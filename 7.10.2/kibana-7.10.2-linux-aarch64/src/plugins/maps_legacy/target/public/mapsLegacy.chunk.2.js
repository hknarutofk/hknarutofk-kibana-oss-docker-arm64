(window["mapsLegacy_bundle_jsonpfunction"]=window["mapsLegacy_bundle_jsonpfunction"]||[]).push([[2],{42:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,"KibanaMap",(function(){return kibana_map_KibanaMap}));__webpack_require__.d(__webpack_exports__,"ServiceSettings",(function(){return service_settings_ServiceSettings}));__webpack_require__.d(__webpack_exports__,"L",(function(){return L}));var events=__webpack_require__(16);var external_kbnSharedDeps_React_=__webpack_require__(0);var external_kbnSharedDeps_React_default=__webpack_require__.n(external_kbnSharedDeps_React_);var external_kbnSharedDeps_KbnI18nReact_=__webpack_require__(1);var external_kbnSharedDeps_ElasticEui_=__webpack_require__(2);var public_=__webpack_require__(40);function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(typeof call==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}var createZoomWarningMsg=function(){var disableZoomMsg=false;var setZoomMsg=function setZoomMsg(boolDisableMsg){return disableZoomMsg=boolDisableMsg};var ZoomWarning=function(_React$Component){_inherits(ZoomWarning,_React$Component);var _super=_createSuper(ZoomWarning);function ZoomWarning(props){var _this;_classCallCheck(this,ZoomWarning);_this=_super.call(this,props);_this.state={disabled:false};return _this}_createClass(ZoomWarning,[{key:"render",value:function render(){var _this2=this;return external_kbnSharedDeps_React_default.a.createElement("div",null,external_kbnSharedDeps_React_default.a.createElement("p",null,external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_KbnI18nReact_["FormattedMessage"],{id:"maps_legacy.kibanaMap.zoomWarning",defaultMessage:"You've reached the maximum number of zoom levels. To zoom all the way in, upgrade to the {defaultDistribution} of Elasticsearch and Kibana. You'll get access to additional zoom levels for free through the {ems}. Or, you can configure your own map server. Please go to { wms } or { configSettings} for more information.",values:{defaultDistribution:external_kbnSharedDeps_React_default.a.createElement("a",{target:"_blank",href:"https://www.elastic.co/downloads/kibana"},"default distribution "),ems:external_kbnSharedDeps_React_default.a.createElement("a",{target:"_blank",href:"https://www.elastic.co/elastic-maps-service"},"Elastic Maps Service"),wms:external_kbnSharedDeps_React_default.a.createElement("a",{target:"_blank",href:"https://www.elastic.co/guide/en/kibana/current/tilemap.html"},"Custom WMS Configuration"),configSettings:external_kbnSharedDeps_React_default.a.createElement("a",{target:"_blank",href:"https://www.elastic.co/guide/en/kibana/current/settings.html"},"Custom TMS Using Config Settings")}})),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiSpacer"],{size:"xs"}),external_kbnSharedDeps_React_default.a.createElement(external_kbnSharedDeps_ElasticEui_["EuiButtonEmpty"],{size:"s",flush:"left",isDisabled:this.state.disabled,onClick:function onClick(){_this2.setState({disabled:true},(function(){return _this2.props.onChange(_this2.state.disabled)}))},"data-test-subj":"suppressZoomWarnings"},"Don't show again"))}}]);return ZoomWarning}(external_kbnSharedDeps_React_default.a.Component);var zoomToast={title:"No additional zoom levels",text:Object(public_["toMountPoint"])(external_kbnSharedDeps_React_default.a.createElement(ZoomWarning,{onChange:setZoomMsg})),"data-test-subj":"maxZoomWarning"};return function(toastService,getZoomLevel,getMaxZoomLevel){return function(){var zoomLevel=getZoomLevel();var maxMapZoom=getMaxZoomLevel();if(!disableZoomMsg&&zoomLevel===maxMapZoom){toastService.addDanger(zoomToast)}}}}();var external_kbnSharedDeps_Jquery_=__webpack_require__(41);var external_kbnSharedDeps_Jquery_default=__webpack_require__.n(external_kbnSharedDeps_Jquery_);var external_kbnSharedDeps_Lodash_=__webpack_require__(39);var external_kbnSharedDeps_Lodash_default=__webpack_require__.n(external_kbnSharedDeps_Lodash_);var decode_geo_hash=__webpack_require__(6);var defaultMaxPrecision=12;var minGeoHashPixels=16;var zoom_to_precision_calculateZoomToPrecisionMap=function calculateZoomToPrecisionMap(maxZoom){var zoomPrecisionMap=new Map;for(var zoom=0;zoom<=maxZoom;zoom+=1){if(typeof zoomPrecisionMap.get(zoom)==="number"){continue}var worldPixels=256*Math.pow(2,zoom);zoomPrecisionMap.set(zoom,1);for(var precision=2;precision<=defaultMaxPrecision;precision+=1){var columns=Object(decode_geo_hash["c"])(precision);if(worldPixels/columns>=minGeoHashPixels){zoomPrecisionMap.set(zoom,precision)}else{break}}}return zoomPrecisionMap};function zoomToPrecision(mapZoom,maxPrecision,maxZoom){var zoomPrecisionMap=zoom_to_precision_calculateZoomToPrecisionMap(typeof maxZoom==="number"?maxZoom:21);var precision=zoomPrecisionMap.get(mapZoom);return precision?Math.min(precision,maxPrecision):maxPrecision}var external_kbnSharedDeps_KbnI18n_=__webpack_require__(5);var constants_origin=__webpack_require__(13);var kibana_services=__webpack_require__(3);if(!window.hasOwnProperty("L")){__webpack_require__(77);window.L=__webpack_require__(82);window.L.Browser.touch=false;window.L.Browser.pointer=false;__webpack_require__(83);__webpack_require__(85);__webpack_require__(86);__webpack_require__(91);__webpack_require__(92);__webpack_require__(94)}var L=window.L;function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)}))}}function kibana_map_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function kibana_map_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function kibana_map_createClass(Constructor,protoProps,staticProps){if(protoProps)kibana_map_defineProperties(Constructor.prototype,protoProps);if(staticProps)kibana_map_defineProperties(Constructor,staticProps);return Constructor}function kibana_map_inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)kibana_map_setPrototypeOf(subClass,superClass)}function kibana_map_setPrototypeOf(o,p){kibana_map_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return kibana_map_setPrototypeOf(o,p)}function kibana_map_createSuper(Derived){var hasNativeReflectConstruct=kibana_map_isNativeReflectConstruct();return function _createSuperInternal(){var Super=kibana_map_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=kibana_map_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return kibana_map_possibleConstructorReturn(this,result)}}function kibana_map_possibleConstructorReturn(self,call){if(call&&(typeof call==="object"||typeof call==="function")){return call}return kibana_map_assertThisInitialized(self)}function kibana_map_assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function kibana_map_isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function kibana_map_getPrototypeOf(o){kibana_map_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return kibana_map_getPrototypeOf(o)}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function makeFitControl(fitContainer,kibanaMap){var FitControl=L.Control.extend({options:{position:"topleft"},initialize:function initialize(fitContainer,kibanaMap){this._fitContainer=fitContainer;this._kibanaMap=kibanaMap;this._leafletMap=null},onAdd:function onAdd(leafletMap){var _this=this;this._leafletMap=leafletMap;var fitDatBoundsLabel=external_kbnSharedDeps_KbnI18n_["i18n"].translate("maps_legacy.kibanaMap.leaflet.fitDataBoundsAriaLabel",{defaultMessage:"Fit Data Bounds"});external_kbnSharedDeps_Jquery_default()(this._fitContainer).html('<a class="kuiIcon fa-crop" href="#" title="'.concat(fitDatBoundsLabel,'" aria-label="').concat(fitDatBoundsLabel,'"></a>')).on("click",(function(e){e.preventDefault();_this._kibanaMap.fitToData()}));return this._fitContainer},onRemove:function onRemove(){external_kbnSharedDeps_Jquery_default()(this._fitContainer).off("click")}});return new FitControl(fitContainer,kibanaMap)}function makeLegendControl(container,kibanaMap,position){var LegendControl=L.Control.extend({options:{position:"topright"},initialize:function initialize(container,kibanaMap,position){this._legendContainer=container;this._kibanaMap=kibanaMap;this.options.position=position},updateContents(){this._legendContainer.empty();var $div=external_kbnSharedDeps_Jquery_default()("<div>").addClass("visMapLegend");this._legendContainer.append($div);var layers=this._kibanaMap.getLayers();layers.forEach((function(layer){return layer.appendLegendContents($div)}))},onAdd:function onAdd(){var _this2=this;this._layerUpdateHandle=function(){return _this2.updateContents()};this._kibanaMap.on("layers:update",this._layerUpdateHandle);this.updateContents();return this._legendContainer.get(0)},onRemove:function onRemove(){this._kibanaMap.removeListener("layers:update",this._layerUpdateHandle);this._legendContainer.empty()}});return new LegendControl(container,kibanaMap,position)}var kibana_map_KibanaMap=function(_EventEmitter){kibana_map_inherits(KibanaMap,_EventEmitter);var _super=kibana_map_createSuper(KibanaMap);function KibanaMap(containerNode,options){var _this3;kibana_map_classCallCheck(this,KibanaMap);_this3=_super.call(this);_defineProperty(kibana_map_assertThisInitialized(_this3),"getZoomLevel",(function(){return _this3._leafletMap.getZoom()}));_defineProperty(kibana_map_assertThisInitialized(_this3),"getMaxZoomLevel",(function(){return _this3._leafletMap.getMaxZoom()}));_defineProperty(kibana_map_assertThisInitialized(_this3),"_addMaxZoomMessage",(function(layer){var zoomWarningMsg=createZoomWarningMsg(Object(kibana_services["d"])(),_this3.getZoomLevel,_this3.getMaxZoomLevel);_this3._leafletMap.on("zoomend",zoomWarningMsg);_this3._containerNode.setAttribute("data-test-subj","zoomWarningEnabled");layer.on("remove",(function(){_this3._leafletMap.off("zoomend",zoomWarningMsg);_this3._containerNode.removeAttribute("data-test-subj")}))}));_this3._containerNode=containerNode;_this3._leafletBaseLayer=null;_this3._baseLayerSettings=null;_this3._baseLayerIsDesaturated=true;_this3._leafletDrawControl=null;_this3._leafletFitControl=null;_this3._leafletLegendControl=null;_this3._legendPosition="topright";_this3._layers=[];_this3._listeners=[];_this3._showTooltip=false;var leafletOptions={minZoom:options.minZoom,maxZoom:options.maxZoom,center:options.center?options.center:[0,0],zoom:options.zoom?options.zoom:2,renderer:L.canvas(),zoomAnimation:false,zoomControl:options.zoomControl===undefined?true:options.zoomControl};_this3._leafletMap=L.map(containerNode,leafletOptions);_this3._leafletMap.attributionControl.setPrefix("");if(!options.scrollWheelZoom){_this3._leafletMap.scrollWheelZoom.disable()}var previousZoom=_this3._leafletMap.getZoom();_this3._leafletMap.on("zoomend",(function(){if(previousZoom!==_this3._leafletMap.getZoom()){previousZoom=_this3._leafletMap.getZoom();_this3.emit("zoomchange")}}));_this3._leafletMap.on("zoomend",(function(){return _this3.emit("zoomend")}));_this3._leafletMap.on("dragend",(function(){return _this3.emit("dragend")}));_this3._leafletMap.on("zoomend",(function(){return _this3._updateExtent()}));_this3._leafletMap.on("dragend",(function(){return _this3._updateExtent()}));_this3._leafletMap.on("mousemove",(function(e){return _this3._layers.forEach((function(layer){return layer.movePointer("mousemove",e)}))}));_this3._leafletMap.on("mouseout",(function(e){return _this3._layers.forEach((function(layer){return layer.movePointer("mouseout",e)}))}));_this3._leafletMap.on("mousedown",(function(e){return _this3._layers.forEach((function(layer){return layer.movePointer("mousedown",e)}))}));_this3._leafletMap.on("mouseup",(function(e){return _this3._layers.forEach((function(layer){return layer.movePointer("mouseup",e)}))}));_this3._leafletMap.on("draw:created",(function(event){var drawType=event.layerType;if(drawType==="rectangle"){var bounds=event.layer.getBounds();var southEast=bounds.getSouthEast();var northWest=bounds.getNorthWest();var southEastLng=southEast.lng;if(southEastLng>180){southEastLng-=360}var northWestLng=northWest.lng;if(northWestLng<-180){northWestLng+=360}var southEastLat=southEast.lat;var northWestLat=northWest.lat;if(southEastLat===northWestLat||southEastLng===northWestLng){return}_this3.emit("drawCreated:rectangle",{bounds:{bottom_right:{lat:southEastLat,lon:southEastLng},top_left:{lat:northWestLat,lon:northWestLng}}})}else if(drawType==="polygon"){var latLongs=event.layer.getLatLngs()[0];_this3.emit("drawCreated:polygon",{points:latLongs.map((function(leafletLatLng){return{lat:leafletLatLng.lat,lon:leafletLatLng.lng}}))})}}));_this3.resize();return _this3}kibana_map_createClass(KibanaMap,[{key:"setShowTooltip",value:function setShowTooltip(showTooltip){this._showTooltip=showTooltip}},{key:"getLayers",value:function getLayers(){return this._layers.slice()}},{key:"addLayer",value:function addLayer(kibanaLayer){var _this4=this;var onshowTooltip=function onshowTooltip(event){if(!_this4._showTooltip){return}if(!_this4._popup){_this4._popup=new L.ResponsivePopup({autoPan:false});_this4._popup.setLatLng(event.position);_this4._popup.setContent(event.content);_this4._leafletMap.openPopup(_this4._popup)}else{if(!_this4._popup.getLatLng().equals(event.position)){_this4._popup.setLatLng(event.position)}if(_this4._popup.getContent()!==event.content){_this4._popup.setContent(event.content)}}};kibanaLayer.on("showTooltip",onshowTooltip);this._listeners.push({name:"showTooltip",handle:onshowTooltip,layer:kibanaLayer});var onHideTooltip=function onHideTooltip(){_this4._leafletMap.closePopup();_this4._popup=null};kibanaLayer.on("hideTooltip",onHideTooltip);this._listeners.push({name:"hideTooltip",handle:onHideTooltip,layer:kibanaLayer});var onStyleChanged=function onStyleChanged(){if(_this4._leafletLegendControl){_this4._leafletLegendControl.updateContents()}};kibanaLayer.on("styleChanged",onStyleChanged);this._listeners.push({name:"styleChanged",handle:onStyleChanged,layer:kibanaLayer});this._layers.push(kibanaLayer);kibanaLayer.addToLeafletMap(this._leafletMap);this.emit("layers:update");this._addAttributions(kibanaLayer.getAttributions())}},{key:"removeLayer",value:function removeLayer(kibanaLayer){var _this5=this;if(!kibanaLayer){return}this._removeAttributions(kibanaLayer.getAttributions());var index=this._layers.indexOf(kibanaLayer);if(index>=0){this._layers.splice(index,1);kibanaLayer.removeFromLeafletMap(this._leafletMap)}this._listeners.forEach((function(listener){if(listener.layer===kibanaLayer){listener.layer.removeListener(listener.name,listener.handle)}}));this._layers.forEach((function(layer){return _this5._addAttributions(layer.getAttributions())}));if(this._baseLayerSettings){this._addAttributions(this._baseLayerSettings.options.attribution)}}},{key:"_addAttributions",value:function _addAttributions(attribution){var _this6=this;var attributions=getAttributionArray(attribution);attributions.forEach((function(attribution){_this6._leafletMap.attributionControl.removeAttribution(attribution);_this6._leafletMap.attributionControl.addAttribution(attribution)}))}},{key:"_removeAttributions",value:function _removeAttributions(attribution){var _this7=this;var attributions=getAttributionArray(attribution);attributions.forEach((function(attribution){_this7._leafletMap.attributionControl.removeAttribution(attribution)}))}},{key:"destroy",value:function destroy(){if(this._leafletFitControl){this._leafletMap.removeControl(this._leafletFitControl)}if(this._leafletDrawControl){this._leafletMap.removeControl(this._leafletDrawControl)}if(this._leafletLegendControl){this._leafletMap.removeControl(this._leafletLegendControl)}this.setBaseLayer(null);var layer;while(this._layers.length){layer=this._layers.pop();layer.removeFromLeafletMap(this._leafletMap)}this._leafletMap.remove();this._containerNode.innerHTML="";this._listeners.forEach((function(listener){return listener.layer.removeListener(listener.name,listener.handle)}))}},{key:"getCenter",value:function getCenter(){var center=this._leafletMap.getCenter();return{lon:center.lng,lat:center.lat}}},{key:"setCenter",value:function setCenter(latitude,longitude){var latLong=L.latLng(latitude,longitude);if(latLong.equals&&!latLong.equals(this._leafletMap.getCenter())){this._leafletMap.setView(latLong)}}},{key:"setZoomLevel",value:function setZoomLevel(zoomLevel){if(this._leafletMap.getZoom()!==zoomLevel){this._leafletMap.setZoom(zoomLevel)}}},{key:"getGeohashPrecision",value:function getGeohashPrecision(){return zoomToPrecision(this._leafletMap.getZoom(),12,this._leafletMap.getMaxZoom())}},{key:"getLeafletBounds",value:function getLeafletBounds(){return this._leafletMap.getBounds()}},{key:"getMetersPerPixel",value:function getMetersPerPixel(){var pointC=this._leafletMap.latLngToContainerPoint(this._leafletMap.getCenter());var pointX=[pointC.x+1,pointC.y];var pointY=[pointC.x,pointC.y+1];var latLngC=this._leafletMap.containerPointToLatLng(pointC);var latLngX=this._leafletMap.containerPointToLatLng(pointX);var latLngY=this._leafletMap.containerPointToLatLng(pointY);var distanceX=latLngC.distanceTo(latLngX);var distanceY=latLngC.distanceTo(latLngY);return Math.min(distanceX,distanceY)}},{key:"_getLeafletBounds",value:function _getLeafletBounds(resizeOnFail){var boundsRaw=this._leafletMap.getBounds();var bounds=this._leafletMap.wrapLatLngBounds(boundsRaw);if(!bounds){return null}var southEast=bounds.getSouthEast();var northWest=bounds.getNorthWest();if(southEast.lng===northWest.lng||southEast.lat===northWest.lat){if(resizeOnFail){this._leafletMap.invalidateSize();return this._getLeafletBounds(false)}else{return null}}else{return bounds}}},{key:"getBounds",value:function getBounds(){var bounds=this._getLeafletBounds(true);if(!bounds){return null}var southEast=bounds.getSouthEast();var northWest=bounds.getNorthWest();var southEastLng=southEast.lng;var northWestLng=northWest.lng;var southEastLat=southEast.lat;var northWestLat=northWest.lat;return{bottom_right:{lat:southEastLat,lon:southEastLng},top_left:{lat:northWestLat,lon:northWestLng}}}},{key:"setDesaturateBaseLayer",value:function setDesaturateBaseLayer(isDesaturated){if(isDesaturated===this._baseLayerIsDesaturated){return}this._baseLayerIsDesaturated=isDesaturated;this._updateDesaturation();if(this._leafletBaseLayer){this._leafletBaseLayer.redraw()}}},{key:"addDrawControl",value:function addDrawControl(){var drawColor="#000";var drawOptions={draw:{polyline:false,marker:false,circle:false,rectangle:{shapeOptions:{stroke:false,color:drawColor}},polygon:{shapeOptions:{color:drawColor}},circlemarker:false}};this._leafletDrawControl=new L.Control.Draw(drawOptions);this._leafletMap.addControl(this._leafletDrawControl)}},{key:"addFitControl",value:function addFitControl(){if(this._leafletFitControl||!this._leafletMap){return}var fitContainer=L.DomUtil.create("div","leaflet-control leaflet-bar leaflet-control-fit");this._leafletFitControl=makeFitControl(fitContainer,this);this._leafletMap.addControl(this._leafletFitControl)}},{key:"addLegendControl",value:function addLegendControl(){if(this._leafletLegendControl||!this._leafletMap){return}this._updateLegend()}},{key:"setLegendPosition",value:function setLegendPosition(position){if(this._legendPosition===position){if(!this._leafletLegendControl){this._updateLegend()}}else{this._legendPosition=position;this._updateLegend()}}},{key:"_updateLegend",value:function _updateLegend(){if(this._leafletLegendControl){this._leafletMap.removeControl(this._leafletLegendControl)}var $wrapper=external_kbnSharedDeps_Jquery_default()("<div>").addClass("visMapLegend__wrapper");this._leafletLegendControl=makeLegendControl($wrapper,this,this._legendPosition);this._leafletMap.addControl(this._leafletLegendControl)}},{key:"resize",value:function resize(){this._leafletMap.invalidateSize();this._updateExtent()}},{key:"setMinZoom",value:function setMinZoom(zoom){this._leafletMap.setMinZoom(zoom)}},{key:"setMaxZoom",value:function setMaxZoom(zoom){this._leafletMap.setMaxZoom(zoom)}},{key:"getLeafletBaseLayer",value:function getLeafletBaseLayer(){return this._leafletBaseLayer}},{key:"setBaseLayer",value:function setBaseLayer(settings){var _this8=this;if(Object(external_kbnSharedDeps_Lodash_["isEqual"])(settings,this._baseLayerSettings)){return}if(settings===null){if(this._leafletBaseLayer&&this._leafletMap){this._removeAttributions(this._baseLayerSettings.options.attribution);this._leafletMap.removeLayer(this._leafletBaseLayer);this._leafletBaseLayer=null;this._baseLayerSettings=null}return}this._baseLayerSettings=settings;if(this._leafletBaseLayer){this._leafletMap.removeLayer(this._leafletBaseLayer);this._leafletBaseLayer=null}var baseLayer;if(settings.baseLayerType==="wms"){this._baseLayerSettings.options.attribution=Object(external_kbnSharedDeps_Lodash_["escape"])(settings.options.attribution);baseLayer=this._getWMSBaseLayer(settings.options)}else if(settings.baseLayerType==="tms"){baseLayer=this._getTMSBaseLayer(settings.options)}if(baseLayer){baseLayer.on("tileload",(function(){return _this8._updateDesaturation()}));baseLayer.on("load",(function(){_this8.emit("baseLayer:loaded")}));baseLayer.on("loading",(function(){_this8.emit("baseLayer:loading")}));this._leafletBaseLayer=baseLayer;if(settings.options.showZoomMessage){baseLayer.on("add",(function(){_this8._addMaxZoomMessage(baseLayer)}))}this._leafletBaseLayer.addTo(this._leafletMap);this._leafletBaseLayer.bringToBack();if(settings.options.minZoom>this._leafletMap.getZoom()){this._leafletMap.setZoom(settings.options.minZoom)}this._addAttributions(settings.options.attribution);this.resize()}}},{key:"isInside",value:function isInside(bucketRectBounds){var mapBounds=this._leafletMap.getBounds();return mapBounds.intersects(bucketRectBounds)}},{key:"fitToData",value:function(){var _fitToData=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(){var boundsArray,bounds;return regeneratorRuntime.wrap((function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(this._leafletMap){_context3.next=2;break}return _context3.abrupt("return");case 2:_context3.next=4;return Promise.all(this._layers.map(function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(layer){return regeneratorRuntime.wrap((function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return layer.getBounds();case 2:return _context.abrupt("return",_context.sent);case 3:case"end":return _context.stop()}}}),_callee)})));return function(_x){return _ref.apply(this,arguments)}}()));case 4:boundsArray=_context3.sent;bounds=null;boundsArray.forEach(function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(b){return regeneratorRuntime.wrap((function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(bounds){bounds.extend(b)}else{bounds=b}case 1:case"end":return _context2.stop()}}}),_callee2)})));return function(_x2){return _ref2.apply(this,arguments)}}());if(bounds&&bounds.isValid()){this._leafletMap.fitBounds(bounds)}case 8:case"end":return _context3.stop()}}}),_callee3,this)})));function fitToData(){return _fitToData.apply(this,arguments)}return fitToData}()},{key:"_getTMSBaseLayer",value:function _getTMSBaseLayer(options){return L.tileLayer(options.url,{minZoom:options.minZoom,maxZoom:options.maxZoom,subdomains:options.subdomains||[]})}},{key:"_getWMSBaseLayer",value:function _getWMSBaseLayer(options){var wmsOptions={format:options.format||"",layers:options.layers||"",minZoom:options.minZoom,maxZoom:options.maxZoom,styles:options.styles||"",transparent:options.transparent,version:options.version||"1.3.0"};return typeof options.url==="string"&&options.url.length?L.tileLayer.wms(options.url,wmsOptions):null}},{key:"_updateExtent",value:function _updateExtent(){this._layers.forEach((function(layer){return layer.updateExtent()}))}},{key:"_updateDesaturation",value:function _updateDesaturation(){var tiles=external_kbnSharedDeps_Jquery_default()("img.leaflet-tile-loaded");if(Object(external_kbnSharedDeps_Lodash_["get"])(this._baseLayerSettings,"options.origin")===constants_origin["a"].EMS){tiles.addClass("filters-off")}else{if(this._baseLayerIsDesaturated){tiles.removeClass("filters-off")}else if(!this._baseLayerIsDesaturated){tiles.addClass("filters-off")}}}},{key:"persistUiStateForVisualization",value:function persistUiStateForVisualization(visualization){var _this9=this;function persistMapStateInUiState(){var uiState=visualization.getUiState();var centerFromUIState=uiState.get("mapCenter");var zoomFromUiState=parseInt(uiState.get("mapZoom"));if(isNaN(zoomFromUiState)||this.getZoomLevel()!==zoomFromUiState){visualization.uiStateVal("mapZoom",this.getZoomLevel())}var centerFromMap=this.getCenter();if(!centerFromUIState||centerFromMap.lon!==centerFromUIState[1]||centerFromMap.lat!==centerFromUIState[0]){visualization.uiStateVal("mapCenter",[centerFromMap.lat,centerFromMap.lon])}}this._leafletMap.on("resize",(function(){visualization.sessionState.mapBounds=_this9.getBounds()}));this._leafletMap.on("load",(function(){visualization.sessionState.mapBounds=_this9.getBounds()}));this.on("dragend",persistMapStateInUiState);this.on("zoomend",persistMapStateInUiState)}},{key:"useUiStateFromVisualization",value:function useUiStateFromVisualization(visualization){var uiState=visualization.getUiState();var zoomFromUiState=parseInt(uiState.get("mapZoom"));var centerFromUIState=uiState.get("mapCenter");if(!isNaN(zoomFromUiState)){this.setZoomLevel(zoomFromUiState)}if(centerFromUIState){this.setCenter(centerFromUIState[0],centerFromUIState[1])}}}]);return KibanaMap}(events["EventEmitter"]);function getAttributionArray(attribution){var attributionString=attribution||"";var attributions=attributionString.split(/\s*\|\s*/);if(attributions.length===1){attributions=attributions[0].split(",")}return attributions}var markdown_it=__webpack_require__(95);var markdown_it_default=__webpack_require__.n(markdown_it);var web=__webpack_require__(180);function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach((function(key){service_settings_defineProperty(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}function service_settings_asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function service_settings_asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){service_settings_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){service_settings_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)}))}}function service_settings_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function service_settings_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function service_settings_createClass(Constructor,protoProps,staticProps){if(protoProps)service_settings_defineProperties(Constructor.prototype,protoProps);if(staticProps)service_settings_defineProperties(Constructor,staticProps);return Constructor}function service_settings_defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}var TMS_IN_YML_ID="TMS in config/kibana.yml";var service_settings_ServiceSettings=function(){function ServiceSettings(mapConfig,tilemapsConfig){service_settings_classCallCheck(this,ServiceSettings);service_settings_defineProperty(this,"_backfillSettings",(function(fileLayer){var format=fileLayer.getDefaultFormatType();var meta=fileLayer.getDefaultFormatMeta();return{name:fileLayer.getDisplayName(),origin:fileLayer.getOrigin(),id:fileLayer.getId(),created_at:fileLayer.getCreatedAt(),attribution:getAttributionString(fileLayer),fields:fileLayer.getFieldsInLanguage(),format:format,meta:meta}}));this._mapConfig=mapConfig;this._tilemapsConfig=tilemapsConfig;this._hasTmsConfigured=typeof tilemapsConfig.url==="string"&&tilemapsConfig.url!=="";this._showZoomMessage=true;this._emsClient=new web["a"]({language:external_kbnSharedDeps_KbnI18n_["i18n"].getLocale(),appVersion:Object(kibana_services["b"])(),appName:"kibana",fileApiUrl:this._mapConfig.emsFileApiUrl,tileApiUrl:this._mapConfig.emsTileApiUrl,landingPageUrl:this._mapConfig.emsLandingPageUrl,fetchFunction:function fetchFunction(){return fetch.apply(void 0,arguments)}});this.getTMSOptions()}service_settings_createClass(ServiceSettings,[{key:"getTMSOptions",value:function getTMSOptions(){var markdownIt=new markdown_it_default.a({html:false,linkify:true});this.tmsOptionsFromConfig=external_kbnSharedDeps_Lodash_default.a.assign({},this._tilemapsConfig.options,{attribution:external_kbnSharedDeps_Lodash_default.a.escape(markdownIt.render(this._tilemapsConfig.options.attribution||"")),url:this._tilemapsConfig.url})}},{key:"shouldShowZoomMessage",value:function shouldShowZoomMessage(_ref){var origin=_ref.origin;return origin===constants_origin["a"].EMS&&this._showZoomMessage}},{key:"enableZoomMessage",value:function enableZoomMessage(){this._showZoomMessage=true}},{key:"disableZoomMessage",value:function disableZoomMessage(){this._showZoomMessage=false}},{key:"__debugStubManifestCalls",value:function __debugStubManifestCalls(manifestRetrieval){var _this=this;var oldGetManifest=this._emsClient.getManifest;this._emsClient.getManifest=manifestRetrieval;return{removeStub:function removeStub(){delete _this._emsClient.getManifest;if(_this._emsClient.getManifest!==oldGetManifest){_this._emsClient.getManifest=oldGetManifest}}}}},{key:"getFileLayers",value:function(){var _getFileLayers=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee(){var fileLayers;return regeneratorRuntime.wrap((function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(this._mapConfig.includeElasticMapsService){_context.next=2;break}return _context.abrupt("return",[]);case 2:_context.next=4;return this._emsClient.getFileLayers();case 4:fileLayers=_context.sent;return _context.abrupt("return",fileLayers.map(this._backfillSettings));case 6:case"end":return _context.stop()}}}),_callee,this)})));function getFileLayers(){return _getFileLayers.apply(this,arguments)}return getFileLayers}()},{key:"getTMSServices",value:function(){var _getTMSServices=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee3(){var _this2=this;var allServices,tmsService,servicesFromManifest,strippedServiceFromManifest;return regeneratorRuntime.wrap((function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:allServices=[];if(this._hasTmsConfigured){tmsService=external_kbnSharedDeps_Lodash_default.a.cloneDeep(this.tmsOptionsFromConfig);tmsService.id=TMS_IN_YML_ID;tmsService.origin=constants_origin["a"].KIBANA_YML;allServices.push(tmsService)}if(!this._mapConfig.includeElasticMapsService){_context3.next=10;break}_context3.next=5;return this._emsClient.getTMSServices();case 5:servicesFromManifest=_context3.sent;_context3.next=8;return Promise.all(servicesFromManifest.filter((function(tmsService){return tmsService.getId()===_this2._mapConfig.emsTileLayerId.bright})).map(function(){var _ref2=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee2(tmsService){return regeneratorRuntime.wrap((function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.t0=tmsService.getOrigin();_context2.t1=tmsService.getId();_context2.next=4;return tmsService.getMinZoom();case 4:_context2.t2=_context2.sent;_context2.next=7;return tmsService.getMaxZoom();case 7:_context2.t3=_context2.sent;_context2.t4=getAttributionString(tmsService);return _context2.abrupt("return",{origin:_context2.t0,id:_context2.t1,minZoom:_context2.t2,maxZoom:_context2.t3,attribution:_context2.t4});case 10:case"end":return _context2.stop()}}}),_callee2)})));return function(_x){return _ref2.apply(this,arguments)}}()));case 8:strippedServiceFromManifest=_context3.sent;allServices=allServices.concat(strippedServiceFromManifest);case 10:return _context3.abrupt("return",allServices);case 11:case"end":return _context3.stop()}}}),_callee3,this)})));function getTMSServices(){return _getTMSServices.apply(this,arguments)}return getTMSServices}()},{key:"setQueryParams",value:function setQueryParams(additionalQueryParams){this._emsClient.addQueryParams(additionalQueryParams)}},{key:"getFileLayerFromConfig",value:function(){var _getFileLayerFromConfig=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee4(fileLayerConfig){var fileLayers;return regeneratorRuntime.wrap((function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return this._emsClient.getFileLayers();case 2:fileLayers=_context4.sent;return _context4.abrupt("return",fileLayers.find((function(fileLayer){var hasIdByName=fileLayer.hasId(fileLayerConfig.name);var hasIdById=fileLayer.hasId(fileLayerConfig.id);return hasIdByName||hasIdById})));case 4:case"end":return _context4.stop()}}}),_callee4,this)})));function getFileLayerFromConfig(_x2){return _getFileLayerFromConfig.apply(this,arguments)}return getFileLayerFromConfig}()},{key:"getEMSHotLink",value:function(){var _getEMSHotLink=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee5(fileLayerConfig){var layer;return regeneratorRuntime.wrap((function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return this.getFileLayerFromConfig(fileLayerConfig);case 2:layer=_context5.sent;return _context5.abrupt("return",layer?layer.getEMSHotLink():null);case 4:case"end":return _context5.stop()}}}),_callee5,this)})));function getEMSHotLink(_x3){return _getEMSHotLink.apply(this,arguments)}return getEMSHotLink}()},{key:"loadFileLayerConfig",value:function(){var _loadFileLayerConfig=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee6(fileLayerConfig){var fileLayer;return regeneratorRuntime.wrap((function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return this.getFileLayerFromConfig(fileLayerConfig);case 2:fileLayer=_context6.sent;return _context6.abrupt("return",fileLayer?this._backfillSettings(fileLayer):null);case 4:case"end":return _context6.stop()}}}),_callee6,this)})));function loadFileLayerConfig(_x4){return _loadFileLayerConfig.apply(this,arguments)}return loadFileLayerConfig}()},{key:"_getAttributesForEMSTMSLayer",value:function(){var _getAttributesForEMSTMSLayer2=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee7(isDesaturated,isDarkMode){var tmsServices,emsTileLayerId,serviceId,tmsService;return regeneratorRuntime.wrap((function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return this._emsClient.getTMSServices();case 2:tmsServices=_context7.sent;emsTileLayerId=this._mapConfig.emsTileLayerId;if(isDarkMode){serviceId=emsTileLayerId.dark}else{if(isDesaturated){serviceId=emsTileLayerId.desaturated}else{serviceId=emsTileLayerId.bright}}tmsService=tmsServices.find((function(service){return service.getId()===serviceId}));_context7.next=8;return tmsService.getUrlTemplate();case 8:_context7.t0=_context7.sent;_context7.next=11;return tmsService.getMinZoom();case 11:_context7.t1=_context7.sent;_context7.next=14;return tmsService.getMaxZoom();case 14:_context7.t2=_context7.sent;_context7.t3=getAttributionString(tmsService);_context7.t4=constants_origin["a"].EMS;return _context7.abrupt("return",{url:_context7.t0,minZoom:_context7.t1,maxZoom:_context7.t2,attribution:_context7.t3,origin:_context7.t4});case 18:case"end":return _context7.stop()}}}),_callee7,this)})));function _getAttributesForEMSTMSLayer(_x5,_x6){return _getAttributesForEMSTMSLayer2.apply(this,arguments)}return _getAttributesForEMSTMSLayer}()},{key:"getAttributesForTMSLayer",value:function(){var _getAttributesForTMSLayer=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee8(tmsServiceConfig,isDesaturated,isDarkMode){var attrs,_attrs;return regeneratorRuntime.wrap((function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:if(!(tmsServiceConfig.origin===constants_origin["a"].EMS)){_context8.next=4;break}return _context8.abrupt("return",this._getAttributesForEMSTMSLayer(isDesaturated,isDarkMode));case 4:if(!(tmsServiceConfig.origin===constants_origin["a"].KIBANA_YML)){_context8.next=9;break}attrs=external_kbnSharedDeps_Lodash_default.a.pick(this._tilemapsConfig,["url","minzoom","maxzoom","attribution"]);return _context8.abrupt("return",_objectSpread(_objectSpread({},attrs),{origin:constants_origin["a"].KIBANA_YML}));case 9:if(!(tmsServiceConfig.id===TMS_IN_YML_ID)){_context8.next=14;break}_attrs=external_kbnSharedDeps_Lodash_default.a.pick(this._tilemapsConfig,["url","minzoom","maxzoom","attribution"]);return _context8.abrupt("return",_objectSpread(_objectSpread({},_attrs),{origin:constants_origin["a"].KIBANA_YML}));case 14:return _context8.abrupt("return",this._getAttributesForEMSTMSLayer(isDesaturated,isDarkMode));case 15:case"end":return _context8.stop()}}}),_callee8,this)})));function getAttributesForTMSLayer(_x7,_x8,_x9){return _getAttributesForTMSLayer.apply(this,arguments)}return getAttributesForTMSLayer}()},{key:"_getFileUrlFromEMS",value:function(){var _getFileUrlFromEMS2=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee9(fileLayerConfig){var fileLayers,layer;return regeneratorRuntime.wrap((function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return this._emsClient.getFileLayers();case 2:fileLayers=_context9.sent;layer=fileLayers.find((function(fileLayer){var hasIdByName=fileLayer.hasId(fileLayerConfig.name);var hasIdById=fileLayer.hasId(fileLayerConfig.id);return hasIdByName||hasIdById}));if(!layer){_context9.next=8;break}return _context9.abrupt("return",layer.getDefaultFormatUrl());case 8:throw new Error("File  ".concat(fileLayerConfig.name," not recognized"));case 9:case"end":return _context9.stop()}}}),_callee9,this)})));function _getFileUrlFromEMS(_x10){return _getFileUrlFromEMS2.apply(this,arguments)}return _getFileUrlFromEMS}()},{key:"getUrlForRegionLayer",value:function(){var _getUrlForRegionLayer=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee10(fileLayerConfig){var url;return regeneratorRuntime.wrap((function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:if(fileLayerConfig.origin===constants_origin["a"].EMS){url=this._getFileUrlFromEMS(fileLayerConfig)}else if(fileLayerConfig.layerId&&fileLayerConfig.layerId.startsWith("".concat(constants_origin["a"].EMS,"."))){url=this._getFileUrlFromEMS(fileLayerConfig)}else if(fileLayerConfig.layerId&&fileLayerConfig.layerId.startsWith("".concat(constants_origin["a"].KIBANA_YML,"."))){url=fileLayerConfig.url}else{url=fileLayerConfig.url}return _context10.abrupt("return",url);case 2:case"end":return _context10.stop()}}}),_callee10,this)})));function getUrlForRegionLayer(_x11){return _getUrlForRegionLayer.apply(this,arguments)}return getUrlForRegionLayer}()},{key:"getJsonForRegionLayer",value:function(){var _getJsonForRegionLayer=service_settings_asyncToGenerator(regeneratorRuntime.mark((function _callee11(fileLayerConfig){var url,response;return regeneratorRuntime.wrap((function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.next=2;return this.getUrlForRegionLayer(fileLayerConfig);case 2:url=_context11.sent;_context11.next=5;return fetch(url);case 5:response=_context11.sent;_context11.next=8;return response.json();case 8:return _context11.abrupt("return",_context11.sent);case 9:case"end":return _context11.stop()}}}),_callee11,this)})));function getJsonForRegionLayer(_x12){return _getJsonForRegionLayer.apply(this,arguments)}return getJsonForRegionLayer}()}]);return ServiceSettings}();function getAttributionString(emsService){var attributions=emsService.getAttributions();var attributionSnippets=attributions.map((function(attribution){var anchorTag=document.createElement("a");anchorTag.setAttribute("rel","noreferrer noopener");if(attribution.url.startsWith("http://")||attribution.url.startsWith("https://")){anchorTag.setAttribute("href",attribution.url)}anchorTag.textContent=attribution.label;return anchorTag.outerHTML}));return attributionSnippets.join(" | ");//!!!this is the current convention used in Kibana
}}}]);