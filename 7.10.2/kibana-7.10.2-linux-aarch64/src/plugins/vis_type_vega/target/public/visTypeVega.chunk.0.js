(window["visTypeVega_bundle_jsonpfunction"]=window["visTypeVega_bundle_jsonpfunction"]||[]).push([[0],{54:function(module,exports,__webpack_require__){(function(Buffer){(function(global,factory){true?factory(exports):undefined})(this,(function(exports){"use strict";var version="4.16.8";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function(obj){return typeof obj}}else{_typeof=function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread2(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach((function(key){_defineProperty(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function")}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass)}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return true}catch(e){return false}}function _construct(Parent,args,Class){if(_isNativeReflectConstruct()){_construct=Reflect.construct}else{_construct=function _construct(Parent,args,Class){var a=[null];a.push.apply(a,args);var Constructor=Function.bind.apply(Parent,a);var instance=new Constructor;if(Class)_setPrototypeOf(instance,Class.prototype);return instance}}return _construct.apply(null,arguments)}function _objectWithoutPropertiesLoose(source,excluded){if(source==null)return{};var target={};var sourceKeys=Object.keys(source);var key,i;for(i=0;i<sourceKeys.length;i++){key=sourceKeys[i];if(excluded.indexOf(key)>=0)continue;target[key]=source[key]}return target}function _objectWithoutProperties(source,excluded){if(source==null)return{};var target=_objectWithoutPropertiesLoose(source,excluded);var key,i;if(Object.getOwnPropertySymbols){var sourceSymbolKeys=Object.getOwnPropertySymbols(source);for(i=0;i<sourceSymbolKeys.length;i++){key=sourceSymbolKeys[i];if(excluded.indexOf(key)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(source,key))continue;target[key]=source[key]}}return target}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return self}function _possibleConstructorReturn(self,call){if(call&&(typeof call==="object"||typeof call==="function")){return call}return _assertThisInitialized(self)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else{result=Super.apply(this,arguments)}return _possibleConstructorReturn(this,result)}}function _superPropBase(object,property){while(!Object.prototype.hasOwnProperty.call(object,property)){object=_getPrototypeOf(object);if(object===null)break}return object}function _get(target,property,receiver){if(typeof Reflect!=="undefined"&&Reflect.get){_get=Reflect.get}else{_get=function _get(target,property,receiver){var base=_superPropBase(target,property);if(!base)return;var desc=Object.getOwnPropertyDescriptor(base,property);if(desc.get){return desc.get.call(receiver)}return desc.value}}return _get(target,property,receiver||target)}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _toArray(arr){return _arrayWithHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableRest()}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&Symbol.iterator in Object(iter))return Array.from(iter)}function _iterableToArrayLimit(arr,i){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(arr)))return;var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]!=null)_i["return"]()}finally{if(_d)throw _e}}return _arr}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _createForOfIteratorHelper(o,allowArrayLike){var it;if(typeof Symbol==="undefined"||o[Symbol.iterator]==null){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function(){};return{s:F,n:function(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var normalCompletion=true,didErr=false,err;return{s:function(){it=o[Symbol.iterator]()},n:function(){var step=it.next();normalCompletion=step.done;return step},e:function(e){didErr=true;err=e},f:function(){try{if(!normalCompletion&&it.return!=null)it.return()}finally{if(didErr)throw err}}}}function _toPrimitive(input,hint){if(typeof input!=="object"||input===null)return input;var prim=input[Symbol.toPrimitive];if(prim!==undefined){var res=prim.call(input,hint||"default");if(typeof res!=="object")return res;throw new TypeError("@@toPrimitive must return a primitive value.")}return(hint==="string"?String:Number)(input)}function _toPropertyKey(arg){var key=_toPrimitive(arg,"string");return typeof key==="symbol"?key:String(key)}function _classPrivateFieldGet(receiver,privateMap){var descriptor=privateMap.get(receiver);if(!descriptor){throw new TypeError("attempted to get private field on non-instance")}if(descriptor.get){return descriptor.get.call(receiver)}return descriptor.value}function _classPrivateFieldSet(receiver,privateMap,value){var descriptor=privateMap.get(receiver);if(!descriptor){throw new TypeError("attempted to set private field on non-instance")}if(descriptor.set){descriptor.set.call(receiver,value)}else{if(!descriptor.writable){throw new TypeError("attempted to set read only private field")}descriptor.value=value}return value}function accessor(fn,fields,name){fn.fields=fields||[];fn.fname=name;return fn}function getter(path){return path.length===1?get1(path[0]):getN(path)}var get1=function get1(field){return function(obj){return obj[field]}};var getN=function getN(path){var len=path.length;return function(obj){for(var i=0;i<len;++i){obj=obj[path[i]]}return obj}};function error(message){throw Error(message)}function splitAccessPath(p){var path=[],n=p.length;var q=null,b=0,s="",i,j,c;p=p+"";function push(){path.push(s+p.substring(i,j));s="";i=j+1}for(i=j=0;j<n;++j){c=p[j];if(c==="\\"){s+=p.substring(i,j);s+=p.substring(++j,++j);i=j}else if(c===q){push();q=null;b=-1}else if(q){continue}else if(i===b&&c==='"'){i=j+1;q=c}else if(i===b&&c==="'"){i=j+1;q=c}else if(c==="."&&!b){if(j>i){push()}else{i=j+1}}else if(c==="["){if(j>i)push();b=i=j+1}else if(c==="]"){if(!b)error("Access path missing open bracket: "+p);if(b>0)push();b=0;i=j+1}}if(b)error("Access path missing closing bracket: "+p);if(q)error("Access path missing closing quote: "+p);if(j>i){j++;push()}return path}function field(field,name,opt){var path=splitAccessPath(field);field=path.length===1?path[0]:field;return accessor((opt&&opt.get||getter)(path),[field],name||field)}var id=field("id");var identity=accessor((function(_){return _}),[],"identity");var zero=accessor((function(){return 0}),[],"zero");var one=accessor((function(){return 1}),[],"one");var truthy=accessor((function(){return true}),[],"true");var falsy=accessor((function(){return false}),[],"false");function log(method,level,input){var args=[level].concat([].slice.call(input));console[method].apply(console,args)}var None=0;var Error$1=1;var Warn=2;var Info=3;var Debug=4;function logger(_,method){var _level=_||None;return{level:function level(_){if(arguments.length){_level=+_;return this}else{return _level}},error:function error(){if(_level>=Error$1)log(method||"error","ERROR",arguments);return this},warn:function warn(){if(_level>=Warn)log(method||"warn","WARN",arguments);return this},info:function info(){if(_level>=Info)log(method||"log","INFO",arguments);return this},debug:function debug(){if(_level>=Debug)log(method||"log","DEBUG",arguments);return this}}}var isArray=Array.isArray;function isObject(_){return _===Object(_)}var isLegalKey=function isLegalKey(key){return key!=="__proto__"};function mergeConfig(){for(var _len=arguments.length,configs=new Array(_len),_key=0;_key<_len;_key++){configs[_key]=arguments[_key]}return configs.reduce((function(out,source){for(var _key2 in source){if(_key2==="signals"){out.signals=mergeNamed(out.signals,source.signals)}else{var r=_key2==="legend"?{layout:1}:_key2==="style"?true:null;writeConfig(out,_key2,source[_key2],r)}}return out}),{})}function writeConfig(output,key,value,recurse){if(!isLegalKey(key))return;var k,o;if(isObject(value)&&!isArray(value)){o=isObject(output[key])?output[key]:output[key]={};for(k in value){if(recurse&&(recurse===true||recurse[k])){writeConfig(o,k,value[k])}else if(isLegalKey(k)){o[k]=value[k]}}}else{output[key]=value}}function mergeNamed(a,b){if(a==null)return b;var map={},out=[];function add(_){if(!map[_.name]){map[_.name]=1;out.push(_)}}b.forEach(add);a.forEach(add);return out}function array(_){return _!=null?isArray(_)?_:[_]:[]}function isFunction(_){return typeof _==="function"}var hop=Object.prototype.hasOwnProperty;function _has(object,property){return hop.call(object,property)}function isBoolean(_){return typeof _==="boolean"}function isNumber(_){return typeof _==="number"}function isString(_){return typeof _==="string"}function $(x){return isArray(x)?"["+x.map($)+"]":isObject(x)||isString(x)?JSON.stringify(x).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):x}function toSet(_){var s={},n=_.length;for(var i=0;i<n;++i){s[_[i]]=true}return s}Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function r(){var t=isNaN(arguments[0])?1:Number(arguments[0]);return t?Array.prototype.reduce.call(this,(function(a,e){return Array.isArray(e)?a.push.apply(a,r.call(e,t-1)):a.push(e),a}),[]):Array.prototype.slice.call(this)},writable:!0}),Array.prototype.flatMap||Object.defineProperty(Array.prototype,"flatMap",{configurable:!0,value:function(r){return Array.prototype.map.apply(this,arguments).flat()},writable:!0});function createCommonjsModule(fn,basedir,module){return module={path:basedir,exports:{},require:function(path,base){return commonjsRequire(path,base===undefined||base===null?module.path:base)}},fn(module,module.exports),module.exports}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}var clone_1=createCommonjsModule((function(module){var clone=function(){function _instanceof(obj,type){return type!=null&&obj instanceof type}var nativeMap;try{nativeMap=Map}catch(_){nativeMap=function nativeMap(){}}var nativeSet;try{nativeSet=Set}catch(_){nativeSet=function nativeSet(){}}var nativePromise;try{nativePromise=Promise}catch(_){nativePromise=function nativePromise(){}}function clone(parent,circular,depth,prototype,includeNonEnumerable){if(_typeof(circular)==="object"){depth=circular.depth;prototype=circular.prototype;includeNonEnumerable=circular.includeNonEnumerable;circular=circular.circular}var allParents=[];var allChildren=[];var useBuffer=typeof Buffer!="undefined";if(typeof circular=="undefined")circular=true;if(typeof depth=="undefined")depth=Infinity;function _clone(parent,depth){if(parent===null)return null;if(depth===0)return parent;var child;var proto;if(_typeof(parent)!="object"){return parent}if(_instanceof(parent,nativeMap)){child=new nativeMap}else if(_instanceof(parent,nativeSet)){child=new nativeSet}else if(_instanceof(parent,nativePromise)){child=new nativePromise((function(resolve,reject){parent.then((function(value){resolve(_clone(value,depth-1))}),(function(err){reject(_clone(err,depth-1))}))}))}else if(clone.__isArray(parent)){child=[]}else if(clone.__isRegExp(parent)){child=new RegExp(parent.source,__getRegExpFlags(parent));if(parent.lastIndex)child.lastIndex=parent.lastIndex}else if(clone.__isDate(parent)){child=new Date(parent.getTime())}else if(useBuffer&&Buffer.isBuffer(parent)){if(Buffer.allocUnsafe){child=Buffer.allocUnsafe(parent.length)}else{child=new Buffer(parent.length)}parent.copy(child);return child}else if(_instanceof(parent,Error)){child=Object.create(parent)}else{if(typeof prototype=="undefined"){proto=Object.getPrototypeOf(parent);child=Object.create(proto)}else{child=Object.create(prototype);proto=prototype}}if(circular){var index=allParents.indexOf(parent);if(index!=-1){return allChildren[index]}allParents.push(parent);allChildren.push(child)}if(_instanceof(parent,nativeMap)){parent.forEach((function(value,key){var keyChild=_clone(key,depth-1);var valueChild=_clone(value,depth-1);child.set(keyChild,valueChild)}))}if(_instanceof(parent,nativeSet)){parent.forEach((function(value){var entryChild=_clone(value,depth-1);child.add(entryChild)}))}for(var i in parent){var attrs;if(proto){attrs=Object.getOwnPropertyDescriptor(proto,i)}if(attrs&&attrs.set==null){continue}child[i]=_clone(parent[i],depth-1)}if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(parent);for(var i=0;i<symbols.length;i++){var symbol=symbols[i];var descriptor=Object.getOwnPropertyDescriptor(parent,symbol);if(descriptor&&!descriptor.enumerable&&!includeNonEnumerable){continue}child[symbol]=_clone(parent[symbol],depth-1);if(!descriptor.enumerable){Object.defineProperty(child,symbol,{enumerable:false})}}}if(includeNonEnumerable){var allPropertyNames=Object.getOwnPropertyNames(parent);for(var i=0;i<allPropertyNames.length;i++){var propertyName=allPropertyNames[i];var descriptor=Object.getOwnPropertyDescriptor(parent,propertyName);if(descriptor&&descriptor.enumerable){continue}child[propertyName]=_clone(parent[propertyName],depth-1);Object.defineProperty(child,propertyName,{enumerable:false})}}return child}return _clone(parent,depth)}clone.clonePrototype=function clonePrototype(parent){if(parent===null)return null;var c=function c(){};c.prototype=parent;return new c};function __objToStr(o){return Object.prototype.toString.call(o)}clone.__objToStr=__objToStr;function __isDate(o){return _typeof(o)==="object"&&__objToStr(o)==="[object Date]"}clone.__isDate=__isDate;function __isArray(o){return _typeof(o)==="object"&&__objToStr(o)==="[object Array]"}clone.__isArray=__isArray;function __isRegExp(o){return _typeof(o)==="object"&&__objToStr(o)==="[object RegExp]"}clone.__isRegExp=__isRegExp;function __getRegExpFlags(re){var flags="";if(re.global)flags+="g";if(re.ignoreCase)flags+="i";if(re.multiline)flags+="m";return flags}clone.__getRegExpFlags=__getRegExpFlags;return clone}();if(module.exports){module.exports=clone}}));var fastDeepEqual=function equal(a,b){if(a===b)return true;if(a&&b&&_typeof(a)=="object"&&_typeof(b)=="object"){if(a.constructor!==b.constructor)return false;var length,i,keys;if(Array.isArray(a)){length=a.length;if(length!=b.length)return false;for(i=length;i--!==0;){if(!equal(a[i],b[i]))return false}return true}if(a.constructor===RegExp)return a.source===b.source&&a.flags===b.flags;if(a.valueOf!==Object.prototype.valueOf)return a.valueOf()===b.valueOf();if(a.toString!==Object.prototype.toString)return a.toString()===b.toString();keys=Object.keys(a);length=keys.length;if(length!==Object.keys(b).length)return false;for(i=length;i--!==0;){if(!Object.prototype.hasOwnProperty.call(b,keys[i]))return false}for(i=length;i--!==0;){var key=keys[i];if(!equal(a[key],b[key]))return false}return true}return a!==a&&b!==b};var fastJsonStableStringify=function fastJsonStableStringify(data,opts){if(!opts)opts={};if(typeof opts==="function")opts={cmp:opts};var cycles=typeof opts.cycles==="boolean"?opts.cycles:false;var cmp=opts.cmp&&function(f){return function(node){return function(a,b){var aobj={key:a,value:node[a]};var bobj={key:b,value:node[b]};return f(aobj,bobj)}}}(opts.cmp);var seen=[];return function stringify(node){if(node&&node.toJSON&&typeof node.toJSON==="function"){node=node.toJSON()}if(node===undefined)return;if(typeof node=="number")return isFinite(node)?""+node:"null";if(_typeof(node)!=="object")return JSON.stringify(node);var i,out;if(Array.isArray(node)){out="[";for(i=0;i<node.length;i++){if(i)out+=",";out+=stringify(node[i])||"null"}return out+"]"}if(node===null)return"null";if(seen.indexOf(node)!==-1){if(cycles)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var seenIndex=seen.push(node)-1;var keys=Object.keys(node).sort(cmp&&cmp(node));out="";for(i=0;i<keys.length;i++){var key=keys[i];var value=stringify(node[key]);if(!value)continue;if(out)out+=",";out+=JSON.stringify(key)+":"+value}seen.splice(seenIndex,1);return"{"+out+"}"}(data)};function isLogicalOr(op){return!!op.or}function isLogicalAnd(op){return!!op.and}function isLogicalNot(op){return!!op.not}function forEachLeaf(op,fn){if(isLogicalNot(op)){forEachLeaf(op.not,fn)}else if(isLogicalAnd(op)){var _iterator=_createForOfIteratorHelper(op.and),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var subop=_step.value;forEachLeaf(subop,fn)}}catch(err){_iterator.e(err)}finally{_iterator.f()}}else if(isLogicalOr(op)){var _iterator2=_createForOfIteratorHelper(op.or),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _subop=_step2.value;forEachLeaf(_subop,fn)}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}else{fn(op)}}function normalizeLogicalComposition(op,normalizer){if(isLogicalNot(op)){return{not:normalizeLogicalComposition(op.not,normalizer)}}else if(isLogicalAnd(op)){return{and:op.and.map((function(o){return normalizeLogicalComposition(o,normalizer)}))}}else if(isLogicalOr(op)){return{or:op.or.map((function(o){return normalizeLogicalComposition(o,normalizer)}))}}else{return normalizer(op)}}var deepEqual=fastDeepEqual;var duplicate=clone_1;function pick(obj,props){var copy={};var _iterator=_createForOfIteratorHelper(props),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var prop=_step.value;if(_has(obj,prop)){copy[prop]=obj[prop]}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return copy}function omit(obj,props){var copy=_objectSpread2({},obj);var _iterator2=_createForOfIteratorHelper(props),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var prop=_step2.value;delete copy[prop]}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return copy}Set.prototype["toJSON"]=function(){return"Set(".concat(_toConsumableArray(this).map((function(x){return fastJsonStableStringify(x)})).join(","),")")};var stringify=fastJsonStableStringify;function hash(a){if(isNumber(a)){return a}var str=isString(a)?a:fastJsonStableStringify(a);if(str.length<250){return str}var h=0;for(var i=0;i<str.length;i++){var char=str.charCodeAt(i);h=(h<<5)-h+char;h=h&h}return h}function isNullOrFalse(x){return x===false||x===null}function contains(array,item){return array.indexOf(item)>-1}function some(arr,f){var i=0;var _iterator3=_createForOfIteratorHelper(arr.entries()),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _step3$value=_slicedToArray(_step3.value,2),_k=_step3$value[0],a=_step3$value[1];if(f(a,_k,i++)){return true}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return false}function every(arr,f){var i=0;var _iterator4=_createForOfIteratorHelper(arr.entries()),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _step4$value=_slicedToArray(_step4.value,2),_k2=_step4$value[0],a=_step4$value[1];if(!f(a,_k2,i++)){return false}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}return true}function mergeDeep(dest){for(var _len=arguments.length,src=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){src[_key-1]=arguments[_key]}for(var _i=0,_src=src;_i<_src.length;_i++){var s=_src[_i];deepMerge_(dest,s!==null&&s!==void 0?s:{})}return dest}function deepMerge_(dest,src){var _iterator5=_createForOfIteratorHelper(keys(src)),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var property=_step5.value;writeConfig(dest,property,src[property],true)}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}}function unique(values,f){var results=[];var u={};var v;var _iterator6=_createForOfIteratorHelper(values),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var val=_step6.value;v=f(val);if(v in u){continue}u[v]=1;results.push(val)}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}return results}function isEqual(dict,other){var dictKeys=keys(dict);var otherKeys=keys(other);if(dictKeys.length!==otherKeys.length){return false}var _iterator7=_createForOfIteratorHelper(dictKeys),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var key=_step7.value;if(dict[key]!==other[key]){return false}}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}return true}function setEqual(a,b){if(a.size!==b.size){return false}var _iterator8=_createForOfIteratorHelper(a),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var e=_step8.value;if(!b.has(e)){return false}}}catch(err){_iterator8.e(err)}finally{_iterator8.f()}return true}function hasIntersection(a,b){var _iterator9=_createForOfIteratorHelper(a),_step9;try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var key=_step9.value;if(b.has(key)){return true}}}catch(err){_iterator9.e(err)}finally{_iterator9.f()}return false}function prefixGenerator(a){var prefixes=new Set;var _iterator10=_createForOfIteratorHelper(a),_step10;try{var _loop=function _loop(){var x=_step10.value;var splitField=splitAccessPath(x);var wrappedWithAccessors=splitField.map((function(y,i){return i===0?y:"[".concat(y,"]")}));var computedPrefixes=wrappedWithAccessors.map((function(_,i){return wrappedWithAccessors.slice(0,i+1).join("")}));var _iterator11=_createForOfIteratorHelper(computedPrefixes),_step11;try{for(_iterator11.s();!(_step11=_iterator11.n()).done;){var y=_step11.value;prefixes.add(y)}}catch(err){_iterator11.e(err)}finally{_iterator11.f()}};for(_iterator10.s();!(_step10=_iterator10.n()).done;){_loop()}}catch(err){_iterator10.e(err)}finally{_iterator10.f()}return prefixes}function fieldIntersection(a,b){if(a===undefined||b===undefined){return true}return hasIntersection(prefixGenerator(a),prefixGenerator(b))}function isEmpty(obj){return keys(obj).length===0}var keys=Object.keys;var vals=Object.values;var entries=Object.entries;function isBoolean$1(b){return b===true||b===false}function varName(s){var alphanumericS=s.replace(/\W/g,"_");return(s.match(/^\d+/)?"_":"")+alphanumericS}function logicalExpr(op,cb){if(isLogicalNot(op)){return"!("+logicalExpr(op.not,cb)+")"}else if(isLogicalAnd(op)){return"("+op.and.map((function(and){return logicalExpr(and,cb)})).join(") && (")+")"}else if(isLogicalOr(op)){return"("+op.or.map((function(or){return logicalExpr(or,cb)})).join(") || (")+")"}else{return cb(op)}}function deleteNestedProperty(obj,orderedProps){if(orderedProps.length===0){return true}var prop=orderedProps.shift();if(prop in obj&&deleteNestedProperty(obj[prop],orderedProps)){delete obj[prop]}return isEmpty(obj)}function titleCase(s){return s.charAt(0).toUpperCase()+s.substr(1)}function accessPathWithDatum(path){var datum=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"datum";var pieces=splitAccessPath(path);var prefixes=[];for(var i=1;i<=pieces.length;i++){var prefix="[".concat(pieces.slice(0,i).map($).join("]["),"]");prefixes.push("".concat(datum).concat(prefix))}return prefixes.join(" && ")}function flatAccessWithDatum(path){var datum=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"datum";return"".concat(datum,"[").concat($(splitAccessPath(path).join(".")),"]")}function escapePathAccess(string){return string.replace(/(\[|\]|\.|'|")/g,"\\$1")}function replacePathInField(path){return"".concat(splitAccessPath(path).map(escapePathAccess).join("\\."))}function replaceAll(string,find,replacement){return string.replace(new RegExp(find.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),replacement)}function removePathFromField(path){return"".concat(splitAccessPath(path).join("."))}function accessPathDepth(path){if(!path){return 0}return splitAccessPath(path).length}function getFirstDefined(){for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2]}for(var _i2=0,_args=args;_i2<_args.length;_i2++){var arg=_args[_i2];if(arg!==undefined){return arg}}return undefined}var idCounter=42;function uniqueId(prefix){var id=++idCounter;return prefix?String(prefix)+id:id}function resetIdCounter(){idCounter=42}function internalField(name){return isInternalField(name)?name:"__".concat(name)}function isInternalField(name){return name.indexOf("__")===0}function normalizeAngle(angle){if(angle===undefined){return undefined}return(angle%360+360)%360}function isNumeric(value){if(isNumber(value)){return true}return!isNaN(value)&&!isNaN(parseFloat(value))}var CONDITIONAL_AXIS_PROP_INDEX={labelAlign:{part:"labels",vgProp:"align"},labelBaseline:{part:"labels",vgProp:"baseline"},labelColor:{part:"labels",vgProp:"fill"},labelFont:{part:"labels",vgProp:"font"},labelFontSize:{part:"labels",vgProp:"fontSize"},labelFontStyle:{part:"labels",vgProp:"fontStyle"},labelFontWeight:{part:"labels",vgProp:"fontWeight"},labelOpacity:{part:"labels",vgProp:"opacity"},labelOffset:null,labelPadding:null,gridColor:{part:"grid",vgProp:"stroke"},gridDash:{part:"grid",vgProp:"strokeDash"},gridDashOffset:{part:"grid",vgProp:"strokeDashOffset"},gridOpacity:{part:"grid",vgProp:"opacity"},gridWidth:{part:"grid",vgProp:"strokeWidth"},tickColor:{part:"ticks",vgProp:"stroke"},tickDash:{part:"ticks",vgProp:"strokeDash"},tickDashOffset:{part:"ticks",vgProp:"strokeDashOffset"},tickOpacity:{part:"ticks",vgProp:"opacity"},tickSize:null,tickWidth:{part:"ticks",vgProp:"strokeWidth"}};function isConditionalAxisValue(v){return v&&v["condition"]}var AXIS_PARTS=["domain","grid","labels","ticks","title"];var AXIS_PROPERTY_TYPE={grid:"grid",gridCap:"grid",gridColor:"grid",gridDash:"grid",gridDashOffset:"grid",gridOpacity:"grid",gridScale:"grid",gridWidth:"grid",orient:"main",bandPosition:"both",aria:"main",description:"main",domain:"main",domainCap:"main",domainColor:"main",domainDash:"main",domainDashOffset:"main",domainOpacity:"main",domainWidth:"main",format:"main",formatType:"main",labelAlign:"main",labelAngle:"main",labelBaseline:"main",labelBound:"main",labelColor:"main",labelFlush:"main",labelFlushOffset:"main",labelFont:"main",labelFontSize:"main",labelFontStyle:"main",labelFontWeight:"main",labelLimit:"main",labelLineHeight:"main",labelOffset:"main",labelOpacity:"main",labelOverlap:"main",labelPadding:"main",labels:"main",labelSeparation:"main",maxExtent:"main",minExtent:"main",offset:"both",position:"main",tickCap:"main",tickColor:"main",tickDash:"main",tickDashOffset:"main",tickMinStep:"main",tickOffset:"both",tickOpacity:"main",tickRound:"both",ticks:"main",tickSize:"main",tickWidth:"both",title:"main",titleAlign:"main",titleAnchor:"main",titleAngle:"main",titleBaseline:"main",titleColor:"main",titleFont:"main",titleFontSize:"main",titleFontStyle:"main",titleFontWeight:"main",titleLimit:"main",titleLineHeight:"main",titleOpacity:"main",titlePadding:"main",titleX:"main",titleY:"main",encode:"both",scale:"both",tickBand:"both",tickCount:"both",tickExtra:"both",translate:"both",values:"both",zindex:"both"};var COMMON_AXIS_PROPERTIES_INDEX={orient:1,aria:1,bandPosition:1,description:1,domain:1,domainCap:1,domainColor:1,domainDash:1,domainDashOffset:1,domainOpacity:1,domainWidth:1,format:1,formatType:1,grid:1,gridCap:1,gridColor:1,gridDash:1,gridDashOffset:1,gridOpacity:1,gridWidth:1,labelAlign:1,labelAngle:1,labelBaseline:1,labelBound:1,labelColor:1,labelFlush:1,labelFlushOffset:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelLineHeight:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labels:1,labelSeparation:1,maxExtent:1,minExtent:1,offset:1,position:1,tickBand:1,tickCap:1,tickColor:1,tickCount:1,tickDash:1,tickDashOffset:1,tickExtra:1,tickMinStep:1,tickOffset:1,tickOpacity:1,tickRound:1,ticks:1,tickSize:1,tickWidth:1,title:1,titleAlign:1,titleAnchor:1,titleAngle:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titlePadding:1,titleX:1,titleY:1,translate:1,values:1,zindex:1};var AXIS_PROPERTIES_INDEX=_objectSpread2(_objectSpread2({},COMMON_AXIS_PROPERTIES_INDEX),{},{style:1,labelExpr:1,encoding:1});function isAxisProperty(prop){return!!AXIS_PROPERTIES_INDEX[prop]}var AXIS_CONFIGS_INDEX={axis:1,axisBand:1,axisBottom:1,axisDiscrete:1,axisLeft:1,axisPoint:1,axisQuantitative:1,axisRight:1,axisTemporal:1,axisTop:1,axisX:1,axisXBand:1,axisXDiscrete:1,axisXPoint:1,axisXQuantitative:1,axisXTemporal:1,axisY:1,axisYBand:1,axisYDiscrete:1,axisYPoint:1,axisYQuantitative:1,axisYTemporal:1};var AXIS_CONFIGS=keys(AXIS_CONFIGS_INDEX);var AGGREGATE_OP_INDEX={argmax:1,argmin:1,average:1,count:1,distinct:1,product:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1};var MULTIDOMAIN_SORT_OP_INDEX={count:1,min:1,max:1};function isArgminDef(a){return!!a&&!!a["argmin"]}function isArgmaxDef(a){return!!a&&!!a["argmax"]}function isAggregateOp(a){return isString(a)&&!!AGGREGATE_OP_INDEX[a]}var COUNTING_OPS=["count","valid","missing","distinct"];function isCountingAggregateOp(aggregate){return isString(aggregate)&&contains(COUNTING_OPS,aggregate)}function isMinMaxOp(aggregate){return isString(aggregate)&&contains(["min","max"],aggregate)}var SUM_OPS=["count","sum","distinct","valid","missing"];var SHARED_DOMAIN_OPS=["mean","average","median","q1","q3","min","max"];var SHARED_DOMAIN_OP_INDEX=toSet(SHARED_DOMAIN_OPS);var ROW="row";var COLUMN="column";var FACET="facet";var X="x";var Y="y";var X2="x2";var Y2="y2";var RADIUS="radius";var RADIUS2="radius2";var THETA="theta";var THETA2="theta2";var LATITUDE="latitude";var LONGITUDE="longitude";var LATITUDE2="latitude2";var LONGITUDE2="longitude2";var COLOR="color";var FILL="fill";var STROKE="stroke";var SHAPE="shape";var SIZE="size";var ANGLE="angle";var OPACITY="opacity";var FILLOPACITY="fillOpacity";var STROKEOPACITY="strokeOpacity";var STROKEWIDTH="strokeWidth";var STROKEDASH="strokeDash";var TEXT="text";var ORDER="order";var DETAIL="detail";var KEY="key";var TOOLTIP="tooltip";var HREF="href";var URL="url";var DESCRIPTION="description";var POSITION_CHANNEL_INDEX={x:1,y:1,x2:1,y2:1};var POLAR_POSITION_CHANNEL_INDEX={theta:1,theta2:1,radius:1,radius2:1};function isPolarPositionChannel(c){return c in POLAR_POSITION_CHANNEL_INDEX}var GEO_POSIITON_CHANNEL_INDEX={longitude:1,longitude2:1,latitude:1,latitude2:1};function getPositionChannelFromLatLong(channel){switch(channel){case LATITUDE:return"y";case LATITUDE2:return"y2";case LONGITUDE:return"x";case LONGITUDE2:return"x2"}}function isGeoPositionChannel(c){return c in GEO_POSIITON_CHANNEL_INDEX}var GEOPOSITION_CHANNELS=keys(GEO_POSIITON_CHANNEL_INDEX);var UNIT_CHANNEL_INDEX=_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},POSITION_CHANNEL_INDEX),POLAR_POSITION_CHANNEL_INDEX),GEO_POSIITON_CHANNEL_INDEX),{},{color:1,fill:1,stroke:1,opacity:1,fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeDash:1,size:1,angle:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1,url:1,description:1});function isColorChannel(channel){return channel===COLOR||channel===FILL||channel===STROKE}var FACET_CHANNEL_INDEX={row:1,column:1,facet:1};var FACET_CHANNELS=keys(FACET_CHANNEL_INDEX);var CHANNEL_INDEX=_objectSpread2(_objectSpread2({},UNIT_CHANNEL_INDEX),FACET_CHANNEL_INDEX);var CHANNELS=keys(CHANNEL_INDEX);var _o=CHANNEL_INDEX.order,_d=CHANNEL_INDEX.detail,_tt1=CHANNEL_INDEX.tooltip,SINGLE_DEF_CHANNEL_INDEX=_objectWithoutProperties(CHANNEL_INDEX,["order","detail","tooltip"]);var _r=SINGLE_DEF_CHANNEL_INDEX.row,_c=SINGLE_DEF_CHANNEL_INDEX.column,_f=SINGLE_DEF_CHANNEL_INDEX.facet,SINGLE_DEF_UNIT_CHANNEL_INDEX=_objectWithoutProperties(SINGLE_DEF_CHANNEL_INDEX,["row","column","facet"]);function isSingleDefUnitChannel(str){return!!SINGLE_DEF_UNIT_CHANNEL_INDEX[str]}function isChannel(str){return!!CHANNEL_INDEX[str]}var SECONDARY_RANGE_CHANNEL=[X2,Y2,LATITUDE2,LONGITUDE2,THETA2,RADIUS2];function isSecondaryRangeChannel(c){var main=getMainRangeChannel(c);return main!==c}function getMainRangeChannel(channel){switch(channel){case X2:return X;case Y2:return Y;case LATITUDE2:return LATITUDE;case LONGITUDE2:return LONGITUDE;case THETA2:return THETA;case RADIUS2:return RADIUS}return channel}function getVgPositionChannel(channel){if(isPolarPositionChannel(channel)){switch(channel){case THETA:return"startAngle";case THETA2:return"endAngle";case RADIUS:return"outerRadius";case RADIUS2:return"innerRadius"}}return channel}function getSecondaryRangeChannel(channel){switch(channel){case X:return X2;case Y:return Y2;case LATITUDE:return LATITUDE2;case LONGITUDE:return LONGITUDE2;case THETA:return THETA2;case RADIUS:return RADIUS2}return undefined}function getSizeChannel(channel){switch(channel){case X:case X2:return"width";case Y:case Y2:return"height"}return undefined}function getOffsetChannel(channel){switch(channel){case X:return"xOffset";case Y:return"yOffset";case X2:return"x2Offset";case Y2:return"y2Offset";case THETA:return"thetaOffset";case RADIUS:return"radiusOffset";case THETA2:return"theta2Offset";case RADIUS2:return"radius2Offset"}return undefined}var _x=UNIT_CHANNEL_INDEX.x,_y=UNIT_CHANNEL_INDEX.y,_x2=UNIT_CHANNEL_INDEX.x2,_y2=UNIT_CHANNEL_INDEX.y2,_latitude=UNIT_CHANNEL_INDEX.latitude,_longitude=UNIT_CHANNEL_INDEX.longitude,_latitude2=UNIT_CHANNEL_INDEX.latitude2,_longitude2=UNIT_CHANNEL_INDEX.longitude2,_theta=UNIT_CHANNEL_INDEX.theta,_theta2=UNIT_CHANNEL_INDEX.theta2,_radius=UNIT_CHANNEL_INDEX.radius,_radius2=UNIT_CHANNEL_INDEX.radius2,NONPOSITION_CHANNEL_INDEX=_objectWithoutProperties(UNIT_CHANNEL_INDEX,["x","y","x2","y2","latitude","longitude","latitude2","longitude2","theta","theta2","radius","radius2"]);var NONPOSITION_CHANNELS=keys(NONPOSITION_CHANNEL_INDEX);var POSITION_SCALE_CHANNEL_INDEX={x:1,y:1};var POSITION_SCALE_CHANNELS=keys(POSITION_SCALE_CHANNEL_INDEX);function isXorY(channel){return channel in POSITION_SCALE_CHANNEL_INDEX}var POLAR_POSITION_SCALE_CHANNEL_INDEX={theta:1,radius:1};var POLAR_POSITION_SCALE_CHANNELS=keys(POLAR_POSITION_SCALE_CHANNEL_INDEX);function getPositionScaleChannel(sizeType){return sizeType==="width"?X:Y}var _t=NONPOSITION_CHANNEL_INDEX.text,_tt=NONPOSITION_CHANNEL_INDEX.tooltip,_hr=NONPOSITION_CHANNEL_INDEX.href,_u=NONPOSITION_CHANNEL_INDEX.url,_al=NONPOSITION_CHANNEL_INDEX.description,_dd=NONPOSITION_CHANNEL_INDEX.detail,_k=NONPOSITION_CHANNEL_INDEX.key,_oo=NONPOSITION_CHANNEL_INDEX.order,NONPOSITION_SCALE_CHANNEL_INDEX=_objectWithoutProperties(NONPOSITION_CHANNEL_INDEX,["text","tooltip","href","url","description","detail","key","order"]);var NONPOSITION_SCALE_CHANNELS=keys(NONPOSITION_SCALE_CHANNEL_INDEX);function isNonPositionScaleChannel(channel){return!!NONPOSITION_CHANNEL_INDEX[channel]}function supportLegend(channel){switch(channel){case COLOR:case FILL:case STROKE:case SIZE:case SHAPE:case OPACITY:case STROKEWIDTH:case STROKEDASH:return true;case FILLOPACITY:case STROKEOPACITY:case ANGLE:return false}}var SCALE_CHANNEL_INDEX=_objectSpread2(_objectSpread2(_objectSpread2({},POSITION_SCALE_CHANNEL_INDEX),POLAR_POSITION_SCALE_CHANNEL_INDEX),NONPOSITION_SCALE_CHANNEL_INDEX);var SCALE_CHANNELS=keys(SCALE_CHANNEL_INDEX);function isScaleChannel(channel){return!!SCALE_CHANNEL_INDEX[channel]}function supportMark(channel,mark){return getSupportedMark(channel)[mark]}var ALL_MARKS={arc:"always",area:"always",bar:"always",circle:"always",geoshape:"always",image:"always",line:"always",rule:"always",point:"always",rect:"always",square:"always",trail:"always",text:"always",tick:"always"};var ALL_MARKS_EXCEPT_GEOSHAPE=_objectWithoutProperties(ALL_MARKS,["geoshape"]);function getSupportedMark(channel){switch(channel){case COLOR:case FILL:case STROKE:case DESCRIPTION:case DETAIL:case KEY:case TOOLTIP:case HREF:case ORDER:case OPACITY:case FILLOPACITY:case STROKEOPACITY:case STROKEWIDTH:case FACET:case ROW:case COLUMN:return ALL_MARKS;case X:case Y:case LATITUDE:case LONGITUDE:return ALL_MARKS_EXCEPT_GEOSHAPE;case X2:case Y2:case LATITUDE2:case LONGITUDE2:return{area:"always",bar:"always",image:"always",rect:"always",rule:"always",circle:"binned",point:"binned",square:"binned",tick:"binned",line:"binned",trail:"binned"};case SIZE:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",text:"always",line:"always",trail:"always"};case STROKEDASH:return{line:"always",point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",geoshape:"always"};case SHAPE:return{point:"always",geoshape:"always"};case TEXT:return{text:"always"};case ANGLE:return{point:"always",square:"always",text:"always"};case URL:return{image:"always"};case THETA:return{text:"always",arc:"always"};case RADIUS:return{text:"always",arc:"always"};case THETA2:case RADIUS2:return{arc:"always"}}}function rangeType(channel){switch(channel){case X:case Y:case THETA:case RADIUS:case SIZE:case ANGLE:case STROKEWIDTH:case OPACITY:case FILLOPACITY:case STROKEOPACITY:case X2:case Y2:case THETA2:case RADIUS2:return undefined;case FACET:case ROW:case COLUMN:case SHAPE:case STROKEDASH:case TEXT:case TOOLTIP:case HREF:case URL:case DESCRIPTION:return"discrete";case COLOR:case FILL:case STROKE:return"flexible";case LATITUDE:case LONGITUDE:case LATITUDE2:case LONGITUDE2:case DETAIL:case KEY:case ORDER:return undefined}}function binToString(bin){if(isBoolean(bin)){bin=normalizeBin(bin,undefined)}return"bin"+keys(bin).map((function(p){return isSelectionExtent(bin[p])?varName("_".concat(p,"_").concat(entries(bin[p]))):varName("_".concat(p,"_").concat(bin[p]))})).join("")}function isBinning(bin){return bin===true||isBinParams(bin)&&!bin.binned}function isBinned(bin){return bin==="binned"||isBinParams(bin)&&bin.binned===true}function isBinParams(bin){return isObject(bin)}function isSelectionExtent(extent){return extent===null||extent===void 0?void 0:extent["selection"]}function autoMaxBins(channel){switch(channel){case ROW:case COLUMN:case SIZE:case COLOR:case FILL:case STROKE:case STROKEWIDTH:case OPACITY:case FILLOPACITY:case STROKEOPACITY:case SHAPE:return 6;case STROKEDASH:return 4;default:return 10}}function invalidSpec(spec){return"Invalid specification ".concat(JSON.stringify(spec),'. Make sure the specification includes at least one of the following properties: "mark", "layer", "facet", "hconcat", "vconcat", "concat", or "repeat".')}var FIT_NON_SINGLE='Autosize "fit" only works for single views and layered views.';function containerSizeNonSingle(name){var uName=name=="width"?"Width":"Height";return"".concat(uName,' "container" only works for single views and layered views.')}function containerSizeNotCompatibleWithAutosize(name){var uName=name=="width"?"Width":"Height";var fitDirection=name=="width"?"x":"y";return"".concat(uName,' "container" only works well with autosize "fit" or "fit-').concat(fitDirection,'".')}function droppingFit(channel){return channel?'Dropping "fit-'.concat(channel,'" because spec has discrete ').concat(getSizeChannel(channel),"."):'Dropping "fit" because spec has discrete size.'}function unknownField(channel){return"Unknown field for ".concat(channel,". Cannot calculate view size.")}function cannotProjectOnChannelWithoutField(channel){return'Cannot project a selection on encoding channel "'.concat(channel,'", which has no field.')}function cannotProjectAggregate(channel,aggregate){return'Cannot project a selection on encoding channel "'.concat(channel,'" as it uses an aggregate function ("').concat(aggregate,'").')}function nearestNotSupportForContinuous(mark){return'The "nearest" transform is not supported for '.concat(mark," marks.")}function selectionNotSupported(mark){return"Selection not supported for ".concat(mark," yet.")}function selectionNotFound(name){return'Cannot find a selection named "'.concat(name,'".')}var SCALE_BINDINGS_CONTINUOUS="Scale bindings are currently only supported for scales with unbinned, continuous domains.";var LEGEND_BINDINGS_MUST_HAVE_PROJECTION="Legend bindings are only supported for selections over an individual field or encoding channel.";function noSameUnitLookup(name){return'Cannot define and lookup the "'.concat(name,'" selection in the same view. ')+"Try moving the lookup into a second, layered view?"}var NEEDS_SAME_SELECTION="The same selection must be used to override scale domains in a layered view.";var INTERVAL_INITIALIZED_WITH_X_Y='Interval selections should be initialized using "x" and/or "y" keys.';function noSuchRepeatedValue(field){return'Unknown repeated value "'.concat(field,'".')}function columnsNotSupportByRowCol(type){return'The "columns" property cannot be used when "'.concat(type,'" has nested row/column.')}var CONCAT_CANNOT_SHARE_AXIS="Axes cannot be shared in concatenated or repeated views yet (https://github.com/vega/vega-lite/issues/2415).";function unrecognizedParse(p){return'Unrecognized parse "'.concat(p,'".')}function differentParse(field,local,ancestor){return'An ancestor parsed field "'.concat(field,'" as ').concat(ancestor," but a child wants to parse the field as ").concat(local,".")}var ADD_SAME_CHILD_TWICE="Attempt to add the same child twice.";function invalidTransformIgnored(transform){return"Ignoring an invalid transform: ".concat(stringify(transform),".")}var NO_FIELDS_NEEDS_AS='If "from.fields" is not specified, "as" has to be a string that specifies the key to be used for the data from the secondary source.';function customFormatTypeNotAllowed(channel){return"Config.customFormatTypes is not true, thus custom format type and format for channel ".concat(channel," are dropped.")}function projectionOverridden(opt){var parentProjection=opt.parentProjection,projection=opt.projection;return"Layer's shared projection ".concat(stringify(parentProjection)," is overridden by a child projection ").concat(stringify(projection),".")}var REPLACE_ANGLE_WITH_THETA="Arc marks uses theta channel rather than angle, replacing angle with theta.";function primitiveChannelDef(channel,type,value){return"Channel ".concat(channel," is a ").concat(type,". Converted to {value: ").concat(stringify(value),"}.")}function invalidFieldType(type){return'Invalid field type "'.concat(type,'".')}function invalidFieldTypeForCountAggregate(type,aggregate){return'Invalid field type "'.concat(type,'" for aggregate: "').concat(aggregate,'", using "quantitative" instead.')}function invalidAggregate(aggregate){return'Invalid aggregation operator "'.concat(aggregate,'".')}function droppingColor(type,opt){var fill=opt.fill,stroke=opt.stroke;return"Dropping color ".concat(type," as the plot also has ").concat(fill&&stroke?"fill and stroke":fill?"fill":"stroke",".")}function emptyFieldDef(fieldDef,channel){return"Dropping ".concat(stringify(fieldDef),' from channel "').concat(channel,'" since it does not contain any data field, datum, value, or signal.')}var LINE_WITH_VARYING_SIZE="Line marks cannot encode size with a non-groupby field. You may want to use trail marks instead.";function incompatibleChannel(channel,markOrFacet,when){return"".concat(channel,' dropped as it is incompatible with "').concat(markOrFacet,'"').concat(when?" when ".concat(when):"",".")}function invalidEncodingChannel(channel){return"".concat(channel,"-encoding is dropped as ").concat(channel," is not a valid encoding channel.")}function facetChannelShouldBeDiscrete(channel){return"".concat(channel," encoding should be discrete (ordinal / nominal / binned).")}function facetChannelDropped(channels){return"Facet encoding dropped as ".concat(channels.join(" and ")," ").concat(channels.length>1?"are":"is"," also specified.")}function discreteChannelCannotEncode(channel,type){return'Using discrete channel "'.concat(channel,'" to encode "').concat(type,'" field can be misleading as it does not encode ').concat(type==="ordinal"?"order":"magnitude",".")}function rangeMarkAlignmentCannotBeExpression(align){return"The ".concat(align," for range marks cannot be an expression")}function lineWithRange(hasX2,hasY2){var channels=hasX2&&hasY2?"x2 and y2":hasX2?"x2":"y2";return"Line mark is for continuous lines and thus cannot be used with ".concat(channels,". We will use the rule mark (line segments) instead.")}function orientOverridden(original,actual){return'Specified orient "'.concat(original,'" overridden with "').concat(actual,'".')}var RANGE_STEP_DEPRECATED='Scale\'s "rangeStep" is deprecated and will be removed in Vega-Lite 5.0. Please use "width"/"height": {"step": ...} instead. See https://vega.github.io/vega-lite/docs/size.html.';function cannotUseScalePropertyWithNonColor(prop){return'Cannot use the scale property "'.concat(prop,'" with non-color channel.')}function unaggregateDomainHasNoEffectForRawField(fieldDef){return"Using unaggregated domain with raw field has no effect (".concat(stringify(fieldDef),").")}function unaggregateDomainWithNonSharedDomainOp(aggregate){return'Unaggregated domain not applicable for "'.concat(aggregate,'" since it produces values outside the origin domain of the source data.')}function unaggregatedDomainWithLogScale(fieldDef){return"Unaggregated domain is currently unsupported for log scale (".concat(stringify(fieldDef),").")}function cannotApplySizeToNonOrientedMark(mark){return'Cannot apply size to non-oriented mark "'.concat(mark,'".')}function scaleTypeNotWorkWithChannel(channel,scaleType,defaultScaleType){return'Channel "'.concat(channel,'" does not work with "').concat(scaleType,'" scale. We are using "').concat(defaultScaleType,'" scale instead.')}function scaleTypeNotWorkWithFieldDef(scaleType,defaultScaleType){return'FieldDef does not work with "'.concat(scaleType,'" scale. We are using "').concat(defaultScaleType,'" scale instead.')}function scalePropertyNotWorkWithScaleType(scaleType,propName,channel){return"".concat(channel,"-scale's \"").concat(propName,'" is dropped as it does not work with ').concat(scaleType," scale.")}function stepDropped(channel){return'The step for "'.concat(channel,'" is dropped because the ').concat(channel==="width"?"x":"y"," is continuous.")}function mergeConflictingProperty(property,propertyOf,v1,v2){return"Conflicting ".concat(propertyOf.toString(),' property "').concat(property.toString(),'" (').concat(stringify(v1)," and ").concat(stringify(v2),"). Using ").concat(stringify(v1),".")}function mergeConflictingDomainProperty(property,propertyOf,v1,v2){return"Conflicting ".concat(propertyOf.toString(),' property "').concat(property.toString(),'" (').concat(stringify(v1)," and ").concat(stringify(v2),"). Using the union of the two domains.")}function independentScaleMeansIndependentGuide(channel){return'Setting the scale to be independent for "'.concat(channel,'" means we also have to set the guide (axis or legend) to be independent.')}function domainSortDropped(sort){return"Dropping sort property ".concat(stringify(sort),' as unioned domains only support boolean or op "count", "min", and "max".')}var MORE_THAN_ONE_SORT="Domains that should be unioned has conflicting sort properties. Sort will be set to true.";var FACETED_INDEPENDENT_DIFFERENT_SOURCES="Detected faceted independent scales that union domain of multiple fields from different data sources. We will use the first field. The result view size may be incorrect.";var FACETED_INDEPENDENT_SAME_FIELDS_DIFFERENT_SOURCES="Detected faceted independent scales that union domain of the same fields from different source. We will assume that this is the same field from a different fork of the same data source. However, if this is not the case, the result view size may be incorrect.";var FACETED_INDEPENDENT_SAME_SOURCE="Detected faceted independent scales that union domain of multiple fields from the same data source. We will use the first field. The result view size may be incorrect.";function cannotStackRangedMark(channel){return'Cannot stack "'.concat(channel,'" if there is already "').concat(channel,'2".')}function cannotStackNonLinearScale(scaleType){return"Cannot stack non-linear scale (".concat(scaleType,").")}function stackNonSummativeAggregate(aggregate){return'Stacking is applied even though the aggregate function is non-summative ("'.concat(aggregate,'").')}function invalidTimeUnit(unitName,value){return"Invalid ".concat(unitName,": ").concat(stringify(value),".")}function droppedDay(d){return"Dropping day from datetime ".concat(stringify(d)," as day cannot be combined with other units.")}function errorBarCenterAndExtentAreNotNeeded(center,extent){return"".concat(extent?"extent ":"").concat(extent&&center?"and ":"").concat(center?"center ":"").concat(extent&&center?"are ":"is ","not needed when data are aggregated.")}function errorBarCenterIsUsedWithWrongExtent(center,extent,mark){return"".concat(center," is not usually used with ").concat(extent," for ").concat(mark,".")}function errorBarContinuousAxisHasCustomizedAggregate(aggregate,compositeMark){return"Continuous axis should not have customized aggregation function ".concat(aggregate,"; ").concat(compositeMark," already agregates the axis.")}function errorBand1DNotSupport(property){return"1D error band does not support ".concat(property,".")}function channelRequiredForBinned(channel){return"Channel ".concat(channel,' is required for "binned" bin.')}function channelShouldNotBeUsedForBinned(channel){return"Channel ".concat(channel,' should not be used with "binned" bin.')}function domainRequiredForThresholdScale(channel){return"Domain for ".concat(channel," is required for threshold scale.")}var main=logger(Warn);var current=main;function set(newLogger){current=newLogger;return current}function reset(){current=main;return current}function warn(){var _current2;(_current2=current).warn.apply(_current2,arguments)}function debug(){var _current4;(_current4=current).debug.apply(_current4,arguments)}function isDateTime(o){if(o&&isObject(o)){var _iterator=_createForOfIteratorHelper(TIMEUNIT_PARTS),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var part=_step.value;if(part in o){return true}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}return false}var MONTHS=["january","february","march","april","may","june","july","august","september","october","november","december"];var SHORT_MONTHS=MONTHS.map((function(m){return m.substr(0,3)}));var DAYS=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];var SHORT_DAYS=DAYS.map((function(d){return d.substr(0,3)}));function normalizeQuarter(q){if(isNumeric(q)){q=+q}if(isNumber(q)){if(q>4){warn(invalidTimeUnit("quarter",q))}return q-1}else{throw new Error(invalidTimeUnit("quarter",q))}}function normalizeMonth(m){if(isNumeric(m)){m=+m}if(isNumber(m)){return m-1}else{var lowerM=m.toLowerCase();var monthIndex=MONTHS.indexOf(lowerM);if(monthIndex!==-1){return monthIndex}var shortM=lowerM.substr(0,3);var shortMonthIndex=SHORT_MONTHS.indexOf(shortM);if(shortMonthIndex!==-1){return shortMonthIndex}throw new Error(invalidTimeUnit("month",m))}}function normalizeDay(d){if(isNumeric(d)){d=+d}if(isNumber(d)){return d%7}else{var lowerD=d.toLowerCase();var dayIndex=DAYS.indexOf(lowerD);if(dayIndex!==-1){return dayIndex}var shortD=lowerD.substr(0,3);var shortDayIndex=SHORT_DAYS.indexOf(shortD);if(shortDayIndex!==-1){return shortDayIndex}throw new Error(invalidTimeUnit("day",d))}}function dateTimeParts(d,normalize){var parts=[];if(normalize&&d.day!==undefined){if(keys(d).length>1){warn(droppedDay(d));d=duplicate(d);delete d.day}}if(d.year!==undefined){parts.push(d.year)}else{parts.push(2012)}if(d.month!==undefined){var month=normalize?normalizeMonth(d.month):d.month;parts.push(month)}else if(d.quarter!==undefined){var quarter=normalize?normalizeQuarter(d.quarter):d.quarter;parts.push(isNumber(quarter)?quarter*3:quarter+"*3")}else{parts.push(0)}if(d.date!==undefined){parts.push(d.date)}else if(d.day!==undefined){var day=normalize?normalizeDay(d.day):d.day;parts.push(isNumber(day)?day+1:day+"+1")}else{parts.push(1)}var _iterator2=_createForOfIteratorHelper(["hours","minutes","seconds","milliseconds"]),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var timeUnit=_step2.value;var unit=d[timeUnit];parts.push(typeof unit==="undefined"?0:unit)}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return parts}function dateTimeToExpr(d){var parts=dateTimeParts(d,true);var string=parts.join(", ");if(d.utc){return"utc(".concat(string,")")}else{return"datetime(".concat(string,")")}}function dateTimeExprToExpr(d){var parts=dateTimeParts(d,false);var string=parts.join(", ");if(d.utc){return"utc(".concat(string,")")}else{return"datetime(".concat(string,")")}}function dateTimeToTimestamp(d){var parts=dateTimeParts(d,true);if(d.utc){return+new Date(Date.UTC.apply(Date,_toConsumableArray(parts)))}else{return+_construct(Date,_toConsumableArray(parts))}}var LOCAL_SINGLE_TIMEUNIT_INDEX={year:1,quarter:1,month:1,week:1,day:1,dayofyear:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1};var TIMEUNIT_PARTS=keys(LOCAL_SINGLE_TIMEUNIT_INDEX);function isLocalSingleTimeUnit(timeUnit){return!!LOCAL_SINGLE_TIMEUNIT_INDEX[timeUnit]}function isUTCTimeUnit(t){return t.startsWith("utc")}function getLocalTimeUnit(t){return t.substr(3)}var VEGALITE_TIMEFORMAT={"year-month":"%b %Y ","year-month-date":"%b %d, %Y "};function getTimeUnitParts(timeUnit){var parts=[];var _iterator=_createForOfIteratorHelper(TIMEUNIT_PARTS),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var part=_step.value;if(containsTimeUnit(timeUnit,part)){parts.push(part)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return parts}function containsTimeUnit(fullTimeUnit,timeUnit){var index=fullTimeUnit.indexOf(timeUnit);if(index<0){return false}if(index>0&&timeUnit==="seconds"&&fullTimeUnit.charAt(index-1)==="i"){return false}if(fullTimeUnit.length>index+3&&timeUnit==="day"&&fullTimeUnit.charAt(index+3)==="o"){return false}if(index>0&&timeUnit==="year"&&fullTimeUnit.charAt(index-1)==="f"){return false}return true}function fieldExpr(fullTimeUnit,field){var _ref=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{end:false},end=_ref.end;var fieldRef=accessPathWithDatum(field);var utc=isUTCTimeUnit(fullTimeUnit)?"utc":"";function func(timeUnit){if(timeUnit==="quarter"){return"(".concat(utc,"quarter(").concat(fieldRef,")-1)")}else{return"".concat(utc).concat(timeUnit,"(").concat(fieldRef,")")}}var lastTimeUnit;var dateExpr={};var _iterator2=_createForOfIteratorHelper(TIMEUNIT_PARTS),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var part=_step2.value;if(containsTimeUnit(fullTimeUnit,part)){dateExpr[part]=func(part);lastTimeUnit=part}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}if(end){dateExpr[lastTimeUnit]+="+1"}return dateTimeExprToExpr(dateExpr)}function timeUnitSpecifierExpression(timeUnit){if(!timeUnit){return undefined}var timeUnitParts=getTimeUnitParts(timeUnit);return"timeUnitSpecifier(".concat(fastJsonStableStringify(timeUnitParts),", ").concat(fastJsonStableStringify(VEGALITE_TIMEFORMAT),")")}function formatExpression(timeUnit,field,isUTCScale){if(!timeUnit){return undefined}var expr=timeUnitSpecifierExpression(timeUnit);var utc=isUTCScale||isUTCTimeUnit(timeUnit);return"".concat(utc?"utc":"time","Format(").concat(field,", ").concat(expr,")")}function normalizeTimeUnit(timeUnit){if(!timeUnit){return undefined}var params;if(isString(timeUnit)){params={unit:timeUnit}}else if(isObject(timeUnit)){params=_objectSpread2(_objectSpread2({},timeUnit),timeUnit.unit?{unit:timeUnit.unit}:{})}if(isUTCTimeUnit(params.unit)){params.utc=true;params.unit=getLocalTimeUnit(params.unit)}return params}function timeUnitToString(tu){var _normalizeTimeUnit=normalizeTimeUnit(tu),utc=_normalizeTimeUnit.utc,rest=_objectWithoutProperties(_normalizeTimeUnit,["utc"]);if(rest.unit){return(utc?"utc":"")+keys(rest).map((function(p){return varName("".concat(p==="unit"?"":"_".concat(p,"_")).concat(rest[p]))})).join("")}else{return(utc?"utc":"")+"timeunit"+keys(rest).map((function(p){return varName("_".concat(p,"_").concat(rest[p]))})).join("")}}function isSignalRef(o){return o&&!!o["signal"]}function isVgRangeStep(range){return!!range["step"]}function isDataRefUnionedDomain(domain){if(!isArray(domain)){return"fields"in domain&&!("data"in domain)}return false}function isFieldRefUnionDomain(domain){if(!isArray(domain)){return"fields"in domain&&"data"in domain}return false}function isDataRefDomain(domain){if(!isArray(domain)){return"field"in domain&&"data"in domain}return false}var VG_MARK_CONFIG_INDEX={aria:1,description:1,ariaRole:1,ariaRoleDescription:1,blend:1,opacity:1,fill:1,fillOpacity:1,stroke:1,strokeCap:1,strokeWidth:1,strokeOpacity:1,strokeDash:1,strokeDashOffset:1,strokeJoin:1,strokeOffset:1,strokeMiterLimit:1,startAngle:1,endAngle:1,padAngle:1,innerRadius:1,outerRadius:1,size:1,shape:1,interpolate:1,tension:1,orient:1,align:1,baseline:1,text:1,dir:1,dx:1,dy:1,ellipsis:1,limit:1,radius:1,theta:1,angle:1,font:1,fontSize:1,fontWeight:1,fontStyle:1,lineBreak:1,lineHeight:1,cursor:1,href:1,tooltip:1,cornerRadius:1,cornerRadiusTopLeft:1,cornerRadiusTopRight:1,cornerRadiusBottomLeft:1,cornerRadiusBottomRight:1,aspect:1,width:1,height:1,url:1,smooth:1};var VG_MARK_CONFIGS=keys(VG_MARK_CONFIG_INDEX);var VG_MARK_INDEX={arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1};var VG_CORNERRADIUS_CHANNELS=["cornerRadius","cornerRadiusTopLeft","cornerRadiusTopRight","cornerRadiusBottomLeft","cornerRadiusBottomRight"];function isSelectionPredicate(predicate){return predicate===null||predicate===void 0?void 0:predicate["selection"]}function isFieldEqualPredicate(predicate){return predicate&&!!predicate.field&&predicate.equal!==undefined}function isFieldLTPredicate(predicate){return predicate&&!!predicate.field&&predicate.lt!==undefined}function isFieldLTEPredicate(predicate){return predicate&&!!predicate.field&&predicate.lte!==undefined}function isFieldGTPredicate(predicate){return predicate&&!!predicate.field&&predicate.gt!==undefined}function isFieldGTEPredicate(predicate){return predicate&&!!predicate.field&&predicate.gte!==undefined}function isFieldRangePredicate(predicate){if(predicate&&predicate.field){if(isArray(predicate.range)&&predicate.range.length===2){return true}else if(isSignalRef(predicate.range)){return true}}return false}function isFieldOneOfPredicate(predicate){return predicate&&!!predicate.field&&(isArray(predicate.oneOf)||isArray(predicate.in))}function isFieldValidPredicate(predicate){return predicate&&!!predicate.field&&predicate.valid!==undefined}function isFieldPredicate(predicate){return isFieldOneOfPredicate(predicate)||isFieldEqualPredicate(predicate)||isFieldRangePredicate(predicate)||isFieldLTPredicate(predicate)||isFieldGTPredicate(predicate)||isFieldLTEPredicate(predicate)||isFieldGTEPredicate(predicate)}function predicateValueExpr(v,timeUnit){return valueExpr(v,{timeUnit:timeUnit,wrapTime:true})}function predicateValuesExpr(vals,timeUnit){return vals.map((function(v){return predicateValueExpr(v,timeUnit)}))}function fieldFilterExpression(predicate){var _normalizeTimeUnit;var useInRange=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var field=predicate.field;var timeUnit=(_normalizeTimeUnit=normalizeTimeUnit(predicate.timeUnit))===null||_normalizeTimeUnit===void 0?void 0:_normalizeTimeUnit.unit;var fieldExpr$1=timeUnit?"time("+fieldExpr(timeUnit,field)+")":vgField(predicate,{expr:"datum"});if(isFieldEqualPredicate(predicate)){return fieldExpr$1+"==="+predicateValueExpr(predicate.equal,timeUnit)}else if(isFieldLTPredicate(predicate)){var upper=predicate.lt;return"".concat(fieldExpr$1,"<").concat(predicateValueExpr(upper,timeUnit))}else if(isFieldGTPredicate(predicate)){var lower=predicate.gt;return"".concat(fieldExpr$1,">").concat(predicateValueExpr(lower,timeUnit))}else if(isFieldLTEPredicate(predicate)){var _upper=predicate.lte;return"".concat(fieldExpr$1,"<=").concat(predicateValueExpr(_upper,timeUnit))}else if(isFieldGTEPredicate(predicate)){var _lower=predicate.gte;return"".concat(fieldExpr$1,">=").concat(predicateValueExpr(_lower,timeUnit))}else if(isFieldOneOfPredicate(predicate)){return"indexof([".concat(predicateValuesExpr(predicate.oneOf,timeUnit).join(","),"], ").concat(fieldExpr$1,") !== -1")}else if(isFieldValidPredicate(predicate)){return fieldValidPredicate(fieldExpr$1,predicate.valid)}else if(isFieldRangePredicate(predicate)){var range=predicate.range;var _lower2=isSignalRef(range)?{signal:"".concat(range.signal,"[0]")}:range[0];var _upper2=isSignalRef(range)?{signal:"".concat(range.signal,"[1]")}:range[1];if(_lower2!==null&&_upper2!==null&&useInRange){return"inrange("+fieldExpr$1+", ["+predicateValueExpr(_lower2,timeUnit)+", "+predicateValueExpr(_upper2,timeUnit)+"])"}var exprs=[];if(_lower2!==null){exprs.push("".concat(fieldExpr$1," >= ").concat(predicateValueExpr(_lower2,timeUnit)))}if(_upper2!==null){exprs.push("".concat(fieldExpr$1," <= ").concat(predicateValueExpr(_upper2,timeUnit)))}return exprs.length>0?exprs.join(" && "):"true"}throw new Error("Invalid field predicate: ".concat(JSON.stringify(predicate)))}function fieldValidPredicate(fieldExpr){var valid=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(valid){return"isValid(".concat(fieldExpr,") && isFinite(+").concat(fieldExpr,")")}else{return"!isValid(".concat(fieldExpr,") || !isFinite(+").concat(fieldExpr,")")}}function normalizePredicate(f){if(isFieldPredicate(f)&&f.timeUnit){var _normalizeTimeUnit2;return _objectSpread2(_objectSpread2({},f),{},{timeUnit:(_normalizeTimeUnit2=normalizeTimeUnit(f.timeUnit))===null||_normalizeTimeUnit2===void 0?void 0:_normalizeTimeUnit2.unit})}return f}var Type={quantitative:"quantitative",ordinal:"ordinal",temporal:"temporal",nominal:"nominal",geojson:"geojson"};var QUANTITATIVE=Type.quantitative;var ORDINAL=Type.ordinal;var TEMPORAL=Type.temporal;var NOMINAL=Type.nominal;var GEOJSON=Type.geojson;function getFullName(type){if(type){type=type.toLowerCase();switch(type){case"q":case QUANTITATIVE:return"quantitative";case"t":case TEMPORAL:return"temporal";case"o":case ORDINAL:return"ordinal";case"n":case NOMINAL:return"nominal";case GEOJSON:return"geojson"}}return undefined}var ScaleType={LINEAR:"linear",LOG:"log",POW:"pow",SQRT:"sqrt",SYMLOG:"symlog",IDENTITY:"identity",SEQUENTIAL:"sequential",TIME:"time",UTC:"utc",QUANTILE:"quantile",QUANTIZE:"quantize",THRESHOLD:"threshold",BIN_ORDINAL:"bin-ordinal",ORDINAL:"ordinal",POINT:"point",BAND:"band"};var SCALE_CATEGORY_INDEX={linear:"numeric",log:"numeric",pow:"numeric",sqrt:"numeric",symlog:"numeric",identity:"numeric",sequential:"numeric",time:"time",utc:"time",ordinal:"ordinal","bin-ordinal":"bin-ordinal",point:"ordinal-position",band:"ordinal-position",quantile:"discretizing",quantize:"discretizing",threshold:"discretizing"};function scaleCompatible(scaleType1,scaleType2){var scaleCategory1=SCALE_CATEGORY_INDEX[scaleType1];var scaleCategory2=SCALE_CATEGORY_INDEX[scaleType2];return scaleCategory1===scaleCategory2||scaleCategory1==="ordinal-position"&&scaleCategory2==="time"||scaleCategory2==="ordinal-position"&&scaleCategory1==="time"}var SCALE_PRECEDENCE_INDEX={linear:0,log:1,pow:1,sqrt:1,symlog:1,identity:1,sequential:1,time:0,utc:0,point:10,band:11,ordinal:0,"bin-ordinal":0,quantile:0,quantize:0,threshold:0};function scaleTypePrecedence(scaleType){return SCALE_PRECEDENCE_INDEX[scaleType]}var CONTINUOUS_TO_CONTINUOUS_SCALES=["linear","log","pow","sqrt","symlog","time","utc"];var CONTINUOUS_TO_CONTINUOUS_INDEX=toSet(CONTINUOUS_TO_CONTINUOUS_SCALES);var QUANTITATIVE_SCALES=["linear","log","pow","sqrt","symlog"];var QUANTITATIVE_SCALES_INDEX=toSet(QUANTITATIVE_SCALES);function isQuantitative(type){return type in QUANTITATIVE_SCALES_INDEX}var CONTINUOUS_TO_DISCRETE_SCALES=["quantile","quantize","threshold"];var CONTINUOUS_TO_DISCRETE_INDEX=toSet(CONTINUOUS_TO_DISCRETE_SCALES);var CONTINUOUS_DOMAIN_SCALES=CONTINUOUS_TO_CONTINUOUS_SCALES.concat(["quantile","quantize","threshold","sequential","identity"]);var CONTINUOUS_DOMAIN_INDEX=toSet(CONTINUOUS_DOMAIN_SCALES);var DISCRETE_DOMAIN_SCALES=["ordinal","bin-ordinal","point","band"];var DISCRETE_DOMAIN_INDEX=toSet(DISCRETE_DOMAIN_SCALES);function hasDiscreteDomain(type){return type in DISCRETE_DOMAIN_INDEX}function hasContinuousDomain(type){return type in CONTINUOUS_DOMAIN_INDEX}function isContinuousToContinuous(type){return type in CONTINUOUS_TO_CONTINUOUS_INDEX}function isContinuousToDiscrete(type){return type in CONTINUOUS_TO_DISCRETE_INDEX}var defaultScaleConfig={pointPadding:.5,barBandPaddingInner:.1,rectBandPaddingInner:0,minBandSize:2,minFontSize:8,maxFontSize:40,minOpacity:.3,maxOpacity:.8,minSize:9,minStrokeWidth:1,maxStrokeWidth:4,quantileCount:4,quantizeCount:4};function isExtendedScheme(scheme){return!isString(scheme)&&!!scheme["name"]}function isSelectionDomain(domain){return domain===null||domain===void 0?void 0:domain["selection"]}function isDomainUnionWith(domain){return domain&&domain["unionWith"]}var SCALE_PROPERTY_INDEX={type:1,domain:1,domainMax:1,domainMin:1,domainMid:1,align:1,range:1,rangeMax:1,rangeMin:1,scheme:1,bins:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,constant:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1};var NON_TYPE_DOMAIN_RANGE_VEGA_SCALE_PROPERTY_INDEX=_objectWithoutProperties(SCALE_PROPERTY_INDEX,["type","domain","range","rangeMax","rangeMin","scheme"]);var NON_TYPE_DOMAIN_RANGE_VEGA_SCALE_PROPERTIES=keys(NON_TYPE_DOMAIN_RANGE_VEGA_SCALE_PROPERTY_INDEX);function scaleTypeSupportProperty(scaleType,propName){switch(propName){case"type":case"domain":case"reverse":case"range":return true;case"scheme":case"interpolate":return!contains(["point","band","identity"],scaleType);case"bins":return!contains(["point","band","identity","ordinal"],scaleType);case"round":return isContinuousToContinuous(scaleType)||scaleType==="band"||scaleType==="point";case"padding":case"rangeMin":case"rangeMax":return isContinuousToContinuous(scaleType)||contains(["point","band"],scaleType);case"paddingOuter":case"align":return contains(["point","band"],scaleType);case"paddingInner":return scaleType==="band";case"domainMax":case"domainMid":case"domainMin":case"clamp":return isContinuousToContinuous(scaleType);case"nice":return isContinuousToContinuous(scaleType)||scaleType==="quantize"||scaleType==="threshold";case"exponent":return scaleType==="pow";case"base":return scaleType==="log";case"constant":return scaleType==="symlog";case"zero":return hasContinuousDomain(scaleType)&&!contains(["log","time","utc","threshold","quantile"],scaleType)}}function channelScalePropertyIncompatability(channel,propName){switch(propName){case"interpolate":case"scheme":case"domainMid":if(!isColorChannel(channel)){return cannotUseScalePropertyWithNonColor(channel)}return undefined;case"align":case"type":case"bins":case"domain":case"domainMax":case"domainMin":case"range":case"base":case"exponent":case"constant":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeMax":case"rangeMin":case"reverse":case"round":case"clamp":case"zero":return undefined}}function scaleTypeSupportDataType(specifiedType,fieldDefType){if(contains([ORDINAL,NOMINAL],fieldDefType)){return specifiedType===undefined||hasDiscreteDomain(specifiedType)}else if(fieldDefType===TEMPORAL){return contains([ScaleType.TIME,ScaleType.UTC,undefined],specifiedType)}else if(fieldDefType===QUANTITATIVE){return contains([ScaleType.LOG,ScaleType.POW,ScaleType.SQRT,ScaleType.SYMLOG,ScaleType.QUANTILE,ScaleType.QUANTIZE,ScaleType.THRESHOLD,ScaleType.LINEAR,undefined],specifiedType)}return true}function channelSupportScaleType(channel,scaleType){if(!isScaleChannel(channel)){return false}switch(channel){case X:case Y:case THETA:case RADIUS:return isContinuousToContinuous(scaleType)||contains(["band","point"],scaleType);case SIZE:case STROKEWIDTH:case OPACITY:case FILLOPACITY:case STROKEOPACITY:case ANGLE:return isContinuousToContinuous(scaleType)||isContinuousToDiscrete(scaleType)||contains(["band","point","ordinal"],scaleType);case COLOR:case FILL:case STROKE:return scaleType!=="band";case STROKEDASH:return scaleType==="ordinal"||isContinuousToDiscrete(scaleType);case SHAPE:return scaleType==="ordinal"}}function isExprRef(o){return o&&!!o["expr"]}function replaceExprRefInIndex(index){var props=keys(index||{});var newIndex={};var _iterator=_createForOfIteratorHelper(props),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var prop=_step.value;newIndex[prop]=signalRefOrValue(index[prop])}}catch(err){_iterator.e(err)}finally{_iterator.f()}return newIndex}var Mark={arc:"arc",area:"area",bar:"bar",image:"image",line:"line",point:"point",rect:"rect",rule:"rule",text:"text",tick:"tick",trail:"trail",circle:"circle",square:"square",geoshape:"geoshape"};var ARC=Mark.arc;var AREA=Mark.area;var BAR=Mark.bar;var IMAGE=Mark.image;var LINE=Mark.line;var POINT=Mark.point;var RECT=Mark.rect;var RULE=Mark.rule;var TEXT$1=Mark.text;var TICK=Mark.tick;var TRAIL=Mark.trail;var CIRCLE=Mark.circle;var SQUARE=Mark.square;var GEOSHAPE=Mark.geoshape;function isPathMark(m){return contains(["line","area","trail"],m)}function isRectBasedMark(m){return contains(["rect","bar","image","arc"],m)}var PRIMITIVE_MARKS=keys(Mark);function isMarkDef(mark){return mark["type"]}var PRIMITIVE_MARK_INDEX=toSet(PRIMITIVE_MARKS);var STROKE_CONFIG=["stroke","strokeWidth","strokeDash","strokeDashOffset","strokeOpacity","strokeJoin","strokeMiterLimit"];var FILL_CONFIG=["fill","fillOpacity"];var FILL_STROKE_CONFIG=[].concat(STROKE_CONFIG,FILL_CONFIG);var VL_ONLY_MARK_CONFIG_INDEX={color:1,filled:1,invalid:1,order:1,radius2:1,theta2:1,timeUnitBand:1,timeUnitBandPosition:1};var VL_ONLY_MARK_CONFIG_PROPERTIES=keys(VL_ONLY_MARK_CONFIG_INDEX);var VL_ONLY_MARK_SPECIFIC_CONFIG_PROPERTY_INDEX={area:["line","point"],bar:["binSpacing","continuousBandSize","discreteBandSize"],rect:["binSpacing","continuousBandSize","discreteBandSize"],line:["point"],tick:["bandSize","thickness"]};var defaultMarkConfig={color:"#4c78a8",invalid:"filter",timeUnitBand:1};var MARK_CONFIG_INDEX={mark:1,arc:1,area:1,bar:1,circle:1,image:1,line:1,point:1,rect:1,rule:1,square:1,text:1,tick:1,trail:1,geoshape:1};var MARK_CONFIGS=keys(MARK_CONFIG_INDEX);var BAR_CORNER_RADIUS_INDEX={horizontal:["cornerRadiusTopRight","cornerRadiusBottomRight"],vertical:["cornerRadiusTopLeft","cornerRadiusTopRight"]};var DEFAULT_RECT_BAND_SIZE=5;var defaultBarConfig={binSpacing:1,continuousBandSize:DEFAULT_RECT_BAND_SIZE,timeUnitBandPosition:.5};var defaultRectConfig={binSpacing:0,continuousBandSize:DEFAULT_RECT_BAND_SIZE,timeUnitBandPosition:.5};var defaultTickConfig={thickness:1};function getMarkType(m){return isMarkDef(m)?m.type:m}function midPointRefWithPositionInvalidTest(params){var channel=params.channel,channelDef=params.channelDef,markDef=params.markDef,scale=params.scale,config=params.config;var ref=midPoint(params);if(isFieldDef(channelDef)&&!isCountingAggregateOp(channelDef.aggregate)&&scale&&isContinuousToContinuous(scale.get("type"))&&scale.get("zero")===false){return wrapPositionInvalidTest({fieldDef:channelDef,channel:channel,markDef:markDef,ref:ref,config:config})}return ref}function wrapPositionInvalidTest(_ref){var fieldDef=_ref.fieldDef,channel=_ref.channel,markDef=_ref.markDef,ref=_ref.ref,config=_ref.config;if(isPathMark(markDef.type)){return ref}var invalid=getMarkPropOrConfig("invalid",markDef,config);if(invalid===null){return ref}return[fieldInvalidTestValueRef(fieldDef,channel),ref]}function fieldInvalidTestValueRef(fieldDef,channel){var test=fieldInvalidPredicate(fieldDef,true);var mainChannel=getMainRangeChannel(channel);var zeroValueRef=mainChannel==="y"?{field:{group:"height"}}:{value:0};return _objectSpread2({test:test},zeroValueRef)}function fieldInvalidPredicate(field){var invalid=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;return fieldValidPredicate(isString(field)?field:vgField(field,{expr:"datum"}),!invalid)}function datumDefToExpr(datumDef){var datum=datumDef.datum;if(isDateTime(datum)){return dateTimeToExpr(datum)}return"".concat(JSON.stringify(datum))}function valueRefForFieldOrDatumDef(fieldDef,scaleName,opt,encode){var ref={};if(scaleName){ref.scale=scaleName}if(isDatumDef(fieldDef)){var datum=fieldDef.datum;if(isDateTime(datum)){ref.signal=dateTimeToExpr(datum)}else if(isSignalRef(datum)){ref.signal=datum.signal}else if(isExprRef(datum)){ref.signal=datum.expr}else{ref.value=datum}}else{ref.field=vgField(fieldDef,opt)}if(encode){var offset=encode.offset,band=encode.band;if(offset){ref.offset=offset}if(band){ref.band=band}}return ref}function interpolatedSignalRef(_ref2){var scaleName=_ref2.scaleName,fieldOrDatumDef=_ref2.fieldOrDatumDef,fieldOrDatumDef2=_ref2.fieldOrDatumDef2,offset=_ref2.offset,startSuffix=_ref2.startSuffix,_ref2$band=_ref2.band,band=_ref2$band===void 0?.5:_ref2$band;var expr=0<band&&band<1?"datum":undefined;var start=vgField(fieldOrDatumDef,{expr:expr,suffix:startSuffix});var end=fieldOrDatumDef2!==undefined?vgField(fieldOrDatumDef2,{expr:expr}):vgField(fieldOrDatumDef,{suffix:"end",expr:expr});var ref={};if(band===0||band===1){ref.scale=scaleName;var val=band===0?start:end;ref.field=val}else{var datum="".concat(band," * ").concat(start," + ").concat(1-band," * ").concat(end);ref.signal='scale("'.concat(scaleName,'", ').concat(datum,")")}if(offset){ref.offset=offset}return ref}function midPoint(_ref3){var channel=_ref3.channel,channelDef=_ref3.channelDef,channel2Def=_ref3.channel2Def,markDef=_ref3.markDef,config=_ref3.config,scaleName=_ref3.scaleName,scale=_ref3.scale,stack=_ref3.stack,offset=_ref3.offset,defaultRef=_ref3.defaultRef,band=_ref3.band;if(channelDef){if(isFieldOrDatumDef(channelDef)){var _ref4,_band2;if(isTypedFieldDef(channelDef)){var _band;band=(_band=band)!==null&&_band!==void 0?_band:getBand({channel:channel,fieldDef:channelDef,fieldDef2:channel2Def,markDef:markDef,stack:stack,config:config,isMidPoint:true});var bin=channelDef.bin,timeUnit=channelDef.timeUnit,type=channelDef.type;if(isBinning(bin)||band&&timeUnit&&type===TEMPORAL){if(stack&&stack.impute){return valueRefForFieldOrDatumDef(channelDef,scaleName,{binSuffix:"mid"},{offset:offset})}if(band){return interpolatedSignalRef({scaleName:scaleName,fieldOrDatumDef:channelDef,band:band,offset:offset})}return valueRefForFieldOrDatumDef(channelDef,scaleName,binRequiresRange(channelDef,channel)?{binSuffix:"range"}:{},{offset:offset})}else if(isBinned(bin)){if(isFieldDef(channel2Def)){return interpolatedSignalRef({scaleName:scaleName,fieldOrDatumDef:channelDef,fieldOrDatumDef2:channel2Def,band:band,offset:offset})}else{var channel2=channel===X?X2:Y2;warn(channelRequiredForBinned(channel2))}}}var scaleType=scale===null||scale===void 0?void 0:scale.get("type");return valueRefForFieldOrDatumDef(channelDef,scaleName,hasDiscreteDomain(scaleType)?{binSuffix:"range"}:{},{offset:offset,band:scaleType==="band"?(_ref4=(_band2=band)!==null&&_band2!==void 0?_band2:channelDef.band)!==null&&_ref4!==void 0?_ref4:.5:undefined})}else if(isValueDef(channelDef)){var value=channelDef.value;var offsetMixins=offset?{offset:offset}:{};return _objectSpread2(_objectSpread2({},widthHeightValueOrSignalRef(channel,value)),offsetMixins)}}if(isFunction(defaultRef)){defaultRef=defaultRef()}if(defaultRef){return _objectSpread2(_objectSpread2({},defaultRef),offset?{offset:offset}:{})}return defaultRef}function widthHeightValueOrSignalRef(channel,value){if(contains(["x","x2"],channel)&&value==="width"){return{field:{group:"width"}}}else if(contains(["y","y2"],channel)&&value==="height"){return{field:{group:"height"}}}return signalOrValueRef(value)}function isCustomFormatType(formatType){return formatType&&formatType!=="number"&&formatType!=="time"}function customFormatExpr(formatType,field,format){return"".concat(formatType,"(").concat(field).concat(format?", ".concat(JSON.stringify(format)):"",")")}var BIN_RANGE_DELIMITER="  ";function formatSignalRef(_ref){var fieldOrDatumDef=_ref.fieldOrDatumDef,format=_ref.format,formatType=_ref.formatType,expr=_ref.expr,normalizeStack=_ref.normalizeStack,config=_ref.config;if(isCustomFormatType(formatType)){return formatCustomType({fieldOrDatumDef:fieldOrDatumDef,format:format,formatType:formatType,expr:expr,config:config})}var field=fieldToFormat(fieldOrDatumDef,expr,normalizeStack);if(isFieldOrDatumDefForTimeFormat(fieldOrDatumDef)){var _normalizeTimeUnit,_fieldOrDatumDef$scal;var signal=timeFormatExpression(field,isFieldDef(fieldOrDatumDef)?(_normalizeTimeUnit=normalizeTimeUnit(fieldOrDatumDef.timeUnit))===null||_normalizeTimeUnit===void 0?void 0:_normalizeTimeUnit.unit:undefined,format,config.timeFormat,isScaleFieldDef(fieldOrDatumDef)&&((_fieldOrDatumDef$scal=fieldOrDatumDef.scale)===null||_fieldOrDatumDef$scal===void 0?void 0:_fieldOrDatumDef$scal.type)===ScaleType.UTC);return signal?{signal:signal}:undefined}format=numberFormat(channelDefType(fieldOrDatumDef),format,config);if(isFieldDef(fieldOrDatumDef)&&isBinning(fieldOrDatumDef.bin)){var endField=vgField(fieldOrDatumDef,{expr:expr,binSuffix:"end"});return{signal:binFormatExpression(field,endField,format,formatType,config)}}else if(format||channelDefType(fieldOrDatumDef)==="quantitative"){return{signal:"".concat(formatExpr(field,format))}}else{return{signal:"isValid(".concat(field,") ? ").concat(field,' : ""+').concat(field)}}}function fieldToFormat(fieldOrDatumDef,expr,normalizeStack){if(isFieldDef(fieldOrDatumDef)){if(normalizeStack){return"".concat(vgField(fieldOrDatumDef,{expr:expr,suffix:"end"}),"-").concat(vgField(fieldOrDatumDef,{expr:expr,suffix:"start"}))}else{return vgField(fieldOrDatumDef,{expr:expr})}}else{return datumDefToExpr(fieldOrDatumDef)}}function formatCustomType(_ref2){var _field;var fieldOrDatumDef=_ref2.fieldOrDatumDef,format=_ref2.format,formatType=_ref2.formatType,expr=_ref2.expr,normalizeStack=_ref2.normalizeStack,config=_ref2.config,field=_ref2.field;field=(_field=field)!==null&&_field!==void 0?_field:fieldToFormat(fieldOrDatumDef,expr,normalizeStack);if(isFieldDef(fieldOrDatumDef)&&isBinning(fieldOrDatumDef.bin)){var endField=vgField(fieldOrDatumDef,{expr:expr,binSuffix:"end"});return{signal:binFormatExpression(field,endField,format,formatType,config)}}return{signal:customFormatExpr(formatType,field,format)}}function guideFormat(fieldOrDatumDef,type,format,formatType,config,omitTimeFormatConfig){if(isCustomFormatType(formatType)){return undefined}if(isFieldOrDatumDefForTimeFormat(fieldOrDatumDef)){var _normalizeTimeUnit2;var timeUnit=isFieldDef(fieldOrDatumDef)?(_normalizeTimeUnit2=normalizeTimeUnit(fieldOrDatumDef.timeUnit))===null||_normalizeTimeUnit2===void 0?void 0:_normalizeTimeUnit2.unit:undefined;return timeFormat(format,timeUnit,config,omitTimeFormatConfig)}return numberFormat(type,format,config)}function guideFormatType(formatType,fieldOrDatumDef,scaleType){if(formatType&&(isSignalRef(formatType)||formatType==="number"||formatType==="time")){return formatType}if(isFieldOrDatumDefForTimeFormat(fieldOrDatumDef)&&scaleType!=="time"&&scaleType!=="utc"){return"time"}return undefined}function numberFormat(type,specifiedFormat,config){if(isString(specifiedFormat)){return specifiedFormat}if(type===QUANTITATIVE){return config.numberFormat}return undefined}function timeFormat(specifiedFormat,timeUnit,config,omitTimeFormatConfig){if(specifiedFormat){return specifiedFormat}if(timeUnit){return{signal:timeUnitSpecifierExpression(timeUnit)}}return omitTimeFormatConfig?undefined:config.timeFormat}function formatExpr(field,format){return"format(".concat(field,', "').concat(format||"",'")')}function binNumberFormatExpr(field,format,formatType,config){var _ref3;if(isCustomFormatType(formatType)){return customFormatExpr(formatType,field,format)}return formatExpr(field,(_ref3=isString(format)?format:undefined)!==null&&_ref3!==void 0?_ref3:config.numberFormat)}function binFormatExpression(startField,endField,format,formatType,config){var start=binNumberFormatExpr(startField,format,formatType,config);var end=binNumberFormatExpr(endField,format,formatType,config);return"".concat(fieldValidPredicate(startField,false),' ? "null" : ').concat(start,' + "').concat(BIN_RANGE_DELIMITER,'" + ').concat(end)}function timeFormatExpression(field,timeUnit,format,rawTimeFormat,isUTCScale){if(!timeUnit||format){format=isString(format)?format:rawTimeFormat;return"".concat(isUTCScale?"utc":"time","Format(").concat(field,", '").concat(format,"')")}else{return formatExpression(timeUnit,field,isUTCScale)}}var DEFAULT_SORT_OP="min";var SORT_BY_CHANNEL_INDEX={x:1,y:1,color:1,fill:1,stroke:1,strokeWidth:1,size:1,shape:1,fillOpacity:1,strokeOpacity:1,opacity:1,text:1};function isSortByChannel(c){return c in SORT_BY_CHANNEL_INDEX}function isSortByEncoding(sort){return!!sort&&!!sort["encoding"]}function isSortField(sort){return!!sort&&(sort["op"]==="count"||!!sort["field"])}function isSortArray(sort){return!!sort&&isArray(sort)}function isFacetMapping(f){return"row"in f||"column"in f}function isFacetFieldDef(channelDef){return!!channelDef&&"header"in channelDef}function isFacetSpec(spec){return"facet"in spec}function isConditionalSelection(c){return c["selection"]}function isRepeatRef(field){return field&&!isString(field)&&"repeat"in field}function toFieldDefBase(fieldDef){var field=fieldDef.field,timeUnit=fieldDef.timeUnit,bin=fieldDef.bin,aggregate=fieldDef.aggregate;return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},timeUnit?{timeUnit:timeUnit}:{}),bin?{bin:bin}:{}),aggregate?{aggregate:aggregate}:{}),{},{field:field})}function isSortableFieldDef(fieldDef){return"sort"in fieldDef}function getBand(_ref){var channel=_ref.channel,fieldDef=_ref.fieldDef,fieldDef2=_ref.fieldDef2,mark=_ref.markDef,stack=_ref.stack,config=_ref.config,isMidPoint=_ref.isMidPoint;if(isFieldOrDatumDef(fieldDef)&&fieldDef.band!==undefined){return fieldDef.band}if(isFieldDef(fieldDef)){var timeUnit=fieldDef.timeUnit,bin=fieldDef.bin;if(timeUnit&&!fieldDef2){if(isMidPoint){return getMarkConfig("timeUnitBandPosition",mark,config)}else{return isRectBasedMark(mark.type)?getMarkConfig("timeUnitBand",mark,config):0}}else if(isBinning(bin)){return isRectBasedMark(mark.type)&&!isMidPoint?1:.5}}if((stack===null||stack===void 0?void 0:stack.fieldChannel)===channel&&isMidPoint){return.5}return undefined}function hasBand(channel,fieldDef,fieldDef2,stack,markDef,config){if(isBinning(fieldDef.bin)||fieldDef.timeUnit&&isTypedFieldDef(fieldDef)&&fieldDef.type==="temporal"){return!!getBand({channel:channel,fieldDef:fieldDef,fieldDef2:fieldDef2,stack:stack,markDef:markDef,config:config})}return false}function isConditionalDef(channelDef){return!!channelDef&&"condition"in channelDef}function hasConditionalFieldDef(channelDef){var condition=channelDef&&channelDef["condition"];return!!condition&&!isArray(condition)&&isFieldDef(condition)}function hasConditionalFieldOrDatumDef(channelDef){var condition=channelDef&&channelDef["condition"];return!!condition&&!isArray(condition)&&isFieldOrDatumDef(condition)}function hasConditionalValueDef(channelDef){var condition=channelDef&&channelDef["condition"];return!!condition&&(isArray(condition)||isValueDef(condition))}function isFieldDef(channelDef){return!!channelDef&&(!!channelDef["field"]||channelDef["aggregate"]==="count")}function channelDefType(channelDef){return channelDef&&channelDef["type"]}function isDatumDef(channelDef){return!!channelDef&&"datum"in channelDef}function isContinuousFieldOrDatumDef(cd){return isTypedFieldDef(cd)&&isContinuous(cd)||isNumericDataDef(cd)}function isNumericDataDef(cd){return isDatumDef(cd)&&isNumber(cd.datum)}function isFieldOrDatumDef(channelDef){return isFieldDef(channelDef)||isDatumDef(channelDef)}function isTypedFieldDef(channelDef){return!!channelDef&&("field"in channelDef||channelDef["aggregate"]==="count")&&"type"in channelDef}function isValueDef(channelDef){return channelDef&&"value"in channelDef&&"value"in channelDef}function isScaleFieldDef(channelDef){return!!channelDef&&("scale"in channelDef||"sort"in channelDef)}function isPositionFieldOrDatumDef(channelDef){return channelDef&&("axis"in channelDef||"stack"in channelDef||"impute"in channelDef)}function isMarkPropFieldOrDatumDef(channelDef){return!!channelDef&&"legend"in channelDef}function isStringFieldOrDatumDef(channelDef){return!!channelDef&&("format"in channelDef||"formatType"in channelDef)}function toStringFieldDef(fieldDef){return omit(fieldDef,["legend","axis","header","scale"])}function isOpFieldDef(fieldDef){return"op"in fieldDef}function vgField(fieldDef){var opt=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var field=fieldDef.field;var prefix=opt.prefix;var suffix=opt.suffix;var argAccessor="";if(isCount(fieldDef)){field=internalField("count")}else{var fn;if(!opt.nofn){if(isOpFieldDef(fieldDef)){fn=fieldDef.op}else{var bin=fieldDef.bin,aggregate=fieldDef.aggregate,timeUnit=fieldDef.timeUnit;if(isBinning(bin)){var _opt$binSuffix,_opt$suffix;fn=binToString(bin);suffix=((_opt$binSuffix=opt.binSuffix)!==null&&_opt$binSuffix!==void 0?_opt$binSuffix:"")+((_opt$suffix=opt.suffix)!==null&&_opt$suffix!==void 0?_opt$suffix:"")}else if(aggregate){if(isArgmaxDef(aggregate)){argAccessor='["'.concat(field,'"]');field="argmax_".concat(aggregate.argmax)}else if(isArgminDef(aggregate)){argAccessor='["'.concat(field,'"]');field="argmin_".concat(aggregate.argmin)}else{fn=String(aggregate)}}else if(timeUnit){var _opt$suffix2;fn=timeUnitToString(timeUnit);suffix=(!contains(["range","mid"],opt.binSuffix)&&opt.binSuffix||"")+((_opt$suffix2=opt.suffix)!==null&&_opt$suffix2!==void 0?_opt$suffix2:"")}}}if(fn){field=field?"".concat(fn,"_").concat(field):fn}}if(suffix){field="".concat(field,"_").concat(suffix)}if(prefix){field="".concat(prefix,"_").concat(field)}if(opt.forAs){return removePathFromField(field)}else if(opt.expr){return flatAccessWithDatum(field,opt.expr)+argAccessor}else{return replacePathInField(field)+argAccessor}}function isDiscrete(def){switch(def.type){case"nominal":case"ordinal":case"geojson":return true;case"quantitative":return isFieldDef(def)&&!!def.bin;case"temporal":return false}throw new Error(invalidFieldType(def.type))}function isContinuous(fieldDef){return!isDiscrete(fieldDef)}function isCount(fieldDef){return fieldDef.aggregate==="count"}function verbalTitleFormatter(fieldDef,config){var field=fieldDef.field,bin=fieldDef.bin,timeUnit=fieldDef.timeUnit,aggregate=fieldDef.aggregate;if(aggregate==="count"){return config.countTitle}else if(isBinning(bin)){return"".concat(field," (binned)")}else if(timeUnit){var _normalizeTimeUnit;var unit=(_normalizeTimeUnit=normalizeTimeUnit(timeUnit))===null||_normalizeTimeUnit===void 0?void 0:_normalizeTimeUnit.unit;if(unit){return"".concat(field," (").concat(getTimeUnitParts(unit).join("-"),")")}}else if(aggregate){if(isArgmaxDef(aggregate)){return"".concat(field," for max ").concat(aggregate.argmax)}else if(isArgminDef(aggregate)){return"".concat(field," for min ").concat(aggregate.argmin)}else{return"".concat(titleCase(aggregate)," of ").concat(field)}}return field}function functionalTitleFormatter(fieldDef){var aggregate=fieldDef.aggregate,bin=fieldDef.bin,timeUnit=fieldDef.timeUnit,field=fieldDef.field;if(isArgmaxDef(aggregate)){return"".concat(field," for argmax(").concat(aggregate.argmax,")")}else if(isArgminDef(aggregate)){return"".concat(field," for argmin(").concat(aggregate.argmin,")")}var timeUnitParams=normalizeTimeUnit(timeUnit);var fn=aggregate||(timeUnitParams===null||timeUnitParams===void 0?void 0:timeUnitParams.unit)||(timeUnitParams===null||timeUnitParams===void 0?void 0:timeUnitParams.maxbins)&&"timeunit"||isBinning(bin)&&"bin";if(fn){return fn.toUpperCase()+"("+field+")"}else{return field}}var defaultTitleFormatter=function defaultTitleFormatter(fieldDef,config){switch(config.fieldTitle){case"plain":return fieldDef.field;case"functional":return functionalTitleFormatter(fieldDef);default:return verbalTitleFormatter(fieldDef,config)}};var titleFormatter=defaultTitleFormatter;function setTitleFormatter(formatter){titleFormatter=formatter}function resetTitleFormatter(){setTitleFormatter(defaultTitleFormatter)}function title(fieldOrDatumDef,config,_ref2){var _getGuide;var allowDisabling=_ref2.allowDisabling,_ref2$includeDefault=_ref2.includeDefault,includeDefault=_ref2$includeDefault===void 0?true:_ref2$includeDefault;var guideTitle=(_getGuide=getGuide(fieldOrDatumDef))===null||_getGuide===void 0?void 0:_getGuide.title;if(!isFieldDef(fieldOrDatumDef)){return guideTitle}var fieldDef=fieldOrDatumDef;var def=includeDefault?defaultTitle(fieldDef,config):undefined;if(allowDisabling){return getFirstDefined(guideTitle,fieldDef.title,def)}else{var _ref3;return(_ref3=guideTitle!==null&&guideTitle!==void 0?guideTitle:fieldDef.title)!==null&&_ref3!==void 0?_ref3:def}}function getGuide(fieldDef){if(isPositionFieldOrDatumDef(fieldDef)&&fieldDef.axis){return fieldDef.axis}else if(isMarkPropFieldOrDatumDef(fieldDef)&&fieldDef.legend){return fieldDef.legend}else if(isFacetFieldDef(fieldDef)&&fieldDef.header){return fieldDef.header}return undefined}function defaultTitle(fieldDef,config){return titleFormatter(fieldDef,config)}function getFormatMixins(fieldDef){if(isStringFieldOrDatumDef(fieldDef)){var format=fieldDef.format,formatType=fieldDef.formatType;return{format:format,formatType:formatType}}else{var _getGuide2;var guide=(_getGuide2=getGuide(fieldDef))!==null&&_getGuide2!==void 0?_getGuide2:{};var _format=guide.format,_formatType=guide.formatType;return{format:_format,formatType:_formatType}}}function defaultType(fieldDef,channel){var _fieldDef$scale;switch(channel){case"latitude":case"longitude":return"quantitative";case"row":case"column":case"facet":case"shape":case"strokeDash":return"nominal";case"order":return"ordinal"}if(isSortableFieldDef(fieldDef)&&isArray(fieldDef.sort)){return"ordinal"}var aggregate=fieldDef.aggregate,bin=fieldDef.bin,timeUnit=fieldDef.timeUnit;if(timeUnit){return"temporal"}if(bin||aggregate&&!isArgmaxDef(aggregate)&&!isArgminDef(aggregate)){return"quantitative"}if(isScaleFieldDef(fieldDef)&&((_fieldDef$scale=fieldDef.scale)===null||_fieldDef$scale===void 0?void 0:_fieldDef$scale.type)){switch(SCALE_CATEGORY_INDEX[fieldDef.scale.type]){case"numeric":case"discretizing":return"quantitative";case"time":return"temporal"}}return"nominal"}function getFieldDef(channelDef){if(isFieldDef(channelDef)){return channelDef}else if(hasConditionalFieldDef(channelDef)){return channelDef.condition}return undefined}function getFieldOrDatumDef(channelDef){if(isFieldOrDatumDef(channelDef)){return channelDef}else if(hasConditionalFieldOrDatumDef(channelDef)){return channelDef.condition}return undefined}function initChannelDef(channelDef,channel,config){var opt=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};if(isString(channelDef)||isNumber(channelDef)||isBoolean(channelDef)){var primitiveType=isString(channelDef)?"string":isNumber(channelDef)?"number":"boolean";warn(primitiveChannelDef(channel,primitiveType,channelDef));return{value:channelDef}}if(isFieldOrDatumDef(channelDef)){return initFieldOrDatumDef(channelDef,channel,config,opt)}else if(hasConditionalFieldOrDatumDef(channelDef)){return _objectSpread2(_objectSpread2({},channelDef),{},{condition:initFieldOrDatumDef(channelDef.condition,channel,config,opt)})}return channelDef}function initFieldOrDatumDef(fd,channel,config,opt){if(isStringFieldOrDatumDef(fd)){var format=fd.format,formatType=fd.formatType,rest=_objectWithoutProperties(fd,["format","formatType"]);if(isCustomFormatType(formatType)&&!config.customFormatTypes){warn(customFormatTypeNotAllowed(channel));return initFieldOrDatumDef(rest,channel,config,opt)}}else{var guideType=isPositionFieldOrDatumDef(fd)?"axis":isMarkPropFieldOrDatumDef(fd)?"legend":isFacetFieldDef(fd)?"header":null;if(guideType&&fd[guideType]){var _fd$guideType=fd[guideType],_format2=_fd$guideType.format,_formatType2=_fd$guideType.formatType,newGuide=_objectWithoutProperties(_fd$guideType,["format","formatType"]);if(isCustomFormatType(_formatType2)&&!config.customFormatTypes){warn(customFormatTypeNotAllowed(channel));return initFieldOrDatumDef(_objectSpread2(_objectSpread2({},fd),{},_defineProperty({},guideType,newGuide)),channel,config,opt)}}}if(isFieldDef(fd)){return initFieldDef(fd,channel,opt)}return initDatumDef(fd)}function initDatumDef(datumDef){var type=datumDef["type"];if(type){return datumDef}var datum=datumDef.datum;type=isNumber(datum)?"quantitative":isString(datum)?"nominal":isDateTime(datum)?"temporal":undefined;return _objectSpread2(_objectSpread2({},datumDef),{},{type:type})}function initFieldDef(fd,channel){var _ref4=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},_ref4$compositeMark=_ref4.compositeMark,compositeMark=_ref4$compositeMark===void 0?false:_ref4$compositeMark;var aggregate=fd.aggregate,timeUnit=fd.timeUnit,bin=fd.bin,field=fd.field;var fieldDef=_objectSpread2({},fd);if(!compositeMark&&aggregate&&!isAggregateOp(aggregate)&&!isArgmaxDef(aggregate)&&!isArgminDef(aggregate)){warn(invalidAggregate(aggregate));delete fieldDef.aggregate}if(timeUnit){fieldDef.timeUnit=normalizeTimeUnit(timeUnit)}if(field){fieldDef.field="".concat(field)}if(isBinning(bin)){fieldDef.bin=normalizeBin(bin,channel)}if(isBinned(bin)&&!isXorY(channel)){warn(channelShouldNotBeUsedForBinned(channel))}if(isTypedFieldDef(fieldDef)){var type=fieldDef.type;var fullType=getFullName(type);if(type!==fullType){fieldDef.type=fullType}if(type!=="quantitative"){if(isCountingAggregateOp(aggregate)){warn(invalidFieldTypeForCountAggregate(type,aggregate));fieldDef.type="quantitative"}}}else if(!isSecondaryRangeChannel(channel)){var newType=defaultType(fieldDef,channel);fieldDef["type"]=newType}if(isTypedFieldDef(fieldDef)){var _ref5=channelCompatibility(fieldDef,channel)||{},compatible=_ref5.compatible,warning=_ref5.warning;if(compatible===false){warn(warning)}}if(isSortableFieldDef(fieldDef)&&isString(fieldDef.sort)){var sort=fieldDef.sort;if(isSortByChannel(sort)){return _objectSpread2(_objectSpread2({},fieldDef),{},{sort:{encoding:sort}})}var sub=sort.substr(1);if(sort.charAt(0)==="-"&&isSortByChannel(sub)){return _objectSpread2(_objectSpread2({},fieldDef),{},{sort:{encoding:sub,order:"descending"}})}}if(isFacetFieldDef(fieldDef)){var header=fieldDef.header;var orient=header.orient,rest=_objectWithoutProperties(header,["orient"]);if(orient){return _objectSpread2(_objectSpread2({},fieldDef),{},{header:_objectSpread2(_objectSpread2({},rest),{},{labelOrient:header.labelOrient||orient,titleOrient:header.titleOrient||orient})})}}return fieldDef}function normalizeBin(bin,channel){if(isBoolean(bin)){return{maxbins:autoMaxBins(channel)}}else if(bin==="binned"){return{binned:true}}else if(!bin.maxbins&&!bin.step){return _objectSpread2(_objectSpread2({},bin),{},{maxbins:autoMaxBins(channel)})}else{return bin}}var COMPATIBLE={compatible:true};function channelCompatibility(fieldDef,channel){var type=fieldDef.type;if(type==="geojson"&&channel!=="shape"){return{compatible:false,warning:"Channel ".concat(channel," should not be used with a geojson data.")}}switch(channel){case ROW:case COLUMN:case FACET:if(isContinuous(fieldDef)){return{compatible:false,warning:facetChannelShouldBeDiscrete(channel)}}return COMPATIBLE;case X:case Y:case COLOR:case FILL:case STROKE:case TEXT:case DETAIL:case KEY:case TOOLTIP:case HREF:case URL:case ANGLE:case THETA:case RADIUS:case DESCRIPTION:return COMPATIBLE;case LONGITUDE:case LONGITUDE2:case LATITUDE:case LATITUDE2:if(type!==QUANTITATIVE){return{compatible:false,warning:"Channel ".concat(channel," should be used with a quantitative field only, not ").concat(fieldDef.type," field.")}}return COMPATIBLE;case OPACITY:case FILLOPACITY:case STROKEOPACITY:case STROKEWIDTH:case SIZE:case THETA2:case RADIUS2:case X2:case Y2:if(type==="nominal"&&!fieldDef["sort"]){return{compatible:false,warning:"Channel ".concat(channel," should not be used with an unsorted discrete field.")}}return COMPATIBLE;case STROKEDASH:if(!contains(["ordinal","nominal"],fieldDef.type)){return{compatible:false,warning:"StrokeDash channel should be used with only discrete data."}}return COMPATIBLE;case SHAPE:if(!contains(["ordinal","nominal","geojson"],fieldDef.type)){return{compatible:false,warning:"Shape channel should be used with only either discrete or geojson data."}}return COMPATIBLE;case ORDER:if(fieldDef.type==="nominal"&&!("sort"in fieldDef)){return{compatible:false,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}}return COMPATIBLE}}function isFieldOrDatumDefForTimeFormat(fieldOrDatumDef){var _getFormatMixins=getFormatMixins(fieldOrDatumDef),formatType=_getFormatMixins.formatType;return formatType==="time"||!formatType&&isTimeFieldDef(fieldOrDatumDef)}function isTimeFieldDef(def){return def&&(def["type"]==="temporal"||isFieldDef(def)&&!!def.timeUnit)}function valueExpr(v,_ref6){var _normalizeTimeUnit2;var timeUnit=_ref6.timeUnit,type=_ref6.type,wrapTime=_ref6.wrapTime,undefinedIfExprNotRequired=_ref6.undefinedIfExprNotRequired;var unit=timeUnit&&((_normalizeTimeUnit2=normalizeTimeUnit(timeUnit))===null||_normalizeTimeUnit2===void 0?void 0:_normalizeTimeUnit2.unit);var isTime=unit||type==="temporal";var expr;if(isExprRef(v)){expr=v.expr}else if(isSignalRef(v)){expr=v.signal}else if(isDateTime(v)){isTime=true;expr=dateTimeToExpr(v)}else if(isString(v)||isNumber(v)){if(isTime){expr="datetime(".concat(JSON.stringify(v),")");if(isLocalSingleTimeUnit(unit)){if(isNumber(v)&&v<1e4||isString(v)&&isNaN(Date.parse(v))){expr=dateTimeToExpr(_defineProperty({},unit,v))}}}}if(expr){return wrapTime&&isTime?"time(".concat(expr,")"):expr}return undefinedIfExprNotRequired?undefined:JSON.stringify(v)}function valueArray(fieldOrDatumDef,values){var type=fieldOrDatumDef.type;return values.map((function(v){var expr=valueExpr(v,{timeUnit:isFieldDef(fieldOrDatumDef)?fieldOrDatumDef.timeUnit:undefined,type:type,undefinedIfExprNotRequired:true});if(expr!==undefined){return{signal:expr}}return v}))}function binRequiresRange(fieldDef,channel){if(!isBinning(fieldDef.bin)){console.warn("Only call this method for binned field defs.");return false}return isScaleChannel(channel)&&contains(["ordinal","nominal"],fieldDef.type)}function extractTitleConfig(titleConfig){var anchor=titleConfig.anchor,frame=titleConfig.frame,offset=titleConfig.offset,orient=titleConfig.orient,color=titleConfig.color,subtitleColor=titleConfig.subtitleColor,subtitleFont=titleConfig.subtitleFont,subtitleFontSize=titleConfig.subtitleFontSize,subtitleFontStyle=titleConfig.subtitleFontStyle,subtitleFontWeight=titleConfig.subtitleFontWeight,subtitleLineHeight=titleConfig.subtitleLineHeight,subtitlePadding=titleConfig.subtitlePadding,rest=_objectWithoutProperties(titleConfig,["anchor","frame","offset","orient","color","subtitleColor","subtitleFont","subtitleFontSize","subtitleFontStyle","subtitleFontWeight","subtitleLineHeight","subtitlePadding"]);var titleMarkConfig=_objectSpread2(_objectSpread2({},rest),color?{fill:color}:{});var nonMark=_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},anchor?{anchor:anchor}:{}),frame?{frame:frame}:{}),offset?{offset:offset}:{}),orient?{orient:orient}:{});var subtitle=_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},subtitleColor?{subtitleColor:subtitleColor}:{}),subtitleFont?{subtitleFont:subtitleFont}:{}),subtitleFontSize?{subtitleFontSize:subtitleFontSize}:{}),subtitleFontStyle?{subtitleFontStyle:subtitleFontStyle}:{}),subtitleFontWeight?{subtitleFontWeight:subtitleFontWeight}:{}),subtitleLineHeight?{subtitleLineHeight:subtitleLineHeight}:{}),subtitlePadding?{subtitlePadding:subtitlePadding}:{});var subtitleMarkConfig=pick(titleMarkConfig,["align","baseline","dx","dy","limit"]);return{titleMarkConfig:titleMarkConfig,subtitleMarkConfig:subtitleMarkConfig,nonMark:nonMark,subtitle:subtitle}}function isText(v){return isString(v)||isArray(v)&&isString(v[0])}function signalOrValueRefWithCondition(val){var condition=isArray(val.condition)?val.condition.map(conditionalSignalRefOrValue):conditionalSignalRefOrValue(val.condition);return _objectSpread2(_objectSpread2({},signalRefOrValue(val)),{},{condition:condition})}function signalRefOrValue(value){if(isExprRef(value)){var expr=value.expr,rest=_objectWithoutProperties(value,["expr"]);return _objectSpread2({signal:expr},rest)}return value}function conditionalSignalRefOrValue(value){if(isExprRef(value)){var expr=value.expr,rest=_objectWithoutProperties(value,["expr"]);return _objectSpread2({signal:expr},rest)}return value}function signalOrValueRef(value){if(isExprRef(value)){var expr=value.expr,rest=_objectWithoutProperties(value,["expr"]);return _objectSpread2({signal:expr},rest)}if(isSignalRef(value)){return value}return value!==undefined?{value:value}:undefined}function exprFromValueOrSignalRef(ref){if(isSignalRef(ref)){return ref.signal}return $(ref.value)}function signalOrStringValue(v){if(isSignalRef(v)){return v.signal}return v==null?null:$(v)}function applyMarkConfig(e,model,propsList){var _iterator=_createForOfIteratorHelper(propsList),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var property=_step.value;var value=getMarkConfig(property,model.markDef,model.config);if(value!==undefined){e[property]=signalOrValueRef(value)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return e}function getStyles(mark){var _mark$style;return[].concat(mark.type,(_mark$style=mark.style)!==null&&_mark$style!==void 0?_mark$style:[])}function getMarkPropOrConfig(channel,mark,config){var opt=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};var vgChannel=opt.vgChannel,ignoreVgConfig=opt.ignoreVgConfig;if(vgChannel&&mark[vgChannel]!==undefined){return mark[vgChannel]}else if(mark[channel]!==undefined){return mark[channel]}else if(ignoreVgConfig&&(!vgChannel||vgChannel===channel)){return undefined}return getMarkConfig(channel,mark,config,opt)}function getMarkConfig(channel,mark,config){var _ref=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{},vgChannel=_ref.vgChannel;return getFirstDefined(vgChannel?getMarkStyleConfig(channel,mark,config.style):undefined,getMarkStyleConfig(channel,mark,config.style),vgChannel?config[mark.type][vgChannel]:undefined,config[mark.type][channel],vgChannel?config.mark[vgChannel]:config.mark[channel])}function getMarkStyleConfig(prop,mark,styleConfigIndex){return getStyleConfig(prop,getStyles(mark),styleConfigIndex)}function getStyleConfig(p,styles,styleConfigIndex){styles=array(styles);var value;var _iterator2=_createForOfIteratorHelper(styles),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var style=_step2.value;var styleConfig=styleConfigIndex[style];if(styleConfig&&styleConfig[p]!==undefined){value=styleConfig[p]}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return value}function sortParams(orderDef,fieldRefOption){return array(orderDef).reduce((function(s,orderChannelDef){var _orderChannelDef$sort;s.field.push(vgField(orderChannelDef,fieldRefOption));s.order.push((_orderChannelDef$sort=orderChannelDef.sort)!==null&&_orderChannelDef$sort!==void 0?_orderChannelDef$sort:"ascending");return s}),{field:[],order:[]})}function mergeTitleFieldDefs(f1,f2){var merged=_toConsumableArray(f1);f2.forEach((function(fdToMerge){var _iterator3=_createForOfIteratorHelper(merged),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var fieldDef1=_step3.value;if(deepEqual(fieldDef1,fdToMerge)){return}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}merged.push(fdToMerge)}));return merged}function mergeTitle(title1,title2){if(deepEqual(title1,title2)||!title2){return title1}else if(!title1){return title2}else{return[].concat(_toConsumableArray(array(title1)),_toConsumableArray(array(title2))).join(", ")}}function mergeTitleComponent(v1,v2){var v1Val=v1.value;var v2Val=v2.value;if(v1Val==null||v2Val===null){return{explicit:v1.explicit,value:null}}else if((isText(v1Val)||isSignalRef(v1Val))&&(isText(v2Val)||isSignalRef(v2Val))){return{explicit:v1.explicit,value:mergeTitle(v1Val,v2Val)}}else if(isText(v1Val)||isSignalRef(v1Val)){return{explicit:v1.explicit,value:v1Val}}else if(isText(v2Val)||isSignalRef(v2Val)){return{explicit:v1.explicit,value:v2Val}}else if(!isText(v1Val)&&!isSignalRef(v1Val)&&!isText(v2Val)&&!isSignalRef(v2Val)){return{explicit:v1.explicit,value:mergeTitleFieldDefs(v1Val,v2Val)}}throw new Error("It should never reach here")}function isUnitSpec(spec){return"mark"in spec}var CompositeMarkNormalizer=function(){function CompositeMarkNormalizer(name,run){_classCallCheck(this,CompositeMarkNormalizer);this.name=name;this.run=run}_createClass(CompositeMarkNormalizer,[{key:"hasMatchingType",value:function hasMatchingType(spec){if(isUnitSpec(spec)){return getMarkType(spec.mark)===this.name}return false}}]);return CompositeMarkNormalizer}();function channelHasField(encoding,channel){var channelDef=encoding&&encoding[channel];if(channelDef){if(isArray(channelDef)){return some(channelDef,(function(fieldDef){return!!fieldDef.field}))}else{return isFieldDef(channelDef)||hasConditionalFieldDef(channelDef)}}return false}function isAggregate(encoding){return some(CHANNELS,(function(channel){if(channelHasField(encoding,channel)){var channelDef=encoding[channel];if(isArray(channelDef)){return some(channelDef,(function(fieldDef){return!!fieldDef.aggregate}))}else{var fieldDef=getFieldDef(channelDef);return fieldDef&&!!fieldDef.aggregate}}return false}))}function extractTransformsFromEncoding(oldEncoding,config){var groupby=[];var bins=[];var timeUnits=[];var aggregate=[];var encoding={};forEach(oldEncoding,(function(channelDef,channel){if(isFieldDef(channelDef)){var field=channelDef.field,aggOp=channelDef.aggregate,bin=channelDef.bin,timeUnit=channelDef.timeUnit,remaining=_objectWithoutProperties(channelDef,["field","aggregate","bin","timeUnit"]);if(aggOp||timeUnit||bin){var guide=getGuide(channelDef);var isTitleDefined=guide&&guide.title;var newField=vgField(channelDef,{forAs:true});var newFieldDef=_objectSpread2(_objectSpread2(_objectSpread2({},isTitleDefined?[]:{title:title(channelDef,config,{allowDisabling:true})}),remaining),{},{field:newField});if(aggOp){var op;if(isArgmaxDef(aggOp)){op="argmax";newField=vgField({op:"argmax",field:aggOp.argmax},{forAs:true});newFieldDef.field="".concat(newField,".").concat(field)}else if(isArgminDef(aggOp)){op="argmin";newField=vgField({op:"argmin",field:aggOp.argmin},{forAs:true});newFieldDef.field="".concat(newField,".").concat(field)}else if(aggOp!=="boxplot"&&aggOp!=="errorbar"&&aggOp!=="errorband"){op=aggOp}if(op){var aggregateEntry={op:op,as:newField};if(field){aggregateEntry.field=field}aggregate.push(aggregateEntry)}}else{groupby.push(newField);if(isTypedFieldDef(channelDef)&&isBinning(bin)){bins.push({bin:bin,field:field,as:newField});groupby.push(vgField(channelDef,{binSuffix:"end"}));if(binRequiresRange(channelDef,channel)){groupby.push(vgField(channelDef,{binSuffix:"range"}))}if(isXorY(channel)){var secondaryChannel={field:newField+"_end"};encoding[channel+"2"]=secondaryChannel}newFieldDef.bin="binned";if(!isSecondaryRangeChannel(channel)){newFieldDef["type"]=QUANTITATIVE}}else if(timeUnit){timeUnits.push({timeUnit:timeUnit,field:field,as:newField});var formatType=isTypedFieldDef(channelDef)&&channelDef.type!==TEMPORAL&&"time";if(formatType){if(channel===TEXT||channel===TOOLTIP){newFieldDef["formatType"]=formatType}else if(isNonPositionScaleChannel(channel)){newFieldDef["legend"]=_objectSpread2({formatType:formatType},newFieldDef["legend"])}else if(isXorY(channel)){newFieldDef["axis"]=_objectSpread2({formatType:formatType},newFieldDef["axis"])}}}}encoding[channel]=newFieldDef}else{groupby.push(field);encoding[channel]=oldEncoding[channel]}}else{encoding[channel]=oldEncoding[channel]}}));return{bins:bins,timeUnits:timeUnits,aggregate:aggregate,groupby:groupby,encoding:encoding}}function markChannelCompatible(encoding,channel,mark){var markSupported=supportMark(channel,mark);if(!markSupported){return false}else if(markSupported==="binned"){var primaryFieldDef=encoding[channel===X2?X:Y];if(isFieldDef(primaryFieldDef)&&isFieldDef(encoding[channel])&&isBinned(primaryFieldDef.bin)){return true}else{return false}}return true}function initEncoding(encoding,mark,filled,config){return keys(encoding).reduce((function(normalizedEncoding,channel){if(!isChannel(channel)){warn(invalidEncodingChannel(channel));return normalizedEncoding}var channelDef=encoding[channel];if(channel==="angle"&&mark==="arc"&&!encoding.theta){warn(REPLACE_ANGLE_WITH_THETA);channel=THETA}if(!markChannelCompatible(encoding,channel,mark)){warn(incompatibleChannel(channel,mark));return normalizedEncoding}if(channel===SIZE&&mark==="line"){var fieldDef=getFieldDef(encoding[channel]);if(fieldDef===null||fieldDef===void 0?void 0:fieldDef.aggregate){warn(LINE_WITH_VARYING_SIZE);return normalizedEncoding}}if(channel===COLOR&&(filled?"fill"in encoding:"stroke"in encoding)){warn(droppingColor("encoding",{fill:"fill"in encoding,stroke:"stroke"in encoding}));return normalizedEncoding}if(channel===DETAIL||channel===ORDER&&!isArray(channelDef)&&!isValueDef(channelDef)||channel===TOOLTIP&&isArray(channelDef)){if(channelDef){normalizedEncoding[channel]=array(channelDef).reduce((function(defs,fieldDef){if(!isFieldDef(fieldDef)){warn(emptyFieldDef(fieldDef,channel))}else{defs.push(initFieldDef(fieldDef,channel))}return defs}),[])}}else{if(channel===TOOLTIP&&channelDef===null){normalizedEncoding[channel]=null}else if(!isFieldDef(channelDef)&&!isDatumDef(channelDef)&&!isValueDef(channelDef)&&!isConditionalDef(channelDef)&&!isSignalRef(channelDef)){warn(emptyFieldDef(channelDef,channel));return normalizedEncoding}normalizedEncoding[channel]=initChannelDef(channelDef,channel,config)}return normalizedEncoding}),{})}function normalizeEncoding(encoding,config){var normalizedEncoding={};var _iterator=_createForOfIteratorHelper(keys(encoding)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;var newChannelDef=initChannelDef(encoding[channel],channel,config,{compositeMark:true});normalizedEncoding[channel]=newChannelDef}}catch(err){_iterator.e(err)}finally{_iterator.f()}return normalizedEncoding}function fieldDefs(encoding){var arr=[];var _iterator2=_createForOfIteratorHelper(keys(encoding)),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var channel=_step2.value;if(channelHasField(encoding,channel)){var channelDef=encoding[channel];var channelDefArray=array(channelDef);var _iterator3=_createForOfIteratorHelper(channelDefArray),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var def=_step3.value;if(isFieldDef(def)){arr.push(def)}else if(hasConditionalFieldDef(def)){arr.push(def.condition)}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return arr}function forEach(mapping,f,thisArg){if(!mapping){return}var _iterator4=_createForOfIteratorHelper(keys(mapping)),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var channel=_step4.value;var el=mapping[channel];if(isArray(el)){var _iterator5=_createForOfIteratorHelper(el),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var channelDef=_step5.value;f.call(thisArg,channelDef,channel)}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}}else{f.call(thisArg,el,channel)}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}function reduce(mapping,f,init,thisArg){if(!mapping){return init}return keys(mapping).reduce((function(r,channel){var map=mapping[channel];if(isArray(map)){return map.reduce((function(r1,channelDef){return f.call(thisArg,r1,channelDef,channel)}),r)}else{return f.call(thisArg,r,map,channel)}}),init)}function pathGroupingFields(mark,encoding){return keys(encoding).reduce((function(details,channel){switch(channel){case X:case Y:case HREF:case DESCRIPTION:case URL:case X2:case Y2:case THETA:case THETA2:case RADIUS:case RADIUS2:case LATITUDE:case LONGITUDE:case LATITUDE2:case LONGITUDE2:case TEXT:case SHAPE:case ANGLE:case TOOLTIP:return details;case ORDER:if(mark==="line"||mark==="trail"){return details}case DETAIL:case KEY:{var channelDef=encoding[channel];if(isArray(channelDef)||isFieldDef(channelDef)){var _iterator6=_createForOfIteratorHelper(array(channelDef)),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var fieldDef=_step6.value;if(!fieldDef.aggregate){details.push(vgField(fieldDef,{}))}}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}}return details}case SIZE:if(mark==="trail"){return details}case COLOR:case FILL:case STROKE:case OPACITY:case FILLOPACITY:case STROKEOPACITY:case STROKEDASH:case STROKEWIDTH:{var _fieldDef=getFieldDef(encoding[channel]);if(_fieldDef&&!_fieldDef.aggregate){details.push(vgField(_fieldDef,{}))}return details}}}),[])}function filterTooltipWithAggregatedField(oldEncoding){var tooltip=oldEncoding.tooltip,filteredEncoding=_objectWithoutProperties(oldEncoding,["tooltip"]);if(!tooltip){return{filteredEncoding:filteredEncoding}}var customTooltipWithAggregatedField;var customTooltipWithoutAggregatedField;if(isArray(tooltip)){var _iterator=_createForOfIteratorHelper(tooltip),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var t=_step.value;if(t.aggregate){if(!customTooltipWithAggregatedField){customTooltipWithAggregatedField=[]}customTooltipWithAggregatedField.push(t)}else{if(!customTooltipWithoutAggregatedField){customTooltipWithoutAggregatedField=[]}customTooltipWithoutAggregatedField.push(t)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}if(customTooltipWithAggregatedField){filteredEncoding.tooltip=customTooltipWithAggregatedField}}else{if(tooltip["aggregate"]){filteredEncoding.tooltip=tooltip}else{customTooltipWithoutAggregatedField=tooltip}}if(isArray(customTooltipWithoutAggregatedField)&&customTooltipWithoutAggregatedField.length===1){customTooltipWithoutAggregatedField=customTooltipWithoutAggregatedField[0]}return{customTooltipWithoutAggregatedField:customTooltipWithoutAggregatedField,filteredEncoding:filteredEncoding}}function getCompositeMarkTooltip(tooltipSummary,continuousAxisChannelDef,encodingWithoutContinuousAxis){var withFieldName=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;if("tooltip"in encodingWithoutContinuousAxis){return{tooltip:encodingWithoutContinuousAxis.tooltip}}var fiveSummaryTooltip=tooltipSummary.map((function(_ref){var fieldPrefix=_ref.fieldPrefix,titlePrefix=_ref.titlePrefix;var mainTitle=withFieldName?" of ".concat(getTitle(continuousAxisChannelDef)):"";return{field:fieldPrefix+continuousAxisChannelDef.field,type:continuousAxisChannelDef.type,title:isSignalRef(titlePrefix)?{signal:titlePrefix+'"'.concat(escape(mainTitle),'"')}:titlePrefix+mainTitle}}));var tooltipFieldDefs=fieldDefs(encodingWithoutContinuousAxis).map(toStringFieldDef);return{tooltip:[].concat(_toConsumableArray(fiveSummaryTooltip),_toConsumableArray(unique(tooltipFieldDefs,hash)))}}function getTitle(continuousAxisChannelDef){var title=continuousAxisChannelDef.title,field=continuousAxisChannelDef.field;return getFirstDefined(title,field)}function makeCompositeAggregatePartFactory(compositeMarkDef,continuousAxis,continuousAxisChannelDef,sharedEncoding,compositeMarkConfig){var scale=continuousAxisChannelDef.scale,axis=continuousAxisChannelDef.axis;return function(_ref2){var partName=_ref2.partName,mark=_ref2.mark,positionPrefix=_ref2.positionPrefix,_ref2$endPositionPref=_ref2.endPositionPrefix,endPositionPrefix=_ref2$endPositionPref===void 0?undefined:_ref2$endPositionPref,_ref2$extraEncoding=_ref2.extraEncoding,extraEncoding=_ref2$extraEncoding===void 0?{}:_ref2$extraEncoding;var title=getTitle(continuousAxisChannelDef);return partLayerMixins(compositeMarkDef,partName,compositeMarkConfig,{mark:mark,encoding:_objectSpread2(_objectSpread2(_objectSpread2(_defineProperty({},continuousAxis,_objectSpread2(_objectSpread2(_objectSpread2({field:positionPrefix+"_"+continuousAxisChannelDef.field,type:continuousAxisChannelDef.type},title!==undefined?{title:title}:{}),scale!==undefined?{scale:scale}:{}),axis!==undefined?{axis:axis}:{})),isString(endPositionPrefix)?_defineProperty({},continuousAxis+"2",{field:endPositionPrefix+"_"+continuousAxisChannelDef.field}):{}),sharedEncoding),extraEncoding)})}}function partLayerMixins(markDef,part,compositeMarkConfig,partBaseSpec){var clip=markDef.clip,color=markDef.color,opacity=markDef.opacity;var mark=markDef.type;if(markDef[part]||markDef[part]===undefined&&compositeMarkConfig[part]){return[_objectSpread2(_objectSpread2({},partBaseSpec),{},{mark:_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},compositeMarkConfig[part]),clip?{clip:clip}:{}),color?{color:color}:{}),opacity?{opacity:opacity}:{}),isMarkDef(partBaseSpec.mark)?partBaseSpec.mark:{type:partBaseSpec.mark}),{},{style:"".concat(mark,"-").concat(part)},isBoolean(markDef[part])?{}:markDef[part])})]}return[]}function compositeMarkContinuousAxis(spec,orient,compositeMark){var encoding=spec.encoding;var continuousAxis=orient==="vertical"?"y":"x";var continuousAxisChannelDef=encoding[continuousAxis];var continuousAxisChannelDef2=encoding[continuousAxis+"2"];var continuousAxisChannelDefError=encoding[continuousAxis+"Error"];var continuousAxisChannelDefError2=encoding[continuousAxis+"Error2"];return{continuousAxisChannelDef:filterAggregateFromChannelDef(continuousAxisChannelDef,compositeMark),continuousAxisChannelDef2:filterAggregateFromChannelDef(continuousAxisChannelDef2,compositeMark),continuousAxisChannelDefError:filterAggregateFromChannelDef(continuousAxisChannelDefError,compositeMark),continuousAxisChannelDefError2:filterAggregateFromChannelDef(continuousAxisChannelDefError2,compositeMark),continuousAxis:continuousAxis}}function filterAggregateFromChannelDef(continuousAxisChannelDef,compositeMark){if(continuousAxisChannelDef&&continuousAxisChannelDef.aggregate){var aggregate=continuousAxisChannelDef.aggregate,continuousAxisWithoutAggregate=_objectWithoutProperties(continuousAxisChannelDef,["aggregate"]);if(aggregate!==compositeMark){warn(errorBarContinuousAxisHasCustomizedAggregate(aggregate,compositeMark))}return continuousAxisWithoutAggregate}else{return continuousAxisChannelDef}}function compositeMarkOrient(spec,compositeMark){var mark=spec.mark,encoding=spec.encoding;var x=encoding.x,y=encoding.y;if(isMarkDef(mark)&&mark.orient){return mark.orient}if(isContinuousFieldOrDatumDef(x)){if(isContinuousFieldOrDatumDef(y)){var xAggregate=isFieldDef(x)&&x.aggregate;var yAggregate=isFieldDef(y)&&y.aggregate;if(!xAggregate&&yAggregate===compositeMark){return"vertical"}else if(!yAggregate&&xAggregate===compositeMark){return"horizontal"}else if(xAggregate===compositeMark&&yAggregate===compositeMark){throw new Error("Both x and y cannot have aggregate")}else{if(isFieldOrDatumDefForTimeFormat(y)&&!isFieldOrDatumDefForTimeFormat(x)){return"horizontal"}return"vertical"}}return"horizontal"}else if(isContinuousFieldOrDatumDef(y)){return"vertical"}else{throw new Error("Need a valid continuous axis for ".concat(compositeMark,"s"))}}var BOXPLOT="boxplot";var BOXPLOT_PARTS=["box","median","outliers","rule","ticks"];var boxPlotNormalizer=new CompositeMarkNormalizer(BOXPLOT,normalizeBoxPlot);function getBoxPlotType(extent){if(isNumber(extent)){return"tukey"}return extent}function normalizeBoxPlot(spec,_ref){var _markDef$extent;var config=_ref.config;spec=_objectSpread2(_objectSpread2({},spec),{},{encoding:normalizeEncoding(spec.encoding,config)});var _spec=spec,mark=_spec.mark,_encoding=_spec.encoding,selection=_spec.selection,_p=_spec.projection,outerSpec=_objectWithoutProperties(_spec,["mark","encoding","selection","projection"]);var markDef=isMarkDef(mark)?mark:{type:mark};if(selection){warn(selectionNotSupported("boxplot"))}var extent=(_markDef$extent=markDef.extent)!==null&&_markDef$extent!==void 0?_markDef$extent:config.boxplot.extent;var sizeValue=getMarkPropOrConfig("size",markDef,config);var boxPlotType=getBoxPlotType(extent);var _boxParams=boxParams(spec,extent,config),bins=_boxParams.bins,timeUnits=_boxParams.timeUnits,transform=_boxParams.transform,continuousAxisChannelDef=_boxParams.continuousAxisChannelDef,continuousAxis=_boxParams.continuousAxis,groupby=_boxParams.groupby,aggregate=_boxParams.aggregate,encodingWithoutContinuousAxis=_boxParams.encodingWithoutContinuousAxis,ticksOrient=_boxParams.ticksOrient,boxOrient=_boxParams.boxOrient,customTooltipWithoutAggregatedField=_boxParams.customTooltipWithoutAggregatedField;var color=encodingWithoutContinuousAxis.color,size=encodingWithoutContinuousAxis.size,encodingWithoutSizeColorAndContinuousAxis=_objectWithoutProperties(encodingWithoutContinuousAxis,["color","size"]);var makeBoxPlotPart=function makeBoxPlotPart(sharedEncoding){return makeCompositeAggregatePartFactory(markDef,continuousAxis,continuousAxisChannelDef,sharedEncoding,config.boxplot)};var makeBoxPlotExtent=makeBoxPlotPart(encodingWithoutSizeColorAndContinuousAxis);var makeBoxPlotBox=makeBoxPlotPart(encodingWithoutContinuousAxis);var makeBoxPlotMidTick=makeBoxPlotPart(_objectSpread2(_objectSpread2({},encodingWithoutSizeColorAndContinuousAxis),size?{size:size}:{}));var fiveSummaryTooltipEncoding=getCompositeMarkTooltip([{fieldPrefix:boxPlotType==="min-max"?"upper_whisker_":"max_",titlePrefix:"Max"},{fieldPrefix:"upper_box_",titlePrefix:"Q3"},{fieldPrefix:"mid_box_",titlePrefix:"Median"},{fieldPrefix:"lower_box_",titlePrefix:"Q1"},{fieldPrefix:boxPlotType==="min-max"?"lower_whisker_":"min_",titlePrefix:"Min"}],continuousAxisChannelDef,encodingWithoutContinuousAxis);var endTick={type:"tick",color:"black",opacity:1,orient:ticksOrient,invalid:null,aria:false};var whiskerTooltipEncoding=boxPlotType==="min-max"?fiveSummaryTooltipEncoding:getCompositeMarkTooltip([{fieldPrefix:"upper_whisker_",titlePrefix:"Upper Whisker"},{fieldPrefix:"lower_whisker_",titlePrefix:"Lower Whisker"}],continuousAxisChannelDef,encodingWithoutContinuousAxis);var whiskerLayers=[].concat(_toConsumableArray(makeBoxPlotExtent({partName:"rule",mark:{type:"rule",invalid:null,aria:false},positionPrefix:"lower_whisker",endPositionPrefix:"lower_box",extraEncoding:whiskerTooltipEncoding})),_toConsumableArray(makeBoxPlotExtent({partName:"rule",mark:{type:"rule",invalid:null,aria:false},positionPrefix:"upper_box",endPositionPrefix:"upper_whisker",extraEncoding:whiskerTooltipEncoding})),_toConsumableArray(makeBoxPlotExtent({partName:"ticks",mark:endTick,positionPrefix:"lower_whisker",extraEncoding:whiskerTooltipEncoding})),_toConsumableArray(makeBoxPlotExtent({partName:"ticks",mark:endTick,positionPrefix:"upper_whisker",extraEncoding:whiskerTooltipEncoding})));var boxLayers=[].concat(_toConsumableArray(boxPlotType!=="tukey"?whiskerLayers:[]),_toConsumableArray(makeBoxPlotBox({partName:"box",mark:_objectSpread2(_objectSpread2({type:"bar"},sizeValue?{size:sizeValue}:{}),{},{orient:boxOrient,invalid:null,ariaRoleDescription:"box"}),positionPrefix:"lower_box",endPositionPrefix:"upper_box",extraEncoding:fiveSummaryTooltipEncoding})),_toConsumableArray(makeBoxPlotMidTick({partName:"median",mark:_objectSpread2(_objectSpread2(_objectSpread2({type:"tick",invalid:null},isObject(config.boxplot.median)&&config.boxplot.median.color?{color:config.boxplot.median.color}:{}),sizeValue?{size:sizeValue}:{}),{},{orient:ticksOrient,aria:false}),positionPrefix:"mid_box",extraEncoding:fiveSummaryTooltipEncoding})));if(boxPlotType==="min-max"){var _outerSpec$transform;return _objectSpread2(_objectSpread2({},outerSpec),{},{transform:((_outerSpec$transform=outerSpec.transform)!==null&&_outerSpec$transform!==void 0?_outerSpec$transform:[]).concat(transform),layer:boxLayers})}var lowerBoxExpr='datum["lower_box_'.concat(continuousAxisChannelDef.field,'"]');var upperBoxExpr='datum["upper_box_'.concat(continuousAxisChannelDef.field,'"]');var iqrExpr="(".concat(upperBoxExpr," - ").concat(lowerBoxExpr,")");var lowerWhiskerExpr="".concat(lowerBoxExpr," - ").concat(extent," * ").concat(iqrExpr);var upperWhiskerExpr="".concat(upperBoxExpr," + ").concat(extent," * ").concat(iqrExpr);var fieldExpr='datum["'.concat(continuousAxisChannelDef.field,'"]');var joinaggregateTransform={joinaggregate:boxParamsQuartiles(continuousAxisChannelDef.field),groupby:groupby};var filteredWhiskerSpec={transform:[{filter:"(".concat(lowerWhiskerExpr," <= ").concat(fieldExpr,") && (").concat(fieldExpr," <= ").concat(upperWhiskerExpr,")")},{aggregate:[{op:"min",field:continuousAxisChannelDef.field,as:"lower_whisker_"+continuousAxisChannelDef.field},{op:"max",field:continuousAxisChannelDef.field,as:"upper_whisker_"+continuousAxisChannelDef.field},{op:"min",field:"lower_box_"+continuousAxisChannelDef.field,as:"lower_box_"+continuousAxisChannelDef.field},{op:"max",field:"upper_box_"+continuousAxisChannelDef.field,as:"upper_box_"+continuousAxisChannelDef.field}].concat(_toConsumableArray(aggregate)),groupby:groupby}],layer:whiskerLayers};var tooltip=encodingWithoutSizeColorAndContinuousAxis.tooltip,encodingWithoutSizeColorContinuousAxisAndTooltip=_objectWithoutProperties(encodingWithoutSizeColorAndContinuousAxis,["tooltip"]);var scale=continuousAxisChannelDef.scale,axis=continuousAxisChannelDef.axis;var title=getTitle(continuousAxisChannelDef);var axisWithoutTitle=omit(axis,["title"]);var outlierLayersMixins=partLayerMixins(markDef,"outliers",config.boxplot,{transform:[{filter:"(".concat(fieldExpr," < ").concat(lowerWhiskerExpr,") || (").concat(fieldExpr," > ").concat(upperWhiskerExpr,")")}],mark:"point",encoding:_objectSpread2(_objectSpread2(_objectSpread2(_defineProperty({},continuousAxis,_objectSpread2(_objectSpread2(_objectSpread2({field:continuousAxisChannelDef.field,type:continuousAxisChannelDef.type},title!==undefined?{title:title}:{}),scale!==undefined?{scale:scale}:{}),isEmpty(axisWithoutTitle)?{}:{axis:axisWithoutTitle})),encodingWithoutSizeColorContinuousAxisAndTooltip),color?{color:color}:{}),customTooltipWithoutAggregatedField?{tooltip:customTooltipWithoutAggregatedField}:{})})[0];var filteredLayersMixins;var filteredLayersMixinsTransforms=[].concat(_toConsumableArray(bins),_toConsumableArray(timeUnits),[joinaggregateTransform]);if(outlierLayersMixins){filteredLayersMixins={transform:filteredLayersMixinsTransforms,layer:[outlierLayersMixins,filteredWhiskerSpec]}}else{var _filteredLayersMixins;filteredLayersMixins=filteredWhiskerSpec;(_filteredLayersMixins=filteredLayersMixins.transform).unshift.apply(_filteredLayersMixins,_toConsumableArray(filteredLayersMixinsTransforms))}return _objectSpread2(_objectSpread2({},outerSpec),{},{layer:[filteredLayersMixins,{transform:transform,layer:boxLayers}]})}function boxParamsQuartiles(continousAxisField){return[{op:"q1",field:continousAxisField,as:"lower_box_"+continousAxisField},{op:"q3",field:continousAxisField,as:"upper_box_"+continousAxisField}]}function boxParams(spec,extent,config){var orient=compositeMarkOrient(spec,BOXPLOT);var _compositeMarkContinu=compositeMarkContinuousAxis(spec,orient,BOXPLOT),continuousAxisChannelDef=_compositeMarkContinu.continuousAxisChannelDef,continuousAxis=_compositeMarkContinu.continuousAxis;var continuousFieldName=continuousAxisChannelDef.field;var boxPlotType=getBoxPlotType(extent);var boxplotSpecificAggregate=[].concat(_toConsumableArray(boxParamsQuartiles(continuousFieldName)),[{op:"median",field:continuousFieldName,as:"mid_box_"+continuousFieldName},{op:"min",field:continuousFieldName,as:(boxPlotType==="min-max"?"lower_whisker_":"min_")+continuousFieldName},{op:"max",field:continuousFieldName,as:(boxPlotType==="min-max"?"upper_whisker_":"max_")+continuousFieldName}]);var postAggregateCalculates=boxPlotType==="min-max"||boxPlotType==="tukey"?[]:[{calculate:'datum["upper_box_'.concat(continuousFieldName,'"] - datum["lower_box_').concat(continuousFieldName,'"]'),as:"iqr_"+continuousFieldName},{calculate:'min(datum["upper_box_'.concat(continuousFieldName,'"] + datum["iqr_').concat(continuousFieldName,'"] * ').concat(extent,', datum["max_').concat(continuousFieldName,'"])'),as:"upper_whisker_"+continuousFieldName},{calculate:'max(datum["lower_box_'.concat(continuousFieldName,'"] - datum["iqr_').concat(continuousFieldName,'"] * ').concat(extent,', datum["min_').concat(continuousFieldName,'"])'),as:"lower_whisker_"+continuousFieldName}];var _spec$encoding=spec.encoding,oldContinuousAxisChannelDef=_spec$encoding[continuousAxis],oldEncodingWithoutContinuousAxis=_objectWithoutProperties(_spec$encoding,[continuousAxis].map(_toPropertyKey));var _filterTooltipWithAgg=filterTooltipWithAggregatedField(oldEncodingWithoutContinuousAxis),customTooltipWithoutAggregatedField=_filterTooltipWithAgg.customTooltipWithoutAggregatedField,filteredEncoding=_filterTooltipWithAgg.filteredEncoding;var _extractTransformsFro=extractTransformsFromEncoding(filteredEncoding,config),bins=_extractTransformsFro.bins,timeUnits=_extractTransformsFro.timeUnits,aggregate=_extractTransformsFro.aggregate,groupby=_extractTransformsFro.groupby,encodingWithoutContinuousAxis=_extractTransformsFro.encoding;var ticksOrient=orient==="vertical"?"horizontal":"vertical";var boxOrient=orient;var transform=[].concat(_toConsumableArray(bins),_toConsumableArray(timeUnits),[{aggregate:[].concat(_toConsumableArray(aggregate),_toConsumableArray(boxplotSpecificAggregate)),groupby:groupby}],postAggregateCalculates);return{bins:bins,timeUnits:timeUnits,transform:transform,groupby:groupby,aggregate:aggregate,continuousAxisChannelDef:continuousAxisChannelDef,continuousAxis:continuousAxis,encodingWithoutContinuousAxis:encodingWithoutContinuousAxis,ticksOrient:ticksOrient,boxOrient:boxOrient,customTooltipWithoutAggregatedField:customTooltipWithoutAggregatedField}}var ERRORBAR="errorbar";var ERRORBAR_PARTS=["ticks","rule"];var errorBarNormalizer=new CompositeMarkNormalizer(ERRORBAR,normalizeErrorBar);function normalizeErrorBar(spec,_ref){var config=_ref.config;spec=_objectSpread2(_objectSpread2({},spec),{},{encoding:normalizeEncoding(spec.encoding,config)});var _errorBarParams=errorBarParams(spec,ERRORBAR,config),transform=_errorBarParams.transform,continuousAxisChannelDef=_errorBarParams.continuousAxisChannelDef,continuousAxis=_errorBarParams.continuousAxis,encodingWithoutContinuousAxis=_errorBarParams.encodingWithoutContinuousAxis,ticksOrient=_errorBarParams.ticksOrient,markDef=_errorBarParams.markDef,outerSpec=_errorBarParams.outerSpec,tooltipEncoding=_errorBarParams.tooltipEncoding;delete encodingWithoutContinuousAxis["size"];var makeErrorBarPart=makeCompositeAggregatePartFactory(markDef,continuousAxis,continuousAxisChannelDef,encodingWithoutContinuousAxis,config.errorbar);var thickness=markDef.thickness;var size=markDef.size;var tick=_objectSpread2(_objectSpread2({type:"tick",orient:ticksOrient,aria:false},thickness!==undefined?{thickness:thickness}:{}),size!==undefined?{size:size}:{});var layer=[].concat(_toConsumableArray(makeErrorBarPart({partName:"ticks",mark:tick,positionPrefix:"lower",extraEncoding:tooltipEncoding})),_toConsumableArray(makeErrorBarPart({partName:"ticks",mark:tick,positionPrefix:"upper",extraEncoding:tooltipEncoding})),_toConsumableArray(makeErrorBarPart({partName:"rule",mark:_objectSpread2({type:"rule",ariaRoleDescription:"errorbar"},thickness!==undefined?{size:thickness}:{}),positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:tooltipEncoding})));return _objectSpread2(_objectSpread2({},outerSpec),{},{transform:transform},layer.length>1?{layer:layer}:_objectSpread2({},layer[0]))}function errorBarOrientAndInputType(spec,compositeMark){var encoding=spec.encoding;if(errorBarIsInputTypeRaw(encoding)){return{orient:compositeMarkOrient(spec,compositeMark),inputType:"raw"}}var isTypeAggregatedUpperLower=errorBarIsInputTypeAggregatedUpperLower(encoding);var isTypeAggregatedError=errorBarIsInputTypeAggregatedError(encoding);var x=encoding.x;var y=encoding.y;if(isTypeAggregatedUpperLower){if(isTypeAggregatedError){throw new Error("".concat(compositeMark," cannot be both type aggregated-upper-lower and aggregated-error"))}var x2=encoding.x2;var y2=encoding.y2;if(isFieldOrDatumDef(x2)&&isFieldOrDatumDef(y2)){throw new Error("".concat(compositeMark," cannot have both x2 and y2"))}else if(isFieldOrDatumDef(x2)){if(isContinuousFieldOrDatumDef(x)){return{orient:"horizontal",inputType:"aggregated-upper-lower"}}else{throw new Error("Both x and x2 have to be quantitative in ".concat(compositeMark))}}else if(isFieldOrDatumDef(y2)){if(isContinuousFieldOrDatumDef(y)){return{orient:"vertical",inputType:"aggregated-upper-lower"}}else{throw new Error("Both y and y2 have to be quantitative in ".concat(compositeMark))}}throw new Error("No ranged axis")}else{var xError=encoding.xError;var xError2=encoding.xError2;var yError=encoding.yError;var yError2=encoding.yError2;if(isFieldOrDatumDef(xError2)&&!isFieldOrDatumDef(xError)){throw new Error("".concat(compositeMark," cannot have xError2 without xError"))}if(isFieldOrDatumDef(yError2)&&!isFieldOrDatumDef(yError)){throw new Error("".concat(compositeMark," cannot have yError2 without yError"))}if(isFieldOrDatumDef(xError)&&isFieldOrDatumDef(yError)){throw new Error("".concat(compositeMark," cannot have both xError and yError with both are quantiative"))}else if(isFieldOrDatumDef(xError)){if(isContinuousFieldOrDatumDef(x)){return{orient:"horizontal",inputType:"aggregated-error"}}else{throw new Error("All x, xError, and xError2 (if exist) have to be quantitative")}}else if(isFieldOrDatumDef(yError)){if(isContinuousFieldOrDatumDef(y)){return{orient:"vertical",inputType:"aggregated-error"}}else{throw new Error("All y, yError, and yError2 (if exist) have to be quantitative")}}throw new Error("No ranged axis")}}function errorBarIsInputTypeRaw(encoding){return(isFieldOrDatumDef(encoding.x)||isFieldOrDatumDef(encoding.y))&&!isFieldOrDatumDef(encoding.x2)&&!isFieldOrDatumDef(encoding.y2)&&!isFieldOrDatumDef(encoding.xError)&&!isFieldOrDatumDef(encoding.xError2)&&!isFieldOrDatumDef(encoding.yError)&&!isFieldOrDatumDef(encoding.yError2)}function errorBarIsInputTypeAggregatedUpperLower(encoding){return isFieldOrDatumDef(encoding.x2)||isFieldOrDatumDef(encoding.y2)}function errorBarIsInputTypeAggregatedError(encoding){return isFieldOrDatumDef(encoding.xError)||isFieldOrDatumDef(encoding.xError2)||isFieldOrDatumDef(encoding.yError)||isFieldOrDatumDef(encoding.yError2)}function errorBarParams(spec,compositeMark,config){var _outerSpec$transform;var mark=spec.mark,encoding=spec.encoding,selection=spec.selection,_p=spec.projection,outerSpec=_objectWithoutProperties(spec,["mark","encoding","selection","projection"]);var markDef=isMarkDef(mark)?mark:{type:mark};if(selection){warn(selectionNotSupported(compositeMark))}var _errorBarOrientAndInp=errorBarOrientAndInputType(spec,compositeMark),orient=_errorBarOrientAndInp.orient,inputType=_errorBarOrientAndInp.inputType;var _compositeMarkContinu=compositeMarkContinuousAxis(spec,orient,compositeMark),continuousAxisChannelDef=_compositeMarkContinu.continuousAxisChannelDef,continuousAxisChannelDef2=_compositeMarkContinu.continuousAxisChannelDef2,continuousAxisChannelDefError=_compositeMarkContinu.continuousAxisChannelDefError,continuousAxisChannelDefError2=_compositeMarkContinu.continuousAxisChannelDefError2,continuousAxis=_compositeMarkContinu.continuousAxis;var _errorBarAggregationA=errorBarAggregationAndCalculation(markDef,continuousAxisChannelDef,continuousAxisChannelDef2,continuousAxisChannelDefError,continuousAxisChannelDefError2,inputType,compositeMark,config),errorBarSpecificAggregate=_errorBarAggregationA.errorBarSpecificAggregate,postAggregateCalculates=_errorBarAggregationA.postAggregateCalculates,tooltipSummary=_errorBarAggregationA.tooltipSummary,tooltipTitleWithFieldName=_errorBarAggregationA.tooltipTitleWithFieldName;var _ref2=continuousAxis==="x"?"x2":"y2",_ref3=continuousAxis==="x"?"xError":"yError",_ref4=continuousAxis==="x"?"xError2":"yError2",oldContinuousAxisChannelDef=encoding[continuousAxis],oldContinuousAxisChannelDef2=encoding[_ref2],oldContinuousAxisChannelDefError=encoding[_ref3],oldContinuousAxisChannelDefError2=encoding[_ref4],oldEncodingWithoutContinuousAxis=_objectWithoutProperties(encoding,[continuousAxis,_ref2,_ref3,_ref4].map(_toPropertyKey));var _extractTransformsFro=extractTransformsFromEncoding(oldEncodingWithoutContinuousAxis,config),bins=_extractTransformsFro.bins,timeUnits=_extractTransformsFro.timeUnits,oldAggregate=_extractTransformsFro.aggregate,oldGroupBy=_extractTransformsFro.groupby,encodingWithoutContinuousAxis=_extractTransformsFro.encoding;var aggregate=[].concat(_toConsumableArray(oldAggregate),_toConsumableArray(errorBarSpecificAggregate));var groupby=inputType!=="raw"?[]:oldGroupBy;var tooltipEncoding=getCompositeMarkTooltip(tooltipSummary,continuousAxisChannelDef,encodingWithoutContinuousAxis,tooltipTitleWithFieldName);return{transform:[].concat(_toConsumableArray((_outerSpec$transform=outerSpec.transform)!==null&&_outerSpec$transform!==void 0?_outerSpec$transform:[]),_toConsumableArray(bins),_toConsumableArray(timeUnits),_toConsumableArray(aggregate.length===0?[]:[{aggregate:aggregate,groupby:groupby}]),_toConsumableArray(postAggregateCalculates)),groupby:groupby,continuousAxisChannelDef:continuousAxisChannelDef,continuousAxis:continuousAxis,encodingWithoutContinuousAxis:encodingWithoutContinuousAxis,ticksOrient:orient==="vertical"?"horizontal":"vertical",markDef:markDef,outerSpec:outerSpec,tooltipEncoding:tooltipEncoding}}function errorBarAggregationAndCalculation(markDef,continuousAxisChannelDef,continuousAxisChannelDef2,continuousAxisChannelDefError,continuousAxisChannelDefError2,inputType,compositeMark,config){var errorBarSpecificAggregate=[];var postAggregateCalculates=[];var continuousFieldName=continuousAxisChannelDef.field;var tooltipSummary;var tooltipTitleWithFieldName=false;if(inputType==="raw"){var center=markDef.center?markDef.center:markDef.extent?markDef.extent==="iqr"?"median":"mean":config.errorbar.center;var extent=markDef.extent?markDef.extent:center==="mean"?"stderr":"iqr";if(center==="median"!==(extent==="iqr")){warn(errorBarCenterIsUsedWithWrongExtent(center,extent,compositeMark))}if(extent==="stderr"||extent==="stdev"){errorBarSpecificAggregate=[{op:extent,field:continuousFieldName,as:"extent_"+continuousFieldName},{op:center,field:continuousFieldName,as:"center_"+continuousFieldName}];postAggregateCalculates=[{calculate:'datum["center_'.concat(continuousFieldName,'"] + datum["extent_').concat(continuousFieldName,'"]'),as:"upper_"+continuousFieldName},{calculate:'datum["center_'.concat(continuousFieldName,'"] - datum["extent_').concat(continuousFieldName,'"]'),as:"lower_"+continuousFieldName}];tooltipSummary=[{fieldPrefix:"center_",titlePrefix:titleCase(center)},{fieldPrefix:"upper_",titlePrefix:getTitlePrefix(center,extent,"+")},{fieldPrefix:"lower_",titlePrefix:getTitlePrefix(center,extent,"-")}];tooltipTitleWithFieldName=true}else{var centerOp;var lowerExtentOp;var upperExtentOp;if(extent==="ci"){centerOp="mean";lowerExtentOp="ci0";upperExtentOp="ci1"}else{centerOp="median";lowerExtentOp="q1";upperExtentOp="q3"}errorBarSpecificAggregate=[{op:lowerExtentOp,field:continuousFieldName,as:"lower_"+continuousFieldName},{op:upperExtentOp,field:continuousFieldName,as:"upper_"+continuousFieldName},{op:centerOp,field:continuousFieldName,as:"center_"+continuousFieldName}];tooltipSummary=[{fieldPrefix:"upper_",titlePrefix:title({field:continuousFieldName,aggregate:upperExtentOp,type:"quantitative"},config,{allowDisabling:false})},{fieldPrefix:"lower_",titlePrefix:title({field:continuousFieldName,aggregate:lowerExtentOp,type:"quantitative"},config,{allowDisabling:false})},{fieldPrefix:"center_",titlePrefix:title({field:continuousFieldName,aggregate:centerOp,type:"quantitative"},config,{allowDisabling:false})}]}}else{if(markDef.center||markDef.extent){warn(errorBarCenterAndExtentAreNotNeeded(markDef.center,markDef.extent))}if(inputType==="aggregated-upper-lower"){tooltipSummary=[];postAggregateCalculates=[{calculate:'datum["'.concat(continuousAxisChannelDef2.field,'"]'),as:"upper_"+continuousFieldName},{calculate:'datum["'.concat(continuousFieldName,'"]'),as:"lower_"+continuousFieldName}]}else if(inputType==="aggregated-error"){tooltipSummary=[{fieldPrefix:"",titlePrefix:continuousFieldName}];postAggregateCalculates=[{calculate:'datum["'.concat(continuousFieldName,'"] + datum["').concat(continuousAxisChannelDefError.field,'"]'),as:"upper_"+continuousFieldName}];if(continuousAxisChannelDefError2){postAggregateCalculates.push({calculate:'datum["'.concat(continuousFieldName,'"] + datum["').concat(continuousAxisChannelDefError2.field,'"]'),as:"lower_"+continuousFieldName})}else{postAggregateCalculates.push({calculate:'datum["'.concat(continuousFieldName,'"] - datum["').concat(continuousAxisChannelDefError.field,'"]'),as:"lower_"+continuousFieldName})}}var _iterator=_createForOfIteratorHelper(postAggregateCalculates),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var postAggregateCalculate=_step.value;tooltipSummary.push({fieldPrefix:postAggregateCalculate.as.substring(0,6),titlePrefix:replaceAll(replaceAll(postAggregateCalculate.calculate,'datum["',""),'"]',"")})}}catch(err){_iterator.e(err)}finally{_iterator.f()}}return{postAggregateCalculates:postAggregateCalculates,errorBarSpecificAggregate:errorBarSpecificAggregate,tooltipSummary:tooltipSummary,tooltipTitleWithFieldName:tooltipTitleWithFieldName}}function getTitlePrefix(center,extent,operation){return titleCase(center)+" "+operation+" "+extent}var ERRORBAND="errorband";var ERRORBAND_PARTS=["band","borders"];var errorBandNormalizer=new CompositeMarkNormalizer(ERRORBAND,normalizeErrorBand);function normalizeErrorBand(spec,_ref){var config=_ref.config;spec=_objectSpread2(_objectSpread2({},spec),{},{encoding:normalizeEncoding(spec.encoding,config)});var _errorBarParams=errorBarParams(spec,ERRORBAND,config),transform=_errorBarParams.transform,continuousAxisChannelDef=_errorBarParams.continuousAxisChannelDef,continuousAxis=_errorBarParams.continuousAxis,encodingWithoutContinuousAxis=_errorBarParams.encodingWithoutContinuousAxis,markDef=_errorBarParams.markDef,outerSpec=_errorBarParams.outerSpec,tooltipEncoding=_errorBarParams.tooltipEncoding;var errorBandDef=markDef;var makeErrorBandPart=makeCompositeAggregatePartFactory(errorBandDef,continuousAxis,continuousAxisChannelDef,encodingWithoutContinuousAxis,config.errorband);var is2D=spec.encoding.x!==undefined&&spec.encoding.y!==undefined;var bandMark={type:is2D?"area":"rect"};var bordersMark={type:is2D?"line":"rule"};var interpolate=_objectSpread2(_objectSpread2({},errorBandDef.interpolate?{interpolate:errorBandDef.interpolate}:{}),errorBandDef.tension&&errorBandDef.interpolate?{tension:errorBandDef.tension}:{});if(is2D){bandMark=_objectSpread2(_objectSpread2(_objectSpread2({},bandMark),interpolate),{},{ariaRoleDescription:"errorband"});bordersMark=_objectSpread2(_objectSpread2(_objectSpread2({},bordersMark),interpolate),{},{aria:false})}else if(errorBandDef.interpolate){warn(errorBand1DNotSupport("interpolate"))}else if(errorBandDef.tension){warn(errorBand1DNotSupport("tension"))}return _objectSpread2(_objectSpread2({},outerSpec),{},{transform:transform,layer:[].concat(_toConsumableArray(makeErrorBandPart({partName:"band",mark:bandMark,positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:tooltipEncoding})),_toConsumableArray(makeErrorBandPart({partName:"borders",mark:bordersMark,positionPrefix:"lower",extraEncoding:tooltipEncoding})),_toConsumableArray(makeErrorBandPart({partName:"borders",mark:bordersMark,positionPrefix:"upper",extraEncoding:tooltipEncoding})))})}var compositeMarkRegistry={};function add(mark,run,parts){var normalizer=new CompositeMarkNormalizer(mark,run);compositeMarkRegistry[mark]={normalizer:normalizer,parts:parts}}function getAllCompositeMarks(){return keys(compositeMarkRegistry)}add(BOXPLOT,normalizeBoxPlot,BOXPLOT_PARTS);add(ERRORBAR,normalizeErrorBar,ERRORBAR_PARTS);add(ERRORBAND,normalizeErrorBand,ERRORBAND_PARTS);var VL_ONLY_LEGEND_CONFIG=["gradientHorizontalMaxLength","gradientHorizontalMinLength","gradientVerticalMaxLength","gradientVerticalMinLength","unselectedOpacity"];var HEADER_TITLE_PROPERTIES_MAP={titleAlign:"align",titleAnchor:"anchor",titleAngle:"angle",titleBaseline:"baseline",titleColor:"color",titleFont:"font",titleFontSize:"fontSize",titleFontStyle:"fontStyle",titleFontWeight:"fontWeight",titleLimit:"limit",titleLineHeight:"lineHeight",titleOrient:"orient",titlePadding:"offset"};var HEADER_LABEL_PROPERTIES_MAP={labelAlign:"align",labelAnchor:"anchor",labelAngle:"angle",labelBaseline:"baseline",labelColor:"color",labelFont:"font",labelFontSize:"fontSize",labelFontStyle:"fontStyle",labelFontWeight:"fontWeight",labelLimit:"limit",labelLineHeight:"lineHeight",labelOrient:"orient",labelPadding:"offset"};var HEADER_TITLE_PROPERTIES=keys(HEADER_TITLE_PROPERTIES_MAP);var HEADER_LABEL_PROPERTIES=keys(HEADER_LABEL_PROPERTIES_MAP);var HEADER_CONFIGS_INDEX={header:1,headerRow:1,headerColumn:1,headerFacet:1};var HEADER_CONFIGS=keys(HEADER_CONFIGS_INDEX);var LEGEND_SCALE_CHANNELS=["size","shape","fill","stroke","strokeDash","strokeWidth","opacity"];var defaultLegendConfig={gradientHorizontalMaxLength:200,gradientHorizontalMinLength:100,gradientVerticalMaxLength:200,gradientVerticalMinLength:64,unselectedOpacity:.35};var COMMON_LEGEND_PROPERTY_INDEX={aria:1,clipHeight:1,columnPadding:1,columns:1,cornerRadius:1,description:1,direction:1,fillColor:1,format:1,formatType:1,gradientLength:1,gradientOpacity:1,gradientStrokeColor:1,gradientStrokeWidth:1,gradientThickness:1,gridAlign:1,labelAlign:1,labelBaseline:1,labelColor:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labelSeparation:1,legendX:1,legendY:1,offset:1,orient:1,padding:1,rowPadding:1,strokeColor:1,symbolDash:1,symbolDashOffset:1,symbolFillColor:1,symbolLimit:1,symbolOffset:1,symbolOpacity:1,symbolSize:1,symbolStrokeColor:1,symbolStrokeWidth:1,symbolType:1,tickCount:1,tickMinStep:1,title:1,titleAlign:1,titleAnchor:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titleOrient:1,titlePadding:1,type:1,values:1,zindex:1};function assembleParameterSignals(params){var signals=[];var _iterator=_createForOfIteratorHelper(params||[]),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var param=_step.value;var expr=param.expr,bind=param.bind,rest=_objectWithoutProperties(param,["expr","bind"]);if(bind&&expr){var signal=_objectSpread2(_objectSpread2({},rest),{},{bind:bind,init:expr});signals.push(signal)}else{var _signal=_objectSpread2(_objectSpread2(_objectSpread2({},rest),expr?{update:expr}:{}),bind?{bind:bind}:{});signals.push(_signal)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return signals}var SELECTION_ID="_vgsid_";var defaultConfig={single:{on:"click",fields:[SELECTION_ID],resolve:"global",empty:"all",clear:"dblclick"},multi:{on:"click",fields:[SELECTION_ID],toggle:"event.shiftKey",resolve:"global",empty:"all",clear:"dblclick"},interval:{on:"[mousedown, window:mouseup] > window:mousemove!",encodings:["x","y"],translate:"[mousedown, window:mouseup] > window:mousemove!",zoom:"wheel!",mark:{fill:"#333",fillOpacity:.125,stroke:"white"},resolve:"global",clear:"dblclick"}};function isLegendBinding(bind){return!!bind&&(bind==="legend"||!!bind.legend)}function isLegendStreamBinding(bind){return isLegendBinding(bind)&&isObject(bind)}function isAnyConcatSpec(spec){return isVConcatSpec(spec)||isHConcatSpec(spec)||isConcatSpec(spec)}function isConcatSpec(spec){return"concat"in spec}function isVConcatSpec(spec){return"vconcat"in spec}function isHConcatSpec(spec){return"hconcat"in spec}function isFitType(autoSizeType){return autoSizeType==="fit"||autoSizeType==="fit-x"||autoSizeType==="fit-y"}function getFitType(sizeType){return sizeType?"fit-".concat(getPositionScaleChannel(sizeType)):"fit"}var TOP_LEVEL_PROPERTIES=["background","padding"];function extractTopLevelProperties(t,includeParams){var o={};var _iterator=_createForOfIteratorHelper(TOP_LEVEL_PROPERTIES),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var p=_step.value;if(t&&t[p]!==undefined){o[p]=signalRefOrValue(t[p])}}}catch(err){_iterator.e(err)}finally{_iterator.f()}if(includeParams){o.params=t.params}return o}function isStep(size){return isObject(size)&&size["step"]!==undefined}function isFrameMixins(o){return o["view"]||o["width"]||o["height"]}var DEFAULT_SPACING=20;var COMPOSITION_LAYOUT_INDEX={align:1,bounds:1,center:1,columns:1,spacing:1};var COMPOSITION_LAYOUT_PROPERTIES=keys(COMPOSITION_LAYOUT_INDEX);function extractCompositionLayout(spec,specType,config){var compositionConfig=config[specType];var layout={};var spacingConfig=compositionConfig.spacing,columns=compositionConfig.columns;if(spacingConfig!==undefined){layout.spacing=spacingConfig}if(columns!==undefined){if(isFacetSpec(spec)&&!isFacetMapping(spec.facet)||isConcatSpec(spec)){layout.columns=columns}}if(isVConcatSpec(spec)){layout.columns=1}var _iterator=_createForOfIteratorHelper(COMPOSITION_LAYOUT_PROPERTIES),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var prop=_step.value;if(spec[prop]!==undefined){if(prop==="spacing"){var _spacing$row,_spacing$column;var spacing=spec[prop];layout[prop]=isNumber(spacing)?spacing:{row:(_spacing$row=spacing.row)!==null&&_spacing$row!==void 0?_spacing$row:spacingConfig,column:(_spacing$column=spacing.column)!==null&&_spacing$column!==void 0?_spacing$column:spacingConfig}}else{layout[prop]=spec[prop]}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return layout}function getViewConfigContinuousSize(viewConfig,channel){var _viewConfig$channel;return(_viewConfig$channel=viewConfig[channel])!==null&&_viewConfig$channel!==void 0?_viewConfig$channel:viewConfig[channel==="width"?"continuousWidth":"continuousHeight"]}function getViewConfigDiscreteStep(viewConfig,channel){var size=getViewConfigDiscreteSize(viewConfig,channel);return isStep(size)?size.step:DEFAULT_STEP}function getViewConfigDiscreteSize(viewConfig,channel){var _viewConfig$channel2;var size=(_viewConfig$channel2=viewConfig[channel])!==null&&_viewConfig$channel2!==void 0?_viewConfig$channel2:viewConfig[channel==="width"?"discreteWidth":"discreteHeight"];return getFirstDefined(size,{step:viewConfig.step})}var DEFAULT_STEP=20;var defaultViewConfig={continuousWidth:200,continuousHeight:200,step:DEFAULT_STEP};var defaultConfig$1={background:"white",padding:5,timeFormat:"%b %d, %Y",countTitle:"Count of Records",view:defaultViewConfig,mark:defaultMarkConfig,arc:{},area:{},bar:defaultBarConfig,circle:{},geoshape:{},image:{},line:{},point:{},rect:defaultRectConfig,rule:{color:"black"},square:{},text:{color:"black"},tick:defaultTickConfig,trail:{},boxplot:{size:14,extent:1.5,box:{},median:{color:"white"},outliers:{},rule:{},ticks:null},errorbar:{center:"mean",rule:true,ticks:false},errorband:{band:{opacity:.3},borders:false},scale:defaultScaleConfig,projection:{},legend:defaultLegendConfig,header:{titlePadding:10,labelPadding:10},headerColumn:{},headerRow:{},headerFacet:{},selection:defaultConfig,style:{},title:{},facet:{spacing:DEFAULT_SPACING},concat:{spacing:DEFAULT_SPACING}};var tab10=["#4c78a8","#f58518","#e45756","#72b7b2","#54a24b","#eeca3b","#b279a2","#ff9da6","#9d755d","#bab0ac"];var DEFAULT_FONT_SIZE={text:11,guideLabel:10,guideTitle:11,groupTitle:13,groupSubtitle:12};var DEFAULT_COLOR={blue:tab10[0],orange:tab10[1],red:tab10[2],teal:tab10[3],green:tab10[4],yellow:tab10[5],purple:tab10[6],pink:tab10[7],brown:tab10[8],gray0:"#000",gray1:"#111",gray2:"#222",gray3:"#333",gray4:"#444",gray5:"#555",gray6:"#666",gray7:"#777",gray8:"#888",gray9:"#999",gray10:"#aaa",gray11:"#bbb",gray12:"#ccc",gray13:"#ddd",gray14:"#eee",gray15:"#fff"};function colorSignalConfig(){var color=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return{signals:[{name:"color",value:isObject(color)?_objectSpread2(_objectSpread2({},DEFAULT_COLOR),color):DEFAULT_COLOR}],mark:{color:{signal:"color.blue"}},rule:{color:{signal:"color.gray0"}},text:{color:{signal:"color.gray0"}},style:{"guide-label":{fill:{signal:"color.gray0"}},"guide-title":{fill:{signal:"color.gray0"}},"group-title":{fill:{signal:"color.gray0"}},"group-subtitle":{fill:{signal:"color.gray0"}},cell:{stroke:{signal:"color.gray8"}}},axis:{domainColor:{signal:"color.gray13"},gridColor:{signal:"color.gray8"},tickColor:{signal:"color.gray13"}},range:{category:[{signal:"color.blue"},{signal:"color.orange"},{signal:"color.red"},{signal:"color.teal"},{signal:"color.green"},{signal:"color.yellow"},{signal:"color.purple"},{signal:"color.pink"},{signal:"color.brown"},{signal:"color.grey8"}]}}}function fontSizeSignalConfig(fontSize){return{signals:[{name:"fontSize",value:isObject(fontSize)?_objectSpread2(_objectSpread2({},DEFAULT_FONT_SIZE),fontSize):DEFAULT_FONT_SIZE}],text:{fontSize:{signal:"fontSize.text"}},style:{"guide-label":{fontSize:{signal:"fontSize.guideLabel"}},"guide-title":{fontSize:{signal:"fontSize.guideTitle"}},"group-title":{fontSize:{signal:"fontSize.groupTitle"}},"group-subtitle":{fontSize:{signal:"fontSize.groupSubtitle"}}}}}function fontConfig(font){return{text:{font:font},style:{"guide-label":{font:font},"guide-title":{font:font},"group-title":{font:font},"group-subtitle":{font:font}}}}function getAxisConfigInternal(axisConfig){var props=keys(axisConfig||{});var axisConfigInternal={};var _iterator=_createForOfIteratorHelper(props),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var prop=_step.value;var val=axisConfig[prop];axisConfigInternal[prop]=isConditionalAxisValue(val)?signalOrValueRefWithCondition(val):signalRefOrValue(val)}}catch(err){_iterator.e(err)}finally{_iterator.f()}return axisConfigInternal}function getStyleConfigInternal(styleConfig){var props=keys(styleConfig);var styleConfigInternal={};var _iterator2=_createForOfIteratorHelper(props),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var prop=_step2.value;styleConfigInternal[prop]=getAxisConfigInternal(styleConfig[prop])}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return styleConfigInternal}var configPropsWithExpr=[].concat(_toConsumableArray(MARK_CONFIGS),_toConsumableArray(AXIS_CONFIGS),_toConsumableArray(HEADER_CONFIGS),["background","padding","legend","lineBreak","scale","style","title","view"]);function initConfig(){var specifiedConfig=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var color=specifiedConfig.color,font=specifiedConfig.font,fontSize=specifiedConfig.fontSize,restConfig=_objectWithoutProperties(specifiedConfig,["color","font","fontSize"]);var mergedConfig=mergeConfig({},defaultConfig$1,font?fontConfig(font):{},color?colorSignalConfig(color):{},fontSize?fontSizeSignalConfig(fontSize):{},restConfig||{});var outputConfig=omit(mergedConfig,configPropsWithExpr);for(var _i=0,_arr=["background","lineBreak","padding"];_i<_arr.length;_i++){var prop=_arr[_i];if(mergedConfig[prop]){outputConfig[prop]=signalRefOrValue(mergedConfig[prop])}}var _iterator3=_createForOfIteratorHelper(MARK_CONFIGS),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var markConfigType=_step3.value;if(mergedConfig[markConfigType]){outputConfig[markConfigType]=replaceExprRefInIndex(mergedConfig[markConfigType])}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}var _iterator4=_createForOfIteratorHelper(AXIS_CONFIGS),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var axisConfigType=_step4.value;if(mergedConfig[axisConfigType]){outputConfig[axisConfigType]=getAxisConfigInternal(mergedConfig[axisConfigType])}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}var _iterator5=_createForOfIteratorHelper(HEADER_CONFIGS),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var headerConfigType=_step5.value;if(mergedConfig[headerConfigType]){outputConfig[headerConfigType]=replaceExprRefInIndex(mergedConfig[headerConfigType])}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}if(mergedConfig.legend){outputConfig.legend=replaceExprRefInIndex(mergedConfig.legend)}if(mergedConfig.scale){outputConfig.scale=replaceExprRefInIndex(mergedConfig.scale)}if(mergedConfig.style){outputConfig.style=getStyleConfigInternal(mergedConfig.style)}if(mergedConfig.title){outputConfig.title=replaceExprRefInIndex(mergedConfig.title)}if(mergedConfig.view){outputConfig.view=replaceExprRefInIndex(mergedConfig.view)}return outputConfig}var MARK_STYLES=["view"].concat(_toConsumableArray(PRIMITIVE_MARKS));var VL_ONLY_CONFIG_PROPERTIES=["color","fontSize","background","padding","facet","concat","numberFormat","timeFormat","countTitle","header","axisQuantitative","axisTemporal","axisDiscrete","axisPoint","axisXBand","axisXPoint","axisXDiscrete","axisXQuantitative","axisXTemporal","axisYBand","axisYPoint","axisYDiscrete","axisYQuantitative","axisYTemporal","scale","selection","overlay"];var VL_ONLY_ALL_MARK_SPECIFIC_CONFIG_PROPERTY_INDEX=_objectSpread2({view:["continuousWidth","continuousHeight","discreteWidth","discreteHeight","step"]},VL_ONLY_MARK_SPECIFIC_CONFIG_PROPERTY_INDEX);function stripAndRedirectConfig(config){config=duplicate(config);var _iterator6=_createForOfIteratorHelper(VL_ONLY_CONFIG_PROPERTIES),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var _prop4=_step6.value;delete config[_prop4]}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}if(config.axis){for(var prop in config.axis){if(isConditionalAxisValue(config.axis[prop])){delete config.axis[prop]}}}if(config.legend){var _iterator7=_createForOfIteratorHelper(VL_ONLY_LEGEND_CONFIG),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var _prop=_step7.value;delete config.legend[_prop]}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}}if(config.mark){var _iterator8=_createForOfIteratorHelper(VL_ONLY_MARK_CONFIG_PROPERTIES),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var _prop2=_step8.value;delete config.mark[_prop2]}}catch(err){_iterator8.e(err)}finally{_iterator8.f()}if(config.mark.tooltip&&isObject(config.mark.tooltip)){delete config.mark.tooltip}}if(config.params){config.signals=(config.signals||[]).concat(assembleParameterSignals(config.params));delete config.params}var _iterator9=_createForOfIteratorHelper(MARK_STYLES),_step9;try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var markType=_step9.value;var _iterator11=_createForOfIteratorHelper(VL_ONLY_MARK_CONFIG_PROPERTIES),_step11;try{for(_iterator11.s();!(_step11=_iterator11.n()).done;){var _prop6=_step11.value;delete config[markType][_prop6]}}catch(err){_iterator11.e(err)}finally{_iterator11.f()}var vlOnlyMarkSpecificConfigs=VL_ONLY_ALL_MARK_SPECIFIC_CONFIG_PROPERTY_INDEX[markType];if(vlOnlyMarkSpecificConfigs){var _iterator12=_createForOfIteratorHelper(vlOnlyMarkSpecificConfigs),_step12;try{for(_iterator12.s();!(_step12=_iterator12.n()).done;){var _prop5=_step12.value;delete config[markType][_prop5]}}catch(err){_iterator12.e(err)}finally{_iterator12.f()}}redirectConfigToStyleConfig(config,markType)}}catch(err){_iterator9.e(err)}finally{_iterator9.f()}var _iterator10=_createForOfIteratorHelper(getAllCompositeMarks()),_step10;try{for(_iterator10.s();!(_step10=_iterator10.n()).done;){var m=_step10.value;delete config[m]}}catch(err){_iterator10.e(err)}finally{_iterator10.f()}redirectTitleConfig(config);for(var _prop3 in config){if(isObject(config[_prop3])&&isEmpty(config[_prop3])){delete config[_prop3]}}return isEmpty(config)?undefined:config}function redirectTitleConfig(config){var _extractTitleConfig=extractTitleConfig(config.title),titleMarkConfig=_extractTitleConfig.titleMarkConfig,subtitleMarkConfig=_extractTitleConfig.subtitleMarkConfig,subtitle=_extractTitleConfig.subtitle;if(!isEmpty(titleMarkConfig)){config.style["group-title"]=_objectSpread2(_objectSpread2({},config.style["group-title"]),titleMarkConfig)}if(!isEmpty(subtitleMarkConfig)){config.style["group-subtitle"]=_objectSpread2(_objectSpread2({},config.style["group-subtitle"]),subtitleMarkConfig)}if(!isEmpty(subtitle)){config.title=subtitle}else{delete config.title}}function redirectConfigToStyleConfig(config,prop,toProp,compositeMarkPart){var _toProp;var propConfig=compositeMarkPart?config[prop][compositeMarkPart]:config[prop];if(prop==="view"){toProp="cell"}var style=_objectSpread2(_objectSpread2({},propConfig),config.style[(_toProp=toProp)!==null&&_toProp!==void 0?_toProp:prop]);if(!isEmpty(style)){var _toProp2;config.style[(_toProp2=toProp)!==null&&_toProp2!==void 0?_toProp2:prop]=style}if(!compositeMarkPart){delete config[prop]}}function isLayerSpec(spec){return"layer"in spec}function isRepeatSpec(spec){return"repeat"in spec}function isLayerRepeatSpec(spec){return!isArray(spec.repeat)&&spec.repeat["layer"]}var SpecMapper=function(){function SpecMapper(){_classCallCheck(this,SpecMapper)}_createClass(SpecMapper,[{key:"map",value:function map(spec,params){if(isFacetSpec(spec)){return this.mapFacet(spec,params)}else if(isRepeatSpec(spec)){return this.mapRepeat(spec,params)}else if(isHConcatSpec(spec)){return this.mapHConcat(spec,params)}else if(isVConcatSpec(spec)){return this.mapVConcat(spec,params)}else if(isConcatSpec(spec)){return this.mapConcat(spec,params)}else{return this.mapLayerOrUnit(spec,params)}}},{key:"mapLayerOrUnit",value:function mapLayerOrUnit(spec,params){if(isLayerSpec(spec)){return this.mapLayer(spec,params)}else if(isUnitSpec(spec)){return this.mapUnit(spec,params)}throw new Error(invalidSpec(spec))}},{key:"mapLayer",value:function mapLayer(spec,params){var _this=this;return _objectSpread2(_objectSpread2({},spec),{},{layer:spec.layer.map((function(subspec){return _this.mapLayerOrUnit(subspec,params)}))})}},{key:"mapHConcat",value:function mapHConcat(spec,params){var _this2=this;return _objectSpread2(_objectSpread2({},spec),{},{hconcat:spec.hconcat.map((function(subspec){return _this2.map(subspec,params)}))})}},{key:"mapVConcat",value:function mapVConcat(spec,params){var _this3=this;return _objectSpread2(_objectSpread2({},spec),{},{vconcat:spec.vconcat.map((function(subspec){return _this3.map(subspec,params)}))})}},{key:"mapConcat",value:function mapConcat(spec,params){var _this4=this;var concat=spec.concat,rest=_objectWithoutProperties(spec,["concat"]);return _objectSpread2(_objectSpread2({},rest),{},{concat:concat.map((function(subspec){return _this4.map(subspec,params)}))})}},{key:"mapFacet",value:function mapFacet(spec,params){return _objectSpread2(_objectSpread2({},spec),{},{spec:this.map(spec.spec,params)})}},{key:"mapRepeat",value:function mapRepeat(spec,params){return _objectSpread2(_objectSpread2({},spec),{},{spec:this.map(spec.spec,params)})}}]);return SpecMapper}();var STACK_OFFSET_INDEX={zero:1,center:1,normalize:1};function isStackOffset(s){return s in STACK_OFFSET_INDEX}var STACKABLE_MARKS=new Set([ARC,BAR,AREA,RULE,POINT,CIRCLE,SQUARE,LINE,TEXT$1,TICK]);var STACK_BY_DEFAULT_MARKS=new Set([BAR,AREA,ARC]);function potentialStackedChannel(encoding,x){var y=x==="x"?"y":"radius";var xDef=encoding[x];var yDef=encoding[y];if(isFieldDef(xDef)&&isFieldDef(yDef)){if(channelDefType(xDef)==="quantitative"&&channelDefType(yDef)==="quantitative"){if(xDef.stack){return x}else if(yDef.stack){return y}var xAggregate=isFieldDef(xDef)&&!!xDef.aggregate;var yAggregate=isFieldDef(yDef)&&!!yDef.aggregate;if(xAggregate!==yAggregate){return xAggregate?x:y}else{var _xDef$scale,_yDef$scale;var xScale=(_xDef$scale=xDef.scale)===null||_xDef$scale===void 0?void 0:_xDef$scale.type;var yScale=(_yDef$scale=yDef.scale)===null||_yDef$scale===void 0?void 0:_yDef$scale.type;if(xScale&&xScale!=="linear"){return y}else if(yScale&&yScale!=="linear"){return x}}}else if(channelDefType(xDef)==="quantitative"){return x}else if(channelDefType(yDef)==="quantitative"){return y}}else if(channelDefType(xDef)==="quantitative"){return x}else if(channelDefType(yDef)==="quantitative"){return y}return undefined}function getDimensionChannel(channel){switch(channel){case"x":return"y";case"y":return"x";case"theta":return"radius";case"radius":return"theta"}}function stack(m,encoding){var opt=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var mark=isMarkDef(m)?m.type:m;if(!STACKABLE_MARKS.has(mark)){return null}var fieldChannel=potentialStackedChannel(encoding,"x")||potentialStackedChannel(encoding,"theta");if(!fieldChannel){return null}var stackedFieldDef=encoding[fieldChannel];var stackedField=isFieldDef(stackedFieldDef)?vgField(stackedFieldDef,{}):undefined;var dimensionChannel=getDimensionChannel(fieldChannel);var dimensionDef=encoding[dimensionChannel];var dimensionField=isFieldDef(dimensionDef)?vgField(dimensionDef,{}):undefined;if(dimensionField===stackedField){dimensionField=undefined;dimensionDef=undefined;dimensionChannel=undefined}var stackBy=NONPOSITION_CHANNELS.reduce((function(sc,channel){if(channel!=="tooltip"&&channelHasField(encoding,channel)){var channelDef=encoding[channel];var _iterator=_createForOfIteratorHelper(array(channelDef)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var cDef=_step.value;var fieldDef=getFieldDef(cDef);if(fieldDef.aggregate){continue}var f=vgField(fieldDef,{});if(!f||f!==dimensionField){sc.push({channel:channel,fieldDef:fieldDef})}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}return sc}),[]);var offset;if(stackedFieldDef.stack!==undefined){if(isBoolean(stackedFieldDef.stack)){offset=stackedFieldDef.stack?"zero":null}else{offset=stackedFieldDef.stack}}else if(stackBy.length>0&&STACK_BY_DEFAULT_MARKS.has(mark)){offset="zero"}if(!offset||!isStackOffset(offset)){return null}if(isAggregate(encoding)&&stackBy.length===0){return null}if(stackedFieldDef.scale&&stackedFieldDef.scale.type&&stackedFieldDef.scale.type!==ScaleType.LINEAR){if(opt.disallowNonLinearStack){return null}else{warn(cannotStackNonLinearScale(stackedFieldDef.scale.type))}}if(isFieldOrDatumDef(encoding[getSecondaryRangeChannel(fieldChannel)])){if(stackedFieldDef.stack!==undefined){warn(cannotStackRangedMark(fieldChannel))}return null}if(isFieldDef(stackedFieldDef)&&stackedFieldDef.aggregate&&!contains(SUM_OPS,stackedFieldDef.aggregate)){warn(stackNonSummativeAggregate(stackedFieldDef.aggregate))}return{groupbyChannel:dimensionDef?dimensionChannel:undefined,groupbyField:dimensionField,fieldChannel:fieldChannel,impute:stackedFieldDef.impute===null?false:isPathMark(mark),stackBy:stackBy,offset:offset}}function dropLineAndPoint(markDef){var _point=markDef.point,_line=markDef.line,mark=_objectWithoutProperties(markDef,["point","line"]);return keys(mark).length>1?mark:mark.type}function dropLineAndPointFromConfig(config){var _iterator=_createForOfIteratorHelper(["line","area","rule","trail"]),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var mark=_step.value;if(config[mark]){config=_objectSpread2(_objectSpread2({},config),{},_defineProperty({},mark,omit(config[mark],["point","line"])))}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return config}function getPointOverlay(markDef){var markConfig=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var encoding=arguments.length>2?arguments[2]:undefined;if(markDef.point==="transparent"){return{opacity:0}}else if(markDef.point){return isObject(markDef.point)?markDef.point:{}}else if(markDef.point!==undefined){return null}else{if(markConfig.point||encoding.shape){return isObject(markConfig.point)?markConfig.point:{}}return undefined}}function getLineOverlay(markDef){var markConfig=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(markDef.line){return markDef.line===true?{}:markDef.line}else if(markDef.line!==undefined){return null}else{if(markConfig.line){return markConfig.line===true?{}:markConfig.line}return undefined}}var PathOverlayNormalizer=function(){function PathOverlayNormalizer(){_classCallCheck(this,PathOverlayNormalizer);_defineProperty(this,"name","path-overlay")}_createClass(PathOverlayNormalizer,[{key:"hasMatchingType",value:function hasMatchingType(spec,config){if(isUnitSpec(spec)){var mark=spec.mark,encoding=spec.encoding;var markDef=isMarkDef(mark)?mark:{type:mark};switch(markDef.type){case"line":case"rule":case"trail":return!!getPointOverlay(markDef,config[markDef.type],encoding);case"area":return!!getPointOverlay(markDef,config[markDef.type],encoding)||!!getLineOverlay(markDef,config[markDef.type])}}return false}},{key:"run",value:function run(spec,params,normalize){var config=params.config;var selection=spec.selection,projection=spec.projection,mark=spec.mark,e=spec.encoding,outerSpec=_objectWithoutProperties(spec,["selection","projection","mark","encoding"]);var encoding=normalizeEncoding(e,config);var markDef=isMarkDef(mark)?mark:{type:mark};var pointOverlay=getPointOverlay(markDef,config[markDef.type],encoding);var lineOverlay=markDef.type==="area"&&getLineOverlay(markDef,config[markDef.type]);var layer=[_objectSpread2(_objectSpread2({},selection?{selection:selection}:{}),{},{mark:dropLineAndPoint(_objectSpread2(_objectSpread2({},markDef.type==="area"&&markDef.opacity===undefined&&markDef.fillOpacity===undefined?{opacity:.7}:{}),markDef)),encoding:omit(encoding,["shape"])})];var stackProps=stack(markDef,encoding);var overlayEncoding=encoding;if(stackProps){var stackFieldChannel=stackProps.fieldChannel,offset=stackProps.offset;overlayEncoding=_objectSpread2(_objectSpread2({},encoding),{},_defineProperty({},stackFieldChannel,_objectSpread2(_objectSpread2({},encoding[stackFieldChannel]),offset?{stack:offset}:{})))}if(lineOverlay){layer.push(_objectSpread2(_objectSpread2({},projection?{projection:projection}:{}),{},{mark:_objectSpread2(_objectSpread2({type:"line"},pick(markDef,["clip","interpolate","tension","tooltip"])),lineOverlay),encoding:overlayEncoding}))}if(pointOverlay){layer.push(_objectSpread2(_objectSpread2({},projection?{projection:projection}:{}),{},{mark:_objectSpread2(_objectSpread2({type:"point",opacity:1,filled:true},pick(markDef,["clip","tooltip"])),pointOverlay),encoding:overlayEncoding}))}return normalize(_objectSpread2(_objectSpread2({},outerSpec),{},{layer:layer}),_objectSpread2(_objectSpread2({},params),{},{config:dropLineAndPointFromConfig(config)}))}}]);return PathOverlayNormalizer}();var RangeStepNormalizer=function(){function RangeStepNormalizer(){_classCallCheck(this,RangeStepNormalizer);_defineProperty(this,"name","RangeStep")}_createClass(RangeStepNormalizer,[{key:"hasMatchingType",value:function hasMatchingType(spec){if(isUnitSpec(spec)&&spec.encoding){var _iterator=_createForOfIteratorHelper(POSITION_SCALE_CHANNELS),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;var def=spec.encoding[channel];if(def&&isFieldOrDatumDef(def)){var _def$scale;if(def===null||def===void 0?void 0:(_def$scale=def.scale)===null||_def$scale===void 0?void 0:_def$scale["rangeStep"]){return true}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}return false}},{key:"run",value:function run(spec){var sizeMixins={};var encoding=_objectSpread2({},spec.encoding);var _iterator2=_createForOfIteratorHelper(POSITION_SCALE_CHANNELS),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var channel=_step2.value;var sizeType=getSizeChannel(channel);var def=encoding[channel];if(def&&isFieldOrDatumDef(def)){var _def$scale2;if(def===null||def===void 0?void 0:(_def$scale2=def.scale)===null||_def$scale2===void 0?void 0:_def$scale2["rangeStep"]){var scale=def.scale,defWithoutScale=_objectWithoutProperties(def,["scale"]);var _ref=scale,rangeStep=_ref.rangeStep,scaleWithoutRangeStep=_objectWithoutProperties(_ref,["rangeStep"]);sizeMixins[sizeType]={step:scale["rangeStep"]};warn(RANGE_STEP_DEPRECATED);encoding=_objectSpread2(_objectSpread2({},encoding),{},_defineProperty({},channel,_objectSpread2(_objectSpread2({},defWithoutScale),isEmpty(scaleWithoutRangeStep)?{}:{scale:scaleWithoutRangeStep})))}}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return _objectSpread2(_objectSpread2(_objectSpread2({},sizeMixins),spec),{},{encoding:encoding})}}]);return RangeStepNormalizer}();function replaceRepeaterInFacet(facet,repeater){if(!repeater){return facet}if(isFacetMapping(facet)){return replaceRepeaterInMapping(facet,repeater)}return replaceRepeaterInFieldDef(facet,repeater)}function replaceRepeaterInEncoding(encoding,repeater){if(!repeater){return encoding}return replaceRepeaterInMapping(encoding,repeater)}function replaceRepeatInProp(prop,o,repeater){var val=o[prop];if(isRepeatRef(val)){if(val.repeat in repeater){return _objectSpread2(_objectSpread2({},o),{},_defineProperty({},prop,repeater[val.repeat]))}else{warn(noSuchRepeatedValue(val.repeat));return undefined}}return o}function replaceRepeaterInFieldDef(fieldDef,repeater){fieldDef=replaceRepeatInProp("field",fieldDef,repeater);if(fieldDef===undefined){return undefined}else if(fieldDef===null){return null}if(isSortableFieldDef(fieldDef)&&isSortField(fieldDef.sort)){var sort=replaceRepeatInProp("field",fieldDef.sort,repeater);fieldDef=_objectSpread2(_objectSpread2({},fieldDef),sort?{sort:sort}:{})}return fieldDef}function replaceRepeaterInFieldOrDatumDef(def,repeater){if(isFieldDef(def)){return replaceRepeaterInFieldDef(def,repeater)}else{var datumDef=replaceRepeatInProp("datum",def,repeater);if(datumDef!==def&&!datumDef.type){datumDef.type="nominal"}return datumDef}}function replaceRepeaterInChannelDef(channelDef,repeater){if(isFieldOrDatumDef(channelDef)){var fd=replaceRepeaterInFieldOrDatumDef(channelDef,repeater);if(fd){return fd}else if(isConditionalDef(channelDef)){return{condition:channelDef.condition}}}else{if(hasConditionalFieldOrDatumDef(channelDef)){var _fd=replaceRepeaterInFieldOrDatumDef(channelDef.condition,repeater);if(_fd){return _objectSpread2(_objectSpread2({},channelDef),{},{condition:_fd})}else{var condition=channelDef.condition,channelDefWithoutCondition=_objectWithoutProperties(channelDef,["condition"]);return channelDefWithoutCondition}}return channelDef}return undefined}function replaceRepeaterInMapping(mapping,repeater){var out={};for(var channel in mapping){if(_has(mapping,channel)){var channelDef=mapping[channel];if(isArray(channelDef)){out[channel]=channelDef.map((function(cd){return replaceRepeaterInChannelDef(cd,repeater)})).filter((function(cd){return cd}))}else{var cd=replaceRepeaterInChannelDef(channelDef,repeater);if(cd!==undefined){out[channel]=cd}}}}return out}var RuleForRangedLineNormalizer=function(){function RuleForRangedLineNormalizer(){_classCallCheck(this,RuleForRangedLineNormalizer);_defineProperty(this,"name","RuleForRangedLine")}_createClass(RuleForRangedLineNormalizer,[{key:"hasMatchingType",value:function hasMatchingType(spec){if(isUnitSpec(spec)){var encoding=spec.encoding,mark=spec.mark;if(mark==="line"){var _iterator=_createForOfIteratorHelper(SECONDARY_RANGE_CHANNEL),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;var mainChannel=getMainRangeChannel(channel);var mainChannelDef=encoding[mainChannel];if(encoding[channel]){if(isFieldDef(mainChannelDef)&&!isBinned(mainChannelDef.bin)||isDatumDef(mainChannelDef)){return true}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}}return false}},{key:"run",value:function run(spec,params,normalize){var encoding=spec.encoding;warn(lineWithRange(!!encoding.x2,!!encoding.y2));return normalize(_objectSpread2(_objectSpread2({},spec),{},{mark:"rule"}),params)}}]);return RuleForRangedLineNormalizer}();var CoreNormalizer=function(_SpecMapper){_inherits(CoreNormalizer,_SpecMapper);var _super=_createSuper(CoreNormalizer);function CoreNormalizer(){var _this;_classCallCheck(this,CoreNormalizer);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}_this=_super.call.apply(_super,[this].concat(args));_defineProperty(_assertThisInitialized(_this),"nonFacetUnitNormalizers",[boxPlotNormalizer,errorBarNormalizer,errorBandNormalizer,new PathOverlayNormalizer,new RuleForRangedLineNormalizer,new RangeStepNormalizer]);return _this}_createClass(CoreNormalizer,[{key:"map",value:function map(spec,params){if(isUnitSpec(spec)){var hasRow=channelHasField(spec.encoding,ROW);var hasColumn=channelHasField(spec.encoding,COLUMN);var hasFacet=channelHasField(spec.encoding,FACET);if(hasRow||hasColumn||hasFacet){return this.mapFacetedUnit(spec,params)}}return _get(_getPrototypeOf(CoreNormalizer.prototype),"map",this).call(this,spec,params)}},{key:"mapUnit",value:function mapUnit(spec,params){var parentEncoding=params.parentEncoding,parentProjection=params.parentProjection;var encoding=replaceRepeaterInEncoding(spec.encoding,params.repeater);var specWithReplacedEncoding=_objectSpread2(_objectSpread2({},spec),encoding?{encoding:encoding}:{});if(parentEncoding||parentProjection){return this.mapUnitWithParentEncodingOrProjection(specWithReplacedEncoding,params)}var normalizeLayerOrUnit=this.mapLayerOrUnit.bind(this);var _iterator=_createForOfIteratorHelper(this.nonFacetUnitNormalizers),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var unitNormalizer=_step.value;if(unitNormalizer.hasMatchingType(specWithReplacedEncoding,params.config)){return unitNormalizer.run(specWithReplacedEncoding,params,normalizeLayerOrUnit)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return specWithReplacedEncoding}},{key:"mapRepeat",value:function mapRepeat(spec,params){if(isLayerRepeatSpec(spec)){return this.mapLayerRepeat(spec,params)}else{return this.mapNonLayerRepeat(spec,params)}}},{key:"mapLayerRepeat",value:function mapLayerRepeat(spec,params){var _this2=this;var repeat=spec.repeat,childSpec=spec.spec,rest=_objectWithoutProperties(spec,["repeat","spec"]);var row=repeat.row,column=repeat.column,layer=repeat.layer;var _params$repeater=params.repeater,repeater=_params$repeater===void 0?{}:_params$repeater,_params$repeaterPrefi=params.repeaterPrefix,repeaterPrefix=_params$repeaterPrefi===void 0?"":_params$repeaterPrefi;if(row||column){return this.mapRepeat(_objectSpread2(_objectSpread2({},spec),{},{repeat:_objectSpread2(_objectSpread2({},row?{row:row}:{}),column?{column:column}:{}),spec:{repeat:{layer:layer},spec:childSpec}}),params)}else{return _objectSpread2(_objectSpread2({},rest),{},{layer:layer.map((function(layerValue){var childRepeater=_objectSpread2(_objectSpread2({},repeater),{},{layer:layerValue});var childName=(childSpec.name||"")+repeaterPrefix+"child__layer_".concat(varName(layerValue));var child=_this2.mapLayerOrUnit(childSpec,_objectSpread2(_objectSpread2({},params),{},{repeater:childRepeater,repeaterPrefix:childName}));child.name=childName;return child}))})}}},{key:"mapNonLayerRepeat",value:function mapNonLayerRepeat(spec,params){var _childSpec$data;var _spec=spec,repeat=_spec.repeat,childSpec=_spec.spec,data=_spec.data,remainingProperties=_objectWithoutProperties(_spec,["repeat","spec","data"]);if(!isArray(repeat)&&spec.columns){spec=omit(spec,["columns"]);warn(columnsNotSupportByRowCol("repeat"))}var concat=[];var _params$repeater2=params.repeater,repeater=_params$repeater2===void 0?{}:_params$repeater2,_params$repeaterPrefi2=params.repeaterPrefix,repeaterPrefix=_params$repeaterPrefi2===void 0?"":_params$repeaterPrefi2;var row=!isArray(repeat)&&repeat.row||[repeater?repeater.row:null];var column=!isArray(repeat)&&repeat.column||[repeater?repeater.column:null];var repeatValues=isArray(repeat)&&repeat||[repeater?repeater.repeat:null];var _iterator2=_createForOfIteratorHelper(repeatValues),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var repeatValue=_step2.value;var _iterator3=_createForOfIteratorHelper(row),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var rowValue=_step3.value;var _iterator4=_createForOfIteratorHelper(column),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var columnValue=_step4.value;var childRepeater={repeat:repeatValue,row:rowValue,column:columnValue,layer:repeater.layer};var childName=(childSpec.name||"")+repeaterPrefix+"child__"+(isArray(repeat)?"".concat(varName(repeatValue)):(repeat.row?"row_".concat(varName(rowValue)):"")+(repeat.column?"column_".concat(varName(columnValue)):""));var child=this.map(childSpec,_objectSpread2(_objectSpread2({},params),{},{repeater:childRepeater,repeaterPrefix:childName}));child.name=childName;concat.push(omit(child,["data"]))}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}var columns=isArray(repeat)?spec.columns:repeat.column?repeat.column.length:1;return _objectSpread2(_objectSpread2({data:(_childSpec$data=childSpec.data)!==null&&_childSpec$data!==void 0?_childSpec$data:data,align:"all"},remainingProperties),{},{columns:columns,concat:concat})}},{key:"mapFacet",value:function mapFacet(spec,params){var _spec2=spec,facet=_spec2.facet;if(isFacetMapping(facet)&&spec.columns){spec=omit(spec,["columns"]);warn(columnsNotSupportByRowCol("facet"))}return _get(_getPrototypeOf(CoreNormalizer.prototype),"mapFacet",this).call(this,spec,params)}},{key:"mapUnitWithParentEncodingOrProjection",value:function mapUnitWithParentEncodingOrProjection(spec,params){var encoding=spec.encoding,projection=spec.projection;var parentEncoding=params.parentEncoding,parentProjection=params.parentProjection,config=params.config;var mergedProjection=mergeProjection({parentProjection:parentProjection,projection:projection});var mergedEncoding=mergeEncoding({parentEncoding:parentEncoding,encoding:replaceRepeaterInEncoding(encoding,params.repeater)});return this.mapUnit(_objectSpread2(_objectSpread2(_objectSpread2({},spec),mergedProjection?{projection:mergedProjection}:{}),mergedEncoding?{encoding:mergedEncoding}:{}),{config:config})}},{key:"mapFacetedUnit",value:function mapFacetedUnit(spec,params){var _spec$encoding=spec.encoding,row=_spec$encoding.row,column=_spec$encoding.column,facet=_spec$encoding.facet,encoding=_objectWithoutProperties(_spec$encoding,["row","column","facet"]);var mark=spec.mark,width=spec.width,projection=spec.projection,height=spec.height,view=spec.view,selection=spec.selection,_=spec.encoding,outerSpec=_objectWithoutProperties(spec,["mark","width","projection","height","view","selection","encoding"]);var _this$getFacetMapping=this.getFacetMappingAndLayout({row:row,column:column,facet:facet},params),facetMapping=_this$getFacetMapping.facetMapping,layout=_this$getFacetMapping.layout;var newEncoding=replaceRepeaterInEncoding(encoding,params.repeater);return this.mapFacet(_objectSpread2(_objectSpread2(_objectSpread2({},outerSpec),layout),{},{facet:facetMapping,spec:_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},width?{width:width}:{}),height?{height:height}:{}),view?{view:view}:{}),projection?{projection:projection}:{}),{},{mark:mark,encoding:newEncoding},selection?{selection:selection}:{})}),params)}},{key:"getFacetMappingAndLayout",value:function getFacetMappingAndLayout(facets,params){var row=facets.row,column=facets.column,facet=facets.facet;if(row||column){if(facet){warn(facetChannelDropped([].concat(_toConsumableArray(row?[ROW]:[]),_toConsumableArray(column?[COLUMN]:[]))))}var facetMapping={};var layout={};for(var _i=0,_arr=[ROW,COLUMN];_i<_arr.length;_i++){var channel=_arr[_i];var def=facets[channel];if(def){var align=def.align,center=def.center,spacing=def.spacing,columns=def.columns,defWithoutLayout=_objectWithoutProperties(def,["align","center","spacing","columns"]);facetMapping[channel]=defWithoutLayout;var _iterator5=_createForOfIteratorHelper(["align","center","spacing"]),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var prop=_step5.value;if(def[prop]!==undefined){var _layout$prop;layout[prop]=(_layout$prop=layout[prop])!==null&&_layout$prop!==void 0?_layout$prop:{};layout[prop][channel]=def[prop]}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}}}return{facetMapping:facetMapping,layout:layout}}else{var _align=facet.align,_center=facet.center,_spacing=facet.spacing,_columns=facet.columns,_facetMapping=_objectWithoutProperties(facet,["align","center","spacing","columns"]);return{facetMapping:replaceRepeaterInFacet(_facetMapping,params.repeater),layout:_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},_align?{align:_align}:{}),_center?{center:_center}:{}),_spacing?{spacing:_spacing}:{}),_columns?{columns:_columns}:{})}}}},{key:"mapLayer",value:function mapLayer(spec,_ref){var parentEncoding=_ref.parentEncoding,parentProjection=_ref.parentProjection,otherParams=_objectWithoutProperties(_ref,["parentEncoding","parentProjection"]);var encoding=spec.encoding,projection=spec.projection,rest=_objectWithoutProperties(spec,["encoding","projection"]);var params=_objectSpread2(_objectSpread2({},otherParams),{},{parentEncoding:mergeEncoding({parentEncoding:parentEncoding,encoding:encoding,layer:true}),parentProjection:mergeProjection({parentProjection:parentProjection,projection:projection})});return _get(_getPrototypeOf(CoreNormalizer.prototype),"mapLayer",this).call(this,rest,params)}}]);return CoreNormalizer}(SpecMapper);function mergeEncoding(_ref2){var parentEncoding=_ref2.parentEncoding,_ref2$encoding=_ref2.encoding,encoding=_ref2$encoding===void 0?{}:_ref2$encoding,layer=_ref2.layer;var merged={};if(parentEncoding){var channels=new Set([].concat(_toConsumableArray(keys(parentEncoding)),_toConsumableArray(keys(encoding))));var _iterator6=_createForOfIteratorHelper(channels),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var channel=_step6.value;var channelDef=encoding[channel];var parentChannelDef=parentEncoding[channel];if(isFieldOrDatumDef(channelDef)){var mergedChannelDef=_objectSpread2(_objectSpread2({},parentChannelDef),channelDef);merged[channel]=mergedChannelDef}else if(hasConditionalFieldOrDatumDef(channelDef)){merged[channel]=_objectSpread2(_objectSpread2({},channelDef),{},{condition:_objectSpread2(_objectSpread2({},parentChannelDef),channelDef.condition)})}else if(channelDef||channelDef===null){merged[channel]=channelDef}else if(layer||isValueDef(parentChannelDef)||isSignalRef(parentChannelDef)||isFieldOrDatumDef(parentChannelDef)||isArray(parentChannelDef)){merged[channel]=parentChannelDef}}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}}else{merged=encoding}return!merged||isEmpty(merged)?undefined:merged}function mergeProjection(opt){var parentProjection=opt.parentProjection,projection=opt.projection;if(parentProjection&&projection){warn(projectionOverridden({parentProjection:parentProjection,projection:projection}))}return projection!==null&&projection!==void 0?projection:parentProjection}function normalize(spec,config){if(config===undefined){config=initConfig(spec.config)}var normalizedSpec=normalizeGenericSpec(spec,config);var width=spec.width,height=spec.height;var autosize=normalizeAutoSize(normalizedSpec,{width:width,height:height,autosize:spec.autosize},config);return _objectSpread2(_objectSpread2({},normalizedSpec),autosize?{autosize:autosize}:{})}var normalizer=new CoreNormalizer;function normalizeGenericSpec(spec){var config=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return normalizer.map(spec,{config:config})}function _normalizeAutoSize(autosize){return isString(autosize)?{type:autosize}:autosize!==null&&autosize!==void 0?autosize:{}}function normalizeAutoSize(spec,sizeInfo,config){var width=sizeInfo.width,height=sizeInfo.height;var isFitCompatible=isUnitSpec(spec)||isLayerSpec(spec);var autosizeDefault={};if(!isFitCompatible){if(width=="container"){warn(containerSizeNonSingle("width"));width=undefined}if(height=="container"){warn(containerSizeNonSingle("height"));height=undefined}}else{if(width=="container"&&height=="container"){autosizeDefault.type="fit";autosizeDefault.contains="padding"}else if(width=="container"){autosizeDefault.type="fit-x";autosizeDefault.contains="padding"}else if(height=="container"){autosizeDefault.type="fit-y";autosizeDefault.contains="padding"}}var autosize=_objectSpread2(_objectSpread2(_objectSpread2({type:"pad"},autosizeDefault),config?_normalizeAutoSize(config.autosize):{}),_normalizeAutoSize(spec.autosize));if(autosize.type==="fit"&&!isFitCompatible){warn(FIT_NON_SINGLE);autosize.type="pad"}if(width=="container"&&!(autosize.type=="fit"||autosize.type=="fit-x")){warn(containerSizeNotCompatibleWithAutosize("width"))}if(height=="container"&&!(autosize.type=="fit"||autosize.type=="fit-y")){warn(containerSizeNotCompatibleWithAutosize("height"))}if(deepEqual(autosize,{type:"pad"})){return undefined}return autosize}var Split=function(){function Split(){var explicit=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var implicit=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};_classCallCheck(this,Split);this.explicit=explicit;this.implicit=implicit}_createClass(Split,[{key:"clone",value:function clone(){return new Split(duplicate(this.explicit),duplicate(this.implicit))}},{key:"combine",value:function combine(){return _objectSpread2(_objectSpread2({},this.explicit),this.implicit)}},{key:"get",value:function get(key){return getFirstDefined(this.explicit[key],this.implicit[key])}},{key:"getWithExplicit",value:function getWithExplicit(key){if(this.explicit[key]!==undefined){return{explicit:true,value:this.explicit[key]}}else if(this.implicit[key]!==undefined){return{explicit:false,value:this.implicit[key]}}return{explicit:false,value:undefined}}},{key:"setWithExplicit",value:function setWithExplicit(key,value){if(value.value!==undefined){this.set(key,value.value,value.explicit)}}},{key:"set",value:function set(key,value,explicit){delete this[explicit?"implicit":"explicit"][key];this[explicit?"explicit":"implicit"][key]=value;return this}},{key:"copyKeyFromSplit",value:function copyKeyFromSplit(key,s){if(s.explicit[key]!==undefined){this.set(key,s.explicit[key],true)}else if(s.implicit[key]!==undefined){this.set(key,s.implicit[key],false)}}},{key:"copyKeyFromObject",value:function copyKeyFromObject(key,s){if(s[key]!==undefined){this.set(key,s[key],true)}}},{key:"copyAll",value:function copyAll(other){var _iterator=_createForOfIteratorHelper(keys(other.combine())),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var key=_step.value;var val=other.getWithExplicit(key);this.setWithExplicit(key,val)}}catch(err){_iterator.e(err)}finally{_iterator.f()}}}]);return Split}();function makeExplicit(value){return{explicit:true,value:value}}function makeImplicit(value){return{explicit:false,value:value}}function tieBreakByComparing(compare){return function(v1,v2,property,propertyOf){var diff=compare(v1.value,v2.value);if(diff>0){return v1}else if(diff<0){return v2}return defaultTieBreaker(v1,v2,property,propertyOf)}}function defaultTieBreaker(v1,v2,property,propertyOf){if(v1.explicit&&v2.explicit){warn(mergeConflictingProperty(property,propertyOf,v1.value,v2.value))}return v1}function mergeValuesWithExplicit(v1,v2,property,propertyOf){var tieBreaker=arguments.length>4&&arguments[4]!==undefined?arguments[4]:defaultTieBreaker;if(v1===undefined||v1.value===undefined){return v2}if(v1.explicit&&!v2.explicit){return v1}else if(v2.explicit&&!v1.explicit){return v2}else if(deepEqual(v1.value,v2.value)){return v1}else{return tieBreaker(v1,v2,property,propertyOf)}}var AncestorParse=function(_Split){_inherits(AncestorParse,_Split);var _super=_createSuper(AncestorParse);function AncestorParse(){var _this;var explicit=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var implicit=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var parseNothing=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;_classCallCheck(this,AncestorParse);_this=_super.call(this,explicit,implicit);_this.explicit=explicit;_this.implicit=implicit;_this.parseNothing=parseNothing;return _this}_createClass(AncestorParse,[{key:"clone",value:function clone(){var clone=_get(_getPrototypeOf(AncestorParse.prototype),"clone",this).call(this);clone.parseNothing=this.parseNothing;return clone}}]);return AncestorParse}(Split);function isUrlData(data){return"url"in data}function isInlineData(data){return"values"in data}function isNamedData(data){return"name"in data&&!isUrlData(data)&&!isInlineData(data)&&!isGenerator(data)}function isGenerator(data){return data&&(isSequenceGenerator(data)||isSphereGenerator(data)||isGraticuleGenerator(data))}function isSequenceGenerator(data){return"sequence"in data}function isSphereGenerator(data){return"sphere"in data}function isGraticuleGenerator(data){return"graticule"in data}var DataSourceType;(function(DataSourceType){DataSourceType[DataSourceType["Raw"]=0]="Raw";DataSourceType[DataSourceType["Main"]=1]="Main";DataSourceType[DataSourceType["Row"]=2]="Row";DataSourceType[DataSourceType["Column"]=3]="Column";DataSourceType[DataSourceType["Lookup"]=4]="Lookup"})(DataSourceType||(DataSourceType={}));function isFilter(t){return"filter"in t}function isImputeSequence(t){return(t===null||t===void 0?void 0:t["stop"])!==undefined}function isLookup(t){return"lookup"in t}function isLookupData(from){return"data"in from}function isLookupSelection(from){return"selection"in from}function isPivot(t){return"pivot"in t}function isDensity(t){return"density"in t}function isQuantile(t){return"quantile"in t}function isRegression(t){return"regression"in t}function isLoess(t){return"loess"in t}function isSample(t){return"sample"in t}function isWindow(t){return"window"in t}function isJoinAggregate(t){return"joinaggregate"in t}function isFlatten(t){return"flatten"in t}function isCalculate(t){return"calculate"in t}function isBin(t){return"bin"in t}function isImpute(t){return"impute"in t}function isTimeUnit(t){return"timeUnit"in t}function isAggregate$1(t){return"aggregate"in t}function isStack(t){return"stack"in t}function isFold(t){return"fold"in t}function normalizeTransform(transform){return transform.map((function(t){if(isFilter(t)){return{filter:normalizeLogicalComposition(t.filter,normalizePredicate)}}return t}))}var VIEW="view",LBRACK="[",RBRACK="]",LBRACE="{",RBRACE="}",COLON=":",COMMA=",",NAME="@",GT=">",ILLEGAL=/[[\]{}]/,DEFAULT_MARKS={"*":1,arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1};var DEFAULT_SOURCE,MARKS;function eventSelector(selector,source,marks){DEFAULT_SOURCE=source||VIEW;MARKS=marks||DEFAULT_MARKS;return parseMerge(selector.trim()).map(parseSelector)}function isMarkType(type){return MARKS[type]}function find(s,i,endChar,pushChar,popChar){var n=s.length;var count=0,c;for(;i<n;++i){c=s[i];if(!count&&c===endChar)return i;else if(popChar&&popChar.indexOf(c)>=0)--count;else if(pushChar&&pushChar.indexOf(c)>=0)++count}return i}function parseMerge(s){var output=[],n=s.length;var start=0,i=0;while(i<n){i=find(s,i,COMMA,LBRACK+LBRACE,RBRACK+RBRACE);output.push(s.substring(start,i).trim());start=++i}if(output.length===0){throw"Empty event selector: "+s}return output}function parseSelector(s){return s[0]==="["?parseBetween(s):parseStream(s)}function parseBetween(s){var n=s.length;var i=1,b;i=find(s,i,RBRACK,LBRACK,RBRACK);if(i===n){throw"Empty between selector: "+s}b=parseMerge(s.substring(1,i));if(b.length!==2){throw"Between selector must have two elements: "+s}s=s.slice(i+1).trim();if(s[0]!==GT){throw"Expected '>' after between selector: "+s}b=b.map(parseSelector);var stream=parseSelector(s.slice(1).trim());if(stream.between){return{between:b,stream:stream}}else{stream.between=b}return stream}function parseStream(s){var stream={source:DEFAULT_SOURCE},source=[];var throttle=[0,0],markname=0,start=0,n=s.length,i=0,j,filter;if(s[n-1]===RBRACE){i=s.lastIndexOf(LBRACE);if(i>=0){try{throttle=parseThrottle(s.substring(i+1,n-1))}catch(e){throw"Invalid throttle specification: "+s}s=s.slice(0,i).trim();n=s.length}else throw"Unmatched right brace: "+s;i=0}if(!n)throw s;if(s[0]===NAME)markname=++i;j=find(s,i,COLON);if(j<n){source.push(s.substring(start,j).trim());start=i=++j}i=find(s,i,LBRACK);if(i===n){source.push(s.substring(start,n).trim())}else{source.push(s.substring(start,i).trim());filter=[];start=++i;if(start===n)throw"Unmatched left bracket: "+s}while(i<n){i=find(s,i,RBRACK);if(i===n)throw"Unmatched left bracket: "+s;filter.push(s.substring(start,i).trim());if(i<n-1&&s[++i]!==LBRACK)throw"Expected left bracket: "+s;start=++i}if(!(n=source.length)||ILLEGAL.test(source[n-1])){throw"Invalid event selector: "+s}if(n>1){stream.type=source[1];if(markname){stream.markname=source[0].slice(1)}else if(isMarkType(source[0])){stream.marktype=source[0]}else{stream.source=source[0]}}else{stream.type=source[0]}if(stream.type.slice(-1)==="!"){stream.consume=true;stream.type=stream.type.slice(0,-1)}if(filter!=null)stream.filter=filter;if(throttle[0])stream.throttle=throttle[0];if(throttle[1])stream.debounce=throttle[1];return stream}function parseThrottle(s){var a=s.split(COMMA);if(!s.length||a.length>2)throw s;return a.map((function(_){var x=+_;if(x!==x)throw s;return x}))}function wrapCondition(model,channelDef,vgChannel,refFn){var condition=isConditionalDef(channelDef)&&channelDef.condition;var valueRef=refFn(channelDef);if(condition){var conditions=array(condition);var vgConditions=conditions.map((function(c){var conditionValueRef=refFn(c);var test=isConditionalSelection(c)?parseSelectionPredicate(model,c.selection):expression(model,c.test);return _objectSpread2({test:test},conditionValueRef)}));return _defineProperty({},vgChannel,[].concat(_toConsumableArray(vgConditions),_toConsumableArray(valueRef!==undefined?[valueRef]:[])))}else{return valueRef!==undefined?_defineProperty({},vgChannel,valueRef):{}}}function text(model){var channel=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"text";var channelDef=model.encoding[channel];return wrapCondition(model,channelDef,channel,(function(cDef){return textRef(cDef,model.config)}))}function textRef(channelDef,config){var expr=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"datum";if(channelDef){if(isValueDef(channelDef)){return signalOrValueRef(channelDef.value)}if(isFieldOrDatumDef(channelDef)){var _getFormatMixins=getFormatMixins(channelDef),format=_getFormatMixins.format,formatType=_getFormatMixins.formatType;return formatSignalRef({fieldOrDatumDef:channelDef,format:format,formatType:formatType,expr:expr,config:config})}}return undefined}function tooltip(model){var opt=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var encoding=model.encoding,markDef=model.markDef,config=model.config,stack=model.stack;var channelDef=encoding.tooltip;if(isArray(channelDef)){return{tooltip:tooltipRefForEncoding({tooltip:channelDef},stack,config,opt)}}else{var datum=opt.reactiveGeom?"datum.datum":"datum";return wrapCondition(model,channelDef,"tooltip",(function(cDef){var tooltipRefFromChannelDef=textRef(cDef,config,datum);if(tooltipRefFromChannelDef){return tooltipRefFromChannelDef}if(cDef===null){return undefined}var markTooltip=getMarkPropOrConfig("tooltip",markDef,config);if(markTooltip===true){markTooltip={content:"encoding"}}if(isString(markTooltip)){return{value:markTooltip}}else if(isObject(markTooltip)){if(isSignalRef(markTooltip)){return markTooltip}else if(markTooltip.content==="encoding"){return tooltipRefForEncoding(encoding,stack,config,opt)}else{return{signal:datum}}}return undefined}))}}function tooltipData(encoding,stack,config){var _ref=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{},reactiveGeom=_ref.reactiveGeom;var toSkip={};var expr=reactiveGeom?"datum.datum":"datum";var tuples=[];function add(fDef,channel){var _value;var mainChannel=getMainRangeChannel(channel);var fieldDef=isTypedFieldDef(fDef)?fDef:_objectSpread2(_objectSpread2({},fDef),{},{type:encoding[mainChannel].type});var title=fieldDef.title||defaultTitle(fieldDef,config);var key=array(title).join(", ");var value;if(isXorY(channel)){var channel2=channel==="x"?"x2":"y2";var fieldDef2=getFieldDef(encoding[channel2]);if(isBinned(fieldDef.bin)&&fieldDef2){var startField=vgField(fieldDef,{expr:expr});var endField=vgField(fieldDef2,{expr:expr});var _getFormatMixins=getFormatMixins(fieldDef),format=_getFormatMixins.format,formatType=_getFormatMixins.formatType;value=binFormatExpression(startField,endField,format,formatType,config);toSkip[channel2]=true}else if(stack&&stack.fieldChannel===channel&&stack.offset==="normalize"){var _getFormatMixins2=getFormatMixins(fieldDef),_format=_getFormatMixins2.format,_formatType=_getFormatMixins2.formatType;value=formatSignalRef({fieldOrDatumDef:fieldDef,format:_format,formatType:_formatType,expr:expr,config:config,normalizeStack:true}).signal}}value=(_value=value)!==null&&_value!==void 0?_value:textRef(fieldDef,config,expr).signal;tuples.push({channel:channel,key:key,value:value})}forEach(encoding,(function(channelDef,channel){if(isFieldDef(channelDef)){add(channelDef,channel)}else if(hasConditionalFieldDef(channelDef)){add(channelDef.condition,channel)}}));var out={};for(var _i=0,_tuples=tuples;_i<_tuples.length;_i++){var _tuples$_i=_tuples[_i],channel=_tuples$_i.channel,key=_tuples$_i.key,value=_tuples$_i.value;if(!toSkip[channel]&&!out[key]){out[key]=value}}return out}function tooltipRefForEncoding(encoding,stack,config){var _ref2=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{},reactiveGeom=_ref2.reactiveGeom;var data=tooltipData(encoding,stack,config,{reactiveGeom:reactiveGeom});var keyValues=entries(data).map((function(_ref3){var _ref4=_slicedToArray(_ref3,2),key=_ref4[0],value=_ref4[1];return'"'.concat(key,'": ').concat(value)}));return keyValues.length>0?{signal:"{".concat(keyValues.join(", "),"}")}:undefined}function aria(model){var markDef=model.markDef,config=model.config;var enableAria=getMarkPropOrConfig("aria",markDef,config);if(enableAria===false){return{}}return _objectSpread2(_objectSpread2(_objectSpread2({},enableAria?{aria:enableAria}:{}),ariaRoleDescription(model)),description(model))}function ariaRoleDescription(model){var mark=model.mark,markDef=model.markDef,config=model.config;if(config.aria===false){return{}}var ariaRoleDesc=getMarkPropOrConfig("ariaRoleDescription",markDef,config);if(ariaRoleDesc!=null){return{ariaRoleDescription:{value:ariaRoleDesc}}}return mark in VG_MARK_INDEX?{}:{ariaRoleDescription:{value:mark}}}function description(model){var encoding=model.encoding,markDef=model.markDef,config=model.config,stack=model.stack;var channelDef=encoding.description;if(channelDef){return wrapCondition(model,channelDef,"description",(function(cDef){return textRef(cDef,model.config)}))}var descriptionValue=getMarkPropOrConfig("description",markDef,config);if(descriptionValue!=null){return{description:signalOrValueRef(descriptionValue)}}if(config.aria===false){return{}}var data=tooltipData(encoding,stack,config);if(isEmpty(data)){return undefined}return{description:{signal:entries(data).map((function(_ref,index){var _ref2=_slicedToArray(_ref,2),key=_ref2[0],value=_ref2[1];return'"'.concat(index>0?"; ":"").concat(key,': " + (').concat(value,")")})).join(" + ")}}}function nonPosition(channel,model){var opt=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var markDef=model.markDef,encoding=model.encoding,config=model.config;var vgChannel=opt.vgChannel;var defaultRef=opt.defaultRef,defaultValue=opt.defaultValue;if(defaultRef===undefined){var _defaultValue;defaultValue=(_defaultValue=defaultValue)!==null&&_defaultValue!==void 0?_defaultValue:getMarkPropOrConfig(channel,markDef,config,{vgChannel:vgChannel,ignoreVgConfig:true});if(defaultValue!==undefined){defaultRef=signalOrValueRef(defaultValue)}}var channelDef=encoding[channel];return wrapCondition(model,channelDef,vgChannel!==null&&vgChannel!==void 0?vgChannel:channel,(function(cDef){return midPoint({channel:channel,channelDef:cDef,markDef:markDef,config:config,scaleName:model.scaleName(channel),scale:model.getScaleComponent(channel),stack:null,defaultRef:defaultRef})}))}function color(model){var _opt$filled,_ref,_getMarkPropOrConfig,_getMarkPropOrConfig2;var opt=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{filled:undefined};var markDef=model.markDef,encoding=model.encoding,config=model.config;var markType=markDef.type;var filled=(_opt$filled=opt.filled)!==null&&_opt$filled!==void 0?_opt$filled:getMarkPropOrConfig("filled",markDef,config);var transparentIfNeeded=contains(["bar","point","circle","square","geoshape"],markType)?"transparent":undefined;var defaultFill=(_ref=(_getMarkPropOrConfig=getMarkPropOrConfig(filled===true?"color":undefined,markDef,config,{vgChannel:"fill"}))!==null&&_getMarkPropOrConfig!==void 0?_getMarkPropOrConfig:config.mark[filled===true&&"color"])!==null&&_ref!==void 0?_ref:transparentIfNeeded;var defaultStroke=(_getMarkPropOrConfig2=getMarkPropOrConfig(filled===false?"color":undefined,markDef,config,{vgChannel:"stroke"}))!==null&&_getMarkPropOrConfig2!==void 0?_getMarkPropOrConfig2:config.mark[filled===false&&"color"];var colorVgChannel=filled?"fill":"stroke";var fillStrokeMarkDefAndConfig=_objectSpread2(_objectSpread2({},defaultFill?{fill:signalOrValueRef(defaultFill)}:{}),defaultStroke?{stroke:signalOrValueRef(defaultStroke)}:{});if(markDef.color&&(filled?markDef.fill:markDef.stroke)){warn(droppingColor("property",{fill:"fill"in markDef,stroke:"stroke"in markDef}))}return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},fillStrokeMarkDefAndConfig),nonPosition("color",model,{vgChannel:colorVgChannel,defaultValue:filled?defaultFill:defaultStroke})),nonPosition("fill",model,{defaultValue:encoding.fill?defaultFill:undefined})),nonPosition("stroke",model,{defaultValue:encoding.stroke?defaultStroke:undefined}))}function zindex(model){var encoding=model.encoding,mark=model.mark;var order=encoding.order;if(!isPathMark(mark)&&isValueDef(order)){return wrapCondition(model,order,"zindex",(function(cd){return signalOrValueRef(cd.value)}))}return{}}function getOffset(channel,markDef){var offsetChannel=getOffsetChannel(channel);var markDefOffsetValue=markDef[offsetChannel];if(markDefOffsetValue){return markDefOffsetValue}return undefined}function pointPosition(channel,model,_ref){var defaultPos=_ref.defaultPos,vgChannel=_ref.vgChannel,isMidPoint=_ref.isMidPoint;var encoding=model.encoding,markDef=model.markDef,config=model.config,stack=model.stack;var channelDef=encoding[channel];var channel2Def=encoding[getSecondaryRangeChannel(channel)];var scaleName=model.scaleName(channel);var scale=model.getScaleComponent(channel);var offset=getOffset(channel,markDef);var defaultRef=pointPositionDefaultRef({model:model,defaultPos:defaultPos,channel:channel,scaleName:scaleName,scale:scale});var valueRef=!channelDef&&isXorY(channel)&&(encoding.latitude||encoding.longitude)?{field:model.getName(channel)}:positionRef({channel:channel,channelDef:channelDef,channel2Def:channel2Def,markDef:markDef,config:config,isMidPoint:isMidPoint,scaleName:scaleName,scale:scale,stack:stack,offset:offset,defaultRef:defaultRef});return valueRef?_defineProperty({},vgChannel||channel,valueRef):undefined}function positionRef(params){var channel=params.channel,channelDef=params.channelDef,isMidPoint=params.isMidPoint,scaleName=params.scaleName,stack=params.stack,offset=params.offset,markDef=params.markDef,config=params.config;if(isFieldOrDatumDef(channelDef)&&stack&&channel===stack.fieldChannel){if(isFieldDef(channelDef)){var band=getBand({channel:channel,fieldDef:channelDef,isMidPoint:isMidPoint,markDef:markDef,stack:stack,config:config});if(band!==undefined){return interpolatedSignalRef({scaleName:scaleName,fieldOrDatumDef:channelDef,startSuffix:"start",band:band,offset:offset})}}return valueRefForFieldOrDatumDef(channelDef,scaleName,{suffix:"end"},{offset:offset})}return midPointRefWithPositionInvalidTest(params)}function pointPositionDefaultRef(_ref3){var model=_ref3.model,defaultPos=_ref3.defaultPos,channel=_ref3.channel,scaleName=_ref3.scaleName,scale=_ref3.scale;var markDef=model.markDef,config=model.config;return function(){var mainChannel=getMainRangeChannel(channel);var vgChannel=getVgPositionChannel(channel);var definedValueOrConfig=getMarkPropOrConfig(channel,markDef,config,{vgChannel:vgChannel});if(definedValueOrConfig!==undefined){return widthHeightValueOrSignalRef(channel,definedValueOrConfig)}switch(defaultPos){case"zeroOrMin":case"zeroOrMax":if(scaleName){var scaleType=scale.get("type");if(contains([ScaleType.LOG,ScaleType.TIME,ScaleType.UTC],scaleType));else{if(scale.domainDefinitelyIncludesZero()){return{scale:scaleName,value:0}}}}if(defaultPos==="zeroOrMin"){return mainChannel==="y"?{field:{group:"height"}}:{value:0}}else{switch(mainChannel){case"radius":return{signal:"min(".concat(model.width.signal,",").concat(model.height.signal,")/2")};case"theta":return{signal:"2*PI"};case"x":return{field:{group:"width"}};case"y":return{value:0}}}break;case"mid":{var sizeRef=model[getSizeChannel(channel)];return _objectSpread2(_objectSpread2({},sizeRef),{},{mult:.5})}}return undefined}}var ALIGNED_X_CHANNEL={left:"x",center:"xc",right:"x2"};var BASELINED_Y_CHANNEL={top:"y",middle:"yc",bottom:"y2"};function vgAlignedPositionChannel(channel,markDef,config){var defaultAlign=arguments.length>3&&arguments[3]!==undefined?arguments[3]:"middle";if(channel==="radius"||channel==="theta"){return getVgPositionChannel(channel)}var alignChannel=channel==="x"?"align":"baseline";var align=getMarkPropOrConfig(alignChannel,markDef,config);var alignExcludingSignal;if(isSignalRef(align)){warn(rangeMarkAlignmentCannotBeExpression(alignChannel));alignExcludingSignal=undefined}else{alignExcludingSignal=align}if(channel==="x"){return ALIGNED_X_CHANNEL[alignExcludingSignal||(defaultAlign==="top"?"left":"center")]}else{return BASELINED_Y_CHANNEL[alignExcludingSignal||defaultAlign]}}function pointOrRangePosition(channel,model,_ref){var defaultPos=_ref.defaultPos,defaultPos2=_ref.defaultPos2,range=_ref.range;if(range){return rangePosition(channel,model,{defaultPos:defaultPos,defaultPos2:defaultPos2})}return pointPosition(channel,model,{defaultPos:defaultPos})}function rangePosition(channel,model,_ref2){var defaultPos=_ref2.defaultPos,defaultPos2=_ref2.defaultPos2;var markDef=model.markDef,config=model.config;var channel2=getSecondaryRangeChannel(channel);var sizeChannel=getSizeChannel(channel);var pos2Mixins=pointPosition2OrSize(model,defaultPos2,channel2);var vgChannel=pos2Mixins[sizeChannel]?vgAlignedPositionChannel(channel,markDef,config):getVgPositionChannel(channel);return _objectSpread2(_objectSpread2({},pointPosition(channel,model,{defaultPos:defaultPos,vgChannel:vgChannel})),pos2Mixins)}function pointPosition2OrSize(model,defaultPos,channel){var _position2orSize;var encoding=model.encoding,mark=model.mark,markDef=model.markDef,stack=model.stack,config=model.config;var baseChannel=getMainRangeChannel(channel);var sizeChannel=getSizeChannel(channel);var vgChannel=getVgPositionChannel(channel);var channelDef=encoding[baseChannel];var scaleName=model.scaleName(baseChannel);var scale=model.getScaleComponent(baseChannel);var offset=channel in encoding||channel in markDef?getOffset(channel,model.markDef):getOffset(baseChannel,model.markDef);if(!channelDef&&(channel==="x2"||channel==="y2")&&(encoding.latitude||encoding.longitude)){return _defineProperty({},vgChannel,{field:model.getName(channel)})}var valueRef=position2Ref({channel:channel,channelDef:channelDef,channel2Def:encoding[channel],markDef:markDef,config:config,scaleName:scaleName,scale:scale,stack:stack,offset:offset,defaultRef:undefined});if(valueRef!==undefined){return _defineProperty({},vgChannel,valueRef)}return position2orSize(channel,markDef)||position2orSize(channel,(_position2orSize={},_defineProperty(_position2orSize,channel,getMarkStyleConfig(channel,markDef,config.style)),_defineProperty(_position2orSize,sizeChannel,getMarkStyleConfig(sizeChannel,markDef,config.style)),_position2orSize))||position2orSize(channel,config[mark])||position2orSize(channel,config.mark)||_defineProperty({},vgChannel,pointPositionDefaultRef({model:model,defaultPos:defaultPos,channel:channel,scaleName:scaleName,scale:scale})())}function position2Ref(_ref6){var channel=_ref6.channel,channelDef=_ref6.channelDef,channel2Def=_ref6.channel2Def,markDef=_ref6.markDef,config=_ref6.config,scaleName=_ref6.scaleName,scale=_ref6.scale,stack=_ref6.stack,offset=_ref6.offset,defaultRef=_ref6.defaultRef;if(isFieldOrDatumDef(channelDef)&&stack&&channel.charAt(0)===stack.fieldChannel.charAt(0)){return valueRefForFieldOrDatumDef(channelDef,scaleName,{suffix:"start"},{offset:offset})}return midPointRefWithPositionInvalidTest({channel:channel,channelDef:channel2Def,scaleName:scaleName,scale:scale,stack:stack,markDef:markDef,config:config,offset:offset,defaultRef:defaultRef})}function position2orSize(channel,markDef){var sizeChannel=getSizeChannel(channel);var vgChannel=getVgPositionChannel(channel);if(markDef[vgChannel]!==undefined){return _defineProperty({},vgChannel,widthHeightValueOrSignalRef(channel,markDef[vgChannel]))}else if(markDef[channel]!==undefined){return _defineProperty({},vgChannel,widthHeightValueOrSignalRef(channel,markDef[channel]))}else if(markDef[sizeChannel]){return _defineProperty({},sizeChannel,widthHeightValueOrSignalRef(channel,markDef[sizeChannel]))}return undefined}function rectPosition(model,channel,mark){var _ref,_encoding$sizeChannel;var config=model.config,encoding=model.encoding,markDef=model.markDef,stack=model.stack;var channel2=getSecondaryRangeChannel(channel);var sizeChannel=getSizeChannel(channel);var channelDef=encoding[channel];var channelDef2=encoding[channel2];var scale=model.getScaleComponent(channel);var scaleType=scale?scale.get("type"):undefined;var scaleName=model.scaleName(channel);var orient=markDef.orient;var hasSizeDef=(_ref=(_encoding$sizeChannel=encoding[sizeChannel])!==null&&_encoding$sizeChannel!==void 0?_encoding$sizeChannel:encoding.size)!==null&&_ref!==void 0?_ref:getMarkPropOrConfig("size",markDef,config,{vgChannel:sizeChannel});var isBarBand=mark==="bar"&&(channel==="x"?orient==="vertical":orient==="horizontal");if(isFieldDef(channelDef)&&(isBinning(channelDef.bin)||isBinned(channelDef.bin)||channelDef.timeUnit&&!channelDef2)&&!hasSizeDef&&!hasDiscreteDomain(scaleType)){var _model$component$axes,_axis$get;var band=getBand({channel:channel,fieldDef:channelDef,stack:stack,markDef:markDef,config:config});var axis=(_model$component$axes=model.component.axes[channel])===null||_model$component$axes===void 0?void 0:_model$component$axes[0];var axisTranslate=(_axis$get=axis===null||axis===void 0?void 0:axis.get("translate"))!==null&&_axis$get!==void 0?_axis$get:.5;return rectBinPosition({fieldDef:channelDef,fieldDef2:channelDef2,channel:channel,markDef:markDef,scaleName:scaleName,band:band,axisTranslate:axisTranslate,spacing:isXorY(channel)?getMarkPropOrConfig("binSpacing",markDef,config):undefined,reverse:scale.get("reverse"),config:config})}else if((isFieldOrDatumDef(channelDef)&&hasDiscreteDomain(scaleType)||isBarBand)&&!channelDef2){return positionAndSize(mark,channelDef,channel,model)}else{return rangePosition(channel,model,{defaultPos:"zeroOrMax",defaultPos2:"zeroOrMin"})}}function defaultSizeRef(mark,sizeChannel,scaleName,scale,config,band){if(scale){var scaleType=scale.get("type");if(scaleType==="point"||scaleType==="band"){if(config[mark].discreteBandSize!==undefined){return{value:config[mark].discreteBandSize}}if(scaleType===ScaleType.POINT){var scaleRange=scale.get("range");if(isVgRangeStep(scaleRange)&&isNumber(scaleRange.step)){return{value:scaleRange.step-2}}return{value:DEFAULT_STEP-2}}else{return{scale:scaleName,band:band}}}else{return{value:config[mark].continuousBandSize}}}var step=getViewConfigDiscreteStep(config.view,sizeChannel);var value=getFirstDefined(config[mark].discreteBandSize,step-2);return value!==undefined?{value:value}:undefined}function positionAndSize(mark,fieldDef,channel,model){var _ref2;var markDef=model.markDef,encoding=model.encoding,config=model.config,stack=model.stack;var orient=markDef.orient;var scaleName=model.scaleName(channel);var scale=model.getScaleComponent(channel);var vgSizeChannel=getSizeChannel(channel);var channel2=getSecondaryRangeChannel(channel);var useVlSizeChannel=orient==="horizontal"&&channel==="y"||orient==="vertical"&&channel==="x";var sizeFromMarkOrConfig=getMarkPropOrConfig(useVlSizeChannel?"size":vgSizeChannel,markDef,config,{vgChannel:vgSizeChannel});var sizeMixins;if(encoding.size||sizeFromMarkOrConfig!==undefined){if(useVlSizeChannel){sizeMixins=nonPosition("size",model,{vgChannel:vgSizeChannel,defaultValue:sizeFromMarkOrConfig})}else{warn(cannotApplySizeToNonOrientedMark(markDef.type))}}var band=(_ref2=isFieldOrDatumDef(fieldDef)?getBand({channel:channel,fieldDef:fieldDef,markDef:markDef,stack:stack,config:config}):undefined)!==null&&_ref2!==void 0?_ref2:1;sizeMixins=sizeMixins||_defineProperty({},vgSizeChannel,defaultSizeRef(mark,vgSizeChannel,scaleName,scale,config,band));var center=(scale===null||scale===void 0?void 0:scale.get("type"))!=="band"||!("band"in sizeMixins[vgSizeChannel]);var vgChannel=vgAlignedPositionChannel(channel,markDef,config,center?"middle":"top");var offset=getOffset(channel,markDef);var posRef=midPointRefWithPositionInvalidTest({channel:channel,channelDef:fieldDef,markDef:markDef,config:config,scaleName:scaleName,scale:scale,stack:stack,offset:offset,defaultRef:pointPositionDefaultRef({model:model,defaultPos:"mid",channel:channel,scaleName:scaleName,scale:scale}),band:center?.5:(1-band)/2});if(vgSizeChannel){return _objectSpread2(_defineProperty({},vgChannel,posRef),sizeMixins)}else{var _ref4;var vgChannel2=getVgPositionChannel(channel2);var sizeRef=sizeMixins[vgSizeChannel];var sizeOffset=offset?_objectSpread2(_objectSpread2({},sizeRef),{},{offset:offset}):sizeRef;return _ref4={},_defineProperty(_ref4,vgChannel,posRef),_defineProperty(_ref4,vgChannel2,isArray(posRef)?[posRef[0],_objectSpread2(_objectSpread2({},posRef[1]),{},{offset:sizeOffset})]:_objectSpread2(_objectSpread2({},posRef),{},{offset:sizeOffset})),_ref4}}function getBinSpacing(channel,spacing,reverse,translate,offset){if(isPolarPositionChannel(channel)){return 0}var spacingOffset=channel==="x"||channel==="y2"?-spacing/2:spacing/2;if(isSignalRef(reverse)||isSignalRef(offset)||isSignalRef(translate)){var reverseExpr=signalOrStringValue(reverse);var offsetExpr=signalOrStringValue(offset);var translateExpr=signalOrStringValue(translate);var t=translateExpr?"".concat(translateExpr," + "):"";var r=reverseExpr?"(".concat(reverseExpr," ? -1 : 1) * "):"";var o=offsetExpr?"(".concat(offsetExpr," + ").concat(spacingOffset,")"):spacingOffset;return{signal:t+r+o}}else{offset=offset||0;return translate+(reverse?-offset-spacingOffset:+offset+spacingOffset)}}function rectBinPosition(_ref5){var fieldDef=_ref5.fieldDef,fieldDef2=_ref5.fieldDef2,channel=_ref5.channel,band=_ref5.band,scaleName=_ref5.scaleName,markDef=_ref5.markDef,_ref5$spacing=_ref5.spacing,spacing=_ref5$spacing===void 0?0:_ref5$spacing,axisTranslate=_ref5.axisTranslate,reverse=_ref5.reverse,config=_ref5.config;var channel2=getSecondaryRangeChannel(channel);var vgChannel=getVgPositionChannel(channel);var vgChannel2=getVgPositionChannel(channel2);var offset=getOffset(channel,markDef);if(isBinning(fieldDef.bin)||fieldDef.timeUnit){var _ref6;return _ref6={},_defineProperty(_ref6,vgChannel2,rectBinRef({channel:channel,fieldDef:fieldDef,scaleName:scaleName,markDef:markDef,band:(1-band)/2,offset:getBinSpacing(channel2,spacing,reverse,axisTranslate,offset),config:config})),_defineProperty(_ref6,vgChannel,rectBinRef({channel:channel,fieldDef:fieldDef,scaleName:scaleName,markDef:markDef,band:1-(1-band)/2,offset:getBinSpacing(channel,spacing,reverse,axisTranslate,offset),config:config})),_ref6}else if(isBinned(fieldDef.bin)){var startRef=valueRefForFieldOrDatumDef(fieldDef,scaleName,{},{offset:getBinSpacing(channel2,spacing,reverse,axisTranslate,offset)});if(isFieldDef(fieldDef2)){var _ref7;return _ref7={},_defineProperty(_ref7,vgChannel2,startRef),_defineProperty(_ref7,vgChannel,valueRefForFieldOrDatumDef(fieldDef2,scaleName,{},{offset:getBinSpacing(channel,spacing,reverse,axisTranslate,offset)})),_ref7}else if(isBinParams(fieldDef.bin)&&fieldDef.bin.step){var _ref8;return _ref8={},_defineProperty(_ref8,vgChannel2,startRef),_defineProperty(_ref8,vgChannel,{signal:'scale("'.concat(scaleName,'", ').concat(vgField(fieldDef,{expr:"datum"})," + ").concat(fieldDef.bin.step,")"),offset:getBinSpacing(channel,spacing,reverse,axisTranslate,offset)}),_ref8}}warn(channelRequiredForBinned(channel2));return undefined}function rectBinRef(_ref9){var channel=_ref9.channel,fieldDef=_ref9.fieldDef,scaleName=_ref9.scaleName,markDef=_ref9.markDef,band=_ref9.band,offset=_ref9.offset,config=_ref9.config;var r=interpolatedSignalRef({scaleName:scaleName,fieldOrDatumDef:fieldDef,band:band,offset:offset});return wrapPositionInvalidTest({fieldDef:fieldDef,channel:channel,markDef:markDef,ref:r,config:config})}var ALWAYS_IGNORE=new Set(["aria"]);function baseEncodeEntry(model,ignore){var _ref=ignore.color==="include"?color(model):{},_ref$fill=_ref.fill,fill=_ref$fill===void 0?undefined:_ref$fill,_ref$stroke=_ref.stroke,stroke=_ref$stroke===void 0?undefined:_ref$stroke;return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},markDefProperties(model.markDef,ignore)),wrapAllFieldsInvalid(model,"fill",fill)),wrapAllFieldsInvalid(model,"stroke",stroke)),nonPosition("opacity",model)),nonPosition("fillOpacity",model)),nonPosition("strokeOpacity",model)),nonPosition("strokeWidth",model)),nonPosition("strokeDash",model)),zindex(model)),tooltip(model)),text(model,"href")),aria(model))}function wrapAllFieldsInvalid(model,channel,valueRef){var config=model.config,mark=model.mark,markDef=model.markDef;var invalid=getMarkPropOrConfig("invalid",markDef,config);if(invalid==="hide"&&valueRef&&!isPathMark(mark)){var test=allFieldsInvalidPredicate(model,{invalid:true,channels:SCALE_CHANNELS});if(test){return _defineProperty({},channel,[{test:test,value:null}].concat(_toConsumableArray(array(valueRef))))}}return valueRef?_defineProperty({},channel,valueRef):{}}function markDefProperties(mark,ignore){return VG_MARK_CONFIGS.reduce((function(m,prop){if(!ALWAYS_IGNORE.has(prop)&&mark[prop]!==undefined&&ignore[prop]!=="ignore"){m[prop]=signalOrValueRef(mark[prop])}return m}),{})}function allFieldsInvalidPredicate(model,_ref4){var _ref4$invalid=_ref4.invalid,invalid=_ref4$invalid===void 0?false:_ref4$invalid,channels=_ref4.channels;var filterIndex=channels.reduce((function(aggregator,channel){var scaleComponent=model.getScaleComponent(channel);if(scaleComponent){var scaleType=scaleComponent.get("type");var field=model.vgField(channel,{expr:"datum"});if(field&&hasContinuousDomain(scaleType)){aggregator[field]=true}}return aggregator}),{});var fields=keys(filterIndex);if(fields.length>0){var op=invalid?"||":"&&";return fields.map((function(field){return fieldInvalidPredicate(field,invalid)})).join(" ".concat(op," "))}return undefined}function defined(model){var config=model.config,markDef=model.markDef;var invalid=getMarkPropOrConfig("invalid",markDef,config);if(invalid){var signal=allFieldsInvalidPredicate$1(model,{channels:POSITION_SCALE_CHANNELS});if(signal){return{defined:{signal:signal}}}}return{}}function allFieldsInvalidPredicate$1(model,_ref){var _ref$invalid=_ref.invalid,invalid=_ref$invalid===void 0?false:_ref$invalid,channels=_ref.channels;var filterIndex=channels.reduce((function(aggregator,channel){var scaleComponent=model.getScaleComponent(channel);if(scaleComponent){var scaleType=scaleComponent.get("type");var field=model.vgField(channel,{expr:"datum"});if(field&&hasContinuousDomain(scaleType)){aggregator[field]=true}}return aggregator}),{});var fields=keys(filterIndex);if(fields.length>0){var op=invalid?"||":"&&";return fields.map((function(field){return fieldInvalidPredicate(field,invalid)})).join(" ".concat(op," "))}return undefined}function valueIfDefined(prop,value){if(value!==undefined){return _defineProperty({},prop,signalOrValueRef(value))}return undefined}var VORONOI="voronoi";var nearest={has:function has(selCmpt){return selCmpt.type!=="interval"&&selCmpt.nearest},parse:function parse(model,selCmpt){if(selCmpt.events){var _iterator=_createForOfIteratorHelper(selCmpt.events),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var s=_step.value;s.markname=model.getName(VORONOI)}}catch(err){_iterator.e(err)}finally{_iterator.f()}}},marks:function marks(model,selCmpt,_marks){var _selCmpt$project$hasC=selCmpt.project.hasChannel,x=_selCmpt$project$hasC.x,y=_selCmpt$project$hasC.y;var markType=model.mark;if(isPathMark(markType)){warn(nearestNotSupportForContinuous(markType));return _marks}var cellDef={name:model.getName(VORONOI),type:"path",interactive:true,from:{data:model.getName("marks")},encode:{update:_objectSpread2({fill:{value:"transparent"},strokeWidth:{value:.35},stroke:{value:"transparent"},isVoronoi:{value:true}},tooltip(model,{reactiveGeom:true}))},transform:[{type:"voronoi",x:{expr:x||!y?"datum.datum.x || 0":"0"},y:{expr:y||!x?"datum.datum.y || 0":"0"},size:[model.getSizeSignalRef("width"),model.getSizeSignalRef("height")]}]};var index=0;var exists=false;_marks.forEach((function(mark,i){var _mark$name;var name=(_mark$name=mark.name)!==null&&_mark$name!==void 0?_mark$name:"";if(name===model.component.mark[0].name){index=i}else if(name.indexOf(VORONOI)>=0){exists=true}}));if(!exists){_marks.splice(index+1,0,cellDef)}return _marks}};var DataFlowNode=function(){function DataFlowNode(parent,debugName){_classCallCheck(this,DataFlowNode);this.debugName=debugName;_defineProperty(this,"_children",[]);_defineProperty(this,"_parent",null);_defineProperty(this,"_hash",void 0);if(parent){this.parent=parent}}_createClass(DataFlowNode,[{key:"clone",value:function clone(){throw new Error("Cannot clone node")}},{key:"numChildren",value:function numChildren(){return this._children.length}},{key:"addChild",value:function addChild(child,loc){if(this._children.indexOf(child)>-1){warn(ADD_SAME_CHILD_TWICE);return}if(loc!==undefined){this._children.splice(loc,0,child)}else{this._children.push(child)}}},{key:"removeChild",value:function removeChild(oldChild){var loc=this._children.indexOf(oldChild);this._children.splice(loc,1);return loc}},{key:"remove",value:function remove(){var loc=this._parent.removeChild(this);var _iterator=_createForOfIteratorHelper(this._children),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var child=_step.value;child._parent=this._parent;this._parent.addChild(child,loc++)}}catch(err){_iterator.e(err)}finally{_iterator.f()}}},{key:"insertAsParentOf",value:function insertAsParentOf(other){var parent=other.parent;parent.removeChild(this);this.parent=parent;other.parent=this}},{key:"swapWithParent",value:function swapWithParent(){var parent=this._parent;var newParent=parent.parent;var _iterator2=_createForOfIteratorHelper(this._children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;child.parent=parent}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}this._children=[];parent.removeChild(this);parent.parent.removeChild(parent);this.parent=newParent;parent.parent=this}},{key:"parent",get:function get(){return this._parent},set:function set(parent){this._parent=parent;if(parent){parent.addChild(this)}}},{key:"children",get:function get(){return this._children}}]);return DataFlowNode}();var OutputNode=function(_DataFlowNode){_inherits(OutputNode,_DataFlowNode);var _super=_createSuper(OutputNode);_createClass(OutputNode,[{key:"clone",value:function clone(){var cloneObj=new this.constructor;cloneObj.debugName="clone_"+this.debugName;cloneObj._source=this._source;cloneObj._name="clone_"+this._name;cloneObj.type=this.type;cloneObj.refCounts=this.refCounts;cloneObj.refCounts[cloneObj._name]=0;return cloneObj}}]);function OutputNode(parent,source,type,refCounts){var _this;_classCallCheck(this,OutputNode);_this=_super.call(this,parent,source);_this.type=type;_this.refCounts=refCounts;_defineProperty(_assertThisInitialized(_this),"_source",void 0);_defineProperty(_assertThisInitialized(_this),"_name",void 0);_this._source=_this._name=source;if(_this.refCounts&&!(_this._name in _this.refCounts)){_this.refCounts[_this._name]=0}return _this}_createClass(OutputNode,[{key:"dependentFields",value:function dependentFields(){return new Set}},{key:"producedFields",value:function producedFields(){return new Set}},{key:"hash",value:function hash(){if(this._hash===undefined){this._hash="Output ".concat(uniqueId())}return this._hash}},{key:"getSource",value:function getSource(){this.refCounts[this._name]++;return this._source}},{key:"isRequired",value:function isRequired(){return!!this.refCounts[this._name]}},{key:"setSource",value:function setSource(source){this._source=source}}]);return OutputNode}(DataFlowNode);var TimeUnitNode=function(_DataFlowNode){_inherits(TimeUnitNode,_DataFlowNode);var _super=_createSuper(TimeUnitNode);_createClass(TimeUnitNode,[{key:"clone",value:function clone(){return new TimeUnitNode(null,duplicate(this.formula))}}]);function TimeUnitNode(parent,formula){var _this;_classCallCheck(this,TimeUnitNode);_this=_super.call(this,parent);_this.formula=formula;return _this}_createClass(TimeUnitNode,[{key:"merge",value:function merge(other){this.formula=_objectSpread2({},this.formula);for(var key in other.formula){if(!this.formula[key]||other.formula[key].band){this.formula[key]=other.formula[key]}}var _iterator=_createForOfIteratorHelper(other.children),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var child=_step.value;other.removeChild(child);child.parent=this}}catch(err){_iterator.e(err)}finally{_iterator.f()}other.remove()}},{key:"removeFormulas",value:function removeFormulas(fields){var newFormula={};var _iterator2=_createForOfIteratorHelper(entries(this.formula)),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _step2$value=_slicedToArray(_step2.value,2),key=_step2$value[0],timeUnit=_step2$value[1];if(!fields.has(timeUnit.as)){newFormula[key]=timeUnit}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}this.formula=newFormula}},{key:"producedFields",value:function producedFields(){return new Set(vals(this.formula).map((function(f){return f.as})))}},{key:"dependentFields",value:function dependentFields(){return new Set(vals(this.formula).map((function(f){return f.field})))}},{key:"hash",value:function hash$1(){return"TimeUnit ".concat(hash(this.formula))}},{key:"assemble",value:function assemble(){var transforms=[];var _iterator3=_createForOfIteratorHelper(vals(this.formula)),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var f=_step3.value;var field=f.field,as=f.as,timeUnit=f.timeUnit;var _normalizeTimeUnit=normalizeTimeUnit(timeUnit),unit=_normalizeTimeUnit.unit,utc=_normalizeTimeUnit.utc,params=_objectWithoutProperties(_normalizeTimeUnit,["unit","utc"]);transforms.push(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({field:replacePathInField(field),type:"timeunit"},unit?{units:getTimeUnitParts(unit)}:{}),utc?{timezone:"utc"}:{}),params),{},{as:[as,"".concat(as,"_end")]}))}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return transforms}}],[{key:"makeFromEncoding",value:function makeFromEncoding(parent,model){var formula=model.reduceFieldDef((function(timeUnitComponent,fieldDef,channel){var field=fieldDef.field,timeUnit=fieldDef.timeUnit;var channelDef2=isUnitModel(model)?model.encoding[getSecondaryRangeChannel(channel)]:undefined;var band=isUnitModel(model)&&hasBand(channel,fieldDef,channelDef2,model.stack,model.markDef,model.config);if(timeUnit){var as=vgField(fieldDef,{forAs:true});timeUnitComponent[hash({as:as,field:field,timeUnit:timeUnit})]=_objectSpread2({as:as,field:field,timeUnit:timeUnit},band?{band:true}:{})}return timeUnitComponent}),{});if(isEmpty(formula)){return null}return new TimeUnitNode(parent,formula)}},{key:"makeFromTransform",value:function makeFromTransform(parent,t){var _t=_objectSpread2({},t),timeUnit=_t.timeUnit,other=_objectWithoutProperties(_t,["timeUnit"]);var normalizedTimeUnit=normalizeTimeUnit(timeUnit);var component=_objectSpread2(_objectSpread2({},other),{},{timeUnit:normalizedTimeUnit});return new TimeUnitNode(parent,_defineProperty({},hash(component),component))}}]);return TimeUnitNode}(DataFlowNode);var TUPLE_FIELDS="_tuple_fields";var SelectionProjectionComponent=function SelectionProjectionComponent(){_classCallCheck(this,SelectionProjectionComponent);_defineProperty(this,"hasChannel",void 0);_defineProperty(this,"hasField",void 0);_defineProperty(this,"timeUnit",void 0);_defineProperty(this,"items",void 0);for(var _len=arguments.length,items=new Array(_len),_key=0;_key<_len;_key++){items[_key]=arguments[_key]}this.items=items;this.hasChannel={};this.hasField={}};var project={has:function has(){return true},parse:function parse(model,selCmpt,selDef){var _selCmpt$project,_selDef$fields,_selDef$encodings;var name=selCmpt.name;var proj=(_selCmpt$project=selCmpt.project)!==null&&_selCmpt$project!==void 0?_selCmpt$project:selCmpt.project=new SelectionProjectionComponent;var parsed={};var timeUnits={};var signals=new Set;var signalName=function signalName(p,range){var suffix=range==="visual"?p.channel:p.field;var sg=varName("".concat(name,"_").concat(suffix));for(var counter=1;signals.has(sg);counter++){sg=varName("".concat(name,"_").concat(suffix,"_").concat(counter))}signals.add(sg);return _defineProperty({},range,sg)};if(!selDef.fields&&!selDef.encodings){var cfg=model.config.selection[selDef.type];if(selDef.init){var _iterator=_createForOfIteratorHelper(array(selDef.init)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var init=_step.value;var _iterator2=_createForOfIteratorHelper(keys(init)),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var key=_step2.value;if(isSingleDefUnitChannel(key)){(selDef.encodings||(selDef.encodings=[])).push(key)}else{if(selDef.type==="interval"){warn(INTERVAL_INITIALIZED_WITH_X_Y);selDef.encodings=cfg.encodings}else{(selDef.fields||(selDef.fields=[])).push(key)}}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}else{selDef.encodings=cfg.encodings;selDef.fields=cfg.fields}}var _iterator3=_createForOfIteratorHelper((_selDef$fields=selDef.fields)!==null&&_selDef$fields!==void 0?_selDef$fields:[]),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var field=_step3.value;var p={type:"E",field:field};p.signals=_objectSpread2({},signalName(p,"data"));proj.items.push(p);proj.hasField[field]=p}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}var _iterator4=_createForOfIteratorHelper((_selDef$encodings=selDef.encodings)!==null&&_selDef$encodings!==void 0?_selDef$encodings:[]),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var channel=_step4.value;var fieldDef=model.fieldDef(channel);if(fieldDef){var _field=fieldDef.field;if(fieldDef.aggregate){warn(cannotProjectAggregate(channel,fieldDef.aggregate));continue}else if(!_field){warn(cannotProjectOnChannelWithoutField(channel));continue}if(fieldDef.timeUnit){_field=model.vgField(channel);var component={timeUnit:fieldDef.timeUnit,as:_field,field:fieldDef.field};timeUnits[hash(component)]=component}if(!parsed[_field]){var type="E";if(selCmpt.type==="interval"){var scaleType=model.getScaleComponent(channel).get("type");if(hasContinuousDomain(scaleType)){type="R"}}else if(fieldDef.bin){type="R-RE"}var _p={field:_field,channel:channel,type:type};_p.signals=_objectSpread2(_objectSpread2({},signalName(_p,"data")),signalName(_p,"visual"));proj.items.push(parsed[_field]=_p);proj.hasField[_field]=proj.hasChannel[channel]=parsed[_field]}}else{warn(cannotProjectOnChannelWithoutField(channel))}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}if(selDef.init){var parseInit=function parseInit(i){return proj.items.map((function(p){return i[p.channel]!==undefined?i[p.channel]:i[p.field]}))};if(selDef.type==="interval"){selCmpt.init=parseInit(selDef.init)}else{var _init=array(selDef.init);selCmpt.init=_init.map(parseInit)}}if(!isEmpty(timeUnits)){proj.timeUnit=new TimeUnitNode(null,timeUnits)}},signals:function signals(model,selCmpt,allSignals){var name=selCmpt.name+TUPLE_FIELDS;var hasSignal=allSignals.filter((function(s){return s.name===name}));return hasSignal.length>0?allSignals:allSignals.concat({name:name,value:selCmpt.project.items.map((function(proj){var signals=proj.signals,hasLegend=proj.hasLegend,rest=_objectWithoutProperties(proj,["signals","hasLegend"]);rest.field=replacePathInField(rest.field);return rest}))})}};var inputBindings={has:function has(selCmpt){return selCmpt.type==="single"&&selCmpt.resolve==="global"&&selCmpt.bind&&selCmpt.bind!=="scales"&&!isLegendBinding(selCmpt.bind)},parse:function parse(model,selCmpt,selDef,origDef){if(!origDef.on)delete selCmpt.events;if(!origDef.clear)delete selCmpt.clear},topLevelSignals:function topLevelSignals(model,selCmpt,signals){var name=selCmpt.name;var proj=selCmpt.project;var bind=selCmpt.bind;var init=selCmpt.init&&selCmpt.init[0];var datum=nearest.has(selCmpt)?"(item().isVoronoi ? datum.datum : datum)":"datum";proj.items.forEach((function(p,i){var sgname=varName("".concat(name,"_").concat(p.field));var hasSignal=signals.filter((function(s){return s.name===sgname}));if(!hasSignal.length){var _ref,_bind$p$field;signals.unshift(_objectSpread2(_objectSpread2({name:sgname},init?{init:assembleInit(init[i])}:{value:null}),{},{on:selCmpt.events?[{events:selCmpt.events,update:"datum && item().mark.marktype !== 'group' ? ".concat(datum,"[").concat($(p.field),"] : null")}]:[],bind:(_ref=(_bind$p$field=bind[p.field])!==null&&_bind$p$field!==void 0?_bind$p$field:bind[p.channel])!==null&&_ref!==void 0?_ref:bind}))}}));return signals},signals:function signals(model,selCmpt,_signals){var name=selCmpt.name;var proj=selCmpt.project;var signal=_signals.filter((function(s){return s.name===name+TUPLE}))[0];var fields=name+TUPLE_FIELDS;var values=proj.items.map((function(p){return varName("".concat(name,"_").concat(p.field))}));var valid=values.map((function(v){return"".concat(v," !== null")})).join(" && ");if(values.length){signal.update="".concat(valid," ? {fields: ").concat(fields,", values: [").concat(values.join(", "),"]} : null")}delete signal.value;delete signal.on;return _signals}};var TOGGLE="_toggle";var toggle={has:function has(selCmpt){return selCmpt.type==="multi"&&!!selCmpt.toggle},signals:function signals(model,selCmpt,_signals){return _signals.concat({name:selCmpt.name+TOGGLE,value:false,on:[{events:selCmpt.events,update:selCmpt.toggle}]})},modifyExpr:function modifyExpr(model,selCmpt){var tpl=selCmpt.name+TUPLE;var signal=selCmpt.name+TOGGLE;return"".concat(signal," ? null : ").concat(tpl,", ")+(selCmpt.resolve==="global"?"".concat(signal," ? null : true, "):"".concat(signal," ? null : {unit: ").concat(unitName(model),"}, "))+"".concat(signal," ? ").concat(tpl," : null")}};var clear={has:function has(selCmpt){return selCmpt.clear!==undefined&&selCmpt.clear!==false},parse:function parse(model,selCmpt,selDef){if(selDef.clear){selCmpt.clear=isString(selDef.clear)?eventSelector(selDef.clear,"scope"):selDef.clear}},topLevelSignals:function topLevelSignals(model,selCmpt,signals){if(inputBindings.has(selCmpt)){var _iterator=_createForOfIteratorHelper(selCmpt.project.items),_step;try{var _loop=function _loop(){var proj=_step.value;var idx=signals.findIndex((function(n){return n.name===varName("".concat(selCmpt.name,"_").concat(proj.field))}));if(idx!==-1){signals[idx].on.push({events:selCmpt.clear,update:"null"})}};for(_iterator.s();!(_step=_iterator.n()).done;){_loop()}}catch(err){_iterator.e(err)}finally{_iterator.f()}}return signals},signals:function signals(model,selCmpt,_signals){function addClear(idx,update){if(idx!==-1&&_signals[idx].on){_signals[idx].on.push({events:selCmpt.clear,update:update})}}if(selCmpt.type==="interval"){var _iterator2=_createForOfIteratorHelper(selCmpt.project.items),_step2;try{var _loop2=function _loop2(){var proj=_step2.value;var vIdx=_signals.findIndex((function(n){return n.name===proj.signals.visual}));addClear(vIdx,"[0, 0]");if(vIdx===-1){var dIdx=_signals.findIndex((function(n){return n.name===proj.signals.data}));addClear(dIdx,"null")}};for(_iterator2.s();!(_step2=_iterator2.n()).done;){_loop2()}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}else{var tIdx=_signals.findIndex((function(n){return n.name===selCmpt.name+TUPLE}));addClear(tIdx,"null");if(toggle.has(selCmpt)){tIdx=_signals.findIndex((function(n){return n.name===selCmpt.name+TOGGLE}));addClear(tIdx,"false")}}return _signals}};var scaleBindings={has:function has(selCmpt){return selCmpt.type==="interval"&&selCmpt.resolve==="global"&&selCmpt.bind&&selCmpt.bind==="scales"},parse:function parse(model,selCmpt){var bound=selCmpt.scales=[];var _iterator=_createForOfIteratorHelper(selCmpt.project.items),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var proj=_step.value;var channel=proj.channel;if(!isScaleChannel(channel)){continue}var scale=model.getScaleComponent(channel);var scaleType=scale?scale.get("type"):undefined;if(!scale||!hasContinuousDomain(scaleType)){warn(SCALE_BINDINGS_CONTINUOUS);continue}var extent={selection:selCmpt.name,field:proj.field};scale.set("selectionExtent",extent,true);bound.push(proj)}}catch(err){_iterator.e(err)}finally{_iterator.f()}},topLevelSignals:function topLevelSignals(model,selCmpt,signals){var bound=selCmpt.scales.filter((function(proj){return signals.filter((function(s){return s.name===proj.signals.data})).length===0}));if(!model.parent||isTopLevelLayer(model)||bound.length===0){return signals}var namedSg=signals.filter((function(s){return s.name===selCmpt.name}))[0];var update=namedSg.update;if(update.indexOf(VL_SELECTION_RESOLVE)>=0){namedSg.update="{".concat(bound.map((function(proj){return"".concat($(proj.field),": ").concat(proj.signals.data)})).join(", "),"}")}else{var _iterator2=_createForOfIteratorHelper(bound),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var proj=_step2.value;var mapping="".concat($(proj.field),": ").concat(proj.signals.data);if(update.indexOf(mapping)<0){update="".concat(update.substring(0,update.length-1),", ").concat(mapping,"}")}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}namedSg.update=update}return signals.concat(bound.map((function(proj){return{name:proj.signals.data}})))},signals:function signals(model,selCmpt,_signals){if(model.parent&&!isTopLevelLayer(model)){var _iterator3=_createForOfIteratorHelper(selCmpt.scales),_step3;try{var _loop=function _loop(){var proj=_step3.value;var signal=_signals.filter((function(s){return s.name===proj.signals.data}))[0];signal.push="outer";delete signal.value;delete signal.update};for(_iterator3.s();!(_step3=_iterator3.n()).done;){_loop()}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}return _signals}};function domain(model,channel){var scale=$(model.scaleName(channel));return"domain(".concat(scale,")")}function isTopLevelLayer(model){var _model$parent$parent;return model.parent&&isLayerModel(model.parent)&&((_model$parent$parent=!model.parent.parent)!==null&&_model$parent$parent!==void 0?_model$parent$parent:isTopLevelLayer(model.parent.parent))}var legendBindings={has:function has(selCmpt){var spec=selCmpt.resolve==="global"&&selCmpt.bind&&isLegendBinding(selCmpt.bind);var projLen=selCmpt.project.items.length===1&&selCmpt.project.items[0].field!==SELECTION_ID;if(spec&&!projLen){warn(LEGEND_BINDINGS_MUST_HAVE_PROJECTION)}return spec&&projLen},parse:function parse(model,selCmpt,selDef,origDef){if(!origDef.on)delete selCmpt.events;if(!origDef.clear)delete selCmpt.clear;if(origDef.on||origDef.clear){var legendFilter='event.item && indexof(event.item.mark.role, "legend") < 0';var _iterator=_createForOfIteratorHelper(selCmpt.events),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var _evt$filter;var _evt=_step.value;_evt.filter=array((_evt$filter=_evt.filter)!==null&&_evt$filter!==void 0?_evt$filter:[]);if(_evt.filter.indexOf(legendFilter)<0){_evt.filter.push(legendFilter)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}var evt=isLegendStreamBinding(selCmpt.bind)?selCmpt.bind.legend:"click";var stream=isString(evt)?eventSelector(evt,"view"):array(evt);selCmpt.bind={legend:{merge:stream}}},topLevelSignals:function topLevelSignals(model,selCmpt,signals){var selName=selCmpt.name;var stream=isLegendStreamBinding(selCmpt.bind)&&selCmpt.bind.legend;var markName=function markName(name){return function(s){var ds=duplicate(s);ds.markname=name;return ds}};var _iterator2=_createForOfIteratorHelper(selCmpt.project.items),_step2;try{var _loop=function _loop(){var proj=_step2.value;if(!proj.hasLegend)return"continue";var prefix="".concat(varName(proj.field),"_legend");var sgName="".concat(selName,"_").concat(prefix);var hasSignal=signals.filter((function(s){return s.name===sgName}));if(hasSignal.length===0){var events=stream.merge.map(markName("".concat(prefix,"_symbols"))).concat(stream.merge.map(markName("".concat(prefix,"_labels")))).concat(stream.merge.map(markName("".concat(prefix,"_entries"))));signals.unshift(_objectSpread2(_objectSpread2({name:sgName},!selCmpt.init?{value:null}:{}),{},{on:[{events:events,update:"datum.value || item().items[0].items[0].datum.value",force:true},{events:stream.merge,update:"!event.item || !datum ? null : ".concat(sgName),force:true}]}))}};for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _ret=_loop();if(_ret==="continue")continue}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return signals},signals:function signals(model,selCmpt,_signals){var name=selCmpt.name;var proj=selCmpt.project;var tuple=_signals.find((function(s){return s.name===name+TUPLE}));var fields=name+TUPLE_FIELDS;var values=proj.items.filter((function(p){return p.hasLegend})).map((function(p){return varName("".concat(name,"_").concat(varName(p.field),"_legend"))}));var valid=values.map((function(v){return"".concat(v," !== null")})).join(" && ");var update="".concat(valid," ? {fields: ").concat(fields,", values: [").concat(values.join(", "),"]} : null");if(selCmpt.events&&values.length>0){tuple.on.push({events:values.map((function(signal){return{signal:signal}})),update:update})}else if(values.length>0){tuple.update=update;delete tuple.value;delete tuple.on}var toggle=_signals.find((function(s){return s.name===name+TOGGLE}));var events=isLegendStreamBinding(selCmpt.bind)&&selCmpt.bind.legend;if(toggle){if(!selCmpt.events)toggle.on[0].events=events;else toggle.on.push(_objectSpread2(_objectSpread2({},toggle.on[0]),{},{events:events}))}return _signals}};function parseInteractiveLegend(model,channel,legendCmpt){var _model$fieldDef;var field=(_model$fieldDef=model.fieldDef(channel))===null||_model$fieldDef===void 0?void 0:_model$fieldDef.field;forEachSelection(model,(function(selCmpt){var _selCmpt$project$hasF;var proj=(_selCmpt$project$hasF=selCmpt.project.hasField[field])!==null&&_selCmpt$project$hasF!==void 0?_selCmpt$project$hasF:selCmpt.project.hasChannel[channel];if(proj&&legendBindings.has(selCmpt)){var _legendCmpt$get;var legendSelections=(_legendCmpt$get=legendCmpt.get("selections"))!==null&&_legendCmpt$get!==void 0?_legendCmpt$get:[];legendSelections.push(selCmpt.name);legendCmpt.set("selections",legendSelections,false);proj.hasLegend=true}}))}var ANCHOR="_translate_anchor";var DELTA="_translate_delta";var translate={has:function has(selCmpt){return selCmpt.type==="interval"&&selCmpt.translate},signals:function signals(model,selCmpt,_signals){var name=selCmpt.name;var hasScales=scaleBindings.has(selCmpt);var anchor=name+ANCHOR;var _selCmpt$project$hasC=selCmpt.project.hasChannel,x=_selCmpt$project$hasC.x,y=_selCmpt$project$hasC.y;var events=eventSelector(selCmpt.translate,"scope");if(!hasScales){events=events.map((function(e){return e.between[0].markname=name+BRUSH,e}))}_signals.push({name:anchor,value:{},on:[{events:events.map((function(e){return e.between[0]})),update:"{x: x(unit), y: y(unit)"+(x!==undefined?", extent_x: "+(hasScales?domain(model,X):"slice(".concat(x.signals.visual,")")):"")+(y!==undefined?", extent_y: "+(hasScales?domain(model,Y):"slice(".concat(y.signals.visual,")")):"")+"}"}]},{name:name+DELTA,value:{},on:[{events:events,update:"{x: ".concat(anchor,".x - x(unit), y: ").concat(anchor,".y - y(unit)}")}]});if(x!==undefined){onDelta(model,selCmpt,x,"width",_signals)}if(y!==undefined){onDelta(model,selCmpt,y,"height",_signals)}return _signals}};function onDelta(model,selCmpt,proj,size,signals){var _scaleCmpt$get;var name=selCmpt.name;var anchor=name+ANCHOR;var delta=name+DELTA;var channel=proj.channel;var hasScales=scaleBindings.has(selCmpt);var signal=signals.filter((function(s){return s.name===proj.signals[hasScales?"data":"visual"]}))[0];var sizeSg=model.getSizeSignalRef(size).signal;var scaleCmpt=model.getScaleComponent(channel);var scaleType=scaleCmpt.get("type");var sign=hasScales&&channel===X?"-":"";var extent="".concat(anchor,".extent_").concat(channel);var offset="".concat(sign).concat(delta,".").concat(channel," / ")+(hasScales?"".concat(sizeSg):"span(".concat(extent,")"));var panFn=!hasScales?"panLinear":scaleType==="log"?"panLog":scaleType==="pow"?"panPow":"panLinear";var update="".concat(panFn,"(").concat(extent,", ").concat(offset)+(hasScales&&scaleType==="pow"?", ".concat((_scaleCmpt$get=scaleCmpt.get("exponent"))!==null&&_scaleCmpt$get!==void 0?_scaleCmpt$get:1):"")+")";signal.on.push({events:{signal:delta},update:hasScales?update:"clampRange(".concat(update,", 0, ").concat(sizeSg,")")})}var ANCHOR$1="_zoom_anchor";var DELTA$1="_zoom_delta";var zoom={has:function has(selCmpt){return selCmpt.type==="interval"&&selCmpt.zoom},signals:function signals(model,selCmpt,_signals){var name=selCmpt.name;var hasScales=scaleBindings.has(selCmpt);var delta=name+DELTA$1;var _selCmpt$project$hasC=selCmpt.project.hasChannel,x=_selCmpt$project$hasC.x,y=_selCmpt$project$hasC.y;var sx=$(model.scaleName(X));var sy=$(model.scaleName(Y));var events=eventSelector(selCmpt.zoom,"scope");if(!hasScales){events=events.map((function(e){return e.markname=name+BRUSH,e}))}_signals.push({name:name+ANCHOR$1,on:[{events:events,update:!hasScales?"{x: x(unit), y: y(unit)}":"{"+[sx?"x: invert(".concat(sx,", x(unit))"):"",sy?"y: invert(".concat(sy,", y(unit))"):""].filter((function(expr){return!!expr})).join(", ")+"}"}]},{name:delta,on:[{events:events,force:true,update:"pow(1.001, event.deltaY * pow(16, event.deltaMode))"}]});if(x!==undefined){onDelta$1(model,selCmpt,x,"width",_signals)}if(y!==undefined){onDelta$1(model,selCmpt,y,"height",_signals)}return _signals}};function onDelta$1(model,selCmpt,proj,size,signals){var _scaleCmpt$get;var name=selCmpt.name;var channel=proj.channel;var hasScales=scaleBindings.has(selCmpt);var signal=signals.filter((function(s){return s.name===proj.signals[hasScales?"data":"visual"]}))[0];var sizeSg=model.getSizeSignalRef(size).signal;var scaleCmpt=model.getScaleComponent(channel);var scaleType=scaleCmpt.get("type");var base=hasScales?domain(model,channel):signal.name;var delta=name+DELTA$1;var anchor="".concat(name).concat(ANCHOR$1,".").concat(channel);var zoomFn=!hasScales?"zoomLinear":scaleType==="log"?"zoomLog":scaleType==="pow"?"zoomPow":"zoomLinear";var update="".concat(zoomFn,"(").concat(base,", ").concat(anchor,", ").concat(delta)+(hasScales&&scaleType==="pow"?", ".concat((_scaleCmpt$get=scaleCmpt.get("exponent"))!==null&&_scaleCmpt$get!==void 0?_scaleCmpt$get:1):"")+")";signal.on.push({events:{signal:delta},update:hasScales?update:"clampRange(".concat(update,", 0, ").concat(sizeSg,")")})}var compilers=[project,toggle,scaleBindings,legendBindings,translate,zoom,inputBindings,nearest,clear];function forEachTransform(selCmpt,cb){var _iterator=_createForOfIteratorHelper(compilers),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var t=_step.value;if(t.has(selCmpt)){cb(t)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}function assembleInit(init){var isExpr=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var wrap=arguments.length>2&&arguments[2]!==undefined?arguments[2]:identity;if(isArray(init)){var assembled=init.map((function(v){return assembleInit(v,isExpr,wrap)}));return isExpr?"[".concat(assembled.join(", "),"]"):assembled}else if(isDateTime(init)){if(isExpr){return wrap(dateTimeToExpr(init))}else{return wrap(dateTimeToTimestamp(init))}}return isExpr?wrap(JSON.stringify(init)):init}function assembleUnitSelectionSignals(model,signals){forEachSelection(model,(function(selCmpt,selCompiler){var _signals;var name=selCmpt.name;var modifyExpr=selCompiler.modifyExpr(model,selCmpt);(_signals=signals).push.apply(_signals,_toConsumableArray(selCompiler.signals(model,selCmpt)));forEachTransform(selCmpt,(function(txCompiler){if(txCompiler.signals){signals=txCompiler.signals(model,selCmpt,signals)}if(txCompiler.modifyExpr){modifyExpr=txCompiler.modifyExpr(model,selCmpt,modifyExpr)}}));signals.push({name:name+MODIFY,on:[{events:{signal:selCmpt.name+TUPLE},update:"modify(".concat($(selCmpt.name+STORE),", ").concat(modifyExpr,")")}]})}));return cleanupEmptyOnArray(signals)}function assembleFacetSignals(model,signals){if(model.component.selection&&keys(model.component.selection).length){var name=$(model.getName("cell"));signals.unshift({name:"facet",value:{},on:[{events:eventSelector("mousemove","scope"),update:"isTuple(facet) ? facet : group(".concat(name,").datum")}]})}return cleanupEmptyOnArray(signals)}function assembleTopLevelSignals(model,signals){var hasSelections=false;forEachSelection(model,(function(selCmpt,selCompiler){var name=selCmpt.name;var store=$(name+STORE);var hasSg=signals.filter((function(s){return s.name===name}));if(hasSg.length===0){var resolve=selCmpt.resolve==="global"?"union":selCmpt.resolve;var isMulti=selCmpt.type==="multi"?", true)":")";signals.push({name:selCmpt.name,update:"".concat(VL_SELECTION_RESOLVE,"(").concat(store,", ").concat($(resolve)).concat(isMulti)})}hasSelections=true;if(selCompiler.topLevelSignals){signals=selCompiler.topLevelSignals(model,selCmpt,signals)}forEachTransform(selCmpt,(function(txCompiler){if(txCompiler.topLevelSignals){signals=txCompiler.topLevelSignals(model,selCmpt,signals)}}))}));if(hasSelections){var hasUnit=signals.filter((function(s){return s.name==="unit"}));if(hasUnit.length===0){signals.unshift({name:"unit",value:{},on:[{events:"mousemove",update:"isTuple(group()) ? group() : unit"}]})}}return cleanupEmptyOnArray(signals)}function assembleUnitSelectionData(model,data){var dataCopy=_toConsumableArray(data);forEachSelection(model,(function(selCmpt){var init={name:selCmpt.name+STORE};if(selCmpt.init){var fields=selCmpt.project.items.map((function(proj){var signals=proj.signals,rest=_objectWithoutProperties(proj,["signals"]);return rest}));var insert=selCmpt.init.map((function(i){return assembleInit(i,false)}));init.values=selCmpt.type==="interval"?[{unit:unitName(model,{escape:false}),fields:fields,values:insert}]:insert.map((function(i){return{unit:unitName(model,{escape:false}),fields:fields,values:i}}))}var contains=dataCopy.filter((function(d){return d.name===selCmpt.name+STORE}));if(!contains.length){dataCopy.push(init)}}));return dataCopy}function assembleUnitSelectionMarks(model,marks){forEachSelection(model,(function(selCmpt,selCompiler){marks=selCompiler.marks?selCompiler.marks(model,selCmpt,marks):marks;forEachTransform(selCmpt,(function(txCompiler){if(txCompiler.marks){marks=txCompiler.marks(model,selCmpt,marks)}}))}));return marks}function assembleLayerSelectionMarks(model,marks){var _iterator=_createForOfIteratorHelper(model.children),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var child=_step.value;if(isUnitModel(child)){marks=assembleUnitSelectionMarks(child,marks)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return marks}function assembleSelectionScaleDomain(model,extent){var name=extent.selection;var selCmpt=model.getSelectionComponent(name,varName(name));return{signal:parseSelectionBinExtent(selCmpt,extent)}}function cleanupEmptyOnArray(signals){return signals.map((function(s){if(s.on&&!s.on.length)delete s.on;return s}))}var BRUSH="_brush";var SCALE_TRIGGER="_scale_trigger";var interval={signals:function signals(model,selCmpt){var name=selCmpt.name;var fieldsSg=name+TUPLE_FIELDS;var hasScales=scaleBindings.has(selCmpt);var signals=[];var dataSignals=[];var scaleTriggers=[];if(selCmpt.translate&&!hasScales){var filterExpr="!event.item || event.item.mark.name !== ".concat($(name+BRUSH));events(selCmpt,(function(on,evt){var _evt$between$0$filter;var filters=array((_evt$between$0$filter=evt.between[0].filter)!==null&&_evt$between$0$filter!==void 0?_evt$between$0$filter:evt.between[0].filter=[]);if(filters.indexOf(filterExpr)<0){filters.push(filterExpr)}return on}))}selCmpt.project.items.forEach((function(proj,i){var channel=proj.channel;if(channel!==X&&channel!==Y){warn("Interval selections only support x and y encoding channels.");return}var init=selCmpt.init?selCmpt.init[i]:null;var cs=channelSignals(model,selCmpt,proj,init);var dname=proj.signals.data;var vname=proj.signals.visual;var scaleName=$(model.scaleName(channel));var scaleType=model.getScaleComponent(channel).get("type");var toNum=hasContinuousDomain(scaleType)?"+":"";signals.push.apply(signals,_toConsumableArray(cs));dataSignals.push(dname);scaleTriggers.push({scaleName:model.scaleName(channel),expr:"(!isArray(".concat(dname,") || ")+"(".concat(toNum,"invert(").concat(scaleName,", ").concat(vname,")[0] === ").concat(toNum).concat(dname,"[0] && ")+"".concat(toNum,"invert(").concat(scaleName,", ").concat(vname,")[1] === ").concat(toNum).concat(dname,"[1]))")})}));if(!hasScales){signals.push({name:name+SCALE_TRIGGER,value:{},on:[{events:scaleTriggers.map((function(t){return{scale:t.scaleName}})),update:scaleTriggers.map((function(t){return t.expr})).join(" && ")+" ? ".concat(name+SCALE_TRIGGER," : {}")}]})}var init=selCmpt.init;var update="unit: ".concat(unitName(model),", fields: ").concat(fieldsSg,", values");return signals.concat(_objectSpread2(_objectSpread2({name:name+TUPLE},init?{init:"{".concat(update,": ").concat(assembleInit(init),"}")}:{}),{},{on:[{events:[{signal:dataSignals.join(" || ")}],update:dataSignals.join(" && ")+" ? {".concat(update,": [").concat(dataSignals,"]} : null")}]}))},modifyExpr:function modifyExpr(model,selCmpt){var tpl=selCmpt.name+TUPLE;return tpl+", "+(selCmpt.resolve==="global"?"true":"{unit: ".concat(unitName(model),"}"))},marks:function marks(model,selCmpt,_marks){var name=selCmpt.name;var _selCmpt$project$hasC=selCmpt.project.hasChannel,x=_selCmpt$project$hasC.x,y=_selCmpt$project$hasC.y;var xvname=x&&x.signals.visual;var yvname=y&&y.signals.visual;var store="data(".concat($(selCmpt.name+STORE),")");if(scaleBindings.has(selCmpt)){return _marks}var update={x:x!==undefined?{signal:"".concat(xvname,"[0]")}:{value:0},y:y!==undefined?{signal:"".concat(yvname,"[0]")}:{value:0},x2:x!==undefined?{signal:"".concat(xvname,"[1]")}:{field:{group:"width"}},y2:y!==undefined?{signal:"".concat(yvname,"[1]")}:{field:{group:"height"}}};if(selCmpt.resolve==="global"){var _iterator=_createForOfIteratorHelper(keys(update)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var key=_step.value;update[key]=[_objectSpread2({test:"".concat(store,".length && ").concat(store,"[0].unit === ").concat(unitName(model))},update[key]),{value:0}]}}catch(err){_iterator.e(err)}finally{_iterator.f()}}var _selCmpt$mark=selCmpt.mark,fill=_selCmpt$mark.fill,fillOpacity=_selCmpt$mark.fillOpacity,cursor=_selCmpt$mark.cursor,stroke=_objectWithoutProperties(_selCmpt$mark,["fill","fillOpacity","cursor"]);var vgStroke=keys(stroke).reduce((function(def,k){def[k]=[{test:[x!==undefined&&"".concat(xvname,"[0] !== ").concat(xvname,"[1]"),y!==undefined&&"".concat(yvname,"[0] !== ").concat(yvname,"[1]")].filter((function(t){return t})).join(" && "),value:stroke[k]},{value:null}];return def}),{});return[{name:name+BRUSH+"_bg",type:"rect",clip:true,encode:{enter:{fill:{value:fill},fillOpacity:{value:fillOpacity}},update:update}}].concat(_toConsumableArray(_marks),[{name:name+BRUSH,type:"rect",clip:true,encode:{enter:_objectSpread2(_objectSpread2({},cursor?{cursor:{value:cursor}}:{}),{},{fill:{value:"transparent"}}),update:_objectSpread2(_objectSpread2({},update),vgStroke)}}])}};function channelSignals(model,selCmpt,proj,init){var channel=proj.channel;var vname=proj.signals.visual;var dname=proj.signals.data;var hasScales=scaleBindings.has(selCmpt);var scaleName=$(model.scaleName(channel));var scale=model.getScaleComponent(channel);var scaleType=scale?scale.get("type"):undefined;var scaled=function scaled(str){return"scale(".concat(scaleName,", ").concat(str,")")};var size=model.getSizeSignalRef(channel===X?"width":"height").signal;var coord="".concat(channel,"(unit)");var on=events(selCmpt,(function(def,evt){return[].concat(_toConsumableArray(def),[{events:evt.between[0],update:"[".concat(coord,", ").concat(coord,"]")},{events:evt,update:"[".concat(vname,"[0], clamp(").concat(coord,", 0, ").concat(size,")]")}])}));on.push({events:{signal:selCmpt.name+SCALE_TRIGGER},update:hasContinuousDomain(scaleType)?"[".concat(scaled("".concat(dname,"[0]")),", ").concat(scaled("".concat(dname,"[1]")),"]"):"[0, 0]"});return hasScales?[{name:dname,on:[]}]:[_objectSpread2(_objectSpread2({name:vname},init?{init:assembleInit(init,true,scaled)}:{value:[]}),{},{on:on}),_objectSpread2(_objectSpread2({name:dname},init?{init:assembleInit(init)}:{}),{},{on:[{events:{signal:vname},update:"".concat(vname,"[0] === ").concat(vname,"[1] ? null : invert(").concat(scaleName,", ").concat(vname,")")}]})]}function events(selCmpt,cb){return selCmpt.events.reduce((function(on,evt){if(!evt.between){warn("".concat(evt," is not an ordered event stream for interval selections."));return on}return cb(on,evt)}),[])}function singleOrMultiSignals(model,selCmpt){var name=selCmpt.name;var fieldsSg=name+TUPLE_FIELDS;var project=selCmpt.project;var datum="(item().isVoronoi ? datum.datum : datum)";var values=project.items.map((function(p){var fieldDef=model.fieldDef(p.channel);return fieldDef&&fieldDef.bin?"[".concat(datum,"[").concat($(model.vgField(p.channel,{})),"], ")+"".concat(datum,"[").concat($(model.vgField(p.channel,{binSuffix:"end"})),"]]"):"".concat(datum,"[").concat($(p.field),"]")})).join(", ");var update="unit: ".concat(unitName(model),", fields: ").concat(fieldsSg,", values");var events=selCmpt.events;return[{name:name+TUPLE,on:events?[{events:events,update:"datum && item().mark.marktype !== 'group' ? {".concat(update,": [").concat(values,"]} : null"),force:true}]:[]}]}var multi={signals:singleOrMultiSignals,modifyExpr:function modifyExpr(model,selCmpt){var tpl=selCmpt.name+TUPLE;return tpl+", "+(selCmpt.resolve==="global"?"null":"{unit: ".concat(unitName(model),"}"))}};var single={signals:singleOrMultiSignals,modifyExpr:function modifyExpr(model,selCmpt){var tpl=selCmpt.name+TUPLE;return tpl+", "+(selCmpt.resolve==="global"?"true":"{unit: ".concat(unitName(model),"}"))}};var STORE="_store";var TUPLE="_tuple";var MODIFY="_modify";var VL_SELECTION_RESOLVE="vlSelectionResolve";var compilers$1={single:single,multi:multi,interval:interval};function forEachSelection(model,cb){var selections=model.component.selection;if(selections){var _iterator=_createForOfIteratorHelper(vals(selections)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var sel=_step.value;var success=cb(sel,compilers$1[sel.type]);if(success===true)break}}catch(err){_iterator.e(err)}finally{_iterator.f()}}}function getFacetModel(model){var parent=model.parent;while(parent){if(isFacetModel(parent)){break}parent=parent.parent}return parent}function unitName(model){var _ref=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{escape:true},escape=_ref.escape;var name=escape?$(model.name):model.name;var facetModel=getFacetModel(model);if(facetModel){var facet=facetModel.facet;var _iterator2=_createForOfIteratorHelper(FACET_CHANNELS),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var channel=_step2.value;if(facet[channel]){name+=" + '__facet_".concat(channel,"_' + (facet[").concat($(facetModel.vgField(channel)),"])")}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}return name}function requiresSelectionId(model){var identifier=false;forEachSelection(model,(function(selCmpt){identifier=identifier||selCmpt.project.items.some((function(proj){return proj.field===SELECTION_ID}))}));return identifier}var RawCode="RawCode";var Literal="Literal";var Property="Property";var Identifier="Identifier";var ArrayExpression="ArrayExpression";var BinaryExpression="BinaryExpression";var CallExpression="CallExpression";var ConditionalExpression="ConditionalExpression";var LogicalExpression="LogicalExpression";var MemberExpression="MemberExpression";var ObjectExpression="ObjectExpression";var UnaryExpression="UnaryExpression";function ASTNode(type){this.type=type}ASTNode.prototype.visit=function(visitor){var c,i,n;if(visitor(this))return 1;for(c=children(this),i=0,n=c.length;i<n;++i){if(c[i].visit(visitor))return 1}};function children(node){switch(node.type){case ArrayExpression:return node.elements;case BinaryExpression:case LogicalExpression:return[node.left,node.right];case CallExpression:return[node.callee].concat(node.arguments);case ConditionalExpression:return[node.test,node.consequent,node.alternate];case MemberExpression:return[node.object,node.property];case ObjectExpression:return node.properties;case Property:return[node.key,node.value];case UnaryExpression:return[node.argument];case Identifier:case Literal:case RawCode:default:return[]}}var TokenName,source,index,length,lookahead;var TokenBooleanLiteral=1,TokenEOF=2,TokenIdentifier=3,TokenKeyword=4,TokenNullLiteral=5,TokenNumericLiteral=6,TokenPunctuator=7,TokenStringLiteral=8,TokenRegularExpression=9;TokenName={};TokenName[TokenBooleanLiteral]="Boolean";TokenName[TokenEOF]="<end>";TokenName[TokenIdentifier]="Identifier";TokenName[TokenKeyword]="Keyword";TokenName[TokenNullLiteral]="Null";TokenName[TokenNumericLiteral]="Numeric";TokenName[TokenPunctuator]="Punctuator";TokenName[TokenStringLiteral]="String";TokenName[TokenRegularExpression]="RegularExpression";var SyntaxArrayExpression="ArrayExpression",SyntaxBinaryExpression="BinaryExpression",SyntaxCallExpression="CallExpression",SyntaxConditionalExpression="ConditionalExpression",SyntaxIdentifier="Identifier",SyntaxLiteral="Literal",SyntaxLogicalExpression="LogicalExpression",SyntaxMemberExpression="MemberExpression",SyntaxObjectExpression="ObjectExpression",SyntaxProperty="Property",SyntaxUnaryExpression="UnaryExpression";var MessageUnexpectedToken="Unexpected token %0",MessageUnexpectedNumber="Unexpected number",MessageUnexpectedString="Unexpected string",MessageUnexpectedIdentifier="Unexpected identifier",MessageUnexpectedReserved="Unexpected reserved word",MessageUnexpectedEOS="Unexpected end of input",MessageInvalidRegExp="Invalid regular expression",MessageUnterminatedRegExp="Invalid regular expression: missing /",MessageStrictOctalLiteral="Octal literals are not allowed in strict mode.",MessageStrictDuplicateProperty="Duplicate data property in object literal not allowed in strict mode";var ILLEGAL$1="ILLEGAL",DISABLED="Disabled.";var RegexNonAsciiIdentifierStart=new RegExp("[\\xAA\\xB5\\xBA\\xC0-\\xD6\\xD8-\\xF6\\xF8-\\u02C1\\u02C6-\\u02D1\\u02E0-\\u02E4\\u02EC\\u02EE\\u0370-\\u0374\\u0376\\u0377\\u037A-\\u037D\\u037F\\u0386\\u0388-\\u038A\\u038C\\u038E-\\u03A1\\u03A3-\\u03F5\\u03F7-\\u0481\\u048A-\\u052F\\u0531-\\u0556\\u0559\\u0561-\\u0587\\u05D0-\\u05EA\\u05F0-\\u05F2\\u0620-\\u064A\\u066E\\u066F\\u0671-\\u06D3\\u06D5\\u06E5\\u06E6\\u06EE\\u06EF\\u06FA-\\u06FC\\u06FF\\u0710\\u0712-\\u072F\\u074D-\\u07A5\\u07B1\\u07CA-\\u07EA\\u07F4\\u07F5\\u07FA\\u0800-\\u0815\\u081A\\u0824\\u0828\\u0840-\\u0858\\u08A0-\\u08B2\\u0904-\\u0939\\u093D\\u0950\\u0958-\\u0961\\u0971-\\u0980\\u0985-\\u098C\\u098F\\u0990\\u0993-\\u09A8\\u09AA-\\u09B0\\u09B2\\u09B6-\\u09B9\\u09BD\\u09CE\\u09DC\\u09DD\\u09DF-\\u09E1\\u09F0\\u09F1\\u0A05-\\u0A0A\\u0A0F\\u0A10\\u0A13-\\u0A28\\u0A2A-\\u0A30\\u0A32\\u0A33\\u0A35\\u0A36\\u0A38\\u0A39\\u0A59-\\u0A5C\\u0A5E\\u0A72-\\u0A74\\u0A85-\\u0A8D\\u0A8F-\\u0A91\\u0A93-\\u0AA8\\u0AAA-\\u0AB0\\u0AB2\\u0AB3\\u0AB5-\\u0AB9\\u0ABD\\u0AD0\\u0AE0\\u0AE1\\u0B05-\\u0B0C\\u0B0F\\u0B10\\u0B13-\\u0B28\\u0B2A-\\u0B30\\u0B32\\u0B33\\u0B35-\\u0B39\\u0B3D\\u0B5C\\u0B5D\\u0B5F-\\u0B61\\u0B71\\u0B83\\u0B85-\\u0B8A\\u0B8E-\\u0B90\\u0B92-\\u0B95\\u0B99\\u0B9A\\u0B9C\\u0B9E\\u0B9F\\u0BA3\\u0BA4\\u0BA8-\\u0BAA\\u0BAE-\\u0BB9\\u0BD0\\u0C05-\\u0C0C\\u0C0E-\\u0C10\\u0C12-\\u0C28\\u0C2A-\\u0C39\\u0C3D\\u0C58\\u0C59\\u0C60\\u0C61\\u0C85-\\u0C8C\\u0C8E-\\u0C90\\u0C92-\\u0CA8\\u0CAA-\\u0CB3\\u0CB5-\\u0CB9\\u0CBD\\u0CDE\\u0CE0\\u0CE1\\u0CF1\\u0CF2\\u0D05-\\u0D0C\\u0D0E-\\u0D10\\u0D12-\\u0D3A\\u0D3D\\u0D4E\\u0D60\\u0D61\\u0D7A-\\u0D7F\\u0D85-\\u0D96\\u0D9A-\\u0DB1\\u0DB3-\\u0DBB\\u0DBD\\u0DC0-\\u0DC6\\u0E01-\\u0E30\\u0E32\\u0E33\\u0E40-\\u0E46\\u0E81\\u0E82\\u0E84\\u0E87\\u0E88\\u0E8A\\u0E8D\\u0E94-\\u0E97\\u0E99-\\u0E9F\\u0EA1-\\u0EA3\\u0EA5\\u0EA7\\u0EAA\\u0EAB\\u0EAD-\\u0EB0\\u0EB2\\u0EB3\\u0EBD\\u0EC0-\\u0EC4\\u0EC6\\u0EDC-\\u0EDF\\u0F00\\u0F40-\\u0F47\\u0F49-\\u0F6C\\u0F88-\\u0F8C\\u1000-\\u102A\\u103F\\u1050-\\u1055\\u105A-\\u105D\\u1061\\u1065\\u1066\\u106E-\\u1070\\u1075-\\u1081\\u108E\\u10A0-\\u10C5\\u10C7\\u10CD\\u10D0-\\u10FA\\u10FC-\\u1248\\u124A-\\u124D\\u1250-\\u1256\\u1258\\u125A-\\u125D\\u1260-\\u1288\\u128A-\\u128D\\u1290-\\u12B0\\u12B2-\\u12B5\\u12B8-\\u12BE\\u12C0\\u12C2-\\u12C5\\u12C8-\\u12D6\\u12D8-\\u1310\\u1312-\\u1315\\u1318-\\u135A\\u1380-\\u138F\\u13A0-\\u13F4\\u1401-\\u166C\\u166F-\\u167F\\u1681-\\u169A\\u16A0-\\u16EA\\u16EE-\\u16F8\\u1700-\\u170C\\u170E-\\u1711\\u1720-\\u1731\\u1740-\\u1751\\u1760-\\u176C\\u176E-\\u1770\\u1780-\\u17B3\\u17D7\\u17DC\\u1820-\\u1877\\u1880-\\u18A8\\u18AA\\u18B0-\\u18F5\\u1900-\\u191E\\u1950-\\u196D\\u1970-\\u1974\\u1980-\\u19AB\\u19C1-\\u19C7\\u1A00-\\u1A16\\u1A20-\\u1A54\\u1AA7\\u1B05-\\u1B33\\u1B45-\\u1B4B\\u1B83-\\u1BA0\\u1BAE\\u1BAF\\u1BBA-\\u1BE5\\u1C00-\\u1C23\\u1C4D-\\u1C4F\\u1C5A-\\u1C7D\\u1CE9-\\u1CEC\\u1CEE-\\u1CF1\\u1CF5\\u1CF6\\u1D00-\\u1DBF\\u1E00-\\u1F15\\u1F18-\\u1F1D\\u1F20-\\u1F45\\u1F48-\\u1F4D\\u1F50-\\u1F57\\u1F59\\u1F5B\\u1F5D\\u1F5F-\\u1F7D\\u1F80-\\u1FB4\\u1FB6-\\u1FBC\\u1FBE\\u1FC2-\\u1FC4\\u1FC6-\\u1FCC\\u1FD0-\\u1FD3\\u1FD6-\\u1FDB\\u1FE0-\\u1FEC\\u1FF2-\\u1FF4\\u1FF6-\\u1FFC\\u2071\\u207F\\u2090-\\u209C\\u2102\\u2107\\u210A-\\u2113\\u2115\\u2119-\\u211D\\u2124\\u2126\\u2128\\u212A-\\u212D\\u212F-\\u2139\\u213C-\\u213F\\u2145-\\u2149\\u214E\\u2160-\\u2188\\u2C00-\\u2C2E\\u2C30-\\u2C5E\\u2C60-\\u2CE4\\u2CEB-\\u2CEE\\u2CF2\\u2CF3\\u2D00-\\u2D25\\u2D27\\u2D2D\\u2D30-\\u2D67\\u2D6F\\u2D80-\\u2D96\\u2DA0-\\u2DA6\\u2DA8-\\u2DAE\\u2DB0-\\u2DB6\\u2DB8-\\u2DBE\\u2DC0-\\u2DC6\\u2DC8-\\u2DCE\\u2DD0-\\u2DD6\\u2DD8-\\u2DDE\\u2E2F\\u3005-\\u3007\\u3021-\\u3029\\u3031-\\u3035\\u3038-\\u303C\\u3041-\\u3096\\u309D-\\u309F\\u30A1-\\u30FA\\u30FC-\\u30FF\\u3105-\\u312D\\u3131-\\u318E\\u31A0-\\u31BA\\u31F0-\\u31FF\\u3400-\\u4DB5\\u4E00-\\u9FCC\\uA000-\\uA48C\\uA4D0-\\uA4FD\\uA500-\\uA60C\\uA610-\\uA61F\\uA62A\\uA62B\\uA640-\\uA66E\\uA67F-\\uA69D\\uA6A0-\\uA6EF\\uA717-\\uA71F\\uA722-\\uA788\\uA78B-\\uA78E\\uA790-\\uA7AD\\uA7B0\\uA7B1\\uA7F7-\\uA801\\uA803-\\uA805\\uA807-\\uA80A\\uA80C-\\uA822\\uA840-\\uA873\\uA882-\\uA8B3\\uA8F2-\\uA8F7\\uA8FB\\uA90A-\\uA925\\uA930-\\uA946\\uA960-\\uA97C\\uA984-\\uA9B2\\uA9CF\\uA9E0-\\uA9E4\\uA9E6-\\uA9EF\\uA9FA-\\uA9FE\\uAA00-\\uAA28\\uAA40-\\uAA42\\uAA44-\\uAA4B\\uAA60-\\uAA76\\uAA7A\\uAA7E-\\uAAAF\\uAAB1\\uAAB5\\uAAB6\\uAAB9-\\uAABD\\uAAC0\\uAAC2\\uAADB-\\uAADD\\uAAE0-\\uAAEA\\uAAF2-\\uAAF4\\uAB01-\\uAB06\\uAB09-\\uAB0E\\uAB11-\\uAB16\\uAB20-\\uAB26\\uAB28-\\uAB2E\\uAB30-\\uAB5A\\uAB5C-\\uAB5F\\uAB64\\uAB65\\uABC0-\\uABE2\\uAC00-\\uD7A3\\uD7B0-\\uD7C6\\uD7CB-\\uD7FB\\uF900-\\uFA6D\\uFA70-\\uFAD9\\uFB00-\\uFB06\\uFB13-\\uFB17\\uFB1D\\uFB1F-\\uFB28\\uFB2A-\\uFB36\\uFB38-\\uFB3C\\uFB3E\\uFB40\\uFB41\\uFB43\\uFB44\\uFB46-\\uFBB1\\uFBD3-\\uFD3D\\uFD50-\\uFD8F\\uFD92-\\uFDC7\\uFDF0-\\uFDFB\\uFE70-\\uFE74\\uFE76-\\uFEFC\\uFF21-\\uFF3A\\uFF41-\\uFF5A\\uFF66-\\uFFBE\\uFFC2-\\uFFC7\\uFFCA-\\uFFCF\\uFFD2-\\uFFD7\\uFFDA-\\uFFDC]"),RegexNonAsciiIdentifierPart=new RegExp("[\\xAA\\xB5\\xBA\\xC0-\\xD6\\xD8-\\xF6\\xF8-\\u02C1\\u02C6-\\u02D1\\u02E0-\\u02E4\\u02EC\\u02EE\\u0300-\\u0374\\u0376\\u0377\\u037A-\\u037D\\u037F\\u0386\\u0388-\\u038A\\u038C\\u038E-\\u03A1\\u03A3-\\u03F5\\u03F7-\\u0481\\u0483-\\u0487\\u048A-\\u052F\\u0531-\\u0556\\u0559\\u0561-\\u0587\\u0591-\\u05BD\\u05BF\\u05C1\\u05C2\\u05C4\\u05C5\\u05C7\\u05D0-\\u05EA\\u05F0-\\u05F2\\u0610-\\u061A\\u0620-\\u0669\\u066E-\\u06D3\\u06D5-\\u06DC\\u06DF-\\u06E8\\u06EA-\\u06FC\\u06FF\\u0710-\\u074A\\u074D-\\u07B1\\u07C0-\\u07F5\\u07FA\\u0800-\\u082D\\u0840-\\u085B\\u08A0-\\u08B2\\u08E4-\\u0963\\u0966-\\u096F\\u0971-\\u0983\\u0985-\\u098C\\u098F\\u0990\\u0993-\\u09A8\\u09AA-\\u09B0\\u09B2\\u09B6-\\u09B9\\u09BC-\\u09C4\\u09C7\\u09C8\\u09CB-\\u09CE\\u09D7\\u09DC\\u09DD\\u09DF-\\u09E3\\u09E6-\\u09F1\\u0A01-\\u0A03\\u0A05-\\u0A0A\\u0A0F\\u0A10\\u0A13-\\u0A28\\u0A2A-\\u0A30\\u0A32\\u0A33\\u0A35\\u0A36\\u0A38\\u0A39\\u0A3C\\u0A3E-\\u0A42\\u0A47\\u0A48\\u0A4B-\\u0A4D\\u0A51\\u0A59-\\u0A5C\\u0A5E\\u0A66-\\u0A75\\u0A81-\\u0A83\\u0A85-\\u0A8D\\u0A8F-\\u0A91\\u0A93-\\u0AA8\\u0AAA-\\u0AB0\\u0AB2\\u0AB3\\u0AB5-\\u0AB9\\u0ABC-\\u0AC5\\u0AC7-\\u0AC9\\u0ACB-\\u0ACD\\u0AD0\\u0AE0-\\u0AE3\\u0AE6-\\u0AEF\\u0B01-\\u0B03\\u0B05-\\u0B0C\\u0B0F\\u0B10\\u0B13-\\u0B28\\u0B2A-\\u0B30\\u0B32\\u0B33\\u0B35-\\u0B39\\u0B3C-\\u0B44\\u0B47\\u0B48\\u0B4B-\\u0B4D\\u0B56\\u0B57\\u0B5C\\u0B5D\\u0B5F-\\u0B63\\u0B66-\\u0B6F\\u0B71\\u0B82\\u0B83\\u0B85-\\u0B8A\\u0B8E-\\u0B90\\u0B92-\\u0B95\\u0B99\\u0B9A\\u0B9C\\u0B9E\\u0B9F\\u0BA3\\u0BA4\\u0BA8-\\u0BAA\\u0BAE-\\u0BB9\\u0BBE-\\u0BC2\\u0BC6-\\u0BC8\\u0BCA-\\u0BCD\\u0BD0\\u0BD7\\u0BE6-\\u0BEF\\u0C00-\\u0C03\\u0C05-\\u0C0C\\u0C0E-\\u0C10\\u0C12-\\u0C28\\u0C2A-\\u0C39\\u0C3D-\\u0C44\\u0C46-\\u0C48\\u0C4A-\\u0C4D\\u0C55\\u0C56\\u0C58\\u0C59\\u0C60-\\u0C63\\u0C66-\\u0C6F\\u0C81-\\u0C83\\u0C85-\\u0C8C\\u0C8E-\\u0C90\\u0C92-\\u0CA8\\u0CAA-\\u0CB3\\u0CB5-\\u0CB9\\u0CBC-\\u0CC4\\u0CC6-\\u0CC8\\u0CCA-\\u0CCD\\u0CD5\\u0CD6\\u0CDE\\u0CE0-\\u0CE3\\u0CE6-\\u0CEF\\u0CF1\\u0CF2\\u0D01-\\u0D03\\u0D05-\\u0D0C\\u0D0E-\\u0D10\\u0D12-\\u0D3A\\u0D3D-\\u0D44\\u0D46-\\u0D48\\u0D4A-\\u0D4E\\u0D57\\u0D60-\\u0D63\\u0D66-\\u0D6F\\u0D7A-\\u0D7F\\u0D82\\u0D83\\u0D85-\\u0D96\\u0D9A-\\u0DB1\\u0DB3-\\u0DBB\\u0DBD\\u0DC0-\\u0DC6\\u0DCA\\u0DCF-\\u0DD4\\u0DD6\\u0DD8-\\u0DDF\\u0DE6-\\u0DEF\\u0DF2\\u0DF3\\u0E01-\\u0E3A\\u0E40-\\u0E4E\\u0E50-\\u0E59\\u0E81\\u0E82\\u0E84\\u0E87\\u0E88\\u0E8A\\u0E8D\\u0E94-\\u0E97\\u0E99-\\u0E9F\\u0EA1-\\u0EA3\\u0EA5\\u0EA7\\u0EAA\\u0EAB\\u0EAD-\\u0EB9\\u0EBB-\\u0EBD\\u0EC0-\\u0EC4\\u0EC6\\u0EC8-\\u0ECD\\u0ED0-\\u0ED9\\u0EDC-\\u0EDF\\u0F00\\u0F18\\u0F19\\u0F20-\\u0F29\\u0F35\\u0F37\\u0F39\\u0F3E-\\u0F47\\u0F49-\\u0F6C\\u0F71-\\u0F84\\u0F86-\\u0F97\\u0F99-\\u0FBC\\u0FC6\\u1000-\\u1049\\u1050-\\u109D\\u10A0-\\u10C5\\u10C7\\u10CD\\u10D0-\\u10FA\\u10FC-\\u1248\\u124A-\\u124D\\u1250-\\u1256\\u1258\\u125A-\\u125D\\u1260-\\u1288\\u128A-\\u128D\\u1290-\\u12B0\\u12B2-\\u12B5\\u12B8-\\u12BE\\u12C0\\u12C2-\\u12C5\\u12C8-\\u12D6\\u12D8-\\u1310\\u1312-\\u1315\\u1318-\\u135A\\u135D-\\u135F\\u1380-\\u138F\\u13A0-\\u13F4\\u1401-\\u166C\\u166F-\\u167F\\u1681-\\u169A\\u16A0-\\u16EA\\u16EE-\\u16F8\\u1700-\\u170C\\u170E-\\u1714\\u1720-\\u1734\\u1740-\\u1753\\u1760-\\u176C\\u176E-\\u1770\\u1772\\u1773\\u1780-\\u17D3\\u17D7\\u17DC\\u17DD\\u17E0-\\u17E9\\u180B-\\u180D\\u1810-\\u1819\\u1820-\\u1877\\u1880-\\u18AA\\u18B0-\\u18F5\\u1900-\\u191E\\u1920-\\u192B\\u1930-\\u193B\\u1946-\\u196D\\u1970-\\u1974\\u1980-\\u19AB\\u19B0-\\u19C9\\u19D0-\\u19D9\\u1A00-\\u1A1B\\u1A20-\\u1A5E\\u1A60-\\u1A7C\\u1A7F-\\u1A89\\u1A90-\\u1A99\\u1AA7\\u1AB0-\\u1ABD\\u1B00-\\u1B4B\\u1B50-\\u1B59\\u1B6B-\\u1B73\\u1B80-\\u1BF3\\u1C00-\\u1C37\\u1C40-\\u1C49\\u1C4D-\\u1C7D\\u1CD0-\\u1CD2\\u1CD4-\\u1CF6\\u1CF8\\u1CF9\\u1D00-\\u1DF5\\u1DFC-\\u1F15\\u1F18-\\u1F1D\\u1F20-\\u1F45\\u1F48-\\u1F4D\\u1F50-\\u1F57\\u1F59\\u1F5B\\u1F5D\\u1F5F-\\u1F7D\\u1F80-\\u1FB4\\u1FB6-\\u1FBC\\u1FBE\\u1FC2-\\u1FC4\\u1FC6-\\u1FCC\\u1FD0-\\u1FD3\\u1FD6-\\u1FDB\\u1FE0-\\u1FEC\\u1FF2-\\u1FF4\\u1FF6-\\u1FFC\\u200C\\u200D\\u203F\\u2040\\u2054\\u2071\\u207F\\u2090-\\u209C\\u20D0-\\u20DC\\u20E1\\u20E5-\\u20F0\\u2102\\u2107\\u210A-\\u2113\\u2115\\u2119-\\u211D\\u2124\\u2126\\u2128\\u212A-\\u212D\\u212F-\\u2139\\u213C-\\u213F\\u2145-\\u2149\\u214E\\u2160-\\u2188\\u2C00-\\u2C2E\\u2C30-\\u2C5E\\u2C60-\\u2CE4\\u2CEB-\\u2CF3\\u2D00-\\u2D25\\u2D27\\u2D2D\\u2D30-\\u2D67\\u2D6F\\u2D7F-\\u2D96\\u2DA0-\\u2DA6\\u2DA8-\\u2DAE\\u2DB0-\\u2DB6\\u2DB8-\\u2DBE\\u2DC0-\\u2DC6\\u2DC8-\\u2DCE\\u2DD0-\\u2DD6\\u2DD8-\\u2DDE\\u2DE0-\\u2DFF\\u2E2F\\u3005-\\u3007\\u3021-\\u302F\\u3031-\\u3035\\u3038-\\u303C\\u3041-\\u3096\\u3099\\u309A\\u309D-\\u309F\\u30A1-\\u30FA\\u30FC-\\u30FF\\u3105-\\u312D\\u3131-\\u318E\\u31A0-\\u31BA\\u31F0-\\u31FF\\u3400-\\u4DB5\\u4E00-\\u9FCC\\uA000-\\uA48C\\uA4D0-\\uA4FD\\uA500-\\uA60C\\uA610-\\uA62B\\uA640-\\uA66F\\uA674-\\uA67D\\uA67F-\\uA69D\\uA69F-\\uA6F1\\uA717-\\uA71F\\uA722-\\uA788\\uA78B-\\uA78E\\uA790-\\uA7AD\\uA7B0\\uA7B1\\uA7F7-\\uA827\\uA840-\\uA873\\uA880-\\uA8C4\\uA8D0-\\uA8D9\\uA8E0-\\uA8F7\\uA8FB\\uA900-\\uA92D\\uA930-\\uA953\\uA960-\\uA97C\\uA980-\\uA9C0\\uA9CF-\\uA9D9\\uA9E0-\\uA9FE\\uAA00-\\uAA36\\uAA40-\\uAA4D\\uAA50-\\uAA59\\uAA60-\\uAA76\\uAA7A-\\uAAC2\\uAADB-\\uAADD\\uAAE0-\\uAAEF\\uAAF2-\\uAAF6\\uAB01-\\uAB06\\uAB09-\\uAB0E\\uAB11-\\uAB16\\uAB20-\\uAB26\\uAB28-\\uAB2E\\uAB30-\\uAB5A\\uAB5C-\\uAB5F\\uAB64\\uAB65\\uABC0-\\uABEA\\uABEC\\uABED\\uABF0-\\uABF9\\uAC00-\\uD7A3\\uD7B0-\\uD7C6\\uD7CB-\\uD7FB\\uF900-\\uFA6D\\uFA70-\\uFAD9\\uFB00-\\uFB06\\uFB13-\\uFB17\\uFB1D-\\uFB28\\uFB2A-\\uFB36\\uFB38-\\uFB3C\\uFB3E\\uFB40\\uFB41\\uFB43\\uFB44\\uFB46-\\uFBB1\\uFBD3-\\uFD3D\\uFD50-\\uFD8F\\uFD92-\\uFDC7\\uFDF0-\\uFDFB\\uFE00-\\uFE0F\\uFE20-\\uFE2D\\uFE33\\uFE34\\uFE4D-\\uFE4F\\uFE70-\\uFE74\\uFE76-\\uFEFC\\uFF10-\\uFF19\\uFF21-\\uFF3A\\uFF3F\\uFF41-\\uFF5A\\uFF66-\\uFFBE\\uFFC2-\\uFFC7\\uFFCA-\\uFFCF\\uFFD2-\\uFFD7\\uFFDA-\\uFFDC]");function assert(condition,message){if(!condition){throw new Error("ASSERT: "+message)}}function isDecimalDigit(ch){return ch>=48&&ch<=57}function isHexDigit(ch){return"0123456789abcdefABCDEF".indexOf(ch)>=0}function isOctalDigit(ch){return"01234567".indexOf(ch)>=0}function isWhiteSpace(ch){return ch===32||ch===9||ch===11||ch===12||ch===160||ch>=5760&&[5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279].indexOf(ch)>=0}function isLineTerminator(ch){return ch===10||ch===13||ch===8232||ch===8233}function isIdentifierStart(ch){return ch===36||ch===95||ch>=65&&ch<=90||ch>=97&&ch<=122||ch===92||ch>=128&&RegexNonAsciiIdentifierStart.test(String.fromCharCode(ch))}function isIdentifierPart(ch){return ch===36||ch===95||ch>=65&&ch<=90||ch>=97&&ch<=122||ch>=48&&ch<=57||ch===92||ch>=128&&RegexNonAsciiIdentifierPart.test(String.fromCharCode(ch))}var keywords={if:1,in:1,do:1,var:1,for:1,new:1,try:1,let:1,this:1,else:1,case:1,void:1,with:1,enum:1,while:1,break:1,catch:1,throw:1,const:1,yield:1,class:1,super:1,return:1,typeof:1,delete:1,switch:1,export:1,import:1,public:1,static:1,default:1,finally:1,extends:1,package:1,private:1,function:1,continue:1,debugger:1,interface:1,protected:1,instanceof:1,implements:1};function skipComment(){while(index<length){var ch=source.charCodeAt(index);if(isWhiteSpace(ch)||isLineTerminator(ch)){++index}else{break}}}function scanHexEscape(prefix){var i,len,ch,code=0;len=prefix==="u"?4:2;for(i=0;i<len;++i){if(index<length&&isHexDigit(source[index])){ch=source[index++];code=code*16+"0123456789abcdef".indexOf(ch.toLowerCase())}else{throwError({},MessageUnexpectedToken,ILLEGAL$1)}}return String.fromCharCode(code)}function scanUnicodeCodePointEscape(){var ch,code,cu1,cu2;ch=source[index];code=0;if(ch==="}"){throwError({},MessageUnexpectedToken,ILLEGAL$1)}while(index<length){ch=source[index++];if(!isHexDigit(ch)){break}code=code*16+"0123456789abcdef".indexOf(ch.toLowerCase())}if(code>1114111||ch!=="}"){throwError({},MessageUnexpectedToken,ILLEGAL$1)}if(code<=65535){return String.fromCharCode(code)}cu1=(code-65536>>10)+55296;cu2=(code-65536&1023)+56320;return String.fromCharCode(cu1,cu2)}function getEscapedIdentifier(){var ch,id;ch=source.charCodeAt(index++);id=String.fromCharCode(ch);if(ch===92){if(source.charCodeAt(index)!==117){throwError({},MessageUnexpectedToken,ILLEGAL$1)}++index;ch=scanHexEscape("u");if(!ch||ch==="\\"||!isIdentifierStart(ch.charCodeAt(0))){throwError({},MessageUnexpectedToken,ILLEGAL$1)}id=ch}while(index<length){ch=source.charCodeAt(index);if(!isIdentifierPart(ch)){break}++index;id+=String.fromCharCode(ch);if(ch===92){id=id.substr(0,id.length-1);if(source.charCodeAt(index)!==117){throwError({},MessageUnexpectedToken,ILLEGAL$1)}++index;ch=scanHexEscape("u");if(!ch||ch==="\\"||!isIdentifierPart(ch.charCodeAt(0))){throwError({},MessageUnexpectedToken,ILLEGAL$1)}id+=ch}}return id}function getIdentifier(){var start,ch;start=index++;while(index<length){ch=source.charCodeAt(index);if(ch===92){index=start;return getEscapedIdentifier()}if(isIdentifierPart(ch)){++index}else{break}}return source.slice(start,index)}function scanIdentifier(){var start,id,type;start=index;id=source.charCodeAt(index)===92?getEscapedIdentifier():getIdentifier();if(id.length===1){type=TokenIdentifier}else if(keywords.hasOwnProperty(id)){type=TokenKeyword}else if(id==="null"){type=TokenNullLiteral}else if(id==="true"||id==="false"){type=TokenBooleanLiteral}else{type=TokenIdentifier}return{type:type,value:id,start:start,end:index}}function scanPunctuator(){var start=index,code=source.charCodeAt(index),code2,ch1=source[index],ch2,ch3,ch4;switch(code){case 46:case 40:case 41:case 59:case 44:case 123:case 125:case 91:case 93:case 58:case 63:case 126:++index;return{type:TokenPunctuator,value:String.fromCharCode(code),start:start,end:index};default:code2=source.charCodeAt(index+1);if(code2===61){switch(code){case 43:case 45:case 47:case 60:case 62:case 94:case 124:case 37:case 38:case 42:index+=2;return{type:TokenPunctuator,value:String.fromCharCode(code)+String.fromCharCode(code2),start:start,end:index};case 33:case 61:index+=2;if(source.charCodeAt(index)===61){++index}return{type:TokenPunctuator,value:source.slice(start,index),start:start,end:index}}}}ch4=source.substr(index,4);if(ch4===">>>="){index+=4;return{type:TokenPunctuator,value:ch4,start:start,end:index}}ch3=ch4.substr(0,3);if(ch3===">>>"||ch3==="<<="||ch3===">>="){index+=3;return{type:TokenPunctuator,value:ch3,start:start,end:index}}ch2=ch3.substr(0,2);if(ch1===ch2[1]&&"+-<>&|".indexOf(ch1)>=0||ch2==="=>"){index+=2;return{type:TokenPunctuator,value:ch2,start:start,end:index}}if("<>=!+-*%&|^/".indexOf(ch1)>=0){++index;return{type:TokenPunctuator,value:ch1,start:start,end:index}}throwError({},MessageUnexpectedToken,ILLEGAL$1)}function scanHexLiteral(start){var number="";while(index<length){if(!isHexDigit(source[index])){break}number+=source[index++]}if(number.length===0){throwError({},MessageUnexpectedToken,ILLEGAL$1)}if(isIdentifierStart(source.charCodeAt(index))){throwError({},MessageUnexpectedToken,ILLEGAL$1)}return{type:TokenNumericLiteral,value:parseInt("0x"+number,16),start:start,end:index}}function scanOctalLiteral(start){var number="0"+source[index++];while(index<length){if(!isOctalDigit(source[index])){break}number+=source[index++]}if(isIdentifierStart(source.charCodeAt(index))||isDecimalDigit(source.charCodeAt(index))){throwError({},MessageUnexpectedToken,ILLEGAL$1)}return{type:TokenNumericLiteral,value:parseInt(number,8),octal:true,start:start,end:index}}function scanNumericLiteral(){var number,start,ch;ch=source[index];assert(isDecimalDigit(ch.charCodeAt(0))||ch===".","Numeric literal must start with a decimal digit or a decimal point");start=index;number="";if(ch!=="."){number=source[index++];ch=source[index];if(number==="0"){if(ch==="x"||ch==="X"){++index;return scanHexLiteral(start)}if(isOctalDigit(ch)){return scanOctalLiteral(start)}if(ch&&isDecimalDigit(ch.charCodeAt(0))){throwError({},MessageUnexpectedToken,ILLEGAL$1)}}while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++]}ch=source[index]}if(ch==="."){number+=source[index++];while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++]}ch=source[index]}if(ch==="e"||ch==="E"){number+=source[index++];ch=source[index];if(ch==="+"||ch==="-"){number+=source[index++]}if(isDecimalDigit(source.charCodeAt(index))){while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++]}}else{throwError({},MessageUnexpectedToken,ILLEGAL$1)}}if(isIdentifierStart(source.charCodeAt(index))){throwError({},MessageUnexpectedToken,ILLEGAL$1)}return{type:TokenNumericLiteral,value:parseFloat(number),start:start,end:index}}function scanStringLiteral(){var str="",quote,start,ch,code,octal=false;quote=source[index];assert(quote==="'"||quote==='"',"String literal must starts with a quote");start=index;++index;while(index<length){ch=source[index++];if(ch===quote){quote="";break}else if(ch==="\\"){ch=source[index++];if(!ch||!isLineTerminator(ch.charCodeAt(0))){switch(ch){case"u":case"x":if(source[index]==="{"){++index;str+=scanUnicodeCodePointEscape()}else{str+=scanHexEscape(ch)}break;case"n":str+="\n";break;case"r":str+="\r";break;case"t":str+="\t";break;case"b":str+="\b";break;case"f":str+="\f";break;case"v":str+="\v";break;default:if(isOctalDigit(ch)){code="01234567".indexOf(ch);if(code!==0){octal=true}if(index<length&&isOctalDigit(source[index])){octal=true;code=code*8+"01234567".indexOf(source[index++]);if("0123".indexOf(ch)>=0&&index<length&&isOctalDigit(source[index])){code=code*8+"01234567".indexOf(source[index++])}}str+=String.fromCharCode(code)}else{str+=ch}break}}else{if(ch==="\r"&&source[index]==="\n"){++index}}}else if(isLineTerminator(ch.charCodeAt(0))){break}else{str+=ch}}if(quote!==""){throwError({},MessageUnexpectedToken,ILLEGAL$1)}return{type:TokenStringLiteral,value:str,octal:octal,start:start,end:index}}function testRegExp(pattern,flags){var tmp=pattern;if(flags.indexOf("u")>=0){tmp=tmp.replace(/\\u\{([0-9a-fA-F]+)\}/g,(function($0,$1){if(parseInt($1,16)<=1114111){return"x"}throwError({},MessageInvalidRegExp)})).replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"x")}try{new RegExp(tmp)}catch(e){throwError({},MessageInvalidRegExp)}try{return new RegExp(pattern,flags)}catch(exception){return null}}function scanRegExpBody(){var ch,str,classMarker,terminated,body;ch=source[index];assert(ch==="/","Regular expression literal must start with a slash");str=source[index++];classMarker=false;terminated=false;while(index<length){ch=source[index++];str+=ch;if(ch==="\\"){ch=source[index++];if(isLineTerminator(ch.charCodeAt(0))){throwError({},MessageUnterminatedRegExp)}str+=ch}else if(isLineTerminator(ch.charCodeAt(0))){throwError({},MessageUnterminatedRegExp)}else if(classMarker){if(ch==="]"){classMarker=false}}else{if(ch==="/"){terminated=true;break}else if(ch==="["){classMarker=true}}}if(!terminated){throwError({},MessageUnterminatedRegExp)}body=str.substr(1,str.length-2);return{value:body,literal:str}}function scanRegExpFlags(){var ch,str,flags;str="";flags="";while(index<length){ch=source[index];if(!isIdentifierPart(ch.charCodeAt(0))){break}++index;if(ch==="\\"&&index<length){throwError({},MessageUnexpectedToken,ILLEGAL$1)}else{flags+=ch;str+=ch}}if(flags.search(/[^gimuy]/g)>=0){throwError({},MessageInvalidRegExp,flags)}return{value:flags,literal:str}}function scanRegExp(){var start,body,flags,value;lookahead=null;skipComment();start=index;body=scanRegExpBody();flags=scanRegExpFlags();value=testRegExp(body.value,flags.value);return{literal:body.literal+flags.literal,value:value,regex:{pattern:body.value,flags:flags.value},start:start,end:index}}function isIdentifierName(token){return token.type===TokenIdentifier||token.type===TokenKeyword||token.type===TokenBooleanLiteral||token.type===TokenNullLiteral}function advance(){skipComment();if(index>=length){return{type:TokenEOF,start:index,end:index}}var ch=source.charCodeAt(index);if(isIdentifierStart(ch)){return scanIdentifier()}if(ch===40||ch===41||ch===59){return scanPunctuator()}if(ch===39||ch===34){return scanStringLiteral()}if(ch===46){if(isDecimalDigit(source.charCodeAt(index+1))){return scanNumericLiteral()}return scanPunctuator()}if(isDecimalDigit(ch)){return scanNumericLiteral()}return scanPunctuator()}function lex(){var token=lookahead;index=token.end;lookahead=advance();index=token.end;return token}function peek(){var pos=index;lookahead=advance();index=pos}function finishArrayExpression(elements){var node=new ASTNode(SyntaxArrayExpression);node.elements=elements;return node}function finishBinaryExpression(operator,left,right){var node=new ASTNode(operator==="||"||operator==="&&"?SyntaxLogicalExpression:SyntaxBinaryExpression);node.operator=operator;node.left=left;node.right=right;return node}function finishCallExpression(callee,args){var node=new ASTNode(SyntaxCallExpression);node.callee=callee;node.arguments=args;return node}function finishConditionalExpression(test,consequent,alternate){var node=new ASTNode(SyntaxConditionalExpression);node.test=test;node.consequent=consequent;node.alternate=alternate;return node}function finishIdentifier(name){var node=new ASTNode(SyntaxIdentifier);node.name=name;return node}function finishLiteral(token){var node=new ASTNode(SyntaxLiteral);node.value=token.value;node.raw=source.slice(token.start,token.end);if(token.regex){if(node.raw==="//"){node.raw="/(?:)/"}node.regex=token.regex}return node}function finishMemberExpression(accessor,object,property){var node=new ASTNode(SyntaxMemberExpression);node.computed=accessor==="[";node.object=object;node.property=property;if(!node.computed)property.member=true;return node}function finishObjectExpression(properties){var node=new ASTNode(SyntaxObjectExpression);node.properties=properties;return node}function finishProperty(kind,key,value){var node=new ASTNode(SyntaxProperty);node.key=key;node.value=value;node.kind=kind;return node}function finishUnaryExpression(operator,argument){var node=new ASTNode(SyntaxUnaryExpression);node.operator=operator;node.argument=argument;node.prefix=true;return node}function throwError(token,messageFormat){var error,args=Array.prototype.slice.call(arguments,2),msg=messageFormat.replace(/%(\d)/g,(function(whole,index){assert(index<args.length,"Message reference must be in range");return args[index]}));error=new Error(msg);error.index=index;error.description=msg;throw error}function throwUnexpected(token){if(token.type===TokenEOF){throwError(token,MessageUnexpectedEOS)}if(token.type===TokenNumericLiteral){throwError(token,MessageUnexpectedNumber)}if(token.type===TokenStringLiteral){throwError(token,MessageUnexpectedString)}if(token.type===TokenIdentifier){throwError(token,MessageUnexpectedIdentifier)}if(token.type===TokenKeyword){throwError(token,MessageUnexpectedReserved)}throwError(token,MessageUnexpectedToken,token.value)}function expect(value){var token=lex();if(token.type!==TokenPunctuator||token.value!==value){throwUnexpected(token)}}function match(value){return lookahead.type===TokenPunctuator&&lookahead.value===value}function matchKeyword(keyword){return lookahead.type===TokenKeyword&&lookahead.value===keyword}function parseArrayInitialiser(){var elements=[];index=lookahead.start;expect("[");while(!match("]")){if(match(",")){lex();elements.push(null)}else{elements.push(parseConditionalExpression());if(!match("]")){expect(",")}}}lex();return finishArrayExpression(elements)}function parseObjectPropertyKey(){index=lookahead.start;var token=lex();if(token.type===TokenStringLiteral||token.type===TokenNumericLiteral){if(token.octal){throwError(token,MessageStrictOctalLiteral)}return finishLiteral(token)}return finishIdentifier(token.value)}function parseObjectProperty(){var token,key,id,value;index=lookahead.start;token=lookahead;if(token.type===TokenIdentifier){id=parseObjectPropertyKey();expect(":");value=parseConditionalExpression();return finishProperty("init",id,value)}if(token.type===TokenEOF||token.type===TokenPunctuator){throwUnexpected(token)}else{key=parseObjectPropertyKey();expect(":");value=parseConditionalExpression();return finishProperty("init",key,value)}}function parseObjectInitialiser(){var properties=[],property,name,key,map={},toString=String;index=lookahead.start;expect("{");while(!match("}")){property=parseObjectProperty();if(property.key.type===SyntaxIdentifier){name=property.key.name}else{name=toString(property.key.value)}key="$"+name;if(Object.prototype.hasOwnProperty.call(map,key)){throwError({},MessageStrictDuplicateProperty)}else{map[key]=true}properties.push(property);if(!match("}")){expect(",")}}expect("}");return finishObjectExpression(properties)}function parseGroupExpression(){expect("(");var expr=parseExpression();expect(")");return expr}var legalKeywords={if:1};function parsePrimaryExpression(){var type,token,expr;if(match("(")){return parseGroupExpression()}if(match("[")){return parseArrayInitialiser()}if(match("{")){return parseObjectInitialiser()}type=lookahead.type;index=lookahead.start;if(type===TokenIdentifier||legalKeywords[lookahead.value]){expr=finishIdentifier(lex().value)}else if(type===TokenStringLiteral||type===TokenNumericLiteral){if(lookahead.octal){throwError(lookahead,MessageStrictOctalLiteral)}expr=finishLiteral(lex())}else if(type===TokenKeyword){throw new Error(DISABLED)}else if(type===TokenBooleanLiteral){token=lex();token.value=token.value==="true";expr=finishLiteral(token)}else if(type===TokenNullLiteral){token=lex();token.value=null;expr=finishLiteral(token)}else if(match("/")||match("/=")){expr=finishLiteral(scanRegExp());peek()}else{throwUnexpected(lex())}return expr}function parseArguments(){var args=[];expect("(");if(!match(")")){while(index<length){args.push(parseConditionalExpression());if(match(")")){break}expect(",")}}expect(")");return args}function parseNonComputedProperty(){index=lookahead.start;var token=lex();if(!isIdentifierName(token)){throwUnexpected(token)}return finishIdentifier(token.value)}function parseNonComputedMember(){expect(".");return parseNonComputedProperty()}function parseComputedMember(){expect("[");var expr=parseExpression();expect("]");return expr}function parseLeftHandSideExpressionAllowCall(){var expr,args,property;expr=parsePrimaryExpression();for(;;){if(match(".")){property=parseNonComputedMember();expr=finishMemberExpression(".",expr,property)}else if(match("(")){args=parseArguments();expr=finishCallExpression(expr,args)}else if(match("[")){property=parseComputedMember();expr=finishMemberExpression("[",expr,property)}else{break}}return expr}function parsePostfixExpression(){var expr=parseLeftHandSideExpressionAllowCall();if(lookahead.type===TokenPunctuator){if(match("++")||match("--")){throw new Error(DISABLED)}}return expr}function parseUnaryExpression(){var token,expr;if(lookahead.type!==TokenPunctuator&&lookahead.type!==TokenKeyword){expr=parsePostfixExpression()}else if(match("++")||match("--")){throw new Error(DISABLED)}else if(match("+")||match("-")||match("~")||match("!")){token=lex();expr=parseUnaryExpression();expr=finishUnaryExpression(token.value,expr)}else if(matchKeyword("delete")||matchKeyword("void")||matchKeyword("typeof")){throw new Error(DISABLED)}else{expr=parsePostfixExpression()}return expr}function binaryPrecedence(token){var prec=0;if(token.type!==TokenPunctuator&&token.type!==TokenKeyword){return 0}switch(token.value){case"||":prec=1;break;case"&&":prec=2;break;case"|":prec=3;break;case"^":prec=4;break;case"&":prec=5;break;case"==":case"!=":case"===":case"!==":prec=6;break;case"<":case">":case"<=":case">=":case"instanceof":case"in":prec=7;break;case"<<":case">>":case">>>":prec=8;break;case"+":case"-":prec=9;break;case"*":case"/":case"%":prec=11;break}return prec}function parseBinaryExpression(){var marker,markers,expr,token,prec,stack,right,operator,left,i;marker=lookahead;left=parseUnaryExpression();token=lookahead;prec=binaryPrecedence(token);if(prec===0){return left}token.prec=prec;lex();markers=[marker,lookahead];right=parseUnaryExpression();stack=[left,token,right];while((prec=binaryPrecedence(lookahead))>0){while(stack.length>2&&prec<=stack[stack.length-2].prec){right=stack.pop();operator=stack.pop().value;left=stack.pop();markers.pop();expr=finishBinaryExpression(operator,left,right);stack.push(expr)}token=lex();token.prec=prec;stack.push(token);markers.push(lookahead);expr=parseUnaryExpression();stack.push(expr)}i=stack.length-1;expr=stack[i];markers.pop();while(i>1){markers.pop();expr=finishBinaryExpression(stack[i-1].value,stack[i-2],expr);i-=2}return expr}function parseConditionalExpression(){var expr,consequent,alternate;expr=parseBinaryExpression();if(match("?")){lex();consequent=parseConditionalExpression();expect(":");alternate=parseConditionalExpression();expr=finishConditionalExpression(expr,consequent,alternate)}return expr}function parseExpression(){var expr=parseConditionalExpression();if(match(",")){throw new Error(DISABLED)}return expr}function parser(code){source=code;index=0;length=source.length;lookahead=null;peek();var expr=parseExpression();if(lookahead.type!==TokenEOF){throw new Error("Unexpect token after expression.")}return expr}function getName(node){var name=[];if(node.type==="Identifier"){return[node.name]}if(node.type==="Literal"){return[node.value]}if(node.type==="MemberExpression"){name.push.apply(name,_toConsumableArray(getName(node.object)));name.push.apply(name,_toConsumableArray(getName(node.property)))}return name}function startsWithDatum(node){if(node.object.type==="MemberExpression"){return startsWithDatum(node.object)}return node.object.name==="datum"}function getDependentFields(expression){var ast=parser(expression);var dependents=new Set;ast.visit((function(node){if(node.type==="MemberExpression"&&startsWithDatum(node)){dependents.add(getName(node).slice(1).join("."))}}));return dependents}var FilterNode=function(_DataFlowNode){_inherits(FilterNode,_DataFlowNode);var _super=_createSuper(FilterNode);_createClass(FilterNode,[{key:"clone",value:function clone(){return new FilterNode(null,this.model,duplicate(this.filter))}}]);function FilterNode(parent,model,filter){var _this;_classCallCheck(this,FilterNode);_this=_super.call(this,parent);_this.model=model;_this.filter=filter;_defineProperty(_assertThisInitialized(_this),"expr",void 0);_defineProperty(_assertThisInitialized(_this),"_dependentFields",void 0);_this.expr=expression(_this.model,_this.filter,_assertThisInitialized(_this));_this._dependentFields=getDependentFields(_this.expr);return _this}_createClass(FilterNode,[{key:"dependentFields",value:function dependentFields(){return this._dependentFields}},{key:"producedFields",value:function producedFields(){return new Set}},{key:"assemble",value:function assemble(){return{type:"filter",expr:this.expr}}},{key:"hash",value:function hash(){return"Filter ".concat(this.expr)}}]);return FilterNode}(DataFlowNode);function parseUnitSelection(model,selDefs){var selCmpts={};var selectionConfig=model.config.selection;var _iterator=_createForOfIteratorHelper(keys(selDefs!==null&&selDefs!==void 0?selDefs:{})),_step;try{var _loop=function _loop(){var name=_step.value;var selDef=duplicate(selDefs[name]);var _selectionConfig$selD=selectionConfig[selDef.type],fields=_selectionConfig$selD.fields,encodings=_selectionConfig$selD.encodings,cfg=_objectWithoutProperties(_selectionConfig$selD,["fields","encodings"]);for(var key in cfg){if(key==="encodings"&&selDef.fields||key==="fields"&&selDef.encodings){continue}if(key==="mark"){selDef[key]=_objectSpread2(_objectSpread2({},cfg[key]),selDef[key])}if(selDef[key]===undefined||selDef[key]===true){var _cfg$key;selDef[key]=(_cfg$key=cfg[key])!==null&&_cfg$key!==void 0?_cfg$key:selDef[key]}}var safeName=varName(name);var selCmpt=selCmpts[safeName]=_objectSpread2(_objectSpread2({},selDef),{},{name:safeName,events:isString(selDef.on)?eventSelector(selDef.on,"scope"):duplicate(selDef.on)});forEachTransform(selCmpt,(function(txCompiler){if(txCompiler.has(selCmpt)&&txCompiler.parse){txCompiler.parse(model,selCmpt,selDef,selDefs[name])}}))};for(_iterator.s();!(_step=_iterator.n()).done;){_loop()}}catch(err){_iterator.e(err)}finally{_iterator.f()}return selCmpts}function parseSelectionPredicate(model,selections,dfnode){var datum=arguments.length>3&&arguments[3]!==undefined?arguments[3]:"datum";var stores=[];function expr(name){var vname=varName(name);var selCmpt=model.getSelectionComponent(vname,name);var store=$(vname+STORE);if(selCmpt.project.timeUnit){var child=dfnode!==null&&dfnode!==void 0?dfnode:model.component.data.raw;var tunode=selCmpt.project.timeUnit.clone();if(child.parent){tunode.insertAsParentOf(child)}else{child.parent=tunode}}if(selCmpt.empty!=="none"){stores.push(store)}return"vlSelectionTest(".concat(store,", ").concat(datum)+(selCmpt.resolve==="global"?")":", ".concat($(selCmpt.resolve),")"))}var predicateStr=logicalExpr(selections,expr);return(stores.length?"!("+stores.map((function(s){return"length(data(".concat(s,"))")})).join(" || ")+") || ":"")+"(".concat(predicateStr,")")}function parseSelectionBinExtent(selCmpt,extent){var encoding=extent["encoding"];var field=extent["field"];if(!encoding&&!field){field=selCmpt.project.items[0].field;if(selCmpt.project.items.length>1){warn('A "field" or "encoding" must be specified when using a selection as a scale domain. '+'Using "field": '.concat($(field),"."))}}else if(encoding&&!field){var encodings=selCmpt.project.items.filter((function(p){return p.channel===encoding}));if(!encodings.length||encodings.length>1){field=selCmpt.project.items[0].field;warn((!encodings.length?"No ":"Multiple ")+"matching ".concat($(encoding)," encoding found for selection ").concat($(extent.selection),". ")+'Using "field": '.concat($(field),"."))}else{field=encodings[0].field}}return"".concat(selCmpt.name,"[").concat($(field),"]")}function materializeSelections(model,main){forEachSelection(model,(function(selCmpt){var selection=selCmpt.name;var lookupName=model.getName("lookup_".concat(selection));model.component.data.outputNodes[lookupName]=selCmpt.materialized=new OutputNode(new FilterNode(main,model,{selection:selection}),lookupName,DataSourceType.Lookup,model.component.data.outputNodeRefCounts)}))}function expression(model,filterOp,node){return logicalExpr(filterOp,(function(predicate){if(isString(predicate)){return predicate}else if(isSelectionPredicate(predicate)){return parseSelectionPredicate(model,predicate.selection,node)}else{return fieldFilterExpression(predicate)}}))}function assembleTitle(title,config){if(!title){return undefined}if(isArray(title)&&!isText(title)){return title.map((function(fieldDef){return defaultTitle(fieldDef,config)})).join(", ")}return title}function setAxisEncode(axis,part,vgProp,vgRef){var _axis$encode,_axis$encode$part,_axis$encode$part$upd;axis.encode=(_axis$encode=axis.encode)!==null&&_axis$encode!==void 0?_axis$encode:{};axis.encode[part]=(_axis$encode$part=axis.encode[part])!==null&&_axis$encode$part!==void 0?_axis$encode$part:{};axis.encode[part].update=(_axis$encode$part$upd=axis.encode[part].update)!==null&&_axis$encode$part$upd!==void 0?_axis$encode$part$upd:{};axis.encode[part].update[vgProp]=vgRef}function assembleAxis(axisCmpt,kind,config){var opt=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{header:false};var _axisCmpt$combine=axisCmpt.combine(),disable=_axisCmpt$combine.disable,orient=_axisCmpt$combine.orient,scale=_axisCmpt$combine.scale,labelExpr=_axisCmpt$combine.labelExpr,title=_axisCmpt$combine.title,zindex=_axisCmpt$combine.zindex,axis=_objectWithoutProperties(_axisCmpt$combine,["disable","orient","scale","labelExpr","title","zindex"]);if(disable){return undefined}for(var prop in axis){var propType=AXIS_PROPERTY_TYPE[prop];var propValue=axis[prop];if(propType&&propType!==kind&&propType!=="both"){delete axis[prop]}else if(isConditionalAxisValue(propValue)){var condition=propValue.condition,valueOrSignalRef=_objectWithoutProperties(propValue,["condition"]);var conditions=array(condition);var propIndex=CONDITIONAL_AXIS_PROP_INDEX[prop];if(propIndex){var vgProp=propIndex.vgProp,part=propIndex.part;var vgRef=[].concat(_toConsumableArray(conditions.map((function(c){var test=c.test,valueOrSignalCRef=_objectWithoutProperties(c,["test"]);return _objectSpread2({test:expression(null,test)},valueOrSignalCRef)}))),[valueOrSignalRef]);setAxisEncode(axis,part,vgProp,vgRef);delete axis[prop]}else if(propIndex===null){var signalRef={signal:conditions.map((function(c){var test=c.test,valueOrSignalCRef=_objectWithoutProperties(c,["test"]);return"".concat(expression(null,test)," ? ").concat(exprFromValueOrSignalRef(valueOrSignalCRef)," : ")})).join("")+exprFromValueOrSignalRef(valueOrSignalRef)};axis[prop]=signalRef}}else if(isSignalRef(propValue)){var _propIndex=CONDITIONAL_AXIS_PROP_INDEX[prop];if(_propIndex){var _vgProp=_propIndex.vgProp,_part=_propIndex.part;setAxisEncode(axis,_part,_vgProp,propValue);delete axis[prop]}}}if(kind==="grid"){if(!axis.grid){return undefined}if(axis.encode){var grid=axis.encode.grid;axis.encode=_objectSpread2({},grid?{grid:grid}:{});if(isEmpty(axis.encode)){delete axis.encode}}return _objectSpread2(_objectSpread2({scale:scale,orient:orient},axis),{},{domain:false,labels:false,aria:false,maxExtent:0,minExtent:0,ticks:false,zindex:getFirstDefined(zindex,0)})}else{if(!opt.header&&axisCmpt.mainExtracted){return undefined}if(labelExpr!==undefined){var _axis$encode2,_axis$encode2$labels;var expr=labelExpr;if(((_axis$encode2=axis.encode)===null||_axis$encode2===void 0?void 0:(_axis$encode2$labels=_axis$encode2.labels)===null||_axis$encode2$labels===void 0?void 0:_axis$encode2$labels.update)&&isSignalRef(axis.encode.labels.update.text)){expr=replaceAll(labelExpr,"datum.label",axis.encode.labels.update.text.signal)}setAxisEncode(axis,"labels","text",{signal:expr})}if(axis.labelAlign===null){delete axis.labelAlign}if(axis.encode){var _iterator=_createForOfIteratorHelper(AXIS_PARTS),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var _part2=_step.value;if(!axisCmpt.hasAxisPart(_part2)){delete axis.encode[_part2]}}}catch(err){_iterator.e(err)}finally{_iterator.f()}if(isEmpty(axis.encode)){delete axis.encode}}var titleString=assembleTitle(title,config);return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({scale:scale,orient:orient,grid:false},titleString?{title:titleString}:{}),axis),config.aria===false?{aria:false}:{}),{},{zindex:getFirstDefined(zindex,0)})}}function assembleAxisSignals(model){var axes=model.component.axes;var signals=[];var _iterator2=_createForOfIteratorHelper(POSITION_SCALE_CHANNELS),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var channel=_step2.value;if(axes[channel]){var _iterator3=_createForOfIteratorHelper(axes[channel]),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var axis=_step3.value;if(!axis.get("disable")&&!axis.get("gridScale")){var sizeType=channel==="x"?"height":"width";var update=model.getSizeSignalRef(sizeType).signal;if(sizeType!==update){signals.push({name:sizeType,update:update})}}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return signals}function assembleAxes(axisComponents,config){var _axisComponents$x=axisComponents.x,x=_axisComponents$x===void 0?[]:_axisComponents$x,_axisComponents$y=axisComponents.y,y=_axisComponents$y===void 0?[]:_axisComponents$y;return[].concat(_toConsumableArray(x.map((function(a){return assembleAxis(a,"grid",config)}))),_toConsumableArray(y.map((function(a){return assembleAxis(a,"grid",config)}))),_toConsumableArray(x.map((function(a){return assembleAxis(a,"main",config)}))),_toConsumableArray(y.map((function(a){return assembleAxis(a,"main",config)})))).filter((function(a){return a}))}function getAxisConfigFromConfigTypes(configTypes,config,channel,orient){return Object.assign.apply(null,[{}].concat(_toConsumableArray(configTypes.map((function(configType){if(configType==="axisOrient"){var orient1=channel==="x"?"bottom":"left";var orientConfig1=config[channel==="x"?"axisBottom":"axisLeft"]||{};var orientConfig2=config[channel==="x"?"axisTop":"axisRight"]||{};var props=new Set([].concat(_toConsumableArray(keys(orientConfig1)),_toConsumableArray(keys(orientConfig2))));var conditionalOrientAxisConfig={};var _iterator=_createForOfIteratorHelper(props.values()),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var prop=_step.value;conditionalOrientAxisConfig[prop]={signal:"".concat(orient["signal"],' === "').concat(orient1,'" ? ').concat(signalOrStringValue(orientConfig1[prop])," : ").concat(signalOrStringValue(orientConfig2[prop]))}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return conditionalOrientAxisConfig}return config[configType]})))))}function getAxisConfigs(channel,scaleType,orient,config){var typeBasedConfigTypes=scaleType==="band"?["axisDiscrete","axisBand"]:scaleType==="point"?["axisDiscrete","axisPoint"]:isQuantitative(scaleType)?["axisQuantitative"]:scaleType==="time"||scaleType==="utc"?["axisTemporal"]:[];var axisChannel=channel==="x"?"axisX":"axisY";var axisOrient=isSignalRef(orient)?"axisOrient":"axis"+titleCase(orient);var vlOnlyConfigTypes=[].concat(typeBasedConfigTypes,_toConsumableArray(typeBasedConfigTypes.map((function(c){return axisChannel+c.substr(4)}))));var vgConfigTypes=["axis",axisOrient,axisChannel];return{vlOnlyAxisConfig:getAxisConfigFromConfigTypes(vlOnlyConfigTypes,config,channel,orient),vgAxisConfig:getAxisConfigFromConfigTypes(vgConfigTypes,config,channel,orient),axisConfigStyle:getAxisConfigStyle([].concat(vgConfigTypes,_toConsumableArray(vlOnlyConfigTypes)),config)}}function getAxisConfigStyle(axisConfigTypes,config){var toMerge=[{}];var _iterator2=_createForOfIteratorHelper(axisConfigTypes),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _config$configType;var configType=_step2.value;var style=(_config$configType=config[configType])===null||_config$configType===void 0?void 0:_config$configType.style;if(style){style=array(style);var _iterator3=_createForOfIteratorHelper(style),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var s=_step3.value;toMerge.push(config.style[s])}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return Object.assign.apply(null,toMerge)}function getAxisConfig(property,styleConfigIndex,style){var axisConfigs=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};var styleConfig=getStyleConfig(property,style,styleConfigIndex);if(styleConfig!==undefined){return{configFrom:"style",configValue:styleConfig}}for(var _i=0,_arr=["vlOnlyAxisConfig","vgAxisConfig","axisConfigStyle"];_i<_arr.length;_i++){var _axisConfigs$configFr;var configFrom=_arr[_i];if(((_axisConfigs$configFr=axisConfigs[configFrom])===null||_axisConfigs$configFr===void 0?void 0:_axisConfigs$configFr[property])!==undefined){return{configFrom:configFrom,configValue:axisConfigs[configFrom][property]}}}return{}}var axisRules={scale:function scale(_ref){var model=_ref.model,channel=_ref.channel;return model.scaleName(channel)},format:function format(_ref2){var fieldOrDatumDef=_ref2.fieldOrDatumDef,config=_ref2.config,axis=_ref2.axis;var format=axis.format,formatType=axis.formatType;return guideFormat(fieldOrDatumDef,fieldOrDatumDef.type,format,formatType,config,true)},formatType:function formatType(_ref3){var axis=_ref3.axis,fieldOrDatumDef=_ref3.fieldOrDatumDef,scaleType=_ref3.scaleType;var formatType=axis.formatType;return guideFormatType(formatType,fieldOrDatumDef,scaleType)},grid:function grid(_ref4){var fieldOrDatumDef=_ref4.fieldOrDatumDef,axis=_ref4.axis,scaleType=_ref4.scaleType;if(isFieldDef(fieldOrDatumDef)&&isBinned(fieldOrDatumDef.bin)){return false}else{var _axis$grid;return(_axis$grid=axis.grid)!==null&&_axis$grid!==void 0?_axis$grid:defaultGrid(scaleType,fieldOrDatumDef)}},gridScale:function gridScale(_ref5){var model=_ref5.model,channel=_ref5.channel;return _gridScale(model,channel)},labelAlign:function labelAlign(_ref6){var axis=_ref6.axis,labelAngle=_ref6.labelAngle,orient=_ref6.orient,channel=_ref6.channel;return axis.labelAlign||defaultLabelAlign(labelAngle,orient,channel)},labelAngle:function labelAngle(_ref7){var _labelAngle=_ref7.labelAngle;return _labelAngle},labelBaseline:function labelBaseline(_ref8){var axis=_ref8.axis,labelAngle=_ref8.labelAngle,orient=_ref8.orient,channel=_ref8.channel;return axis.labelBaseline||defaultLabelBaseline(labelAngle,orient,channel)},labelFlush:function labelFlush(_ref9){var _axis$labelFlush;var axis=_ref9.axis,fieldOrDatumDef=_ref9.fieldOrDatumDef,channel=_ref9.channel;return(_axis$labelFlush=axis.labelFlush)!==null&&_axis$labelFlush!==void 0?_axis$labelFlush:defaultLabelFlush(fieldOrDatumDef.type,channel)},labelOverlap:function labelOverlap(_ref10){var _axis$labelOverlap;var axis=_ref10.axis,fieldOrDatumDef=_ref10.fieldOrDatumDef,scaleType=_ref10.scaleType;return(_axis$labelOverlap=axis.labelOverlap)!==null&&_axis$labelOverlap!==void 0?_axis$labelOverlap:defaultLabelOverlap(fieldOrDatumDef.type,scaleType,isFieldDef(fieldOrDatumDef)&&!!fieldOrDatumDef.timeUnit,isFieldDef(fieldOrDatumDef)?fieldOrDatumDef.sort:undefined)},orient:function orient(_ref11){var _orient=_ref11.orient;return _orient},tickCount:function tickCount(_ref12){var _axis$tickCount;var channel=_ref12.channel,model=_ref12.model,axis=_ref12.axis,fieldOrDatumDef=_ref12.fieldOrDatumDef,scaleType=_ref12.scaleType;var sizeType=channel==="x"?"width":channel==="y"?"height":undefined;var size=sizeType?model.getSizeSignalRef(sizeType):undefined;return(_axis$tickCount=axis.tickCount)!==null&&_axis$tickCount!==void 0?_axis$tickCount:defaultTickCount({fieldOrDatumDef:fieldOrDatumDef,scaleType:scaleType,size:size,values:axis.values})},title:function title(_ref13){var axis=_ref13.axis,model=_ref13.model,channel=_ref13.channel;if(axis.title!==undefined){return axis.title}var fieldDefTitle=getFieldDefTitle(model,channel);if(fieldDefTitle!==undefined){return fieldDefTitle}var fieldDef=model.typedFieldDef(channel);var channel2=channel==="x"?"x2":"y2";var fieldDef2=model.fieldDef(channel2);return mergeTitleFieldDefs(fieldDef?[toFieldDefBase(fieldDef)]:[],isFieldDef(fieldDef2)?[toFieldDefBase(fieldDef2)]:[])},values:function values(_ref14){var axis=_ref14.axis,fieldOrDatumDef=_ref14.fieldOrDatumDef;return _values(axis,fieldOrDatumDef)},zindex:function zindex(_ref15){var _axis$zindex;var axis=_ref15.axis,fieldOrDatumDef=_ref15.fieldOrDatumDef,mark=_ref15.mark;return(_axis$zindex=axis.zindex)!==null&&_axis$zindex!==void 0?_axis$zindex:defaultZindex(mark,fieldOrDatumDef)}};function defaultGrid(scaleType,fieldDef){return!hasDiscreteDomain(scaleType)&&isFieldDef(fieldDef)&&!isBinning(fieldDef===null||fieldDef===void 0?void 0:fieldDef.bin)}function _gridScale(model,channel){var gridChannel=channel==="x"?"y":"x";if(model.getScaleComponent(gridChannel)){return model.scaleName(gridChannel)}return undefined}function getLabelAngle(fieldOrDatumDef,axis,channel,styleConfig,axisConfigs){var labelAngle=axis===null||axis===void 0?void 0:axis.labelAngle;if(labelAngle!==undefined){return isSignalRef(labelAngle)?labelAngle:normalizeAngle(labelAngle)}else{var _getAxisConfig=getAxisConfig("labelAngle",styleConfig,axis===null||axis===void 0?void 0:axis.style,axisConfigs),angle=_getAxisConfig.configValue;if(angle!==undefined){return normalizeAngle(angle)}else{if(channel===X&&contains([NOMINAL,ORDINAL],fieldOrDatumDef.type)&&!(isFieldDef(fieldOrDatumDef)&&fieldOrDatumDef.timeUnit)){return 270}return undefined}}}function normalizeAngleExpr(angle){return"(((".concat(angle.signal," % 360) + 360) % 360)")}function defaultLabelBaseline(angle,orient,channel,alwaysIncludeMiddle){if(angle!==undefined){if(channel==="x"){if(isSignalRef(angle)){var a=normalizeAngleExpr(angle);var orientIsTop=isSignalRef(orient)?"(".concat(orient.signal,' === "top")'):orient==="top";return{signal:"(45 < ".concat(a," && ").concat(a," < 135) || (225 < ").concat(a," && ").concat(a,' < 315) ? "middle" :')+"(".concat(a," <= 45 || 315 <= ").concat(a,") === ").concat(orientIsTop,' ? "bottom" : "top"')}}if(45<angle&&angle<135||225<angle&&angle<315){return"middle"}if(isSignalRef(orient)){var op=angle<=45||315<=angle?"===":"!==";return{signal:"".concat(orient.signal," ").concat(op,' "top" ? "bottom" : "top"')}}return(angle<=45||315<=angle)===(orient==="top")?"bottom":"top"}else{if(isSignalRef(angle)){var _a=normalizeAngleExpr(angle);var orientIsLeft=isSignalRef(orient)?"(".concat(orient.signal,' === "left")'):orient==="left";var middle=alwaysIncludeMiddle?'"middle"':"null";return{signal:"".concat(_a," <= 45 || 315 <= ").concat(_a," || (135 <= ").concat(_a," && ").concat(_a," <= 225) ? ").concat(middle," : (45 <= ").concat(_a," && ").concat(_a," <= 135) === ").concat(orientIsLeft,' ? "top" : "bottom"')}}if(angle<=45||315<=angle||135<=angle&&angle<=225){return alwaysIncludeMiddle?"middle":null}if(isSignalRef(orient)){var _op=45<=angle&&angle<=135?"===":"!==";return{signal:"".concat(orient.signal," ").concat(_op,' "left" ? "top" : "bottom"')}}return(45<=angle&&angle<=135)===(orient==="left")?"top":"bottom"}}return undefined}function defaultLabelAlign(angle,orient,channel){if(angle===undefined){return undefined}var isX=channel==="x";var startAngle=isX?0:90;var mainOrient=isX?"bottom":"left";if(isSignalRef(angle)){var a=normalizeAngleExpr(angle);var orientIsMain=isSignalRef(orient)?"(".concat(orient.signal,' === "').concat(mainOrient,'")'):orient===mainOrient;return{signal:"(".concat(startAngle?"("+a+" + 90)":a," % 180 === 0) ? ").concat(isX?null:'"center"'," :")+"(".concat(startAngle," < ").concat(a," && ").concat(a," < ").concat(180+startAngle,") === ").concat(orientIsMain,' ? "left" : "right"')}}if((angle+startAngle)%180===0){return isX?null:"center"}if(isSignalRef(orient)){var op=startAngle<angle&&angle<180+startAngle?"===":"!==";var _orientIsMain="".concat(orient.signal," ").concat(op,' "').concat(mainOrient,'"');return{signal:"".concat(_orientIsMain,' ? "left" : "right"')}}if((startAngle<angle&&angle<180+startAngle)===(orient===mainOrient)){return"left"}return"right"}function defaultLabelFlush(type,channel){if(channel==="x"&&contains(["quantitative","temporal"],type)){return true}return undefined}function defaultLabelOverlap(type,scaleType,hasTimeUnit,sort){if(hasTimeUnit&&!isObject(sort)||type!=="nominal"&&type!=="ordinal"){if(scaleType==="log"){return"greedy"}return true}return undefined}function defaultOrient(channel){return channel==="x"?"bottom":"left"}function defaultTickCount(_ref16){var fieldOrDatumDef=_ref16.fieldOrDatumDef,scaleType=_ref16.scaleType,size=_ref16.size,vals=_ref16.values;if(!vals&&!hasDiscreteDomain(scaleType)&&scaleType!=="log"){if(isFieldDef(fieldOrDatumDef)){var _normalizeTimeUnit;if(isBinning(fieldOrDatumDef.bin)){return{signal:"ceil(".concat(size.signal,"/10)")}}if(fieldOrDatumDef.timeUnit&&contains(["month","hours","day","quarter"],(_normalizeTimeUnit=normalizeTimeUnit(fieldOrDatumDef.timeUnit))===null||_normalizeTimeUnit===void 0?void 0:_normalizeTimeUnit.unit)){return undefined}}return{signal:"ceil(".concat(size.signal,"/40)")}}return undefined}function getFieldDefTitle(model,channel){var channel2=channel==="x"?"x2":"y2";var fieldDef=model.fieldDef(channel);var fieldDef2=model.fieldDef(channel2);var title1=fieldDef?fieldDef.title:undefined;var title2=fieldDef2?fieldDef2.title:undefined;if(title1&&title2){return mergeTitle(title1,title2)}else if(title1){return title1}else if(title2){return title2}else if(title1!==undefined){return title1}else if(title2!==undefined){return title2}return undefined}function _values(axis,fieldOrDatumDef){var vals=axis.values;if(isArray(vals)){return valueArray(fieldOrDatumDef,vals)}else if(isSignalRef(vals)){return vals}return undefined}function defaultZindex(mark,fieldDef){if(mark==="rect"&&isDiscrete(fieldDef)){return 1}return 0}var CalculateNode=function(_DataFlowNode){_inherits(CalculateNode,_DataFlowNode);var _super=_createSuper(CalculateNode);_createClass(CalculateNode,[{key:"clone",value:function clone(){return new CalculateNode(null,duplicate(this.transform))}}]);function CalculateNode(parent,transform){var _this;_classCallCheck(this,CalculateNode);_this=_super.call(this,parent);_this.transform=transform;_defineProperty(_assertThisInitialized(_this),"_dependentFields",void 0);_this._dependentFields=getDependentFields(_this.transform.calculate);return _this}_createClass(CalculateNode,[{key:"producedFields",value:function producedFields(){return new Set([this.transform.as])}},{key:"dependentFields",value:function dependentFields(){return this._dependentFields}},{key:"assemble",value:function assemble(){return{type:"formula",expr:this.transform.calculate,as:this.transform.as}}},{key:"hash",value:function hash$1(){return"Calculate ".concat(hash(this.transform))}}],[{key:"parseAllForSortIndex",value:function parseAllForSortIndex(parent,model){model.forEachFieldDef((function(fieldDef,channel){if(!isScaleFieldDef(fieldDef)){return}if(isSortArray(fieldDef.sort)){var field=fieldDef.field,timeUnit=fieldDef.timeUnit;var sort=fieldDef.sort;var calculate=sort.map((function(sortValue,i){return"".concat(fieldFilterExpression({field:field,timeUnit:timeUnit,equal:sortValue})," ? ").concat(i," : ")})).join("")+sort.length;parent=new CalculateNode(parent,{calculate:calculate,as:sortArrayIndexField(fieldDef,channel,{forAs:true})})}}));return parent}}]);return CalculateNode}(DataFlowNode);function sortArrayIndexField(fieldDef,channel,opt){return vgField(fieldDef,_objectSpread2({prefix:channel,suffix:"sort_index"},opt!==null&&opt!==void 0?opt:{}))}function getHeaderChannel(channel,orient){if(contains(["top","bottom"],orient)){return"column"}else if(contains(["left","right"],orient)){return"row"}return channel==="row"?"row":"column"}function getHeaderProperty(prop,header,config,channel){var headerSpecificConfig=channel==="row"?config.headerRow:channel==="column"?config.headerColumn:config.headerFacet;return getFirstDefined((header||{})[prop],headerSpecificConfig[prop],config.header[prop])}function getHeaderProperties(properties,header,config,channel){var props={};var _iterator=_createForOfIteratorHelper(properties),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var prop=_step.value;var value=getHeaderProperty(prop,header||{},config,channel);if(value!==undefined){props[prop]=value}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return props}var HEADER_CHANNELS=["row","column"];var HEADER_TYPES=["header","footer"];function assembleTitleGroup(model,channel){var title=model.component.layoutHeaders[channel].title;var config=model.config?model.config:undefined;var facetFieldDef=model.component.layoutHeaders[channel].facetFieldDef?model.component.layoutHeaders[channel].facetFieldDef:undefined;var _getHeaderProperties=getHeaderProperties(["titleAnchor","titleAngle","titleOrient"],facetFieldDef.header,config,channel),titleAnchor=_getHeaderProperties.titleAnchor,ta=_getHeaderProperties.titleAngle,titleOrient=_getHeaderProperties.titleOrient;var headerChannel=getHeaderChannel(channel,titleOrient);var titleAngle=normalizeAngle(ta);return{name:"".concat(channel,"-title"),type:"group",role:"".concat(headerChannel,"-title"),title:_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({text:title},channel==="row"?{orient:"left"}:{}),{},{style:"guide-title"},defaultHeaderGuideBaseline(titleAngle,headerChannel)),defaultHeaderGuideAlign(headerChannel,titleAngle,titleAnchor)),assembleHeaderProperties(config,facetFieldDef,channel,HEADER_TITLE_PROPERTIES,HEADER_TITLE_PROPERTIES_MAP))}}function defaultHeaderGuideAlign(headerChannel,angle){var anchor=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"middle";switch(anchor){case"start":return{align:"left"};case"end":return{align:"right"}}var align=defaultLabelAlign(angle,headerChannel==="row"?"left":"top",headerChannel==="row"?"y":"x");return align?{align:align}:{}}function defaultHeaderGuideBaseline(angle,channel){var baseline=defaultLabelBaseline(angle,channel==="row"?"left":"top",channel==="row"?"y":"x",true);return baseline?{baseline:baseline}:{}}function assembleHeaderGroups(model,channel){var layoutHeader=model.component.layoutHeaders[channel];var groups=[];var _iterator=_createForOfIteratorHelper(HEADER_TYPES),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var headerType=_step.value;if(layoutHeader[headerType]){var _iterator2=_createForOfIteratorHelper(layoutHeader[headerType]),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var headerComponent=_step2.value;var group=assembleHeaderGroup(model,channel,headerType,layoutHeader,headerComponent);if(group!=null){groups.push(group)}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return groups}function getSort(facetFieldDef,channel){var sort=facetFieldDef.sort;if(isSortField(sort)){var _sort$order;return{field:vgField(sort,{expr:"datum"}),order:(_sort$order=sort.order)!==null&&_sort$order!==void 0?_sort$order:"ascending"}}else if(isArray(sort)){return{field:sortArrayIndexField(facetFieldDef,channel,{expr:"datum"}),order:"ascending"}}else{return{field:vgField(facetFieldDef,{expr:"datum"}),order:sort!==null&&sort!==void 0?sort:"ascending"}}}function assembleLabelTitle(facetFieldDef,channel,config){var _getHeaderProperties2=getHeaderProperties(["format","formatType","labelAngle","labelAnchor","labelOrient","labelExpr"],facetFieldDef.header,config,channel),format=_getHeaderProperties2.format,formatType=_getHeaderProperties2.formatType,labelAngle=_getHeaderProperties2.labelAngle,labelAnchor=_getHeaderProperties2.labelAnchor,labelOrient=_getHeaderProperties2.labelOrient,labelExpr=_getHeaderProperties2.labelExpr;var titleTextExpr=formatSignalRef({fieldOrDatumDef:facetFieldDef,format:format,formatType:formatType,expr:"parent",config:config}).signal;var headerChannel=getHeaderChannel(channel,labelOrient);return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({text:{signal:labelExpr?replaceAll(replaceAll(labelExpr,"datum.label",titleTextExpr),"datum.value",vgField(facetFieldDef,{expr:"parent"})):titleTextExpr}},channel==="row"?{orient:"left"}:{}),{},{style:"guide-label",frame:"group"},defaultHeaderGuideBaseline(labelAngle,headerChannel)),defaultHeaderGuideAlign(headerChannel,labelAngle,labelAnchor)),assembleHeaderProperties(config,facetFieldDef,channel,HEADER_LABEL_PROPERTIES,HEADER_LABEL_PROPERTIES_MAP))}function assembleHeaderGroup(model,channel,headerType,layoutHeader,headerComponent){if(headerComponent){var title=null;var facetFieldDef=layoutHeader.facetFieldDef;var config=model.config?model.config:undefined;if(facetFieldDef&&headerComponent.labels){var _getHeaderProperties3=getHeaderProperties(["labelOrient"],facetFieldDef.header,config,channel),labelOrient=_getHeaderProperties3.labelOrient;if(channel==="row"&&!contains(["top","bottom"],labelOrient)||channel==="column"&&!contains(["left","right"],labelOrient)){title=assembleLabelTitle(facetFieldDef,channel,config)}}var isFacetWithoutRowCol=isFacetModel(model)&&!isFacetMapping(model.facet);var axes=headerComponent.axes;var hasAxes=(axes===null||axes===void 0?void 0:axes.length)>0;if(title||hasAxes){var sizeChannel=channel==="row"?"height":"width";return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({name:model.getName("".concat(channel,"_").concat(headerType)),type:"group",role:"".concat(channel,"-").concat(headerType)},layoutHeader.facetFieldDef?{from:{data:model.getName(channel+"_domain")},sort:getSort(facetFieldDef,channel)}:{}),hasAxes&&isFacetWithoutRowCol?{from:{data:model.getName("facet_domain_".concat(channel))}}:{}),title?{title:title}:{}),headerComponent.sizeSignal?{encode:{update:_defineProperty({},sizeChannel,headerComponent.sizeSignal)}}:{}),hasAxes?{axes:axes}:{})}}return null}var LAYOUT_TITLE_BAND={column:{start:0,end:1},row:{start:1,end:0}};function getLayoutTitleBand(titleAnchor,headerChannel){return LAYOUT_TITLE_BAND[headerChannel][titleAnchor]}function assembleLayoutTitleBand(headerComponentIndex,config){var titleBand={};var _iterator3=_createForOfIteratorHelper(FACET_CHANNELS),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var channel=_step3.value;var headerComponent=headerComponentIndex[channel];if(headerComponent===null||headerComponent===void 0?void 0:headerComponent.facetFieldDef){var _getHeaderProperties4=getHeaderProperties(["titleAnchor","titleOrient"],headerComponent.facetFieldDef.header,config,channel),titleAnchor=_getHeaderProperties4.titleAnchor,titleOrient=_getHeaderProperties4.titleOrient;var headerChannel=getHeaderChannel(channel,titleOrient);var band=getLayoutTitleBand(titleAnchor,headerChannel);if(band!==undefined){titleBand[headerChannel]=band}}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return isEmpty(titleBand)?undefined:titleBand}function assembleHeaderProperties(config,facetFieldDef,channel,properties,propertiesMap){var props={};var _iterator4=_createForOfIteratorHelper(properties),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var prop=_step4.value;if(!propertiesMap[prop]){continue}var value=getHeaderProperty(prop,facetFieldDef===null||facetFieldDef===void 0?void 0:facetFieldDef.header,config,channel);if(value!==undefined){props[propertiesMap[prop]]=value}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}return props}function assembleLayoutSignals(model){return[].concat(_toConsumableArray(sizeSignals(model,"width")),_toConsumableArray(sizeSignals(model,"height")),_toConsumableArray(sizeSignals(model,"childWidth")),_toConsumableArray(sizeSignals(model,"childHeight")))}function sizeSignals(model,sizeType){var channel=sizeType==="width"?"x":"y";var size=model.component.layoutSize.get(sizeType);if(!size||size==="merged"){return[]}var name=model.getSizeSignalRef(sizeType).signal;if(size==="step"){var scaleComponent=model.getScaleComponent(channel);if(scaleComponent){var type=scaleComponent.get("type");var range=scaleComponent.get("range");if(hasDiscreteDomain(type)&&isVgRangeStep(range)){var scaleName=model.scaleName(channel);if(isFacetModel(model.parent)){var parentResolve=model.parent.component.resolve;if(parentResolve.scale[channel]==="independent"){return[stepSignal(scaleName,range)]}}return[stepSignal(scaleName,range),{name:name,update:sizeExpr(scaleName,scaleComponent,"domain('".concat(scaleName,"').length"))}]}}throw new Error("layout size is step although width/height is not step.")}else if(size=="container"){var isWidth=name.endsWith("width");var expr=isWidth?"containerSize()[0]":"containerSize()[1]";var defaultValue=getViewConfigContinuousSize(model.config.view,isWidth?"width":"height");var safeExpr="isFinite(".concat(expr,") ? ").concat(expr," : ").concat(defaultValue);return[{name:name,init:safeExpr,on:[{update:safeExpr,events:"window:resize"}]}]}else{return[{name:name,value:size}]}}function stepSignal(scaleName,range){return{name:scaleName+"_step",value:range.step}}function sizeExpr(scaleName,scaleComponent,cardinality){var type=scaleComponent.get("type");var padding=scaleComponent.get("padding");var paddingOuter=getFirstDefined(scaleComponent.get("paddingOuter"),padding);var paddingInner=scaleComponent.get("paddingInner");paddingInner=type==="band"?paddingInner!==undefined?paddingInner:padding:1;return"bandspace(".concat(cardinality,", ").concat(signalOrStringValue(paddingInner),", ").concat(signalOrStringValue(paddingOuter),") * ").concat(scaleName,"_step")}function getSizeTypeFromLayoutSizeType(layoutSizeType){return layoutSizeType==="childWidth"?"width":layoutSizeType==="childHeight"?"height":layoutSizeType}function guideEncodeEntry(encoding,model){return keys(encoding).reduce((function(encode,channel){var valueDef=encoding[channel];return _objectSpread2(_objectSpread2({},encode),wrapCondition(model,valueDef,channel,(function(def){return signalOrValueRef(def.value)})))}),{})}function defaultScaleResolve(channel,model){if(isLayerModel(model)||isFacetModel(model)){return"shared"}else if(isConcatModel(model)){return isXorY(channel)?"independent":"shared"}throw new Error("invalid model type for resolve")}function parseGuideResolve(resolve,channel){var channelScaleResolve=resolve.scale[channel];var guide=isXorY(channel)?"axis":"legend";if(channelScaleResolve==="independent"){if(resolve[guide][channel]==="shared"){warn(independentScaleMeansIndependentGuide(channel))}return"independent"}return resolve[guide][channel]||"shared"}var LEGEND_COMPONENT_PROPERTY_INDEX=_objectSpread2(_objectSpread2({},COMMON_LEGEND_PROPERTY_INDEX),{},{disable:1,labelExpr:1,selections:1,opacity:1,shape:1,stroke:1,fill:1,size:1,strokeWidth:1,strokeDash:1,encode:1});var LEGEND_COMPONENT_PROPERTIES=keys(LEGEND_COMPONENT_PROPERTY_INDEX);var LegendComponent=function(_Split){_inherits(LegendComponent,_Split);var _super=_createSuper(LegendComponent);function LegendComponent(){_classCallCheck(this,LegendComponent);return _super.apply(this,arguments)}return LegendComponent}(Split);var legendEncodeRules={symbols:symbols,gradient:gradient,labels:labels,entries:entries$1};function symbols(symbolsSpec,_ref){var _legendCmpt$get,_legendCmpt$get2,_legendCmpt$get3,_getMaxValue;var fieldOrDatumDef=_ref.fieldOrDatumDef,model=_ref.model,channel=_ref.channel,legendCmpt=_ref.legendCmpt,legendType=_ref.legendType;if(legendType!=="symbol"){return undefined}var markDef=model.markDef,encoding=model.encoding,config=model.config,mark=model.mark;var filled=markDef.filled&&mark!=="trail";var out=_objectSpread2(_objectSpread2({},applyMarkConfig({},model,FILL_STROKE_CONFIG)),color(model,{filled:filled}));var symbolOpacity=(_legendCmpt$get=legendCmpt.get("symbolOpacity"))!==null&&_legendCmpt$get!==void 0?_legendCmpt$get:config.legend.symbolOpacity;var symbolFillColor=(_legendCmpt$get2=legendCmpt.get("symbolFillColor"))!==null&&_legendCmpt$get2!==void 0?_legendCmpt$get2:config.legend.symbolFillColor;var symbolStrokeColor=(_legendCmpt$get3=legendCmpt.get("symbolStrokeColor"))!==null&&_legendCmpt$get3!==void 0?_legendCmpt$get3:config.legend.symbolStrokeColor;var opacity=symbolOpacity===undefined?(_getMaxValue=getMaxValue(encoding.opacity))!==null&&_getMaxValue!==void 0?_getMaxValue:markDef.opacity:undefined;if(out.fill){if(channel==="fill"||filled&&channel===COLOR){delete out.fill}else{if(out.fill["field"]){if(symbolFillColor){delete out.fill}else{var _config$legend$symbol;out.fill=signalOrValueRef((_config$legend$symbol=config.legend.symbolBaseFillColor)!==null&&_config$legend$symbol!==void 0?_config$legend$symbol:"black");out.fillOpacity=signalOrValueRef(opacity!==null&&opacity!==void 0?opacity:1)}}else if(isArray(out.fill)){var _ref2,_getFirstConditionVal,_encoding$fill;var fill=(_ref2=(_getFirstConditionVal=getFirstConditionValue((_encoding$fill=encoding.fill)!==null&&_encoding$fill!==void 0?_encoding$fill:encoding.color))!==null&&_getFirstConditionVal!==void 0?_getFirstConditionVal:markDef.fill)!==null&&_ref2!==void 0?_ref2:filled&&markDef.color;if(fill){out.fill=signalOrValueRef(fill)}}}}if(out.stroke){if(channel==="stroke"||!filled&&channel===COLOR){delete out.stroke}else{if(out.stroke["field"]||symbolStrokeColor){delete out.stroke}else if(isArray(out.stroke)){var stroke=getFirstDefined(getFirstConditionValue(encoding.stroke||encoding.color),markDef.stroke,filled?markDef.color:undefined);if(stroke){out.stroke={value:stroke}}}}}if(channel!==OPACITY){var condition=isFieldDef(fieldOrDatumDef)&&selectedCondition(model,legendCmpt,fieldOrDatumDef);if(condition){out.opacity=[_objectSpread2({test:condition},signalOrValueRef(opacity!==null&&opacity!==void 0?opacity:1)),signalOrValueRef(config.legend.unselectedOpacity)]}else if(opacity){out.opacity=signalOrValueRef(opacity)}}out=_objectSpread2(_objectSpread2({},out),symbolsSpec);return isEmpty(out)?undefined:out}function gradient(gradientSpec,_ref3){var _legendCmpt$get4;var model=_ref3.model,legendType=_ref3.legendType,legendCmpt=_ref3.legendCmpt;if(legendType!=="gradient"){return undefined}var config=model.config,markDef=model.markDef,encoding=model.encoding;var out={};var gradientOpacity=(_legendCmpt$get4=legendCmpt.get("gradientOpacity"))!==null&&_legendCmpt$get4!==void 0?_legendCmpt$get4:config.legend.gradientOpacity;var opacity=gradientOpacity===undefined?getMaxValue(encoding.opacity)||markDef.opacity:undefined;if(opacity){out.opacity=signalOrValueRef(opacity)}out=_objectSpread2(_objectSpread2({},out),gradientSpec);return isEmpty(out)?undefined:out}function labels(specifiedlabelsSpec,_ref4){var fieldOrDatumDef=_ref4.fieldOrDatumDef,model=_ref4.model,channel=_ref4.channel,legendCmpt=_ref4.legendCmpt;var legend=model.legend(channel)||{};var config=model.config;var condition=isFieldDef(fieldOrDatumDef)?selectedCondition(model,legendCmpt,fieldOrDatumDef):undefined;var opacity=condition?[{test:condition,value:1},{value:config.legend.unselectedOpacity}]:undefined;var format=legend.format,formatType=legend.formatType;var text=isCustomFormatType(formatType)?formatCustomType({fieldOrDatumDef:fieldOrDatumDef,field:"datum.value",format:format,formatType:formatType,config:config}):undefined;var labelsSpec=_objectSpread2(_objectSpread2(_objectSpread2({},opacity?{opacity:opacity}:{}),text?{text:text}:{}),specifiedlabelsSpec);return isEmpty(labelsSpec)?undefined:labelsSpec}function entries$1(entriesSpec,_ref5){var legendCmpt=_ref5.legendCmpt;var selections=legendCmpt.get("selections");return(selections===null||selections===void 0?void 0:selections.length)?_objectSpread2(_objectSpread2({},entriesSpec),{},{fill:{value:"transparent"}}):entriesSpec}function getMaxValue(channelDef){return getConditionValue(channelDef,(function(v,conditionalDef){return Math.max(v,conditionalDef.value)}))}function getFirstConditionValue(channelDef){return getConditionValue(channelDef,(function(v,conditionalDef){return getFirstDefined(v,conditionalDef.value)}))}function getConditionValue(channelDef,reducer){if(hasConditionalValueDef(channelDef)){return array(channelDef.condition).reduce(reducer,channelDef.value)}else if(isValueDef(channelDef)){return channelDef.value}return undefined}function selectedCondition(model,legendCmpt,fieldDef){var selections=legendCmpt.get("selections");if(!(selections===null||selections===void 0?void 0:selections.length))return undefined;var field=$(fieldDef.field);return selections.map((function(name){var store=$(varName(name)+STORE);return"(!length(data(".concat(store,")) || (").concat(name,"[").concat(field,"] && indexof(").concat(name,"[").concat(field,"], datum.value) >= 0))")})).join(" || ")}var legendRules={direction:function direction(_ref){var _direction=_ref.direction;return _direction},format:function format(_ref2){var fieldOrDatumDef=_ref2.fieldOrDatumDef,legend=_ref2.legend,config=_ref2.config;var format=legend.format,formatType=legend.formatType;return guideFormat(fieldOrDatumDef,fieldOrDatumDef.type,format,formatType,config,false)},formatType:function formatType(_ref3){var legend=_ref3.legend,fieldOrDatumDef=_ref3.fieldOrDatumDef,scaleType=_ref3.scaleType;var formatType=legend.formatType;return guideFormatType(formatType,fieldOrDatumDef,scaleType)},gradientLength:function gradientLength(params){var _ref4,_legend$gradientLengt;var legend=params.legend,legendConfig=params.legendConfig;return(_ref4=(_legend$gradientLengt=legend.gradientLength)!==null&&_legend$gradientLengt!==void 0?_legend$gradientLengt:legendConfig.gradientLength)!==null&&_ref4!==void 0?_ref4:defaultGradientLength(params)},labelOverlap:function labelOverlap(_ref5){var _ref6,_legend$labelOverlap;var legend=_ref5.legend,legendConfig=_ref5.legendConfig,scaleType=_ref5.scaleType;return(_ref6=(_legend$labelOverlap=legend.labelOverlap)!==null&&_legend$labelOverlap!==void 0?_legend$labelOverlap:legendConfig.labelOverlap)!==null&&_ref6!==void 0?_ref6:defaultLabelOverlap$1(scaleType)},symbolType:function symbolType(_ref7){var _legend$symbolType;var legend=_ref7.legend,markDef=_ref7.markDef,channel=_ref7.channel,encoding=_ref7.encoding;return(_legend$symbolType=legend.symbolType)!==null&&_legend$symbolType!==void 0?_legend$symbolType:defaultSymbolType(markDef.type,channel,encoding.shape,markDef.shape)},title:function title$1(_ref8){var fieldOrDatumDef=_ref8.fieldOrDatumDef,config=_ref8.config;return title(fieldOrDatumDef,config,{allowDisabling:true})},type:function type(_ref9){var legendType=_ref9.legendType,scaleType=_ref9.scaleType,channel=_ref9.channel;if(isColorChannel(channel)&&isContinuousToContinuous(scaleType)){if(legendType==="gradient"){return undefined}}else if(legendType==="symbol"){return undefined}return legendType},values:function values(_ref10){var fieldOrDatumDef=_ref10.fieldOrDatumDef,legend=_ref10.legend;return _values$1(legend,fieldOrDatumDef)}};function _values$1(legend,fieldOrDatumDef){var vals=legend.values;if(isArray(vals)){return valueArray(fieldOrDatumDef,vals)}else if(isSignalRef(vals)){return vals}return undefined}function defaultSymbolType(mark,channel,shapeChannelDef,markShape){if(channel!=="shape"){var _getFirstConditionVal;var shape=(_getFirstConditionVal=getFirstConditionValue(shapeChannelDef))!==null&&_getFirstConditionVal!==void 0?_getFirstConditionVal:markShape;if(shape){return shape}}switch(mark){case"bar":case"rect":case"image":case"square":return"square";case"line":case"trail":case"rule":return"stroke";case"arc":case"point":case"circle":case"tick":case"geoshape":case"area":case"text":return"circle"}}function getLegendType(params){var legend=params.legend;return getFirstDefined(legend.type,defaultType$1(params))}function defaultType$1(_ref11){var channel=_ref11.channel,timeUnit=_ref11.timeUnit,scaleType=_ref11.scaleType;if(isColorChannel(channel)){if(contains(["quarter","month","day"],timeUnit)){return"symbol"}if(isContinuousToContinuous(scaleType)){return"gradient"}}return"symbol"}function getDirection(_ref12){var _ref13,_legend$direction;var legendConfig=_ref12.legendConfig,legendType=_ref12.legendType,orient=_ref12.orient,legend=_ref12.legend;return(_ref13=(_legend$direction=legend.direction)!==null&&_legend$direction!==void 0?_legend$direction:legendConfig[legendType?"gradientDirection":"symbolDirection"])!==null&&_ref13!==void 0?_ref13:defaultDirection(orient,legendType)}function defaultDirection(orient,legendType){switch(orient){case"top":case"bottom":return"horizontal";case"left":case"right":case"none":case undefined:return undefined;default:return legendType==="gradient"?"horizontal":undefined}}function defaultGradientLength(_ref14){var legendConfig=_ref14.legendConfig,model=_ref14.model,direction=_ref14.direction,orient=_ref14.orient,scaleType=_ref14.scaleType;var gradientHorizontalMaxLength=legendConfig.gradientHorizontalMaxLength,gradientHorizontalMinLength=legendConfig.gradientHorizontalMinLength,gradientVerticalMaxLength=legendConfig.gradientVerticalMaxLength,gradientVerticalMinLength=legendConfig.gradientVerticalMinLength;if(isContinuousToContinuous(scaleType)){if(direction==="horizontal"){if(orient==="top"||orient==="bottom"){return gradientLengthSignal(model,"width",gradientHorizontalMinLength,gradientHorizontalMaxLength)}else{return gradientHorizontalMinLength}}else{return gradientLengthSignal(model,"height",gradientVerticalMinLength,gradientVerticalMaxLength)}}return undefined}function gradientLengthSignal(model,sizeType,min,max){var sizeSignal=model.getSizeSignalRef(sizeType).signal;return{signal:"clamp(".concat(sizeSignal,", ").concat(min,", ").concat(max,")")}}function defaultLabelOverlap$1(scaleType){if(contains(["quantile","threshold","log"],scaleType)){return"greedy"}return undefined}function parseLegend(model){var legendComponent=isUnitModel(model)?parseUnitLegend(model):parseNonUnitLegend(model);model.component.legends=legendComponent;return legendComponent}function parseUnitLegend(model){var encoding=model.encoding;var legendComponent={};for(var _i=0,_arr=[COLOR].concat(_toConsumableArray(LEGEND_SCALE_CHANNELS));_i<_arr.length;_i++){var channel=_arr[_i];var def=getFieldOrDatumDef(encoding[channel]);if(!def||!model.getScaleComponent(channel)){continue}if(channel===SHAPE&&isFieldDef(def)&&def.type===GEOJSON){continue}legendComponent[channel]=parseLegendForChannel(model,channel)}return legendComponent}function getLegendDefWithScale(model,channel){var scale=model.scaleName(channel);if(model.mark==="trail"){if(channel==="color"){return{stroke:scale}}else if(channel==="size"){return{strokeWidth:scale}}}if(channel==="color"){return model.markDef.filled?{fill:scale}:{stroke:scale}}return _defineProperty({},channel,scale)}function isExplicit(value,property,legend,fieldDef){switch(property){case"disable":return legend!==undefined;case"values":return!!(legend===null||legend===void 0?void 0:legend.values);case"title":if(property==="title"&&value===(fieldDef===null||fieldDef===void 0?void 0:fieldDef.title)){return true}}return value===(legend||{})[property]}function parseLegendForChannel(model,channel){var _normalizeTimeUnit,_legend$encoding,_legend;var legend=model.legend(channel);var markDef=model.markDef,encoding=model.encoding,config=model.config;var legendConfig=config.legend;var legendCmpt=new LegendComponent({},getLegendDefWithScale(model,channel));parseInteractiveLegend(model,channel,legendCmpt);var disable=legend!==undefined?!legend:legendConfig.disable;legendCmpt.set("disable",disable,legend!==undefined);if(disable){return legendCmpt}legend=legend||{};var scaleType=model.getScaleComponent(channel).get("type");var fieldOrDatumDef=getFieldOrDatumDef(encoding[channel]);var timeUnit=isFieldDef(fieldOrDatumDef)?(_normalizeTimeUnit=normalizeTimeUnit(fieldOrDatumDef.timeUnit))===null||_normalizeTimeUnit===void 0?void 0:_normalizeTimeUnit.unit:undefined;var orient=legend.orient||config.legend.orient||"right";var legendType=getLegendType({legend:legend,channel:channel,timeUnit:timeUnit,scaleType:scaleType});var direction=getDirection({legend:legend,legendType:legendType,orient:orient,legendConfig:legendConfig});var ruleParams={legend:legend,channel:channel,model:model,markDef:markDef,encoding:encoding,fieldOrDatumDef:fieldOrDatumDef,legendConfig:legendConfig,config:config,scaleType:scaleType,orient:orient,legendType:legendType,direction:direction};var _iterator=_createForOfIteratorHelper(LEGEND_COMPONENT_PROPERTIES),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var property=_step.value;if(legendType==="gradient"&&property.startsWith("symbol")||legendType==="symbol"&&property.startsWith("gradient")){continue}var _value=property in legendRules?legendRules[property](ruleParams):legend[property];if(_value!==undefined){var explicit=isExplicit(_value,property,legend,model.fieldDef(channel));if(explicit||config.legend[property]===undefined){legendCmpt.set(property,_value,explicit)}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}var legendEncoding=(_legend$encoding=(_legend=legend)===null||_legend===void 0?void 0:_legend.encoding)!==null&&_legend$encoding!==void 0?_legend$encoding:{};var selections=legendCmpt.get("selections");var legendEncode={};var legendEncodeParams={fieldOrDatumDef:fieldOrDatumDef,model:model,channel:channel,legendCmpt:legendCmpt,legendType:legendType};for(var _i2=0,_arr2=["labels","legend","title","symbols","gradient","entries"];_i2<_arr2.length;_i2++){var _legendEncoding$part;var part=_arr2[_i2];var legendEncodingPart=guideEncodeEntry((_legendEncoding$part=legendEncoding[part])!==null&&_legendEncoding$part!==void 0?_legendEncoding$part:{},model);var value=part in legendEncodeRules?legendEncodeRules[part](legendEncodingPart,legendEncodeParams):legendEncodingPart;if(value!==undefined&&!isEmpty(value)){legendEncode[part]=_objectSpread2(_objectSpread2(_objectSpread2({},(selections===null||selections===void 0?void 0:selections.length)&&isFieldDef(fieldOrDatumDef)?{name:"".concat(varName(fieldOrDatumDef.field),"_legend_").concat(part)}:{}),(selections===null||selections===void 0?void 0:selections.length)?{interactive:!!selections}:{}),{},{update:value})}}if(!isEmpty(legendEncode)){var _legend2;legendCmpt.set("encode",legendEncode,!!((_legend2=legend)===null||_legend2===void 0?void 0:_legend2.encoding))}return legendCmpt}function parseNonUnitLegend(model){var _model$component=model.component,legends=_model$component.legends,resolve=_model$component.resolve;var _iterator2=_createForOfIteratorHelper(model.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;parseLegend(child);var _iterator4=_createForOfIteratorHelper(keys(child.component.legends)),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var channel=_step4.value;resolve.legend[channel]=parseGuideResolve(model.component.resolve,channel);if(resolve.legend[channel]==="shared"){legends[channel]=mergeLegendComponent(legends[channel],child.component.legends[channel]);if(!legends[channel]){resolve.legend[channel]="independent";delete legends[channel]}}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}var _iterator3=_createForOfIteratorHelper(keys(legends)),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _channel=_step3.value;var _iterator5=_createForOfIteratorHelper(model.children),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _child=_step5.value;if(!_child.component.legends[_channel]){continue}if(resolve.legend[_channel]==="shared"){delete _child.component.legends[_channel]}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return legends}function mergeLegendComponent(mergedLegend,childLegend){if(!mergedLegend){return childLegend.clone()}var mergedOrient=mergedLegend.getWithExplicit("orient");var childOrient=childLegend.getWithExplicit("orient");if(mergedOrient.explicit&&childOrient.explicit&&mergedOrient.value!==childOrient.value){return undefined}var typeMerged=false;var _iterator6=_createForOfIteratorHelper(LEGEND_COMPONENT_PROPERTIES),_step6;try{var _loop=function _loop(){var prop=_step6.value;var mergedValueWithExplicit=mergeValuesWithExplicit(mergedLegend.getWithExplicit(prop),childLegend.getWithExplicit(prop),prop,"legend",(function(v1,v2){switch(prop){case"symbolType":return mergeSymbolType(v1,v2);case"title":return mergeTitleComponent(v1,v2);case"type":typeMerged=true;return makeImplicit("symbol")}return defaultTieBreaker(v1,v2,prop,"legend")}));mergedLegend.setWithExplicit(prop,mergedValueWithExplicit)};for(_iterator6.s();!(_step6=_iterator6.n()).done;){_loop()}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}if(typeMerged){var _mergedLegend$implici,_mergedLegend$implici2,_mergedLegend$explici,_mergedLegend$explici2;if((_mergedLegend$implici=mergedLegend.implicit)===null||_mergedLegend$implici===void 0?void 0:(_mergedLegend$implici2=_mergedLegend$implici.encode)===null||_mergedLegend$implici2===void 0?void 0:_mergedLegend$implici2.gradient){deleteNestedProperty(mergedLegend.implicit,["encode","gradient"])}if((_mergedLegend$explici=mergedLegend.explicit)===null||_mergedLegend$explici===void 0?void 0:(_mergedLegend$explici2=_mergedLegend$explici.encode)===null||_mergedLegend$explici2===void 0?void 0:_mergedLegend$explici2.gradient){deleteNestedProperty(mergedLegend.explicit,["encode","gradient"])}}return mergedLegend}function mergeSymbolType(st1,st2){if(st2.value==="circle"){return st2}return st1}function setLegendEncode(legend,part,vgProp,vgRef){var _legend$encode,_legend$encode$part,_legend$encode$part$u;legend.encode=(_legend$encode=legend.encode)!==null&&_legend$encode!==void 0?_legend$encode:{};legend.encode[part]=(_legend$encode$part=legend.encode[part])!==null&&_legend$encode$part!==void 0?_legend$encode$part:{};legend.encode[part].update=(_legend$encode$part$u=legend.encode[part].update)!==null&&_legend$encode$part$u!==void 0?_legend$encode$part$u:{};legend.encode[part].update[vgProp]=vgRef}function assembleLegends(model){var legendComponentIndex=model.component.legends;var legendByDomain={};var _iterator=_createForOfIteratorHelper(keys(legendComponentIndex)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;var scaleComponent=model.getScaleComponent(channel);var domainHash=stringify(scaleComponent.get("domains"));if(legendByDomain[domainHash]){var _iterator2=_createForOfIteratorHelper(legendByDomain[domainHash]),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var mergedLegendComponent=_step2.value;var merged=mergeLegendComponent(mergedLegendComponent,legendComponentIndex[channel]);if(!merged){legendByDomain[domainHash].push(legendComponentIndex[channel])}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}else{legendByDomain[domainHash]=[legendComponentIndex[channel].clone()]}}}catch(err){_iterator.e(err)}finally{_iterator.f()}var legends=vals(legendByDomain).flat().map((function(l){return assembleLegend(l,model.config)})).filter((function(l){return l!==undefined}));return legends}function assembleLegend(legendCmpt,config){var _legend$encode2;var _legendCmpt$combine=legendCmpt.combine(),disable=_legendCmpt$combine.disable,labelExpr=_legendCmpt$combine.labelExpr,selections=_legendCmpt$combine.selections,legend=_objectWithoutProperties(_legendCmpt$combine,["disable","labelExpr","selections"]);if(disable){return undefined}if(config.aria===false&&legend.aria==undefined){legend.aria=false}if((_legend$encode2=legend.encode)===null||_legend$encode2===void 0?void 0:_legend$encode2.symbols){var out=legend.encode.symbols.update;if(out.fill&&out.fill["value"]!=="transparent"&&!out.stroke&&!legend.stroke){out.stroke={value:"transparent"}}var _iterator3=_createForOfIteratorHelper(LEGEND_SCALE_CHANNELS),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var property=_step3.value;if(legend[property]){delete out[property]}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}if(!legend.title){delete legend.title}if(labelExpr!==undefined){var _legend$encode3,_legend$encode3$label;var expr=labelExpr;if(((_legend$encode3=legend.encode)===null||_legend$encode3===void 0?void 0:(_legend$encode3$label=_legend$encode3.labels)===null||_legend$encode3$label===void 0?void 0:_legend$encode3$label.update)&&isSignalRef(legend.encode.labels.update.text)){expr=replaceAll(labelExpr,"datum.label",legend.encode.labels.update.text.signal)}setLegendEncode(legend,"labels","text",{signal:expr})}return legend}function assembleProjections(model){if(isLayerModel(model)||isConcatModel(model)){return assembleProjectionsForModelAndChildren(model)}else{return assembleProjectionForModel(model)}}function assembleProjectionsForModelAndChildren(model){return model.children.reduce((function(projections,child){return projections.concat(child.assembleProjections())}),assembleProjectionForModel(model))}function assembleProjectionForModel(model){var component=model.component.projection;if(!component||component.merged){return[]}var projection=component.combine();var name=projection.name;if(!component.data){return[_objectSpread2(_objectSpread2({name:name},{translate:{signal:"[width / 2, height / 2]"}}),projection)]}else{var size={signal:"[".concat(component.size.map((function(ref){return ref.signal})).join(", "),"]")};var fits=component.data.reduce((function(sources,data){var source=isSignalRef(data)?data.signal:"data('".concat(model.lookupDataSource(data),"')");if(!contains(sources,source)){sources.push(source)}return sources}),[]);if(fits.length<=0){throw new Error("Projection's fit didn't find any data sources")}return[_objectSpread2({name:name,size:size,fit:{signal:fits.length>1?"[".concat(fits.join(", "),"]"):fits[0]}},projection)]}}var PROJECTION_PROPERTIES=["type","clipAngle","clipExtent","center","rotate","precision","reflectX","reflectY","coefficient","distance","fraction","lobes","parallel","radius","ratio","spacing","tilt"];var ProjectionComponent=function(_Split){_inherits(ProjectionComponent,_Split);var _super=_createSuper(ProjectionComponent);function ProjectionComponent(name,specifiedProjection,size,data){var _this;_classCallCheck(this,ProjectionComponent);_this=_super.call(this,_objectSpread2({},specifiedProjection),{name:name});_this.specifiedProjection=specifiedProjection;_this.size=size;_this.data=data;_defineProperty(_assertThisInitialized(_this),"merged",false);return _this}_createClass(ProjectionComponent,[{key:"isFit",get:function get(){return!!this.data}}]);return ProjectionComponent}(Split);function parseProjection(model){model.component.projection=isUnitModel(model)?parseUnitProjection(model):parseNonUnitProjections(model)}function parseUnitProjection(model){if(model.hasProjection){var _model$config$project;var proj=model.specifiedProjection;var fit=!(proj&&(proj.scale!=null||proj.translate!=null));var size=fit?[model.getSizeSignalRef("width"),model.getSizeSignalRef("height")]:undefined;var data=fit?gatherFitData(model):undefined;return new ProjectionComponent(model.projectionName(true),_objectSpread2(_objectSpread2({},(_model$config$project=model.config.projection)!==null&&_model$config$project!==void 0?_model$config$project:{}),proj!==null&&proj!==void 0?proj:{}),size,data)}return undefined}function gatherFitData(model){var data=[];var encoding=model.encoding;for(var _i=0,_arr=[[LONGITUDE,LATITUDE],[LONGITUDE2,LATITUDE2]];_i<_arr.length;_i++){var posssiblePair=_arr[_i];if(getFieldOrDatumDef(encoding[posssiblePair[0]])||getFieldOrDatumDef(encoding[posssiblePair[1]])){data.push({signal:model.getName("geojson_".concat(data.length))})}}if(model.channelHasField(SHAPE)&&model.typedFieldDef(SHAPE).type===GEOJSON){data.push({signal:model.getName("geojson_".concat(data.length))})}if(data.length===0){data.push(model.requestDataName(DataSourceType.Main))}return data}function mergeIfNoConflict(first,second){var allPropertiesShared=every(PROJECTION_PROPERTIES,(function(prop){if(!_has(first.explicit,prop)&&!_has(second.explicit,prop)){return true}if(_has(first.explicit,prop)&&_has(second.explicit,prop)&&stringify(first.get(prop))===stringify(second.get(prop))){return true}return false}));var size=stringify(first.size)===stringify(second.size);if(size){if(allPropertiesShared){return first}else if(stringify(first.explicit)===stringify({})){return second}else if(stringify(second.explicit)===stringify({})){return first}}return null}function parseNonUnitProjections(model){if(model.children.length===0){return undefined}var nonUnitProjection;var _iterator=_createForOfIteratorHelper(model.children),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var _child=_step.value;parseProjection(_child)}}catch(err){_iterator.e(err)}finally{_iterator.f()}var mergable=every(model.children,(function(child){var projection=child.component.projection;if(!projection){return true}else if(!nonUnitProjection){nonUnitProjection=projection;return true}else{var merge=mergeIfNoConflict(nonUnitProjection,projection);if(merge){nonUnitProjection=merge}return!!merge}}));if(nonUnitProjection&&mergable){var name=model.projectionName(true);var modelProjection=new ProjectionComponent(name,nonUnitProjection.specifiedProjection,nonUnitProjection.size,duplicate(nonUnitProjection.data));var _iterator2=_createForOfIteratorHelper(model.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;var projection=child.component.projection;if(projection){if(projection.isFit){var _modelProjection$data;(_modelProjection$data=modelProjection.data).push.apply(_modelProjection$data,_toConsumableArray(child.component.projection.data))}child.renameProjection(projection.get("name"),name);projection.merged=true}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return modelProjection}return undefined}function rangeFormula(model,fieldDef,channel,config){if(binRequiresRange(fieldDef,channel)){var _ref,_model$axis;var guide=isUnitModel(model)?(_ref=(_model$axis=model.axis(channel))!==null&&_model$axis!==void 0?_model$axis:model.legend(channel))!==null&&_ref!==void 0?_ref:{}:{};var startField=vgField(fieldDef,{expr:"datum"});var endField=vgField(fieldDef,{expr:"datum",binSuffix:"end"});return{formulaAs:vgField(fieldDef,{binSuffix:"range",forAs:true}),formula:binFormatExpression(startField,endField,guide.format,guide.formatType,config)}}return{}}function binKey(bin,field){return"".concat(binToString(bin),"_").concat(field)}function getSignalsFromModel(model,key){return{signal:model.getName("".concat(key,"_bins")),extentSignal:model.getName("".concat(key,"_extent"))}}function getBinSignalName(model,field,bin){var _normalizeBin;var normalizedBin=(_normalizeBin=normalizeBin(bin,undefined))!==null&&_normalizeBin!==void 0?_normalizeBin:{};var key=binKey(normalizedBin,field);return model.getName("".concat(key,"_bins"))}function isBinTransform(t){return"as"in t}function createBinComponent(t,bin,model){var as;var span;if(isBinTransform(t)){as=isString(t.as)?[t.as,"".concat(t.as,"_end")]:[t.as[0],t.as[1]]}else{as=[vgField(t,{forAs:true}),vgField(t,{binSuffix:"end",forAs:true})]}var normalizedBin=_objectSpread2({},normalizeBin(bin,undefined));var key=binKey(normalizedBin,t.field);var _getSignalsFromModel=getSignalsFromModel(model,key),signal=_getSignalsFromModel.signal,extentSignal=_getSignalsFromModel.extentSignal;if(isSelectionExtent(normalizedBin.extent)){var ext=normalizedBin.extent;var selName=ext.selection;span=parseSelectionBinExtent(model.getSelectionComponent(varName(selName),selName),ext);delete normalizedBin.extent}var binComponent=_objectSpread2(_objectSpread2(_objectSpread2({bin:normalizedBin,field:t.field,as:[as]},signal?{signal:signal}:{}),extentSignal?{extentSignal:extentSignal}:{}),span?{span:span}:{});return{key:key,binComponent:binComponent}}var BinNode=function(_DataFlowNode){_inherits(BinNode,_DataFlowNode);var _super=_createSuper(BinNode);_createClass(BinNode,[{key:"clone",value:function clone(){return new BinNode(null,duplicate(this.bins))}}]);function BinNode(parent,bins){var _this;_classCallCheck(this,BinNode);_this=_super.call(this,parent);_this.bins=bins;return _this}_createClass(BinNode,[{key:"merge",value:function merge(other,renameSignal){var _iterator=_createForOfIteratorHelper(keys(other.bins)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var key=_step.value;if(key in this.bins){renameSignal(other.bins[key].signal,this.bins[key].signal);this.bins[key].as=unique([].concat(_toConsumableArray(this.bins[key].as),_toConsumableArray(other.bins[key].as)),hash)}else{this.bins[key]=other.bins[key]}}}catch(err){_iterator.e(err)}finally{_iterator.f()}var _iterator2=_createForOfIteratorHelper(other.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;other.removeChild(child);child.parent=this}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}other.remove()}},{key:"producedFields",value:function producedFields(){return new Set(vals(this.bins).map((function(c){return c.as})).flat(2))}},{key:"dependentFields",value:function dependentFields(){return new Set(vals(this.bins).map((function(c){return c.field})))}},{key:"hash",value:function hash$1(){return"Bin ".concat(hash(this.bins))}},{key:"assemble",value:function assemble(){return vals(this.bins).flatMap((function(bin){var transform=[];var _bin$as=_toArray(bin.as),binAs=_bin$as[0],remainingAs=_bin$as.slice(1);var _bin$bin=bin.bin,extent=_bin$bin.extent,params=_objectWithoutProperties(_bin$bin,["extent"]);var binTrans=_objectSpread2(_objectSpread2(_objectSpread2({type:"bin",field:replacePathInField(bin.field),as:binAs,signal:bin.signal},!isSelectionExtent(extent)?{extent:extent}:{extent:null}),bin.span?{span:{signal:"span(".concat(bin.span,")")}}:{}),params);if(!extent&&bin.extentSignal){transform.push({type:"extent",field:replacePathInField(bin.field),signal:bin.extentSignal});binTrans.extent={signal:bin.extentSignal}}transform.push(binTrans);var _iterator3=_createForOfIteratorHelper(remainingAs),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var as=_step3.value;for(var i=0;i<2;i++){transform.push({type:"formula",expr:vgField({field:binAs[i]},{expr:"datum"}),as:as[i]})}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}if(bin.formula){transform.push({type:"formula",expr:bin.formula,as:bin.formulaAs})}return transform}))}}],[{key:"makeFromEncoding",value:function makeFromEncoding(parent,model){var bins=model.reduceFieldDef((function(binComponentIndex,fieldDef,channel){if(isTypedFieldDef(fieldDef)&&isBinning(fieldDef.bin)){var _createBinComponent=createBinComponent(fieldDef,fieldDef.bin,model),key=_createBinComponent.key,binComponent=_createBinComponent.binComponent;binComponentIndex[key]=_objectSpread2(_objectSpread2(_objectSpread2({},binComponent),binComponentIndex[key]),rangeFormula(model,fieldDef,channel,model.config))}return binComponentIndex}),{});if(isEmpty(bins)){return null}return new BinNode(parent,bins)}},{key:"makeFromTransform",value:function makeFromTransform(parent,t,model){var _createBinComponent2=createBinComponent(t,t.bin,model),key=_createBinComponent2.key,binComponent=_createBinComponent2.binComponent;return new BinNode(parent,_defineProperty({},key,binComponent))}}]);return BinNode}(DataFlowNode);function addDimension(dims,channel,fieldDef,model){var channelDef2=isUnitModel(model)?model.encoding[getSecondaryRangeChannel(channel)]:undefined;if(isTypedFieldDef(fieldDef)&&isUnitModel(model)&&hasBand(channel,fieldDef,channelDef2,model.stack,model.markDef,model.config)){dims.add(vgField(fieldDef,{}));dims.add(vgField(fieldDef,{suffix:"end"}));if(fieldDef.bin&&binRequiresRange(fieldDef,channel)){dims.add(vgField(fieldDef,{binSuffix:"range"}))}}else if(isGeoPositionChannel(channel)){var posChannel=getPositionChannelFromLatLong(channel);dims.add(model.getName(posChannel))}else{dims.add(vgField(fieldDef))}return dims}function mergeMeasures(parentMeasures,childMeasures){var _iterator=_createForOfIteratorHelper(keys(childMeasures)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var field=_step.value;var ops=childMeasures[field];var _iterator2=_createForOfIteratorHelper(keys(ops)),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var op=_step2.value;if(field in parentMeasures){var _parentMeasures$field;parentMeasures[field][op]=new Set([].concat(_toConsumableArray((_parentMeasures$field=parentMeasures[field][op])!==null&&_parentMeasures$field!==void 0?_parentMeasures$field:[]),_toConsumableArray(ops[op])))}else{parentMeasures[field]=_defineProperty({},op,ops[op])}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}var AggregateNode=function(_DataFlowNode){_inherits(AggregateNode,_DataFlowNode);var _super=_createSuper(AggregateNode);_createClass(AggregateNode,[{key:"clone",value:function clone(){return new AggregateNode(null,new Set(this.dimensions),duplicate(this.measures))}}]);function AggregateNode(parent,dimensions,measures){var _this;_classCallCheck(this,AggregateNode);_this=_super.call(this,parent);_this.dimensions=dimensions;_this.measures=measures;return _this}_createClass(AggregateNode,[{key:"merge",value:function merge(other){if(setEqual(this.dimensions,other.dimensions)){mergeMeasures(this.measures,other.measures);return true}else{debug("different dimensions, cannot merge");return false}}},{key:"addDimensions",value:function addDimensions(fields){fields.forEach(this.dimensions.add,this.dimensions)}},{key:"dependentFields",value:function dependentFields(){return new Set([].concat(_toConsumableArray(this.dimensions),_toConsumableArray(keys(this.measures))))}},{key:"producedFields",value:function producedFields(){var out=new Set;var _iterator3=_createForOfIteratorHelper(keys(this.measures)),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var field=_step3.value;var _iterator4=_createForOfIteratorHelper(keys(this.measures[field])),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var op=_step4.value;var m=this.measures[field][op];if(m.size===0){out.add("".concat(op,"_").concat(field))}else{m.forEach(out.add,out)}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return out}},{key:"hash",value:function hash$1(){return"Aggregate ".concat(hash({dimensions:this.dimensions,measures:this.measures}))}},{key:"assemble",value:function assemble(){var ops=[];var fields=[];var as=[];var _iterator5=_createForOfIteratorHelper(keys(this.measures)),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var field=_step5.value;var _iterator6=_createForOfIteratorHelper(keys(this.measures[field])),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var op=_step6.value;var _iterator7=_createForOfIteratorHelper(this.measures[field][op]),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var alias=_step7.value;as.push(alias);ops.push(op);fields.push(field==="*"?null:replacePathInField(field))}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}var result={type:"aggregate",groupby:_toConsumableArray(this.dimensions).map(replacePathInField),ops:ops,fields:fields,as:as};return result}},{key:"groupBy",get:function get(){return this.dimensions}}],[{key:"makeFromEncoding",value:function makeFromEncoding(parent,model){var isAggregate=false;model.forEachFieldDef((function(fd){if(fd.aggregate){isAggregate=true}}));var meas={};var dims=new Set;if(!isAggregate){return null}model.forEachFieldDef((function(fieldDef,channel){var aggregate=fieldDef.aggregate,field=fieldDef.field;if(aggregate){if(aggregate==="count"){var _meas$;meas["*"]=(_meas$=meas["*"])!==null&&_meas$!==void 0?_meas$:{};meas["*"]["count"]=new Set([vgField(fieldDef,{forAs:true})])}else{if(isArgminDef(aggregate)||isArgmaxDef(aggregate)){var _meas$argField;var op=isArgminDef(aggregate)?"argmin":"argmax";var argField=aggregate[op];meas[argField]=(_meas$argField=meas[argField])!==null&&_meas$argField!==void 0?_meas$argField:{};meas[argField][op]=new Set([vgField({op:op,field:argField},{forAs:true})])}else{var _meas$field;meas[field]=(_meas$field=meas[field])!==null&&_meas$field!==void 0?_meas$field:{};meas[field][aggregate]=new Set([vgField(fieldDef,{forAs:true})])}if(isScaleChannel(channel)&&model.scaleDomain(channel)==="unaggregated"){var _meas$field2;meas[field]=(_meas$field2=meas[field])!==null&&_meas$field2!==void 0?_meas$field2:{};meas[field]["min"]=new Set([vgField({field:field,aggregate:"min"},{forAs:true})]);meas[field]["max"]=new Set([vgField({field:field,aggregate:"max"},{forAs:true})])}}}else{addDimension(dims,channel,fieldDef,model)}}));if(dims.size+keys(meas).length===0){return null}return new AggregateNode(parent,dims,meas)}},{key:"makeFromTransform",value:function makeFromTransform(parent,t){var _t$groupby;var dims=new Set;var meas={};var _iterator8=_createForOfIteratorHelper(t.aggregate),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var s=_step8.value;var op=s.op,field=s.field,as=s.as;if(op){if(op==="count"){var _meas$2;meas["*"]=(_meas$2=meas["*"])!==null&&_meas$2!==void 0?_meas$2:{};meas["*"]["count"]=new Set([as?as:vgField(s,{forAs:true})])}else{var _meas$field3;meas[field]=(_meas$field3=meas[field])!==null&&_meas$field3!==void 0?_meas$field3:{};meas[field][op]=new Set([as?as:vgField(s,{forAs:true})])}}}}catch(err){_iterator8.e(err)}finally{_iterator8.f()}var _iterator9=_createForOfIteratorHelper((_t$groupby=t.groupby)!==null&&_t$groupby!==void 0?_t$groupby:[]),_step9;try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var _s=_step9.value;dims.add(_s)}}catch(err){_iterator9.e(err)}finally{_iterator9.f()}if(dims.size+keys(meas).length===0){return null}return new AggregateNode(parent,dims,meas)}}]);return AggregateNode}(DataFlowNode);var FacetNode=function(_DataFlowNode){_inherits(FacetNode,_DataFlowNode);var _super=_createSuper(FacetNode);function FacetNode(parent,model,name,data){var _this;_classCallCheck(this,FacetNode);_this=_super.call(this,parent);_this.model=model;_this.name=name;_this.data=data;_defineProperty(_assertThisInitialized(_this),"column",void 0);_defineProperty(_assertThisInitialized(_this),"row",void 0);_defineProperty(_assertThisInitialized(_this),"facet",void 0);_defineProperty(_assertThisInitialized(_this),"childModel",void 0);var _iterator=_createForOfIteratorHelper(FACET_CHANNELS),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;var fieldDef=model.facet[channel];if(fieldDef){var bin=fieldDef.bin,sort=fieldDef.sort;_this[channel]=_objectSpread2({name:model.getName("".concat(channel,"_domain")),fields:[vgField(fieldDef)].concat(_toConsumableArray(isBinning(bin)?[vgField(fieldDef,{binSuffix:"end"})]:[]))},isSortField(sort)?{sortField:sort}:isArray(sort)?{sortIndexField:sortArrayIndexField(fieldDef,channel)}:{})}}}catch(err){_iterator.e(err)}finally{_iterator.f()}_this.childModel=model.child;return _this}_createClass(FacetNode,[{key:"hash",value:function hash$1(){var out="Facet";var _iterator2=_createForOfIteratorHelper(FACET_CHANNELS),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var channel=_step2.value;if(this[channel]){out+=" ".concat(channel.charAt(0),":").concat(hash(this[channel]))}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return out}},{key:"dependentFields",value:function dependentFields(){var depFields=new Set(this.fields);var _iterator3=_createForOfIteratorHelper(FACET_CHANNELS),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var channel=_step3.value;if(this[channel]){if(this[channel].sortField){depFields.add(this[channel].sortField.field)}if(this[channel].sortIndexField){depFields.add(this[channel].sortIndexField)}}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return depFields}},{key:"producedFields",value:function producedFields(){return new Set}},{key:"getSource",value:function getSource(){return this.name}},{key:"getChildIndependentFieldsWithStep",value:function getChildIndependentFieldsWithStep(){var childIndependentFieldsWithStep={};var _iterator4=_createForOfIteratorHelper(POSITION_SCALE_CHANNELS),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var channel=_step4.value;var childScaleComponent=this.childModel.component.scales[channel];if(childScaleComponent&&!childScaleComponent.merged){var type=childScaleComponent.get("type");var range=childScaleComponent.get("range");if(hasDiscreteDomain(type)&&isVgRangeStep(range)){var domain=assembleDomain(this.childModel,channel);var field=getFieldFromDomain(domain);if(field){childIndependentFieldsWithStep[channel]=field}else{warn(unknownField(channel))}}}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}return childIndependentFieldsWithStep}},{key:"assembleRowColumnHeaderData",value:function assembleRowColumnHeaderData(channel,crossedDataName,childIndependentFieldsWithStep){var childChannel={row:"y",column:"x"}[channel];var fields=[];var ops=[];var as=[];if(childIndependentFieldsWithStep&&childIndependentFieldsWithStep[childChannel]){if(crossedDataName){fields.push("distinct_".concat(childIndependentFieldsWithStep[childChannel]));ops.push("max")}else{fields.push(childIndependentFieldsWithStep[childChannel]);ops.push("distinct")}as.push("distinct_".concat(childIndependentFieldsWithStep[childChannel]))}var _this$channel=this[channel],sortField=_this$channel.sortField,sortIndexField=_this$channel.sortIndexField;if(sortField){var _sortField$op=sortField.op,op=_sortField$op===void 0?DEFAULT_SORT_OP:_sortField$op,field=sortField.field;fields.push(field);ops.push(op);as.push(vgField(sortField,{forAs:true}))}else if(sortIndexField){fields.push(sortIndexField);ops.push("max");as.push(sortIndexField)}return{name:this[channel].name,source:crossedDataName!==null&&crossedDataName!==void 0?crossedDataName:this.data,transform:[_objectSpread2({type:"aggregate",groupby:this[channel].fields},fields.length?{fields:fields,ops:ops,as:as}:{})]}}},{key:"assembleFacetHeaderData",value:function assembleFacetHeaderData(childIndependentFieldsWithStep){var columns=this.model.layout.columns;var layoutHeaders=this.model.component.layoutHeaders;var data=[];var hasSharedAxis={};var _iterator5=_createForOfIteratorHelper(HEADER_CHANNELS),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var headerChannel=_step5.value;var _iterator6=_createForOfIteratorHelper(HEADER_TYPES),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var _ref;var headerType=_step6.value;var headers=(_ref=layoutHeaders[headerChannel]&&layoutHeaders[headerChannel][headerType])!==null&&_ref!==void 0?_ref:[];var _iterator7=_createForOfIteratorHelper(headers),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var _header$axes;var header=_step7.value;if(((_header$axes=header.axes)===null||_header$axes===void 0?void 0:_header$axes.length)>0){hasSharedAxis[headerChannel]=true;break}}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}if(hasSharedAxis[headerChannel]){var cardinality='length(data("'.concat(this.facet.name,'"))');var stop=headerChannel==="row"?columns?{signal:"ceil(".concat(cardinality," / ").concat(columns,")")}:1:columns?{signal:"min(".concat(cardinality,", ").concat(columns,")")}:{signal:cardinality};data.push({name:"".concat(this.facet.name,"_").concat(headerChannel),transform:[{type:"sequence",start:0,stop:stop}]})}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}var row=hasSharedAxis.row,column=hasSharedAxis.column;if(row||column){data.unshift(this.assembleRowColumnHeaderData("facet",null,childIndependentFieldsWithStep))}return data}},{key:"assemble",value:function assemble(){var data=[];var crossedDataName=null;var childIndependentFieldsWithStep=this.getChildIndependentFieldsWithStep();var column=this.column,row=this.row,facet=this.facet;if(column&&row&&(childIndependentFieldsWithStep.x||childIndependentFieldsWithStep.y)){var _childIndependentFiel,_childIndependentFiel2;crossedDataName="cross_".concat(this.column.name,"_").concat(this.row.name);var fields=[].concat((_childIndependentFiel=childIndependentFieldsWithStep.x)!==null&&_childIndependentFiel!==void 0?_childIndependentFiel:[],(_childIndependentFiel2=childIndependentFieldsWithStep.y)!==null&&_childIndependentFiel2!==void 0?_childIndependentFiel2:[]);var ops=fields.map((function(){return"distinct"}));data.push({name:crossedDataName,source:this.data,transform:[{type:"aggregate",groupby:this.fields,fields:fields,ops:ops}]})}for(var _i=0,_arr=[COLUMN,ROW];_i<_arr.length;_i++){var channel=_arr[_i];if(this[channel]){data.push(this.assembleRowColumnHeaderData(channel,crossedDataName,childIndependentFieldsWithStep))}}if(facet){var facetData=this.assembleFacetHeaderData(childIndependentFieldsWithStep);if(facetData){data.push.apply(data,_toConsumableArray(facetData))}}return data}},{key:"fields",get:function get(){var f=[];var _iterator8=_createForOfIteratorHelper(FACET_CHANNELS),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var _this$channel2;var channel=_step8.value;if((_this$channel2=this[channel])===null||_this$channel2===void 0?void 0:_this$channel2.fields){f.push.apply(f,_toConsumableArray(this[channel].fields))}}}catch(err){_iterator8.e(err)}finally{_iterator8.f()}return f}}]);return FacetNode}(DataFlowNode);function unquote(pattern){if(pattern[0]==="'"&&pattern[pattern.length-1]==="'"||pattern[0]==='"'&&pattern[pattern.length-1]==='"'){return pattern.slice(1,-1)}return pattern}function parseExpression$1(field,parse){var f=accessPathWithDatum(field);if(parse==="number"){return"toNumber(".concat(f,")")}else if(parse==="boolean"){return"toBoolean(".concat(f,")")}else if(parse==="string"){return"toString(".concat(f,")")}else if(parse==="date"){return"toDate(".concat(f,")")}else if(parse==="flatten"){return f}else if(parse.indexOf("date:")===0){var specifier=unquote(parse.slice(5,parse.length));return"timeParse(".concat(f,",'").concat(specifier,"')")}else if(parse.indexOf("utc:")===0){var _specifier=unquote(parse.slice(4,parse.length));return"utcParse(".concat(f,",'").concat(_specifier,"')")}else{warn(unrecognizedParse(parse));return null}}function getImplicitFromFilterTransform(transform){var implicit={};forEachLeaf(transform.filter,(function(filter){if(isFieldPredicate(filter)){var val=null;if(isFieldEqualPredicate(filter)){val=signalRefOrValue(filter.equal)}else if(isFieldLTEPredicate(filter)){val=signalRefOrValue(filter.lte)}else if(isFieldLTPredicate(filter)){val=signalRefOrValue(filter.lt)}else if(isFieldGTPredicate(filter)){val=signalRefOrValue(filter.gt)}else if(isFieldGTEPredicate(filter)){val=signalRefOrValue(filter.gte)}else if(isFieldRangePredicate(filter)){val=filter.range[0]}else if(isFieldOneOfPredicate(filter)){var _filter$oneOf;val=((_filter$oneOf=filter.oneOf)!==null&&_filter$oneOf!==void 0?_filter$oneOf:filter["in"])[0]}if(val){if(isDateTime(val)){implicit[filter.field]="date"}else if(isNumber(val)){implicit[filter.field]="number"}else if(isString(val)){implicit[filter.field]="string"}}if(filter.timeUnit){implicit[filter.field]="date"}}}));return implicit}function getImplicitFromEncoding(model){var implicit={};function add(fieldDef){if(isFieldOrDatumDefForTimeFormat(fieldDef)){implicit[fieldDef.field]="date"}else if(fieldDef.type==="quantitative"&&isMinMaxOp(fieldDef.aggregate)){implicit[fieldDef.field]="number"}else if(accessPathDepth(fieldDef.field)>1){if(!(fieldDef.field in implicit)){implicit[fieldDef.field]="flatten"}}else if(isScaleFieldDef(fieldDef)&&isSortField(fieldDef.sort)&&accessPathDepth(fieldDef.sort.field)>1){if(!(fieldDef.sort.field in implicit)){implicit[fieldDef.sort.field]="flatten"}}}if(isUnitModel(model)||isFacetModel(model)){model.forEachFieldDef((function(fieldDef,channel){if(isTypedFieldDef(fieldDef)){add(fieldDef)}else{var mainChannel=getMainRangeChannel(channel);var mainFieldDef=model.fieldDef(mainChannel);add(_objectSpread2(_objectSpread2({},fieldDef),{},{type:mainFieldDef.type}))}}))}if(isUnitModel(model)){var mark=model.mark,markDef=model.markDef,encoding=model.encoding;if(isPathMark(mark)&&!model.encoding.order){var dimensionChannel=markDef.orient==="horizontal"?"y":"x";var dimensionChannelDef=encoding[dimensionChannel];if(isFieldDef(dimensionChannelDef)&&dimensionChannelDef.type==="quantitative"&&!(dimensionChannelDef.field in implicit)){implicit[dimensionChannelDef.field]="number"}}}return implicit}function getImplicitFromSelection(model){var implicit={};if(isUnitModel(model)&&model.component.selection){var _iterator=_createForOfIteratorHelper(keys(model.component.selection)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var name=_step.value;var selCmpt=model.component.selection[name];var _iterator2=_createForOfIteratorHelper(selCmpt.project.items),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var proj=_step2.value;if(!proj.channel&&accessPathDepth(proj.field)>1){implicit[proj.field]="flatten"}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}return implicit}var ParseNode=function(_DataFlowNode){_inherits(ParseNode,_DataFlowNode);var _super=_createSuper(ParseNode);_createClass(ParseNode,[{key:"clone",value:function clone(){return new ParseNode(null,duplicate(this._parse))}}]);function ParseNode(parent,parse){var _this;_classCallCheck(this,ParseNode);_this=_super.call(this,parent);_defineProperty(_assertThisInitialized(_this),"_parse",void 0);_this._parse=parse;return _this}_createClass(ParseNode,[{key:"hash",value:function hash$1(){return"Parse ".concat(hash(this._parse))}},{key:"merge",value:function merge(other){this._parse=_objectSpread2(_objectSpread2({},this._parse),other.parse);other.remove()}},{key:"assembleFormatParse",value:function assembleFormatParse(){var formatParse={};var _iterator3=_createForOfIteratorHelper(keys(this._parse)),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var field=_step3.value;var p=this._parse[field];if(accessPathDepth(field)===1){formatParse[field]=p}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return formatParse}},{key:"producedFields",value:function producedFields(){return new Set(keys(this._parse))}},{key:"dependentFields",value:function dependentFields(){return new Set(keys(this._parse))}},{key:"assembleTransforms",value:function assembleTransforms(){var _this2=this;var onlyNested=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;return keys(this._parse).filter((function(field){return onlyNested?accessPathDepth(field)>1:true})).map((function(field){var expr=parseExpression$1(field,_this2._parse[field]);if(!expr){return null}var formula={type:"formula",expr:expr,as:removePathFromField(field)};return formula})).filter((function(t){return t!==null}))}},{key:"parse",get:function get(){return this._parse}}],[{key:"makeExplicit",value:function makeExplicit(parent,model,ancestorParse){var explicit={};var data=model.data;if(!isGenerator(data)&&data&&data.format&&data.format.parse){explicit=data.format.parse}return this.makeWithAncestors(parent,explicit,{},ancestorParse)}},{key:"makeWithAncestors",value:function makeWithAncestors(parent,explicit,implicit,ancestorParse){var _iterator4=_createForOfIteratorHelper(keys(implicit)),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var field=_step4.value;var parsedAs=ancestorParse.getWithExplicit(field);if(parsedAs.value!==undefined){if(parsedAs.explicit||parsedAs.value===implicit[field]||parsedAs.value==="derived"||implicit[field]==="flatten"){delete implicit[field]}else{warn(differentParse(field,implicit[field],parsedAs.value))}}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}var _iterator5=_createForOfIteratorHelper(keys(explicit)),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _field=_step5.value;var _parsedAs=ancestorParse.get(_field);if(_parsedAs!==undefined){if(_parsedAs===explicit[_field]){delete explicit[_field]}else{warn(differentParse(_field,explicit[_field],_parsedAs))}}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}var parse=new Split(explicit,implicit);ancestorParse.copyAll(parse);var p={};var _iterator6=_createForOfIteratorHelper(keys(parse.combine())),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var key=_step6.value;var val=parse.get(key);if(val!==null){p[key]=val}}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}if(keys(p).length===0||ancestorParse.parseNothing){return null}return new ParseNode(parent,p)}}]);return ParseNode}(DataFlowNode);var IdentifierNode=function(_DataFlowNode){_inherits(IdentifierNode,_DataFlowNode);var _super=_createSuper(IdentifierNode);_createClass(IdentifierNode,[{key:"clone",value:function clone(){return new IdentifierNode(null)}}]);function IdentifierNode(parent){_classCallCheck(this,IdentifierNode);return _super.call(this,parent)}_createClass(IdentifierNode,[{key:"dependentFields",value:function dependentFields(){return new Set}},{key:"producedFields",value:function producedFields(){return new Set([SELECTION_ID])}},{key:"hash",value:function hash(){return"Identifier"}},{key:"assemble",value:function assemble(){return{type:"identifier",as:SELECTION_ID}}}]);return IdentifierNode}(DataFlowNode);var GraticuleNode=function(_DataFlowNode){_inherits(GraticuleNode,_DataFlowNode);var _super=_createSuper(GraticuleNode);_createClass(GraticuleNode,[{key:"clone",value:function clone(){return new GraticuleNode(null,this.params)}}]);function GraticuleNode(parent,params){var _this;_classCallCheck(this,GraticuleNode);_this=_super.call(this,parent);_this.params=params;return _this}_createClass(GraticuleNode,[{key:"dependentFields",value:function dependentFields(){return new Set}},{key:"producedFields",value:function producedFields(){return undefined}},{key:"hash",value:function hash$1(){return"Graticule ".concat(hash(this.params))}},{key:"assemble",value:function assemble(){return _objectSpread2({type:"graticule"},this.params===true?{}:this.params)}}]);return GraticuleNode}(DataFlowNode);var SequenceNode=function(_DataFlowNode){_inherits(SequenceNode,_DataFlowNode);var _super=_createSuper(SequenceNode);_createClass(SequenceNode,[{key:"clone",value:function clone(){return new SequenceNode(null,this.params)}}]);function SequenceNode(parent,params){var _this;_classCallCheck(this,SequenceNode);_this=_super.call(this,parent);_this.params=params;return _this}_createClass(SequenceNode,[{key:"dependentFields",value:function dependentFields(){return new Set}},{key:"producedFields",value:function producedFields(){var _this$params$as;return new Set([(_this$params$as=this.params.as)!==null&&_this$params$as!==void 0?_this$params$as:"data"])}},{key:"hash",value:function hash$1(){return"Hash ".concat(hash(this.params))}},{key:"assemble",value:function assemble(){return _objectSpread2({type:"sequence"},this.params)}}]);return SequenceNode}(DataFlowNode);var SourceNode=function(_DataFlowNode){_inherits(SourceNode,_DataFlowNode);var _super=_createSuper(SourceNode);function SourceNode(data){var _data;var _this;_classCallCheck(this,SourceNode);_this=_super.call(this,null);_defineProperty(_assertThisInitialized(_this),"_data",void 0);_defineProperty(_assertThisInitialized(_this),"_name",void 0);_defineProperty(_assertThisInitialized(_this),"_generator",void 0);data=(_data=data)!==null&&_data!==void 0?_data:{name:"source"};var format;if(!isGenerator(data)){format=data.format?_objectSpread2({},omit(data.format,["parse"])):{}}if(isInlineData(data)){_this._data={values:data.values}}else if(isUrlData(data)){_this._data={url:data.url};if(!format.type){var defaultExtension=/(?:\.([^.]+))?$/.exec(data.url)[1];if(!contains(["json","csv","tsv","dsv","topojson"],defaultExtension)){defaultExtension="json"}format.type=defaultExtension}}else if(isSphereGenerator(data)){_this._data={values:[{type:"Sphere"}]}}else if(isNamedData(data)||isGenerator(data)){_this._data={}}_this._generator=isGenerator(data);if(data.name){_this._name=data.name}if(format&&!isEmpty(format)){_this._data.format=format}return _this}_createClass(SourceNode,[{key:"dependentFields",value:function dependentFields(){return new Set}},{key:"producedFields",value:function producedFields(){return undefined}},{key:"hasName",value:function hasName(){return!!this._name}},{key:"remove",value:function remove(){throw new Error("Source nodes are roots and cannot be removed.")}},{key:"hash",value:function hash(){throw new Error("Cannot hash sources")}},{key:"assemble",value:function assemble(){return _objectSpread2(_objectSpread2({name:this._name},this._data),{},{transform:[]})}},{key:"data",get:function get(){return this._data}},{key:"isGenerator",get:function get(){return this._generator}},{key:"dataName",get:function get(){return this._name},set:function set(name){this._name=name}},{key:"parent",set:function set(parent){throw new Error("Source nodes have to be roots.")}}]);return SourceNode}(DataFlowNode);function isDataSourceNode(node){return node instanceof SourceNode||node instanceof GraticuleNode||node instanceof SequenceNode}var _modified=new WeakMap;var Optimizer=function(){function Optimizer(){_classCallCheck(this,Optimizer);_modified.set(this,{writable:true,value:void 0});_classPrivateFieldSet(this,_modified,false)}_createClass(Optimizer,[{key:"setModified",value:function setModified(){_classPrivateFieldSet(this,_modified,true)}},{key:"modifiedFlag",get:function get(){return _classPrivateFieldGet(this,_modified)}}]);return Optimizer}();var BottomUpOptimizer=function(_Optimizer){_inherits(BottomUpOptimizer,_Optimizer);var _super=_createSuper(BottomUpOptimizer);function BottomUpOptimizer(){_classCallCheck(this,BottomUpOptimizer);return _super.apply(this,arguments)}_createClass(BottomUpOptimizer,[{key:"getNodeDepths",value:function getNodeDepths(node,depth,depths){depths.set(node,depth);var _iterator=_createForOfIteratorHelper(node.children),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var child=_step.value;this.getNodeDepths(child,depth+1,depths)}}catch(err){_iterator.e(err)}finally{_iterator.f()}return depths}},{key:"optimize",value:function optimize(node){var depths=this.getNodeDepths(node,0,new Map);var topologicalSort=_toConsumableArray(depths.entries()).sort((function(a,b){return b[1]-a[1]}));var _iterator2=_createForOfIteratorHelper(topologicalSort),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var tuple=_step2.value;this.run(tuple[0])}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return this.modifiedFlag}}]);return BottomUpOptimizer}(Optimizer);var TopDownOptimizer=function(_Optimizer2){_inherits(TopDownOptimizer,_Optimizer2);var _super2=_createSuper(TopDownOptimizer);function TopDownOptimizer(){_classCallCheck(this,TopDownOptimizer);return _super2.apply(this,arguments)}_createClass(TopDownOptimizer,[{key:"optimize",value:function optimize(node){this.run(node);var _iterator3=_createForOfIteratorHelper(node.children),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var child=_step3.value;this.optimize(child)}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return this.modifiedFlag}}]);return TopDownOptimizer}(Optimizer);var MergeIdenticalNodes=function(_TopDownOptimizer){_inherits(MergeIdenticalNodes,_TopDownOptimizer);var _super=_createSuper(MergeIdenticalNodes);function MergeIdenticalNodes(){_classCallCheck(this,MergeIdenticalNodes);return _super.apply(this,arguments)}_createClass(MergeIdenticalNodes,[{key:"mergeNodes",value:function mergeNodes(parent,nodes){var mergedNode=nodes.shift();var _iterator=_createForOfIteratorHelper(nodes),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var node=_step.value;parent.removeChild(node);node.parent=mergedNode;node.remove()}}catch(err){_iterator.e(err)}finally{_iterator.f()}}},{key:"run",value:function run(node){var hashes=node.children.map((function(x){return x.hash()}));var buckets={};for(var i=0;i<hashes.length;i++){if(buckets[hashes[i]]===undefined){buckets[hashes[i]]=[node.children[i]]}else{buckets[hashes[i]].push(node.children[i])}}var _iterator2=_createForOfIteratorHelper(keys(buckets)),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var k=_step2.value;if(buckets[k].length>1){this.setModified();this.mergeNodes(node,buckets[k])}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}}]);return MergeIdenticalNodes}(TopDownOptimizer);var RemoveUnnecessaryIdentifierNodes=function(_TopDownOptimizer2){_inherits(RemoveUnnecessaryIdentifierNodes,_TopDownOptimizer2);var _super2=_createSuper(RemoveUnnecessaryIdentifierNodes);function RemoveUnnecessaryIdentifierNodes(model){var _this;_classCallCheck(this,RemoveUnnecessaryIdentifierNodes);_this=_super2.call(this);_defineProperty(_assertThisInitialized(_this),"requiresSelectionId",void 0);_this.requiresSelectionId=model&&requiresSelectionId(model);return _this}_createClass(RemoveUnnecessaryIdentifierNodes,[{key:"run",value:function run(node){if(node instanceof IdentifierNode){if(!(this.requiresSelectionId&&(isDataSourceNode(node.parent)||node.parent instanceof AggregateNode||node.parent instanceof ParseNode))){this.setModified();node.remove()}}}}]);return RemoveUnnecessaryIdentifierNodes}(TopDownOptimizer);var RemoveDuplicateTimeUnits=function(_Optimizer){_inherits(RemoveDuplicateTimeUnits,_Optimizer);var _super3=_createSuper(RemoveDuplicateTimeUnits);function RemoveDuplicateTimeUnits(){_classCallCheck(this,RemoveDuplicateTimeUnits);return _super3.apply(this,arguments)}_createClass(RemoveDuplicateTimeUnits,[{key:"optimize",value:function optimize(node){this.run(node,new Set);return this.modifiedFlag}},{key:"run",value:function run(node,timeUnitFields){var producedFields=new Set;if(node instanceof TimeUnitNode){producedFields=node.producedFields();if(hasIntersection(producedFields,timeUnitFields)){this.setModified();node.removeFormulas(timeUnitFields);if(node.producedFields.length===0){node.remove()}}}var _iterator3=_createForOfIteratorHelper(node.children),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var child=_step3.value;this.run(child,new Set([].concat(_toConsumableArray(timeUnitFields),_toConsumableArray(producedFields))))}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}]);return RemoveDuplicateTimeUnits}(Optimizer);var RemoveUnnecessaryOutputNodes=function(_TopDownOptimizer3){_inherits(RemoveUnnecessaryOutputNodes,_TopDownOptimizer3);var _super4=_createSuper(RemoveUnnecessaryOutputNodes);function RemoveUnnecessaryOutputNodes(){_classCallCheck(this,RemoveUnnecessaryOutputNodes);return _super4.call(this)}_createClass(RemoveUnnecessaryOutputNodes,[{key:"run",value:function run(node){if(node instanceof OutputNode&&!node.isRequired()){this.setModified();node.remove()}}}]);return RemoveUnnecessaryOutputNodes}(TopDownOptimizer);var MoveParseUp=function(_BottomUpOptimizer){_inherits(MoveParseUp,_BottomUpOptimizer);var _super5=_createSuper(MoveParseUp);function MoveParseUp(){_classCallCheck(this,MoveParseUp);return _super5.apply(this,arguments)}_createClass(MoveParseUp,[{key:"run",value:function run(node){if(isDataSourceNode(node)){return}if(node.numChildren()>1){return}var _iterator4=_createForOfIteratorHelper(node.children),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var child=_step4.value;if(child instanceof ParseNode){if(node instanceof ParseNode){this.setModified();node.merge(child)}else{if(fieldIntersection(node.producedFields(),child.dependentFields())){continue}this.setModified();child.swapWithParent()}}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}return}}]);return MoveParseUp}(BottomUpOptimizer);var MergeParse=function(_BottomUpOptimizer2){_inherits(MergeParse,_BottomUpOptimizer2);var _super6=_createSuper(MergeParse);function MergeParse(){_classCallCheck(this,MergeParse);return _super6.apply(this,arguments)}_createClass(MergeParse,[{key:"run",value:function run(node){var originalChildren=_toConsumableArray(node.children);var parseChildren=node.children.filter((function(child){return child instanceof ParseNode}));if(node.numChildren()>1&&parseChildren.length>=1){var commonParse={};var conflictingParse=new Set;var _iterator5=_createForOfIteratorHelper(parseChildren),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var parseNode=_step5.value;var parse=parseNode.parse;var _iterator9=_createForOfIteratorHelper(keys(parse)),_step9;try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var k=_step9.value;if(!(k in commonParse)){commonParse[k]=parse[k]}else if(commonParse[k]!==parse[k]){conflictingParse.add(k)}}}catch(err){_iterator9.e(err)}finally{_iterator9.f()}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}var _iterator6=_createForOfIteratorHelper(conflictingParse),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var field=_step6.value;delete commonParse[field]}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}if(!isEmpty(commonParse)){this.setModified();var mergedParseNode=new ParseNode(node,commonParse);var _iterator7=_createForOfIteratorHelper(originalChildren),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var childNode=_step7.value;if(childNode instanceof ParseNode){var _iterator8=_createForOfIteratorHelper(keys(commonParse)),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var key=_step8.value;delete childNode.parse[key]}}catch(err){_iterator8.e(err)}finally{_iterator8.f()}}node.removeChild(childNode);childNode.parent=mergedParseNode;if(childNode instanceof ParseNode&&keys(childNode.parse).length===0){childNode.remove()}}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}}}}}]);return MergeParse}(BottomUpOptimizer);var RemoveUnusedSubtrees=function(_BottomUpOptimizer3){_inherits(RemoveUnusedSubtrees,_BottomUpOptimizer3);var _super7=_createSuper(RemoveUnusedSubtrees);function RemoveUnusedSubtrees(){_classCallCheck(this,RemoveUnusedSubtrees);return _super7.apply(this,arguments)}_createClass(RemoveUnusedSubtrees,[{key:"run",value:function run(node){if(node instanceof OutputNode||node.numChildren()>0||node instanceof FacetNode);else{this.setModified();node.remove()}}}]);return RemoveUnusedSubtrees}(BottomUpOptimizer);var MergeTimeUnits=function(_BottomUpOptimizer4){_inherits(MergeTimeUnits,_BottomUpOptimizer4);var _super8=_createSuper(MergeTimeUnits);function MergeTimeUnits(){_classCallCheck(this,MergeTimeUnits);return _super8.apply(this,arguments)}_createClass(MergeTimeUnits,[{key:"run",value:function run(node){var timeUnitChildren=node.children.filter((function(x){return x instanceof TimeUnitNode}));var combination=timeUnitChildren.pop();var _iterator10=_createForOfIteratorHelper(timeUnitChildren),_step10;try{for(_iterator10.s();!(_step10=_iterator10.n()).done;){var timeUnit=_step10.value;this.setModified();combination.merge(timeUnit)}}catch(err){_iterator10.e(err)}finally{_iterator10.f()}}}]);return MergeTimeUnits}(BottomUpOptimizer);var MergeAggregates=function(_BottomUpOptimizer5){_inherits(MergeAggregates,_BottomUpOptimizer5);var _super9=_createSuper(MergeAggregates);function MergeAggregates(){_classCallCheck(this,MergeAggregates);return _super9.apply(this,arguments)}_createClass(MergeAggregates,[{key:"run",value:function run(node){var aggChildren=node.children.filter((function(child){return child instanceof AggregateNode}));var groupedAggregates={};var _iterator11=_createForOfIteratorHelper(aggChildren),_step11;try{for(_iterator11.s();!(_step11=_iterator11.n()).done;){var agg=_step11.value;var groupBys=hash(agg.groupBy);if(!(groupBys in groupedAggregates)){groupedAggregates[groupBys]=[]}groupedAggregates[groupBys].push(agg)}}catch(err){_iterator11.e(err)}finally{_iterator11.f()}var _iterator12=_createForOfIteratorHelper(keys(groupedAggregates)),_step12;try{for(_iterator12.s();!(_step12=_iterator12.n()).done;){var group=_step12.value;var mergeableAggs=groupedAggregates[group];if(mergeableAggs.length>1){var mergedAggs=mergeableAggs.pop();var _iterator13=_createForOfIteratorHelper(mergeableAggs),_step13;try{for(_iterator13.s();!(_step13=_iterator13.n()).done;){var _agg=_step13.value;if(mergedAggs.merge(_agg)){node.removeChild(_agg);_agg.parent=mergedAggs;_agg.remove();this.setModified()}}}catch(err){_iterator13.e(err)}finally{_iterator13.f()}}}}catch(err){_iterator12.e(err)}finally{_iterator12.f()}}}]);return MergeAggregates}(BottomUpOptimizer);var MergeBins=function(_BottomUpOptimizer6){_inherits(MergeBins,_BottomUpOptimizer6);var _super10=_createSuper(MergeBins);function MergeBins(model){var _this2;_classCallCheck(this,MergeBins);_this2=_super10.call(this);_this2.model=model;return _this2}_createClass(MergeBins,[{key:"run",value:function run(node){var moveBinsUp=!(isDataSourceNode(node)||node instanceof FilterNode||node instanceof ParseNode||node instanceof IdentifierNode);var promotableBins=[];var remainingBins=[];var _iterator14=_createForOfIteratorHelper(node.children),_step14;try{for(_iterator14.s();!(_step14=_iterator14.n()).done;){var child=_step14.value;if(child instanceof BinNode){if(moveBinsUp&&!fieldIntersection(node.producedFields(),child.dependentFields())){promotableBins.push(child)}else{remainingBins.push(child)}}}}catch(err){_iterator14.e(err)}finally{_iterator14.f()}if(promotableBins.length>0){var promotedBin=promotableBins.pop();var _iterator15=_createForOfIteratorHelper(promotableBins),_step15;try{for(_iterator15.s();!(_step15=_iterator15.n()).done;){var bin=_step15.value;promotedBin.merge(bin,this.model.renameSignal.bind(this.model))}}catch(err){_iterator15.e(err)}finally{_iterator15.f()}this.setModified();if(node instanceof BinNode){node.merge(promotedBin,this.model.renameSignal.bind(this.model))}else{promotedBin.swapWithParent()}}if(remainingBins.length>1){var remainingBin=remainingBins.pop();var _iterator16=_createForOfIteratorHelper(remainingBins),_step16;try{for(_iterator16.s();!(_step16=_iterator16.n()).done;){var _bin=_step16.value;remainingBin.merge(_bin,this.model.renameSignal.bind(this.model))}}catch(err){_iterator16.e(err)}finally{_iterator16.f()}this.setModified()}}}]);return MergeBins}(BottomUpOptimizer);var MergeOutputs=function(_BottomUpOptimizer7){_inherits(MergeOutputs,_BottomUpOptimizer7);var _super11=_createSuper(MergeOutputs);function MergeOutputs(){_classCallCheck(this,MergeOutputs);return _super11.apply(this,arguments)}_createClass(MergeOutputs,[{key:"run",value:function run(node){var children=_toConsumableArray(node.children);var hasOutputChild=some(children,(function(child){return child instanceof OutputNode}));if(!hasOutputChild||node.numChildren()<=1){return}var otherChildren=[];var mainOutput;var _iterator17=_createForOfIteratorHelper(children),_step17;try{for(_iterator17.s();!(_step17=_iterator17.n()).done;){var _child=_step17.value;if(_child instanceof OutputNode){var lastOutput=_child;while(lastOutput.numChildren()===1){var _lastOutput$children=_slicedToArray(lastOutput.children,1),theChild=_lastOutput$children[0];if(theChild instanceof OutputNode){lastOutput=theChild}else{break}}otherChildren.push.apply(otherChildren,_toConsumableArray(lastOutput.children));if(mainOutput){node.removeChild(_child);_child.parent=mainOutput.parent;mainOutput.parent.removeChild(mainOutput);mainOutput.parent=lastOutput;this.setModified()}else{mainOutput=lastOutput}}else{otherChildren.push(_child)}}}catch(err){_iterator17.e(err)}finally{_iterator17.f()}if(otherChildren.length){this.setModified();var _iterator18=_createForOfIteratorHelper(otherChildren),_step18;try{for(_iterator18.s();!(_step18=_iterator18.n()).done;){var child=_step18.value;child.parent.removeChild(child);child.parent=mainOutput}}catch(err){_iterator18.e(err)}finally{_iterator18.f()}}}}]);return MergeOutputs}(BottomUpOptimizer);var JoinAggregateTransformNode=function(_DataFlowNode){_inherits(JoinAggregateTransformNode,_DataFlowNode);var _super=_createSuper(JoinAggregateTransformNode);_createClass(JoinAggregateTransformNode,[{key:"clone",value:function clone(){return new JoinAggregateTransformNode(null,duplicate(this.transform))}}]);function JoinAggregateTransformNode(parent,transform){var _this;_classCallCheck(this,JoinAggregateTransformNode);_this=_super.call(this,parent);_this.transform=transform;return _this}_createClass(JoinAggregateTransformNode,[{key:"addDimensions",value:function addDimensions(fields){this.transform.groupby=unique(this.transform.groupby.concat(fields),(function(d){return d}))}},{key:"dependentFields",value:function dependentFields(){var out=new Set;if(this.transform.groupby){this.transform.groupby.forEach(out.add,out)}this.transform.joinaggregate.map((function(w){return w.field})).filter((function(f){return f!==undefined})).forEach(out.add,out);return out}},{key:"producedFields",value:function producedFields(){return new Set(this.transform.joinaggregate.map(this.getDefaultName))}},{key:"getDefaultName",value:function getDefaultName(joinAggregateFieldDef){var _joinAggregateFieldDe;return(_joinAggregateFieldDe=joinAggregateFieldDef.as)!==null&&_joinAggregateFieldDe!==void 0?_joinAggregateFieldDe:vgField(joinAggregateFieldDef)}},{key:"hash",value:function hash$1(){return"JoinAggregateTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var fields=[];var ops=[];var as=[];var _iterator=_createForOfIteratorHelper(this.transform.joinaggregate),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var joinaggregate=_step.value;ops.push(joinaggregate.op);as.push(this.getDefaultName(joinaggregate));fields.push(joinaggregate.field===undefined?null:joinaggregate.field)}}catch(err){_iterator.e(err)}finally{_iterator.f()}var groupby=this.transform.groupby;return _objectSpread2({type:"joinaggregate",as:as,ops:ops,fields:fields},groupby!==undefined?{groupby:groupby}:{})}}]);return JoinAggregateTransformNode}(DataFlowNode);function getStackByFields(model){return model.stack.stackBy.reduce((function(fields,by){var fieldDef=by.fieldDef;var _field=vgField(fieldDef);if(_field){fields.push(_field)}return fields}),[])}function isValidAsArray(as){return isArray(as)&&as.every((function(s){return isString(s)}))&&as.length>1}var StackNode=function(_DataFlowNode){_inherits(StackNode,_DataFlowNode);var _super=_createSuper(StackNode);_createClass(StackNode,[{key:"clone",value:function clone(){return new StackNode(null,duplicate(this._stack))}}]);function StackNode(parent,stack){var _this;_classCallCheck(this,StackNode);_this=_super.call(this,parent);_defineProperty(_assertThisInitialized(_this),"_stack",void 0);_this._stack=stack;return _this}_createClass(StackNode,[{key:"addDimensions",value:function addDimensions(fields){var _this$_stack$facetby;(_this$_stack$facetby=this._stack.facetby).push.apply(_this$_stack$facetby,_toConsumableArray(fields))}},{key:"dependentFields",value:function dependentFields(){var out=new Set;out.add(this._stack.stackField);this.getGroupbyFields().forEach(out.add,out);this._stack.facetby.forEach(out.add,out);this._stack.sort.field.forEach(out.add,out);return out}},{key:"producedFields",value:function producedFields(){return new Set(this._stack.as)}},{key:"hash",value:function hash$1(){return"Stack ".concat(hash(this._stack))}},{key:"getGroupbyFields",value:function getGroupbyFields(){var _this$_stack=this._stack,dimensionFieldDef=_this$_stack.dimensionFieldDef,impute=_this$_stack.impute,groupby=_this$_stack.groupby;if(dimensionFieldDef){if(dimensionFieldDef.bin){if(impute){return[vgField(dimensionFieldDef,{binSuffix:"mid"})]}return[vgField(dimensionFieldDef,{}),vgField(dimensionFieldDef,{binSuffix:"end"})]}return[vgField(dimensionFieldDef)]}return groupby!==null&&groupby!==void 0?groupby:[]}},{key:"assemble",value:function assemble(){var transform=[];var _this$_stack2=this._stack,facetby=_this$_stack2.facetby,dimensionFieldDef=_this$_stack2.dimensionFieldDef,field=_this$_stack2.stackField,stackby=_this$_stack2.stackby,sort=_this$_stack2.sort,offset=_this$_stack2.offset,impute=_this$_stack2.impute,as=_this$_stack2.as;if(impute&&dimensionFieldDef){var _dimensionFieldDef$ba=dimensionFieldDef.band,band=_dimensionFieldDef$ba===void 0?.5:_dimensionFieldDef$ba,bin=dimensionFieldDef.bin;if(bin){transform.push({type:"formula",expr:"".concat(band,"*")+vgField(dimensionFieldDef,{expr:"datum"})+"+".concat(1-band,"*")+vgField(dimensionFieldDef,{expr:"datum",binSuffix:"end"}),as:vgField(dimensionFieldDef,{binSuffix:"mid",forAs:true})})}transform.push({type:"impute",field:field,groupby:[].concat(_toConsumableArray(stackby),_toConsumableArray(facetby)),key:vgField(dimensionFieldDef,{binSuffix:"mid"}),method:"value",value:0})}transform.push({type:"stack",groupby:[].concat(_toConsumableArray(this.getGroupbyFields()),_toConsumableArray(facetby)),field:field,sort:sort,as:as,offset:offset});return transform}},{key:"stack",get:function get(){return this._stack}}],[{key:"makeFromTransform",value:function makeFromTransform(parent,stackTransform){var stack=stackTransform.stack,groupby=stackTransform.groupby,as=stackTransform.as,_stackTransform$offse=stackTransform.offset,offset=_stackTransform$offse===void 0?"zero":_stackTransform$offse;var sortFields=[];var sortOrder=[];if(stackTransform.sort!==undefined){var _iterator=_createForOfIteratorHelper(stackTransform.sort),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var sortField=_step.value;sortFields.push(sortField.field);sortOrder.push(getFirstDefined(sortField.order,"ascending"))}}catch(err){_iterator.e(err)}finally{_iterator.f()}}var sort={field:sortFields,order:sortOrder};var normalizedAs;if(isValidAsArray(as)){normalizedAs=as}else if(isString(as)){normalizedAs=[as,as+"_end"]}else{normalizedAs=[stackTransform.stack+"_start",stackTransform.stack+"_end"]}return new StackNode(parent,{stackField:stack,groupby:groupby,offset:offset,sort:sort,facetby:[],as:normalizedAs})}},{key:"makeFromEncoding",value:function makeFromEncoding(parent,model){var stackProperties=model.stack;var encoding=model.encoding;if(!stackProperties){return null}var groupbyChannel=stackProperties.groupbyChannel,fieldChannel=stackProperties.fieldChannel,offset=stackProperties.offset,impute=stackProperties.impute;var dimensionFieldDef;if(groupbyChannel){var cDef=encoding[groupbyChannel];dimensionFieldDef=getFieldDef(cDef)}var stackby=getStackByFields(model);var orderDef=model.encoding.order;var sort;if(isArray(orderDef)||isFieldDef(orderDef)){sort=sortParams(orderDef)}else{sort=stackby.reduce((function(s,field){s.field.push(field);s.order.push(fieldChannel==="y"?"descending":"ascending");return s}),{field:[],order:[]})}return new StackNode(parent,{dimensionFieldDef:dimensionFieldDef,stackField:model.vgField(fieldChannel),facetby:[],stackby:stackby,sort:sort,offset:offset,impute:impute,as:[model.vgField(fieldChannel,{suffix:"start",forAs:true}),model.vgField(fieldChannel,{suffix:"end",forAs:true})]})}}]);return StackNode}(DataFlowNode);var WindowTransformNode=function(_DataFlowNode){_inherits(WindowTransformNode,_DataFlowNode);var _super=_createSuper(WindowTransformNode);_createClass(WindowTransformNode,[{key:"clone",value:function clone(){return new WindowTransformNode(null,duplicate(this.transform))}}]);function WindowTransformNode(parent,transform){var _this;_classCallCheck(this,WindowTransformNode);_this=_super.call(this,parent);_this.transform=transform;return _this}_createClass(WindowTransformNode,[{key:"addDimensions",value:function addDimensions(fields){this.transform.groupby=unique(this.transform.groupby.concat(fields),(function(d){return d}))}},{key:"dependentFields",value:function dependentFields(){var _this$transform$group,_this$transform$sort;var out=new Set;((_this$transform$group=this.transform.groupby)!==null&&_this$transform$group!==void 0?_this$transform$group:[]).forEach(out.add,out);((_this$transform$sort=this.transform.sort)!==null&&_this$transform$sort!==void 0?_this$transform$sort:[]).forEach((function(m){return out.add(m.field)}));this.transform.window.map((function(w){return w.field})).filter((function(f){return f!==undefined})).forEach(out.add,out);return out}},{key:"producedFields",value:function producedFields(){return new Set(this.transform.window.map(this.getDefaultName))}},{key:"getDefaultName",value:function getDefaultName(windowFieldDef){var _windowFieldDef$as;return(_windowFieldDef$as=windowFieldDef.as)!==null&&_windowFieldDef$as!==void 0?_windowFieldDef$as:vgField(windowFieldDef)}},{key:"hash",value:function hash$1(){return"WindowTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var fields=[];var ops=[];var as=[];var params=[];var _iterator=_createForOfIteratorHelper(this.transform.window),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var window=_step.value;ops.push(window.op);as.push(this.getDefaultName(window));params.push(window.param===undefined?null:window.param);fields.push(window.field===undefined?null:window.field)}}catch(err){_iterator.e(err)}finally{_iterator.f()}var frame=this.transform.frame;var groupby=this.transform.groupby;if(frame&&frame[0]===null&&frame[1]===null&&ops.every((function(o){return isAggregateOp(o)}))){return _objectSpread2({type:"joinaggregate",as:as,ops:ops,fields:fields},groupby!==undefined?{groupby:groupby}:{})}var sortFields=[];var sortOrder=[];if(this.transform.sort!==undefined){var _iterator2=_createForOfIteratorHelper(this.transform.sort),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _sortField$order;var sortField=_step2.value;sortFields.push(sortField.field);sortOrder.push((_sortField$order=sortField.order)!==null&&_sortField$order!==void 0?_sortField$order:"ascending")}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}var sort={field:sortFields,order:sortOrder};var ignorePeers=this.transform.ignorePeers;return _objectSpread2(_objectSpread2(_objectSpread2({type:"window",params:params,as:as,ops:ops,fields:fields,sort:sort},ignorePeers!==undefined?{ignorePeers:ignorePeers}:{}),groupby!==undefined?{groupby:groupby}:{}),frame!==undefined?{frame:frame}:{})}}]);return WindowTransformNode}(DataFlowNode);function cloneSubtree(facet){function clone(node){if(!(node instanceof FacetNode)){var copy=node.clone();if(copy instanceof OutputNode){var newName=FACET_SCALE_PREFIX+copy.getSource();copy.setSource(newName);facet.model.component.data.outputNodes[newName]=copy}else if(copy instanceof AggregateNode||copy instanceof StackNode||copy instanceof WindowTransformNode||copy instanceof JoinAggregateTransformNode){copy.addDimensions(facet.fields)}var _iterator=_createForOfIteratorHelper(node.children.flatMap(clone)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var n=_step.value;n.parent=copy}}catch(err){_iterator.e(err)}finally{_iterator.f()}return[copy]}return node.children.flatMap(clone)}return clone}function moveFacetDown(node){if(node instanceof FacetNode){if(node.numChildren()===1&&!(node.children[0]instanceof OutputNode)){var child=node.children[0];if(child instanceof AggregateNode||child instanceof StackNode||child instanceof WindowTransformNode||child instanceof JoinAggregateTransformNode){child.addDimensions(node.fields)}child.swapWithParent();moveFacetDown(node)}else{var facetMain=node.model.component.data.main;moveMainDownToFacet(facetMain);var cloner=cloneSubtree(node);var copy=node.children.map(cloner).flat();var _iterator2=_createForOfIteratorHelper(copy),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var c=_step2.value;c.parent=facetMain}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}}else{node.children.map(moveFacetDown)}}function moveMainDownToFacet(node){if(node instanceof OutputNode&&node.type===DataSourceType.Main){if(node.numChildren()===1){var child=node.children[0];if(!(child instanceof FacetNode)){child.swapWithParent();moveMainDownToFacet(node)}}}}var FACET_SCALE_PREFIX="scale_";var MAX_OPTIMIZATION_RUNS=5;function checkLinks(nodes){var _iterator=_createForOfIteratorHelper(nodes),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var node=_step.value;var _iterator2=_createForOfIteratorHelper(node.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;if(child.parent!==node){return false}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}if(!checkLinks(node.children)){return false}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return true}function runOptimizer(optimizer,nodes){var modified=false;var _iterator3=_createForOfIteratorHelper(nodes),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var node=_step3.value;modified=optimizer.optimize(node)||modified}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return modified}function optimizationDataflowHelper(dataComponent,model,firstPass){var roots=dataComponent.sources;var modified=false;modified=runOptimizer(new RemoveUnnecessaryOutputNodes,roots)||modified;modified=runOptimizer(new RemoveUnnecessaryIdentifierNodes(model),roots)||modified;roots=roots.filter((function(r){return r.numChildren()>0}));modified=runOptimizer(new RemoveUnusedSubtrees,roots)||modified;roots=roots.filter((function(r){return r.numChildren()>0}));if(!firstPass){modified=runOptimizer(new MoveParseUp,roots)||modified;modified=runOptimizer(new MergeBins(model),roots)||modified;modified=runOptimizer(new RemoveDuplicateTimeUnits,roots)||modified;modified=runOptimizer(new MergeParse,roots)||modified;modified=runOptimizer(new MergeAggregates,roots)||modified;modified=runOptimizer(new MergeTimeUnits,roots)||modified;modified=runOptimizer(new MergeIdenticalNodes,roots)||modified;modified=runOptimizer(new MergeOutputs,roots)||modified}dataComponent.sources=roots;return modified}function optimizeDataflow(data,model){checkLinks(data.sources);var firstPassCounter=0;var secondPassCounter=0;for(var i=0;i<MAX_OPTIMIZATION_RUNS;i++){if(!optimizationDataflowHelper(data,model,true)){break}firstPassCounter++}data.sources.map(moveFacetDown);for(var _i=0;_i<MAX_OPTIMIZATION_RUNS;_i++){if(!optimizationDataflowHelper(data,model,false)){break}secondPassCounter++}checkLinks(data.sources);if(Math.max(firstPassCounter,secondPassCounter)===MAX_OPTIMIZATION_RUNS){warn("Maximum optimization runs(".concat(MAX_OPTIMIZATION_RUNS,") reached."))}}var SignalRefWrapper=function(){function SignalRefWrapper(exprGenerator){_classCallCheck(this,SignalRefWrapper);_defineProperty(this,"signal",void 0);Object.defineProperty(this,"signal",{enumerable:true,get:exprGenerator})}_createClass(SignalRefWrapper,null,[{key:"fromName",value:function fromName(rename,signalName){return new SignalRefWrapper((function(){return rename(signalName)}))}}]);return SignalRefWrapper}();function parseScaleDomain(model){if(isUnitModel(model)){parseUnitScaleDomain(model)}else{parseNonUnitScaleDomain(model)}}function parseUnitScaleDomain(model){var localScaleComponents=model.component.scales;var _iterator=_createForOfIteratorHelper(keys(localScaleComponents)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;var domains=parseDomainForChannel(model,channel);var localScaleCmpt=localScaleComponents[channel];localScaleCmpt.setWithExplicit("domains",domains);parseSelectionDomain(model,channel);if(model.component.data.isFaceted){var facetParent=model;while(!isFacetModel(facetParent)&&facetParent.parent){facetParent=facetParent.parent}var resolve=facetParent.component.resolve.scale[channel];if(resolve==="shared"){var _iterator2=_createForOfIteratorHelper(domains.value),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var domain=_step2.value;if(isDataRefDomain(domain)){domain.data=FACET_SCALE_PREFIX+domain.data.replace(FACET_SCALE_PREFIX,"")}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}function parseNonUnitScaleDomain(model){var _iterator3=_createForOfIteratorHelper(model.children),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var child=_step3.value;parseScaleDomain(child)}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}var localScaleComponents=model.component.scales;var _iterator4=_createForOfIteratorHelper(keys(localScaleComponents)),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var channel=_step4.value;var domains=void 0;var selectionExtent=null;var _iterator5=_createForOfIteratorHelper(model.children),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _child=_step5.value;var childComponent=_child.component.scales[channel];if(childComponent){if(domains===undefined){domains=childComponent.getWithExplicit("domains")}else{domains=mergeValuesWithExplicit(domains,childComponent.getWithExplicit("domains"),"domains","scale",domainsTieBreaker)}var se=childComponent.get("selectionExtent");if(selectionExtent&&se&&selectionExtent.selection!==se.selection){warn(NEEDS_SAME_SELECTION)}selectionExtent=se}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}localScaleComponents[channel].setWithExplicit("domains",domains);if(selectionExtent){localScaleComponents[channel].set("selectionExtent",selectionExtent,true)}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}function normalizeUnaggregatedDomain(domain,fieldDef,scaleType,scaleConfig){if(domain==="unaggregated"){var _canUseUnaggregatedDo=canUseUnaggregatedDomain(fieldDef,scaleType),valid=_canUseUnaggregatedDo.valid,reason=_canUseUnaggregatedDo.reason;if(!valid){warn(reason);return undefined}}else if(domain===undefined&&scaleConfig.useUnaggregatedDomain){var _canUseUnaggregatedDo2=canUseUnaggregatedDomain(fieldDef,scaleType),_valid=_canUseUnaggregatedDo2.valid;if(_valid){return"unaggregated"}}return domain}function parseDomainForChannel(model,channel){var scaleType=model.getScaleComponent(channel).get("type");var encoding=model.encoding;var domain=normalizeUnaggregatedDomain(model.scaleDomain(channel),model.typedFieldDef(channel),scaleType,model.config.scale);if(domain!==model.scaleDomain(channel)){model.specifiedScales[channel]=_objectSpread2(_objectSpread2({},model.specifiedScales[channel]),{},{domain:domain})}if(channel==="x"&&getFieldOrDatumDef(encoding.x2)){if(getFieldOrDatumDef(encoding.x)){return mergeValuesWithExplicit(parseSingleChannelDomain(scaleType,domain,model,"x"),parseSingleChannelDomain(scaleType,domain,model,"x2"),"domain","scale",domainsTieBreaker)}else{return parseSingleChannelDomain(scaleType,domain,model,"x2")}}else if(channel==="y"&&getFieldOrDatumDef(encoding.y2)){if(getFieldOrDatumDef(encoding.y)){return mergeValuesWithExplicit(parseSingleChannelDomain(scaleType,domain,model,"y"),parseSingleChannelDomain(scaleType,domain,model,"y2"),"domain","scale",domainsTieBreaker)}else{return parseSingleChannelDomain(scaleType,domain,model,"y2")}}return parseSingleChannelDomain(scaleType,domain,model,channel)}function mapDomainToDataSignal(domain,type,timeUnit){return domain.map((function(v){var data=valueExpr(v,{timeUnit:timeUnit,type:type});return{signal:"{data: ".concat(data,"}")}}))}function convertDomainIfItIsDateTime(domain,type,timeUnit){var _normalizeTimeUnit;var normalizedTimeUnit=(_normalizeTimeUnit=normalizeTimeUnit(timeUnit))===null||_normalizeTimeUnit===void 0?void 0:_normalizeTimeUnit.unit;if(type==="temporal"||normalizedTimeUnit){return mapDomainToDataSignal(domain,type,normalizedTimeUnit)}return[domain]}function parseSingleChannelDomain(scaleType,domain,model,channel){var encoding=model.encoding;var fieldOrDatumDef=getFieldOrDatumDef(encoding[channel]);var type=fieldOrDatumDef.type;var timeUnit=fieldOrDatumDef["timeUnit"];if(isDomainUnionWith(domain)){var defaultDomain=parseSingleChannelDomain(scaleType,undefined,model,channel);var unionWith=convertDomainIfItIsDateTime(domain.unionWith,type,timeUnit);return makeExplicit([].concat(_toConsumableArray(defaultDomain.value),_toConsumableArray(unionWith)))}else if(isSignalRef(domain)){return makeExplicit([domain])}else if(domain&&domain!=="unaggregated"&&!isSelectionDomain(domain)){return makeExplicit(convertDomainIfItIsDateTime(domain,type,timeUnit))}var stack=model.stack;if(stack&&channel===stack.fieldChannel){if(stack.offset==="normalize"){return makeImplicit([[0,1]])}var data=model.requestDataName(DataSourceType.Main);return makeImplicit([{data:data,field:model.vgField(channel,{suffix:"start"})},{data:data,field:model.vgField(channel,{suffix:"end"})}])}var sort=isScaleChannel(channel)&&isFieldDef(fieldOrDatumDef)?domainSort(model,channel,scaleType):undefined;if(isDatumDef(fieldOrDatumDef)){var d=convertDomainIfItIsDateTime([fieldOrDatumDef.datum],type,timeUnit);return makeImplicit(d)}var fieldDef=fieldOrDatumDef;if(domain==="unaggregated"){var _data=model.requestDataName(DataSourceType.Main);var field=fieldOrDatumDef.field;return makeImplicit([{data:_data,field:vgField({field:field,aggregate:"min"})},{data:_data,field:vgField({field:field,aggregate:"max"})}])}else if(isBinning(fieldDef.bin)){if(hasDiscreteDomain(scaleType)){if(scaleType==="bin-ordinal"){return makeImplicit([])}return makeImplicit([{data:isBoolean$1(sort)?model.requestDataName(DataSourceType.Main):model.requestDataName(DataSourceType.Raw),field:model.vgField(channel,binRequiresRange(fieldDef,channel)?{binSuffix:"range"}:{}),sort:sort===true||!isObject(sort)?{field:model.vgField(channel,{}),op:"min"}:sort}])}else{var bin=fieldDef.bin;if(isBinning(bin)){var binSignal=getBinSignalName(model,fieldDef.field,bin);return makeImplicit([new SignalRefWrapper((function(){var signal=model.getSignalName(binSignal);return"[".concat(signal,".start, ").concat(signal,".stop]")}))])}else{return makeImplicit([{data:model.requestDataName(DataSourceType.Main),field:model.vgField(channel,{})}])}}}else if(fieldDef.timeUnit&&contains(["time","utc"],scaleType)&&hasBand(channel,fieldDef,isUnitModel(model)?model.encoding[getSecondaryRangeChannel(channel)]:undefined,model.stack,model.markDef,model.config)){var _data2=model.requestDataName(DataSourceType.Main);return makeImplicit([{data:_data2,field:model.vgField(channel)},{data:_data2,field:model.vgField(channel,{suffix:"end"})}])}else if(sort){return makeImplicit([{data:isBoolean$1(sort)?model.requestDataName(DataSourceType.Main):model.requestDataName(DataSourceType.Raw),field:model.vgField(channel),sort:sort}])}else{return makeImplicit([{data:model.requestDataName(DataSourceType.Main),field:model.vgField(channel)}])}}function normalizeSortField(sort,isStackedMeasure){var op=sort.op,field=sort.field,order=sort.order;return _objectSpread2(_objectSpread2({op:op!==null&&op!==void 0?op:isStackedMeasure?"sum":DEFAULT_SORT_OP},field?{field:replacePathInField(field)}:{}),order?{order:order}:{})}function parseSelectionDomain(model,channel){var _model$fieldDef;var scale=model.component.scales[channel];var spec=model.specifiedScales[channel].domain;var bin=(_model$fieldDef=model.fieldDef(channel))===null||_model$fieldDef===void 0?void 0:_model$fieldDef.bin;var domain=isSelectionDomain(spec)&&spec;var extent=isBinParams(bin)&&isSelectionExtent(bin.extent)&&bin.extent;if(domain||extent){scale.set("selectionExtent",domain!==null&&domain!==void 0?domain:extent,true)}}function domainSort(model,channel,scaleType){if(!hasDiscreteDomain(scaleType)){return undefined}var fieldDef=model.fieldDef(channel);var sort=fieldDef.sort;if(isSortArray(sort)){return{op:"min",field:sortArrayIndexField(fieldDef,channel),order:"ascending"}}var stack=model.stack;var stackDimensions=stack?[].concat(_toConsumableArray(stack.groupbyField?[stack.groupbyField]:[]),_toConsumableArray(stack.stackBy.map((function(s){return s.fieldDef.field})))):undefined;if(isSortField(sort)){var isStackedMeasure=stack&&!contains(stackDimensions,sort.field);return normalizeSortField(sort,isStackedMeasure)}else if(isSortByEncoding(sort)){var encoding=sort.encoding,order=sort.order;var fieldDefToSortBy=model.fieldDef(encoding);var aggregate=fieldDefToSortBy.aggregate,field=fieldDefToSortBy.field;var _isStackedMeasure=stack&&!contains(stackDimensions,field);if(isArgminDef(aggregate)||isArgmaxDef(aggregate)){return normalizeSortField({field:vgField(fieldDefToSortBy),order:order},_isStackedMeasure)}else if(isAggregateOp(aggregate)||!aggregate){return normalizeSortField({op:aggregate,field:field,order:order},_isStackedMeasure)}}else if(sort==="descending"){return{op:"min",field:model.vgField(channel),order:"descending"}}else if(contains(["ascending",undefined],sort)){return true}return undefined}function canUseUnaggregatedDomain(fieldDef,scaleType){var aggregate=fieldDef.aggregate,type=fieldDef.type;if(!aggregate){return{valid:false,reason:unaggregateDomainHasNoEffectForRawField(fieldDef)}}if(isString(aggregate)&&!SHARED_DOMAIN_OP_INDEX[aggregate]){return{valid:false,reason:unaggregateDomainWithNonSharedDomainOp(aggregate)}}if(type==="quantitative"){if(scaleType==="log"){return{valid:false,reason:unaggregatedDomainWithLogScale(fieldDef)}}}return{valid:true}}function domainsTieBreaker(v1,v2,property,propertyOf){if(v1.explicit&&v2.explicit){warn(mergeConflictingDomainProperty(property,propertyOf,v1.value,v2.value))}return{explicit:v1.explicit,value:[].concat(_toConsumableArray(v1.value),_toConsumableArray(v2.value))}}function mergeDomains(domains){var uniqueDomains=unique(domains.map((function(domain){if(isDataRefDomain(domain)){var _s=domain.sort,domainWithoutSort=_objectWithoutProperties(domain,["sort"]);return domainWithoutSort}return domain})),hash);var sorts=unique(domains.map((function(d){if(isDataRefDomain(d)){var s=d.sort;if(s!==undefined&&!isBoolean$1(s)){if("op"in s&&s.op==="count"){delete s.field}if(s.order==="ascending"){delete s.order}}return s}return undefined})).filter((function(s){return s!==undefined})),hash);if(uniqueDomains.length===0){return undefined}else if(uniqueDomains.length===1){var domain=domains[0];if(isDataRefDomain(domain)&&sorts.length>0){var _sort=sorts[0];if(sorts.length>1){warn(MORE_THAN_ONE_SORT);_sort=true}else{if(isObject(_sort)&&"field"in _sort){var sortField=_sort.field;if(domain.field===sortField){_sort=_sort.order?{order:_sort.order}:true}}}return _objectSpread2(_objectSpread2({},domain),{},{sort:_sort})}return domain}var unionDomainSorts=unique(sorts.map((function(s){if(isBoolean$1(s)||!("op"in s)||isString(s.op)&&s.op in MULTIDOMAIN_SORT_OP_INDEX){return s}warn(domainSortDropped(s));return true})),hash);var sort;if(unionDomainSorts.length===1){sort=unionDomainSorts[0]}else if(unionDomainSorts.length>1){warn(MORE_THAN_ONE_SORT);sort=true}var allData=unique(domains.map((function(d){if(isDataRefDomain(d)){return d.data}return null})),(function(x){return x}));if(allData.length===1&&allData[0]!==null){var _domain=_objectSpread2({data:allData[0],fields:uniqueDomains.map((function(d){return d.field}))},sort?{sort:sort}:{});return _domain}return _objectSpread2({fields:uniqueDomains},sort?{sort:sort}:{})}function getFieldFromDomain(domain){if(isDataRefDomain(domain)&&isString(domain.field)){return domain.field}else if(isDataRefUnionedDomain(domain)){var field;var _iterator6=_createForOfIteratorHelper(domain.fields),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var nonUnionDomain=_step6.value;if(isDataRefDomain(nonUnionDomain)&&isString(nonUnionDomain.field)){if(!field){field=nonUnionDomain.field}else if(field!==nonUnionDomain.field){warn(FACETED_INDEPENDENT_DIFFERENT_SOURCES);return field}}}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}warn(FACETED_INDEPENDENT_SAME_FIELDS_DIFFERENT_SOURCES);return field}else if(isFieldRefUnionDomain(domain)){warn(FACETED_INDEPENDENT_SAME_SOURCE);var _field=domain.fields[0];return isString(_field)?_field:undefined}return undefined}function assembleDomain(model,channel){var scaleComponent=model.component.scales[channel];var domains=scaleComponent.get("domains").map((function(domain){if(isDataRefDomain(domain)){domain.data=model.lookupDataSource(domain.data)}return domain}));return mergeDomains(domains)}function assembleScales(model){if(isLayerModel(model)||isConcatModel(model)){return model.children.reduce((function(scales,child){return scales.concat(assembleScales(child))}),assembleScalesForModel(model))}else{return assembleScalesForModel(model)}}function assembleScalesForModel(model){return keys(model.component.scales).reduce((function(scales,channel){var scaleComponent=model.component.scales[channel];if(scaleComponent.merged){return scales}var scale=scaleComponent.combine();var name=scale.name,type=scale.type,selectionExtent=scale.selectionExtent,_d=scale.domains,_r=scale.range,reverse=scale.reverse,otherScaleProps=_objectWithoutProperties(scale,["name","type","selectionExtent","domains","range","reverse"]);var range=assembleScaleRange(scale.range,name,channel,model);var domainRaw;if(selectionExtent){domainRaw=assembleSelectionScaleDomain(model,selectionExtent)}var domain=assembleDomain(model,channel);scales.push(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({name:name,type:type},domain?{domain:domain}:{}),domainRaw?{domainRaw:domainRaw}:{}),{},{range:range},reverse!==undefined?{reverse:reverse}:{}),otherScaleProps));return scales}),[])}function assembleScaleRange(scaleRange,scaleName,channel,model){if(isXorY(channel)){if(isVgRangeStep(scaleRange)){return{step:{signal:scaleName+"_step"}}}}else if(isObject(scaleRange)&&isDataRefDomain(scaleRange)){return _objectSpread2(_objectSpread2({},scaleRange),{},{data:model.lookupDataSource(scaleRange.data)})}return scaleRange}var ScaleComponent=function(_Split){_inherits(ScaleComponent,_Split);var _super=_createSuper(ScaleComponent);function ScaleComponent(name,typeWithExplicit){var _this;_classCallCheck(this,ScaleComponent);_this=_super.call(this,{},{name:name});_defineProperty(_assertThisInitialized(_this),"merged",false);_this.setWithExplicit("type",typeWithExplicit);return _this}_createClass(ScaleComponent,[{key:"domainDefinitelyIncludesZero",value:function domainDefinitelyIncludesZero(){if(this.get("zero")!==false){return true}return some(this.get("domains"),(function(d){return isArray(d)&&d.length===2&&d[0]<=0&&d[1]>=0}))}}]);return ScaleComponent}(Split);var RANGE_PROPERTIES=["range","scheme"];function getSizeChannel$1(channel){return channel==="x"?"width":channel==="y"?"height":undefined}function parseUnitScaleRange(model){var localScaleComponents=model.component.scales;var _iterator=_createForOfIteratorHelper(SCALE_CHANNELS),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;var localScaleCmpt=localScaleComponents[channel];if(!localScaleCmpt){continue}var rangeWithExplicit=parseRangeForChannel(channel,model);localScaleCmpt.setWithExplicit("range",rangeWithExplicit)}}catch(err){_iterator.e(err)}finally{_iterator.f()}}function getBinStepSignal(model,channel){var fieldDef=model.fieldDef(channel);if(fieldDef&&fieldDef.bin&&isBinning(fieldDef.bin)){var binSignal=getBinSignalName(model,fieldDef.field,fieldDef.bin);var sizeType=getSizeChannel$1(channel);var sizeSignal=model.getName(sizeType);return new SignalRefWrapper((function(){var updatedName=model.getSignalName(binSignal);var binCount="(".concat(updatedName,".stop - ").concat(updatedName,".start) / ").concat(updatedName,".step");return"".concat(model.getSignalName(sizeSignal)," / (").concat(binCount,")")}))}return undefined}function parseRangeForChannel(channel,model){var specifiedScale=model.specifiedScales[channel];var size=model.size;var mergedScaleCmpt=model.getScaleComponent(channel);var scaleType=mergedScaleCmpt.get("type");var _iterator2=_createForOfIteratorHelper(RANGE_PROPERTIES),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var property=_step2.value;if(specifiedScale[property]!==undefined){var supportedByScaleType=scaleTypeSupportProperty(scaleType,property);var channelIncompatability=channelScalePropertyIncompatability(channel,property);if(!supportedByScaleType){warn(scalePropertyNotWorkWithScaleType(scaleType,property,channel))}else if(channelIncompatability){warn(channelIncompatability)}else{switch(property){case"range":{var range=specifiedScale.range;if(isArray(range)){if(isXorY(channel)){return makeExplicit(range.map((function(v){if(v==="width"||v==="height"){var sizeSignal=model.getName(v);var getSignalName=model.getSignalName.bind(model);return SignalRefWrapper.fromName(getSignalName,sizeSignal)}return v})))}}else if(isObject(range)){return makeExplicit({data:model.requestDataName(DataSourceType.Main),field:range.field,sort:{op:"min",field:model.vgField(channel)}})}return makeExplicit(range)}case"scheme":return makeExplicit(parseScheme(specifiedScale[property]))}}}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}if(channel===X||channel===Y){var sizeChannel=channel===X?"width":"height";var sizeValue=size[sizeChannel];if(isStep(sizeValue)){if(hasDiscreteDomain(scaleType)){return makeExplicit({step:sizeValue.step})}else{warn(stepDropped(sizeChannel))}}}var rangeMin=specifiedScale.rangeMin,rangeMax=specifiedScale.rangeMax;var d=defaultRange(channel,model);if((rangeMin!==undefined||rangeMax!==undefined)&&scaleTypeSupportProperty(scaleType,"rangeMin")&&isArray(d)&&d.length===2){return makeExplicit([rangeMin!==null&&rangeMin!==void 0?rangeMin:d[0],rangeMax!==null&&rangeMax!==void 0?rangeMax:d[1]])}return makeImplicit(d)}function parseScheme(scheme){if(isExtendedScheme(scheme)){return _objectSpread2({scheme:scheme.name},omit(scheme,["name"]))}return{scheme:scheme}}function defaultRange(channel,model){var size=model.size,config=model.config,mark=model.mark,encoding=model.encoding;var getSignalName=model.getSignalName.bind(model);var _ref=getFieldOrDatumDef(encoding[channel]),type=_ref.type;var mergedScaleCmpt=model.getScaleComponent(channel);var scaleType=mergedScaleCmpt.get("type");var _model$specifiedScale=model.specifiedScales[channel],domain=_model$specifiedScale.domain,domainMid=_model$specifiedScale.domainMid;switch(channel){case X:case Y:{if(contains(["point","band"],scaleType)){if(channel===X&&!size.width){var w=getViewConfigDiscreteSize(config.view,"width");if(isStep(w)){return w}}else if(channel===Y&&!size.height){var h=getViewConfigDiscreteSize(config.view,"height");if(isStep(h)){return h}}}var sizeType=getSizeChannel$1(channel);var sizeSignal=model.getName(sizeType);if(channel===Y&&hasContinuousDomain(scaleType)){return[SignalRefWrapper.fromName(getSignalName,sizeSignal),0]}else{return[0,SignalRefWrapper.fromName(getSignalName,sizeSignal)]}}case SIZE:{var zero=model.component.scales[channel].get("zero");var rangeMin=sizeRangeMin(mark,zero,config);var rangeMax=sizeRangeMax(mark,size,model,config);if(isContinuousToDiscrete(scaleType)){return interpolateRange(rangeMin,rangeMax,defaultContinuousToDiscreteCount(scaleType,config,domain,channel))}else{return[rangeMin,rangeMax]}}case THETA:return[0,Math.PI*2];case ANGLE:return[0,360];case RADIUS:{return[0,new SignalRefWrapper((function(){var w=model.getSignalName("width");var h=model.getSignalName("height");return"min(".concat(w,",").concat(h,")/2")}))]}case STROKEWIDTH:return[config.scale.minStrokeWidth,config.scale.maxStrokeWidth];case STROKEDASH:return[[1,0],[4,2],[2,1],[1,1],[1,2,4,2]];case SHAPE:return"symbol";case COLOR:case FILL:case STROKE:if(scaleType==="ordinal"){return type==="nominal"?"category":"ordinal"}else{if(domainMid!==undefined){return"diverging"}else{return mark==="rect"||mark==="geoshape"?"heatmap":"ramp"}}case OPACITY:case FILLOPACITY:case STROKEOPACITY:return[config.scale.minOpacity,config.scale.maxOpacity]}throw new Error("Scale range undefined for channel ".concat(channel))}function defaultContinuousToDiscreteCount(scaleType,config,domain,channel){switch(scaleType){case"quantile":return config.scale.quantileCount;case"quantize":return config.scale.quantizeCount;case"threshold":if(domain!==undefined&&isArray(domain)){return domain.length+1}else{warn(domainRequiredForThresholdScale(channel));return 3}}}function interpolateRange(rangeMin,rangeMax,cardinality){var f=function f(){var rMax=signalOrStringValue(rangeMax);var rMin=signalOrStringValue(rangeMin);var step="(".concat(rMax," - ").concat(rMin,") / (").concat(cardinality," - 1)");return"sequence(".concat(rMin,", ").concat(rMax," + ").concat(step,", ").concat(step,")")};if(isSignalRef(rangeMax)){return new SignalRefWrapper(f)}else{return{signal:f()}}}function sizeRangeMin(mark,zero,config){if(zero){if(isSignalRef(zero)){return{signal:"".concat(zero.signal," ? 0 : ").concat(sizeRangeMin(mark,false,config))}}else{return 0}}switch(mark){case"bar":case"tick":return config.scale.minBandSize;case"line":case"trail":case"rule":return config.scale.minStrokeWidth;case"text":return config.scale.minFontSize;case"point":case"square":case"circle":return config.scale.minSize}throw new Error(incompatibleChannel("size",mark))}var MAX_SIZE_RANGE_STEP_RATIO=.95;function sizeRangeMax(mark,size,model,config){var xyStepSignals={x:getBinStepSignal(model,"x"),y:getBinStepSignal(model,"y")};switch(mark){case"bar":case"tick":{if(config.scale.maxBandSize!==undefined){return config.scale.maxBandSize}var min=minXYStep(size,xyStepSignals,config.view);if(isNumber(min)){return min-1}else{return new SignalRefWrapper((function(){return"".concat(min.signal," - 1")}))}}case"line":case"trail":case"rule":return config.scale.maxStrokeWidth;case"text":return config.scale.maxFontSize;case"point":case"square":case"circle":{if(config.scale.maxSize){return config.scale.maxSize}var pointStep=minXYStep(size,xyStepSignals,config.view);if(isNumber(pointStep)){return Math.pow(MAX_SIZE_RANGE_STEP_RATIO*pointStep,2)}else{return new SignalRefWrapper((function(){return"pow(".concat(MAX_SIZE_RANGE_STEP_RATIO," * ").concat(pointStep.signal,", 2)")}))}}}throw new Error(incompatibleChannel("size",mark))}function minXYStep(size,xyStepSignals,viewConfig){var widthStep=isStep(size.width)?size.width.step:getViewConfigDiscreteStep(viewConfig,"width");var heightStep=isStep(size.height)?size.height.step:getViewConfigDiscreteStep(viewConfig,"height");if(xyStepSignals.x||xyStepSignals.y){return new SignalRefWrapper((function(){var exprs=[xyStepSignals.x?xyStepSignals.x.signal:widthStep,xyStepSignals.y?xyStepSignals.y.signal:heightStep];return"min(".concat(exprs.join(", "),")")}))}return Math.min(widthStep,heightStep)}function parseScaleProperty(model,property){if(isUnitModel(model)){parseUnitScaleProperty(model,property)}else{parseNonUnitScaleProperty(model,property)}}function parseUnitScaleProperty(model,property){var localScaleComponents=model.component.scales;var config=model.config,encoding=model.encoding,markDef=model.markDef,specifiedScales=model.specifiedScales;var _iterator=_createForOfIteratorHelper(keys(localScaleComponents)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;var specifiedScale=specifiedScales[channel];var localScaleCmpt=localScaleComponents[channel];var mergedScaleCmpt=model.getScaleComponent(channel);var fieldOrDatumDef=getFieldOrDatumDef(encoding[channel]);var specifiedValue=specifiedScale[property];var scaleType=mergedScaleCmpt.get("type");var scalePadding=mergedScaleCmpt.get("padding");var scalePaddingInner=mergedScaleCmpt.get("paddingInner");var supportedByScaleType=scaleTypeSupportProperty(scaleType,property);var channelIncompatability=channelScalePropertyIncompatability(channel,property);if(specifiedValue!==undefined){if(!supportedByScaleType){warn(scalePropertyNotWorkWithScaleType(scaleType,property,channel))}else if(channelIncompatability){warn(channelIncompatability)}}if(supportedByScaleType&&channelIncompatability===undefined){if(specifiedValue!==undefined){var timeUnit=fieldOrDatumDef["timeUnit"];var type=fieldOrDatumDef.type;switch(property){case"domainMax":case"domainMin":if(isDateTime(specifiedScale[property])||type==="temporal"||timeUnit){localScaleCmpt.set(property,{signal:valueExpr(specifiedScale[property],{type:type,timeUnit:timeUnit})},true)}else{localScaleCmpt.set(property,specifiedScale[property],true)}break;default:localScaleCmpt.copyKeyFromObject(property,specifiedScale)}}else{var value=property in scaleRules?scaleRules[property]({model:model,channel:channel,fieldOrDatumDef:fieldOrDatumDef,scaleType:scaleType,scalePadding:scalePadding,scalePaddingInner:scalePaddingInner,domain:specifiedScale.domain,markDef:markDef,config:config}):config.scale[property];if(value!==undefined){localScaleCmpt.set(property,value,false)}}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}var scaleRules={bins:function bins(_ref){var model=_ref.model,fieldOrDatumDef=_ref.fieldOrDatumDef;return isFieldDef(fieldOrDatumDef)?_bins(model,fieldOrDatumDef):undefined},interpolate:function interpolate(_ref2){var channel=_ref2.channel,fieldOrDatumDef=_ref2.fieldOrDatumDef;return _interpolate(channel,fieldOrDatumDef.type)},nice:function nice(_ref3){var scaleType=_ref3.scaleType,channel=_ref3.channel,fieldOrDatumDef=_ref3.fieldOrDatumDef;return _nice(scaleType,channel,fieldOrDatumDef)},padding:function padding(_ref4){var channel=_ref4.channel,scaleType=_ref4.scaleType,fieldOrDatumDef=_ref4.fieldOrDatumDef,markDef=_ref4.markDef,config=_ref4.config;return _padding(channel,scaleType,config.scale,fieldOrDatumDef,markDef,config.bar)},paddingInner:function paddingInner(_ref5){var scalePadding=_ref5.scalePadding,channel=_ref5.channel,markDef=_ref5.markDef,config=_ref5.config;return _paddingInner(scalePadding,channel,markDef.type,config.scale)},paddingOuter:function paddingOuter(_ref6){var scalePadding=_ref6.scalePadding,channel=_ref6.channel,scaleType=_ref6.scaleType,markDef=_ref6.markDef,scalePaddingInner=_ref6.scalePaddingInner,config=_ref6.config;return _paddingOuter(scalePadding,channel,scaleType,markDef.type,scalePaddingInner,config.scale)},reverse:function reverse(_ref7){var fieldOrDatumDef=_ref7.fieldOrDatumDef,scaleType=_ref7.scaleType,channel=_ref7.channel,config=_ref7.config;var sort=isFieldDef(fieldOrDatumDef)?fieldOrDatumDef.sort:undefined;return _reverse(scaleType,sort,channel,config.scale)},zero:function zero(_ref8){var channel=_ref8.channel,fieldOrDatumDef=_ref8.fieldOrDatumDef,domain=_ref8.domain,markDef=_ref8.markDef,scaleType=_ref8.scaleType;return _zero(channel,fieldOrDatumDef,domain,markDef,scaleType)}};function parseScaleRange(model){if(isUnitModel(model)){parseUnitScaleRange(model)}else{parseNonUnitScaleProperty(model,"range")}}function parseNonUnitScaleProperty(model,property){var localScaleComponents=model.component.scales;var _iterator2=_createForOfIteratorHelper(model.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;if(property==="range"){parseScaleRange(child)}else{parseScaleProperty(child,property)}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}var _iterator3=_createForOfIteratorHelper(keys(localScaleComponents)),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var channel=_step3.value;var valueWithExplicit=void 0;var _iterator4=_createForOfIteratorHelper(model.children),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _child=_step4.value;var childComponent=_child.component.scales[channel];if(childComponent){var childValueWithExplicit=childComponent.getWithExplicit(property);valueWithExplicit=mergeValuesWithExplicit(valueWithExplicit,childValueWithExplicit,property,"scale",tieBreakByComparing((function(v1,v2){switch(property){case"range":if(v1.step&&v2.step){return v1.step-v2.step}return 0}return 0})))}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}localScaleComponents[channel].setWithExplicit(property,valueWithExplicit)}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}function _bins(model,fieldDef){var bin=fieldDef.bin;if(isBinning(bin)){var binSignal=getBinSignalName(model,fieldDef.field,bin);return new SignalRefWrapper((function(){return model.getSignalName(binSignal)}))}else if(isBinned(bin)&&isBinParams(bin)&&bin.step!==undefined){return{step:bin.step}}return undefined}function _interpolate(channel,type){if(contains([COLOR,FILL,STROKE],channel)&&type!=="nominal"){return"hcl"}return undefined}function _nice(scaleType,channel,fieldOrDatumDef){var _getFieldDef;if(((_getFieldDef=getFieldDef(fieldOrDatumDef))===null||_getFieldDef===void 0?void 0:_getFieldDef.bin)||contains([ScaleType.TIME,ScaleType.UTC],scaleType)){return undefined}return channel in POSITION_SCALE_CHANNEL_INDEX?true:undefined}function _padding(channel,scaleType,scaleConfig,fieldOrDatumDef,markDef,barConfig){if(channel in POSITION_SCALE_CHANNEL_INDEX){if(isContinuousToContinuous(scaleType)){if(scaleConfig.continuousPadding!==undefined){return scaleConfig.continuousPadding}var type=markDef.type,orient=markDef.orient;if(type==="bar"&&!(isFieldDef(fieldOrDatumDef)&&(fieldOrDatumDef.bin||fieldOrDatumDef.timeUnit))){if(orient==="vertical"&&channel==="x"||orient==="horizontal"&&channel==="y"){return barConfig.continuousBandSize}}}if(scaleType===ScaleType.POINT){return scaleConfig.pointPadding}}return undefined}function _paddingInner(paddingValue,channel,mark,scaleConfig){if(paddingValue!==undefined){return undefined}if(channel in POSITION_SCALE_CHANNEL_INDEX){var bandPaddingInner=scaleConfig.bandPaddingInner,barBandPaddingInner=scaleConfig.barBandPaddingInner,rectBandPaddingInner=scaleConfig.rectBandPaddingInner;return getFirstDefined(bandPaddingInner,mark==="bar"?barBandPaddingInner:rectBandPaddingInner)}return undefined}function _paddingOuter(paddingValue,channel,scaleType,mark,paddingInnerValue,scaleConfig){if(paddingValue!==undefined){return undefined}if(channel in POSITION_SCALE_CHANNEL_INDEX){if(scaleType===ScaleType.BAND){var bandPaddingOuter=scaleConfig.bandPaddingOuter;return getFirstDefined(bandPaddingOuter,isSignalRef(paddingInnerValue)?{signal:"".concat(paddingInnerValue.signal,"/2")}:paddingInnerValue/2)}}return undefined}function _reverse(scaleType,sort,channel,scaleConfig){if(channel==="x"&&scaleConfig.xReverse!==undefined){if(hasContinuousDomain(scaleType)&&sort==="descending"){if(isSignalRef(scaleConfig.xReverse)){return{signal:"!".concat(scaleConfig.xReverse.signal)}}else{return!scaleConfig.xReverse}}return scaleConfig.xReverse}if(hasContinuousDomain(scaleType)&&sort==="descending"){return true}return undefined}function _zero(channel,fieldDef,specifiedDomain,markDef,scaleType){var hasCustomDomain=!!specifiedDomain&&specifiedDomain!=="unaggregated";if(hasCustomDomain){if(hasContinuousDomain(scaleType)){if(isArray(specifiedDomain)){var first=specifiedDomain[0];var last=specifiedDomain[specifiedDomain.length-1];if(first<=0&&last>=0){return true}}return false}}if(channel==="size"&&fieldDef.type==="quantitative"&&!isContinuousToDiscrete(scaleType)){return true}if(!(isFieldDef(fieldDef)&&fieldDef.bin)&&contains([].concat(_toConsumableArray(POSITION_SCALE_CHANNELS),_toConsumableArray(POLAR_POSITION_SCALE_CHANNELS)),channel)){var orient=markDef.orient,type=markDef.type;if(contains(["bar","area","line","trail"],type)){if(orient==="horizontal"&&channel==="y"||orient==="vertical"&&channel==="x"){return false}}return true}return false}function scaleType(specifiedScale,channel,fieldDef,mark){var defaultScaleType=defaultType$2(channel,fieldDef,mark);var type=specifiedScale.type;if(!isScaleChannel(channel)){return null}if(type!==undefined){if(!channelSupportScaleType(channel,type)){warn(scaleTypeNotWorkWithChannel(channel,type,defaultScaleType));return defaultScaleType}if(isFieldDef(fieldDef)&&!scaleTypeSupportDataType(type,fieldDef.type)){warn(scaleTypeNotWorkWithFieldDef(type,defaultScaleType));return defaultScaleType}return type}return defaultScaleType}function defaultType$2(channel,fieldDef,mark){var _fieldDef$axis;switch(fieldDef.type){case"nominal":case"ordinal":if(isColorChannel(channel)||rangeType(channel)==="discrete"){if(channel==="shape"&&fieldDef.type==="ordinal"){warn(discreteChannelCannotEncode(channel,"ordinal"))}return"ordinal"}if(channel in POSITION_SCALE_CHANNEL_INDEX){if(contains(["rect","bar","image","rule"],mark)){return"band"}}else if(mark==="arc"&&channel in POLAR_POSITION_SCALE_CHANNEL_INDEX){return"band"}if(fieldDef.band!==undefined||isPositionFieldOrDatumDef(fieldDef)&&((_fieldDef$axis=fieldDef.axis)===null||_fieldDef$axis===void 0?void 0:_fieldDef$axis.tickBand)){return"band"}return"point";case"temporal":if(isColorChannel(channel)){return"time"}else if(rangeType(channel)==="discrete"){warn(discreteChannelCannotEncode(channel,"temporal"));return"ordinal"}else if(isFieldDef(fieldDef)&&fieldDef.timeUnit&&normalizeTimeUnit(fieldDef.timeUnit).utc){return"utc"}return"time";case"quantitative":if(isColorChannel(channel)){if(isFieldDef(fieldDef)&&isBinning(fieldDef.bin)){return"bin-ordinal"}return"linear"}else if(rangeType(channel)==="discrete"){warn(discreteChannelCannotEncode(channel,"quantitative"));return"ordinal"}return"linear";case"geojson":return undefined}throw new Error(invalidFieldType(fieldDef.type))}function parseScales(model){var _ref=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},ignoreRange=_ref.ignoreRange;parseScaleCore(model);parseScaleDomain(model);var _iterator=_createForOfIteratorHelper(NON_TYPE_DOMAIN_RANGE_VEGA_SCALE_PROPERTIES),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var prop=_step.value;parseScaleProperty(model,prop)}}catch(err){_iterator.e(err)}finally{_iterator.f()}if(!ignoreRange){parseScaleRange(model)}}function parseScaleCore(model){if(isUnitModel(model)){model.component.scales=parseUnitScaleCore(model)}else{model.component.scales=parseNonUnitScaleCore(model)}}function parseUnitScaleCore(model){var encoding=model.encoding,mark=model.mark;return SCALE_CHANNELS.reduce((function(scaleComponents,channel){var fieldOrDatumDef=getFieldOrDatumDef(encoding[channel]);if(fieldOrDatumDef&&mark===GEOSHAPE&&channel===SHAPE&&fieldOrDatumDef.type===GEOJSON){return scaleComponents}var specifiedScale=fieldOrDatumDef&&fieldOrDatumDef["scale"];if(fieldOrDatumDef&&specifiedScale!==null&&specifiedScale!==false){var _specifiedScale;specifiedScale=(_specifiedScale=specifiedScale)!==null&&_specifiedScale!==void 0?_specifiedScale:{};var sType=scaleType(specifiedScale,channel,fieldOrDatumDef,mark);scaleComponents[channel]=new ScaleComponent(model.scaleName(channel+"",true),{value:sType,explicit:specifiedScale.type===sType})}return scaleComponents}),{})}var scaleTypeTieBreaker=tieBreakByComparing((function(st1,st2){return scaleTypePrecedence(st1)-scaleTypePrecedence(st2)}));function parseNonUnitScaleCore(model){var scaleComponents=model.component.scales={};var scaleTypeWithExplicitIndex={};var resolve=model.component.resolve;var _iterator2=_createForOfIteratorHelper(model.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;parseScaleCore(child);var _iterator4=_createForOfIteratorHelper(keys(child.component.scales)),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _resolve$scale$channe;var channel=_step4.value;resolve.scale[channel]=(_resolve$scale$channe=resolve.scale[channel])!==null&&_resolve$scale$channe!==void 0?_resolve$scale$channe:defaultScaleResolve(channel,model);if(resolve.scale[channel]==="shared"){var explicitScaleType=scaleTypeWithExplicitIndex[channel];var childScaleType=child.component.scales[channel].getWithExplicit("type");if(explicitScaleType){if(scaleCompatible(explicitScaleType.value,childScaleType.value)){scaleTypeWithExplicitIndex[channel]=mergeValuesWithExplicit(explicitScaleType,childScaleType,"type","scale",scaleTypeTieBreaker)}else{resolve.scale[channel]="independent";delete scaleTypeWithExplicitIndex[channel]}}else{scaleTypeWithExplicitIndex[channel]=childScaleType}}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}var _iterator3=_createForOfIteratorHelper(keys(scaleTypeWithExplicitIndex)),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _channel=_step3.value;var name=model.scaleName(_channel,true);var typeWithExplicit=scaleTypeWithExplicitIndex[_channel];scaleComponents[_channel]=new ScaleComponent(name,typeWithExplicit);var _iterator5=_createForOfIteratorHelper(model.children),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _child=_step5.value;var childScale=_child.component.scales[_channel];if(childScale){_child.renameScale(childScale.get("name"),name);childScale.merged=true}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return scaleComponents}var NameMap=function(){function NameMap(){_classCallCheck(this,NameMap);_defineProperty(this,"nameMap",void 0);this.nameMap={}}_createClass(NameMap,[{key:"rename",value:function rename(oldName,newName){this.nameMap[oldName]=newName}},{key:"has",value:function has(name){return this.nameMap[name]!==undefined}},{key:"get",value:function get(name){while(this.nameMap[name]&&name!==this.nameMap[name]){name=this.nameMap[name]}return name}}]);return NameMap}();function isUnitModel(model){return(model===null||model===void 0?void 0:model.type)==="unit"}function isFacetModel(model){return(model===null||model===void 0?void 0:model.type)==="facet"}function isConcatModel(model){return(model===null||model===void 0?void 0:model.type)==="concat"}function isLayerModel(model){return(model===null||model===void 0?void 0:model.type)==="layer"}var Model=function(){function Model(spec,type,parent,parentGivenName,config,resolve,view){var _this=this,_spec$name,_spec$transform;_classCallCheck(this,Model);this.type=type;this.parent=parent;this.config=config;_defineProperty(this,"name",void 0);_defineProperty(this,"size",void 0);_defineProperty(this,"title",void 0);_defineProperty(this,"description",void 0);_defineProperty(this,"data",void 0);_defineProperty(this,"transforms",void 0);_defineProperty(this,"layout",void 0);_defineProperty(this,"scaleNameMap",void 0);_defineProperty(this,"projectionNameMap",void 0);_defineProperty(this,"signalNameMap",void 0);_defineProperty(this,"component",void 0);_defineProperty(this,"view",void 0);_defineProperty(this,"children",[]);_defineProperty(this,"correctDataNames",(function(mark){if(mark.from&&mark.from.data){mark.from.data=_this.lookupDataSource(mark.from.data)}if(mark.from&&mark.from.facet&&mark.from.facet.data){mark.from.facet.data=_this.lookupDataSource(mark.from.facet.data)}return mark}));this.parent=parent;this.config=config;this.view=replaceExprRefInIndex(view);this.name=(_spec$name=spec.name)!==null&&_spec$name!==void 0?_spec$name:parentGivenName;this.title=isText(spec.title)?{text:spec.title}:spec.title?this.initTitle(spec.title):undefined;this.scaleNameMap=parent?parent.scaleNameMap:new NameMap;this.projectionNameMap=parent?parent.projectionNameMap:new NameMap;this.signalNameMap=parent?parent.signalNameMap:new NameMap;this.data=spec.data;this.description=spec.description;this.transforms=normalizeTransform((_spec$transform=spec.transform)!==null&&_spec$transform!==void 0?_spec$transform:[]);this.layout=type==="layer"||type==="unit"?{}:extractCompositionLayout(spec,type,config);this.component={data:{sources:parent?parent.component.data.sources:[],outputNodes:parent?parent.component.data.outputNodes:{},outputNodeRefCounts:parent?parent.component.data.outputNodeRefCounts:{},isFaceted:isFacetSpec(spec)||parent&&parent.component.data.isFaceted&&spec.data===undefined},layoutSize:new Split,layoutHeaders:{row:{},column:{},facet:{}},mark:null,resolve:_objectSpread2({scale:{},axis:{},legend:{}},resolve?duplicate(resolve):{}),selection:null,scales:null,projection:null,axes:{},legends:{}}}_createClass(Model,[{key:"initTitle",value:function initTitle(title){var props=keys(title);var titleInternal={text:signalRefOrValue(title.text)};var _iterator=_createForOfIteratorHelper(props),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var prop=_step.value;titleInternal[prop]=signalRefOrValue(title[prop])}}catch(err){_iterator.e(err)}finally{_iterator.f()}return titleInternal}},{key:"parse",value:function parse(){this.parseScale();this.parseLayoutSize();this.renameTopLevelLayoutSizeSignal();this.parseSelections();this.parseProjection();this.parseData();this.parseAxesAndHeaders();this.parseLegends();this.parseMarkGroup()}},{key:"parseScale",value:function parseScale(){parseScales(this)}},{key:"parseProjection",value:function parseProjection$1(){parseProjection(this)}},{key:"renameTopLevelLayoutSizeSignal",value:function renameTopLevelLayoutSizeSignal(){if(this.getName("width")!=="width"){this.renameSignal(this.getName("width"),"width")}if(this.getName("height")!=="height"){this.renameSignal(this.getName("height"),"height")}}},{key:"parseLegends",value:function parseLegends(){parseLegend(this)}},{key:"assembleGroupStyle",value:function assembleGroupStyle(){if(this.type==="unit"||this.type==="layer"){var _this$view$style,_this$view;return(_this$view$style=(_this$view=this.view)===null||_this$view===void 0?void 0:_this$view.style)!==null&&_this$view$style!==void 0?_this$view$style:"cell"}return undefined}},{key:"assembleEncodeFromView",value:function assembleEncodeFromView(view){var _=view.style,baseView=_objectWithoutProperties(view,["style"]);var e={};var _iterator2=_createForOfIteratorHelper(keys(baseView)),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var property=_step2.value;var value=baseView[property];if(value!==undefined){e[property]=signalOrValueRef(value)}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return e}},{key:"assembleGroupEncodeEntry",value:function assembleGroupEncodeEntry(isTopLevel){var encodeEntry={};if(this.view){encodeEntry=this.assembleEncodeFromView(this.view)}if(!isTopLevel){if(this.description){encodeEntry["description"]=signalOrValueRef(this.description)}if(this.type==="unit"||this.type==="layer"){var _encodeEntry;return _objectSpread2({width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")},(_encodeEntry=encodeEntry)!==null&&_encodeEntry!==void 0?_encodeEntry:{})}}return isEmpty(encodeEntry)?undefined:encodeEntry}},{key:"assembleLayout",value:function assembleLayout(){if(!this.layout){return undefined}var _this$layout=this.layout,spacing=_this$layout.spacing,layout=_objectWithoutProperties(_this$layout,["spacing"]);var component=this.component,config=this.config;var titleBand=assembleLayoutTitleBand(component.layoutHeaders,config);return _objectSpread2(_objectSpread2(_objectSpread2({padding:spacing},this.assembleDefaultLayout()),layout),titleBand?{titleBand:titleBand}:{})}},{key:"assembleDefaultLayout",value:function assembleDefaultLayout(){return{}}},{key:"assembleHeaderMarks",value:function assembleHeaderMarks(){var layoutHeaders=this.component.layoutHeaders;var headerMarks=[];var _iterator3=_createForOfIteratorHelper(FACET_CHANNELS),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _channel=_step3.value;if(layoutHeaders[_channel].title){headerMarks.push(assembleTitleGroup(this,_channel))}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}var _iterator4=_createForOfIteratorHelper(HEADER_CHANNELS),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _channel2=_step4.value;headerMarks=headerMarks.concat(assembleHeaderGroups(this,_channel2))}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}return headerMarks}},{key:"assembleAxes",value:function assembleAxes$1(){return assembleAxes(this.component.axes,this.config)}},{key:"assembleLegends",value:function assembleLegends$1(){return assembleLegends(this)}},{key:"assembleProjections",value:function assembleProjections$1(){return assembleProjections(this)}},{key:"assembleTitle",value:function assembleTitle(){var _this$title;var _ref=(_this$title=this.title)!==null&&_this$title!==void 0?_this$title:{},encoding=_ref.encoding,titleNoEncoding=_objectWithoutProperties(_ref,["encoding"]);var title=_objectSpread2(_objectSpread2(_objectSpread2({},extractTitleConfig(this.config.title).nonMark),titleNoEncoding),encoding?{encode:{update:encoding}}:{});if(title.text){if(contains(["unit","layer"],this.type)){if(contains(["middle",undefined],title.anchor)){var _title$frame;title.frame=(_title$frame=title.frame)!==null&&_title$frame!==void 0?_title$frame:"group"}}else{var _title$anchor;title.anchor=(_title$anchor=title.anchor)!==null&&_title$anchor!==void 0?_title$anchor:"start"}return isEmpty(title)?undefined:title}return undefined}},{key:"assembleGroup",value:function assembleGroup(){var signals=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var group={};signals=signals.concat(this.assembleSignals());if(signals.length>0){group.signals=signals}var layout=this.assembleLayout();if(layout){group.layout=layout}group.marks=[].concat(this.assembleHeaderMarks(),this.assembleMarks());var scales=!this.parent||isFacetModel(this.parent)?assembleScales(this):[];if(scales.length>0){group.scales=scales}var axes=this.assembleAxes();if(axes.length>0){group.axes=axes}var legends=this.assembleLegends();if(legends.length>0){group.legends=legends}return group}},{key:"getName",value:function getName(text){return varName((this.name?this.name+"_":"")+text)}},{key:"getDataName",value:function getDataName(type){return this.getName(DataSourceType[type].toLowerCase())}},{key:"requestDataName",value:function requestDataName(name){var fullName=this.getDataName(name);var refCounts=this.component.data.outputNodeRefCounts;refCounts[fullName]=(refCounts[fullName]||0)+1;return fullName}},{key:"getSizeSignalRef",value:function getSizeSignalRef(layoutSizeType){if(isFacetModel(this.parent)){var sizeType=getSizeTypeFromLayoutSizeType(layoutSizeType);var _channel3=getPositionScaleChannel(sizeType);var scaleComponent=this.component.scales[_channel3];if(scaleComponent&&!scaleComponent.merged){var _type=scaleComponent.get("type");var range=scaleComponent.get("range");if(hasDiscreteDomain(_type)&&isVgRangeStep(range)){var scaleName=scaleComponent.get("name");var domain=assembleDomain(this,_channel3);var field=getFieldFromDomain(domain);if(field){var fieldRef=vgField({aggregate:"distinct",field:field},{expr:"datum"});return{signal:sizeExpr(scaleName,scaleComponent,fieldRef)}}else{warn(unknownField(_channel3));return null}}}}return{signal:this.signalNameMap.get(this.getName(layoutSizeType))}}},{key:"lookupDataSource",value:function lookupDataSource(name){var node=this.component.data.outputNodes[name];if(!node){return name}return node.getSource()}},{key:"getSignalName",value:function getSignalName(oldSignalName){return this.signalNameMap.get(oldSignalName)}},{key:"renameSignal",value:function renameSignal(oldName,newName){this.signalNameMap.rename(oldName,newName)}},{key:"renameScale",value:function renameScale(oldName,newName){this.scaleNameMap.rename(oldName,newName)}},{key:"renameProjection",value:function renameProjection(oldName,newName){this.projectionNameMap.rename(oldName,newName)}},{key:"scaleName",value:function scaleName(originalScaleName,parse){if(parse){return this.getName(originalScaleName)}if(isChannel(originalScaleName)&&isScaleChannel(originalScaleName)&&this.component.scales[originalScaleName]||this.scaleNameMap.has(this.getName(originalScaleName))){return this.scaleNameMap.get(this.getName(originalScaleName))}return undefined}},{key:"projectionName",value:function projectionName(parse){if(parse){return this.getName("projection")}if(this.component.projection&&!this.component.projection.merged||this.projectionNameMap.has(this.getName("projection"))){return this.projectionNameMap.get(this.getName("projection"))}return undefined}},{key:"getScaleComponent",value:function getScaleComponent(channel){if(!this.component.scales){throw new Error("getScaleComponent cannot be called before parseScale(). Make sure you have called parseScale or use parseUnitModelWithScale().")}var localScaleComponent=this.component.scales[channel];if(localScaleComponent&&!localScaleComponent.merged){return localScaleComponent}return this.parent?this.parent.getScaleComponent(channel):undefined}},{key:"getSelectionComponent",value:function getSelectionComponent(variableName,origName){var sel=this.component.selection[variableName];if(!sel&&this.parent){sel=this.parent.getSelectionComponent(variableName,origName)}if(!sel){throw new Error(selectionNotFound(origName))}return sel}},{key:"hasAxisOrientSignalRef",value:function hasAxisOrientSignalRef(){var _this$component$axes$,_this$component$axes$2;return((_this$component$axes$=this.component.axes.x)===null||_this$component$axes$===void 0?void 0:_this$component$axes$.some((function(a){return a.hasOrientSignalRef()})))||((_this$component$axes$2=this.component.axes.y)===null||_this$component$axes$2===void 0?void 0:_this$component$axes$2.some((function(a){return a.hasOrientSignalRef()})))}},{key:"width",get:function get(){return this.getSizeSignalRef("width")}},{key:"height",get:function get(){return this.getSizeSignalRef("height")}}]);return Model}();var ModelWithField=function(_Model){_inherits(ModelWithField,_Model);var _super=_createSuper(ModelWithField);function ModelWithField(){_classCallCheck(this,ModelWithField);return _super.apply(this,arguments)}_createClass(ModelWithField,[{key:"vgField",value:function vgField$1(channel){var opt=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var fieldDef=this.fieldDef(channel);if(!fieldDef){return undefined}return vgField(fieldDef,opt)}},{key:"reduceFieldDef",value:function reduceFieldDef(f,init){return reduce(this.getMapping(),(function(acc,cd,c){var fieldDef=getFieldDef(cd);if(fieldDef){return f(acc,fieldDef,c)}return acc}),init)}},{key:"forEachFieldDef",value:function forEachFieldDef(f,t){forEach(this.getMapping(),(function(cd,c){var fieldDef=getFieldDef(cd);if(fieldDef){f(fieldDef,c)}}),t)}}]);return ModelWithField}(Model);var DensityTransformNode=function(_DataFlowNode){_inherits(DensityTransformNode,_DataFlowNode);var _super=_createSuper(DensityTransformNode);_createClass(DensityTransformNode,[{key:"clone",value:function clone(){return new DensityTransformNode(null,duplicate(this.transform))}}]);function DensityTransformNode(parent,transform){var _this$transform$as,_specifiedAs$,_specifiedAs$2;var _this;_classCallCheck(this,DensityTransformNode);_this=_super.call(this,parent);_this.transform=transform;_this.transform=duplicate(transform);var specifiedAs=(_this$transform$as=_this.transform.as)!==null&&_this$transform$as!==void 0?_this$transform$as:[undefined,undefined];_this.transform.as=[(_specifiedAs$=specifiedAs[0])!==null&&_specifiedAs$!==void 0?_specifiedAs$:"value",(_specifiedAs$2=specifiedAs[1])!==null&&_specifiedAs$2!==void 0?_specifiedAs$2:"density"];return _this}_createClass(DensityTransformNode,[{key:"dependentFields",value:function dependentFields(){var _this$transform$group;return new Set([this.transform.density].concat(_toConsumableArray((_this$transform$group=this.transform.groupby)!==null&&_this$transform$group!==void 0?_this$transform$group:[])))}},{key:"producedFields",value:function producedFields(){return new Set(this.transform.as)}},{key:"hash",value:function hash$1(){return"DensityTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var _this$transform=this.transform,density=_this$transform.density,rest=_objectWithoutProperties(_this$transform,["density"]);var result=_objectSpread2({type:"kde",field:density},rest);return result}}]);return DensityTransformNode}(DataFlowNode);var FilterInvalidNode=function(_DataFlowNode){_inherits(FilterInvalidNode,_DataFlowNode);var _super=_createSuper(FilterInvalidNode);_createClass(FilterInvalidNode,[{key:"clone",value:function clone(){return new FilterInvalidNode(null,_objectSpread2({},this.filter))}}]);function FilterInvalidNode(parent,filter){var _this;_classCallCheck(this,FilterInvalidNode);_this=_super.call(this,parent);_this.filter=filter;return _this}_createClass(FilterInvalidNode,[{key:"dependentFields",value:function dependentFields(){return new Set(keys(this.filter))}},{key:"producedFields",value:function producedFields(){return new Set}},{key:"hash",value:function hash$1(){return"FilterInvalid ".concat(hash(this.filter))}},{key:"assemble",value:function assemble(){var _this2=this;var filters=keys(this.filter).reduce((function(vegaFilters,field){var fieldDef=_this2.filter[field];var ref=vgField(fieldDef,{expr:"datum"});if(fieldDef!==null){if(fieldDef.type==="temporal"){vegaFilters.push("(isDate(".concat(ref,") || (isValid(").concat(ref,") && isFinite(+").concat(ref,")))"))}else if(fieldDef.type==="quantitative"){vegaFilters.push("isValid(".concat(ref,")"));vegaFilters.push("isFinite(+".concat(ref,")"))}else;}return vegaFilters}),[]);return filters.length>0?{type:"filter",expr:filters.join(" && ")}:null}}],[{key:"make",value:function make(parent,model){var config=model.config,mark=model.mark,markDef=model.markDef;var invalid=getMarkPropOrConfig("invalid",markDef,config);if(invalid!=="filter"){return null}var filter=model.reduceFieldDef((function(aggregator,fieldDef,channel){var scaleComponent=isScaleChannel(channel)&&model.getScaleComponent(channel);if(scaleComponent){var scaleType=scaleComponent.get("type");if(hasContinuousDomain(scaleType)&&fieldDef.aggregate!=="count"&&!isPathMark(mark)){aggregator[fieldDef.field]=fieldDef}}return aggregator}),{});if(!keys(filter).length){return null}return new FilterInvalidNode(parent,filter)}}]);return FilterInvalidNode}(DataFlowNode);var FlattenTransformNode=function(_DataFlowNode){_inherits(FlattenTransformNode,_DataFlowNode);var _super=_createSuper(FlattenTransformNode);_createClass(FlattenTransformNode,[{key:"clone",value:function clone(){return new FlattenTransformNode(this.parent,duplicate(this.transform))}}]);function FlattenTransformNode(parent,transform){var _this;_classCallCheck(this,FlattenTransformNode);_this=_super.call(this,parent);_this.transform=transform;_this.transform=duplicate(transform);var _this$transform=_this.transform,flatten=_this$transform.flatten,_this$transform$as=_this$transform.as,as=_this$transform$as===void 0?[]:_this$transform$as;_this.transform.as=flatten.map((function(f,i){var _as$i;return(_as$i=as[i])!==null&&_as$i!==void 0?_as$i:f}));return _this}_createClass(FlattenTransformNode,[{key:"dependentFields",value:function dependentFields(){return new Set(this.transform.flatten)}},{key:"producedFields",value:function producedFields(){return new Set(this.transform.as)}},{key:"hash",value:function hash$1(){return"FlattenTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var _this$transform2=this.transform,fields=_this$transform2.flatten,as=_this$transform2.as;var result={type:"flatten",fields:fields,as:as};return result}}]);return FlattenTransformNode}(DataFlowNode);var FoldTransformNode=function(_DataFlowNode){_inherits(FoldTransformNode,_DataFlowNode);var _super=_createSuper(FoldTransformNode);_createClass(FoldTransformNode,[{key:"clone",value:function clone(){return new FoldTransformNode(null,duplicate(this.transform))}}]);function FoldTransformNode(parent,transform){var _this$transform$as,_specifiedAs$,_specifiedAs$2;var _this;_classCallCheck(this,FoldTransformNode);_this=_super.call(this,parent);_this.transform=transform;_this.transform=duplicate(transform);var specifiedAs=(_this$transform$as=_this.transform.as)!==null&&_this$transform$as!==void 0?_this$transform$as:[undefined,undefined];_this.transform.as=[(_specifiedAs$=specifiedAs[0])!==null&&_specifiedAs$!==void 0?_specifiedAs$:"key",(_specifiedAs$2=specifiedAs[1])!==null&&_specifiedAs$2!==void 0?_specifiedAs$2:"value"];return _this}_createClass(FoldTransformNode,[{key:"dependentFields",value:function dependentFields(){return new Set(this.transform.fold)}},{key:"producedFields",value:function producedFields(){return new Set(this.transform.as)}},{key:"hash",value:function hash$1(){return"FoldTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var _this$transform=this.transform,fold=_this$transform.fold,as=_this$transform.as;var result={type:"fold",fields:fold,as:as};return result}}]);return FoldTransformNode}(DataFlowNode);var GeoJSONNode=function(_DataFlowNode){_inherits(GeoJSONNode,_DataFlowNode);var _super=_createSuper(GeoJSONNode);_createClass(GeoJSONNode,[{key:"clone",value:function clone(){return new GeoJSONNode(null,duplicate(this.fields),this.geojson,this.signal)}}],[{key:"parseAll",value:function parseAll(parent,model){if(model.component.projection&&!model.component.projection.isFit){return parent}var geoJsonCounter=0;var _iterator=_createForOfIteratorHelper([[LONGITUDE,LATITUDE],[LONGITUDE2,LATITUDE2]]),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var coordinates=_step.value;var pair=coordinates.map((function(channel){var def=getFieldOrDatumDef(model.encoding[channel]);return isFieldDef(def)?def.field:isDatumDef(def)?{expr:"".concat(def.datum)}:isValueDef(def)?{expr:"".concat(def["value"])}:undefined}));if(pair[0]||pair[1]){parent=new GeoJSONNode(parent,pair,null,model.getName("geojson_".concat(geoJsonCounter++)))}}}catch(err){_iterator.e(err)}finally{_iterator.f()}if(model.channelHasField(SHAPE)){var fieldDef=model.typedFieldDef(SHAPE);if(fieldDef.type===GEOJSON){parent=new GeoJSONNode(parent,null,fieldDef.field,model.getName("geojson_".concat(geoJsonCounter++)))}}return parent}}]);function GeoJSONNode(parent,fields,geojson,signal){var _this;_classCallCheck(this,GeoJSONNode);_this=_super.call(this,parent);_this.fields=fields;_this.geojson=geojson;_this.signal=signal;return _this}_createClass(GeoJSONNode,[{key:"dependentFields",value:function dependentFields(){var _this$fields;var fields=((_this$fields=this.fields)!==null&&_this$fields!==void 0?_this$fields:[]).filter(isString);return new Set([].concat(_toConsumableArray(this.geojson?[this.geojson]:[]),_toConsumableArray(fields)))}},{key:"producedFields",value:function producedFields(){return new Set}},{key:"hash",value:function hash$1(){return"GeoJSON ".concat(this.geojson," ").concat(this.signal," ").concat(hash(this.fields))}},{key:"assemble",value:function assemble(){return _objectSpread2(_objectSpread2(_objectSpread2({type:"geojson"},this.fields?{fields:this.fields}:{}),this.geojson?{geojson:this.geojson}:{}),{},{signal:this.signal})}}]);return GeoJSONNode}(DataFlowNode);var GeoPointNode=function(_DataFlowNode){_inherits(GeoPointNode,_DataFlowNode);var _super=_createSuper(GeoPointNode);_createClass(GeoPointNode,[{key:"clone",value:function clone(){return new GeoPointNode(null,this.projection,duplicate(this.fields),duplicate(this.as))}}]);function GeoPointNode(parent,projection,fields,as){var _this;_classCallCheck(this,GeoPointNode);_this=_super.call(this,parent);_this.projection=projection;_this.fields=fields;_this.as=as;return _this}_createClass(GeoPointNode,[{key:"dependentFields",value:function dependentFields(){return new Set(this.fields.filter(isString))}},{key:"producedFields",value:function producedFields(){return new Set(this.as)}},{key:"hash",value:function hash$1(){return"Geopoint ".concat(this.projection," ").concat(hash(this.fields)," ").concat(hash(this.as))}},{key:"assemble",value:function assemble(){return{type:"geopoint",projection:this.projection,fields:this.fields,as:this.as}}}],[{key:"parseAll",value:function parseAll(parent,model){if(!model.projectionName()){return parent}var _iterator=_createForOfIteratorHelper([[LONGITUDE,LATITUDE],[LONGITUDE2,LATITUDE2]]),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var coordinates=_step.value;var pair=coordinates.map((function(channel){var def=getFieldOrDatumDef(model.encoding[channel]);return isFieldDef(def)?def.field:isDatumDef(def)?{expr:"".concat(def.datum)}:isValueDef(def)?{expr:"".concat(def["value"])}:undefined}));var suffix=coordinates[0]===LONGITUDE2?"2":"";if(pair[0]||pair[1]){parent=new GeoPointNode(parent,model.projectionName(),pair,[model.getName("x"+suffix),model.getName("y"+suffix)])}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return parent}}]);return GeoPointNode}(DataFlowNode);var ImputeNode=function(_DataFlowNode){_inherits(ImputeNode,_DataFlowNode);var _super=_createSuper(ImputeNode);_createClass(ImputeNode,[{key:"clone",value:function clone(){return new ImputeNode(null,duplicate(this.transform))}}]);function ImputeNode(parent,transform){var _this;_classCallCheck(this,ImputeNode);_this=_super.call(this,parent);_this.transform=transform;return _this}_createClass(ImputeNode,[{key:"dependentFields",value:function dependentFields(){var _this$transform$group;return new Set([this.transform.impute,this.transform.key].concat(_toConsumableArray((_this$transform$group=this.transform.groupby)!==null&&_this$transform$group!==void 0?_this$transform$group:[])))}},{key:"producedFields",value:function producedFields(){return new Set([this.transform.impute])}},{key:"processSequence",value:function processSequence(keyvals){var _keyvals$start=keyvals.start,start=_keyvals$start===void 0?0:_keyvals$start,stop=keyvals.stop,step=keyvals.step;var result=[start,stop].concat(_toConsumableArray(step?[step]:[])).join(",");return{signal:"sequence(".concat(result,")")}}},{key:"hash",value:function hash$1(){return"Impute ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var _this$transform=this.transform,impute=_this$transform.impute,key=_this$transform.key,keyvals=_this$transform.keyvals,method=_this$transform.method,groupby=_this$transform.groupby,value=_this$transform.value,_this$transform$frame=_this$transform.frame,frame=_this$transform$frame===void 0?[null,null]:_this$transform$frame;var imputeTransform=_objectSpread2(_objectSpread2(_objectSpread2({type:"impute",field:impute,key:key},keyvals?{keyvals:isImputeSequence(keyvals)?this.processSequence(keyvals):keyvals}:{}),{},{method:"value"},groupby?{groupby:groupby}:{}),{},{value:!method||method==="value"?value:null});if(method&&method!=="value"){var deriveNewField=_objectSpread2({type:"window",as:["imputed_".concat(impute,"_value")],ops:[method],fields:[impute],frame:frame,ignorePeers:false},groupby?{groupby:groupby}:{});var replaceOriginal={type:"formula",expr:"datum.".concat(impute," === null ? datum.imputed_").concat(impute,"_value : datum.").concat(impute),as:impute};return[imputeTransform,deriveNewField,replaceOriginal]}else{return[imputeTransform]}}}],[{key:"makeFromTransform",value:function makeFromTransform(parent,imputeTransform){return new ImputeNode(parent,imputeTransform)}},{key:"makeFromEncoding",value:function makeFromEncoding(parent,model){var encoding=model.encoding;var xDef=encoding.x;var yDef=encoding.y;if(isFieldDef(xDef)&&isFieldDef(yDef)){var imputedChannel=xDef.impute?xDef:yDef.impute?yDef:undefined;if(imputedChannel===undefined){return undefined}var keyChannel=xDef.impute?yDef:yDef.impute?xDef:undefined;var _imputedChannel$imput=imputedChannel.impute,method=_imputedChannel$imput.method,value=_imputedChannel$imput.value,frame=_imputedChannel$imput.frame,keyvals=_imputedChannel$imput.keyvals;var groupbyFields=pathGroupingFields(model.mark,encoding);return new ImputeNode(parent,_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({impute:imputedChannel.field,key:keyChannel.field},method?{method:method}:{}),value!==undefined?{value:value}:{}),frame?{frame:frame}:{}),keyvals!==undefined?{keyvals:keyvals}:{}),groupbyFields.length?{groupby:groupbyFields}:{}))}return null}}]);return ImputeNode}(DataFlowNode);var LoessTransformNode=function(_DataFlowNode){_inherits(LoessTransformNode,_DataFlowNode);var _super=_createSuper(LoessTransformNode);_createClass(LoessTransformNode,[{key:"clone",value:function clone(){return new LoessTransformNode(null,duplicate(this.transform))}}]);function LoessTransformNode(parent,transform){var _this$transform$as,_specifiedAs$,_specifiedAs$2;var _this;_classCallCheck(this,LoessTransformNode);_this=_super.call(this,parent);_this.transform=transform;_this.transform=duplicate(transform);var specifiedAs=(_this$transform$as=_this.transform.as)!==null&&_this$transform$as!==void 0?_this$transform$as:[undefined,undefined];_this.transform.as=[(_specifiedAs$=specifiedAs[0])!==null&&_specifiedAs$!==void 0?_specifiedAs$:transform.on,(_specifiedAs$2=specifiedAs[1])!==null&&_specifiedAs$2!==void 0?_specifiedAs$2:transform.loess];return _this}_createClass(LoessTransformNode,[{key:"dependentFields",value:function dependentFields(){var _this$transform$group;return new Set([this.transform.loess,this.transform.on].concat(_toConsumableArray((_this$transform$group=this.transform.groupby)!==null&&_this$transform$group!==void 0?_this$transform$group:[])))}},{key:"producedFields",value:function producedFields(){return new Set(this.transform.as)}},{key:"hash",value:function hash$1(){return"LoessTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var _this$transform=this.transform,loess=_this$transform.loess,on=_this$transform.on,rest=_objectWithoutProperties(_this$transform,["loess","on"]);var result=_objectSpread2({type:"loess",x:on,y:loess},rest);return result}}]);return LoessTransformNode}(DataFlowNode);var LookupNode=function(_DataFlowNode){_inherits(LookupNode,_DataFlowNode);var _super=_createSuper(LookupNode);_createClass(LookupNode,[{key:"clone",value:function clone(){return new LookupNode(null,duplicate(this.transform),this.secondary)}}]);function LookupNode(parent,transform,secondary){var _this;_classCallCheck(this,LookupNode);_this=_super.call(this,parent);_this.transform=transform;_this.secondary=secondary;return _this}_createClass(LookupNode,[{key:"dependentFields",value:function dependentFields(){return new Set([this.transform.lookup])}},{key:"producedFields",value:function producedFields(){return new Set(this.transform.as?array(this.transform.as):this.transform.from.fields)}},{key:"hash",value:function hash$1(){return"Lookup ".concat(hash({transform:this.transform,secondary:this.secondary}))}},{key:"assemble",value:function assemble(){var foreign;if(this.transform.from.fields){foreign=_objectSpread2({values:this.transform.from.fields},this.transform.as?{as:array(this.transform.as)}:{})}else{var asName=this.transform.as;if(!isString(asName)){warn(NO_FIELDS_NEEDS_AS);asName="_lookup"}foreign={as:[asName]}}return _objectSpread2(_objectSpread2({type:"lookup",from:this.secondary,key:this.transform.from.key,fields:[this.transform.lookup]},foreign),this.transform.default?{default:this.transform.default}:{})}}],[{key:"make",value:function make(parent,model,transform,counter){var sources=model.component.data.sources;var _transform=transform,from=_transform.from;var fromOutputNode=null;if(isLookupData(from)){var fromSource=findSource(from.data,sources);if(!fromSource){fromSource=new SourceNode(from.data);sources.push(fromSource)}var fromOutputName=model.getName("lookup_".concat(counter));fromOutputNode=new OutputNode(fromSource,fromOutputName,DataSourceType.Lookup,model.component.data.outputNodeRefCounts);model.component.data.outputNodes[fromOutputName]=fromOutputNode}else if(isLookupSelection(from)){var selName=from.selection;transform=_objectSpread2({as:selName},transform);fromOutputNode=model.getSelectionComponent(varName(selName),selName).materialized;if(!fromOutputNode){throw new Error(noSameUnitLookup(selName))}}return new LookupNode(parent,transform,fromOutputNode.getSource())}}]);return LookupNode}(DataFlowNode);var QuantileTransformNode=function(_DataFlowNode){_inherits(QuantileTransformNode,_DataFlowNode);var _super=_createSuper(QuantileTransformNode);_createClass(QuantileTransformNode,[{key:"clone",value:function clone(){return new QuantileTransformNode(null,duplicate(this.transform))}}]);function QuantileTransformNode(parent,transform){var _this$transform$as,_specifiedAs$,_specifiedAs$2;var _this;_classCallCheck(this,QuantileTransformNode);_this=_super.call(this,parent);_this.transform=transform;_this.transform=duplicate(transform);var specifiedAs=(_this$transform$as=_this.transform.as)!==null&&_this$transform$as!==void 0?_this$transform$as:[undefined,undefined];_this.transform.as=[(_specifiedAs$=specifiedAs[0])!==null&&_specifiedAs$!==void 0?_specifiedAs$:"prob",(_specifiedAs$2=specifiedAs[1])!==null&&_specifiedAs$2!==void 0?_specifiedAs$2:"value"];return _this}_createClass(QuantileTransformNode,[{key:"dependentFields",value:function dependentFields(){var _this$transform$group;return new Set([this.transform.quantile].concat(_toConsumableArray((_this$transform$group=this.transform.groupby)!==null&&_this$transform$group!==void 0?_this$transform$group:[])))}},{key:"producedFields",value:function producedFields(){return new Set(this.transform.as)}},{key:"hash",value:function hash$1(){return"QuantileTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var _this$transform=this.transform,quantile=_this$transform.quantile,rest=_objectWithoutProperties(_this$transform,["quantile"]);var result=_objectSpread2({type:"quantile",field:quantile},rest);return result}}]);return QuantileTransformNode}(DataFlowNode);var RegressionTransformNode=function(_DataFlowNode){_inherits(RegressionTransformNode,_DataFlowNode);var _super=_createSuper(RegressionTransformNode);_createClass(RegressionTransformNode,[{key:"clone",value:function clone(){return new RegressionTransformNode(null,duplicate(this.transform))}}]);function RegressionTransformNode(parent,transform){var _this$transform$as,_specifiedAs$,_specifiedAs$2;var _this;_classCallCheck(this,RegressionTransformNode);_this=_super.call(this,parent);_this.transform=transform;_this.transform=duplicate(transform);var specifiedAs=(_this$transform$as=_this.transform.as)!==null&&_this$transform$as!==void 0?_this$transform$as:[undefined,undefined];_this.transform.as=[(_specifiedAs$=specifiedAs[0])!==null&&_specifiedAs$!==void 0?_specifiedAs$:transform.on,(_specifiedAs$2=specifiedAs[1])!==null&&_specifiedAs$2!==void 0?_specifiedAs$2:transform.regression];return _this}_createClass(RegressionTransformNode,[{key:"dependentFields",value:function dependentFields(){var _this$transform$group;return new Set([this.transform.regression,this.transform.on].concat(_toConsumableArray((_this$transform$group=this.transform.groupby)!==null&&_this$transform$group!==void 0?_this$transform$group:[])))}},{key:"producedFields",value:function producedFields(){return new Set(this.transform.as)}},{key:"hash",value:function hash$1(){return"RegressionTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var _this$transform=this.transform,regression=_this$transform.regression,on=_this$transform.on,rest=_objectWithoutProperties(_this$transform,["regression","on"]);var result=_objectSpread2({type:"regression",x:on,y:regression},rest);return result}}]);return RegressionTransformNode}(DataFlowNode);var PivotTransformNode=function(_DataFlowNode){_inherits(PivotTransformNode,_DataFlowNode);var _super=_createSuper(PivotTransformNode);_createClass(PivotTransformNode,[{key:"clone",value:function clone(){return new PivotTransformNode(null,duplicate(this.transform))}}]);function PivotTransformNode(parent,transform){var _this;_classCallCheck(this,PivotTransformNode);_this=_super.call(this,parent);_this.transform=transform;return _this}_createClass(PivotTransformNode,[{key:"addDimensions",value:function addDimensions(fields){var _this$transform$group;this.transform.groupby=unique(((_this$transform$group=this.transform.groupby)!==null&&_this$transform$group!==void 0?_this$transform$group:[]).concat(fields),(function(d){return d}))}},{key:"producedFields",value:function producedFields(){return undefined}},{key:"dependentFields",value:function dependentFields(){var _this$transform$group2;return new Set([this.transform.pivot,this.transform.value].concat(_toConsumableArray((_this$transform$group2=this.transform.groupby)!==null&&_this$transform$group2!==void 0?_this$transform$group2:[])))}},{key:"hash",value:function hash$1(){return"PivotTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){var _this$transform=this.transform,pivot=_this$transform.pivot,value=_this$transform.value,groupby=_this$transform.groupby,limit=_this$transform.limit,op=_this$transform.op;return _objectSpread2(_objectSpread2(_objectSpread2({type:"pivot",field:pivot,value:value},limit!==undefined?{limit:limit}:{}),op!==undefined?{op:op}:{}),groupby!==undefined?{groupby:groupby}:{})}}]);return PivotTransformNode}(DataFlowNode);var SampleTransformNode=function(_DataFlowNode){_inherits(SampleTransformNode,_DataFlowNode);var _super=_createSuper(SampleTransformNode);_createClass(SampleTransformNode,[{key:"clone",value:function clone(){return new SampleTransformNode(null,duplicate(this.transform))}}]);function SampleTransformNode(parent,transform){var _this;_classCallCheck(this,SampleTransformNode);_this=_super.call(this,parent);_this.transform=transform;return _this}_createClass(SampleTransformNode,[{key:"dependentFields",value:function dependentFields(){return new Set}},{key:"producedFields",value:function producedFields(){return new Set}},{key:"hash",value:function hash$1(){return"SampleTransform ".concat(hash(this.transform))}},{key:"assemble",value:function assemble(){return{type:"sample",size:this.transform.sample}}}]);return SampleTransformNode}(DataFlowNode);function makeWalkTree(data){var datasetIndex=0;function walkTree(node,dataSource){if(node instanceof SourceNode){if(!node.isGenerator&&!isUrlData(node.data)){data.push(dataSource);var newData={name:null,source:dataSource.name,transform:[]};dataSource=newData}}if(node instanceof ParseNode){if(node.parent instanceof SourceNode&&!dataSource.source){var _dataSource$format,_dataSource$transform;dataSource.format=_objectSpread2(_objectSpread2({},(_dataSource$format=dataSource.format)!==null&&_dataSource$format!==void 0?_dataSource$format:{}),{},{parse:node.assembleFormatParse()});(_dataSource$transform=dataSource.transform).push.apply(_dataSource$transform,_toConsumableArray(node.assembleTransforms(true)))}else{var _dataSource$transform2;(_dataSource$transform2=dataSource.transform).push.apply(_dataSource$transform2,_toConsumableArray(node.assembleTransforms()))}}if(node instanceof FacetNode){if(!dataSource.name){dataSource.name="data_".concat(datasetIndex++)}if(!dataSource.source||dataSource.transform.length>0){data.push(dataSource);node.data=dataSource.name}else{node.data=dataSource.source}var _iterator=_createForOfIteratorHelper(node.assemble()),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var d=_step.value;data.push(d)}}catch(err){_iterator.e(err)}finally{_iterator.f()}return}if(node instanceof GraticuleNode||node instanceof SequenceNode||node instanceof FilterInvalidNode||node instanceof FilterNode||node instanceof CalculateNode||node instanceof GeoPointNode||node instanceof GeoJSONNode||node instanceof AggregateNode||node instanceof LookupNode||node instanceof WindowTransformNode||node instanceof JoinAggregateTransformNode||node instanceof FoldTransformNode||node instanceof FlattenTransformNode||node instanceof DensityTransformNode||node instanceof LoessTransformNode||node instanceof QuantileTransformNode||node instanceof RegressionTransformNode||node instanceof IdentifierNode||node instanceof SampleTransformNode||node instanceof PivotTransformNode){dataSource.transform.push(node.assemble())}if(node instanceof BinNode||node instanceof TimeUnitNode||node instanceof ImputeNode||node instanceof StackNode){var _dataSource$transform3;(_dataSource$transform3=dataSource.transform).push.apply(_dataSource$transform3,_toConsumableArray(node.assemble()))}if(node instanceof OutputNode){if(dataSource.source&&dataSource.transform.length===0){node.setSource(dataSource.source)}else if(node.parent instanceof OutputNode){node.setSource(dataSource.name)}else{if(!dataSource.name){dataSource.name="data_".concat(datasetIndex++)}node.setSource(dataSource.name);if(node.numChildren()===1){data.push(dataSource);var _newData={name:null,source:dataSource.name,transform:[]};dataSource=_newData}}}switch(node.numChildren()){case 0:if(node instanceof OutputNode&&(!dataSource.source||dataSource.transform.length>0)){data.push(dataSource)}break;case 1:walkTree(node.children[0],dataSource);break;default:{if(!dataSource.name){dataSource.name="data_".concat(datasetIndex++)}var source=dataSource.name;if(!dataSource.source||dataSource.transform.length>0){data.push(dataSource)}else{source=dataSource.source}var _iterator2=_createForOfIteratorHelper(node.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;var _newData2={name:null,source:source,transform:[]};walkTree(child,_newData2)}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}break}}}return walkTree}function assembleFacetData(root){var data=[];var walkTree=makeWalkTree(data);var _iterator3=_createForOfIteratorHelper(root.children),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var child=_step3.value;walkTree(child,{source:root.name,name:null,transform:[]})}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}return data}function assembleRootData(dataComponent,datasets){var data=[];var walkTree=makeWalkTree(data);var sourceIndex=0;var _iterator4=_createForOfIteratorHelper(dataComponent.sources),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var root=_step4.value;if(!root.hasName()){root.dataName="source_".concat(sourceIndex++)}var newData=root.assemble();walkTree(root,newData)}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}for(var _i=0,_data=data;_i<_data.length;_i++){var d=_data[_i];if(d.transform.length===0){delete d.transform}}var whereTo=0;var _iterator5=_createForOfIteratorHelper(data.entries()),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _d3$transform;var _step5$value=_slicedToArray(_step5.value,2),i=_step5$value[0],_d3=_step5$value[1];if(((_d3$transform=_d3.transform)!==null&&_d3$transform!==void 0?_d3$transform:[]).length===0&&!_d3.source){data.splice(whereTo++,0,data.splice(i,1)[0])}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}for(var _i2=0,_data2=data;_i2<_data2.length;_i2++){var _d$transform;var _d=_data2[_i2];var _iterator6=_createForOfIteratorHelper((_d$transform=_d.transform)!==null&&_d$transform!==void 0?_d$transform:[]),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var t=_step6.value;if(t.type==="lookup"){t.from=dataComponent.outputNodes[t.from].getSource()}}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}}for(var _i3=0,_data3=data;_i3<_data3.length;_i3++){var _d2=_data3[_i3];if(_d2.name in datasets){_d2.values=datasets[_d2.name]}}return data}function getHeaderType(orient){if(orient==="top"||orient==="left"||isSignalRef(orient)){return"header"}return"footer"}function parseFacetHeaders(model){var _iterator=_createForOfIteratorHelper(FACET_CHANNELS),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;parseFacetHeader(model,channel)}}catch(err){_iterator.e(err)}finally{_iterator.f()}mergeChildAxis(model,"x");mergeChildAxis(model,"y")}function parseFacetHeader(model,channel){var facet=model.facet,config=model.config,child=model.child,component=model.component;if(model.channelHasField(channel)){var _fieldDef$header;var fieldDef=facet[channel];var titleConfig=getHeaderProperty("title",null,config,channel);var title$1=title(fieldDef,config,{allowDisabling:true,includeDefault:titleConfig===undefined||!!titleConfig});if(child.component.layoutHeaders[channel].title){title$1=isArray(title$1)?title$1.join(", "):title$1;title$1+=" / "+child.component.layoutHeaders[channel].title;child.component.layoutHeaders[channel].title=null}var labelOrient=getHeaderProperty("labelOrient",fieldDef,config,channel);var header=(_fieldDef$header=fieldDef.header)!==null&&_fieldDef$header!==void 0?_fieldDef$header:{};var labels=getFirstDefined(header.labels,config.header.labels,true);var headerType=contains(["bottom","right"],labelOrient)?"footer":"header";component.layoutHeaders[channel]=_defineProperty({title:title$1,facetFieldDef:fieldDef},headerType,channel==="facet"?[]:[makeHeaderComponent(model,channel,labels)])}}function makeHeaderComponent(model,channel,labels){var sizeType=channel==="row"?"height":"width";return{labels:labels,sizeSignal:model.child.component.layoutSize.get(sizeType)?model.child.getSizeSignalRef(sizeType):undefined,axes:[]}}function mergeChildAxis(model,channel){var child=model.child;if(child.component.axes[channel]){var _model$component=model.component,layoutHeaders=_model$component.layoutHeaders,resolve=_model$component.resolve;resolve.axis[channel]=parseGuideResolve(resolve,channel);if(resolve.axis[channel]==="shared"){var headerChannel=channel==="x"?"column":"row";var layoutHeader=layoutHeaders[headerChannel];var _iterator2=_createForOfIteratorHelper(child.component.axes[channel]),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _layoutHeader$headerT;var axisComponent=_step2.value;var headerType=getHeaderType(axisComponent.get("orient"));layoutHeader[headerType]=(_layoutHeader$headerT=layoutHeader[headerType])!==null&&_layoutHeader$headerT!==void 0?_layoutHeader$headerT:[makeHeaderComponent(model,headerChannel,false)];var mainAxis=assembleAxis(axisComponent,"main",model.config,{header:true});if(mainAxis){layoutHeader[headerType][0].axes.push(mainAxis)}axisComponent.mainExtracted=true}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}}}function parseLayerLayoutSize(model){parseChildrenLayoutSize(model);parseNonUnitLayoutSizeForChannel(model,"width");parseNonUnitLayoutSizeForChannel(model,"height")}function parseConcatLayoutSize(model){parseChildrenLayoutSize(model);var widthType=model.layout.columns===1?"width":"childWidth";var heightType=model.layout.columns===undefined?"height":"childHeight";parseNonUnitLayoutSizeForChannel(model,widthType);parseNonUnitLayoutSizeForChannel(model,heightType)}function parseChildrenLayoutSize(model){var _iterator=_createForOfIteratorHelper(model.children),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var child=_step.value;child.parseLayoutSize()}}catch(err){_iterator.e(err)}finally{_iterator.f()}}function parseNonUnitLayoutSizeForChannel(model,layoutSizeType){var sizeType=getSizeTypeFromLayoutSizeType(layoutSizeType);var channel=getPositionScaleChannel(sizeType);var resolve=model.component.resolve;var layoutSizeCmpt=model.component.layoutSize;var mergedSize;var _iterator2=_createForOfIteratorHelper(model.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _child=_step2.value;var childSize=_child.component.layoutSize.getWithExplicit(sizeType);var scaleResolve=resolve.scale[channel];if(scaleResolve==="independent"&&childSize.value==="step"){mergedSize=undefined;break}if(mergedSize){if(scaleResolve==="independent"&&mergedSize.value!==childSize.value){mergedSize=undefined;break}mergedSize=mergeValuesWithExplicit(mergedSize,childSize,sizeType,"")}else{mergedSize=childSize}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}if(mergedSize){var _iterator3=_createForOfIteratorHelper(model.children),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var child=_step3.value;model.renameSignal(child.getName(sizeType),model.getName(layoutSizeType));child.component.layoutSize.set(sizeType,"merged",false)}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}layoutSizeCmpt.setWithExplicit(layoutSizeType,mergedSize)}else{layoutSizeCmpt.setWithExplicit(layoutSizeType,{explicit:false,value:undefined})}}function parseUnitLayoutSize(model){var size=model.size,component=model.component;var _iterator4=_createForOfIteratorHelper(POSITION_SCALE_CHANNELS),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var channel=_step4.value;var sizeType=getSizeChannel(channel);if(size[sizeType]){var specifiedSize=size[sizeType];component.layoutSize.set(sizeType,isStep(specifiedSize)?"step":specifiedSize,true)}else{var defaultSize=defaultUnitSize(model,sizeType);component.layoutSize.set(sizeType,defaultSize,false)}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}function defaultUnitSize(model,sizeType){var channel=sizeType==="width"?"x":"y";var config=model.config;var scaleComponent=model.getScaleComponent(channel);if(scaleComponent){var scaleType=scaleComponent.get("type");var range=scaleComponent.get("range");if(hasDiscreteDomain(scaleType)){var size=getViewConfigDiscreteSize(config.view,sizeType);if(isVgRangeStep(range)||isStep(size)){return"step"}else{return size}}else{return getViewConfigContinuousSize(config.view,sizeType)}}else if(model.hasProjection||model.mark==="arc"){return getViewConfigContinuousSize(config.view,sizeType)}else{var _size=getViewConfigDiscreteSize(config.view,sizeType);return isStep(_size)?_size.step:_size}}function facetSortFieldName(fieldDef,sort,opt){return vgField(sort,_objectSpread2({suffix:"by_".concat(vgField(fieldDef))},opt!==null&&opt!==void 0?opt:{}))}var FacetModel=function(_ModelWithField){_inherits(FacetModel,_ModelWithField);var _super=_createSuper(FacetModel);function FacetModel(spec,parent,parentGivenName,config){var _this;_classCallCheck(this,FacetModel);_this=_super.call(this,spec,"facet",parent,parentGivenName,config,spec.resolve);_defineProperty(_assertThisInitialized(_this),"facet",void 0);_defineProperty(_assertThisInitialized(_this),"child",void 0);_defineProperty(_assertThisInitialized(_this),"children",void 0);_this.child=buildModel(spec.spec,_assertThisInitialized(_this),_this.getName("child"),undefined,config);_this.children=[_this.child];_this.facet=_this.initFacet(spec.facet);return _this}_createClass(FacetModel,[{key:"initFacet",value:function initFacet(facet){if(!isFacetMapping(facet)){return{facet:this.initFacetFieldDef(facet,"facet")}}var channels=keys(facet);var normalizedFacet={};var _iterator=_createForOfIteratorHelper(channels),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;if(!contains([ROW,COLUMN],channel)){warn(incompatibleChannel(channel,"facet"));break}var fieldDef=facet[channel];if(fieldDef.field===undefined){warn(emptyFieldDef(fieldDef,channel));break}normalizedFacet[channel]=this.initFacetFieldDef(fieldDef,channel)}}catch(err){_iterator.e(err)}finally{_iterator.f()}return normalizedFacet}},{key:"initFacetFieldDef",value:function initFacetFieldDef(fieldDef,channel){var header=fieldDef.header,rest=_objectWithoutProperties(fieldDef,["header"]);var facetFieldDef=initFieldDef(rest,channel);if(header){facetFieldDef.header=replaceExprRefInIndex(header)}return facetFieldDef}},{key:"channelHasField",value:function channelHasField(channel){return!!this.facet[channel]}},{key:"fieldDef",value:function fieldDef(channel){return this.facet[channel]}},{key:"parseData",value:function parseData$1(){this.component.data=parseData(this);this.child.parseData()}},{key:"parseLayoutSize",value:function parseLayoutSize(){parseChildrenLayoutSize(this)}},{key:"parseSelections",value:function parseSelections(){this.child.parseSelections();this.component.selection=this.child.component.selection}},{key:"parseMarkGroup",value:function parseMarkGroup(){this.child.parseMarkGroup()}},{key:"parseAxesAndHeaders",value:function parseAxesAndHeaders(){this.child.parseAxesAndHeaders();parseFacetHeaders(this)}},{key:"assembleSelectionTopLevelSignals",value:function assembleSelectionTopLevelSignals(signals){return this.child.assembleSelectionTopLevelSignals(signals)}},{key:"assembleSignals",value:function assembleSignals(){this.child.assembleSignals();return[]}},{key:"assembleSelectionData",value:function assembleSelectionData(data){return this.child.assembleSelectionData(data)}},{key:"getHeaderLayoutMixins",value:function getHeaderLayoutMixins(){var layoutMixins={};var _iterator2=_createForOfIteratorHelper(FACET_CHANNELS),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var channel=_step2.value;var _iterator3=_createForOfIteratorHelper(HEADER_TYPES),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var headerType=_step3.value;var layoutHeaderComponent=this.component.layoutHeaders[channel];var headerComponent=layoutHeaderComponent[headerType];var facetFieldDef=layoutHeaderComponent.facetFieldDef;if(facetFieldDef){var titleOrient=getHeaderProperty("titleOrient",facetFieldDef.header,this.config,channel);if(contains(["right","bottom"],titleOrient)){var _layoutMixins$titleAn;var headerChannel=getHeaderChannel(channel,titleOrient);layoutMixins.titleAnchor=(_layoutMixins$titleAn=layoutMixins.titleAnchor)!==null&&_layoutMixins$titleAn!==void 0?_layoutMixins$titleAn:{};layoutMixins.titleAnchor[headerChannel]="end"}}if(headerComponent===null||headerComponent===void 0?void 0:headerComponent[0]){var sizeType=channel==="row"?"height":"width";var bandType=headerType==="header"?"headerBand":"footerBand";if(channel!=="facet"&&!this.child.component.layoutSize.get(sizeType)){var _layoutMixins$bandTyp;layoutMixins[bandType]=(_layoutMixins$bandTyp=layoutMixins[bandType])!==null&&_layoutMixins$bandTyp!==void 0?_layoutMixins$bandTyp:{};layoutMixins[bandType][channel]=.5}if(layoutHeaderComponent.title){var _layoutMixins$offset;layoutMixins.offset=(_layoutMixins$offset=layoutMixins.offset)!==null&&_layoutMixins$offset!==void 0?_layoutMixins$offset:{};layoutMixins.offset[channel==="row"?"rowTitle":"columnTitle"]=10}}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return layoutMixins}},{key:"assembleDefaultLayout",value:function assembleDefaultLayout(){var _this$facet=this.facet,column=_this$facet.column,row=_this$facet.row;var columns=column?this.columnDistinctSignal():row?1:undefined;var align="all";if(!row&&this.component.resolve.scale.x==="independent"){align="none"}else if(!column&&this.component.resolve.scale.y==="independent"){align="none"}return _objectSpread2(_objectSpread2(_objectSpread2({},this.getHeaderLayoutMixins()),columns?{columns:columns}:{}),{},{bounds:"full",align:align})}},{key:"assembleLayoutSignals",value:function assembleLayoutSignals(){return this.child.assembleLayoutSignals()}},{key:"columnDistinctSignal",value:function columnDistinctSignal(){if(this.parent&&this.parent instanceof FacetModel){return undefined}else{var facetLayoutDataName=this.getName("column_domain");return{signal:"length(data('".concat(facetLayoutDataName,"'))")}}}},{key:"assembleGroup",value:function assembleGroup(signals){if(this.parent&&this.parent instanceof FacetModel){return _objectSpread2(_objectSpread2({},this.channelHasField("column")?{encode:{update:{columns:{field:vgField(this.facet.column,{prefix:"distinct"})}}}}:{}),_get(_getPrototypeOf(FacetModel.prototype),"assembleGroup",this).call(this,signals))}return _get(_getPrototypeOf(FacetModel.prototype),"assembleGroup",this).call(this,signals)}},{key:"getCardinalityAggregateForChild",value:function getCardinalityAggregateForChild(){var fields=[];var ops=[];var as=[];if(this.child instanceof FacetModel){if(this.child.channelHasField("column")){var field=vgField(this.child.facet.column);fields.push(field);ops.push("distinct");as.push("distinct_".concat(field))}}else{var _iterator4=_createForOfIteratorHelper(POSITION_SCALE_CHANNELS),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var channel=_step4.value;var childScaleComponent=this.child.component.scales[channel];if(childScaleComponent&&!childScaleComponent.merged){var type=childScaleComponent.get("type");var range=childScaleComponent.get("range");if(hasDiscreteDomain(type)&&isVgRangeStep(range)){var domain=assembleDomain(this.child,channel);var _field=getFieldFromDomain(domain);if(_field){fields.push(_field);ops.push("distinct");as.push("distinct_".concat(_field))}else{warn(unknownField(channel))}}}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}return{fields:fields,ops:ops,as:as}}},{key:"assembleFacet",value:function assembleFacet(){var _this$component$data$=this.component.data.facetRoot,name=_this$component$data$.name,data=_this$component$data$.data;var _this$facet2=this.facet,row=_this$facet2.row,column=_this$facet2.column;var _this$getCardinalityA=this.getCardinalityAggregateForChild(),fields=_this$getCardinalityA.fields,ops=_this$getCardinalityA.ops,as=_this$getCardinalityA.as;var groupby=[];var _iterator5=_createForOfIteratorHelper(FACET_CHANNELS),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var channel=_step5.value;var fieldDef=this.facet[channel];if(fieldDef){groupby.push(vgField(fieldDef));var bin=fieldDef.bin,sort=fieldDef.sort;if(isBinning(bin)){groupby.push(vgField(fieldDef,{binSuffix:"end"}))}if(isSortField(sort)){var field=sort.field,_sort$op=sort.op,op=_sort$op===void 0?DEFAULT_SORT_OP:_sort$op;var outputName=facetSortFieldName(fieldDef,sort);if(row&&column){fields.push(outputName);ops.push("max");as.push(outputName)}else{fields.push(field);ops.push(op);as.push(outputName)}}else if(isArray(sort)){var _outputName=sortArrayIndexField(fieldDef,channel);fields.push(_outputName);ops.push("max");as.push(_outputName)}}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}var cross=!!row&&!!column;return _objectSpread2({name:name,data:data,groupby:groupby},cross||fields.length>0?{aggregate:_objectSpread2(_objectSpread2({},cross?{cross:cross}:{}),fields.length?{fields:fields,ops:ops,as:as}:{})}:{})}},{key:"facetSortFields",value:function facetSortFields(channel){var facet=this.facet;var fieldDef=facet[channel];if(fieldDef){if(isSortField(fieldDef.sort)){return[facetSortFieldName(fieldDef,fieldDef.sort,{expr:"datum"})]}else if(isArray(fieldDef.sort)){return[sortArrayIndexField(fieldDef,channel,{expr:"datum"})]}return[vgField(fieldDef,{expr:"datum"})]}return[]}},{key:"facetSortOrder",value:function facetSortOrder(channel){var facet=this.facet;var fieldDef=facet[channel];if(fieldDef){var sort=fieldDef.sort;var order=(isSortField(sort)?sort.order:!isArray(sort)&&sort)||"ascending";return[order]}return[]}},{key:"assembleLabelTitle",value:function assembleLabelTitle$1(){var facet=this.facet,config=this.config;if(facet.facet){return assembleLabelTitle(facet.facet,"facet",config)}var ORTHOGONAL_ORIENT={row:["top","bottom"],column:["left","right"]};var _iterator6=_createForOfIteratorHelper(HEADER_CHANNELS),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var channel=_step6.value;if(facet[channel]){var _facet$channel;var labelOrient=getHeaderProperty("labelOrient",(_facet$channel=facet[channel])===null||_facet$channel===void 0?void 0:_facet$channel.header,config,channel);if(contains(ORTHOGONAL_ORIENT[channel],labelOrient)){return assembleLabelTitle(facet[channel],channel,config)}}}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}return undefined}},{key:"assembleMarks",value:function assembleMarks(){var _this2=this;var child=this.child;var facetRoot=this.component.data.facetRoot;var data=assembleFacetData(facetRoot);var encodeEntry=child.assembleGroupEncodeEntry(false);var title=this.assembleLabelTitle()||child.assembleTitle();var style=child.assembleGroupStyle();var markGroup=_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({name:this.getName("cell"),type:"group"},title?{title:title}:{}),style?{style:style}:{}),{},{from:{facet:this.assembleFacet()},sort:{field:FACET_CHANNELS.map((function(c){return _this2.facetSortFields(c)})).flat(),order:FACET_CHANNELS.map((function(c){return _this2.facetSortOrder(c)})).flat()}},data.length>0?{data:data}:{}),encodeEntry?{encode:{update:encodeEntry}}:{}),child.assembleGroup(assembleFacetSignals(this,[])));return[markGroup]}},{key:"getMapping",value:function getMapping(){return this.facet}}]);return FacetModel}(ModelWithField);function makeJoinAggregateFromFacet(parent,facet){var row=facet.row,column=facet.column;if(row&&column){var newParent=null;for(var _i=0,_arr=[row,column];_i<_arr.length;_i++){var fieldDef=_arr[_i];if(isSortField(fieldDef.sort)){var _fieldDef$sort=fieldDef.sort,field=_fieldDef$sort.field,_fieldDef$sort$op=_fieldDef$sort.op,op=_fieldDef$sort$op===void 0?DEFAULT_SORT_OP:_fieldDef$sort$op;parent=newParent=new JoinAggregateTransformNode(parent,{joinaggregate:[{op:op,field:field,as:facetSortFieldName(fieldDef,fieldDef.sort,{forAs:true})}],groupby:[vgField(fieldDef)]})}}return newParent}return null}function findSource(data,sources){var _iterator=_createForOfIteratorHelper(sources),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var _data$format,_otherData$format,_data$format2,_otherData$format2;var other=_step.value;var otherData=other.data;if(data.name&&other.hasName()&&data.name!==other.dataName){continue}var formatMesh=(_data$format=data["format"])===null||_data$format===void 0?void 0:_data$format.mesh;var otherFeature=(_otherData$format=otherData.format)===null||_otherData$format===void 0?void 0:_otherData$format.feature;if(formatMesh&&otherFeature){continue}var formatFeature=(_data$format2=data["format"])===null||_data$format2===void 0?void 0:_data$format2.feature;if((formatFeature||otherFeature)&&formatFeature!==otherFeature){continue}var otherMesh=(_otherData$format2=otherData.format)===null||_otherData$format2===void 0?void 0:_otherData$format2.mesh;if((formatMesh||otherMesh)&&formatMesh!==otherMesh){continue}if(isInlineData(data)&&isInlineData(otherData)){if(deepEqual(data.values,otherData.values)){return other}}else if(isUrlData(data)&&isUrlData(otherData)){if(data.url===otherData.url){return other}}else if(isNamedData(data)){if(data.name===other.dataName){return other}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return null}function parseRoot(model,sources){if(model.data||!model.parent){if(model.data===null){var source=new SourceNode({values:[]});sources.push(source);return source}var existingSource=findSource(model.data,sources);if(existingSource){if(!isGenerator(model.data)){existingSource.data.format=mergeDeep({},model.data.format,existingSource.data.format)}if(!existingSource.hasName()&&model.data.name){existingSource.dataName=model.data.name}return existingSource}else{var _source=new SourceNode(model.data);sources.push(_source);return _source}}else{return model.parent.component.data.facetRoot?model.parent.component.data.facetRoot:model.parent.component.data.main}}function parseTransformArray(head,model,ancestorParse){var lookupCounter=0;var _iterator2=_createForOfIteratorHelper(model.transforms),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var t=_step2.value;var derivedType=undefined;var transformNode=void 0;if(isCalculate(t)){transformNode=head=new CalculateNode(head,t);derivedType="derived"}else if(isFilter(t)){var _ParseNode$makeWithAn;var implicit=getImplicitFromFilterTransform(t);transformNode=head=(_ParseNode$makeWithAn=ParseNode.makeWithAncestors(head,{},implicit,ancestorParse))!==null&&_ParseNode$makeWithAn!==void 0?_ParseNode$makeWithAn:head;head=new FilterNode(head,model,t.filter)}else if(isBin(t)){transformNode=head=BinNode.makeFromTransform(head,t,model);derivedType="number"}else if(isTimeUnit(t)){derivedType="date";var parsedAs=ancestorParse.getWithExplicit(t.field);if(parsedAs.value===undefined){head=new ParseNode(head,_defineProperty({},t.field,derivedType));ancestorParse.set(t.field,derivedType,false)}transformNode=head=TimeUnitNode.makeFromTransform(head,t)}else if(isAggregate$1(t)){transformNode=head=AggregateNode.makeFromTransform(head,t);derivedType="number";if(requiresSelectionId(model)){head=new IdentifierNode(head)}}else if(isLookup(t)){transformNode=head=LookupNode.make(head,model,t,lookupCounter++);derivedType="derived"}else if(isWindow(t)){transformNode=head=new WindowTransformNode(head,t);derivedType="number"}else if(isJoinAggregate(t)){transformNode=head=new JoinAggregateTransformNode(head,t);derivedType="number"}else if(isStack(t)){transformNode=head=StackNode.makeFromTransform(head,t);derivedType="derived"}else if(isFold(t)){transformNode=head=new FoldTransformNode(head,t);derivedType="derived"}else if(isFlatten(t)){transformNode=head=new FlattenTransformNode(head,t);derivedType="derived"}else if(isPivot(t)){transformNode=head=new PivotTransformNode(head,t);derivedType="derived"}else if(isSample(t)){head=new SampleTransformNode(head,t)}else if(isImpute(t)){transformNode=head=ImputeNode.makeFromTransform(head,t);derivedType="derived"}else if(isDensity(t)){transformNode=head=new DensityTransformNode(head,t);derivedType="derived"}else if(isQuantile(t)){transformNode=head=new QuantileTransformNode(head,t);derivedType="derived"}else if(isRegression(t)){transformNode=head=new RegressionTransformNode(head,t);derivedType="derived"}else if(isLoess(t)){transformNode=head=new LoessTransformNode(head,t);derivedType="derived"}else{warn(invalidTransformIgnored(t));continue}if(transformNode&&derivedType!==undefined){var _transformNode$produc;var _iterator3=_createForOfIteratorHelper((_transformNode$produc=transformNode.producedFields())!==null&&_transformNode$produc!==void 0?_transformNode$produc:[]),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var field=_step3.value;ancestorParse.set(field,derivedType,false)}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return head}function parseData(model){var _data$format3,_ParseNode$makeExplic,_ParseNode$makeWithAn2;var head=parseRoot(model,model.component.data.sources);var _model$component$data=model.component.data,outputNodes=_model$component$data.outputNodes,outputNodeRefCounts=_model$component$data.outputNodeRefCounts;var ancestorParse=model.parent?model.parent.component.data.ancestorParse.clone():new AncestorParse;var data=model.data;if(isGenerator(data)){if(isSequenceGenerator(data)){head=new SequenceNode(head,data.sequence)}else if(isGraticuleGenerator(data)){head=new GraticuleNode(head,data.graticule)}ancestorParse.parseNothing=true}else if((data===null||data===void 0?void 0:(_data$format3=data.format)===null||_data$format3===void 0?void 0:_data$format3.parse)===null){ancestorParse.parseNothing=true}head=(_ParseNode$makeExplic=ParseNode.makeExplicit(head,model,ancestorParse))!==null&&_ParseNode$makeExplic!==void 0?_ParseNode$makeExplic:head;head=new IdentifierNode(head);var parentIsLayer=model.parent&&isLayerModel(model.parent);if(isUnitModel(model)||isFacetModel(model)){if(parentIsLayer){var _BinNode$makeFromEnco;head=(_BinNode$makeFromEnco=BinNode.makeFromEncoding(head,model))!==null&&_BinNode$makeFromEnco!==void 0?_BinNode$makeFromEnco:head}}if(model.transforms.length>0){head=parseTransformArray(head,model,ancestorParse)}var implicitSelection=getImplicitFromSelection(model);var implicitEncoding=getImplicitFromEncoding(model);head=(_ParseNode$makeWithAn2=ParseNode.makeWithAncestors(head,{},_objectSpread2(_objectSpread2({},implicitSelection),implicitEncoding),ancestorParse))!==null&&_ParseNode$makeWithAn2!==void 0?_ParseNode$makeWithAn2:head;if(isUnitModel(model)){head=GeoJSONNode.parseAll(head,model);head=GeoPointNode.parseAll(head,model)}if(isUnitModel(model)||isFacetModel(model)){var _TimeUnitNode$makeFro;if(!parentIsLayer){var _BinNode$makeFromEnco2;head=(_BinNode$makeFromEnco2=BinNode.makeFromEncoding(head,model))!==null&&_BinNode$makeFromEnco2!==void 0?_BinNode$makeFromEnco2:head}head=(_TimeUnitNode$makeFro=TimeUnitNode.makeFromEncoding(head,model))!==null&&_TimeUnitNode$makeFro!==void 0?_TimeUnitNode$makeFro:head;head=CalculateNode.parseAllForSortIndex(head,model)}var rawName=model.getDataName(DataSourceType.Raw);var raw=new OutputNode(head,rawName,DataSourceType.Raw,outputNodeRefCounts);outputNodes[rawName]=raw;head=raw;if(isUnitModel(model)){var _ImputeNode$makeFromE,_StackNode$makeFromEn;var agg=AggregateNode.makeFromEncoding(head,model);if(agg){head=agg;if(requiresSelectionId(model)){head=new IdentifierNode(head)}}head=(_ImputeNode$makeFromE=ImputeNode.makeFromEncoding(head,model))!==null&&_ImputeNode$makeFromE!==void 0?_ImputeNode$makeFromE:head;head=(_StackNode$makeFromEn=StackNode.makeFromEncoding(head,model))!==null&&_StackNode$makeFromEn!==void 0?_StackNode$makeFromEn:head}if(isUnitModel(model)){var _FilterInvalidNode$ma;head=(_FilterInvalidNode$ma=FilterInvalidNode.make(head,model))!==null&&_FilterInvalidNode$ma!==void 0?_FilterInvalidNode$ma:head}var mainName=model.getDataName(DataSourceType.Main);var main=new OutputNode(head,mainName,DataSourceType.Main,outputNodeRefCounts);outputNodes[mainName]=main;head=main;if(isUnitModel(model)){materializeSelections(model,main)}var facetRoot=null;if(isFacetModel(model)){var _makeJoinAggregateFro;var facetName=model.getName("facet");head=(_makeJoinAggregateFro=makeJoinAggregateFromFacet(head,model.facet))!==null&&_makeJoinAggregateFro!==void 0?_makeJoinAggregateFro:head;facetRoot=new FacetNode(head,model,facetName,main.getSource());outputNodes[facetName]=facetRoot}return _objectSpread2(_objectSpread2({},model.component.data),{},{outputNodes:outputNodes,outputNodeRefCounts:outputNodeRefCounts,raw:raw,main:main,facetRoot:facetRoot,ancestorParse:ancestorParse})}var ConcatModel=function(_Model){_inherits(ConcatModel,_Model);var _super=_createSuper(ConcatModel);function ConcatModel(spec,parent,parentGivenName,config){var _spec$resolve,_spec$resolve$axis,_spec$resolve2,_spec$resolve2$axis;var _this;_classCallCheck(this,ConcatModel);_this=_super.call(this,spec,"concat",parent,parentGivenName,config,spec.resolve);_defineProperty(_assertThisInitialized(_this),"children",void 0);if(((_spec$resolve=spec.resolve)===null||_spec$resolve===void 0?void 0:(_spec$resolve$axis=_spec$resolve.axis)===null||_spec$resolve$axis===void 0?void 0:_spec$resolve$axis.x)==="shared"||((_spec$resolve2=spec.resolve)===null||_spec$resolve2===void 0?void 0:(_spec$resolve2$axis=_spec$resolve2.axis)===null||_spec$resolve2$axis===void 0?void 0:_spec$resolve2$axis.y)==="shared"){warn(CONCAT_CANNOT_SHARE_AXIS)}_this.children=_this.getChildren(spec).map((function(child,i){return buildModel(child,_assertThisInitialized(_this),_this.getName("concat_"+i),undefined,config)}));return _this}_createClass(ConcatModel,[{key:"parseData",value:function parseData$1(){this.component.data=parseData(this);var _iterator=_createForOfIteratorHelper(this.children),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var child=_step.value;child.parseData()}}catch(err){_iterator.e(err)}finally{_iterator.f()}}},{key:"parseSelections",value:function parseSelections(){this.component.selection={};var _iterator2=_createForOfIteratorHelper(this.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;child.parseSelections();var _iterator3=_createForOfIteratorHelper(keys(child.component.selection)),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var key=_step3.value;this.component.selection[key]=child.component.selection[key]}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}},{key:"parseMarkGroup",value:function parseMarkGroup(){var _iterator4=_createForOfIteratorHelper(this.children),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var child=_step4.value;child.parseMarkGroup()}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}},{key:"parseAxesAndHeaders",value:function parseAxesAndHeaders(){var _iterator5=_createForOfIteratorHelper(this.children),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var child=_step5.value;child.parseAxesAndHeaders()}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}}},{key:"getChildren",value:function getChildren(spec){if(isVConcatSpec(spec)){return spec.vconcat}else if(isHConcatSpec(spec)){return spec.hconcat}return spec.concat}},{key:"parseLayoutSize",value:function parseLayoutSize(){parseConcatLayoutSize(this)}},{key:"parseAxisGroup",value:function parseAxisGroup(){return null}},{key:"assembleSelectionTopLevelSignals",value:function assembleSelectionTopLevelSignals(signals){return this.children.reduce((function(sg,child){return child.assembleSelectionTopLevelSignals(sg)}),signals)}},{key:"assembleSignals",value:function assembleSignals(){this.children.forEach((function(child){return child.assembleSignals()}));return[]}},{key:"assembleLayoutSignals",value:function assembleLayoutSignals$1(){var layoutSignals=assembleLayoutSignals(this);var _iterator6=_createForOfIteratorHelper(this.children),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var child=_step6.value;layoutSignals.push.apply(layoutSignals,_toConsumableArray(child.assembleLayoutSignals()))}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}return layoutSignals}},{key:"assembleSelectionData",value:function assembleSelectionData(data){return this.children.reduce((function(db,child){return child.assembleSelectionData(db)}),data)}},{key:"assembleMarks",value:function assembleMarks(){return this.children.map((function(child){var title=child.assembleTitle();var style=child.assembleGroupStyle();var encodeEntry=child.assembleGroupEncodeEntry(false);return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({type:"group",name:child.getName("group")},title?{title:title}:{}),style?{style:style}:{}),encodeEntry?{encode:{update:encodeEntry}}:{}),child.assembleGroup())}))}},{key:"assembleDefaultLayout",value:function assembleDefaultLayout(){var columns=this.layout.columns;return _objectSpread2(_objectSpread2({},columns!=null?{columns:columns}:{}),{},{bounds:"full",align:"each"})}}]);return ConcatModel}(Model);function isFalseOrNull(v){return v===false||v===null}var AXIS_COMPONENT_PROPERTIES_INDEX=_objectSpread2(_objectSpread2({disable:1,gridScale:1,scale:1},COMMON_AXIS_PROPERTIES_INDEX),{},{labelExpr:1,encode:1});var AXIS_COMPONENT_PROPERTIES=keys(AXIS_COMPONENT_PROPERTIES_INDEX);var AxisComponent=function(_Split){_inherits(AxisComponent,_Split);var _super=_createSuper(AxisComponent);function AxisComponent(){var _this;var explicit=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var implicit=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var mainExtracted=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;_classCallCheck(this,AxisComponent);_this=_super.call(this);_this.explicit=explicit;_this.implicit=implicit;_this.mainExtracted=mainExtracted;return _this}_createClass(AxisComponent,[{key:"clone",value:function clone(){return new AxisComponent(duplicate(this.explicit),duplicate(this.implicit),this.mainExtracted)}},{key:"hasAxisPart",value:function hasAxisPart(part){if(part==="axis"){return true}if(part==="grid"||part==="title"){return!!this.get(part)}return!isFalseOrNull(this.get(part))}},{key:"hasOrientSignalRef",value:function hasOrientSignalRef(){return isSignalRef(this.explicit.orient)}}]);return AxisComponent}(Split);function labels$1(model,channel,specifiedLabelsSpec){var _getFieldOrDatumDef;var encoding=model.encoding,config=model.config;var fieldOrDatumDef=(_getFieldOrDatumDef=getFieldOrDatumDef(encoding[channel]))!==null&&_getFieldOrDatumDef!==void 0?_getFieldOrDatumDef:getFieldOrDatumDef(encoding[getSecondaryRangeChannel(channel)]);var axis=model.axis(channel)||{};var format=axis.format,formatType=axis.formatType;if(isCustomFormatType(formatType)){return _objectSpread2({text:formatCustomType({fieldOrDatumDef:fieldOrDatumDef,field:"datum.value",format:format,formatType:formatType,config:config})},specifiedLabelsSpec)}return specifiedLabelsSpec}function parseUnitAxes(model){return POSITION_SCALE_CHANNELS.reduce((function(axis,channel){if(model.component.scales[channel]){axis[channel]=[parseAxis(channel,model)]}return axis}),{})}var OPPOSITE_ORIENT={bottom:"top",top:"bottom",left:"right",right:"left"};function parseLayerAxes(model){var _model$component=model.component,axes=_model$component.axes,resolve=_model$component.resolve;var axisCount={top:0,bottom:0,right:0,left:0};var _iterator=_createForOfIteratorHelper(model.children),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var child=_step.value;child.parseAxesAndHeaders();var _iterator3=_createForOfIteratorHelper(keys(child.component.axes)),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var channel=_step3.value;resolve.axis[channel]=parseGuideResolve(model.component.resolve,channel);if(resolve.axis[channel]==="shared"){axes[channel]=mergeAxisComponents(axes[channel],child.component.axes[channel]);if(!axes[channel]){resolve.axis[channel]="independent";delete axes[channel]}}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}catch(err){_iterator.e(err)}finally{_iterator.f()}var _iterator2=_createForOfIteratorHelper(POSITION_SCALE_CHANNELS),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _channel=_step2.value;var _iterator4=_createForOfIteratorHelper(model.children),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _child=_step4.value;if(!_child.component.axes[_channel]){continue}if(resolve.axis[_channel]==="independent"){var _axes$_channel;axes[_channel]=((_axes$_channel=axes[_channel])!==null&&_axes$_channel!==void 0?_axes$_channel:[]).concat(_child.component.axes[_channel]);var _iterator6=_createForOfIteratorHelper(_child.component.axes[_channel]),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var axisComponent=_step6.value;var _axisComponent$getWit=axisComponent.getWithExplicit("orient"),orient=_axisComponent$getWit.value,explicit=_axisComponent$getWit.explicit;if(isSignalRef(orient)){continue}if(axisCount[orient]>0&&!explicit){var oppositeOrient=OPPOSITE_ORIENT[orient];if(axisCount[orient]>axisCount[oppositeOrient]){axisComponent.set("orient",oppositeOrient,false)}}axisCount[orient]++}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}}delete _child.component.axes[_channel]}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}if(resolve.axis[_channel]==="independent"&&axes[_channel]&&axes[_channel].length>1){var _iterator5=_createForOfIteratorHelper(axes[_channel]),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var axisCmpt=_step5.value;if(!!axisCmpt.get("grid")&&!axisCmpt.explicit.grid){axisCmpt.implicit.grid=false}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}function mergeAxisComponents(mergedAxisCmpts,childAxisCmpts){if(mergedAxisCmpts){if(mergedAxisCmpts.length!==childAxisCmpts.length){return undefined}var length=mergedAxisCmpts.length;for(var i=0;i<length;i++){var merged=mergedAxisCmpts[i];var child=childAxisCmpts[i];if(!!merged!==!!child){return undefined}else if(merged&&child){var mergedOrient=merged.getWithExplicit("orient");var childOrient=child.getWithExplicit("orient");if(mergedOrient.explicit&&childOrient.explicit&&mergedOrient.value!==childOrient.value){return undefined}else{mergedAxisCmpts[i]=mergeAxisComponent(merged,child)}}}}else{return childAxisCmpts.map((function(axisComponent){return axisComponent.clone()}))}return mergedAxisCmpts}function mergeAxisComponent(merged,child){var _iterator7=_createForOfIteratorHelper(AXIS_COMPONENT_PROPERTIES),_step7;try{var _loop=function _loop(){var prop=_step7.value;var mergedValueWithExplicit=mergeValuesWithExplicit(merged.getWithExplicit(prop),child.getWithExplicit(prop),prop,"axis",(function(v1,v2){switch(prop){case"title":return mergeTitleComponent(v1,v2);case"gridScale":return{explicit:v1.explicit,value:getFirstDefined(v1.value,v2.value)}}return defaultTieBreaker(v1,v2,prop,"axis")}));merged.setWithExplicit(prop,mergedValueWithExplicit)};for(_iterator7.s();!(_step7=_iterator7.n()).done;){_loop()}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}return merged}function isExplicit$1(value,property,axis,model,channel){if(property==="disable"){return axis!==undefined}axis=axis||{};switch(property){case"titleAngle":case"labelAngle":return value===(isSignalRef(axis.labelAngle)?axis.labelAngle:normalizeAngle(axis.labelAngle));case"values":return!!axis.values;case"encode":return!!axis.encoding||!!axis.labelAngle;case"title":if(value===getFieldDefTitle(model,channel)){return true}}return value===axis[property]}var propsToAlwaysIncludeConfig=new Set(["grid","translate","format","formatType","orient","labelExpr","tickCount","position","tickMinStep"]);function parseAxis(channel,model){var _axis,_config,_config$axis,_axis2,_axis$encoding;var axis=model.axis(channel);var axisComponent=new AxisComponent;var fieldOrDatumDef=getFieldOrDatumDef(model.encoding[channel]);var mark=model.mark,config=model.config;var orient=((_axis=axis)===null||_axis===void 0?void 0:_axis.orient)||((_config=config[channel==="x"?"axisX":"axisY"])===null||_config===void 0?void 0:_config.orient)||((_config$axis=config.axis)===null||_config$axis===void 0?void 0:_config$axis.orient)||defaultOrient(channel);var scaleType=model.getScaleComponent(channel).get("type");var axisConfigs=getAxisConfigs(channel,scaleType,orient,model.config);var disable=axis!==undefined?!axis:getAxisConfig("disable",config.style,(_axis2=axis)===null||_axis2===void 0?void 0:_axis2.style,axisConfigs).configValue;axisComponent.set("disable",disable,axis!==undefined);if(disable){return axisComponent}axis=axis||{};var labelAngle=getLabelAngle(fieldOrDatumDef,axis,channel,config.style,axisConfigs);var ruleParams={fieldOrDatumDef:fieldOrDatumDef,axis:axis,channel:channel,model:model,scaleType:scaleType,orient:orient,labelAngle:labelAngle,mark:mark,config:config};var _iterator8=_createForOfIteratorHelper(AXIS_COMPONENT_PROPERTIES),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var property=_step8.value;var value=property in axisRules?axisRules[property](ruleParams):isAxisProperty(property)?axis[property]:undefined;var hasValue=value!==undefined;var explicit=isExplicit$1(value,property,axis,model,channel);if(hasValue&&explicit){axisComponent.set(property,value,explicit)}else{var _ref=isAxisProperty(property)&&property!=="values"?getAxisConfig(property,config.style,axis.style,axisConfigs):{},_ref$configValue=_ref.configValue,configValue=_ref$configValue===void 0?undefined:_ref$configValue,_ref$configFrom=_ref.configFrom,configFrom=_ref$configFrom===void 0?undefined:_ref$configFrom;var hasConfigValue=configValue!==undefined;if(hasValue&&!hasConfigValue){axisComponent.set(property,value,explicit)}else if(!(configFrom==="vgAxisConfig")||propsToAlwaysIncludeConfig.has(property)&&hasConfigValue||isConditionalAxisValue(configValue)||isSignalRef(configValue)){axisComponent.set(property,configValue,false)}}}}catch(err){_iterator8.e(err)}finally{_iterator8.f()}var axisEncoding=(_axis$encoding=axis.encoding)!==null&&_axis$encoding!==void 0?_axis$encoding:{};var axisEncode=AXIS_PARTS.reduce((function(e,part){var _axisEncoding$part;if(!axisComponent.hasAxisPart(part)){return e}var axisEncodingPart=guideEncodeEntry((_axisEncoding$part=axisEncoding[part])!==null&&_axisEncoding$part!==void 0?_axisEncoding$part:{},model);var value=part==="labels"?labels$1(model,channel,axisEncodingPart):axisEncodingPart;if(value!==undefined&&!isEmpty(value)){e[part]={update:value}}return e}),{});if(!isEmpty(axisEncode)){axisComponent.set("encode",axisEncode,!!axis.encoding||axis.labelAngle!==undefined)}return axisComponent}function initLayoutSize(_ref){var encoding=_ref.encoding,size=_ref.size;var _iterator=_createForOfIteratorHelper(POSITION_SCALE_CHANNELS),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var channel=_step.value;var sizeType=getSizeChannel(channel);if(isStep(size[sizeType])){if(isContinuousFieldOrDatumDef(encoding[channel])){delete size[sizeType];warn(stepDropped(sizeType))}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return size}function initMarkdef(originalMarkDef,encoding,config){var markDef=replaceExprRefInIndex(originalMarkDef);var specifiedOrient=getMarkPropOrConfig("orient",markDef,config);markDef.orient=orient(markDef.type,encoding,specifiedOrient);if(specifiedOrient!==undefined&&specifiedOrient!==markDef.orient){warn(orientOverridden(markDef.orient,specifiedOrient))}if(markDef.type==="bar"&&markDef.orient){var cornerRadiusEnd=getMarkPropOrConfig("cornerRadiusEnd",markDef,config);if(cornerRadiusEnd!==undefined){var newProps=markDef.orient==="horizontal"&&encoding.x2||markDef.orient==="vertical"&&encoding.y2?["cornerRadius"]:BAR_CORNER_RADIUS_INDEX[markDef.orient];var _iterator=_createForOfIteratorHelper(newProps),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var newProp=_step.value;markDef[newProp]=cornerRadiusEnd}}catch(err){_iterator.e(err)}finally{_iterator.f()}if(markDef.cornerRadiusEnd!==undefined){delete markDef.cornerRadiusEnd}}}var specifiedOpacity=getMarkPropOrConfig("opacity",markDef,config);if(specifiedOpacity===undefined){markDef.opacity=opacity(markDef.type,encoding)}var specifiedCursor=getMarkPropOrConfig("cursor",markDef,config);if(specifiedCursor===undefined){markDef.cursor=cursor(markDef,encoding,config)}return markDef}function cursor(markDef,encoding,config){if(encoding.href||markDef.href||getMarkPropOrConfig("href",markDef,config)){return"pointer"}return markDef.cursor}function opacity(mark,encoding){if(contains([POINT,TICK,CIRCLE,SQUARE],mark)){if(!isAggregate(encoding)){return.7}}return undefined}function defaultFilled(markDef,config,_ref){var graticule=_ref.graticule;if(graticule){return false}var filledConfig=getMarkConfig("filled",markDef,config);var mark=markDef.type;return getFirstDefined(filledConfig,mark!==POINT&&mark!==LINE&&mark!==RULE)}function orient(mark,encoding,specifiedOrient){switch(mark){case POINT:case CIRCLE:case SQUARE:case TEXT$1:case RECT:case IMAGE:return undefined}var x=encoding.x,y=encoding.y,x2=encoding.x2,y2=encoding.y2;switch(mark){case BAR:if(isFieldDef(x)&&(isBinned(x.bin)||isFieldDef(y)&&y.aggregate&&!x.aggregate)){return"vertical"}if(isFieldDef(y)&&(isBinned(y.bin)||isFieldDef(x)&&x.aggregate&&!y.aggregate)){return"horizontal"}if(y2||x2){if(specifiedOrient){return specifiedOrient}if(!x2){if(isFieldDef(x)&&x.type===QUANTITATIVE&&!isBinning(x.bin)||isNumericDataDef(x)){return"horizontal"}}if(!y2){if(isFieldDef(y)&&y.type===QUANTITATIVE&&!isBinning(y.bin)||isNumericDataDef(y)){return"vertical"}}}case RULE:if(x2&&!(isFieldDef(x)&&isBinned(x.bin))&&y2&&!(isFieldDef(y)&&isBinned(y.bin))){return undefined}case AREA:if(y2){if(isFieldDef(y)&&isBinned(y.bin)){return"horizontal"}else{return"vertical"}}else if(x2){if(isFieldDef(x)&&isBinned(x.bin)){return"vertical"}else{return"horizontal"}}else if(mark===RULE){if(x&&!y){return"vertical"}else if(y&&!x){return"horizontal"}}case LINE:case TICK:{var xIsContinuous=isContinuousFieldOrDatumDef(x);var yIsContinuous=isContinuousFieldOrDatumDef(y);if(xIsContinuous&&!yIsContinuous){return mark!=="tick"?"horizontal":"vertical"}else if(!xIsContinuous&&yIsContinuous){return mark!=="tick"?"vertical":"horizontal"}else if(xIsContinuous&&yIsContinuous){var xDef=x;var yDef=y;var xIsTemporal=xDef.type===TEMPORAL;var yIsTemporal=yDef.type===TEMPORAL;if(xIsTemporal&&!yIsTemporal){return mark!=="tick"?"vertical":"horizontal"}else if(!xIsTemporal&&yIsTemporal){return mark!=="tick"?"horizontal":"vertical"}if(!xDef.aggregate&&yDef.aggregate){return mark!=="tick"?"vertical":"horizontal"}else if(xDef.aggregate&&!yDef.aggregate){return mark!=="tick"?"horizontal":"vertical"}if(specifiedOrient){return specifiedOrient}return"vertical"}else{if(specifiedOrient){return specifiedOrient}return undefined}}}return"vertical"}var arc={vgMark:"arc",encodeEntry:function encodeEntry(model){return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"})),pointPosition("x",model,{defaultPos:"mid"})),pointPosition("y",model,{defaultPos:"mid"})),rectPosition(model,"radius","arc")),rectPosition(model,"theta","arc"))}};var area={vgMark:"area",encodeEntry:function encodeEntry(model){return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",orient:"include",size:"ignore",theta:"ignore"})),pointOrRangePosition("x",model,{defaultPos:"zeroOrMin",defaultPos2:"zeroOrMin",range:model.markDef.orient==="horizontal"})),pointOrRangePosition("y",model,{defaultPos:"zeroOrMin",defaultPos2:"zeroOrMin",range:model.markDef.orient==="vertical"})),defined(model))}};var bar={vgMark:"rect",encodeEntry:function encodeEntry(model){return _objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"})),rectPosition(model,"x","bar")),rectPosition(model,"y","bar"))}};var geoshape={vgMark:"shape",encodeEntry:function encodeEntry(model){return _objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"}))},postEncodingTransform:function postEncodingTransform(model){var encoding=model.encoding;var shapeDef=encoding.shape;var transform=_objectSpread2({type:"geoshape",projection:model.projectionName()},shapeDef&&isFieldDef(shapeDef)&&shapeDef.type===GEOJSON?{field:vgField(shapeDef,{expr:"datum"})}:{});return[transform]}};var image={vgMark:"image",encodeEntry:function encodeEntry(model){return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"ignore",orient:"ignore",size:"ignore",theta:"ignore"})),rectPosition(model,"x","image")),rectPosition(model,"y","image")),text(model,"url"))}};var line={vgMark:"line",encodeEntry:function encodeEntry(model){return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"})),pointPosition("x",model,{defaultPos:"mid"})),pointPosition("y",model,{defaultPos:"mid"})),nonPosition("size",model,{vgChannel:"strokeWidth"})),defined(model))}};var trail={vgMark:"trail",encodeEntry:function encodeEntry(model){return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",size:"include",orient:"ignore",theta:"ignore"})),pointPosition("x",model,{defaultPos:"mid"})),pointPosition("y",model,{defaultPos:"mid"})),nonPosition("size",model)),defined(model))}};function _encodeEntry(model,fixedShape){var config=model.config;return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",size:"include",orient:"ignore",theta:"ignore"})),pointPosition("x",model,{defaultPos:"mid"})),pointPosition("y",model,{defaultPos:"mid"})),nonPosition("size",model)),nonPosition("angle",model)),shapeMixins(model,config,fixedShape))}function shapeMixins(model,config,fixedShape){if(fixedShape){return{shape:{value:fixedShape}}}return nonPosition("shape",model)}var point={vgMark:"symbol",encodeEntry:function encodeEntry(model){return _encodeEntry(model)}};var circle={vgMark:"symbol",encodeEntry:function encodeEntry(model){return _encodeEntry(model,"circle")}};var square={vgMark:"symbol",encodeEntry:function encodeEntry(model){return _encodeEntry(model,"square")}};var rect={vgMark:"rect",encodeEntry:function encodeEntry(model){return _objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"})),rectPosition(model,"x","rect")),rectPosition(model,"y","rect"))}};var rule={vgMark:"rule",encodeEntry:function encodeEntry(model){var markDef=model.markDef;var orient=markDef.orient;if(!model.encoding.x&&!model.encoding.y&&!model.encoding.latitude&&!model.encoding.longitude){return{}}return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"})),pointOrRangePosition("x",model,{defaultPos:orient==="horizontal"?"zeroOrMax":"mid",defaultPos2:"zeroOrMin",range:orient!=="vertical"})),pointOrRangePosition("y",model,{defaultPos:orient==="vertical"?"zeroOrMax":"mid",defaultPos2:"zeroOrMin",range:orient!=="horizontal"})),nonPosition("size",model,{vgChannel:"strokeWidth"}))}};var text$1={vgMark:"text",encodeEntry:function encodeEntry(model){var config=model.config,encoding=model.encoding;return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"include",baseline:"include",color:"include",size:"ignore",orient:"ignore",theta:"include"})),pointPosition("x",model,{defaultPos:"mid"})),pointPosition("y",model,{defaultPos:"mid"})),text(model)),nonPosition("size",model,{vgChannel:"fontSize"})),nonPosition("angle",model)),valueIfDefined("align",align(model.markDef,encoding,config))),valueIfDefined("baseline",baseline(model.markDef,encoding,config))),pointPosition("radius",model,{defaultPos:null,isMidPoint:true})),pointPosition("theta",model,{defaultPos:null,isMidPoint:true}))}};function align(markDef,encoding,config){var a=getMarkPropOrConfig("align",markDef,config);if(a===undefined){return"center"}return undefined}function baseline(markDef,encoding,config){var b=getMarkPropOrConfig("baseline",markDef,config);if(b===undefined){return"middle"}return undefined}var tick={vgMark:"rect",encodeEntry:function encodeEntry(model){var config=model.config,markDef=model.markDef;var orient=markDef.orient;var vgSizeChannel=orient==="horizontal"?"width":"height";var vgThicknessChannel=orient==="horizontal"?"height":"width";return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({},baseEncodeEntry(model,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"})),pointPosition("x",model,{defaultPos:"mid",vgChannel:"xc"})),pointPosition("y",model,{defaultPos:"mid",vgChannel:"yc"})),nonPosition("size",model,{defaultValue:defaultSize(model),vgChannel:vgSizeChannel})),{},_defineProperty({},vgThicknessChannel,signalOrValueRef(getMarkPropOrConfig("thickness",markDef,config))))}};function defaultSize(model){var _getMarkPropOrConfig;var config=model.config,markDef=model.markDef;var orient=markDef.orient;var vgSizeChannel=orient==="horizontal"?"width":"height";var scale=model.getScaleComponent(orient==="horizontal"?"x":"y");var markPropOrConfig=(_getMarkPropOrConfig=getMarkPropOrConfig("size",markDef,config,{vgChannel:vgSizeChannel}))!==null&&_getMarkPropOrConfig!==void 0?_getMarkPropOrConfig:config.tick.bandSize;if(markPropOrConfig!==undefined){return markPropOrConfig}else{var scaleRange=scale?scale.get("range"):undefined;if(scaleRange&&isVgRangeStep(scaleRange)&&isNumber(scaleRange.step)){return scaleRange.step*3/4}var defaultViewStep=getViewConfigDiscreteStep(config.view,vgSizeChannel);return defaultViewStep*3/4}}var markCompiler={arc:arc,area:area,bar:bar,circle:circle,geoshape:geoshape,image:image,line:line,point:point,rect:rect,rule:rule,square:square,text:text$1,tick:tick,trail:trail};function parseMarkGroups(model){if(contains([LINE,AREA,TRAIL],model.mark)){var details=pathGroupingFields(model.mark,model.encoding);if(details.length>0){return getPathGroups(model,details)}}else if(contains([BAR],model.mark)){var hasCornerRadius=VG_CORNERRADIUS_CHANNELS.some((function(prop){return getMarkPropOrConfig(prop,model.markDef,model.config)}));if(model.stack&&!model.fieldDef("size")&&hasCornerRadius){return getGroupsForStackedBarWithCornerRadius(model)}}return getMarkGroup(model)}var FACETED_PATH_PREFIX="faceted_path_";function getPathGroups(model,details){return[{name:model.getName("pathgroup"),type:"group",from:{facet:{name:FACETED_PATH_PREFIX+model.requestDataName(DataSourceType.Main),data:model.requestDataName(DataSourceType.Main),groupby:details}},encode:{update:{width:{field:{group:"width"}},height:{field:{group:"height"}}}},marks:getMarkGroup(model,{fromPrefix:FACETED_PATH_PREFIX})}]}var STACK_GROUP_PREFIX="stack_group_";function getGroupsForStackedBarWithCornerRadius(model){var _getMarkGroup=getMarkGroup(model,{fromPrefix:STACK_GROUP_PREFIX}),_getMarkGroup2=_slicedToArray(_getMarkGroup,1),mark=_getMarkGroup2[0];var fieldScale=model.scaleName(model.stack.fieldChannel);var stackField=function stackField(){var opt=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return model.vgField(model.stack.fieldChannel,opt)};var stackFieldGroup=function stackFieldGroup(func,expr){var vgFieldMinMax=[stackField({prefix:"min",suffix:"start",expr:expr}),stackField({prefix:"max",suffix:"start",expr:expr}),stackField({prefix:"min",suffix:"end",expr:expr}),stackField({prefix:"max",suffix:"end",expr:expr})];return"".concat(func,"(").concat(vgFieldMinMax.map((function(field){return"scale('".concat(fieldScale,"',").concat(field,")")})).join(","),")")};var groupUpdate;var innerGroupUpdate;if(model.stack.fieldChannel==="x"){groupUpdate=_objectSpread2(_objectSpread2({},pick(mark.encode.update,["y","yc","y2","height"].concat(_toConsumableArray(VG_CORNERRADIUS_CHANNELS)))),{},{x:{signal:stackFieldGroup("min","datum")},x2:{signal:stackFieldGroup("max","datum")},clip:{value:true}});innerGroupUpdate={x:{field:{group:"x"},mult:-1},height:{field:{group:"height"}}};mark.encode.update=_objectSpread2(_objectSpread2({},omit(mark.encode.update,["y","yc","y2"])),{},{height:{field:{group:"height"}}})}else{groupUpdate=_objectSpread2(_objectSpread2({},pick(mark.encode.update,["x","xc","x2","width"])),{},{y:{signal:stackFieldGroup("min","datum")},y2:{signal:stackFieldGroup("max","datum")},clip:{value:true}});innerGroupUpdate={y:{field:{group:"y"},mult:-1},width:{field:{group:"width"}}};mark.encode.update=_objectSpread2(_objectSpread2({},omit(mark.encode.update,["x","xc","x2"])),{},{width:{field:{group:"width"}}})}var _iterator=_createForOfIteratorHelper(VG_CORNERRADIUS_CHANNELS),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var key=_step.value;var configValue=getMarkConfig(key,model.markDef,model.config);if(mark.encode.update[key]){groupUpdate[key]=mark.encode.update[key];delete mark.encode.update[key]}else if(configValue){groupUpdate[key]=signalOrValueRef(configValue)}if(configValue){mark.encode.update[key]={value:0}}}}catch(err){_iterator.e(err)}finally{_iterator.f()}var groupByField=model.fieldDef(model.stack.groupbyChannel);var groupby=vgField(groupByField)?[vgField(groupByField)]:[];if((groupByField===null||groupByField===void 0?void 0:groupByField.bin)||(groupByField===null||groupByField===void 0?void 0:groupByField.timeUnit)){groupby.push(vgField(groupByField,{binSuffix:"end"}))}var strokeProperties=["stroke","strokeWidth","strokeJoin","strokeCap","strokeDash","strokeDashOffset","strokeMiterLimit","strokeOpacity"];groupUpdate=strokeProperties.reduce((function(encode,prop){if(mark.encode.update[prop]){return _objectSpread2(_objectSpread2({},encode),{},_defineProperty({},prop,mark.encode.update[prop]))}else{var configValue=getMarkConfig(prop,model.markDef,model.config);if(configValue!==undefined){return _objectSpread2(_objectSpread2({},encode),{},_defineProperty({},prop,signalOrValueRef(configValue)))}else{return encode}}}),groupUpdate);if(groupUpdate.stroke){groupUpdate.strokeForeground={value:true};groupUpdate.strokeOffset={value:0}}return[{type:"group",from:{facet:{data:model.requestDataName(DataSourceType.Main),name:STACK_GROUP_PREFIX+model.requestDataName(DataSourceType.Main),groupby:groupby,aggregate:{fields:[stackField({suffix:"start"}),stackField({suffix:"start"}),stackField({suffix:"end"}),stackField({suffix:"end"})],ops:["min","max","min","max"]}}},encode:{update:groupUpdate},marks:[{type:"group",encode:{update:innerGroupUpdate},marks:[mark]}]}]}function getSort$1(model){var encoding=model.encoding,stack=model.stack,mark=model.mark,markDef=model.markDef,config=model.config;var order=encoding.order;if(!isArray(order)&&isValueDef(order)&&isNullOrFalse(order.value)||!order&&isNullOrFalse(getMarkPropOrConfig("order",markDef,config))){return undefined}else if((isArray(order)||isFieldDef(order))&&!stack){return sortParams(order,{expr:"datum"})}else if(isPathMark(mark)){var dimensionChannel=markDef.orient==="horizontal"?"y":"x";var dimensionChannelDef=encoding[dimensionChannel];if(isFieldDef(dimensionChannelDef)){var s=dimensionChannelDef.sort;if(isArray(s)){return{field:vgField(dimensionChannelDef,{prefix:dimensionChannel,suffix:"sort_index",expr:"datum"})}}else if(isSortField(s)){return{field:vgField({aggregate:isAggregate(model.encoding)?s.op:undefined,field:s.field},{expr:"datum"})}}else if(isSortByEncoding(s)){var fieldDefToSort=model.fieldDef(s.encoding);return{field:vgField(fieldDefToSort,{expr:"datum"}),order:s.order}}else if(s===null){return undefined}else{return{field:vgField(dimensionChannelDef,{binSuffix:model.stack&&model.stack.impute?"mid":undefined,expr:"datum"})}}}return undefined}return undefined}function getMarkGroup(model){var opt=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{fromPrefix:""};var mark=model.mark,markDef=model.markDef,encoding=model.encoding,config=model.config;var clip=getFirstDefined(markDef.clip,scaleClip(model),projectionClip(model));var style=getStyles(markDef);var key=encoding.key;var sort=getSort$1(model);var interactive=interactiveFlag(model);var aria=getMarkPropOrConfig("aria",markDef,config);var postEncodingTransform=markCompiler[mark].postEncodingTransform?markCompiler[mark].postEncodingTransform(model):null;return[_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({name:model.getName("marks"),type:markCompiler[mark].vgMark},clip?{clip:true}:{}),style?{style:style}:{}),key?{key:key.field}:{}),sort?{sort:sort}:{}),interactive?interactive:{}),aria===false?{aria:aria}:{}),{},{from:{data:opt.fromPrefix+model.requestDataName(DataSourceType.Main)},encode:{update:markCompiler[mark].encodeEntry(model)}},postEncodingTransform?{transform:postEncodingTransform}:{})]}function scaleClip(model){var xScale=model.getScaleComponent("x");var yScale=model.getScaleComponent("y");return xScale&&xScale.get("selectionExtent")||yScale&&yScale.get("selectionExtent")?true:undefined}function projectionClip(model){var projection=model.component.projection;return projection&&!projection.isFit?true:undefined}function interactiveFlag(model){if(!model.component.selection)return null;var unitCount=keys(model.component.selection).length;var parentCount=unitCount;var parent=model.parent;while(parent&&parentCount===0){parentCount=keys(parent.component.selection).length;parent=parent.parent}return parentCount?{interactive:unitCount>0||!!model.encoding.tooltip}:null}var UnitModel=function(_ModelWithField){_inherits(UnitModel,_ModelWithField);var _super=_createSuper(UnitModel);function UnitModel(spec,parent,parentGivenName){var _this;var parentGivenSize=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};var config=arguments.length>4?arguments[4]:undefined;_classCallCheck(this,UnitModel);_this=_super.call(this,spec,"unit",parent,parentGivenName,config,undefined,isFrameMixins(spec)?spec.view:undefined);_defineProperty(_assertThisInitialized(_this),"markDef",void 0);_defineProperty(_assertThisInitialized(_this),"encoding",void 0);_defineProperty(_assertThisInitialized(_this),"specifiedScales",{});_defineProperty(_assertThisInitialized(_this),"stack",void 0);_defineProperty(_assertThisInitialized(_this),"specifiedAxes",{});_defineProperty(_assertThisInitialized(_this),"specifiedLegends",{});_defineProperty(_assertThisInitialized(_this),"specifiedProjection",{});_defineProperty(_assertThisInitialized(_this),"selection",{});_defineProperty(_assertThisInitialized(_this),"children",[]);var markDef=isMarkDef(spec.mark)?_objectSpread2({},spec.mark):{type:spec.mark};var mark=markDef.type;if(markDef.filled===undefined){markDef.filled=defaultFilled(markDef,config,{graticule:spec.data&&isGraticuleGenerator(spec.data)})}var encoding=_this.encoding=initEncoding(spec.encoding||{},mark,markDef.filled,config);_this.markDef=initMarkdef(markDef,encoding,config);_this.size=initLayoutSize({encoding:encoding,size:isFrameMixins(spec)?_objectSpread2(_objectSpread2(_objectSpread2({},parentGivenSize),spec.width?{width:spec.width}:{}),spec.height?{height:spec.height}:{}):parentGivenSize});_this.stack=stack(mark,encoding);_this.specifiedScales=_this.initScales(mark,encoding);_this.specifiedAxes=_this.initAxes(encoding);_this.specifiedLegends=_this.initLegends(encoding);_this.specifiedProjection=spec.projection;_this.selection=spec.selection;return _this}_createClass(UnitModel,[{key:"scaleDomain",value:function scaleDomain(channel){var scale=this.specifiedScales[channel];return scale?scale.domain:undefined}},{key:"axis",value:function axis(channel){return this.specifiedAxes[channel]}},{key:"legend",value:function legend(channel){return this.specifiedLegends[channel]}},{key:"initScales",value:function initScales(mark,encoding){var _this2=this;return SCALE_CHANNELS.reduce((function(scales,channel){var fieldOrDatumDef=getFieldOrDatumDef(encoding[channel]);if(fieldOrDatumDef){var _fieldOrDatumDef$scal;scales[channel]=_this2.initScale((_fieldOrDatumDef$scal=fieldOrDatumDef.scale)!==null&&_fieldOrDatumDef$scal!==void 0?_fieldOrDatumDef$scal:{})}return scales}),{})}},{key:"initScale",value:function initScale(scale){var domain=scale.domain,range=scale.range;var scaleInternal=replaceExprRefInIndex(scale);if(isArray(domain)){scaleInternal.domain=domain.map(signalRefOrValue)}if(isArray(range)){scaleInternal.range=range.map(signalRefOrValue)}return scaleInternal}},{key:"initAxes",value:function initAxes(encoding){var _this3=this;return POSITION_SCALE_CHANNELS.reduce((function(_axis,channel){var channelDef=encoding[channel];if(isFieldOrDatumDef(channelDef)||channel===X&&isFieldOrDatumDef(encoding.x2)||channel===Y&&isFieldOrDatumDef(encoding.y2)){var axisSpec=isFieldOrDatumDef(channelDef)?channelDef.axis:undefined;_axis[channel]=axisSpec?_this3.initAxis(_objectSpread2({},axisSpec)):axisSpec}return _axis}),{})}},{key:"initAxis",value:function initAxis(axis){var props=keys(axis);var axisInternal={};var _iterator=_createForOfIteratorHelper(props),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var prop=_step.value;var val=axis[prop];axisInternal[prop]=isConditionalAxisValue(val)?signalOrValueRefWithCondition(val):signalRefOrValue(val)}}catch(err){_iterator.e(err)}finally{_iterator.f()}return axisInternal}},{key:"initLegends",value:function initLegends(encoding){return NONPOSITION_SCALE_CHANNELS.reduce((function(_legend,channel){var fieldOrDatumDef=getFieldOrDatumDef(encoding[channel]);if(fieldOrDatumDef&&supportLegend(channel)){var legend=fieldOrDatumDef.legend;_legend[channel]=legend?replaceExprRefInIndex(legend):legend}return _legend}),{})}},{key:"parseData",value:function parseData$1(){this.component.data=parseData(this)}},{key:"parseLayoutSize",value:function parseLayoutSize(){parseUnitLayoutSize(this)}},{key:"parseSelections",value:function parseSelections(){this.component.selection=parseUnitSelection(this,this.selection)}},{key:"parseMarkGroup",value:function parseMarkGroup(){this.component.mark=parseMarkGroups(this)}},{key:"parseAxesAndHeaders",value:function parseAxesAndHeaders(){this.component.axes=parseUnitAxes(this)}},{key:"assembleSelectionTopLevelSignals",value:function assembleSelectionTopLevelSignals(signals){return assembleTopLevelSignals(this,signals)}},{key:"assembleSignals",value:function assembleSignals(){return[].concat(_toConsumableArray(assembleAxisSignals(this)),_toConsumableArray(assembleUnitSelectionSignals(this,[])))}},{key:"assembleSelectionData",value:function assembleSelectionData(data){return assembleUnitSelectionData(this,data)}},{key:"assembleLayout",value:function assembleLayout(){return null}},{key:"assembleLayoutSignals",value:function assembleLayoutSignals$1(){return assembleLayoutSignals(this)}},{key:"assembleMarks",value:function assembleMarks(){var _this$component$mark;var marks=(_this$component$mark=this.component.mark)!==null&&_this$component$mark!==void 0?_this$component$mark:[];if(!this.parent||!isLayerModel(this.parent)){marks=assembleUnitSelectionMarks(this,marks)}return marks.map(this.correctDataNames)}},{key:"getMapping",value:function getMapping(){return this.encoding}},{key:"channelHasField",value:function channelHasField$1(channel){return channelHasField(this.encoding,channel)}},{key:"fieldDef",value:function fieldDef(channel){var channelDef=this.encoding[channel];return getFieldDef(channelDef)}},{key:"typedFieldDef",value:function typedFieldDef(channel){var fieldDef=this.fieldDef(channel);if(isTypedFieldDef(fieldDef)){return fieldDef}return null}},{key:"hasProjection",get:function get(){var encoding=this.encoding;var isGeoShapeMark=this.mark===GEOSHAPE;var hasGeoPosition=encoding&&GEOPOSITION_CHANNELS.some((function(channel){return isFieldOrDatumDef(encoding[channel])}));return isGeoShapeMark||hasGeoPosition}},{key:"mark",get:function get(){return this.markDef.type}}]);return UnitModel}(ModelWithField);var LayerModel=function(_Model){_inherits(LayerModel,_Model);var _super=_createSuper(LayerModel);function LayerModel(spec,parent,parentGivenName,parentGivenSize,config){var _this;_classCallCheck(this,LayerModel);_this=_super.call(this,spec,"layer",parent,parentGivenName,config,spec.resolve,spec.view);_defineProperty(_assertThisInitialized(_this),"children",void 0);var layoutSize=_objectSpread2(_objectSpread2(_objectSpread2({},parentGivenSize),spec.width?{width:spec.width}:{}),spec.height?{height:spec.height}:{});_this.children=spec.layer.map((function(layer,i){if(isLayerSpec(layer)){return new LayerModel(layer,_assertThisInitialized(_this),_this.getName("layer_"+i),layoutSize,config)}else if(isUnitSpec(layer)){return new UnitModel(layer,_assertThisInitialized(_this),_this.getName("layer_"+i),layoutSize,config)}throw new Error(invalidSpec(layer))}));return _this}_createClass(LayerModel,[{key:"parseData",value:function parseData$1(){this.component.data=parseData(this);var _iterator=_createForOfIteratorHelper(this.children),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var child=_step.value;child.parseData()}}catch(err){_iterator.e(err)}finally{_iterator.f()}}},{key:"parseLayoutSize",value:function parseLayoutSize(){parseLayerLayoutSize(this)}},{key:"parseSelections",value:function parseSelections(){this.component.selection={};var _iterator2=_createForOfIteratorHelper(this.children),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var child=_step2.value;child.parseSelections();var _iterator3=_createForOfIteratorHelper(keys(child.component.selection)),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var key=_step3.value;this.component.selection[key]=child.component.selection[key]}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}},{key:"parseMarkGroup",value:function parseMarkGroup(){var _iterator4=_createForOfIteratorHelper(this.children),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var child=_step4.value;child.parseMarkGroup()}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}},{key:"parseAxesAndHeaders",value:function parseAxesAndHeaders(){parseLayerAxes(this)}},{key:"assembleSelectionTopLevelSignals",value:function assembleSelectionTopLevelSignals(signals){return this.children.reduce((function(sg,child){return child.assembleSelectionTopLevelSignals(sg)}),signals)}},{key:"assembleSignals",value:function assembleSignals(){return this.children.reduce((function(signals,child){return signals.concat(child.assembleSignals())}),assembleAxisSignals(this))}},{key:"assembleLayoutSignals",value:function assembleLayoutSignals$1(){return this.children.reduce((function(signals,child){return signals.concat(child.assembleLayoutSignals())}),assembleLayoutSignals(this))}},{key:"assembleSelectionData",value:function assembleSelectionData(data){return this.children.reduce((function(db,child){return child.assembleSelectionData(db)}),data)}},{key:"assembleTitle",value:function assembleTitle(){var title=_get(_getPrototypeOf(LayerModel.prototype),"assembleTitle",this).call(this);if(title){return title}var _iterator5=_createForOfIteratorHelper(this.children),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var child=_step5.value;title=child.assembleTitle();if(title){return title}}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}return undefined}},{key:"assembleLayout",value:function assembleLayout(){return null}},{key:"assembleMarks",value:function assembleMarks(){return assembleLayerSelectionMarks(this,this.children.flatMap((function(child){return child.assembleMarks()})))}},{key:"assembleLegends",value:function assembleLegends$1(){return this.children.reduce((function(legends,child){return legends.concat(child.assembleLegends())}),assembleLegends(this))}}]);return LayerModel}(Model);function buildModel(spec,parent,parentGivenName,unitSize,config){if(isFacetSpec(spec)){return new FacetModel(spec,parent,parentGivenName,config)}else if(isLayerSpec(spec)){return new LayerModel(spec,parent,parentGivenName,unitSize,config)}else if(isUnitSpec(spec)){return new UnitModel(spec,parent,parentGivenName,unitSize,config)}else if(isAnyConcatSpec(spec)){return new ConcatModel(spec,parent,parentGivenName,config)}throw new Error(invalidSpec(spec))}function compile(inputSpec){var opt=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(opt.logger){set(opt.logger)}if(opt.fieldTitle){setTitleFormatter(opt.fieldTitle)}try{var config=initConfig(mergeConfig(opt.config,inputSpec.config));var spec=normalize(inputSpec,config);var model=buildModel(spec,null,"",undefined,config);model.parse();optimizeDataflow(model.component.data,model);var vgSpec=assembleTopLevelModel(model,getTopLevelProperties(inputSpec,spec.autosize,config,model),inputSpec.datasets,inputSpec.usermeta);return{spec:vgSpec,normalized:spec}}finally{if(opt.logger){reset()}if(opt.fieldTitle){resetTitleFormatter()}}}function getTopLevelProperties(inputSpec,autosize,config,model){var width=model.component.layoutSize.get("width");var height=model.component.layoutSize.get("height");if(autosize===undefined){autosize={type:"pad"};if(model.hasAxisOrientSignalRef()){autosize.resize=true}}else if(isString(autosize)){autosize={type:autosize}}if(width&&height&&isFitType(autosize.type)){if(width==="step"&&height==="step"){warn(droppingFit());autosize.type="pad"}else if(width==="step"||height==="step"){var sizeType=width==="step"?"width":"height";warn(droppingFit(getPositionScaleChannel(sizeType)));var inverseSizeType=sizeType==="width"?"height":"width";autosize.type=getFitType(inverseSizeType)}}return _objectSpread2(_objectSpread2(_objectSpread2({},keys(autosize).length===1&&autosize.type?autosize.type==="pad"?{}:{autosize:autosize.type}:{autosize:autosize}),extractTopLevelProperties(config,false)),extractTopLevelProperties(inputSpec,true))}function assembleTopLevelModel(model,topLevelProperties){var datasets=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var usermeta=arguments.length>3?arguments[3]:undefined;var vgConfig=model.config?stripAndRedirectConfig(model.config):undefined;var data=[].concat(model.assembleSelectionData([]),assembleRootData(model.component.data,datasets));var projections=model.assembleProjections();var title=model.assembleTitle();var style=model.assembleGroupStyle();var encodeEntry=model.assembleGroupEncodeEntry(true);var layoutSignals=model.assembleLayoutSignals();layoutSignals=layoutSignals.filter((function(signal){if((signal.name==="width"||signal.name==="height")&&signal.value!==undefined){topLevelProperties[signal.name]=+signal.value;return false}return true}));var params=topLevelProperties.params,otherTopLevelProps=_objectWithoutProperties(topLevelProperties,["params"]);return _objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2(_objectSpread2({$schema:"https://vega.github.io/schema/vega/v5.json"},model.description?{description:model.description}:{}),otherTopLevelProps),title?{title:title}:{}),style?{style:style}:{}),encodeEntry?{encode:{update:encodeEntry}}:{}),{},{data:data},projections.length>0?{projections:projections}:{}),model.assembleGroup([].concat(_toConsumableArray(layoutSignals),_toConsumableArray(model.assembleSelectionTopLevelSignals([])),_toConsumableArray(assembleParameterSignals(params))))),vgConfig?{config:vgConfig}:{}),usermeta?{usermeta:usermeta}:{})}exports.accessPathDepth=accessPathDepth;exports.accessPathWithDatum=accessPathWithDatum;exports.compile=compile;exports.contains=contains;exports.deepEqual=deepEqual;exports.deleteNestedProperty=deleteNestedProperty;exports.duplicate=duplicate;exports.entries=entries;exports.every=every;exports.fieldIntersection=fieldIntersection;exports.flatAccessWithDatum=flatAccessWithDatum;exports.getFirstDefined=getFirstDefined;exports.hasIntersection=hasIntersection;exports.hash=hash;exports.internalField=internalField;exports.isBoolean=isBoolean$1;exports.isEmpty=isEmpty;exports.isEqual=isEqual;exports.isInternalField=isInternalField;exports.isNullOrFalse=isNullOrFalse;exports.isNumeric=isNumeric;exports.keys=keys;exports.logicalExpr=logicalExpr;exports.mergeDeep=mergeDeep;exports.normalize=normalize;exports.normalizeAngle=normalizeAngle;exports.omit=omit;exports.pick=pick;exports.prefixGenerator=prefixGenerator;exports.removePathFromField=removePathFromField;exports.replaceAll=replaceAll;exports.replacePathInField=replacePathInField;exports.resetIdCounter=resetIdCounter;exports.setEqual=setEqual;exports.some=some;exports.stringify=stringify;exports.titleCase=titleCase;exports.unique=unique;exports.uniqueId=uniqueId;exports.vals=vals;exports.varName=varName;exports.version=version;Object.defineProperty(exports,"__esModule",{value:true})}))}).call(this,__webpack_require__(55).Buffer)},55:function(module,exports,__webpack_require__){"use strict";(function(global){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
var base64=__webpack_require__(61);var ieee754=__webpack_require__(62);var isArray=__webpack_require__(63);exports.Buffer=Buffer;exports.SlowBuffer=SlowBuffer;exports.INSPECT_MAX_BYTES=50;Buffer.TYPED_ARRAY_SUPPORT=global.TYPED_ARRAY_SUPPORT!==undefined?global.TYPED_ARRAY_SUPPORT:typedArraySupport();exports.kMaxLength=kMaxLength();function typedArraySupport(){try{var arr=new Uint8Array(1);arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}};return arr.foo()===42&&typeof arr.subarray==="function"&&arr.subarray(1,1).byteLength===0}catch(e){return false}}function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function createBuffer(that,length){if(kMaxLength()<length){throw new RangeError("Invalid typed array length")}if(Buffer.TYPED_ARRAY_SUPPORT){that=new Uint8Array(length);that.__proto__=Buffer.prototype}else{if(that===null){that=new Buffer(length)}that.length=length}return that}function Buffer(arg,encodingOrOffset,length){if(!Buffer.TYPED_ARRAY_SUPPORT&&!(this instanceof Buffer)){return new Buffer(arg,encodingOrOffset,length)}if(typeof arg==="number"){if(typeof encodingOrOffset==="string"){throw new Error("If encoding is specified then the first argument must be a string")}return allocUnsafe(this,arg)}return from(this,arg,encodingOrOffset,length)}Buffer.poolSize=8192;Buffer._augment=function(arr){arr.__proto__=Buffer.prototype;return arr};function from(that,value,encodingOrOffset,length){if(typeof value==="number"){throw new TypeError('"value" argument must not be a number')}if(typeof ArrayBuffer!=="undefined"&&value instanceof ArrayBuffer){return fromArrayBuffer(that,value,encodingOrOffset,length)}if(typeof value==="string"){return fromString(that,value,encodingOrOffset)}return fromObject(that,value)}Buffer.from=function(value,encodingOrOffset,length){return from(null,value,encodingOrOffset,length)};if(Buffer.TYPED_ARRAY_SUPPORT){Buffer.prototype.__proto__=Uint8Array.prototype;Buffer.__proto__=Uint8Array;if(typeof Symbol!=="undefined"&&Symbol.species&&Buffer[Symbol.species]===Buffer){Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:true})}}function assertSize(size){if(typeof size!=="number"){throw new TypeError('"size" argument must be a number')}else if(size<0){throw new RangeError('"size" argument must not be negative')}}function alloc(that,size,fill,encoding){assertSize(size);if(size<=0){return createBuffer(that,size)}if(fill!==undefined){return typeof encoding==="string"?createBuffer(that,size).fill(fill,encoding):createBuffer(that,size).fill(fill)}return createBuffer(that,size)}Buffer.alloc=function(size,fill,encoding){return alloc(null,size,fill,encoding)};function allocUnsafe(that,size){assertSize(size);that=createBuffer(that,size<0?0:checked(size)|0);if(!Buffer.TYPED_ARRAY_SUPPORT){for(var i=0;i<size;++i){that[i]=0}}return that}Buffer.allocUnsafe=function(size){return allocUnsafe(null,size)};Buffer.allocUnsafeSlow=function(size){return allocUnsafe(null,size)};function fromString(that,string,encoding){if(typeof encoding!=="string"||encoding===""){encoding="utf8"}if(!Buffer.isEncoding(encoding)){throw new TypeError('"encoding" must be a valid string encoding')}var length=byteLength(string,encoding)|0;that=createBuffer(that,length);var actual=that.write(string,encoding);if(actual!==length){that=that.slice(0,actual)}return that}function fromArrayLike(that,array){var length=array.length<0?0:checked(array.length)|0;that=createBuffer(that,length);for(var i=0;i<length;i+=1){that[i]=array[i]&255}return that}function fromArrayBuffer(that,array,byteOffset,length){array.byteLength;if(byteOffset<0||array.byteLength<byteOffset){throw new RangeError("'offset' is out of bounds")}if(array.byteLength<byteOffset+(length||0)){throw new RangeError("'length' is out of bounds")}if(byteOffset===undefined&&length===undefined){array=new Uint8Array(array)}else if(length===undefined){array=new Uint8Array(array,byteOffset)}else{array=new Uint8Array(array,byteOffset,length)}if(Buffer.TYPED_ARRAY_SUPPORT){that=array;that.__proto__=Buffer.prototype}else{that=fromArrayLike(that,array)}return that}function fromObject(that,obj){if(Buffer.isBuffer(obj)){var len=checked(obj.length)|0;that=createBuffer(that,len);if(that.length===0){return that}obj.copy(that,0,0,len);return that}if(obj){if(typeof ArrayBuffer!=="undefined"&&obj.buffer instanceof ArrayBuffer||"length"in obj){if(typeof obj.length!=="number"||isnan(obj.length)){return createBuffer(that,0)}return fromArrayLike(that,obj)}if(obj.type==="Buffer"&&isArray(obj.data)){return fromArrayLike(that,obj.data)}}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function checked(length){if(length>=kMaxLength()){throw new RangeError("Attempt to allocate Buffer larger than maximum "+"size: 0x"+kMaxLength().toString(16)+" bytes")}return length|0}function SlowBuffer(length){if(+length!=length){length=0}return Buffer.alloc(+length)}Buffer.isBuffer=function isBuffer(b){return!!(b!=null&&b._isBuffer)};Buffer.compare=function compare(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b)){throw new TypeError("Arguments must be Buffers")}if(a===b)return 0;var x=a.length;var y=b.length;for(var i=0,len=Math.min(x,y);i<len;++i){if(a[i]!==b[i]){x=a[i];y=b[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};Buffer.isEncoding=function isEncoding(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return true;default:return false}};Buffer.concat=function concat(list,length){if(!isArray(list)){throw new TypeError('"list" argument must be an Array of Buffers')}if(list.length===0){return Buffer.alloc(0)}var i;if(length===undefined){length=0;for(i=0;i<list.length;++i){length+=list[i].length}}var buffer=Buffer.allocUnsafe(length);var pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(!Buffer.isBuffer(buf)){throw new TypeError('"list" argument must be an Array of Buffers')}buf.copy(buffer,pos);pos+=buf.length}return buffer};function byteLength(string,encoding){if(Buffer.isBuffer(string)){return string.length}if(typeof ArrayBuffer!=="undefined"&&typeof ArrayBuffer.isView==="function"&&(ArrayBuffer.isView(string)||string instanceof ArrayBuffer)){return string.byteLength}if(typeof string!=="string"){string=""+string}var len=string.length;if(len===0)return 0;var loweredCase=false;for(;;){switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":case undefined:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return len*2;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase();loweredCase=true}}}Buffer.byteLength=byteLength;function slowToString(encoding,start,end){var loweredCase=false;if(start===undefined||start<0){start=0}if(start>this.length){return""}if(end===undefined||end>this.length){end=this.length}if(end<=0){return""}end>>>=0;start>>>=0;if(end<=start){return""}if(!encoding)encoding="utf8";while(true){switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase();loweredCase=true}}}Buffer.prototype._isBuffer=true;function swap(b,n,m){var i=b[n];b[n]=b[m];b[m]=i}Buffer.prototype.swap16=function swap16(){var len=this.length;if(len%2!==0){throw new RangeError("Buffer size must be a multiple of 16-bits")}for(var i=0;i<len;i+=2){swap(this,i,i+1)}return this};Buffer.prototype.swap32=function swap32(){var len=this.length;if(len%4!==0){throw new RangeError("Buffer size must be a multiple of 32-bits")}for(var i=0;i<len;i+=4){swap(this,i,i+3);swap(this,i+1,i+2)}return this};Buffer.prototype.swap64=function swap64(){var len=this.length;if(len%8!==0){throw new RangeError("Buffer size must be a multiple of 64-bits")}for(var i=0;i<len;i+=8){swap(this,i,i+7);swap(this,i+1,i+6);swap(this,i+2,i+5);swap(this,i+3,i+4)}return this};Buffer.prototype.toString=function toString(){var length=this.length|0;if(length===0)return"";if(arguments.length===0)return utf8Slice(this,0,length);return slowToString.apply(this,arguments)};Buffer.prototype.equals=function equals(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");if(this===b)return true;return Buffer.compare(this,b)===0};Buffer.prototype.inspect=function inspect(){var str="";var max=exports.INSPECT_MAX_BYTES;if(this.length>0){str=this.toString("hex",0,max).match(/.{2}/g).join(" ");if(this.length>max)str+=" ... "}return"<Buffer "+str+">"};Buffer.prototype.compare=function compare(target,start,end,thisStart,thisEnd){if(!Buffer.isBuffer(target)){throw new TypeError("Argument must be a Buffer")}if(start===undefined){start=0}if(end===undefined){end=target?target.length:0}if(thisStart===undefined){thisStart=0}if(thisEnd===undefined){thisEnd=this.length}if(start<0||end>target.length||thisStart<0||thisEnd>this.length){throw new RangeError("out of range index")}if(thisStart>=thisEnd&&start>=end){return 0}if(thisStart>=thisEnd){return-1}if(start>=end){return 1}start>>>=0;end>>>=0;thisStart>>>=0;thisEnd>>>=0;if(this===target)return 0;var x=thisEnd-thisStart;var y=end-start;var len=Math.min(x,y);var thisCopy=this.slice(thisStart,thisEnd);var targetCopy=target.slice(start,end);for(var i=0;i<len;++i){if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i];y=targetCopy[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(buffer.length===0)return-1;if(typeof byteOffset==="string"){encoding=byteOffset;byteOffset=0}else if(byteOffset>2147483647){byteOffset=2147483647}else if(byteOffset<-2147483648){byteOffset=-2147483648}byteOffset=+byteOffset;if(isNaN(byteOffset)){byteOffset=dir?0:buffer.length-1}if(byteOffset<0)byteOffset=buffer.length+byteOffset;if(byteOffset>=buffer.length){if(dir)return-1;else byteOffset=buffer.length-1}else if(byteOffset<0){if(dir)byteOffset=0;else return-1}if(typeof val==="string"){val=Buffer.from(val,encoding)}if(Buffer.isBuffer(val)){if(val.length===0){return-1}return arrayIndexOf(buffer,val,byteOffset,encoding,dir)}else if(typeof val==="number"){val=val&255;if(Buffer.TYPED_ARRAY_SUPPORT&&typeof Uint8Array.prototype.indexOf==="function"){if(dir){return Uint8Array.prototype.indexOf.call(buffer,val,byteOffset)}else{return Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset)}}return arrayIndexOf(buffer,[val],byteOffset,encoding,dir)}throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var indexSize=1;var arrLength=arr.length;var valLength=val.length;if(encoding!==undefined){encoding=String(encoding).toLowerCase();if(encoding==="ucs2"||encoding==="ucs-2"||encoding==="utf16le"||encoding==="utf-16le"){if(arr.length<2||val.length<2){return-1}indexSize=2;arrLength/=2;valLength/=2;byteOffset/=2}}function read(buf,i){if(indexSize===1){return buf[i]}else{return buf.readUInt16BE(i*indexSize)}}var i;if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++){if(read(arr,i)===read(val,foundIndex===-1?0:i-foundIndex)){if(foundIndex===-1)foundIndex=i;if(i-foundIndex+1===valLength)return foundIndex*indexSize}else{if(foundIndex!==-1)i-=i-foundIndex;foundIndex=-1}}}else{if(byteOffset+valLength>arrLength)byteOffset=arrLength-valLength;for(i=byteOffset;i>=0;i--){var found=true;for(var j=0;j<valLength;j++){if(read(arr,i+j)!==read(val,j)){found=false;break}}if(found)return i}}return-1}Buffer.prototype.includes=function includes(val,byteOffset,encoding){return this.indexOf(val,byteOffset,encoding)!==-1};Buffer.prototype.indexOf=function indexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,true)};Buffer.prototype.lastIndexOf=function lastIndexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,false)};function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}var strLen=string.length;if(strLen%2!==0)throw new TypeError("Invalid hex string");if(length>strLen/2){length=strLen/2}for(var i=0;i<length;++i){var parsed=parseInt(string.substr(i*2,2),16);if(isNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}Buffer.prototype.write=function write(string,offset,length,encoding){if(offset===undefined){encoding="utf8";length=this.length;offset=0}else if(length===undefined&&typeof offset==="string"){encoding=offset;length=this.length;offset=0}else if(isFinite(offset)){offset=offset|0;if(isFinite(length)){length=length|0;if(encoding===undefined)encoding="utf8"}else{encoding=length;length=undefined}}else{throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported")}var remaining=this.length-offset;if(length===undefined||length>remaining)length=remaining;if(string.length>0&&(length<0||offset<0)||offset>this.length){throw new RangeError("Attempt to write outside buffer bounds")}if(!encoding)encoding="utf8";var loweredCase=false;for(;;){switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase();loweredCase=true}}};Buffer.prototype.toJSON=function toJSON(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function base64Slice(buf,start,end){if(start===0&&end===buf.length){return base64.fromByteArray(buf)}else{return base64.fromByteArray(buf.slice(start,end))}}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);var res=[];var i=start;while(i<end){var firstByte=buf[i];var codePoint=null;var bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:if(firstByte<128){codePoint=firstByte}break;case 2:secondByte=buf[i+1];if((secondByte&192)===128){tempCodePoint=(firstByte&31)<<6|secondByte&63;if(tempCodePoint>127){codePoint=tempCodePoint}}break;case 3:secondByte=buf[i+1];thirdByte=buf[i+2];if((secondByte&192)===128&&(thirdByte&192)===128){tempCodePoint=(firstByte&15)<<12|(secondByte&63)<<6|thirdByte&63;if(tempCodePoint>2047&&(tempCodePoint<55296||tempCodePoint>57343)){codePoint=tempCodePoint}}break;case 4:secondByte=buf[i+1];thirdByte=buf[i+2];fourthByte=buf[i+3];if((secondByte&192)===128&&(thirdByte&192)===128&&(fourthByte&192)===128){tempCodePoint=(firstByte&15)<<18|(secondByte&63)<<12|(thirdByte&63)<<6|fourthByte&63;if(tempCodePoint>65535&&tempCodePoint<1114112){codePoint=tempCodePoint}}}}if(codePoint===null){codePoint=65533;bytesPerSequence=1}else if(codePoint>65535){codePoint-=65536;res.push(codePoint>>>10&1023|55296);codePoint=56320|codePoint&1023}res.push(codePoint);i+=bytesPerSequence}return decodeCodePointsArray(res)}var MAX_ARGUMENTS_LENGTH=4096;function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH){return String.fromCharCode.apply(String,codePoints)}var res="";var i=0;while(i<len){res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH))}return res}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i]&127)}return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i])}return ret}function hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;++i){out+=toHex(buf[i])}return out}function utf16leSlice(buf,start,end){var bytes=buf.slice(start,end);var res="";for(var i=0;i<bytes.length;i+=2){res+=String.fromCharCode(bytes[i]+bytes[i+1]*256)}return res}Buffer.prototype.slice=function slice(start,end){var len=this.length;start=~~start;end=end===undefined?len:~~end;if(start<0){start+=len;if(start<0)start=0}else if(start>len){start=len}if(end<0){end+=len;if(end<0)end=0}else if(end>len){end=len}if(end<start)end=start;var newBuf;if(Buffer.TYPED_ARRAY_SUPPORT){newBuf=this.subarray(start,end);newBuf.__proto__=Buffer.prototype}else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,undefined);for(var i=0;i<sliceLen;++i){newBuf[i]=this[i+start]}}return newBuf};function checkOffset(offset,ext,length){if(offset%1!==0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}Buffer.prototype.readUIntLE=function readUIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}return val};Buffer.prototype.readUIntBE=function readUIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert){checkOffset(offset,byteLength,this.length)}var val=this[offset+--byteLength];var mul=1;while(byteLength>0&&(mul*=256)){val+=this[offset+--byteLength]*mul}return val};Buffer.prototype.readUInt8=function readUInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);return this[offset]};Buffer.prototype.readUInt16LE=function readUInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]|this[offset+1]<<8};Buffer.prototype.readUInt16BE=function readUInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);return this[offset]<<8|this[offset+1]};Buffer.prototype.readUInt32LE=function readUInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+this[offset+3]*16777216};Buffer.prototype.readUInt32BE=function readUInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]*16777216+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])};Buffer.prototype.readIntLE=function readIntLE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readIntBE=function readIntBE(offset,byteLength,noAssert){offset=offset|0;byteLength=byteLength|0;if(!noAssert)checkOffset(offset,byteLength,this.length);var i=byteLength;var mul=1;var val=this[offset+--i];while(i>0&&(mul*=256)){val+=this[offset+--i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readInt8=function readInt8(offset,noAssert){if(!noAssert)checkOffset(offset,1,this.length);if(!(this[offset]&128))return this[offset];return(255-this[offset]+1)*-1};Buffer.prototype.readInt16LE=function readInt16LE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt16BE=function readInt16BE(offset,noAssert){if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt32LE=function readInt32LE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24};Buffer.prototype.readInt32BE=function readInt32BE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]};Buffer.prototype.readFloatLE=function readFloatLE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,true,23,4)};Buffer.prototype.readFloatBE=function readFloatBE(offset,noAssert){if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,false,23,4)};Buffer.prototype.readDoubleLE=function readDoubleLE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,true,52,8)};Buffer.prototype.readDoubleBE=function readDoubleBE(offset,noAssert){if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,false,52,8)};function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}Buffer.prototype.writeUIntLE=function writeUIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var mul=1;var i=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUIntBE=function writeUIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;byteLength=byteLength|0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var i=byteLength-1;var mul=1;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUInt8=function writeUInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,255,0);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);this[offset]=value&255;return offset+1};function objectWriteUInt16(buf,value,offset,littleEndian){if(value<0)value=65535+value+1;for(var i=0,j=Math.min(buf.length-offset,2);i<j;++i){buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>(littleEndian?i:1-i)*8}}Buffer.prototype.writeUInt16LE=function writeUInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,65535,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&255;this[offset+1]=value>>>8}else{objectWriteUInt16(this,value,offset,true)}return offset+2};Buffer.prototype.writeUInt16BE=function writeUInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,65535,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&255}else{objectWriteUInt16(this,value,offset,false)}return offset+2};function objectWriteUInt32(buf,value,offset,littleEndian){if(value<0)value=4294967295+value+1;for(var i=0,j=Math.min(buf.length-offset,4);i<j;++i){buf[offset+i]=value>>>(littleEndian?i:3-i)*8&255}}Buffer.prototype.writeUInt32LE=function writeUInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset+3]=value>>>24;this[offset+2]=value>>>16;this[offset+1]=value>>>8;this[offset]=value&255}else{objectWriteUInt32(this,value,offset,true)}return offset+4};Buffer.prototype.writeUInt32BE=function writeUInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255}else{objectWriteUInt32(this,value,offset,false)}return offset+4};Buffer.prototype.writeIntLE=function writeIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0;var mul=1;var sub=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){if(value<0&&sub===0&&this[offset+i-1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeIntBE=function writeIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset|0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1;var mul=1;var sub=0;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){if(value<0&&sub===0&&this[offset+i+1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeInt8=function writeInt8(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,1,127,-128);if(!Buffer.TYPED_ARRAY_SUPPORT)value=Math.floor(value);if(value<0)value=255+value+1;this[offset]=value&255;return offset+1};Buffer.prototype.writeInt16LE=function writeInt16LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&255;this[offset+1]=value>>>8}else{objectWriteUInt16(this,value,offset,true)}return offset+2};Buffer.prototype.writeInt16BE=function writeInt16BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>8;this[offset+1]=value&255}else{objectWriteUInt16(this,value,offset,false)}return offset+2};Buffer.prototype.writeInt32LE=function writeInt32LE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value&255;this[offset+1]=value>>>8;this[offset+2]=value>>>16;this[offset+3]=value>>>24}else{objectWriteUInt32(this,value,offset,true)}return offset+4};Buffer.prototype.writeInt32BE=function writeInt32BE(value,offset,noAssert){value=+value;offset=offset|0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);if(value<0)value=4294967295+value+1;if(Buffer.TYPED_ARRAY_SUPPORT){this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255}else{objectWriteUInt32(this,value,offset,false)}return offset+4};function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,4,34028234663852886e22,-34028234663852886e22)}ieee754.write(buf,value,offset,littleEndian,23,4);return offset+4}Buffer.prototype.writeFloatLE=function writeFloatLE(value,offset,noAssert){return writeFloat(this,value,offset,true,noAssert)};Buffer.prototype.writeFloatBE=function writeFloatBE(value,offset,noAssert){return writeFloat(this,value,offset,false,noAssert)};function writeDouble(buf,value,offset,littleEndian,noAssert){if(!noAssert){checkIEEE754(buf,value,offset,8,17976931348623157e292,-17976931348623157e292)}ieee754.write(buf,value,offset,littleEndian,52,8);return offset+8}Buffer.prototype.writeDoubleLE=function writeDoubleLE(value,offset,noAssert){return writeDouble(this,value,offset,true,noAssert)};Buffer.prototype.writeDoubleBE=function writeDoubleBE(value,offset,noAssert){return writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.copy=function copy(target,targetStart,start,end){if(!start)start=0;if(!end&&end!==0)end=this.length;if(targetStart>=target.length)targetStart=target.length;if(!targetStart)targetStart=0;if(end>0&&end<start)end=start;if(end===start)return 0;if(target.length===0||this.length===0)return 0;if(targetStart<0){throw new RangeError("targetStart out of bounds")}if(start<0||start>=this.length)throw new RangeError("sourceStart out of bounds");if(end<0)throw new RangeError("sourceEnd out of bounds");if(end>this.length)end=this.length;if(target.length-targetStart<end-start){end=target.length-targetStart+start}var len=end-start;var i;if(this===target&&start<targetStart&&targetStart<end){for(i=len-1;i>=0;--i){target[i+targetStart]=this[i+start]}}else if(len<1e3||!Buffer.TYPED_ARRAY_SUPPORT){for(i=0;i<len;++i){target[i+targetStart]=this[i+start]}}else{Uint8Array.prototype.set.call(target,this.subarray(start,start+len),targetStart)}return len};Buffer.prototype.fill=function fill(val,start,end,encoding){if(typeof val==="string"){if(typeof start==="string"){encoding=start;start=0;end=this.length}else if(typeof end==="string"){encoding=end;end=this.length}if(val.length===1){var code=val.charCodeAt(0);if(code<256){val=code}}if(encoding!==undefined&&typeof encoding!=="string"){throw new TypeError("encoding must be a string")}if(typeof encoding==="string"&&!Buffer.isEncoding(encoding)){throw new TypeError("Unknown encoding: "+encoding)}}else if(typeof val==="number"){val=val&255}if(start<0||this.length<start||this.length<end){throw new RangeError("Out of range index")}if(end<=start){return this}start=start>>>0;end=end===undefined?this.length:end>>>0;if(!val)val=0;var i;if(typeof val==="number"){for(i=start;i<end;++i){this[i]=val}}else{var bytes=Buffer.isBuffer(val)?val:utf8ToBytes(new Buffer(val,encoding).toString());var len=bytes.length;for(i=0;i<end-start;++i){this[i+start]=bytes[i%len]}}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function base64clean(str){str=stringtrim(str).replace(INVALID_BASE64_RE,"");if(str.length<2)return"";while(str.length%4!==0){str=str+"="}return str}function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(string,units){units=units||Infinity;var codePoint;var length=string.length;var leadSurrogate=null;var bytes=[];for(var i=0;i<length;++i){codePoint=string.charCodeAt(i);if(codePoint>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){if((units-=3)>-1)bytes.push(239,191,189);continue}else if(i+1===length){if((units-=3)>-1)bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){if((units-=3)>-1)bytes.push(239,191,189);leadSurrogate=codePoint;continue}codePoint=(leadSurrogate-55296<<10|codePoint-56320)+65536}else if(leadSurrogate){if((units-=3)>-1)bytes.push(239,191,189)}leadSurrogate=null;if(codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,codePoint&63|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,codePoint&63|128)}else if(codePoint<1114112){if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,codePoint&63|128)}else{throw new Error("Invalid code point")}}return bytes}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;++i){byteArray.push(str.charCodeAt(i)&255)}return byteArray}function utf16leToBytes(str,units){var c,hi,lo;var byteArray=[];for(var i=0;i<str.length;++i){if((units-=2)<0)break;c=str.charCodeAt(i);hi=c>>8;lo=c%256;byteArray.push(lo);byteArray.push(hi)}return byteArray}function base64ToBytes(str){return base64.toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length;++i){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i]}return i}function isnan(val){return val!==val}}).call(this,__webpack_require__(60))},56:function(module,exports,__webpack_require__){(function(Buffer){(function(global,factory){true?factory(exports):undefined})(this,(function(exports){"use strict";function accessor(fn,fields,name){fn.fields=fields||[];fn.fname=name;return fn}function accessorName(fn){return fn==null?null:fn.fname}function accessorFields(fn){return fn==null?null:fn.fields}function getter(path){return path.length===1?get1(path[0]):getN(path)}var get1=function get1(field){return function(obj){return obj[field]}};var getN=function getN(path){var len=path.length;return function(obj){for(var i=0;i<len;++i){obj=obj[path[i]]}return obj}};function error(message){throw Error(message)}function splitAccessPath(p){var path=[],n=p.length;var q=null,b=0,s="",i,j,c;p=p+"";function push(){path.push(s+p.substring(i,j));s="";i=j+1}for(i=j=0;j<n;++j){c=p[j];if(c==="\\"){s+=p.substring(i,j);s+=p.substring(++j,++j);i=j}else if(c===q){push();q=null;b=-1}else if(q){continue}else if(i===b&&c==='"'){i=j+1;q=c}else if(i===b&&c==="'"){i=j+1;q=c}else if(c==="."&&!b){if(j>i){push()}else{i=j+1}}else if(c==="["){if(j>i)push();b=i=j+1}else if(c==="]"){if(!b)error("Access path missing open bracket: "+p);if(b>0)push();b=0;i=j+1}}if(b)error("Access path missing closing bracket: "+p);if(q)error("Access path missing closing quote: "+p);if(j>i){j++;push()}return path}function field(field,name,opt){var path=splitAccessPath(field);field=path.length===1?path[0]:field;return accessor((opt&&opt.get||getter)(path),[field],name||field)}var id=field("id");var identity=accessor((function(_){return _}),[],"identity");var zero=accessor((function(){return 0}),[],"zero");var one=accessor((function(){return 1}),[],"one");var truthy=accessor((function(){return true}),[],"true");var falsy=accessor((function(){return false}),[],"false");function log(method,level,input){var args=[level].concat([].slice.call(input));console[method].apply(console,args)}var None=0;var Error$1=1;var Warn=2;var Info=3;var Debug=4;function logger(_,method){var _level=_||None;return{level:function level(_){if(arguments.length){_level=+_;return this}else{return _level}},error:function error(){if(_level>=Error$1)log(method||"error","ERROR",arguments);return this},warn:function warn(){if(_level>=Warn)log(method||"warn","WARN",arguments);return this},info:function info(){if(_level>=Info)log(method||"log","INFO",arguments);return this},debug:function debug(){if(_level>=Debug)log(method||"log","DEBUG",arguments);return this}}}var isArray=Array.isArray;function isObject(_){return _===Object(_)}var isLegalKey=function isLegalKey(key){return key!=="__proto__"};function mergeConfig(){for(var _len=arguments.length,configs=new Array(_len),_key=0;_key<_len;_key++){configs[_key]=arguments[_key]}return configs.reduce((function(out,source){for(var _key2 in source){if(_key2==="signals"){out.signals=mergeNamed(out.signals,source.signals)}else{var r=_key2==="legend"?{layout:1}:_key2==="style"?true:null;writeConfig(out,_key2,source[_key2],r)}}return out}),{})}function writeConfig(output,key,value,recurse){if(!isLegalKey(key))return;var k,o;if(isObject(value)&&!isArray(value)){o=isObject(output[key])?output[key]:output[key]={};for(k in value){if(recurse&&(recurse===true||recurse[k])){writeConfig(o,k,value[k])}else if(isLegalKey(k)){o[k]=value[k]}}}else{output[key]=value}}function mergeNamed(a,b){if(a==null)return b;var map={},out=[];function add(_){if(!map[_.name]){map[_.name]=1;out.push(_)}}b.forEach(add);a.forEach(add);return out}function peek(array){return array[array.length-1]}function toNumber(_){return _==null||_===""?null:+_}var exp=function exp(sign){return function(x){return sign*Math.exp(x)}};var log$1=function log$1(sign){return function(x){return Math.log(sign*x)}};var symlog=function symlog(c){return function(x){return Math.sign(x)*Math.log1p(Math.abs(x/c))}};var symexp=function symexp(c){return function(x){return Math.sign(x)*Math.expm1(Math.abs(x))*c}};var pow=function pow(exponent){return function(x){return x<0?-Math.pow(-x,exponent):Math.pow(x,exponent)}};function pan(domain,delta,lift,ground){var d0=lift(domain[0]),d1=lift(peek(domain)),dd=(d1-d0)*delta;return[ground(d0-dd),ground(d1-dd)]}function panLinear(domain,delta){return pan(domain,delta,toNumber,identity)}function panLog(domain,delta){var sign=Math.sign(domain[0]);return pan(domain,delta,log$1(sign),exp(sign))}function panPow(domain,delta,exponent){return pan(domain,delta,pow(exponent),pow(1/exponent))}function panSymlog(domain,delta,constant){return pan(domain,delta,symlog(constant),symexp(constant))}function zoom(domain,anchor,scale,lift,ground){var d0=lift(domain[0]),d1=lift(peek(domain)),da=anchor!=null?lift(anchor):(d0+d1)/2;return[ground(da+(d0-da)*scale),ground(da+(d1-da)*scale)]}function zoomLinear(domain,anchor,scale){return zoom(domain,anchor,scale,toNumber,identity)}function zoomLog(domain,anchor,scale){var sign=Math.sign(domain[0]);return zoom(domain,anchor,scale,log$1(sign),exp(sign))}function zoomPow(domain,anchor,scale,exponent){return zoom(domain,anchor,scale,pow(exponent),pow(1/exponent))}function zoomSymlog(domain,anchor,scale,constant){return zoom(domain,anchor,scale,symlog(constant),symexp(constant))}function quarter(date){return 1+~~(new Date(date).getMonth()/3)}function utcquarter(date){return 1+~~(new Date(date).getUTCMonth()/3)}function array(_){return _!=null?isArray(_)?_:[_]:[]}function clampRange(range,min,max){var lo=range[0],hi=range[1],span;if(hi<lo){span=hi;hi=lo;lo=span}span=hi-lo;return span>=max-min?[min,max]:[lo=Math.min(Math.max(lo,min),max-span),lo+span]}function isFunction(_){return typeof _==="function"}var DESCENDING="descending";function compare(fields,orders,opt){opt=opt||{};orders=array(orders)||[];var ord=[],get=[],fmap={},gen=opt.comparator||comparator;array(fields).forEach((function(f,i){if(f==null)return;ord.push(orders[i]===DESCENDING?-1:1);get.push(f=isFunction(f)?f:field(f,null,opt));(accessorFields(f)||[]).forEach((function(_){return fmap[_]=1}))}));return get.length===0?null:accessor(gen(get,ord),Object.keys(fmap))}var ascending=function ascending(u,v){return(u<v||u==null)&&v!=null?-1:(u>v||v==null)&&u!=null?1:(v=v instanceof Date?+v:v,u=u instanceof Date?+u:u)!==u&&v===v?-1:v!==v&&u===u?1:0};var comparator=function comparator(fields,orders){return fields.length===1?compare1(fields[0],orders[0]):compareN(fields,orders,fields.length)};var compare1=function compare1(field,order){return function(a,b){return ascending(field(a),field(b))*order}};var compareN=function compareN(fields,orders,n){orders.push(0);return function(a,b){var f,c=0,i=-1;while(c===0&&++i<n){f=fields[i];c=ascending(f(a),f(b))}return c*orders[i]}};function constant(_){return isFunction(_)?_:function(){return _}}function debounce(delay,handler){var tid;return function(e){if(tid)clearTimeout(tid);tid=setTimeout((function(){return handler(e),tid=null}),delay)}}function extend(_){for(var x,k,i=1,len=arguments.length;i<len;++i){x=arguments[i];for(k in x){_[k]=x[k]}}return _}function extent(array,f){var i=0,n,v,min,max;if(array&&(n=array.length)){if(f==null){for(v=array[i];i<n&&(v==null||v!==v);v=array[++i]){}min=max=v;for(;i<n;++i){v=array[i];if(v!=null){if(v<min)min=v;if(v>max)max=v}}}else{for(v=f(array[i]);i<n&&(v==null||v!==v);v=f(array[++i])){}min=max=v;for(;i<n;++i){v=f(array[i]);if(v!=null){if(v<min)min=v;if(v>max)max=v}}}}return[min,max]}function extentIndex(array,f){var n=array.length;var i=-1,a,b,c,u,v;if(f==null){while(++i<n){b=array[i];if(b!=null&&b>=b){a=c=b;break}}if(i===n)return[-1,-1];u=v=i;while(++i<n){b=array[i];if(b!=null){if(a>b){a=b;u=i}if(c<b){c=b;v=i}}}}else{while(++i<n){b=f(array[i],i,array);if(b!=null&&b>=b){a=c=b;break}}if(i===n)return[-1,-1];u=v=i;while(++i<n){b=f(array[i],i,array);if(b!=null){if(a>b){a=b;u=i}if(c<b){c=b;v=i}}}}return[u,v]}var hop=Object.prototype.hasOwnProperty;function _has(object,property){return hop.call(object,property)}var NULL={};function fastmap(input){var obj={},_test;function has$1(key){return _has(obj,key)&&obj[key]!==NULL}var map={size:0,empty:0,object:obj,has:has$1,get:function get(key){return has$1(key)?obj[key]:undefined},set:function set(key,value){if(!has$1(key)){++map.size;if(obj[key]===NULL)--map.empty}obj[key]=value;return this},delete:function _delete(key){if(has$1(key)){--map.size;++map.empty;obj[key]=NULL}return this},clear:function clear(){map.size=map.empty=0;map.object=obj={}},test:function test(_){if(arguments.length){_test=_;return map}else{return _test}},clean:function clean(){var next={};var size=0;for(var _key3 in obj){var value=obj[_key3];if(value!==NULL&&(!_test||!_test(value))){next[_key3]=value;++size}}map.size=size;map.empty=0;map.object=obj=next}};if(input)Object.keys(input).forEach((function(key){map.set(key,input[key])}));return map}function flush(range,value,threshold,left,right,center){if(!threshold&&threshold!==0)return center;var t=+threshold;var a=range[0],b=peek(range),l;if(b<a){l=a;a=b;b=l}l=Math.abs(value-a);var r=Math.abs(b-value);return l<r&&l<=t?left:r<=t?right:center}function inherits(child,parent,members){var proto=child.prototype=Object.create(parent.prototype);proto.constructor=child;return extend(proto,members)}function inrange(value,range,left,right){var r0=range[0],r1=range[range.length-1],t;if(r0>r1){t=r0;r0=r1;r1=t}left=left===undefined||left;right=right===undefined||right;return(left?r0<=value:r0<value)&&(right?value<=r1:value<r1)}function isBoolean(_){return typeof _==="boolean"}function isDate(_){return Object.prototype.toString.call(_)==="[object Date]"}function isIterable(_){return _&&isFunction(_[Symbol.iterator])}function isNumber(_){return typeof _==="number"}function isRegExp(_){return Object.prototype.toString.call(_)==="[object RegExp]"}function isString(_){return typeof _==="string"}function key(fields,flat,opt){if(fields){fields=flat?array(fields).map((function(f){return f.replace(/\\(.)/g,"$1")})):array(fields)}var len=fields&&fields.length,gen=opt&&opt.get||getter,map=function map(f){return gen(flat?[f]:splitAccessPath(f))};var fn;if(!len){fn=function fn(){return""}}else if(len===1){var get=map(fields[0]);fn=function fn(_){return""+get(_)}}else{var _get=fields.map(map);fn=function fn(_){var s=""+_get[0](_),i=0;while(++i<len){s+="|"+_get[i](_)}return s}}return accessor(fn,fields,"key")}function lerp(array,frac){var lo=array[0],hi=peek(array),f=+frac;return!f?lo:f===1?hi:lo+f*(hi-lo)}var DEFAULT_MAX_SIZE=1e4;function lruCache(maxsize){maxsize=+maxsize||DEFAULT_MAX_SIZE;var curr,prev,size;var clear=function clear(){curr={};prev={};size=0};var update=function update(key,value){if(++size>maxsize){prev=curr;curr={};size=1}return curr[key]=value};clear();return{clear:clear,has:function has(key){return _has(curr,key)||_has(prev,key)},get:function get(key){return _has(curr,key)?curr[key]:_has(prev,key)?update(key,prev[key]):undefined},set:function set(key,value){return _has(curr,key)?curr[key]=value:update(key,value)}}}function merge(compare,array0,array1,output){var n0=array0.length,n1=array1.length;if(!n1)return array0;if(!n0)return array1;var merged=output||new array0.constructor(n0+n1);var i0=0,i1=0,i=0;for(;i0<n0&&i1<n1;++i){merged[i]=compare(array0[i0],array1[i1])>0?array1[i1++]:array0[i0++]}for(;i0<n0;++i0,++i){merged[i]=array0[i0]}for(;i1<n1;++i1,++i){merged[i]=array1[i1]}return merged}function repeat(str,reps){var s="";while(--reps>=0){s+=str}return s}function pad(str,length,padchar,align){var c=padchar||" ",s=str+"",n=length-s.length;return n<=0?s:align==="left"?repeat(c,n)+s:align==="center"?repeat(c,~~(n/2))+s+repeat(c,Math.ceil(n/2)):s+repeat(c,n)}function span(array){return array&&peek(array)-array[0]||0}function $(x){return isArray(x)?"["+x.map($)+"]":isObject(x)||isString(x)?JSON.stringify(x).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):x}function toBoolean(_){return _==null||_===""?null:!_||_==="false"||_==="0"?false:!!_}var defaultParser=function defaultParser(_){return isNumber(_)?_:isDate(_)?_:Date.parse(_)};function toDate(_,parser){parser=parser||defaultParser;return _==null||_===""?null:parser(_)}function toString(_){return _==null||_===""?null:_+""}function toSet(_){var s={},n=_.length;for(var i=0;i<n;++i){s[_[i]]=true}return s}function truncate(str,length,align,ellipsis){var e=ellipsis!=null?ellipsis:"",s=str+"",n=s.length,l=Math.max(0,length-e.length);return n<=length?s:align==="left"?e+s.slice(n-l):align==="center"?s.slice(0,Math.ceil(l/2))+e+s.slice(n-~~(l/2)):s.slice(0,l)+e}function visitArray(array,filter,visitor){if(array){if(filter){var n=array.length;for(var i=0;i<n;++i){var t=filter(array[i]);if(t)visitor(t,i,array)}}else{array.forEach(visitor)}}}function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function(obj){return typeof obj}}else{_typeof=function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)}))}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&Symbol.iterator in Object(iter))return Array.from(iter)}function _iterableToArrayLimit(arr,i){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(arr)))return;var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]!=null)_i["return"]()}finally{if(_d)throw _e}}return _arr}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _createForOfIteratorHelper(o,allowArrayLike){var it;if(typeof Symbol==="undefined"||o[Symbol.iterator]==null){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function(){};return{s:F,n:function(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var normalCompletion=true,didErr=false,err;return{s:function(){it=o[Symbol.iterator]()},n:function(){var step=it.next();normalCompletion=step.done;return step},e:function(e){didErr=true;err=e},f:function(){try{if(!normalCompletion&&it.return!=null)it.return()}finally{if(didErr)throw err}}}}var protocol_re=/^([A-Za-z]+:)?\/\//;var allowed_re=/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|file|data):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i;var whitespace_re=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205f\u3000]/g;var fileProtocol="file://";function loaderFactory(fetch,fs){return function(options){return{options:options||{},sanitize:sanitize,load:load,fileAccess:!!fs,file:fileLoader(fs),http:httpLoader(fetch)}}}function load(_x,_x2){return _load.apply(this,arguments)}function _load(){_load=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(uri,options){var opt,url;return regeneratorRuntime.wrap((function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return this.sanitize(uri,options);case 2:opt=_context2.sent;url=opt.href;return _context2.abrupt("return",opt.localFile?this.file(url):this.http(url,options));case 5:case"end":return _context2.stop()}}}),_callee2,this)})));return _load.apply(this,arguments)}function sanitize(_x3,_x4){return _sanitize.apply(this,arguments)}function _sanitize(){_sanitize=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(uri,options){var fileAccess,result,isFile,loadFile,base,isAllowed,hasProtocol;return regeneratorRuntime.wrap((function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:options=extend({},this.options,options);fileAccess=this.fileAccess,result={href:null};isAllowed=allowed_re.test(uri.replace(whitespace_re,""));if(uri==null||typeof uri!=="string"||!isAllowed){error("Sanitize failure, invalid URI: "+$(uri))}hasProtocol=protocol_re.test(uri);if((base=options.baseURL)&&!hasProtocol){if(!uri.startsWith("/")&&base[base.length-1]!=="/"){uri="/"+uri}uri=base+uri}loadFile=(isFile=uri.startsWith(fileProtocol))||options.mode==="file"||options.mode!=="http"&&!hasProtocol&&fileAccess;if(isFile){uri=uri.slice(fileProtocol.length)}else if(uri.startsWith("//")){if(options.defaultProtocol==="file"){uri=uri.slice(2);loadFile=true}else{uri=(options.defaultProtocol||"http")+":"+uri}}Object.defineProperty(result,"localFile",{value:!!loadFile});result.href=uri;if(options.target){result.target=options.target+""}if(options.rel){result.rel=options.rel+""}if(options.context==="image"&&options.crossOrigin){result.crossOrigin=options.crossOrigin+""}return _context3.abrupt("return",result);case 14:case"end":return _context3.stop()}}}),_callee3,this)})));return _sanitize.apply(this,arguments)}function fileLoader(fs){return fs?function(filename){return new Promise((function(accept,reject){fs.readFile(filename,(function(error,data){if(error)reject(error);else accept(data)}))}))}:fileReject}function fileReject(){return _fileReject.apply(this,arguments)}function _fileReject(){_fileReject=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(){return regeneratorRuntime.wrap((function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:error("No file system access.");case 1:case"end":return _context4.stop()}}}),_callee4)})));return _fileReject.apply(this,arguments)}function httpLoader(fetch){return fetch?function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee(url,options){var opt,type,response;return regeneratorRuntime.wrap((function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:opt=extend({},this.options.http,options);type=options&&options.response;_context.next=4;return fetch(url,opt);case 4:response=_context.sent;return _context.abrupt("return",!response.ok?error(response.status+""+response.statusText):isFunction(response[type])?response[type]():response.text());case 6:case"end":return _context.stop()}}}),_callee,this)})));return function(_x5,_x6){return _ref.apply(this,arguments)}}():httpReject}function httpReject(){return _httpReject.apply(this,arguments)}function _httpReject(){_httpReject=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(){return regeneratorRuntime.wrap((function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:error("No HTTP fetch method available.");case 1:case"end":return _context5.stop()}}}),_callee5)})));return _httpReject.apply(this,arguments)}var isValid=function isValid(_){return _!=null&&_===_};var isBoolean$1=function isBoolean(_){return _==="true"||_==="false"||_===true||_===false};var isDate$1=function isDate(_){return!Number.isNaN(Date.parse(_))};var isNumber$1=function isNumber(_){return!Number.isNaN(+_)&&!(_ instanceof Date)};var isInteger=function isInteger(_){return isNumber$1(_)&&Number.isInteger(+_)};var typeParsers={boolean:toBoolean,integer:toNumber,number:toNumber,date:toDate,string:toString,unknown:identity};var typeTests=[isBoolean$1,isInteger,isNumber$1,isDate$1];var typeList=["boolean","integer","number","date"];function inferType(values,field){if(!values||!values.length)return"unknown";var n=values.length,m=typeTests.length,a=typeTests.map((function(_,i){return i+1}));for(var i=0,t=0,j,value;i<n;++i){value=field?values[i][field]:values[i];for(j=0;j<m;++j){if(a[j]&&isValid(value)&&!typeTests[j](value)){a[j]=0;++t;if(t===typeTests.length)return"string"}}}return typeList[a.reduce((function(u,v){return u===0?v:u}),0)-1]}function inferTypes(data,fields){return fields.reduce((function(types,field){types[field]=inferType(data,field);return types}),{})}var EOL={},EOF={},QUOTE=34,NEWLINE=10,RETURN=13;function objectConverter(columns){return new Function("d","return {"+columns.map((function(name,i){return JSON.stringify(name)+": d["+i+'] || ""'})).join(",")+"}")}function customConverter(columns,f){var object=objectConverter(columns);return function(row,i){return f(object(row),i,columns)}}function inferColumns(rows){var columnSet=Object.create(null),columns=[];rows.forEach((function(row){for(var column in row){if(!(column in columnSet)){columns.push(columnSet[column]=column)}}}));return columns}function pad$1(value,width){var s=value+"",length=s.length;return length<width?new Array(width-length+1).join(0)+s:s}function formatYear(year){return year<0?"-"+pad$1(-year,6):year>9999?"+"+pad$1(year,6):pad$1(year,4)}function formatDate(date){var hours=date.getUTCHours(),minutes=date.getUTCMinutes(),seconds=date.getUTCSeconds(),milliseconds=date.getUTCMilliseconds();return isNaN(date)?"Invalid Date":formatYear(date.getUTCFullYear())+"-"+pad$1(date.getUTCMonth()+1,2)+"-"+pad$1(date.getUTCDate(),2)+(milliseconds?"T"+pad$1(hours,2)+":"+pad$1(minutes,2)+":"+pad$1(seconds,2)+"."+pad$1(milliseconds,3)+"Z":seconds?"T"+pad$1(hours,2)+":"+pad$1(minutes,2)+":"+pad$1(seconds,2)+"Z":minutes||hours?"T"+pad$1(hours,2)+":"+pad$1(minutes,2)+"Z":"")}function dsvFormat(delimiter){var reFormat=new RegExp('["'+delimiter+"\n\r]"),DELIMITER=delimiter.charCodeAt(0);function parse(text,f){var convert,columns,rows=parseRows(text,(function(row,i){if(convert)return convert(row,i-1);columns=row,convert=f?customConverter(row,f):objectConverter(row)}));rows.columns=columns||[];return rows}function parseRows(text,f){var rows=[],N=text.length,I=0,n=0,t,eof=N<=0,eol=false;if(text.charCodeAt(N-1)===NEWLINE)--N;if(text.charCodeAt(N-1)===RETURN)--N;function token(){if(eof)return EOF;if(eol)return eol=false,EOL;var i,j=I,c;if(text.charCodeAt(j)===QUOTE){while(I++<N&&text.charCodeAt(I)!==QUOTE||text.charCodeAt(++I)===QUOTE){}if((i=I)>=N)eof=true;else if((c=text.charCodeAt(I++))===NEWLINE)eol=true;else if(c===RETURN){eol=true;if(text.charCodeAt(I)===NEWLINE)++I}return text.slice(j+1,i-1).replace(/""/g,'"')}while(I<N){if((c=text.charCodeAt(i=I++))===NEWLINE)eol=true;else if(c===RETURN){eol=true;if(text.charCodeAt(I)===NEWLINE)++I}else if(c!==DELIMITER)continue;return text.slice(j,i)}return eof=true,text.slice(j,N)}while((t=token())!==EOF){var row=[];while(t!==EOL&&t!==EOF){row.push(t),t=token()}if(f&&(row=f(row,n++))==null)continue;rows.push(row)}return rows}function preformatBody(rows,columns){return rows.map((function(row){return columns.map((function(column){return formatValue(row[column])})).join(delimiter)}))}function format(rows,columns){if(columns==null)columns=inferColumns(rows);return[columns.map(formatValue).join(delimiter)].concat(preformatBody(rows,columns)).join("\n")}function formatBody(rows,columns){if(columns==null)columns=inferColumns(rows);return preformatBody(rows,columns).join("\n")}function formatRows(rows){return rows.map(formatRow).join("\n")}function formatRow(row){return row.map(formatValue).join(delimiter)}function formatValue(value){return value==null?"":value instanceof Date?formatDate(value):reFormat.test(value+="")?'"'+value.replace(/"/g,'""')+'"':value}return{parse:parse,parseRows:parseRows,format:format,formatBody:formatBody,formatRows:formatRows,formatRow:formatRow,formatValue:formatValue}}function delimitedFormat(delimiter){var parse=function parse(data,format){var delim={delimiter:delimiter};return dsv(data,format?extend(format,delim):delim)};parse.responseType="text";return parse}function dsv(data,format){if(format.header){data=format.header.map($).join(format.delimiter)+"\n"+data}return dsvFormat(format.delimiter).parse(data+"")}dsv.responseType="text";function isBuffer(_){return typeof Buffer==="function"&&isFunction(Buffer.isBuffer)?Buffer.isBuffer(_):false}function json(data,format){var prop=format&&format.property?field(format.property):identity;return isObject(data)&&!isBuffer(data)?parseJSON(prop(data),format):prop(JSON.parse(data))}json.responseType="json";function parseJSON(data,format){if(!isArray(data)&&isIterable(data)){data=_toConsumableArray(data)}return format&&format.copy?JSON.parse(JSON.stringify(data)):data}function identity$1(x){return x}function transform(transform){if(transform==null)return identity$1;var x0,y0,kx=transform.scale[0],ky=transform.scale[1],dx=transform.translate[0],dy=transform.translate[1];return function(input,i){if(!i)x0=y0=0;var j=2,n=input.length,output=new Array(n);output[0]=(x0+=input[0])*kx+dx;output[1]=(y0+=input[1])*ky+dy;while(j<n){output[j]=input[j],++j}return output}}function reverse(array,n){var t,j=array.length,i=j-n;while(i<--j){t=array[i],array[i++]=array[j],array[j]=t}}function feature(topology,o){if(typeof o==="string")o=topology.objects[o];return o.type==="GeometryCollection"?{type:"FeatureCollection",features:o.geometries.map((function(o){return feature$1(topology,o)}))}:feature$1(topology,o)}function feature$1(topology,o){var id=o.id,bbox=o.bbox,properties=o.properties==null?{}:o.properties,geometry=object(topology,o);return id==null&&bbox==null?{type:"Feature",properties:properties,geometry:geometry}:bbox==null?{type:"Feature",id:id,properties:properties,geometry:geometry}:{type:"Feature",id:id,bbox:bbox,properties:properties,geometry:geometry}}function object(topology,o){var transformPoint=transform(topology.transform),arcs=topology.arcs;function arc(i,points){if(points.length)points.pop();for(var a=arcs[i<0?~i:i],k=0,n=a.length;k<n;++k){points.push(transformPoint(a[k],k))}if(i<0)reverse(points,n)}function point(p){return transformPoint(p)}function line(arcs){var points=[];for(var i=0,n=arcs.length;i<n;++i){arc(arcs[i],points)}if(points.length<2)points.push(points[0]);return points}function ring(arcs){var points=line(arcs);while(points.length<4){points.push(points[0])}return points}function polygon(arcs){return arcs.map(ring)}function geometry(o){var type=o.type,coordinates;switch(type){case"GeometryCollection":return{type:type,geometries:o.geometries.map(geometry)};case"Point":coordinates=point(o.coordinates);break;case"MultiPoint":coordinates=o.coordinates.map(point);break;case"LineString":coordinates=line(o.arcs);break;case"MultiLineString":coordinates=o.arcs.map(line);break;case"Polygon":coordinates=polygon(o.arcs);break;case"MultiPolygon":coordinates=o.arcs.map(polygon);break;default:return null}return{type:type,coordinates:coordinates}}return geometry(o)}function stitch(topology,arcs){var stitchedArcs={},fragmentByStart={},fragmentByEnd={},fragments=[],emptyIndex=-1;arcs.forEach((function(i,j){var arc=topology.arcs[i<0?~i:i],t;if(arc.length<3&&!arc[1][0]&&!arc[1][1]){t=arcs[++emptyIndex],arcs[emptyIndex]=i,arcs[j]=t}}));arcs.forEach((function(i){var e=ends(i),start=e[0],end=e[1],f,g;if(f=fragmentByEnd[start]){delete fragmentByEnd[f.end];f.push(i);f.end=end;if(g=fragmentByStart[end]){delete fragmentByStart[g.start];var fg=g===f?f:f.concat(g);fragmentByStart[fg.start=f.start]=fragmentByEnd[fg.end=g.end]=fg}else{fragmentByStart[f.start]=fragmentByEnd[f.end]=f}}else if(f=fragmentByStart[end]){delete fragmentByStart[f.start];f.unshift(i);f.start=start;if(g=fragmentByEnd[start]){delete fragmentByEnd[g.end];var gf=g===f?f:g.concat(f);fragmentByStart[gf.start=g.start]=fragmentByEnd[gf.end=f.end]=gf}else{fragmentByStart[f.start]=fragmentByEnd[f.end]=f}}else{f=[i];fragmentByStart[f.start=start]=fragmentByEnd[f.end=end]=f}}));function ends(i){var arc=topology.arcs[i<0?~i:i],p0=arc[0],p1;if(topology.transform)p1=[0,0],arc.forEach((function(dp){p1[0]+=dp[0],p1[1]+=dp[1]}));else p1=arc[arc.length-1];return i<0?[p1,p0]:[p0,p1]}function flush(fragmentByEnd,fragmentByStart){for(var k in fragmentByEnd){var f=fragmentByEnd[k];delete fragmentByStart[f.start];delete f.start;delete f.end;f.forEach((function(i){stitchedArcs[i<0?~i:i]=1}));fragments.push(f)}}flush(fragmentByEnd,fragmentByStart);flush(fragmentByStart,fragmentByEnd);arcs.forEach((function(i){if(!stitchedArcs[i<0?~i:i])fragments.push([i])}));return fragments}function mesh(topology){return object(topology,meshArcs.apply(this,arguments))}function meshArcs(topology,object,filter){var arcs,i,n;if(arguments.length>1)arcs=extractArcs(topology,object,filter);else for(i=0,arcs=new Array(n=topology.arcs.length);i<n;++i){arcs[i]=i}return{type:"MultiLineString",arcs:stitch(topology,arcs)}}function extractArcs(topology,object,filter){var arcs=[],geomsByArc=[],geom;function extract0(i){var j=i<0?~i:i;(geomsByArc[j]||(geomsByArc[j]=[])).push({i:i,g:geom})}function extract1(arcs){arcs.forEach(extract0)}function extract2(arcs){arcs.forEach(extract1)}function extract3(arcs){arcs.forEach(extract2)}function geometry(o){switch(geom=o,o.type){case"GeometryCollection":o.geometries.forEach(geometry);break;case"LineString":extract1(o.arcs);break;case"MultiLineString":case"Polygon":extract2(o.arcs);break;case"MultiPolygon":extract3(o.arcs);break}}geometry(object);geomsByArc.forEach(filter==null?function(geoms){arcs.push(geoms[0].i)}:function(geoms){if(filter(geoms[0].g,geoms[geoms.length-1].g))arcs.push(geoms[0].i)});return arcs}var filters={interior:function interior(a,b){return a!==b},exterior:function exterior(a,b){return a===b}};function topojson(data,format){var method,object,property,filter;data=json(data,format);if(format&&format.feature){method=feature;property=format.feature}else if(format&&format.mesh){method=mesh;property=format.mesh;filter=filters[format.filter]}else{error("Missing TopoJSON feature or mesh parameter.")}object=(object=data.objects[property])?method(data,object,filter):error("Invalid TopoJSON object: "+property);return object&&object.features||[object]}topojson.responseType="json";var format={dsv:dsv,csv:delimitedFormat(","),tsv:delimitedFormat("\t"),json:json,topojson:topojson};function formats(name,reader){if(arguments.length>1){format[name]=reader;return this}else{return _has(format,name)?format[name]:null}}function responseType(type){var f=formats(type);return f&&f.responseType||"text"}function ascending$1(a,b){return a<b?-1:a>b?1:a>=b?0:NaN}function bisector(f){var delta=f;var compare=f;if(f.length===1){delta=function delta(d,x){return f(d)-x};compare=ascendingComparator(f)}function left(a,x,lo,hi){if(lo==null)lo=0;if(hi==null)hi=a.length;while(lo<hi){var mid=lo+hi>>>1;if(compare(a[mid],x)<0)lo=mid+1;else hi=mid}return lo}function right(a,x,lo,hi){if(lo==null)lo=0;if(hi==null)hi=a.length;while(lo<hi){var mid=lo+hi>>>1;if(compare(a[mid],x)>0)hi=mid;else lo=mid+1}return lo}function center(a,x,lo,hi){if(lo==null)lo=0;if(hi==null)hi=a.length;var i=left(a,x,lo,hi-1);return i>lo&&delta(a[i-1],x)>-delta(a[i],x)?i-1:i}return{left:left,center:center,right:right}}function ascendingComparator(f){return function(d,x){return ascending$1(f(d),x)}}var _marked=regeneratorRuntime.mark(numbers);function number(x){return x===null?NaN:+x}function numbers(values,valueof){var _iterator,_step,value,index,_iterator2,_step2,_value;return regeneratorRuntime.wrap((function numbers$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(valueof===undefined)){_context.next=21;break}_iterator=_createForOfIteratorHelper(values);_context.prev=2;_iterator.s();case 4:if((_step=_iterator.n()).done){_context.next=11;break}value=_step.value;if(!(value!=null&&(value=+value)>=value)){_context.next=9;break}_context.next=9;return value;case 9:_context.next=4;break;case 11:_context.next=16;break;case 13:_context.prev=13;_context.t0=_context["catch"](2);_iterator.e(_context.t0);case 16:_context.prev=16;_iterator.f();return _context.finish(16);case 19:_context.next=40;break;case 21:index=-1;_iterator2=_createForOfIteratorHelper(values);_context.prev=23;_iterator2.s();case 25:if((_step2=_iterator2.n()).done){_context.next=32;break}_value=_step2.value;if(!((_value=valueof(_value,++index,values))!=null&&(_value=+_value)>=_value)){_context.next=30;break}_context.next=30;return _value;case 30:_context.next=25;break;case 32:_context.next=37;break;case 34:_context.prev=34;_context.t1=_context["catch"](23);_iterator2.e(_context.t1);case 37:_context.prev=37;_iterator2.f();return _context.finish(37);case 40:case"end":return _context.stop()}}}),_marked,null,[[2,13,16,19],[23,34,37,40]])}var ascendingBisect=bisector(ascending$1);var bisectRight=ascendingBisect.right;var bisectLeft=ascendingBisect.left;var bisectCenter=bisector(number).center;function variance(values,valueof){var count=0;var delta;var mean=0;var sum=0;if(valueof===undefined){var _iterator=_createForOfIteratorHelper(values),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var value=_step.value;if(value!=null&&(value=+value)>=value){delta=value-mean;mean+=delta/++count;sum+=delta*(value-mean)}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}else{var index=-1;var _iterator2=_createForOfIteratorHelper(values),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _value=_step2.value;if((_value=valueof(_value,++index,values))!=null&&(_value=+_value)>=_value){delta=_value-mean;mean+=delta/++count;sum+=delta*(_value-mean)}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}if(count>1)return sum/(count-1)}function deviation(values,valueof){var v=variance(values,valueof);return v?Math.sqrt(v):v}var Adder=function(){function Adder(){_classCallCheck(this,Adder);this._partials=new Float64Array(32);this._n=0}_createClass(Adder,[{key:"add",value:function add(x){var p=this._partials;var i=0;for(var j=0;j<this._n&&j<32;j++){var y=p[j],hi=x+y,lo=Math.abs(x)<Math.abs(y)?x-(hi-y):y-(hi-x);if(lo)p[i++]=lo;x=hi}p[i]=x;this._n=i+1;return this}},{key:"valueOf",value:function valueOf(){var p=this._partials;var n=this._n,x,y,lo,hi=0;if(n>0){hi=p[--n];while(n>0){x=hi;y=p[--n];hi=x+y;lo=y-(hi-x);if(lo)break}if(n>0&&(lo<0&&p[n-1]<0||lo>0&&p[n-1]>0)){y=lo*2;x=hi+y;if(y==x-hi)hi=x}}return hi}}]);return Adder}();var e10=Math.sqrt(50),e5=Math.sqrt(10),e2=Math.sqrt(2);function ticks(start,stop,count){var reverse,i=-1,n,ticks,step;stop=+stop,start=+start,count=+count;if(start===stop&&count>0)return[start];if(reverse=stop<start)n=start,start=stop,stop=n;if((step=tickIncrement(start,stop,count))===0||!isFinite(step))return[];if(step>0){start=Math.ceil(start/step);stop=Math.floor(stop/step);ticks=new Array(n=Math.ceil(stop-start+1));while(++i<n){ticks[i]=(start+i)*step}}else{step=-step;start=Math.ceil(start*step);stop=Math.floor(stop*step);ticks=new Array(n=Math.ceil(stop-start+1));while(++i<n){ticks[i]=(start+i)/step}}if(reverse)ticks.reverse();return ticks}function tickIncrement(start,stop,count){var step=(stop-start)/Math.max(0,count),power=Math.floor(Math.log(step)/Math.LN10),error=step/Math.pow(10,power);return power>=0?(error>=e10?10:error>=e5?5:error>=e2?2:1)*Math.pow(10,power):-Math.pow(10,-power)/(error>=e10?10:error>=e5?5:error>=e2?2:1)}function tickStep(start,stop,count){var step0=Math.abs(stop-start)/Math.max(0,count),step1=Math.pow(10,Math.floor(Math.log(step0)/Math.LN10)),error=step0/step1;if(error>=e10)step1*=10;else if(error>=e5)step1*=5;else if(error>=e2)step1*=2;return stop<start?-step1:step1}function max(values,valueof){var max;if(valueof===undefined){var _iterator=_createForOfIteratorHelper(values),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var value=_step.value;if(value!=null&&(max<value||max===undefined&&value>=value)){max=value}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}else{var index=-1;var _iterator2=_createForOfIteratorHelper(values),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _value=_step2.value;if((_value=valueof(_value,++index,values))!=null&&(max<_value||max===undefined&&_value>=_value)){max=_value}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}return max}function min(values,valueof){var min;if(valueof===undefined){var _iterator=_createForOfIteratorHelper(values),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var value=_step.value;if(value!=null&&(min>value||min===undefined&&value>=value)){min=value}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}else{var index=-1;var _iterator2=_createForOfIteratorHelper(values),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _value=_step2.value;if((_value=valueof(_value,++index,values))!=null&&(min>_value||min===undefined&&_value>=_value)){min=_value}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}return min}function quickselect(array,k){var left=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var right=arguments.length>3&&arguments[3]!==undefined?arguments[3]:array.length-1;var compare=arguments.length>4&&arguments[4]!==undefined?arguments[4]:ascending$1;while(right>left){if(right-left>600){var n=right-left+1;var m=k-left+1;var z=Math.log(n);var s=.5*Math.exp(2*z/3);var sd=.5*Math.sqrt(z*s*(n-s)/n)*(m-n/2<0?-1:1);var newLeft=Math.max(left,Math.floor(k-m*s/n+sd));var newRight=Math.min(right,Math.floor(k+(n-m)*s/n+sd));quickselect(array,k,newLeft,newRight,compare)}var t=array[k];var i=left;var j=right;swap(array,left,k);if(compare(array[right],t)>0)swap(array,left,right);while(i<j){swap(array,i,j),++i,--j;while(compare(array[i],t)<0){++i}while(compare(array[j],t)>0){--j}}if(compare(array[left],t)===0)swap(array,left,j);else++j,swap(array,j,right);if(j<=k)left=j+1;if(k<=j)right=j-1}return array}function swap(array,i,j){var t=array[i];array[i]=array[j];array[j]=t}function quantile(values,p,valueof){values=Float64Array.from(numbers(values,valueof));if(!(n=values.length))return;if((p=+p)<=0||n<2)return min(values);if(p>=1)return max(values);var n,i=(n-1)*p,i0=Math.floor(i),value0=max(quickselect(values,i0).subarray(0,i0+1)),value1=min(values.subarray(i0+1));return value0+(value1-value0)*(i-i0)}function quantileSorted(values,p){var valueof=arguments.length>2&&arguments[2]!==undefined?arguments[2]:number;if(!(n=values.length))return;if((p=+p)<=0||n<2)return+valueof(values[0],0,values);if(p>=1)return+valueof(values[n-1],n-1,values);var n,i=(n-1)*p,i0=Math.floor(i),value0=+valueof(values[i0],i0,values),value1=+valueof(values[i0+1],i0+1,values);return value0+(value1-value0)*(i-i0)}function mean(values,valueof){var count=0;var sum=0;if(valueof===undefined){var _iterator=_createForOfIteratorHelper(values),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var value=_step.value;if(value!=null&&(value=+value)>=value){++count,sum+=value}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}else{var index=-1;var _iterator2=_createForOfIteratorHelper(values),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _value=_step2.value;if((_value=valueof(_value,++index,values))!=null&&(_value=+_value)>=_value){++count,sum+=_value}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}if(count)return sum/count}function median(values,valueof){return quantile(values,.5,valueof)}var _marked$1=regeneratorRuntime.mark(flatten);function flatten(arrays){var _iterator,_step,array;return regeneratorRuntime.wrap((function flatten$(_context){while(1){switch(_context.prev=_context.next){case 0:_iterator=_createForOfIteratorHelper(arrays);_context.prev=1;_iterator.s();case 3:if((_step=_iterator.n()).done){_context.next=8;break}array=_step.value;return _context.delegateYield(array,"t0",6);case 6:_context.next=3;break;case 8:_context.next=13;break;case 10:_context.prev=10;_context.t1=_context["catch"](1);_iterator.e(_context.t1);case 13:_context.prev=13;_iterator.f();return _context.finish(13);case 16:case"end":return _context.stop()}}}),_marked$1,null,[[1,10,13,16]])}function merge$1(arrays){return Array.from(flatten(arrays))}function permute(source,keys){return Array.from(keys,(function(key){return source[key]}))}function range$1(start,stop,step){start=+start,stop=+stop,step=(n=arguments.length)<2?(stop=start,start=0,1):n<3?1:+step;var i=-1,n=Math.max(0,Math.ceil((stop-start)/step))|0,range=new Array(n);while(++i<n){range[i]=start+i*step}return range}function sum(values,valueof){var sum=0;if(valueof===undefined){var _iterator=_createForOfIteratorHelper(values),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var value=_step.value;if(value=+value){sum+=value}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}else{var index=-1;var _iterator2=_createForOfIteratorHelper(values),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _value=_step2.value;if(_value=+valueof(_value,++index,values)){sum+=_value}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}return sum}function formatDecimal(x){return Math.abs(x=Math.round(x))>=1e21?x.toLocaleString("en").replace(/,/g,""):x.toString(10)}function formatDecimalParts(x,p){if((i=(x=p?x.toExponential(p-1):x.toExponential()).indexOf("e"))<0)return null;var i,coefficient=x.slice(0,i);return[coefficient.length>1?coefficient[0]+coefficient.slice(2):coefficient,+x.slice(i+1)]}function exponent(x){return x=formatDecimalParts(Math.abs(x)),x?x[1]:NaN}function formatGroup(grouping,thousands){return function(value,width){var i=value.length,t=[],j=0,g=grouping[0],length=0;while(i>0&&g>0){if(length+g+1>width)g=Math.max(1,width-length);t.push(value.substring(i-=g,i+g));if((length+=g+1)>width)break;g=grouping[j=(j+1)%grouping.length]}return t.reverse().join(thousands)}}function formatNumerals(numerals){return function(value){return value.replace(/[0-9]/g,(function(i){return numerals[+i]}))}}var re=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function formatSpecifier(specifier){if(!(match=re.exec(specifier)))throw new Error("invalid format: "+specifier);var match;return new FormatSpecifier({fill:match[1],align:match[2],sign:match[3],symbol:match[4],zero:match[5],width:match[6],comma:match[7],precision:match[8]&&match[8].slice(1),trim:match[9],type:match[10]})}formatSpecifier.prototype=FormatSpecifier.prototype;function FormatSpecifier(specifier){this.fill=specifier.fill===undefined?" ":specifier.fill+"";this.align=specifier.align===undefined?">":specifier.align+"";this.sign=specifier.sign===undefined?"-":specifier.sign+"";this.symbol=specifier.symbol===undefined?"":specifier.symbol+"";this.zero=!!specifier.zero;this.width=specifier.width===undefined?undefined:+specifier.width;this.comma=!!specifier.comma;this.precision=specifier.precision===undefined?undefined:+specifier.precision;this.trim=!!specifier.trim;this.type=specifier.type===undefined?"":specifier.type+""}FormatSpecifier.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===undefined?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===undefined?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function formatTrim(s){out:for(var n=s.length,i=1,i0=-1,i1;i<n;++i){switch(s[i]){case".":i0=i1=i;break;case"0":if(i0===0)i0=i;i1=i;break;default:if(!+s[i])break out;if(i0>0)i0=0;break}}return i0>0?s.slice(0,i0)+s.slice(i1+1):s}var prefixExponent;function formatPrefixAuto(x,p){var d=formatDecimalParts(x,p);if(!d)return x+"";var coefficient=d[0],exponent=d[1],i=exponent-(prefixExponent=Math.max(-8,Math.min(8,Math.floor(exponent/3)))*3)+1,n=coefficient.length;return i===n?coefficient:i>n?coefficient+new Array(i-n+1).join("0"):i>0?coefficient.slice(0,i)+"."+coefficient.slice(i):"0."+new Array(1-i).join("0")+formatDecimalParts(x,Math.max(0,p+i-1))[0]}function formatRounded(x,p){var d=formatDecimalParts(x,p);if(!d)return x+"";var coefficient=d[0],exponent=d[1];return exponent<0?"0."+new Array(-exponent).join("0")+coefficient:coefficient.length>exponent+1?coefficient.slice(0,exponent+1)+"."+coefficient.slice(exponent+1):coefficient+new Array(exponent-coefficient.length+2).join("0")}var formatTypes={"%":function _(x,p){return(x*100).toFixed(p)},b:function b(x){return Math.round(x).toString(2)},c:function c(x){return x+""},d:formatDecimal,e:function e(x,p){return x.toExponential(p)},f:function f(x,p){return x.toFixed(p)},g:function g(x,p){return x.toPrecision(p)},o:function o(x){return Math.round(x).toString(8)},p:function p(x,_p){return formatRounded(x*100,_p)},r:formatRounded,s:formatPrefixAuto,X:function X(x){return Math.round(x).toString(16).toUpperCase()},x:function x(_x){return Math.round(_x).toString(16)}};function identity$2(x){return x}var map=Array.prototype.map,prefixes=["y","z","a","f","p","n","","m","","k","M","G","T","P","E","Z","Y"];function formatLocale(locale){var group=locale.grouping===undefined||locale.thousands===undefined?identity$2:formatGroup(map.call(locale.grouping,Number),locale.thousands+""),currencyPrefix=locale.currency===undefined?"":locale.currency[0]+"",currencySuffix=locale.currency===undefined?"":locale.currency[1]+"",decimal=locale.decimal===undefined?".":locale.decimal+"",numerals=locale.numerals===undefined?identity$2:formatNumerals(map.call(locale.numerals,String)),percent=locale.percent===undefined?"%":locale.percent+"",minus=locale.minus===undefined?"":locale.minus+"",nan=locale.nan===undefined?"NaN":locale.nan+"";function newFormat(specifier){specifier=formatSpecifier(specifier);var fill=specifier.fill,align=specifier.align,sign=specifier.sign,symbol=specifier.symbol,zero=specifier.zero,width=specifier.width,comma=specifier.comma,precision=specifier.precision,trim=specifier.trim,type=specifier.type;if(type==="n")comma=true,type="g";else if(!formatTypes[type])precision===undefined&&(precision=12),trim=true,type="g";if(zero||fill==="0"&&align==="=")zero=true,fill="0",align="=";var prefix=symbol==="$"?currencyPrefix:symbol==="#"&&/[boxX]/.test(type)?"0"+type.toLowerCase():"",suffix=symbol==="$"?currencySuffix:/[%p]/.test(type)?percent:"";var formatType=formatTypes[type],maybeSuffix=/[defgprs%]/.test(type);precision=precision===undefined?6:/[gprs]/.test(type)?Math.max(1,Math.min(21,precision)):Math.max(0,Math.min(20,precision));function format(value){var valuePrefix=prefix,valueSuffix=suffix,i,n,c;if(type==="c"){valueSuffix=formatType(value)+valueSuffix;value=""}else{value=+value;var valueNegative=value<0||1/value<0;value=isNaN(value)?nan:formatType(Math.abs(value),precision);if(trim)value=formatTrim(value);if(valueNegative&&+value===0&&sign!=="+")valueNegative=false;valuePrefix=(valueNegative?sign==="("?sign:minus:sign==="-"||sign==="("?"":sign)+valuePrefix;valueSuffix=(type==="s"?prefixes[8+prefixExponent/3]:"")+valueSuffix+(valueNegative&&sign==="("?")":"");if(maybeSuffix){i=-1,n=value.length;while(++i<n){if(c=value.charCodeAt(i),48>c||c>57){valueSuffix=(c===46?decimal+value.slice(i+1):value.slice(i))+valueSuffix;value=value.slice(0,i);break}}}}if(comma&&!zero)value=group(value,Infinity);var length=valuePrefix.length+value.length+valueSuffix.length,padding=length<width?new Array(width-length+1).join(fill):"";if(comma&&zero)value=group(padding+value,padding.length?width-valueSuffix.length:Infinity),padding="";switch(align){case"<":value=valuePrefix+value+valueSuffix+padding;break;case"=":value=valuePrefix+padding+value+valueSuffix;break;case"^":value=padding.slice(0,length=padding.length>>1)+valuePrefix+value+valueSuffix+padding.slice(length);break;default:value=padding+valuePrefix+value+valueSuffix;break}return numerals(value)}format.toString=function(){return specifier+""};return format}function formatPrefix(specifier,value){var f=newFormat((specifier=formatSpecifier(specifier),specifier.type="f",specifier)),e=Math.max(-8,Math.min(8,Math.floor(exponent(value)/3)))*3,k=Math.pow(10,-e),prefix=prefixes[8+e/3];return function(value){return f(k*value)+prefix}}return{format:newFormat,formatPrefix:formatPrefix}}var locale;var format$1;var formatPrefix;defaultLocale({thousands:",",grouping:[3],currency:["$",""]});function defaultLocale(definition){locale=formatLocale(definition);format$1=locale.format;formatPrefix=locale.formatPrefix;return locale}function precisionFixed(step){return Math.max(0,-exponent(Math.abs(step)))}function precisionPrefix(step,value){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(exponent(value)/3)))*3-exponent(Math.abs(step)))}function precisionRound(step,max){step=Math.abs(step),max=Math.abs(max)-step;return Math.max(0,exponent(max)-exponent(step))+1}var t0=new Date,t1=new Date;function newInterval(floori,offseti,count,field){function interval(date){return floori(date=arguments.length===0?new Date:new Date(+date)),date}interval.floor=function(date){return floori(date=new Date(+date)),date};interval.ceil=function(date){return floori(date=new Date(date-1)),offseti(date,1),floori(date),date};interval.round=function(date){var d0=interval(date),d1=interval.ceil(date);return date-d0<d1-date?d0:d1};interval.offset=function(date,step){return offseti(date=new Date(+date),step==null?1:Math.floor(step)),date};interval.range=function(start,stop,step){var range=[],previous;start=interval.ceil(start);step=step==null?1:Math.floor(step);if(!(start<stop)||!(step>0))return range;do{range.push(previous=new Date(+start)),offseti(start,step),floori(start)}while(previous<start&&start<stop);return range};interval.filter=function(test){return newInterval((function(date){if(date>=date)while(floori(date),!test(date)){date.setTime(date-1)}}),(function(date,step){if(date>=date){if(step<0)while(++step<=0){while(offseti(date,-1),!test(date)){}}else while(--step>=0){while(offseti(date,+1),!test(date)){}}}}))};if(count){interval.count=function(start,end){t0.setTime(+start),t1.setTime(+end);floori(t0),floori(t1);return Math.floor(count(t0,t1))};interval.every=function(step){step=Math.floor(step);return!isFinite(step)||!(step>0)?null:!(step>1)?interval:interval.filter(field?function(d){return field(d)%step===0}:function(d){return interval.count(0,d)%step===0})}}return interval}var millisecond=newInterval((function(){}),(function(date,step){date.setTime(+date+step)}),(function(start,end){return end-start}));millisecond.every=function(k){k=Math.floor(k);if(!isFinite(k)||!(k>0))return null;if(!(k>1))return millisecond;return newInterval((function(date){date.setTime(Math.floor(date/k)*k)}),(function(date,step){date.setTime(+date+step*k)}),(function(start,end){return(end-start)/k}))};var durationSecond=1e3;var durationMinute=6e4;var durationHour=36e5;var durationDay=864e5;var durationWeek=6048e5;var second=newInterval((function(date){date.setTime(date-date.getMilliseconds())}),(function(date,step){date.setTime(+date+step*durationSecond)}),(function(start,end){return(end-start)/durationSecond}),(function(date){return date.getUTCSeconds()}));var minute=newInterval((function(date){date.setTime(date-date.getMilliseconds()-date.getSeconds()*durationSecond)}),(function(date,step){date.setTime(+date+step*durationMinute)}),(function(start,end){return(end-start)/durationMinute}),(function(date){return date.getMinutes()}));var hour=newInterval((function(date){date.setTime(date-date.getMilliseconds()-date.getSeconds()*durationSecond-date.getMinutes()*durationMinute)}),(function(date,step){date.setTime(+date+step*durationHour)}),(function(start,end){return(end-start)/durationHour}),(function(date){return date.getHours()}));var day=newInterval((function(date){return date.setHours(0,0,0,0)}),(function(date,step){return date.setDate(date.getDate()+step)}),(function(start,end){return(end-start-(end.getTimezoneOffset()-start.getTimezoneOffset())*durationMinute)/durationDay}),(function(date){return date.getDate()-1}));function weekday(i){return newInterval((function(date){date.setDate(date.getDate()-(date.getDay()+7-i)%7);date.setHours(0,0,0,0)}),(function(date,step){date.setDate(date.getDate()+step*7)}),(function(start,end){return(end-start-(end.getTimezoneOffset()-start.getTimezoneOffset())*durationMinute)/durationWeek}))}var sunday=weekday(0);var monday=weekday(1);var tuesday=weekday(2);var wednesday=weekday(3);var thursday=weekday(4);var friday=weekday(5);var saturday=weekday(6);var month=newInterval((function(date){date.setDate(1);date.setHours(0,0,0,0)}),(function(date,step){date.setMonth(date.getMonth()+step)}),(function(start,end){return end.getMonth()-start.getMonth()+(end.getFullYear()-start.getFullYear())*12}),(function(date){return date.getMonth()}));var year=newInterval((function(date){date.setMonth(0,1);date.setHours(0,0,0,0)}),(function(date,step){date.setFullYear(date.getFullYear()+step)}),(function(start,end){return end.getFullYear()-start.getFullYear()}),(function(date){return date.getFullYear()}));year.every=function(k){return!isFinite(k=Math.floor(k))||!(k>0)?null:newInterval((function(date){date.setFullYear(Math.floor(date.getFullYear()/k)*k);date.setMonth(0,1);date.setHours(0,0,0,0)}),(function(date,step){date.setFullYear(date.getFullYear()+step*k)}))};var utcMinute=newInterval((function(date){date.setUTCSeconds(0,0)}),(function(date,step){date.setTime(+date+step*durationMinute)}),(function(start,end){return(end-start)/durationMinute}),(function(date){return date.getUTCMinutes()}));var utcHour=newInterval((function(date){date.setUTCMinutes(0,0,0)}),(function(date,step){date.setTime(+date+step*durationHour)}),(function(start,end){return(end-start)/durationHour}),(function(date){return date.getUTCHours()}));var utcDay=newInterval((function(date){date.setUTCHours(0,0,0,0)}),(function(date,step){date.setUTCDate(date.getUTCDate()+step)}),(function(start,end){return(end-start)/durationDay}),(function(date){return date.getUTCDate()-1}));function utcWeekday(i){return newInterval((function(date){date.setUTCDate(date.getUTCDate()-(date.getUTCDay()+7-i)%7);date.setUTCHours(0,0,0,0)}),(function(date,step){date.setUTCDate(date.getUTCDate()+step*7)}),(function(start,end){return(end-start)/durationWeek}))}var utcSunday=utcWeekday(0);var utcMonday=utcWeekday(1);var utcTuesday=utcWeekday(2);var utcWednesday=utcWeekday(3);var utcThursday=utcWeekday(4);var utcFriday=utcWeekday(5);var utcSaturday=utcWeekday(6);var utcMonth=newInterval((function(date){date.setUTCDate(1);date.setUTCHours(0,0,0,0)}),(function(date,step){date.setUTCMonth(date.getUTCMonth()+step)}),(function(start,end){return end.getUTCMonth()-start.getUTCMonth()+(end.getUTCFullYear()-start.getUTCFullYear())*12}),(function(date){return date.getUTCMonth()}));var utcYear=newInterval((function(date){date.setUTCMonth(0,1);date.setUTCHours(0,0,0,0)}),(function(date,step){date.setUTCFullYear(date.getUTCFullYear()+step)}),(function(start,end){return end.getUTCFullYear()-start.getUTCFullYear()}),(function(date){return date.getUTCFullYear()}));utcYear.every=function(k){return!isFinite(k=Math.floor(k))||!(k>0)?null:newInterval((function(date){date.setUTCFullYear(Math.floor(date.getUTCFullYear()/k)*k);date.setUTCMonth(0,1);date.setUTCHours(0,0,0,0)}),(function(date,step){date.setUTCFullYear(date.getUTCFullYear()+step*k)}))};var _defaultSpecifiers,_localGet,_localInv,_utcGet,_utcInv,_timeIntervals,_utcIntervals;var YEAR="year";var QUARTER="quarter";var MONTH="month";var WEEK="week";var DATE="date";var DAY="day";var DAYOFYEAR="dayofyear";var HOURS="hours";var MINUTES="minutes";var SECONDS="seconds";var MILLISECONDS="milliseconds";var TIME_UNITS=[YEAR,QUARTER,MONTH,WEEK,DATE,DAY,DAYOFYEAR,HOURS,MINUTES,SECONDS,MILLISECONDS];var UNITS=TIME_UNITS.reduce((function(o,u,i){return o[u]=1+i,o}),{});function timeUnits(units){var u=array(units).slice(),m={};if(!u.length)error("Missing time unit.");u.forEach((function(unit){if(_has(UNITS,unit)){m[unit]=1}else{error("Invalid time unit: ".concat(unit,"."))}}));var numTypes=(m[WEEK]||m[DAY]?1:0)+(m[QUARTER]||m[MONTH]||m[DATE]?1:0)+(m[DAYOFYEAR]?1:0);if(numTypes>1){error("Incompatible time units: ".concat(units))}u.sort((function(a,b){return UNITS[a]-UNITS[b]}));return u}var defaultSpecifiers=(_defaultSpecifiers={},_defineProperty(_defaultSpecifiers,YEAR,"%Y "),_defineProperty(_defaultSpecifiers,QUARTER,"Q%q "),_defineProperty(_defaultSpecifiers,MONTH,"%b "),_defineProperty(_defaultSpecifiers,DATE,"%d "),_defineProperty(_defaultSpecifiers,WEEK,"W%U "),_defineProperty(_defaultSpecifiers,DAY,"%a "),_defineProperty(_defaultSpecifiers,DAYOFYEAR,"%j "),_defineProperty(_defaultSpecifiers,HOURS,"%H:00"),_defineProperty(_defaultSpecifiers,MINUTES,"00:%M"),_defineProperty(_defaultSpecifiers,SECONDS,":%S"),_defineProperty(_defaultSpecifiers,MILLISECONDS,".%L"),_defineProperty(_defaultSpecifiers,"".concat(YEAR,"-").concat(MONTH),"%Y-%m "),_defineProperty(_defaultSpecifiers,"".concat(YEAR,"-").concat(MONTH,"-").concat(DATE),"%Y-%m-%d "),_defineProperty(_defaultSpecifiers,"".concat(HOURS,"-").concat(MINUTES),"%H:%M"),_defaultSpecifiers);function timeUnitSpecifier(units,specifiers){var s=extend({},defaultSpecifiers,specifiers),u=timeUnits(units),n=u.length;var fmt="",start=0,end,key;for(start=0;start<n;){for(end=u.length;end>start;--end){key=u.slice(start,end).join("-");if(s[key]!=null){fmt+=s[key];start=end;break}}}return fmt.trim()}var t0$1=new Date;function localYear(y){t0$1.setFullYear(y);t0$1.setMonth(0);t0$1.setDate(1);t0$1.setHours(0,0,0,0);return t0$1}function dayofyear(d){return localDayOfYear(new Date(d))}function week(d){return localWeekNum(new Date(d))}function localDayOfYear(d){return day.count(localYear(d.getFullYear())-1,d)}function localWeekNum(d){return sunday.count(localYear(d.getFullYear())-1,d)}function localFirst(y){return localYear(y).getDay()}function localDate(y,m,d,H,M,S,L){if(0<=y&&y<100){var date=new Date(-1,m,d,H,M,S,L);date.setFullYear(y);return date}return new Date(y,m,d,H,M,S,L)}function utcdayofyear(d){return utcDayOfYear(new Date(d))}function utcweek(d){return utcWeekNum(new Date(d))}function utcDayOfYear(d){var y=Date.UTC(d.getUTCFullYear(),0,1);return utcDay.count(y-1,d)}function utcWeekNum(d){var y=Date.UTC(d.getUTCFullYear(),0,1);return utcSunday.count(y-1,d)}function utcFirst(y){t0$1.setTime(Date.UTC(y,0,1));return t0$1.getUTCDay()}function utcDate(y,m,d,H,M,S,L){if(0<=y&&y<100){var date=new Date(Date.UTC(-1,m,d,H,M,S,L));date.setUTCFullYear(d.y);return date}return new Date(Date.UTC(y,m,d,H,M,S,L))}function floor(units,step,get,inv,newDate){var s=step||1,b=peek(units),_=function _(unit,p,key){key=key||unit;return getUnit(get[key],inv[key],unit===b&&s,p)};var t=new Date,u=toSet(units),y=u[YEAR]?_(YEAR):constant(2012),m=u[MONTH]?_(MONTH):u[QUARTER]?_(QUARTER):zero,d=u[WEEK]&&u[DAY]?_(DAY,1,WEEK+DAY):u[WEEK]?_(WEEK,1):u[DAY]?_(DAY,1):u[DATE]?_(DATE,1):u[DAYOFYEAR]?_(DAYOFYEAR,1):one,H=u[HOURS]?_(HOURS):zero,M=u[MINUTES]?_(MINUTES):zero,S=u[SECONDS]?_(SECONDS):zero,L=u[MILLISECONDS]?_(MILLISECONDS):zero;return function(v){t.setTime(+v);var year=y(t);return newDate(year,m(t),d(t,year),H(t),M(t),S(t),L(t))}}function getUnit(f,inv,step,phase){var u=step<=1?f:phase?function(d,y){return phase+step*Math.floor((f(d,y)-phase)/step)}:function(d,y){return step*Math.floor(f(d,y)/step)};return inv?function(d,y){return inv(u(d,y),y)}:u}function weekday$1(week,day,firstDay){return day+week*7-(firstDay+6)%7}var localGet=(_localGet={},_defineProperty(_localGet,YEAR,(function(d){return d.getFullYear()})),_defineProperty(_localGet,QUARTER,(function(d){return Math.floor(d.getMonth()/3)})),_defineProperty(_localGet,MONTH,(function(d){return d.getMonth()})),_defineProperty(_localGet,DATE,(function(d){return d.getDate()})),_defineProperty(_localGet,HOURS,(function(d){return d.getHours()})),_defineProperty(_localGet,MINUTES,(function(d){return d.getMinutes()})),_defineProperty(_localGet,SECONDS,(function(d){return d.getSeconds()})),_defineProperty(_localGet,MILLISECONDS,(function(d){return d.getMilliseconds()})),_defineProperty(_localGet,DAYOFYEAR,(function(d){return localDayOfYear(d)})),_defineProperty(_localGet,WEEK,(function(d){return localWeekNum(d)})),_defineProperty(_localGet,WEEK+DAY,(function(d,y){return weekday$1(localWeekNum(d),d.getDay(),localFirst(y))})),_defineProperty(_localGet,DAY,(function(d,y){return weekday$1(1,d.getDay(),localFirst(y))})),_localGet);var localInv=(_localInv={},_defineProperty(_localInv,QUARTER,(function(q){return 3*q})),_defineProperty(_localInv,WEEK,(function(w,y){return weekday$1(w,0,localFirst(y))})),_localInv);function timeFloor(units,step){return floor(units,step||1,localGet,localInv,localDate)}var utcGet=(_utcGet={},_defineProperty(_utcGet,YEAR,(function(d){return d.getUTCFullYear()})),_defineProperty(_utcGet,QUARTER,(function(d){return Math.floor(d.getUTCMonth()/3)})),_defineProperty(_utcGet,MONTH,(function(d){return d.getUTCMonth()})),_defineProperty(_utcGet,DATE,(function(d){return d.getUTCDate()})),_defineProperty(_utcGet,HOURS,(function(d){return d.getUTCHours()})),_defineProperty(_utcGet,MINUTES,(function(d){return d.getUTCMinutes()})),_defineProperty(_utcGet,SECONDS,(function(d){return d.getUTCSeconds()})),_defineProperty(_utcGet,MILLISECONDS,(function(d){return d.getUTCMilliseconds()})),_defineProperty(_utcGet,DAYOFYEAR,(function(d){return utcDayOfYear(d)})),_defineProperty(_utcGet,WEEK,(function(d){return utcWeekNum(d)})),_defineProperty(_utcGet,DAY,(function(d,y){return weekday$1(1,d.getUTCDay(),utcFirst(y))})),_defineProperty(_utcGet,WEEK+DAY,(function(d,y){return weekday$1(utcWeekNum(d),d.getUTCDay(),utcFirst(y))})),_utcGet);var utcInv=(_utcInv={},_defineProperty(_utcInv,QUARTER,(function(q){return 3*q})),_defineProperty(_utcInv,WEEK,(function(w,y){return weekday$1(w,0,utcFirst(y))})),_utcInv);function utcFloor(units,step){return floor(units,step||1,utcGet,utcInv,utcDate)}var timeIntervals=(_timeIntervals={},_defineProperty(_timeIntervals,YEAR,year),_defineProperty(_timeIntervals,QUARTER,month.every(3)),_defineProperty(_timeIntervals,MONTH,month),_defineProperty(_timeIntervals,WEEK,sunday),_defineProperty(_timeIntervals,DATE,day),_defineProperty(_timeIntervals,DAY,day),_defineProperty(_timeIntervals,DAYOFYEAR,day),_defineProperty(_timeIntervals,HOURS,hour),_defineProperty(_timeIntervals,MINUTES,minute),_defineProperty(_timeIntervals,SECONDS,second),_defineProperty(_timeIntervals,MILLISECONDS,millisecond),_timeIntervals);var utcIntervals=(_utcIntervals={},_defineProperty(_utcIntervals,YEAR,utcYear),_defineProperty(_utcIntervals,QUARTER,utcMonth.every(3)),_defineProperty(_utcIntervals,MONTH,utcMonth),_defineProperty(_utcIntervals,WEEK,utcSunday),_defineProperty(_utcIntervals,DATE,utcDay),_defineProperty(_utcIntervals,DAY,utcDay),_defineProperty(_utcIntervals,DAYOFYEAR,utcDay),_defineProperty(_utcIntervals,HOURS,utcHour),_defineProperty(_utcIntervals,MINUTES,utcMinute),_defineProperty(_utcIntervals,SECONDS,second),_defineProperty(_utcIntervals,MILLISECONDS,millisecond),_utcIntervals);function timeInterval(unit){return timeIntervals[unit]}function utcInterval(unit){return utcIntervals[unit]}function offset(ival,date,step){return ival?ival.offset(date,step):undefined}function timeOffset(unit,date,step){return offset(timeInterval(unit),date,step)}function utcOffset(unit,date,step){return offset(utcInterval(unit),date,step)}function sequence(ival,start,stop,step){return ival?ival.range(start,stop,step):undefined}function timeSequence(unit,start,stop,step){return sequence(timeInterval(unit),start,stop,step)}function utcSequence(unit,start,stop,step){return sequence(utcInterval(unit),start,stop,step)}var durationSecond$1=1e3,durationMinute$1=durationSecond$1*60,durationHour$1=durationMinute$1*60,durationDay$1=durationHour$1*24,durationWeek$1=durationDay$1*7,durationMonth=durationDay$1*30,durationYear=durationDay$1*365;var Milli=[YEAR,MONTH,DATE,HOURS,MINUTES,SECONDS,MILLISECONDS],Seconds=Milli.slice(0,-1),Minutes=Seconds.slice(0,-1),Hours=Minutes.slice(0,-1),Day=Hours.slice(0,-1),Week=[YEAR,WEEK],Month=[YEAR,MONTH],Year=[YEAR];var intervals=[[Seconds,1,durationSecond$1],[Seconds,5,5*durationSecond$1],[Seconds,15,15*durationSecond$1],[Seconds,30,30*durationSecond$1],[Minutes,1,durationMinute$1],[Minutes,5,5*durationMinute$1],[Minutes,15,15*durationMinute$1],[Minutes,30,30*durationMinute$1],[Hours,1,durationHour$1],[Hours,3,3*durationHour$1],[Hours,6,6*durationHour$1],[Hours,12,12*durationHour$1],[Day,1,durationDay$1],[Week,1,durationWeek$1],[Month,1,durationMonth],[Month,3,3*durationMonth],[Year,1,durationYear]];function bin(opt){var ext=opt.extent,max=opt.maxbins||40,target=Math.abs(span(ext))/max;var i=bisector((function(i){return i[2]})).right(intervals,target),units,step;if(i===intervals.length){units=Year,step=tickStep(ext[0]/durationYear,ext[1]/durationYear,max)}else if(i){i=intervals[target/intervals[i-1][2]<intervals[i][2]/target?i-1:i];units=i[0];step=i[1]}else{units=Milli;step=Math.max(tickStep(ext[0],ext[1],max),1)}return{units:units,step:step}}function localDate$1(d){if(0<=d.y&&d.y<100){var date=new Date(-1,d.m,d.d,d.H,d.M,d.S,d.L);date.setFullYear(d.y);return date}return new Date(d.y,d.m,d.d,d.H,d.M,d.S,d.L)}function utcDate$1(d){if(0<=d.y&&d.y<100){var date=new Date(Date.UTC(-1,d.m,d.d,d.H,d.M,d.S,d.L));date.setUTCFullYear(d.y);return date}return new Date(Date.UTC(d.y,d.m,d.d,d.H,d.M,d.S,d.L))}function newDate(y,m,d){return{y:y,m:m,d:d,H:0,M:0,S:0,L:0}}function formatLocale$1(locale){var locale_dateTime=locale.dateTime,locale_date=locale.date,locale_time=locale.time,locale_periods=locale.periods,locale_weekdays=locale.days,locale_shortWeekdays=locale.shortDays,locale_months=locale.months,locale_shortMonths=locale.shortMonths;var periodRe=formatRe(locale_periods),periodLookup=formatLookup(locale_periods),weekdayRe=formatRe(locale_weekdays),weekdayLookup=formatLookup(locale_weekdays),shortWeekdayRe=formatRe(locale_shortWeekdays),shortWeekdayLookup=formatLookup(locale_shortWeekdays),monthRe=formatRe(locale_months),monthLookup=formatLookup(locale_months),shortMonthRe=formatRe(locale_shortMonths),shortMonthLookup=formatLookup(locale_shortMonths);var formats={a:formatShortWeekday,A:formatWeekday,b:formatShortMonth,B:formatMonth,c:null,d:formatDayOfMonth,e:formatDayOfMonth,f:formatMicroseconds,g:formatYearISO,G:formatFullYearISO,H:formatHour24,I:formatHour12,j:formatDayOfYear,L:formatMilliseconds,m:formatMonthNumber,M:formatMinutes,p:formatPeriod,q:formatQuarter,Q:formatUnixTimestamp,s:formatUnixTimestampSeconds,S:formatSeconds,u:formatWeekdayNumberMonday,U:formatWeekNumberSunday,V:formatWeekNumberISO,w:formatWeekdayNumberSunday,W:formatWeekNumberMonday,x:null,X:null,y:formatYear$1,Y:formatFullYear,Z:formatZone,"%":formatLiteralPercent};var utcFormats={a:formatUTCShortWeekday,A:formatUTCWeekday,b:formatUTCShortMonth,B:formatUTCMonth,c:null,d:formatUTCDayOfMonth,e:formatUTCDayOfMonth,f:formatUTCMicroseconds,g:formatUTCYearISO,G:formatUTCFullYearISO,H:formatUTCHour24,I:formatUTCHour12,j:formatUTCDayOfYear,L:formatUTCMilliseconds,m:formatUTCMonthNumber,M:formatUTCMinutes,p:formatUTCPeriod,q:formatUTCQuarter,Q:formatUnixTimestamp,s:formatUnixTimestampSeconds,S:formatUTCSeconds,u:formatUTCWeekdayNumberMonday,U:formatUTCWeekNumberSunday,V:formatUTCWeekNumberISO,w:formatUTCWeekdayNumberSunday,W:formatUTCWeekNumberMonday,x:null,X:null,y:formatUTCYear,Y:formatUTCFullYear,Z:formatUTCZone,"%":formatLiteralPercent};var parses={a:parseShortWeekday,A:parseWeekday,b:parseShortMonth,B:parseMonth,c:parseLocaleDateTime,d:parseDayOfMonth,e:parseDayOfMonth,f:parseMicroseconds,g:parseYear,G:parseFullYear,H:parseHour24,I:parseHour24,j:parseDayOfYear,L:parseMilliseconds,m:parseMonthNumber,M:parseMinutes,p:parsePeriod,q:parseQuarter,Q:parseUnixTimestamp,s:parseUnixTimestampSeconds,S:parseSeconds,u:parseWeekdayNumberMonday,U:parseWeekNumberSunday,V:parseWeekNumberISO,w:parseWeekdayNumberSunday,W:parseWeekNumberMonday,x:parseLocaleDate,X:parseLocaleTime,y:parseYear,Y:parseFullYear,Z:parseZone,"%":parseLiteralPercent};formats.x=newFormat(locale_date,formats);formats.X=newFormat(locale_time,formats);formats.c=newFormat(locale_dateTime,formats);utcFormats.x=newFormat(locale_date,utcFormats);utcFormats.X=newFormat(locale_time,utcFormats);utcFormats.c=newFormat(locale_dateTime,utcFormats);function newFormat(specifier,formats){return function(date){var string=[],i=-1,j=0,n=specifier.length,c,pad,format;if(!(date instanceof Date))date=new Date(+date);while(++i<n){if(specifier.charCodeAt(i)===37){string.push(specifier.slice(j,i));if((pad=pads[c=specifier.charAt(++i)])!=null)c=specifier.charAt(++i);else pad=c==="e"?" ":"0";if(format=formats[c])c=format(date,pad);string.push(c);j=i+1}}string.push(specifier.slice(j,i));return string.join("")}}function newParse(specifier,Z){return function(string){var d=newDate(1900,undefined,1),i=parseSpecifier(d,specifier,string+="",0),week,day$1;if(i!=string.length)return null;if("Q"in d)return new Date(d.Q);if("s"in d)return new Date(d.s*1e3+("L"in d?d.L:0));if(Z&&!("Z"in d))d.Z=0;if("p"in d)d.H=d.H%12+d.p*12;if(d.m===undefined)d.m="q"in d?d.q:0;if("V"in d){if(d.V<1||d.V>53)return null;if(!("w"in d))d.w=1;if("Z"in d){week=utcDate$1(newDate(d.y,0,1)),day$1=week.getUTCDay();week=day$1>4||day$1===0?utcMonday.ceil(week):utcMonday(week);week=utcDay.offset(week,(d.V-1)*7);d.y=week.getUTCFullYear();d.m=week.getUTCMonth();d.d=week.getUTCDate()+(d.w+6)%7}else{week=localDate$1(newDate(d.y,0,1)),day$1=week.getDay();week=day$1>4||day$1===0?monday.ceil(week):monday(week);week=day.offset(week,(d.V-1)*7);d.y=week.getFullYear();d.m=week.getMonth();d.d=week.getDate()+(d.w+6)%7}}else if("W"in d||"U"in d){if(!("w"in d))d.w="u"in d?d.u%7:"W"in d?1:0;day$1="Z"in d?utcDate$1(newDate(d.y,0,1)).getUTCDay():localDate$1(newDate(d.y,0,1)).getDay();d.m=0;d.d="W"in d?(d.w+6)%7+d.W*7-(day$1+5)%7:d.w+d.U*7-(day$1+6)%7}if("Z"in d){d.H+=d.Z/100|0;d.M+=d.Z%100;return utcDate$1(d)}return localDate$1(d)}}function parseSpecifier(d,specifier,string,j){var i=0,n=specifier.length,m=string.length,c,parse;while(i<n){if(j>=m)return-1;c=specifier.charCodeAt(i++);if(c===37){c=specifier.charAt(i++);parse=parses[c in pads?specifier.charAt(i++):c];if(!parse||(j=parse(d,string,j))<0)return-1}else if(c!=string.charCodeAt(j++)){return-1}}return j}function parsePeriod(d,string,i){var n=periodRe.exec(string.slice(i));return n?(d.p=periodLookup.get(n[0].toLowerCase()),i+n[0].length):-1}function parseShortWeekday(d,string,i){var n=shortWeekdayRe.exec(string.slice(i));return n?(d.w=shortWeekdayLookup.get(n[0].toLowerCase()),i+n[0].length):-1}function parseWeekday(d,string,i){var n=weekdayRe.exec(string.slice(i));return n?(d.w=weekdayLookup.get(n[0].toLowerCase()),i+n[0].length):-1}function parseShortMonth(d,string,i){var n=shortMonthRe.exec(string.slice(i));return n?(d.m=shortMonthLookup.get(n[0].toLowerCase()),i+n[0].length):-1}function parseMonth(d,string,i){var n=monthRe.exec(string.slice(i));return n?(d.m=monthLookup.get(n[0].toLowerCase()),i+n[0].length):-1}function parseLocaleDateTime(d,string,i){return parseSpecifier(d,locale_dateTime,string,i)}function parseLocaleDate(d,string,i){return parseSpecifier(d,locale_date,string,i)}function parseLocaleTime(d,string,i){return parseSpecifier(d,locale_time,string,i)}function formatShortWeekday(d){return locale_shortWeekdays[d.getDay()]}function formatWeekday(d){return locale_weekdays[d.getDay()]}function formatShortMonth(d){return locale_shortMonths[d.getMonth()]}function formatMonth(d){return locale_months[d.getMonth()]}function formatPeriod(d){return locale_periods[+(d.getHours()>=12)]}function formatQuarter(d){return 1+~~(d.getMonth()/3)}function formatUTCShortWeekday(d){return locale_shortWeekdays[d.getUTCDay()]}function formatUTCWeekday(d){return locale_weekdays[d.getUTCDay()]}function formatUTCShortMonth(d){return locale_shortMonths[d.getUTCMonth()]}function formatUTCMonth(d){return locale_months[d.getUTCMonth()]}function formatUTCPeriod(d){return locale_periods[+(d.getUTCHours()>=12)]}function formatUTCQuarter(d){return 1+~~(d.getUTCMonth()/3)}return{format:function format(specifier){var f=newFormat(specifier+="",formats);f.toString=function(){return specifier};return f},parse:function parse(specifier){var p=newParse(specifier+="",false);p.toString=function(){return specifier};return p},utcFormat:function utcFormat(specifier){var f=newFormat(specifier+="",utcFormats);f.toString=function(){return specifier};return f},utcParse:function utcParse(specifier){var p=newParse(specifier+="",true);p.toString=function(){return specifier};return p}}}var pads={"-":"",_:" ",0:"0"},numberRe=/^\s*\d+/,percentRe=/^%/,requoteRe=/[\\^$*+?|[\]().{}]/g;function pad$2(value,fill,width){var sign=value<0?"-":"",string=(sign?-value:value)+"",length=string.length;return sign+(length<width?new Array(width-length+1).join(fill)+string:string)}function requote(s){return s.replace(requoteRe,"\\$&")}function formatRe(names){return new RegExp("^(?:"+names.map(requote).join("|")+")","i")}function formatLookup(names){return new Map(names.map((function(name,i){return[name.toLowerCase(),i]})))}function parseWeekdayNumberSunday(d,string,i){var n=numberRe.exec(string.slice(i,i+1));return n?(d.w=+n[0],i+n[0].length):-1}function parseWeekdayNumberMonday(d,string,i){var n=numberRe.exec(string.slice(i,i+1));return n?(d.u=+n[0],i+n[0].length):-1}function parseWeekNumberSunday(d,string,i){var n=numberRe.exec(string.slice(i,i+2));return n?(d.U=+n[0],i+n[0].length):-1}function parseWeekNumberISO(d,string,i){var n=numberRe.exec(string.slice(i,i+2));return n?(d.V=+n[0],i+n[0].length):-1}function parseWeekNumberMonday(d,string,i){var n=numberRe.exec(string.slice(i,i+2));return n?(d.W=+n[0],i+n[0].length):-1}function parseFullYear(d,string,i){var n=numberRe.exec(string.slice(i,i+4));return n?(d.y=+n[0],i+n[0].length):-1}function parseYear(d,string,i){var n=numberRe.exec(string.slice(i,i+2));return n?(d.y=+n[0]+(+n[0]>68?1900:2e3),i+n[0].length):-1}function parseZone(d,string,i){var n=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(string.slice(i,i+6));return n?(d.Z=n[1]?0:-(n[2]+(n[3]||"00")),i+n[0].length):-1}function parseQuarter(d,string,i){var n=numberRe.exec(string.slice(i,i+1));return n?(d.q=n[0]*3-3,i+n[0].length):-1}function parseMonthNumber(d,string,i){var n=numberRe.exec(string.slice(i,i+2));return n?(d.m=n[0]-1,i+n[0].length):-1}function parseDayOfMonth(d,string,i){var n=numberRe.exec(string.slice(i,i+2));return n?(d.d=+n[0],i+n[0].length):-1}function parseDayOfYear(d,string,i){var n=numberRe.exec(string.slice(i,i+3));return n?(d.m=0,d.d=+n[0],i+n[0].length):-1}function parseHour24(d,string,i){var n=numberRe.exec(string.slice(i,i+2));return n?(d.H=+n[0],i+n[0].length):-1}function parseMinutes(d,string,i){var n=numberRe.exec(string.slice(i,i+2));return n?(d.M=+n[0],i+n[0].length):-1}function parseSeconds(d,string,i){var n=numberRe.exec(string.slice(i,i+2));return n?(d.S=+n[0],i+n[0].length):-1}function parseMilliseconds(d,string,i){var n=numberRe.exec(string.slice(i,i+3));return n?(d.L=+n[0],i+n[0].length):-1}function parseMicroseconds(d,string,i){var n=numberRe.exec(string.slice(i,i+6));return n?(d.L=Math.floor(n[0]/1e3),i+n[0].length):-1}function parseLiteralPercent(d,string,i){var n=percentRe.exec(string.slice(i,i+1));return n?i+n[0].length:-1}function parseUnixTimestamp(d,string,i){var n=numberRe.exec(string.slice(i));return n?(d.Q=+n[0],i+n[0].length):-1}function parseUnixTimestampSeconds(d,string,i){var n=numberRe.exec(string.slice(i));return n?(d.s=+n[0],i+n[0].length):-1}function formatDayOfMonth(d,p){return pad$2(d.getDate(),p,2)}function formatHour24(d,p){return pad$2(d.getHours(),p,2)}function formatHour12(d,p){return pad$2(d.getHours()%12||12,p,2)}function formatDayOfYear(d,p){return pad$2(1+day.count(year(d),d),p,3)}function formatMilliseconds(d,p){return pad$2(d.getMilliseconds(),p,3)}function formatMicroseconds(d,p){return formatMilliseconds(d,p)+"000"}function formatMonthNumber(d,p){return pad$2(d.getMonth()+1,p,2)}function formatMinutes(d,p){return pad$2(d.getMinutes(),p,2)}function formatSeconds(d,p){return pad$2(d.getSeconds(),p,2)}function formatWeekdayNumberMonday(d){var day=d.getDay();return day===0?7:day}function formatWeekNumberSunday(d,p){return pad$2(sunday.count(year(d)-1,d),p,2)}function dISO(d){var day=d.getDay();return day>=4||day===0?thursday(d):thursday.ceil(d)}function formatWeekNumberISO(d,p){d=dISO(d);return pad$2(thursday.count(year(d),d)+(year(d).getDay()===4),p,2)}function formatWeekdayNumberSunday(d){return d.getDay()}function formatWeekNumberMonday(d,p){return pad$2(monday.count(year(d)-1,d),p,2)}function formatYear$1(d,p){return pad$2(d.getFullYear()%100,p,2)}function formatYearISO(d,p){d=dISO(d);return pad$2(d.getFullYear()%100,p,2)}function formatFullYear(d,p){return pad$2(d.getFullYear()%1e4,p,4)}function formatFullYearISO(d,p){var day=d.getDay();d=day>=4||day===0?thursday(d):thursday.ceil(d);return pad$2(d.getFullYear()%1e4,p,4)}function formatZone(d){var z=d.getTimezoneOffset();return(z>0?"-":(z*=-1,"+"))+pad$2(z/60|0,"0",2)+pad$2(z%60,"0",2)}function formatUTCDayOfMonth(d,p){return pad$2(d.getUTCDate(),p,2)}function formatUTCHour24(d,p){return pad$2(d.getUTCHours(),p,2)}function formatUTCHour12(d,p){return pad$2(d.getUTCHours()%12||12,p,2)}function formatUTCDayOfYear(d,p){return pad$2(1+utcDay.count(utcYear(d),d),p,3)}function formatUTCMilliseconds(d,p){return pad$2(d.getUTCMilliseconds(),p,3)}function formatUTCMicroseconds(d,p){return formatUTCMilliseconds(d,p)+"000"}function formatUTCMonthNumber(d,p){return pad$2(d.getUTCMonth()+1,p,2)}function formatUTCMinutes(d,p){return pad$2(d.getUTCMinutes(),p,2)}function formatUTCSeconds(d,p){return pad$2(d.getUTCSeconds(),p,2)}function formatUTCWeekdayNumberMonday(d){var dow=d.getUTCDay();return dow===0?7:dow}function formatUTCWeekNumberSunday(d,p){return pad$2(utcSunday.count(utcYear(d)-1,d),p,2)}function UTCdISO(d){var day=d.getUTCDay();return day>=4||day===0?utcThursday(d):utcThursday.ceil(d)}function formatUTCWeekNumberISO(d,p){d=UTCdISO(d);return pad$2(utcThursday.count(utcYear(d),d)+(utcYear(d).getUTCDay()===4),p,2)}function formatUTCWeekdayNumberSunday(d){return d.getUTCDay()}function formatUTCWeekNumberMonday(d,p){return pad$2(utcMonday.count(utcYear(d)-1,d),p,2)}function formatUTCYear(d,p){return pad$2(d.getUTCFullYear()%100,p,2)}function formatUTCYearISO(d,p){d=UTCdISO(d);return pad$2(d.getUTCFullYear()%100,p,2)}function formatUTCFullYear(d,p){return pad$2(d.getUTCFullYear()%1e4,p,4)}function formatUTCFullYearISO(d,p){var day=d.getUTCDay();d=day>=4||day===0?utcThursday(d):utcThursday.ceil(d);return pad$2(d.getUTCFullYear()%1e4,p,4)}function formatUTCZone(){return"+0000"}function formatLiteralPercent(){return"%"}function formatUnixTimestamp(d){return+d}function formatUnixTimestampSeconds(d){return Math.floor(+d/1e3)}var locale$1;var timeFormat;var timeParse;var utcFormat;var utcParse;defaultLocale$1({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});function defaultLocale$1(definition){locale$1=formatLocale$1(definition);timeFormat=locale$1.format;timeParse=locale$1.parse;utcFormat=locale$1.utcFormat;utcParse=locale$1.utcParse;return locale$1}function memoize(method){var cache={};return function(spec){return cache[spec]||(cache[spec]=method(spec))}}function trimZeroes(numberFormat,decimalChar){return function(x){var str=numberFormat(x),dec=str.indexOf(decimalChar);if(dec<0)return str;var idx=rightmostDigit(str,dec);var end=idx<str.length?str.slice(idx):"";while(--idx>dec){if(str[idx]!=="0"){++idx;break}}return str.slice(0,idx)+end}}function rightmostDigit(str,dec){var i=str.lastIndexOf("e"),c;if(i>0)return i;for(i=str.length;--i>dec;){c=str.charCodeAt(i);if(c>=48&&c<=57)return i+1}}function numberLocale(locale){var format=memoize(locale.format),formatPrefix=locale.formatPrefix;return{format:format,formatPrefix:formatPrefix,formatFloat:function formatFloat(spec){var s=formatSpecifier(spec||",");if(s.precision==null){s.precision=12;switch(s.type){case"%":s.precision-=2;break;case"e":s.precision-=1;break}return trimZeroes(format(s),format(".1f")(1)[1])}else{return format(s)}},formatSpan:function formatSpan(start,stop,count,specifier){specifier=formatSpecifier(specifier==null?",f":specifier);var step=tickStep(start,stop,count),value=Math.max(Math.abs(start),Math.abs(stop));var precision;if(specifier.precision==null){switch(specifier.type){case"s":{if(!isNaN(precision=precisionPrefix(step,value))){specifier.precision=precision}return formatPrefix(specifier,value)}case"":case"e":case"g":case"p":case"r":{if(!isNaN(precision=precisionRound(step,value))){specifier.precision=precision-(specifier.type==="e")}break}case"f":case"%":{if(!isNaN(precision=precisionFixed(step))){specifier.precision=precision-(specifier.type==="%")*2}break}}}return format(specifier)}}}var defaultNumberLocale;resetNumberFormatDefaultLocale();function resetNumberFormatDefaultLocale(){return defaultNumberLocale=numberLocale({format:format$1,formatPrefix:formatPrefix})}function numberFormatLocale(definition){return numberLocale(formatLocale(definition))}function numberFormatDefaultLocale(definition){return arguments.length?defaultNumberLocale=numberFormatLocale(definition):defaultNumberLocale}function timeMultiFormat(format,interval,spec){spec=spec||{};if(!isObject(spec)){error("Invalid time multi-format specifier: ".concat(spec))}var second=interval(SECONDS),minute=interval(MINUTES),hour=interval(HOURS),day=interval(DATE),week=interval(WEEK),month=interval(MONTH),quarter=interval(QUARTER),year=interval(YEAR),L=format(spec[MILLISECONDS]||".%L"),S=format(spec[SECONDS]||":%S"),M=format(spec[MINUTES]||"%I:%M"),H=format(spec[HOURS]||"%I %p"),d=format(spec[DATE]||spec[DAY]||"%a %d"),w=format(spec[WEEK]||"%b %d"),m=format(spec[MONTH]||"%B"),q=format(spec[QUARTER]||"%B"),y=format(spec[YEAR]||"%Y");return function(date){return(second(date)<date?L:minute(date)<date?S:hour(date)<date?M:day(date)<date?H:month(date)<date?week(date)<date?d:w:year(date)<date?quarter(date)<date?m:q:y)(date)}}function timeLocale(locale){var _timeFormat=memoize(locale.format),_utcFormat=memoize(locale.utcFormat);return{timeFormat:function timeFormat(spec){return isString(spec)?_timeFormat(spec):timeMultiFormat(_timeFormat,timeInterval,spec)},utcFormat:function utcFormat(spec){return isString(spec)?_utcFormat(spec):timeMultiFormat(_utcFormat,utcInterval,spec)},timeParse:memoize(locale.parse),utcParse:memoize(locale.utcParse)}}var defaultTimeLocale;resetTimeFormatDefaultLocale();function resetTimeFormatDefaultLocale(){return defaultTimeLocale=timeLocale({format:timeFormat,parse:timeParse,utcFormat:utcFormat,utcParse:utcParse})}function timeFormatLocale(definition){return timeLocale(formatLocale$1(definition))}function timeFormatDefaultLocale(definition){return arguments.length?defaultTimeLocale=timeFormatLocale(definition):defaultTimeLocale}var createLocale=function createLocale(number,time){return extend({},number,time)};function locale$2(numberSpec,timeSpec){var number=numberSpec?numberFormatLocale(numberSpec):numberFormatDefaultLocale();var time=timeSpec?timeFormatLocale(timeSpec):timeFormatDefaultLocale();return createLocale(number,time)}function defaultLocale$2(numberSpec,timeSpec){var args=arguments.length;if(args&&args!==2){error("defaultLocale expects either zero or two arguments.")}return args?createLocale(numberFormatDefaultLocale(numberSpec),timeFormatDefaultLocale(timeSpec)):createLocale(numberFormatDefaultLocale(),timeFormatDefaultLocale())}function resetDefaultLocale(){resetNumberFormatDefaultLocale();resetTimeFormatDefaultLocale();return defaultLocale$2()}function read(data,schema,timeParser,utcParser){schema=schema||{};var reader=formats(schema.type||"json");if(!reader)error("Unknown data format type: "+schema.type);data=reader(data,schema);if(schema.parse)parse(data,schema.parse,timeParser,utcParser);if(_has(data,"columns"))delete data.columns;return data}function parse(data,types,timeParser,utcParser){if(!data.length)return;var locale=timeFormatDefaultLocale();timeParser=timeParser||locale.timeParse;utcParser=utcParser||locale.utcParse;var fields=data.columns||Object.keys(data[0]),datum,field,i,j,n,m;if(types==="auto")types=inferTypes(data,fields);fields=Object.keys(types);var parsers=fields.map((function(field){var type=types[field];var parts,pattern;if(type&&(type.startsWith("date:")||type.startsWith("utc:"))){parts=type.split(/:(.+)?/,2);pattern=parts[1];if(pattern[0]==="'"&&pattern[pattern.length-1]==="'"||pattern[0]==='"'&&pattern[pattern.length-1]==='"'){pattern=pattern.slice(1,-1)}var _parse=parts[0]==="utc"?utcParser:timeParser;return _parse(pattern)}if(!typeParsers[type]){throw Error("Illegal format pattern: "+field+":"+type)}return typeParsers[type]}));for(i=0,n=data.length,m=fields.length;i<n;++i){datum=data[i];for(j=0;j<m;++j){field=fields[j];datum[field]=parsers[j](datum[field])}}}var loader=loaderFactory(typeof fetch!=="undefined"&&fetch,null);function UniqueList(idFunc){var $=idFunc||identity,list=[],ids={};list.add=function(_){var id=$(_);if(!ids[id]){ids[id]=1;list.push(_)}return list};list.remove=function(_){var id=$(_);if(ids[id]){ids[id]=0;var idx=list.indexOf(_);if(idx>=0)list.splice(idx,1)}return list};return list}function asyncCallback(_x,_x2){return _asyncCallback.apply(this,arguments)}function _asyncCallback(){_asyncCallback=_asyncToGenerator(regeneratorRuntime.mark((function _callee(df,callback){return regeneratorRuntime.wrap((function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return callback(df);case 3:_context.next=8;break;case 5:_context.prev=5;_context.t0=_context["catch"](0);df.error(_context.t0);case 8:case"end":return _context.stop()}}}),_callee,null,[[0,5]])})));return _asyncCallback.apply(this,arguments)}var TUPLE_ID_KEY=Symbol("vega_id");var TUPLE_ID=1;function isTuple(t){return!!(t&&tupleid(t))}function tupleid(t){return t[TUPLE_ID_KEY]}function setid(t,id){t[TUPLE_ID_KEY]=id;return t}function ingest(datum){var t=datum===Object(datum)?datum:{data:datum};return tupleid(t)?t:setid(t,TUPLE_ID++)}function derive(t){return rederive(t,ingest({}))}function rederive(t,d){for(var k in t){d[k]=t[k]}return d}function replace(t,d){return setid(d,tupleid(t))}function stableCompare(cmp,f){return!cmp?null:f?function(a,b){return cmp(a,b)||tupleid(f(a))-tupleid(f(b))}:function(a,b){return cmp(a,b)||tupleid(a)-tupleid(b)}}function isChangeSet(v){return v&&v.constructor===changeset}function changeset(){var add=[],rem=[],mod=[],remp=[],modp=[];var _clean=null,_reflow=false;return{constructor:changeset,insert:function insert(t){var d=array(t),n=d.length;for(var i=0;i<n;++i){add.push(d[i])}return this},remove:function remove(t){var a=isFunction(t)?remp:rem,d=array(t),n=d.length;for(var i=0;i<n;++i){a.push(d[i])}return this},modify:function modify(t,field,value){var m={field:field,value:constant(value)};if(isFunction(t)){m.filter=t;modp.push(m)}else{m.tuple=t;mod.push(m)}return this},encode:function encode(t,set){if(isFunction(t))modp.push({filter:t,field:set});else mod.push({tuple:t,field:set});return this},clean:function clean(value){_clean=value;return this},reflow:function reflow(){_reflow=true;return this},pulse:function pulse(_pulse,tuples){var cur={},out={};var i,n,m,f,t,id;for(i=0,n=tuples.length;i<n;++i){cur[tupleid(tuples[i])]=1}for(i=0,n=rem.length;i<n;++i){t=rem[i];cur[tupleid(t)]=-1}for(i=0,n=remp.length;i<n;++i){f=remp[i];tuples.forEach((function(t){if(f(t))cur[tupleid(t)]=-1}))}for(i=0,n=add.length;i<n;++i){t=add[i];id=tupleid(t);if(cur[id]){cur[id]=1}else{_pulse.add.push(ingest(add[i]))}}for(i=0,n=tuples.length;i<n;++i){t=tuples[i];if(cur[tupleid(t)]<0)_pulse.rem.push(t)}function modify(t,f,v){if(v){t[f]=v(t)}else{_pulse.encode=f}if(!_reflow)out[tupleid(t)]=t}for(i=0,n=mod.length;i<n;++i){m=mod[i];t=m.tuple;f=m.field;id=cur[tupleid(t)];if(id>0){modify(t,f,m.value);_pulse.modifies(f)}}for(i=0,n=modp.length;i<n;++i){m=modp[i];f=m.filter;tuples.forEach((function(t){if(f(t)&&cur[tupleid(t)]>0){modify(t,m.field,m.value)}}));_pulse.modifies(m.field)}if(_reflow){_pulse.mod=rem.length||remp.length?tuples.filter((function(t){return cur[tupleid(t)]>0})):tuples.slice()}else{for(id in out){_pulse.mod.push(out[id])}}if(_clean||_clean==null&&(rem.length||remp.length)){_pulse.clean(true)}return _pulse}}}var CACHE="_:mod:_";function Parameters(){Object.defineProperty(this,CACHE,{writable:true,value:{}})}Parameters.prototype={set:function set(name,index,value,force){var o=this,v=o[name],mod=o[CACHE];if(index!=null&&index>=0){if(v[index]!==value||force){v[index]=value;mod[index+":"+name]=-1;mod[name]=-1}}else if(v!==value||force){o[name]=value;mod[name]=isArray(value)?1+value.length:-1}return o},modified:function modified(name,index){var mod=this[CACHE];if(!arguments.length){for(var k in mod){if(mod[k])return true}return false}else if(isArray(name)){for(var _k=0;_k<name.length;++_k){if(mod[name[_k]])return true}return false}return index!=null&&index>=0?index+1<mod[name]||!!mod[index+":"+name]:!!mod[name]},clear:function clear(){this[CACHE]={};return this}};var OP_ID=0;var PULSE="pulse",NO_PARAMS=new Parameters;var SKIP=1,MODIFIED=2;function Operator(init,update,params,react){this.id=++OP_ID;this.value=init;this.stamp=-1;this.rank=-1;this.qrank=-1;this.flags=0;if(update){this._update=update}if(params)this.parameters(params,react)}function flag(bit){return function(state){var f=this.flags;if(arguments.length===0)return!!(f&bit);this.flags=state?f|bit:f&~bit;return this}}Operator.prototype={targets:function targets(){return this._targets||(this._targets=UniqueList(id))},set:function set(value){if(this.value!==value){this.value=value;return 1}else{return 0}},skip:flag(SKIP),modified:flag(MODIFIED),parameters:function parameters(params,react,initonly){var _this=this;react=react!==false;var argval=this._argval=this._argval||new Parameters,argops=this._argops=this._argops||[],deps=[];var name,value,n,i;var add=function add(name,index,value){if(value instanceof Operator){if(value!==_this){if(react)value.targets().add(_this);deps.push(value)}argops.push({op:value,name:name,index:index})}else{argval.set(name,index,value)}};for(name in params){value=params[name];if(name===PULSE){array(value).forEach((function(op){if(!(op instanceof Operator)){error("Pulse parameters must be operator instances.")}else if(op!==_this){op.targets().add(_this);deps.push(op)}}));this.source=value}else if(isArray(value)){argval.set(name,-1,Array(n=value.length));for(i=0;i<n;++i){add(name,i,value[i])}}else{add(name,-1,value)}}this.marshall().clear();if(initonly)argops.initonly=true;return deps},marshall:function marshall(stamp){var argval=this._argval||NO_PARAMS,argops=this._argops;var item,i,op,mod;if(argops){var n=argops.length;for(i=0;i<n;++i){item=argops[i];op=item.op;mod=op.modified()&&op.stamp===stamp;argval.set(item.name,item.index,op.value,mod)}if(argops.initonly){for(i=0;i<n;++i){item=argops[i];item.op.targets().remove(this)}this._argops=null;this._update=null}}return argval},detach:function detach(){var argops=this._argops;var i,n,item,op;if(argops){for(i=0,n=argops.length;i<n;++i){item=argops[i];op=item.op;if(op._targets){op._targets.remove(this)}}}},evaluate:function evaluate(pulse){var update=this._update;if(update){var params=this.marshall(pulse.stamp),v=update.call(this,params,pulse);params.clear();if(v!==this.value){this.value=v}else if(!this.modified()){return pulse.StopPropagation}}},run:function run(pulse){if(pulse.stamp<this.stamp)return pulse.StopPropagation;var rv;if(this.skip()){this.skip(false);rv=0}else{rv=this.evaluate(pulse)}return this.pulse=rv||pulse}};function add(init,update,params,react){var shift=1,op;if(init instanceof Operator){op=init}else if(init&&init.prototype instanceof Operator){op=new init}else if(isFunction(init)){op=new Operator(null,init)}else{shift=0;op=new Operator(init,update)}this.rank(op);if(shift){react=params;params=update}if(params)this.connect(op,op.parameters(params,react));this.touch(op);return op}function connect(target,sources){var targetRank=target.rank,n=sources.length;for(var i=0;i<n;++i){if(targetRank<sources[i].rank){this.rerank(target);return}}}var STREAM_ID=0;function EventStream(filter,apply,receive){this.id=++STREAM_ID;this.value=null;if(receive)this.receive=receive;if(filter)this._filter=filter;if(apply)this._apply=apply}function stream(filter,apply,receive){return new EventStream(filter,apply,receive)}EventStream.prototype={_filter:truthy,_apply:identity,targets:function targets(){return this._targets||(this._targets=UniqueList(id))},consume:function consume(_){if(!arguments.length)return!!this._consume;this._consume=!!_;return this},receive:function receive(evt){if(this._filter(evt)){var val=this.value=this._apply(evt),trg=this._targets,n=trg?trg.length:0;for(var i=0;i<n;++i){trg[i].receive(val)}if(this._consume){evt.preventDefault();evt.stopPropagation()}}},filter:function filter(_filter){var s=stream(_filter);this.targets().add(s);return s},apply:function apply(_apply){var s=stream(null,_apply);this.targets().add(s);return s},merge:function merge(){var s=stream();this.targets().add(s);for(var i=0,n=arguments.length;i<n;++i){arguments[i].targets().add(s)}return s},throttle:function throttle(pause){var t=-1;return this.filter((function(){var now=Date.now();if(now-t>pause){t=now;return 1}else{return 0}}))},debounce:function debounce$1(delay){var s=stream();this.targets().add(stream(null,null,debounce(delay,(function(e){var df=e.dataflow;s.receive(e);if(df&&df.run)df.run()}))));return s},between:function between(a,b){var active=false;a.targets().add(stream(null,null,(function(){return active=true})));b.targets().add(stream(null,null,(function(){return active=false})));return this.filter((function(){return active}))},detach:function detach(){}};function events(source,type,filter,apply){var df=this,s=stream(filter,apply),send=function send(e){e.dataflow=df;try{s.receive(e)}catch(error){df.error(error)}finally{df.run()}};var sources;if(typeof source==="string"&&typeof document!=="undefined"){sources=document.querySelectorAll(source)}else{sources=array(source)}var n=sources.length;for(var i=0;i<n;++i){sources[i].addEventListener(type,send)}return s}function parse$1(data,format){var locale=this.locale();return read(data,format,locale.timeParse,locale.utcParse)}function ingest$1(target,data,format){data=this.parse(data,format);return this.pulse(target,this.changeset().insert(data))}function request(_x3,_x4){return _request.apply(this,arguments)}function _request(){_request=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(url,format){var df,status,data;return regeneratorRuntime.wrap((function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:df=this;status=0;_context2.prev=2;_context2.next=5;return df.loader().load(url,{context:"dataflow",response:responseType(format&&format.type)});case 5:data=_context2.sent;try{data=df.parse(data,format)}catch(err){status=-2;df.warn("Data ingestion failed",url,err)}_context2.next=13;break;case 9:_context2.prev=9;_context2.t0=_context2["catch"](2);status=-1;df.warn("Loading failed",url,_context2.t0);case 13:return _context2.abrupt("return",{data:data,status:status});case 14:case"end":return _context2.stop()}}}),_callee2,this,[[2,9]])})));return _request.apply(this,arguments)}function preload(_x5,_x6,_x7){return _preload.apply(this,arguments)}function _preload(){_preload=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(target,url,format){var df,pending,res;return regeneratorRuntime.wrap((function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:df=this,pending=df._pending||loadPending(df);pending.requests+=1;_context3.next=4;return df.request(url,format);case 4:res=_context3.sent;df.pulse(target,df.changeset().remove(truthy).insert(res.data||[]));pending.done();return _context3.abrupt("return",res);case 8:case"end":return _context3.stop()}}}),_callee3,this)})));return _preload.apply(this,arguments)}function loadPending(df){var accept;var pending=new Promise((function(a){return accept=a}));pending.requests=0;pending.done=function(){if(--pending.requests===0){df._pending=null;accept(df)}};return df._pending=pending}var SKIP$1={skip:true};function on(source,target,update,params,options){var fn=source instanceof Operator?onOperator:onStream;fn(this,source,target,update,params,options);return this}function onStream(df,stream,target,update,params,options){var opt=extend({},options,SKIP$1);var func,op;if(!isFunction(target))target=constant(target);if(update===undefined){func=function func(e){return df.touch(target(e))}}else if(isFunction(update)){op=new Operator(null,update,params,false);func=function func(e){op.evaluate(e);var t=target(e),v=op.value;isChangeSet(v)?df.pulse(t,v,options):df.update(t,v,opt)}}else{func=function func(e){return df.update(target(e),update,opt)}}stream.apply(func)}function onOperator(df,source,target,update,params,options){if(update===undefined){source.targets().add(target)}else{var opt=options||{},op=new Operator(null,updater(target,update),params,false);op.modified(opt.force);op.rank=source.rank;source.targets().add(op);if(target){op.skip(true);op.value=target.value;op.targets().add(target);df.connect(target,[op])}}}function updater(target,update){update=isFunction(update)?update:constant(update);return target?function(_,pulse){var value=update(_,pulse);if(!target.skip()){target.skip(value!==this.value).value=value}return value}:update}function rank(op){op.rank=++this._rank}function rerank(op){var queue=[op];var cur,list,i;while(queue.length){this.rank(cur=queue.pop());if(list=cur._targets){for(i=list.length;--i>=0;){queue.push(cur=list[i]);if(cur===op)error("Cycle detected in dataflow graph.")}}}}var StopPropagation={};var ADD=1<<0,REM=1<<1,MOD=1<<2,ADD_REM=ADD|REM,ADD_MOD=ADD|MOD,ALL=ADD|REM|MOD,REFLOW=1<<3,SOURCE=1<<4,NO_SOURCE=1<<5,NO_FIELDS=1<<6;function Pulse(dataflow,stamp,encode){this.dataflow=dataflow;this.stamp=stamp==null?-1:stamp;this.add=[];this.rem=[];this.mod=[];this.fields=null;this.encode=encode||null}function _materialize(data,filter){var out=[];visitArray(data,filter,(function(_){return out.push(_)}));return out}function filter(pulse,flags){var map={};pulse.visit(flags,(function(t){map[tupleid(t)]=1}));return function(t){return map[tupleid(t)]?null:t}}function addFilter(a,b){return a?function(t,i){return a(t,i)&&b(t,i)}:b}Pulse.prototype={StopPropagation:StopPropagation,ADD:ADD,REM:REM,MOD:MOD,ADD_REM:ADD_REM,ADD_MOD:ADD_MOD,ALL:ALL,REFLOW:REFLOW,SOURCE:SOURCE,NO_SOURCE:NO_SOURCE,NO_FIELDS:NO_FIELDS,fork:function fork(flags){return new Pulse(this.dataflow).init(this,flags)},clone:function clone(){var p=this.fork(ALL);p.add=p.add.slice();p.rem=p.rem.slice();p.mod=p.mod.slice();if(p.source)p.source=p.source.slice();return p.materialize(ALL|SOURCE)},addAll:function addAll(){var p=this;var reuse=!p.source||p.add===p.rem||!p.rem.length&&p.source.length===p.add.length;if(reuse){return p}else{p=new Pulse(this.dataflow).init(this);p.add=p.source;p.rem=[];return p}},init:function init(src,flags){var p=this;p.stamp=src.stamp;p.encode=src.encode;if(src.fields&&!(flags&NO_FIELDS)){p.fields=src.fields}if(flags&ADD){p.addF=src.addF;p.add=src.add}else{p.addF=null;p.add=[]}if(flags&REM){p.remF=src.remF;p.rem=src.rem}else{p.remF=null;p.rem=[]}if(flags&MOD){p.modF=src.modF;p.mod=src.mod}else{p.modF=null;p.mod=[]}if(flags&NO_SOURCE){p.srcF=null;p.source=null}else{p.srcF=src.srcF;p.source=src.source;if(src.cleans)p.cleans=src.cleans}return p},runAfter:function runAfter(func){this.dataflow.runAfter(func)},changed:function changed(flags){var f=flags||ALL;return f&ADD&&this.add.length||f&REM&&this.rem.length||f&MOD&&this.mod.length},reflow:function reflow(fork){if(fork)return this.fork(ALL).reflow();var len=this.add.length,src=this.source&&this.source.length;if(src&&src!==len){this.mod=this.source;if(len)this.filter(MOD,filter(this,ADD))}return this},clean:function clean(value){if(arguments.length){this.cleans=!!value;return this}else{return this.cleans}},modifies:function modifies(_){var hash=this.fields||(this.fields={});if(isArray(_)){_.forEach((function(f){return hash[f]=true}))}else{hash[_]=true}return this},modified:function modified(_,nomod){var fields=this.fields;return!((nomod||this.mod.length)&&fields)?false:!arguments.length?!!fields:isArray(_)?_.some((function(f){return fields[f]})):fields[_]},filter:function filter(flags,_filter2){var p=this;if(flags&ADD)p.addF=addFilter(p.addF,_filter2);if(flags&REM)p.remF=addFilter(p.remF,_filter2);if(flags&MOD)p.modF=addFilter(p.modF,_filter2);if(flags&SOURCE)p.srcF=addFilter(p.srcF,_filter2);return p},materialize:function materialize(flags){flags=flags||ALL;var p=this;if(flags&ADD&&p.addF){p.add=_materialize(p.add,p.addF);p.addF=null}if(flags&REM&&p.remF){p.rem=_materialize(p.rem,p.remF);p.remF=null}if(flags&MOD&&p.modF){p.mod=_materialize(p.mod,p.modF);p.modF=null}if(flags&SOURCE&&p.srcF){p.source=p.source.filter(p.srcF);p.srcF=null}return p},visit:function visit(flags,visitor){var p=this,v=visitor;if(flags&SOURCE){visitArray(p.source,p.srcF,v);return p}if(flags&ADD)visitArray(p.add,p.addF,v);if(flags&REM)visitArray(p.rem,p.remF,v);if(flags&MOD)visitArray(p.mod,p.modF,v);var src=p.source;if(flags&REFLOW&&src){var sum=p.add.length+p.mod.length;if(sum===src.length);else if(sum){visitArray(src,filter(p,ADD_MOD),v)}else{visitArray(src,p.srcF,v)}}return p}};function MultiPulse(dataflow,stamp,pulses,encode){var p=this,n=pulses.length;var c=0;this.dataflow=dataflow;this.stamp=stamp;this.fields=null;this.encode=encode||null;this.pulses=pulses;for(var i=0;i<n;++i){var _pulse2=pulses[i];if(_pulse2.stamp!==stamp)continue;if(_pulse2.fields){var hash=p.fields||(p.fields={});for(var f in _pulse2.fields){hash[f]=1}}if(_pulse2.changed(p.ADD))c|=p.ADD;if(_pulse2.changed(p.REM))c|=p.REM;if(_pulse2.changed(p.MOD))c|=p.MOD}this.changes=c}inherits(MultiPulse,Pulse,{fork:function fork(flags){var p=new Pulse(this.dataflow).init(this,flags&this.NO_FIELDS);if(flags!==undefined){if(flags&p.ADD)this.visit(p.ADD,(function(t){return p.add.push(t)}));if(flags&p.REM)this.visit(p.REM,(function(t){return p.rem.push(t)}));if(flags&p.MOD)this.visit(p.MOD,(function(t){return p.mod.push(t)}))}return p},changed:function changed(flags){return this.changes&flags},modified:function modified(_){var p=this,fields=p.fields;return!(fields&&p.changes&p.MOD)?0:isArray(_)?_.some((function(f){return fields[f]})):fields[_]},filter:function filter(){error("MultiPulse does not support filtering.")},materialize:function materialize(){error("MultiPulse does not support materialization.")},visit:function visit(flags,visitor){var p=this,pulses=p.pulses,n=pulses.length;var i=0;if(flags&p.SOURCE){for(;i<n;++i){pulses[i].visit(flags,visitor)}}else{for(;i<n;++i){if(pulses[i].stamp===p.stamp){pulses[i].visit(flags,visitor)}}}return p}});function evaluate(_x8,_x9,_x10){return _evaluate.apply(this,arguments)}function _evaluate(){_evaluate=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(encode,prerun,postrun){var df,async,stamp,count,op,next,error,pr,i;return regeneratorRuntime.wrap((function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:df=this,async=[];if(!df._pulse){_context4.next=3;break}return _context4.abrupt("return",reentrant(df));case 3:if(!df._pending){_context4.next=6;break}_context4.next=6;return df._pending;case 6:if(!prerun){_context4.next=9;break}_context4.next=9;return asyncCallback(df,prerun);case 9:if(df._touched.length){_context4.next=12;break}df.debug("Dataflow invoked, but nothing to do.");return _context4.abrupt("return",df);case 12:stamp=++df._clock;df._pulse=new Pulse(df,stamp,encode);df._touched.forEach((function(op){return df._enqueue(op,true)}));df._touched=UniqueList(id);count=0;_context4.prev=17;case 18:if(!(df._heap.size()>0)){_context4.next=35;break}op=df._heap.pop();if(!(op.rank!==op.qrank)){_context4.next=23;break}df._enqueue(op,true);return _context4.abrupt("continue",18);case 23:next=op.run(df._getPulse(op,encode));if(!next.then){_context4.next=30;break}_context4.next=27;return next;case 27:next=_context4.sent;_context4.next=31;break;case 30:if(next.async){async.push(next.async);next=StopPropagation}case 31:if(next!==StopPropagation){if(op._targets)op._targets.forEach((function(op){return df._enqueue(op)}))}++count;_context4.next=18;break;case 35:_context4.next=41;break;case 37:_context4.prev=37;_context4.t0=_context4["catch"](17);df._heap.clear();error=_context4.t0;case 41:df._input={};df._pulse=null;df.debug("Pulse ".concat(stamp,": ").concat(count," operators"));if(error){df._postrun=[];df.error(error)}if(!df._postrun.length){_context4.next=55;break}pr=df._postrun.sort((function(a,b){return b.priority-a.priority}));df._postrun=[];i=0;case 49:if(!(i<pr.length)){_context4.next=55;break}_context4.next=52;return asyncCallback(df,pr[i].callback);case 52:++i;_context4.next=49;break;case 55:if(!postrun){_context4.next=58;break}_context4.next=58;return asyncCallback(df,postrun);case 58:if(async.length){Promise.all(async).then((function(cb){return df.runAsync(null,(function(){cb.forEach((function(f){try{f(df)}catch(err){df.error(err)}}))}))}))}return _context4.abrupt("return",df);case 60:case"end":return _context4.stop()}}}),_callee4,this,[[17,37]])})));return _evaluate.apply(this,arguments)}function runAsync(_x11,_x12,_x13){return _runAsync.apply(this,arguments)}function _runAsync(){_runAsync=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(encode,prerun,postrun){var _this3=this;var clear;return regeneratorRuntime.wrap((function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!this._running){_context5.next=5;break}_context5.next=3;return this._running;case 3:_context5.next=0;break;case 5:clear=function clear(){return _this3._running=null};(this._running=this.evaluate(encode,prerun,postrun)).then(clear,clear);return _context5.abrupt("return",this._running);case 8:case"end":return _context5.stop()}}}),_callee5,this)})));return _runAsync.apply(this,arguments)}function run(encode,prerun,postrun){return this._pulse?reentrant(this):(this.evaluate(encode,prerun,postrun),this)}function runAfter(callback,enqueue,priority){if(this._pulse||enqueue){this._postrun.push({priority:priority||0,callback:callback})}else{try{callback(this)}catch(err){this.error(err)}}}function reentrant(df){df.error("Dataflow already running. Use runAsync() to chain invocations.");return df}function enqueue(op,force){var q=op.stamp<this._clock;if(q)op.stamp=this._clock;if(q||force){op.qrank=op.rank;this._heap.push(op)}}function getPulse(op,encode){var s=op.source,stamp=this._clock;return s&&isArray(s)?new MultiPulse(this,stamp,s.map((function(_){return _.pulse})),encode):this._input[op.id]||singlePulse(this._pulse,s&&s.pulse)}function singlePulse(p,s){if(s&&s.stamp===p.stamp){return s}p=p.fork();if(s&&s!==StopPropagation){p.source=s.source}return p}var NO_OPT={skip:false,force:false};function touch(op,options){var opt=options||NO_OPT;if(this._pulse){this._enqueue(op)}else{this._touched.add(op)}if(opt.skip)op.skip(true);return this}function update(op,value,options){var opt=options||NO_OPT;if(op.set(value)||opt.force){this.touch(op,opt)}return this}function pulse(op,changeset,options){this.touch(op,options||NO_OPT);var p=new Pulse(this,this._clock+(this._pulse?0:1)),t=op.pulse&&op.pulse.source||[];p.target=op;this._input[op.id]=changeset.pulse(p,t);return this}function Heap(cmp){var nodes=[];return{clear:function clear(){return nodes=[]},size:function size(){return nodes.length},peek:function peek(){return nodes[0]},push:function push(x){nodes.push(x);return siftdown(nodes,0,nodes.length-1,cmp)},pop:function pop(){var last=nodes.pop();var item;if(nodes.length){item=nodes[0];nodes[0]=last;siftup(nodes,0,cmp)}else{item=last}return item}}}function siftdown(array,start,idx,cmp){var parent,pidx;var item=array[idx];while(idx>start){pidx=idx-1>>1;parent=array[pidx];if(cmp(item,parent)<0){array[idx]=parent;idx=pidx;continue}break}return array[idx]=item}function siftup(array,idx,cmp){var start=idx,end=array.length,item=array[idx];var cidx=(idx<<1)+1,ridx;while(cidx<end){ridx=cidx+1;if(ridx<end&&cmp(array[cidx],array[ridx])>=0){cidx=ridx}array[idx]=array[cidx];idx=cidx;cidx=(idx<<1)+1}array[idx]=item;return siftdown(array,start,idx,cmp)}function Dataflow(){this.logger(logger());this.logLevel(Error$1);this._clock=0;this._rank=0;this._locale=defaultLocale$2();try{this._loader=loader()}catch(e){}this._touched=UniqueList(id);this._input={};this._pulse=null;this._heap=Heap((function(a,b){return a.qrank-b.qrank}));this._postrun=[]}function logMethod(method){return function(){return this._log[method].apply(this,arguments)}}Dataflow.prototype={stamp:function stamp(){return this._clock},loader:function loader(_){if(arguments.length){this._loader=_;return this}else{return this._loader}},locale:function locale(_){if(arguments.length){this._locale=_;return this}else{return this._locale}},logger:function logger(_logger){if(arguments.length){this._log=_logger;return this}else{return this._log}},error:logMethod("error"),warn:logMethod("warn"),info:logMethod("info"),debug:logMethod("debug"),logLevel:logMethod("level"),cleanThreshold:1e4,add:add,connect:connect,rank:rank,rerank:rerank,pulse:pulse,touch:touch,update:update,changeset:changeset,ingest:ingest$1,parse:parse$1,preload:preload,request:request,events:events,on:on,evaluate:evaluate,run:run,runAsync:runAsync,runAfter:runAfter,_enqueue:enqueue,_getPulse:getPulse};function Transform(init,params){Operator.call(this,init,null,params)}inherits(Transform,Operator,{run:function run(pulse){var _this2=this;if(pulse.stamp<this.stamp)return pulse.StopPropagation;var rv;if(this.skip()){this.skip(false)}else{rv=this.evaluate(pulse)}rv=rv||pulse;if(rv.then){rv=rv.then((function(_){return _this2.pulse=_}))}else if(rv!==pulse.StopPropagation){this.pulse=rv}return rv},evaluate:function evaluate(pulse){var params=this.marshall(pulse.stamp),out=this.transform(params,pulse);params.clear();return out},transform:function transform(){}});var transforms={};function definition(type){var t=transform$1(type);return t&&t.Definition||null}function transform$1(type){type=type&&type.toLowerCase();return _has(transforms,type)?transforms[type]:null}var _marked$2=regeneratorRuntime.mark(numbers$1);function numbers$1(values,valueof){var _iterator,_step,value,index,_iterator2,_step2,_value;return regeneratorRuntime.wrap((function numbers$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(valueof==null)){_context.next=21;break}_iterator=_createForOfIteratorHelper(values);_context.prev=2;_iterator.s();case 4:if((_step=_iterator.n()).done){_context.next=11;break}value=_step.value;if(!(value!=null&&value!==""&&(value=+value)>=value)){_context.next=9;break}_context.next=9;return value;case 9:_context.next=4;break;case 11:_context.next=16;break;case 13:_context.prev=13;_context.t0=_context["catch"](2);_iterator.e(_context.t0);case 16:_context.prev=16;_iterator.f();return _context.finish(16);case 19:_context.next=41;break;case 21:index=-1;_iterator2=_createForOfIteratorHelper(values);_context.prev=23;_iterator2.s();case 25:if((_step2=_iterator2.n()).done){_context.next=33;break}_value=_step2.value;_value=valueof(_value,++index,values);if(!(_value!=null&&_value!==""&&(_value=+_value)>=_value)){_context.next=31;break}_context.next=31;return _value;case 31:_context.next=25;break;case 33:_context.next=38;break;case 35:_context.prev=35;_context.t1=_context["catch"](23);_iterator2.e(_context.t1);case 38:_context.prev=38;_iterator2.f();return _context.finish(38);case 41:case"end":return _context.stop()}}}),_marked$2,null,[[2,13,16,19],[23,35,38,41]])}function quantiles(array,p,f){var values=Float64Array.from(numbers$1(array,f));values.sort(ascending$1);return p.map((function(_){return quantileSorted(values,_)}))}function quartiles(array,f){return quantiles(array,[.25,.5,.75],f)}function estimateBandwidth(array,f){var n=array.length,d=deviation(array,f),q=quartiles(array,f),h=(q[2]-q[0])/1.34,v=Math.min(d,h)||d||Math.abs(q[0])||1;return 1.06*v*Math.pow(n,-.2)}function bin$1(_){var maxb=_.maxbins||20,base=_.base||10,logb=Math.log(base),div=_.divide||[5,2];var min=_.extent[0],max=_.extent[1],step,level,minstep,v,i,n;var span=_.span||max-min||Math.abs(min)||1;if(_.step){step=_.step}else if(_.steps){v=span/maxb;for(i=0,n=_.steps.length;i<n&&_.steps[i]<v;++i){}step=_.steps[Math.max(0,i-1)]}else{level=Math.ceil(Math.log(maxb)/logb);minstep=_.minstep||0;step=Math.max(minstep,Math.pow(base,Math.round(Math.log(span)/logb)-level));while(Math.ceil(span/step)>maxb){step*=base}for(i=0,n=div.length;i<n;++i){v=step/div[i];if(v>=minstep&&span/v<=maxb)step=v}}v=Math.log(step);var precision=v>=0?0:~~(-v/logb)+1,eps=Math.pow(base,-precision-1);if(_.nice||_.nice===undefined){v=Math.floor(min/step+eps)*step;min=min<v?v-step:v;max=Math.ceil(max/step)*step}return{start:min,stop:max===min?min+step:max,step:step}}exports.random=Math.random;function setRandom(r){exports.random=r}function bootstrapCI(array,samples,alpha,f){if(!array.length)return[undefined,undefined];var values=Float64Array.from(numbers$1(array,f)),n=values.length,m=samples;var a,i,j,mu;for(j=0,mu=Array(m);j<m;++j){for(a=0,i=0;i<n;++i){a+=values[~~(exports.random()*n)]}mu[j]=a/n}mu.sort(ascending$1);return[quantile(mu,alpha/2),quantile(mu,1-alpha/2)]}function dotbin(array,step,smooth,f){f=f||function(_){return _};var n=array.length,v=new Float64Array(n);var i=0,j=1,a=f(array[0]),b=a,w=a+step,x;for(;j<n;++j){x=f(array[j]);if(x>=w){b=(a+b)/2;for(;i<j;++i){v[i]=b}w=x+step;a=x}b=x}b=(a+b)/2;for(;i<j;++i){v[i]=b}return smooth?smoothing(v,step+step/4):v}function smoothing(v,thresh){var n=v.length;var a=0,b=1,c,d;while(v[a]===v[b]){++b}while(b<n){c=b+1;while(v[b]===v[c]){++c}if(v[b]-v[b-1]<thresh){d=b+(a+c-b-b>>1);while(d<b){v[d++]=v[b]}while(d>b){v[d--]=v[a]}}a=b;b=c}return v}function lcg(seed){return function(){seed=(1103515245*seed+12345)%2147483647;return seed/2147483647}}function integer(min,max){if(max==null){max=min;min=0}var a,b,d;var dist={min:function min(_){if(arguments.length){a=_||0;d=b-a;return dist}else{return a}},max:function max(_){if(arguments.length){b=_||0;d=b-a;return dist}else{return b}},sample:function sample(){return a+Math.floor(d*exports.random())},pdf:function pdf(x){return x===Math.floor(x)&&x>=a&&x<b?1/d:0},cdf:function cdf(x){var v=Math.floor(x);return v<a?0:v>=b?1:(v-a+1)/d},icdf:function icdf(p){return p>=0&&p<=1?a-1+Math.floor(p*d):NaN}};return dist.min(min).max(max)}var SQRT2PI=Math.sqrt(2*Math.PI);var SQRT2=Math.SQRT2;var nextSample=NaN;function sampleNormal(mean,stdev){mean=mean||0;stdev=stdev==null?1:stdev;var x=0,y=0,rds,c;if(nextSample===nextSample){x=nextSample;nextSample=NaN}else{do{x=exports.random()*2-1;y=exports.random()*2-1;rds=x*x+y*y}while(rds===0||rds>1);c=Math.sqrt(-2*Math.log(rds)/rds);x*=c;nextSample=y*c}return mean+x*stdev}function densityNormal(value,mean,stdev){stdev=stdev==null?1:stdev;var z=(value-(mean||0))/stdev;return Math.exp(-.5*z*z)/(stdev*SQRT2PI)}function cumulativeNormal(value,mean,stdev){mean=mean||0;stdev=stdev==null?1:stdev;var z=(value-mean)/stdev,Z=Math.abs(z);var cd;if(Z>37){cd=0}else{var _exp=Math.exp(-Z*Z/2);var sum;if(Z<7.07106781186547){sum=.0352624965998911*Z+.700383064443688;sum=sum*Z+6.37396220353165;sum=sum*Z+33.912866078383;sum=sum*Z+112.079291497871;sum=sum*Z+221.213596169931;sum=sum*Z+220.206867912376;cd=_exp*sum;sum=.0883883476483184*Z+1.75566716318264;sum=sum*Z+16.064177579207;sum=sum*Z+86.7807322029461;sum=sum*Z+296.564248779674;sum=sum*Z+637.333633378831;sum=sum*Z+793.826512519948;sum=sum*Z+440.413735824752;cd=cd/sum}else{sum=Z+.65;sum=Z+4/sum;sum=Z+3/sum;sum=Z+2/sum;sum=Z+1/sum;cd=_exp/sum/2.506628274631}}return z>0?1-cd:cd}function quantileNormal(p,mean,stdev){if(p<0||p>1)return NaN;return(mean||0)+(stdev==null?1:stdev)*SQRT2*erfinv(2*p-1)}function erfinv(x){var w=-Math.log((1-x)*(1+x)),p;if(w<6.25){w-=3.125;p=-364441206401782e-35;p=-16850591381820166e-35+p*w;p=128584807152564e-32+p*w;p=11157877678025181e-33+p*w;p=-1333171662854621e-31+p*w;p=20972767875968562e-33+p*w;p=6637638134358324e-30+p*w;p=-4054566272975207e-29+p*w;p=-8151934197605472e-29+p*w;p=26335093153082323e-28+p*w;p=-12975133253453532e-27+p*w;p=-5415412054294628e-26+p*w;p=1.0512122733215323e-9+p*w;p=-4.112633980346984e-9+p*w;p=-2.9070369957882005e-8+p*w;p=4.2347877827932404e-7+p*w;p=-13654692000834679e-22+p*w;p=-13882523362786469e-21+p*w;p=.00018673420803405714+p*w;p=-.000740702534166267+p*w;p=-.006033670871430149+p*w;p=.24015818242558962+p*w;p=1.6536545626831027+p*w}else if(w<16){w=Math.sqrt(w)-3.25;p=2.2137376921775787e-9;p=9.075656193888539e-8+p*w;p=-2.7517406297064545e-7+p*w;p=1.8239629214389228e-8+p*w;p=15027403968909828e-22+p*w;p=-4013867526981546e-21+p*w;p=29234449089955446e-22+p*w;p=12475304481671779e-21+p*w;p=-47318229009055734e-21+p*w;p=6828485145957318e-20+p*w;p=24031110387097894e-21+p*w;p=-.0003550375203628475+p*w;p=.0009532893797373805+p*w;p=-.0016882755560235047+p*w;p=.002491442096107851+p*w;p=-.003751208507569241+p*w;p=.005370914553590064+p*w;p=1.0052589676941592+p*w;p=3.0838856104922208+p*w}else if(Number.isFinite(w)){w=Math.sqrt(w)-5;p=-27109920616438573e-27;p=-2.555641816996525e-10+p*w;p=1.5076572693500548e-9+p*w;p=-3.789465440126737e-9+p*w;p=7.61570120807834e-9+p*w;p=-1.496002662714924e-8+p*w;p=2.914795345090108e-8+p*w;p=-6.771199775845234e-8+p*w;p=2.2900482228026655e-7+p*w;p=-9.9298272942317e-7+p*w;p=4526062597223154e-21+p*w;p=-1968177810553167e-20+p*w;p=7599527703001776e-20+p*w;p=-.00021503011930044477+p*w;p=-.00013871931833623122+p*w;p=1.0103004648645344+p*w;p=4.849906401408584+p*w}else{p=Infinity}return p*x}function gaussian(mean,stdev){var mu,sigma;var dist={mean:function mean(_){if(arguments.length){mu=_||0;return dist}else{return mu}},stdev:function stdev(_){if(arguments.length){sigma=_==null?1:_;return dist}else{return sigma}},sample:function sample(){return sampleNormal(mu,sigma)},pdf:function pdf(value){return densityNormal(value,mu,sigma)},cdf:function cdf(value){return cumulativeNormal(value,mu,sigma)},icdf:function icdf(p){return quantileNormal(p,mu,sigma)}};return dist.mean(mean).stdev(stdev)}function kde(support,_bandwidth){var kernel=gaussian();var n=0;var dist={data:function data(_){if(arguments.length){support=_;n=_?_.length:0;return dist.bandwidth(_bandwidth)}else{return support}},bandwidth:function bandwidth(_){if(!arguments.length)return _bandwidth;_bandwidth=_;if(!_bandwidth&&support)_bandwidth=estimateBandwidth(support);return dist},sample:function sample(){return support[~~(exports.random()*n)]+_bandwidth*kernel.sample()},pdf:function pdf(x){var y=0,i=0;for(;i<n;++i){y+=kernel.pdf((x-support[i])/_bandwidth)}return y/_bandwidth/n},cdf:function cdf(x){var y=0,i=0;for(;i<n;++i){y+=kernel.cdf((x-support[i])/_bandwidth)}return y/n},icdf:function icdf(){throw Error("KDE icdf not supported.")}};return dist.data(support)}function sampleLogNormal(mean,stdev){mean=mean||0;stdev=stdev==null?1:stdev;return Math.exp(mean+sampleNormal()*stdev)}function densityLogNormal(value,mean,stdev){if(value<=0)return 0;mean=mean||0;stdev=stdev==null?1:stdev;var z=(Math.log(value)-mean)/stdev;return Math.exp(-.5*z*z)/(stdev*SQRT2PI*value)}function cumulativeLogNormal(value,mean,stdev){return cumulativeNormal(Math.log(value),mean,stdev)}function quantileLogNormal(p,mean,stdev){return Math.exp(quantileNormal(p,mean,stdev))}function lognormal(mean,stdev){var mu,sigma;var dist={mean:function mean(_){if(arguments.length){mu=_||0;return dist}else{return mu}},stdev:function stdev(_){if(arguments.length){sigma=_==null?1:_;return dist}else{return sigma}},sample:function sample(){return sampleLogNormal(mu,sigma)},pdf:function pdf(value){return densityLogNormal(value,mu,sigma)},cdf:function cdf(value){return cumulativeLogNormal(value,mu,sigma)},icdf:function icdf(p){return quantileLogNormal(p,mu,sigma)}};return dist.mean(mean).stdev(stdev)}function mixture(dists,_weights){var m=0,w;function normalize(x){var w=[];var sum=0,i;for(i=0;i<m;++i){sum+=w[i]=x[i]==null?1:+x[i]}for(i=0;i<m;++i){w[i]/=sum}return w}var dist={weights:function weights(_){if(arguments.length){w=normalize(_weights=_||[]);return dist}return _weights},distributions:function distributions(_){if(arguments.length){if(_){m=_.length;dists=_}else{m=0;dists=[]}return dist.weights(_weights)}return dists},sample:function sample(){var r=exports.random();var d=dists[m-1],v=w[0],i=0;for(;i<m-1;v+=w[++i]){if(r<v){d=dists[i];break}}return d.sample()},pdf:function pdf(x){var p=0,i=0;for(;i<m;++i){p+=w[i]*dists[i].pdf(x)}return p},cdf:function cdf(x){var p=0,i=0;for(;i<m;++i){p+=w[i]*dists[i].cdf(x)}return p},icdf:function icdf(){throw Error("Mixture icdf not supported.")}};return dist.distributions(dists).weights(_weights)}function sampleUniform(min,max){if(max==null){max=min==null?1:min;min=0}return min+(max-min)*exports.random()}function densityUniform(value,min,max){if(max==null){max=min==null?1:min;min=0}return value>=min&&value<=max?1/(max-min):0}function cumulativeUniform(value,min,max){if(max==null){max=min==null?1:min;min=0}return value<min?0:value>max?1:(value-min)/(max-min)}function quantileUniform(p,min,max){if(max==null){max=min==null?1:min;min=0}return p>=0&&p<=1?min+p*(max-min):NaN}function uniform(min,max){var a,b;var dist={min:function min(_){if(arguments.length){a=_||0;return dist}else{return a}},max:function max(_){if(arguments.length){b=_==null?1:_;return dist}else{return b}},sample:function sample(){return sampleUniform(a,b)},pdf:function pdf(value){return densityUniform(value,a,b)},cdf:function cdf(value){return cumulativeUniform(value,a,b)},icdf:function icdf(p){return quantileUniform(p,a,b)}};if(max==null){max=min==null?1:min;min=0}return dist.min(min).max(max)}function ols(uX,uY,uXY,uX2){var delta=uX2-uX*uX,slope=Math.abs(delta)<1e-24?0:(uXY-uX*uY)/delta,intercept=uY-slope*uX;return[intercept,slope]}function points(data,x,y,sort){data=data.filter((function(d){var u=x(d),v=y(d);return u!=null&&(u=+u)>=u&&v!=null&&(v=+v)>=v}));if(sort){data.sort((function(a,b){return x(a)-x(b)}))}var n=data.length,X=new Float64Array(n),Y=new Float64Array(n);var i=0,ux=0,uy=0,xv,yv,d;var _iterator3=_createForOfIteratorHelper(data),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){d=_step3.value;X[i]=xv=+x(d);Y[i]=yv=+y(d);++i;ux+=(xv-ux)/i;uy+=(yv-uy)/i}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}for(i=0;i<n;++i){X[i]-=ux;Y[i]-=uy}return[X,Y,ux,uy]}function visitPoints(data,x,y,callback){var i=-1,u,v;var _iterator4=_createForOfIteratorHelper(data),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var d=_step4.value;u=x(d);v=y(d);if(u!=null&&(u=+u)>=u&&v!=null&&(v=+v)>=v){callback(u,v,++i)}}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}function rSquared(data,x,y,uY,predict){var SSE=0,SST=0;visitPoints(data,x,y,(function(dx,dy){var sse=dy-predict(dx),sst=dy-uY;SSE+=sse*sse;SST+=sst*sst}));return 1-SSE/SST}function linear(data,x,y){var X=0,Y=0,XY=0,X2=0,n=0;visitPoints(data,x,y,(function(dx,dy){++n;X+=(dx-X)/n;Y+=(dy-Y)/n;XY+=(dx*dy-XY)/n;X2+=(dx*dx-X2)/n}));var coef=ols(X,Y,XY,X2),predict=function predict(x){return coef[0]+coef[1]*x};return{coef:coef,predict:predict,rSquared:rSquared(data,x,y,Y,predict)}}function log$2(data,x,y){var X=0,Y=0,XY=0,X2=0,n=0;visitPoints(data,x,y,(function(dx,dy){++n;dx=Math.log(dx);X+=(dx-X)/n;Y+=(dy-Y)/n;XY+=(dx*dy-XY)/n;X2+=(dx*dx-X2)/n}));var coef=ols(X,Y,XY,X2),predict=function predict(x){return coef[0]+coef[1]*Math.log(x)};return{coef:coef,predict:predict,rSquared:rSquared(data,x,y,Y,predict)}}function exp$1(data,x,y){var _points=points(data,x,y),_points2=_slicedToArray(_points,4),xv=_points2[0],yv=_points2[1],ux=_points2[2],uy=_points2[3];var YL=0,XY=0,XYL=0,X2Y=0,n=0,dx,ly,xy;visitPoints(data,x,y,(function(_,dy){dx=xv[n++];ly=Math.log(dy);xy=dx*dy;YL+=(dy*ly-YL)/n;XY+=(xy-XY)/n;XYL+=(xy*ly-XYL)/n;X2Y+=(dx*xy-X2Y)/n}));var _ols=ols(XY/uy,YL/uy,XYL/uy,X2Y/uy),_ols2=_slicedToArray(_ols,2),c0=_ols2[0],c1=_ols2[1],predict=function predict(x){return Math.exp(c0+c1*(x-ux))};return{coef:[Math.exp(c0-c1*ux),c1],predict:predict,rSquared:rSquared(data,x,y,uy,predict)}}function pow$1(data,x,y){var X=0,Y=0,XY=0,X2=0,YS=0,n=0;visitPoints(data,x,y,(function(dx,dy){var lx=Math.log(dx),ly=Math.log(dy);++n;X+=(lx-X)/n;Y+=(ly-Y)/n;XY+=(lx*ly-XY)/n;X2+=(lx*lx-X2)/n;YS+=(dy-YS)/n}));var coef=ols(X,Y,XY,X2),predict=function predict(x){return coef[0]*Math.pow(x,coef[1])};coef[0]=Math.exp(coef[0]);return{coef:coef,predict:predict,rSquared:rSquared(data,x,y,YS,predict)}}function quad(data,x,y){var _points3=points(data,x,y),_points4=_slicedToArray(_points3,4),xv=_points4[0],yv=_points4[1],ux=_points4[2],uy=_points4[3],n=xv.length;var X2=0,X3=0,X4=0,XY=0,X2Y=0,i,dx,dy,x2;for(i=0;i<n;){dx=xv[i];dy=yv[i++];x2=dx*dx;X2+=(x2-X2)/i;X3+=(x2*dx-X3)/i;X4+=(x2*x2-X4)/i;XY+=(dx*dy-XY)/i;X2Y+=(x2*dy-X2Y)/i}var X2X2=X4-X2*X2,d=X2*X2X2-X3*X3,a=(X2Y*X2-XY*X3)/d,b=(XY*X2X2-X2Y*X3)/d,c=-a*X2,predict=function predict(x){x=x-ux;return a*x*x+b*x+c+uy};return{coef:[c-b*ux+a*ux*ux+uy,b-2*a*ux,a],predict:predict,rSquared:rSquared(data,x,y,uy,predict)}}function poly(data,x,y,order){if(order===1)return linear(data,x,y);if(order===2)return quad(data,x,y);var _points5=points(data,x,y),_points6=_slicedToArray(_points5,4),xv=_points6[0],yv=_points6[1],ux=_points6[2],uy=_points6[3],n=xv.length,lhs=[],rhs=[],k=order+1;var i,j,l,v,c;for(i=0;i<k;++i){for(l=0,v=0;l<n;++l){v+=Math.pow(xv[l],i)*yv[l]}lhs.push(v);c=new Float64Array(k);for(j=0;j<k;++j){for(l=0,v=0;l<n;++l){v+=Math.pow(xv[l],i+j)}c[j]=v}rhs.push(c)}rhs.push(lhs);var coef=gaussianElimination(rhs),predict=function predict(x){x-=ux;var y=uy+coef[0]+coef[1]*x+coef[2]*x*x;for(i=3;i<k;++i){y+=coef[i]*Math.pow(x,i)}return y};return{coef:uncenter(k,coef,-ux,uy),predict:predict,rSquared:rSquared(data,x,y,uy,predict)}}function uncenter(k,a,x,y){var z=Array(k);var i,j,v,c;for(i=0;i<k;++i){z[i]=0}for(i=k-1;i>=0;--i){v=a[i];c=1;z[i]+=v;for(j=1;j<=i;++j){c*=(i+1-j)/j;z[i-j]+=v*Math.pow(x,j)*c}}z[0]+=y;return z}function gaussianElimination(matrix){var n=matrix.length-1,coef=[];var i,j,k,r,t;for(i=0;i<n;++i){r=i;for(j=i+1;j<n;++j){if(Math.abs(matrix[i][j])>Math.abs(matrix[i][r])){r=j}}for(k=i;k<n+1;++k){t=matrix[k][i];matrix[k][i]=matrix[k][r];matrix[k][r]=t}for(j=i+1;j<n;++j){for(k=n;k>=i;k--){matrix[k][j]-=matrix[k][i]*matrix[i][j]/matrix[i][i]}}}for(j=n-1;j>=0;--j){t=0;for(k=j+1;k<n;++k){t+=matrix[k][j]*coef[k]}coef[j]=(matrix[n][j]-t)/matrix[j][j]}return coef}var maxiters=2,epsilon=1e-12;function loess(data,x,y,bandwidth){var _points7=points(data,x,y,true),_points8=_slicedToArray(_points7,4),xv=_points8[0],yv=_points8[1],ux=_points8[2],uy=_points8[3],n=xv.length,bw=Math.max(2,~~(bandwidth*n)),yhat=new Float64Array(n),residuals=new Float64Array(n),robustWeights=new Float64Array(n).fill(1);for(var iter=-1;++iter<=maxiters;){var interval=[0,bw-1];for(var i=0;i<n;++i){var dx=xv[i],i0=interval[0],i1=interval[1],edge=dx-xv[i0]>xv[i1]-dx?i0:i1;var W=0,X=0,Y=0,XY=0,X2=0;var denom=1/Math.abs(xv[edge]-dx||1);for(var k=i0;k<=i1;++k){var xk=xv[k],yk=yv[k],w=tricube(Math.abs(dx-xk)*denom)*robustWeights[k],xkw=xk*w;W+=w;X+=xkw;Y+=yk*w;XY+=yk*xkw;X2+=xk*xkw}var _ols3=ols(X/W,Y/W,XY/W,X2/W),_ols4=_slicedToArray(_ols3,2),a=_ols4[0],b=_ols4[1];yhat[i]=a+b*dx;residuals[i]=Math.abs(yv[i]-yhat[i]);updateInterval(xv,i+1,interval)}if(iter===maxiters){break}var medianResidual=median(residuals);if(Math.abs(medianResidual)<epsilon)break;for(var _i=0,arg,_w;_i<n;++_i){arg=residuals[_i]/(6*medianResidual);robustWeights[_i]=arg>=1?epsilon:(_w=1-arg*arg)*_w}}return output(xv,yhat,ux,uy)}function tricube(x){return(x=1-x*x*x)*x*x}function updateInterval(xv,i,interval){var val=xv[i];var left=interval[0],right=interval[1]+1;if(right>=xv.length)return;while(i>left&&xv[right]-val<=val-xv[left]){interval[0]=++left;interval[1]=right;++right}}function output(xv,yhat,ux,uy){var n=xv.length,out=[];var i=0,cnt=0,prev=[],v;for(;i<n;++i){v=xv[i]+ux;if(prev[0]===v){prev[1]+=(yhat[i]-prev[1])/++cnt}else{cnt=0;prev[1]+=uy;prev=[v,yhat[i]];out.push(prev)}}prev[1]+=uy;return out}var MIN_RADIANS=.1*Math.PI/180;function sampleCurve(f,extent,minSteps,maxSteps){minSteps=minSteps||25;maxSteps=Math.max(minSteps,maxSteps||200);var point=function point(x){return[x,f(x)]},minX=extent[0],maxX=extent[1],span=maxX-minX,stop=span/maxSteps,prev=[point(minX)],next=[];if(minSteps===maxSteps){for(var i=1;i<maxSteps;++i){prev.push(point(minX+i/minSteps*span))}prev.push(point(maxX));return prev}else{next.push(point(maxX));for(var _i2=minSteps;--_i2>0;){next.push(point(minX+_i2/minSteps*span))}}var p0=prev[0],p1=next[next.length-1];while(p1){var pm=point((p0[0]+p1[0])/2);if(pm[0]-p0[0]>=stop&&angleDelta(p0,pm,p1)>MIN_RADIANS){next.push(pm)}else{p0=p1;prev.push(p1);next.pop()}p1=next[next.length-1]}return prev}function angleDelta(p,q,r){var a0=Math.atan2(r[1]-p[1],r[0]-p[0]),a1=Math.atan2(q[1]-p[1],q[0]-p[0]);return Math.abs(a0-a1)}function multikey(f){return function(x){var n=f.length;var i=1,k=String(f[0](x));for(;i<n;++i){k+="|"+f[i](x)}return k}}function groupkey(fields){return!fields||!fields.length?function(){return""}:fields.length===1?fields[0]:multikey(fields)}function measureName(op,field,as){return as||op+(!field?"":"_"+field)}var noop=function noop(){};var base_op={init:noop,add:noop,rem:noop,idx:0};var AggregateOps={values:{init:function init(m){return m.cell.store=true},value:function value(m){return m.cell.data.values()},idx:-1},count:{value:function value(m){return m.cell.num}},__count__:{value:function value(m){return m.missing+m.valid}},missing:{value:function value(m){return m.missing}},valid:{value:function value(m){return m.valid}},sum:{init:function init(m){return m.sum=0},value:function value(m){return m.sum},add:function add(m,v){return m.sum+=+v},rem:function rem(m,v){return m.sum-=v}},product:{init:function init(m){return m.product=1},value:function value(m){return m.valid?m.product:undefined},add:function add(m,v){return m.product*=v},rem:function rem(m,v){return m.product/=v}},mean:{init:function init(m){return m.mean=0},value:function value(m){return m.valid?m.mean:undefined},add:function add(m,v){return m.mean_d=v-m.mean,m.mean+=m.mean_d/m.valid},rem:function rem(m,v){return m.mean_d=v-m.mean,m.mean-=m.valid?m.mean_d/m.valid:m.mean}},average:{value:function value(m){return m.valid?m.mean:undefined},req:["mean"],idx:1},variance:{init:function init(m){return m.dev=0},value:function value(m){return m.valid>1?m.dev/(m.valid-1):undefined},add:function add(m,v){return m.dev+=m.mean_d*(v-m.mean)},rem:function rem(m,v){return m.dev-=m.mean_d*(v-m.mean)},req:["mean"],idx:1},variancep:{value:function value(m){return m.valid>1?m.dev/m.valid:undefined},req:["variance"],idx:2},stdev:{value:function value(m){return m.valid>1?Math.sqrt(m.dev/(m.valid-1)):undefined},req:["variance"],idx:2},stdevp:{value:function value(m){return m.valid>1?Math.sqrt(m.dev/m.valid):undefined},req:["variance"],idx:2},stderr:{value:function value(m){return m.valid>1?Math.sqrt(m.dev/(m.valid*(m.valid-1))):undefined},req:["variance"],idx:2},distinct:{value:function value(m){return m.cell.data.distinct(m.get)},req:["values"],idx:3},ci0:{value:function value(m){return m.cell.data.ci0(m.get)},req:["values"],idx:3},ci1:{value:function value(m){return m.cell.data.ci1(m.get)},req:["values"],idx:3},median:{value:function value(m){return m.cell.data.q2(m.get)},req:["values"],idx:3},q1:{value:function value(m){return m.cell.data.q1(m.get)},req:["values"],idx:3},q3:{value:function value(m){return m.cell.data.q3(m.get)},req:["values"],idx:3},min:{init:function init(m){return m.min=undefined},value:function value(m){return m.min=Number.isNaN(m.min)?m.cell.data.min(m.get):m.min},add:function add(m,v){if(v<m.min||m.min===undefined)m.min=v},rem:function rem(m,v){if(v<=m.min)m.min=NaN},req:["values"],idx:4},max:{init:function init(m){return m.max=undefined},value:function value(m){return m.max=Number.isNaN(m.max)?m.cell.data.max(m.get):m.max},add:function add(m,v){if(v>m.max||m.max===undefined)m.max=v},rem:function rem(m,v){if(v>=m.max)m.max=NaN},req:["values"],idx:4},argmin:{init:function init(m){return m.argmin=undefined},value:function value(m){return m.argmin||m.cell.data.argmin(m.get)},add:function add(m,v,t){if(v<m.min)m.argmin=t},rem:function rem(m,v){if(v<=m.min)m.argmin=undefined},req:["min","values"],idx:3},argmax:{init:function init(m){return m.argmax=undefined},value:function value(m){return m.argmax||m.cell.data.argmax(m.get)},add:function add(m,v,t){if(v>m.max)m.argmax=t},rem:function rem(m,v){if(v>=m.max)m.argmax=undefined},req:["max","values"],idx:3}};var ValidAggregateOps=Object.keys(AggregateOps);function measure(key,value){return function(out){return extend({name:key,out:out||key},base_op,value)}}ValidAggregateOps.forEach((function(key){AggregateOps[key]=measure(key,AggregateOps[key])}));function createMeasure(op,name){return AggregateOps[op](name)}function compareIndex(a,b){return a.idx-b.idx}function resolve(agg){var map={};agg.forEach((function(a){return map[a.name]=a}));var getreqs=function getreqs(a){if(!a.req)return;a.req.forEach((function(key){if(!map[key])getreqs(map[key]=AggregateOps[key]())}))};agg.forEach(getreqs);return Object.values(map).sort(compareIndex)}function init(){var _this=this;this.valid=0;this.missing=0;this._ops.forEach((function(op){return op.init(_this)}))}function add$1(v,t){var _this2=this;if(v==null||v===""){++this.missing;return}if(v!==v)return;++this.valid;this._ops.forEach((function(op){return op.add(_this2,v,t)}))}function rem(v,t){var _this3=this;if(v==null||v===""){--this.missing;return}if(v!==v)return;--this.valid;this._ops.forEach((function(op){return op.rem(_this3,v,t)}))}function set(t){var _this4=this;this._out.forEach((function(op){return t[op.out]=op.value(_this4)}));return t}function compileMeasures(agg,field){var get=field||identity,ops=resolve(agg),out=agg.slice().sort(compareIndex);function ctr(cell){this._ops=ops;this._out=out;this.cell=cell;this.init()}ctr.prototype.init=init;ctr.prototype.add=add$1;ctr.prototype.rem=rem;ctr.prototype.set=set;ctr.prototype.get=get;ctr.fields=agg.map((function(op){return op.out}));return ctr}function TupleStore(key){this._key=key?field(key):tupleid;this.reset()}var prototype=TupleStore.prototype;prototype.reset=function(){this._add=[];this._rem=[];this._ext=null;this._get=null;this._q=null};prototype.add=function(v){this._add.push(v)};prototype.rem=function(v){this._rem.push(v)};prototype.values=function(){this._get=null;if(this._rem.length===0)return this._add;var a=this._add,r=this._rem,k=this._key,n=a.length,m=r.length,x=Array(n-m),map={};var i,j,v;for(i=0;i<m;++i){map[k(r[i])]=1}for(i=0,j=0;i<n;++i){if(map[k(v=a[i])]){map[k(v)]=0}else{x[j++]=v}}this._rem=[];return this._add=x};prototype.distinct=function(get){var v=this.values(),map={};var n=v.length,count=0,s;while(--n>=0){s=get(v[n])+"";if(!_has(map,s)){map[s]=1;++count}}return count};prototype.extent=function(get){if(this._get!==get||!this._ext){var v=this.values(),i=extentIndex(v,get);this._ext=[v[i[0]],v[i[1]]];this._get=get}return this._ext};prototype.argmin=function(get){return this.extent(get)[0]||{}};prototype.argmax=function(get){return this.extent(get)[1]||{}};prototype.min=function(get){var m=this.extent(get)[0];return m!=null?get(m):undefined};prototype.max=function(get){var m=this.extent(get)[1];return m!=null?get(m):undefined};prototype.quartile=function(get){if(this._get!==get||!this._q){this._q=quartiles(this.values(),get);this._get=get}return this._q};prototype.q1=function(get){return this.quartile(get)[0]};prototype.q2=function(get){return this.quartile(get)[1]};prototype.q3=function(get){return this.quartile(get)[2]};prototype.ci=function(get){if(this._get!==get||!this._ci){this._ci=bootstrapCI(this.values(),1e3,.05,get);this._get=get}return this._ci};prototype.ci0=function(get){return this.ci(get)[0]};prototype.ci1=function(get){return this.ci(get)[1]};function Aggregate(params){Transform.call(this,null,params);this._adds=[];this._mods=[];this._alen=0;this._mlen=0;this._drop=true;this._cross=false;this._dims=[];this._dnames=[];this._measures=[];this._countOnly=false;this._counts=null;this._prev=null;this._inputs=null;this._outputs=null}Aggregate.Definition={type:"Aggregate",metadata:{generates:true,changes:true},params:[{name:"groupby",type:"field",array:true},{name:"ops",type:"enum",array:true,values:ValidAggregateOps},{name:"fields",type:"field",null:true,array:true},{name:"as",type:"string",null:true,array:true},{name:"drop",type:"boolean",default:true},{name:"cross",type:"boolean",default:false},{name:"key",type:"field"}]};inherits(Aggregate,Transform,{transform:function transform(_,pulse){var _this5=this;var aggr=this,out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),mod=_.modified();aggr.stamp=out.stamp;if(aggr.value&&(mod||pulse.modified(aggr._inputs,true))){aggr._prev=aggr.value;aggr.value=mod?aggr.init(_):{};pulse.visit(pulse.SOURCE,(function(t){return aggr.add(t)}))}else{aggr.value=aggr.value||aggr.init(_);pulse.visit(pulse.REM,(function(t){return aggr.rem(t)}));pulse.visit(pulse.ADD,(function(t){return aggr.add(t)}))}out.modifies(aggr._outputs);aggr._drop=_.drop!==false;if(_.cross&&aggr._dims.length>1){aggr._drop=false;aggr.cross()}if(pulse.clean()&&aggr._drop){out.clean(true).runAfter((function(){return _this5.clean()}))}return aggr.changes(out)},cross:function cross(){var aggr=this,curr=aggr.value,dims=aggr._dnames,vals=dims.map((function(){return{}})),n=dims.length;function collect(cells){var key,i,t,v;for(key in cells){t=cells[key].tuple;for(i=0;i<n;++i){vals[i][v=t[dims[i]]]=v}}}collect(aggr._prev);collect(curr);function generate(base,tuple,index){var name=dims[index],v=vals[index++];for(var k in v){var _key=base?base+"|"+k:k;tuple[name]=v[k];if(index<n)generate(_key,tuple,index);else if(!curr[_key])aggr.cell(_key,tuple)}}generate("",{},0)},init:function init(_){var inputs=this._inputs=[],outputs=this._outputs=[],inputMap={};function inputVisit(get){var fields=array(accessorFields(get)),n=fields.length;var i=0,f;for(;i<n;++i){if(!inputMap[f=fields[i]]){inputMap[f]=1;inputs.push(f)}}}this._dims=array(_.groupby);this._dnames=this._dims.map((function(d){var dname=accessorName(d);inputVisit(d);outputs.push(dname);return dname}));this.cellkey=_.key?_.key:groupkey(this._dims);this._countOnly=true;this._counts=[];this._measures=[];var fields=_.fields||[null],ops=_.ops||["count"],as=_.as||[],n=fields.length,map={};var field,op,m,mname,outname,i;if(n!==ops.length){error("Unmatched number of fields and aggregate ops.")}for(i=0;i<n;++i){field=fields[i];op=ops[i];if(field==null&&op!=="count"){error("Null aggregate field specified.")}mname=accessorName(field);outname=measureName(op,mname,as[i]);outputs.push(outname);if(op==="count"){this._counts.push(outname);continue}m=map[mname];if(!m){inputVisit(field);m=map[mname]=[];m.field=field;this._measures.push(m)}if(op!=="count")this._countOnly=false;m.push(createMeasure(op,outname))}this._measures=this._measures.map((function(m){return compileMeasures(m,m.field)}));return{}},cellkey:groupkey(),cell:function cell(key,t){var cell=this.value[key];if(!cell){cell=this.value[key]=this.newcell(key,t);this._adds[this._alen++]=cell}else if(cell.num===0&&this._drop&&cell.stamp<this.stamp){cell.stamp=this.stamp;this._adds[this._alen++]=cell}else if(cell.stamp<this.stamp){cell.stamp=this.stamp;this._mods[this._mlen++]=cell}return cell},newcell:function newcell(key,t){var cell={key:key,num:0,agg:null,tuple:this.newtuple(t,this._prev&&this._prev[key]),stamp:this.stamp,store:false};if(!this._countOnly){var measures=this._measures,n=measures.length;cell.agg=Array(n);for(var i=0;i<n;++i){cell.agg[i]=new measures[i](cell)}}if(cell.store){cell.data=new TupleStore}return cell},newtuple:function newtuple(t,p){var names=this._dnames,dims=this._dims,n=dims.length,x={};for(var i=0;i<n;++i){x[names[i]]=dims[i](t)}return p?replace(p.tuple,x):ingest(x)},clean:function clean(){var cells=this.value;for(var _key2 in cells){if(cells[_key2].num===0){delete cells[_key2]}}},add:function add(t){var key=this.cellkey(t),cell=this.cell(key,t);cell.num+=1;if(this._countOnly)return;if(cell.store)cell.data.add(t);var agg=cell.agg;for(var i=0,n=agg.length;i<n;++i){agg[i].add(agg[i].get(t),t)}},rem:function rem(t){var key=this.cellkey(t),cell=this.cell(key,t);cell.num-=1;if(this._countOnly)return;if(cell.store)cell.data.rem(t);var agg=cell.agg;for(var i=0,n=agg.length;i<n;++i){agg[i].rem(agg[i].get(t),t)}},celltuple:function celltuple(cell){var tuple=cell.tuple,counts=this._counts;if(cell.store){cell.data.values()}for(var i=0,n=counts.length;i<n;++i){tuple[counts[i]]=cell.num}if(!this._countOnly){var agg=cell.agg;for(var _i=0,_n=agg.length;_i<_n;++_i){agg[_i].set(tuple)}}return tuple},changes:function changes(out){var adds=this._adds,mods=this._mods,prev=this._prev,drop=this._drop,add=out.add,rem=out.rem,mod=out.mod;var cell,key,i,n;if(prev)for(key in prev){cell=prev[key];if(!drop||cell.num)rem.push(cell.tuple)}for(i=0,n=this._alen;i<n;++i){add.push(this.celltuple(adds[i]));adds[i]=null}for(i=0,n=this._mlen;i<n;++i){cell=mods[i];(cell.num===0&&drop?rem:mod).push(this.celltuple(cell));mods[i]=null}this._alen=this._mlen=0;this._prev=null;return out}});var EPSILON=1e-14;function Bin(params){Transform.call(this,null,params)}Bin.Definition={type:"Bin",metadata:{modifies:true},params:[{name:"field",type:"field",required:true},{name:"interval",type:"boolean",default:true},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:true,default:[5,2]},{name:"extent",type:"number",array:true,length:2,required:true},{name:"span",type:"number"},{name:"step",type:"number"},{name:"steps",type:"number",array:true},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:true},{name:"name",type:"string"},{name:"as",type:"string",array:true,length:2,default:["bin0","bin1"]}]};inherits(Bin,Transform,{transform:function transform(_,pulse){var band=_.interval!==false,bins=this._bins(_),start=bins.start,step=bins.step,as=_.as||["bin0","bin1"],b0=as[0],b1=as[1];var flag;if(_.modified()){pulse=pulse.reflow(true);flag=pulse.SOURCE}else{flag=pulse.modified(accessorFields(_.field))?pulse.ADD_MOD:pulse.ADD}pulse.visit(flag,band?function(t){var v=bins(t);t[b0]=v;t[b1]=v==null?null:start+step*(1+(v-start)/step)}:function(t){return t[b0]=bins(t)});return pulse.modifies(band?as:b0)},_bins:function _bins(_){if(this.value&&!_.modified()){return this.value}var field=_.field,bins=bin$1(_),step=bins.step;var start=bins.start,stop=start+Math.ceil((bins.stop-start)/step)*step,a,d;if((a=_.anchor)!=null){d=a-(start+step*Math.floor((a-start)/step));start+=d;stop+=d}var f=function f(t){var v=toNumber(field(t));return v==null?null:v<start?-Infinity:v>stop?+Infinity:(v=Math.max(start,Math.min(v,stop-step)),start+step*Math.floor(EPSILON+(v-start)/step))};f.start=start;f.stop=bins.stop;f.step=step;return this.value=accessor(f,accessorFields(field),_.name||"bin_"+accessorName(field))}});function SortedList(idFunc,source,input){var $=idFunc;var _data=source||[],_add=input||[],rem={},cnt=0;return{add:function add(t){return _add.push(t)},remove:function remove(t){return rem[$(t)]=++cnt},size:function size(){return _data.length},data:function data(compare,resort){if(cnt){_data=_data.filter((function(t){return!rem[$(t)]}));rem={};cnt=0}if(resort&&compare){_data.sort(compare)}if(_add.length){_data=compare?merge(compare,_data,_add.sort(compare)):_data.concat(_add);_add=[]}return _data}}}function Collect(params){Transform.call(this,[],params)}Collect.Definition={type:"Collect",metadata:{source:true},params:[{name:"sort",type:"compare"}]};inherits(Collect,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.ALL),list=SortedList(tupleid,this.value,out.materialize(out.ADD).add),sort=_.sort,mod=pulse.changed()||sort&&(_.modified("sort")||pulse.modified(sort.fields));out.visit(out.REM,list.remove);this.modified(mod);this.value=out.source=list.data(stableCompare(sort),mod);if(pulse.source&&pulse.source.root){this.value.root=pulse.source.root}return out}});function Compare(params){Operator.call(this,null,update$1,params)}inherits(Compare,Operator);function update$1(_){return this.value&&!_.modified()?this.value:compare(_.fields,_.orders)}function CountPattern(params){Transform.call(this,null,params)}CountPattern.Definition={type:"CountPattern",metadata:{generates:true,changes:true},params:[{name:"field",type:"field",required:true},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:true,length:2,default:["text","count"]}]};function tokenize(text,tcase,match){switch(tcase){case"upper":text=text.toUpperCase();break;case"lower":text=text.toLowerCase();break}return text.match(match)}inherits(CountPattern,Transform,{transform:function transform(_,pulse){var process=function process(update){return function(tuple){var tokens=tokenize(get(tuple),_.case,match)||[],t;for(var i=0,n=tokens.length;i<n;++i){if(!stop.test(t=tokens[i]))update(t)}}};var init=this._parameterCheck(_,pulse),counts=this._counts,match=this._match,stop=this._stop,get=_.field,as=_.as||["text","count"],add=process((function(t){return counts[t]=1+(counts[t]||0)})),rem=process((function(t){return counts[t]-=1}));if(init){pulse.visit(pulse.SOURCE,add)}else{pulse.visit(pulse.ADD,add);pulse.visit(pulse.REM,rem)}return this._finish(pulse,as)},_parameterCheck:function _parameterCheck(_,pulse){var init=false;if(_.modified("stopwords")||!this._stop){this._stop=new RegExp("^"+(_.stopwords||"")+"$","i");init=true}if(_.modified("pattern")||!this._match){this._match=new RegExp(_.pattern||"[\\w']+","g");init=true}if(_.modified("field")||pulse.modified(_.field.fields)){init=true}if(init)this._counts={};return init},_finish:function _finish(pulse,as){var counts=this._counts,tuples=this._tuples||(this._tuples={}),text=as[0],count=as[1],out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS);var w,t,c;for(w in counts){t=tuples[w];c=counts[w]||0;if(!t&&c){tuples[w]=t=ingest({});t[text]=w;t[count]=c;out.add.push(t)}else if(c===0){if(t)out.rem.push(t);counts[w]=null;tuples[w]=null}else if(t[count]!==c){t[count]=c;out.mod.push(t)}}return out.modifies(as)}});function Cross(params){Transform.call(this,null,params)}Cross.Definition={type:"Cross",metadata:{generates:true},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:true,length:2,default:["a","b"]}]};inherits(Cross,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE),as=_.as||["a","b"],a=as[0],b=as[1],reset=!this.value||pulse.changed(pulse.ADD_REM)||_.modified("as")||_.modified("filter");var data=this.value;if(reset){if(data)out.rem=data;data=pulse.materialize(pulse.SOURCE).source;out.add=this.value=cross(data,a,b,_.filter||truthy)}else{out.mod=data}out.source=this.value;return out.modifies(as)}});function cross(input,a,b,filter){var data=[],t={},n=input.length,i=0,j,left;for(;i<n;++i){t[a]=left=input[i];for(j=0;j<n;++j){t[b]=input[j];if(filter(t)){data.push(ingest(t));t={};t[a]=left}}}return data}var Distributions={kde:kde,mixture:mixture,normal:gaussian,lognormal:lognormal,uniform:uniform};var DISTRIBUTIONS="distributions",FUNCTION="function",FIELD="field";function parse$2(def,data){var func=def[FUNCTION];if(!_has(Distributions,func)){error("Unknown distribution function: "+func)}var d=Distributions[func]();for(var name in def){if(name===FIELD){d.data((def.from||data()).map(def[name]))}else if(name===DISTRIBUTIONS){d[name](def[name].map((function(_){return parse$2(_,data)})))}else if(_typeof(d[name])===FUNCTION){d[name](def[name])}}return d}function Density(params){Transform.call(this,null,params)}var distributions=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"lognormal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:true},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}];var mixture$1={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:true,params:distributions},{name:"weights",type:"number",array:true}]};Density.Definition={type:"Density",metadata:{generates:true},params:[{name:"extent",type:"number",array:true,length:2},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:distributions.concat(mixture$1)},{name:"as",type:"string",array:true,default:["value","density"]}]};inherits(Density,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS);if(!this.value||pulse.changed()||_.modified()){var dist=parse$2(_.distribution,source(pulse)),minsteps=_.steps||_.minsteps||25,maxsteps=_.steps||_.maxsteps||200;var method=_.method||"pdf";if(method!=="pdf"&&method!=="cdf"){error("Invalid density method: "+method)}if(!_.extent&&!dist.data){error("Missing density extent parameter.")}method=dist[method];var as=_.as||["value","density"],domain=_.extent||extent(dist.data()),values=sampleCurve(method,domain,minsteps,maxsteps).map((function(v){var tuple={};tuple[as[0]]=v[0];tuple[as[1]]=v[1];return ingest(tuple)}));if(this.value)out.rem=this.value;this.value=out.add=out.source=values}return out}});function source(pulse){return function(){return pulse.materialize(pulse.SOURCE).source}}function fieldNames(fields,as){if(!fields)return null;return fields.map((function(f,i){return as[i]||accessorName(f)}))}function partition(data,groupby,field){var groups=[],get=function get(f){return f(t)};var map,i,n,t,k,g;if(groupby==null){groups.push(data.map(field))}else{for(map={},i=0,n=data.length;i<n;++i){t=data[i];k=groupby.map(get);g=map[k];if(!g){map[k]=g=[];g.dims=k;groups.push(g)}g.push(field(t))}}return groups}var Output="bin";function DotBin(params){Transform.call(this,null,params)}DotBin.Definition={type:"DotBin",metadata:{modifies:true},params:[{name:"field",type:"field",required:true},{name:"groupby",type:"field",array:true},{name:"step",type:"number"},{name:"smooth",type:"boolean",default:false},{name:"as",type:"string",default:Output}]};var autostep=function autostep(data,field){return span(extent(data,field))/30};inherits(DotBin,Transform,{transform:function transform(_,pulse){if(this.value&&!(_.modified()||pulse.changed())){return pulse}var source=pulse.materialize(pulse.SOURCE).source,groups=partition(pulse.source,_.groupby,identity),smooth=_.smooth||false,field=_.field,step=_.step||autostep(source,field),sort=stableCompare((function(a,b){return field(a)-field(b)})),as=_.as||Output,n=groups.length;var min=Infinity,max=-Infinity,i=0,j;for(;i<n;++i){var g=groups[i].sort(sort);j=-1;var _iterator=_createForOfIteratorHelper(dotbin(g,step,smooth,field)),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var v=_step.value;if(v<min)min=v;if(v>max)max=v;g[++j][as]=v}}catch(err){_iterator.e(err)}finally{_iterator.f()}}this.value={start:min,stop:max,step:step};return pulse.reflow(true).modifies(as)}});function Expression(params){Operator.call(this,null,update$1$1,params);this.modified(true)}inherits(Expression,Operator);function update$1$1(_){var expr=_.expr;return this.value&&!_.modified("expr")?this.value:accessor((function(datum){return expr(datum,_)}),accessorFields(expr),accessorName(expr))}function Extent(params){Transform.call(this,[undefined,undefined],params)}Extent.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:true}]};inherits(Extent,Transform,{transform:function transform(_,pulse){var extent=this.value,field=_.field,mod=pulse.changed()||pulse.modified(field.fields)||_.modified("field");var min=extent[0],max=extent[1];if(mod||min==null){min=+Infinity;max=-Infinity}pulse.visit(mod?pulse.SOURCE:pulse.ADD,(function(t){var v=toNumber(field(t));if(v!=null){if(v<min)min=v;if(v>max)max=v}}));if(!Number.isFinite(min)||!Number.isFinite(max)){var name=accessorName(field);if(name)name=' for field "'.concat(name,'"');pulse.dataflow.warn("Infinite extent".concat(name,": [").concat(min,", ").concat(max,"]"));min=max=undefined}this.value=[min,max]}});function Subflow(pulse,parent){Operator.call(this,pulse);this.parent=parent;this.count=0}inherits(Subflow,Operator,{connect:function connect(target){this.detachSubflow=target.detachSubflow;this.targets().add(target);return target.source=this},add:function add(t){this.count+=1;this.value.add.push(t)},rem:function rem(t){this.count-=1;this.value.rem.push(t)},mod:function mod(t){this.value.mod.push(t)},init:function init(pulse){this.value.init(pulse,pulse.NO_SOURCE)},evaluate:function evaluate(){return this.value}});function Facet(params){Transform.call(this,{},params);this._keys=fastmap();var a=this._targets=[];a.active=0;a.forEach=function(f){for(var i=0,n=a.active;i<n;++i){f(a[i],i,a)}}}inherits(Facet,Transform,{activate:function activate(flow){this._targets[this._targets.active++]=flow},subflow:function subflow(key,flow,pulse,parent){var flows=this.value;var sf=_has(flows,key)&&flows[key],df,p;if(!sf){p=parent||(p=this._group[key])&&p.tuple;df=pulse.dataflow;sf=new Subflow(pulse.fork(pulse.NO_SOURCE),this);df.add(sf).connect(flow(df,key,p));flows[key]=sf;this.activate(sf)}else if(sf.value.stamp<pulse.stamp){sf.init(pulse);this.activate(sf)}return sf},clean:function clean(){var flows=this.value;for(var _key3 in flows){if(flows[_key3].count===0){var detach=flows[_key3].detachSubflow;if(detach)detach();delete flows[_key3]}}},initTargets:function initTargets(){var a=this._targets,n=a.length;for(var i=0;i<n&&a[i]!=null;++i){a[i]=null}a.active=0},transform:function transform(_,pulse){var _this6=this;var df=pulse.dataflow,key=_.key,flow=_.subflow,cache=this._keys,rekey=_.modified("key"),subflow=function subflow(key){return _this6.subflow(key,flow,pulse)};this._group=_.group||{};this.initTargets();pulse.visit(pulse.REM,(function(t){var id=tupleid(t),k=cache.get(id);if(k!==undefined){cache.delete(id);subflow(k).rem(t)}}));pulse.visit(pulse.ADD,(function(t){var k=key(t);cache.set(tupleid(t),k);subflow(k).add(t)}));if(rekey||pulse.modified(key.fields)){pulse.visit(pulse.MOD,(function(t){var id=tupleid(t),k0=cache.get(id),k1=key(t);if(k0===k1){subflow(k1).mod(t)}else{cache.set(id,k1);subflow(k0).rem(t);subflow(k1).add(t)}}))}else if(pulse.changed(pulse.MOD)){pulse.visit(pulse.MOD,(function(t){subflow(cache.get(tupleid(t))).mod(t)}))}if(rekey){pulse.visit(pulse.REFLOW,(function(t){var id=tupleid(t),k0=cache.get(id),k1=key(t);if(k0!==k1){cache.set(id,k1);subflow(k0).rem(t);subflow(k1).add(t)}}))}if(pulse.clean()){df.runAfter((function(){_this6.clean();cache.clean()}))}else if(cache.empty>df.cleanThreshold){df.runAfter(cache.clean)}return pulse}});function Field(params){Operator.call(this,null,update$2,params)}inherits(Field,Operator);function update$2(_){return this.value&&!_.modified()?this.value:isArray(_.name)?array(_.name).map((function(f){return field(f)})):field(_.name,_.as)}function Filter(params){Transform.call(this,fastmap(),params)}Filter.Definition={type:"Filter",metadata:{changes:true},params:[{name:"expr",type:"expr",required:true}]};inherits(Filter,Transform,{transform:function transform(_,pulse){var df=pulse.dataflow,cache=this.value,output=pulse.fork(),add=output.add,rem=output.rem,mod=output.mod,test=_.expr;var isMod=true;pulse.visit(pulse.REM,(function(t){var id=tupleid(t);if(!cache.has(id))rem.push(t);else cache.delete(id)}));pulse.visit(pulse.ADD,(function(t){if(test(t,_))add.push(t);else cache.set(tupleid(t),1)}));function revisit(t){var id=tupleid(t),b=test(t,_),s=cache.get(id);if(b&&s){cache.delete(id);add.push(t)}else if(!b&&!s){cache.set(id,1);rem.push(t)}else if(isMod&&b&&!s){mod.push(t)}}pulse.visit(pulse.MOD,revisit);if(_.modified()){isMod=false;pulse.visit(pulse.REFLOW,revisit)}if(cache.empty>df.cleanThreshold)df.runAfter(cache.clean);return output}});function Flatten(params){Transform.call(this,[],params)}Flatten.Definition={type:"Flatten",metadata:{generates:true},params:[{name:"fields",type:"field",array:true,required:true},{name:"index",type:"string"},{name:"as",type:"string",array:true}]};inherits(Flatten,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE),fields=_.fields,as=fieldNames(fields,_.as||[]),index=_.index||null,m=as.length;out.rem=this.value;pulse.visit(pulse.SOURCE,(function(t){var arrays=fields.map((function(f){return f(t)})),maxlen=arrays.reduce((function(l,a){return Math.max(l,a.length)}),0);var i=0,j,d,v;for(;i<maxlen;++i){d=derive(t);for(j=0;j<m;++j){d[as[j]]=(v=arrays[j][i])==null?null:v}if(index){d[index]=i}out.add.push(d)}}));this.value=out.source=out.add;if(index)out.modifies(index);return out.modifies(as)}});function Fold(params){Transform.call(this,[],params)}Fold.Definition={type:"Fold",metadata:{generates:true},params:[{name:"fields",type:"field",array:true,required:true},{name:"as",type:"string",array:true,length:2,default:["key","value"]}]};inherits(Fold,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE),fields=_.fields,fnames=fields.map(accessorName),as=_.as||["key","value"],k=as[0],v=as[1],n=fields.length;out.rem=this.value;pulse.visit(pulse.SOURCE,(function(t){for(var i=0,d;i<n;++i){d=derive(t);d[k]=fnames[i];d[v]=fields[i](t);out.add.push(d)}}));this.value=out.source=out.add;return out.modifies(as)}});function Formula(params){Transform.call(this,null,params)}Formula.Definition={type:"Formula",metadata:{modifies:true},params:[{name:"expr",type:"expr",required:true},{name:"as",type:"string",required:true},{name:"initonly",type:"boolean"}]};inherits(Formula,Transform,{transform:function transform(_,pulse){var func=_.expr,as=_.as,mod=_.modified(),flag=_.initonly?pulse.ADD:mod?pulse.SOURCE:pulse.modified(func.fields)||pulse.modified(as)?pulse.ADD_MOD:pulse.ADD;if(mod){pulse=pulse.materialize().reflow(true)}if(!_.initonly){pulse.modifies(as)}return pulse.visit(flag,(function(t){return t[as]=func(t,_)}))}});function Generate(params){Transform.call(this,[],params)}inherits(Generate,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.ALL),gen=_.generator;var data=this.value,num=_.size-data.length,add,rem,t;if(num>0){for(add=[];--num>=0;){add.push(t=ingest(gen(_)));data.push(t)}out.add=out.add.length?out.materialize(out.ADD).add.concat(add):add}else{rem=data.slice(0,-num);out.rem=out.rem.length?out.materialize(out.REM).rem.concat(rem):rem;data=data.slice(-num)}out.source=this.value=data;return out}});var Methods={value:"value",median:median,mean:mean,min:min,max:max};var Empty=[];function Impute(params){Transform.call(this,[],params)}Impute.Definition={type:"Impute",metadata:{changes:true},params:[{name:"field",type:"field",required:true},{name:"key",type:"field",required:true},{name:"keyvals",array:true},{name:"groupby",type:"field",array:true},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]};function getValue(_){var m=_.method||Methods.value,v;if(Methods[m]==null){error("Unrecognized imputation method: "+m)}else if(m===Methods.value){v=_.value!==undefined?_.value:0;return function(){return v}}else{return Methods[m]}}function getField(_){var f=_.field;return function(t){return t?f(t):NaN}}inherits(Impute,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.ALL),impute=getValue(_),field=getField(_),fName=accessorName(_.field),kName=accessorName(_.key),gNames=(_.groupby||[]).map(accessorName),groups=partition$1(pulse.source,_.groupby,_.key,_.keyvals),curr=[],prev=this.value,m=groups.domain.length,group,value,gVals,kVal,g,i,j,l,n,t;for(g=0,l=groups.length;g<l;++g){group=groups[g];gVals=group.values;value=NaN;for(j=0;j<m;++j){if(group[j]!=null)continue;kVal=groups.domain[j];t={_impute:true};for(i=0,n=gVals.length;i<n;++i){t[gNames[i]]=gVals[i]}t[kName]=kVal;t[fName]=Number.isNaN(value)?value=impute(group,field):value;curr.push(ingest(t))}}if(curr.length)out.add=out.materialize(out.ADD).add.concat(curr);if(prev.length)out.rem=out.materialize(out.REM).rem.concat(prev);this.value=curr;return out}});function partition$1(data,groupby,key,keyvals){var get=function get(f){return f(t)},groups=[],domain=keyvals?keyvals.slice():[],kMap={},gMap={},gVals,gKey,group,i,j,k,n,t;domain.forEach((function(k,i){return kMap[k]=i+1}));for(i=0,n=data.length;i<n;++i){t=data[i];k=key(t);j=kMap[k]||(kMap[k]=domain.push(k));gKey=(gVals=groupby?groupby.map(get):Empty)+"";if(!(group=gMap[gKey])){group=gMap[gKey]=[];groups.push(group);group.values=gVals}group[j-1]=t}groups.domain=domain;return groups}function JoinAggregate(params){Aggregate.call(this,params)}JoinAggregate.Definition={type:"JoinAggregate",metadata:{modifies:true},params:[{name:"groupby",type:"field",array:true},{name:"fields",type:"field",null:true,array:true},{name:"ops",type:"enum",array:true,values:ValidAggregateOps},{name:"as",type:"string",null:true,array:true},{name:"key",type:"field"}]};inherits(JoinAggregate,Aggregate,{transform:function transform(_,pulse){var aggr=this,mod=_.modified();var cells;if(aggr.value&&(mod||pulse.modified(aggr._inputs,true))){cells=aggr.value=mod?aggr.init(_):{};pulse.visit(pulse.SOURCE,(function(t){return aggr.add(t)}))}else{cells=aggr.value=aggr.value||this.init(_);pulse.visit(pulse.REM,(function(t){return aggr.rem(t)}));pulse.visit(pulse.ADD,(function(t){return aggr.add(t)}))}aggr.changes();pulse.visit(pulse.SOURCE,(function(t){extend(t,cells[aggr.cellkey(t)].tuple)}));return pulse.reflow(mod).modifies(this._outputs)},changes:function changes(){var adds=this._adds,mods=this._mods;var i,n;for(i=0,n=this._alen;i<n;++i){this.celltuple(adds[i]);adds[i]=null}for(i=0,n=this._mlen;i<n;++i){this.celltuple(mods[i]);mods[i]=null}this._alen=this._mlen=0}});function KDE(params){Transform.call(this,null,params)}KDE.Definition={type:"KDE",metadata:{generates:true},params:[{name:"groupby",type:"field",array:true},{name:"field",type:"field",required:true},{name:"cumulative",type:"boolean",default:false},{name:"counts",type:"boolean",default:false},{name:"bandwidth",type:"number",default:0},{name:"extent",type:"number",array:true,length:2},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"as",type:"string",array:true,default:["value","density"]}]};inherits(KDE,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS);if(!this.value||pulse.changed()||_.modified()){var _source=pulse.materialize(pulse.SOURCE).source,groups=partition(_source,_.groupby,_.field),names=(_.groupby||[]).map(accessorName),bandwidth=_.bandwidth,method=_.cumulative?"cdf":"pdf",as=_.as||["value","density"],values=[];var domain=_.extent,minsteps=_.steps||_.minsteps||25,maxsteps=_.steps||_.maxsteps||200;if(method!=="pdf"&&method!=="cdf"){error("Invalid density method: "+method)}if(_.resolve==="shared"){if(!domain)domain=extent(_source,_.field);minsteps=maxsteps=_.steps||maxsteps}groups.forEach((function(g){var density=kde(g,bandwidth)[method],scale=_.counts?g.length:1,local=domain||extent(g);sampleCurve(density,local,minsteps,maxsteps).forEach((function(v){var t={};for(var i=0;i<names.length;++i){t[names[i]]=g.dims[i]}t[as[0]]=v[0];t[as[1]]=v[1]*scale;values.push(ingest(t))}))}));if(this.value)out.rem=this.value;this.value=out.add=out.source=values}return out}});function Key(params){Operator.call(this,null,update$3,params)}inherits(Key,Operator);function update$3(_){return this.value&&!_.modified()?this.value:key(_.fields,_.flat)}function Load(params){Transform.call(this,[],params);this._pending=null}inherits(Load,Transform,{transform:function transform(_,pulse){var _this7=this;var df=pulse.dataflow;if(this._pending){return output$1(this,pulse,this._pending)}if(stop(_))return pulse.StopPropagation;if(_.values){return output$1(this,pulse,df.parse(_.values,_.format))}else if(_.async){var p=df.request(_.url,_.format).then((function(res){_this7._pending=array(res.data);return function(df){return df.touch(_this7)}}));return{async:p}}else{return df.request(_.url,_.format).then((function(res){return output$1(_this7,pulse,array(res.data))}))}}});function stop(_){return _.modified("async")&&!(_.modified("values")||_.modified("url")||_.modified("format"))}function output$1(op,pulse,data){data.forEach(ingest);var out=pulse.fork(pulse.NO_FIELDS&pulse.NO_SOURCE);out.rem=op.value;op.value=out.source=out.add=data;op._pending=null;if(out.rem.length)out.clean(true);return out}function Lookup(params){Transform.call(this,{},params)}Lookup.Definition={type:"Lookup",metadata:{modifies:true},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:true},{name:"key",type:"field",required:true}]},{name:"values",type:"field",array:true},{name:"fields",type:"field",array:true,required:true},{name:"as",type:"string",array:true},{name:"default",default:null}]};inherits(Lookup,Transform,{transform:function transform(_,pulse){var keys=_.fields,index=_.index,values=_.values,defaultValue=_.default==null?null:_.default,reset=_.modified(),n=keys.length;var flag=reset?pulse.SOURCE:pulse.ADD,out=pulse,as=_.as,set,m,mods;if(values){m=values.length;if(n>1&&!as){error('Multi-field lookup requires explicit "as" parameter.')}if(as&&as.length!==n*m){error('The "as" parameter has too few output field names.')}as=as||values.map(accessorName);set=function set(t){for(var i=0,k=0,j,v;i<n;++i){v=index.get(keys[i](t));if(v==null)for(j=0;j<m;++j,++k){t[as[k]]=defaultValue}else for(j=0;j<m;++j,++k){t[as[k]]=values[j](v)}}}}else{if(!as){error("Missing output field names.")}set=function set(t){for(var i=0,v;i<n;++i){v=index.get(keys[i](t));t[as[i]]=v==null?defaultValue:v}}}if(reset){out=pulse.reflow(true)}else{mods=keys.some((function(k){return pulse.modified(k.fields)}));flag|=mods?pulse.MOD:0}pulse.visit(flag,set);return out.modifies(as)}});function MultiExtent(params){Operator.call(this,null,update$4,params)}inherits(MultiExtent,Operator);function update$4(_){if(this.value&&!_.modified()){return this.value}var ext=_.extents,n=ext.length;var min=+Infinity,max=-Infinity,i,e;for(i=0;i<n;++i){e=ext[i];if(e[0]<min)min=e[0];if(e[1]>max)max=e[1]}return[min,max]}function MultiValues(params){Operator.call(this,null,update$5,params)}inherits(MultiValues,Operator);function update$5(_){return this.value&&!_.modified()?this.value:_.values.reduce((function(data,_){return data.concat(_)}),[])}function Params(params){Transform.call(this,null,params)}inherits(Params,Transform,{transform:function transform(_,pulse){this.modified(_.modified());this.value=_;return pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS)}});function Pivot(params){Aggregate.call(this,params)}Pivot.Definition={type:"Pivot",metadata:{generates:true,changes:true},params:[{name:"groupby",type:"field",array:true},{name:"field",type:"field",required:true},{name:"value",type:"field",required:true},{name:"op",type:"enum",values:ValidAggregateOps,default:"sum"},{name:"limit",type:"number",default:0},{name:"key",type:"field"}]};inherits(Pivot,Aggregate,{_transform:Aggregate.prototype.transform,transform:function transform(_,pulse){return this._transform(aggregateParams(_,pulse),pulse)}});function aggregateParams(_,pulse){var key=_.field,value=_.value,op=(_.op==="count"?"__count__":_.op)||"sum",fields=accessorFields(key).concat(accessorFields(value)),keys=pivotKeys(key,_.limit||0,pulse);if(pulse.changed())_.set("__pivot__",null,null,true);return{key:_.key,groupby:_.groupby,ops:keys.map((function(){return op})),fields:keys.map((function(k){return get(k,key,value,fields)})),as:keys.map((function(k){return k+""})),modified:_.modified.bind(_)}}function get(k,key,value,fields){return accessor((function(d){return key(d)===k?value(d):NaN}),fields,k+"")}function pivotKeys(key,limit,pulse){var map={},list=[];pulse.visit(pulse.SOURCE,(function(t){var k=key(t);if(!map[k]){map[k]=1;list.push(k)}}));list.sort(ascending);return limit?list.slice(0,limit):list}function PreFacet(params){Facet.call(this,params)}inherits(PreFacet,Facet,{transform:function transform(_,pulse){var _this8=this;var flow=_.subflow,field=_.field,subflow=function subflow(t){return _this8.subflow(tupleid(t),flow,pulse,t)};if(_.modified("field")||field&&pulse.modified(accessorFields(field))){error("PreFacet does not support field modification.")}this.initTargets();if(field){pulse.visit(pulse.MOD,(function(t){var sf=subflow(t);field(t).forEach((function(_){return sf.mod(_)}))}));pulse.visit(pulse.ADD,(function(t){var sf=subflow(t);field(t).forEach((function(_){return sf.add(ingest(_))}))}));pulse.visit(pulse.REM,(function(t){var sf=subflow(t);field(t).forEach((function(_){return sf.rem(_)}))}))}else{pulse.visit(pulse.MOD,(function(t){return subflow(t).mod(t)}));pulse.visit(pulse.ADD,(function(t){return subflow(t).add(t)}));pulse.visit(pulse.REM,(function(t){return subflow(t).rem(t)}))}if(pulse.clean()){pulse.runAfter((function(){return _this8.clean()}))}return pulse}});function Project(params){Transform.call(this,null,params)}Project.Definition={type:"Project",metadata:{generates:true,changes:true},params:[{name:"fields",type:"field",array:true},{name:"as",type:"string",null:true,array:true}]};inherits(Project,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE),fields=_.fields,as=fieldNames(_.fields,_.as||[]),derive=fields?function(s,t){return project(s,t,fields,as)}:rederive;var lut;if(this.value){lut=this.value}else{pulse=pulse.addAll();lut=this.value={}}pulse.visit(pulse.REM,(function(t){var id=tupleid(t);out.rem.push(lut[id]);lut[id]=null}));pulse.visit(pulse.ADD,(function(t){var dt=derive(t,ingest({}));lut[tupleid(t)]=dt;out.add.push(dt)}));pulse.visit(pulse.MOD,(function(t){out.mod.push(derive(t,lut[tupleid(t)]))}));return out}});function project(s,t,fields,as){for(var i=0,n=fields.length;i<n;++i){t[as[i]]=fields[i](s)}return t}function Proxy(params){Transform.call(this,null,params)}inherits(Proxy,Transform,{transform:function transform(_,pulse){this.value=_.value;return _.modified("value")?pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS):pulse.StopPropagation}});function Quantile(params){Transform.call(this,null,params)}Quantile.Definition={type:"Quantile",metadata:{generates:true,changes:true},params:[{name:"groupby",type:"field",array:true},{name:"field",type:"field",required:true},{name:"probs",type:"number",array:true},{name:"step",type:"number",default:.01},{name:"as",type:"string",array:true,default:["prob","value"]}]};var EPSILON$1=1e-14;inherits(Quantile,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),as=_.as||["prob","value"];if(this.value&&!_.modified()&&!pulse.changed()){out.source=this.value;return out}var source=pulse.materialize(pulse.SOURCE).source,groups=partition(source,_.groupby,_.field),names=(_.groupby||[]).map(accessorName),values=[],step=_.step||.01,p=_.probs||range$1(step/2,1-EPSILON$1,step),n=p.length;groups.forEach((function(g){var q=quantiles(g,p);for(var i=0;i<n;++i){var t={};for(var _i2=0;_i2<names.length;++_i2){t[names[_i2]]=g.dims[_i2]}t[as[0]]=p[i];t[as[1]]=q[i];values.push(ingest(t))}}));if(this.value)out.rem=this.value;this.value=out.add=out.source=values;return out}});function Relay(params){Transform.call(this,null,params)}inherits(Relay,Transform,{transform:function transform(_,pulse){var out,lut;if(this.value){lut=this.value}else{out=pulse=pulse.addAll();lut=this.value={}}if(_.derive){out=pulse.fork(pulse.NO_SOURCE);pulse.visit(pulse.REM,(function(t){var id=tupleid(t);out.rem.push(lut[id]);lut[id]=null}));pulse.visit(pulse.ADD,(function(t){var dt=derive(t);lut[tupleid(t)]=dt;out.add.push(dt)}));pulse.visit(pulse.MOD,(function(t){var dt=lut[tupleid(t)];for(var k in t){dt[k]=t[k];out.modifies(k)}out.mod.push(dt)}))}return out}});function Sample(params){Transform.call(this,[],params);this.count=0}Sample.Definition={type:"Sample",metadata:{},params:[{name:"size",type:"number",default:1e3}]};inherits(Sample,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE),mod=_.modified("size"),num=_.size,map=this.value.reduce((function(m,t){return m[tupleid(t)]=1,m}),{});var res=this.value,cnt=this.count,cap=0;function update(t){var p,idx;if(res.length<num){res.push(t)}else{idx=~~((cnt+1)*exports.random());if(idx<res.length&&idx>=cap){p=res[idx];if(map[tupleid(p)])out.rem.push(p);res[idx]=t}}++cnt}if(pulse.rem.length){pulse.visit(pulse.REM,(function(t){var id=tupleid(t);if(map[id]){map[id]=-1;out.rem.push(t)}--cnt}));res=res.filter((function(t){return map[tupleid(t)]!==-1}))}if((pulse.rem.length||mod)&&res.length<num&&pulse.source){cap=cnt=res.length;pulse.visit(pulse.SOURCE,(function(t){if(!map[tupleid(t)])update(t)}));cap=-1}if(mod&&res.length>num){var n=res.length-num;for(var i=0;i<n;++i){map[tupleid(res[i])]=-1;out.rem.push(res[i])}res=res.slice(n)}if(pulse.mod.length){pulse.visit(pulse.MOD,(function(t){if(map[tupleid(t)])out.mod.push(t)}))}if(pulse.add.length){pulse.visit(pulse.ADD,update)}if(pulse.add.length||cap<0){out.add=res.filter((function(t){return!map[tupleid(t)]}))}this.count=cnt;this.value=out.source=res;return out}});function Sequence(params){Transform.call(this,null,params)}Sequence.Definition={type:"Sequence",metadata:{generates:true,changes:true},params:[{name:"start",type:"number",required:true},{name:"stop",type:"number",required:true},{name:"step",type:"number",default:1},{name:"as",type:"string",default:"data"}]};inherits(Sequence,Transform,{transform:function transform(_,pulse){if(this.value&&!_.modified())return;var out=pulse.materialize().fork(pulse.MOD),as=_.as||"data";out.rem=this.value?pulse.rem.concat(this.value):pulse.rem;this.value=range$1(_.start,_.stop,_.step||1).map((function(v){var t={};t[as]=v;return ingest(t)}));out.add=pulse.add.concat(this.value);return out}});function Sieve(params){Transform.call(this,null,params);this.modified(true)}inherits(Sieve,Transform,{transform:function transform(_,pulse){this.value=pulse.source;return pulse.changed()?pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS):pulse.StopPropagation}});function TimeUnit(params){Transform.call(this,null,params)}var OUTPUT=["unit0","unit1"];TimeUnit.Definition={type:"TimeUnit",metadata:{modifies:true},params:[{name:"field",type:"field",required:true},{name:"interval",type:"boolean",default:true},{name:"units",type:"enum",values:TIME_UNITS,array:true},{name:"step",type:"number",default:1},{name:"maxbins",type:"number",default:40},{name:"extent",type:"date",array:true},{name:"timezone",type:"enum",default:"local",values:["local","utc"]},{name:"as",type:"string",array:true,length:2,default:OUTPUT}]};inherits(TimeUnit,Transform,{transform:function transform(_,pulse){var field=_.field,band=_.interval!==false,utc=_.timezone==="utc",floor=this._floor(_,pulse),offset=(utc?utcInterval:timeInterval)(floor.unit).offset,as=_.as||OUTPUT,u0=as[0],u1=as[1],step=floor.step;var min=floor.start||Infinity,max=floor.stop||-Infinity,flag=pulse.ADD;if(_.modified()||pulse.modified(accessorFields(field))){pulse=pulse.reflow(true);flag=pulse.SOURCE;min=Infinity;max=-Infinity}pulse.visit(flag,(function(t){var v=field(t);var a,b;if(v==null){t[u0]=null;if(band)t[u1]=null}else{t[u0]=a=b=floor(v);if(band)t[u1]=b=offset(a,step);if(a<min)min=a;if(b>max)max=b}}));floor.start=min;floor.stop=max;return pulse.modifies(band?as:u0)},_floor:function _floor(_,pulse){var utc=_.timezone==="utc";var _ref=_.units?{units:_.units,step:_.step||1}:bin({extent:_.extent||extent(pulse.materialize(pulse.SOURCE).source,_.field),maxbins:_.maxbins}),units=_ref.units,step=_ref.step;var tunits=timeUnits(units),prev=this.value||{},floor=(utc?utcFloor:timeFloor)(tunits,step);floor.unit=peek(tunits);floor.units=tunits;floor.step=step;floor.start=prev.start;floor.stop=prev.stop;return this.value=floor}});function TupleIndex(params){Transform.call(this,fastmap(),params)}inherits(TupleIndex,Transform,{transform:function transform(_,pulse){var df=pulse.dataflow,field=_.field,index=this.value,set=function set(t){return index.set(field(t),t)};var mod=true;if(_.modified("field")||pulse.modified(field.fields)){index.clear();pulse.visit(pulse.SOURCE,set)}else if(pulse.changed()){pulse.visit(pulse.REM,(function(t){return index.delete(field(t))}));pulse.visit(pulse.ADD,set)}else{mod=false}this.modified(mod);if(index.empty>df.cleanThreshold)df.runAfter(index.clean);return pulse.fork()}});function Values(params){Transform.call(this,null,params)}inherits(Values,Transform,{transform:function transform(_,pulse){var run=!this.value||_.modified("field")||_.modified("sort")||pulse.changed()||_.sort&&pulse.modified(_.sort.fields);if(run){this.value=(_.sort?pulse.source.slice().sort(stableCompare(_.sort)):pulse.source).map(_.field)}}});function WindowOp(op,field,param,as){var fn=WindowOps[op](field,param);return{init:fn.init||zero,update:function update(w,t){t[as]=fn.next(w)}}}var WindowOps={row_number:function row_number(){return{next:function next(w){return w.index+1}}},rank:function rank(){var rank;return{init:function init(){return rank=1},next:function next(w){var i=w.index,data=w.data;return i&&w.compare(data[i-1],data[i])?rank=i+1:rank}}},dense_rank:function dense_rank(){var drank;return{init:function init(){return drank=1},next:function next(w){var i=w.index,d=w.data;return i&&w.compare(d[i-1],d[i])?++drank:drank}}},percent_rank:function percent_rank(){var rank=WindowOps.rank(),_next=rank.next;return{init:rank.init,next:function next(w){return(_next(w)-1)/(w.data.length-1)}}},cume_dist:function cume_dist(){var cume;return{init:function init(){return cume=0},next:function next(w){var d=w.data,c=w.compare;var i=w.index;if(cume<i){while(i+1<d.length&&!c(d[i],d[i+1])){++i}cume=i}return(1+cume)/d.length}}},ntile:function ntile(field,num){num=+num;if(!(num>0))error("ntile num must be greater than zero.");var cume=WindowOps.cume_dist(),_next2=cume.next;return{init:cume.init,next:function next(w){return Math.ceil(num*_next2(w))}}},lag:function lag(field,offset){offset=+offset||1;return{next:function next(w){var i=w.index-offset;return i>=0?field(w.data[i]):null}}},lead:function lead(field,offset){offset=+offset||1;return{next:function next(w){var i=w.index+offset,d=w.data;return i<d.length?field(d[i]):null}}},first_value:function first_value(field){return{next:function next(w){return field(w.data[w.i0])}}},last_value:function last_value(field){return{next:function next(w){return field(w.data[w.i1-1])}}},nth_value:function nth_value(field,nth){nth=+nth;if(!(nth>0))error("nth_value nth must be greater than zero.");return{next:function next(w){var i=w.i0+(nth-1);return i<w.i1?field(w.data[i]):null}}},prev_value:function prev_value(field){var prev;return{init:function init(){return prev=null},next:function next(w){var v=field(w.data[w.index]);return v!=null?prev=v:prev}}},next_value:function next_value(field){var v,i;return{init:function init(){return v=null,i=-1},next:function next(w){var d=w.data;return w.index<=i?v:(i=find(field,d,w.index))<0?(i=d.length,v=null):v=field(d[i])}}}};function find(field,data,index){for(var n=data.length;index<n;++index){var v=field(data[index]);if(v!=null)return index}return-1}var ValidWindowOps=Object.keys(WindowOps);function WindowState(_){var ops=array(_.ops),fields=array(_.fields),params=array(_.params),as=array(_.as),outputs=this.outputs=[],windows=this.windows=[],inputs={},map={},counts=[],measures=[];var countOnly=true;function visitInputs(f){array(accessorFields(f)).forEach((function(_){return inputs[_]=1}))}visitInputs(_.sort);ops.forEach((function(op,i){var field=fields[i],mname=accessorName(field),name=measureName(op,mname,as[i]);visitInputs(field);outputs.push(name);if(_has(WindowOps,op)){windows.push(WindowOp(op,fields[i],params[i],name))}else{if(field==null&&op!=="count"){error("Null aggregate field specified.")}if(op==="count"){counts.push(name);return}countOnly=false;var m=map[mname];if(!m){m=map[mname]=[];m.field=field;measures.push(m)}m.push(createMeasure(op,name))}}));if(counts.length||measures.length){this.cell=cell(measures,counts,countOnly)}this.inputs=Object.keys(inputs)}var prototype$1=WindowState.prototype;prototype$1.init=function(){this.windows.forEach((function(_){return _.init()}));if(this.cell)this.cell.init()};prototype$1.update=function(w,t){var cell=this.cell,wind=this.windows,data=w.data,m=wind&&wind.length;var j;if(cell){for(j=w.p0;j<w.i0;++j){cell.rem(data[j])}for(j=w.p1;j<w.i1;++j){cell.add(data[j])}cell.set(t)}for(j=0;j<m;++j){wind[j].update(w,t)}};function cell(measures,counts,countOnly){measures=measures.map((function(m){return compileMeasures(m,m.field)}));var cell={num:0,agg:null,store:false,count:counts};if(!countOnly){var n=measures.length,a=cell.agg=Array(n),i=0;for(;i<n;++i){a[i]=new measures[i](cell)}}if(cell.store){var store=cell.data=new TupleStore}cell.add=function(t){cell.num+=1;if(countOnly)return;if(store)store.add(t);for(var _i3=0;_i3<n;++_i3){a[_i3].add(a[_i3].get(t),t)}};cell.rem=function(t){cell.num-=1;if(countOnly)return;if(store)store.rem(t);for(var _i4=0;_i4<n;++_i4){a[_i4].rem(a[_i4].get(t),t)}};cell.set=function(t){var i,n;if(store)store.values();for(i=0,n=counts.length;i<n;++i){t[counts[i]]=cell.num}if(!countOnly)for(i=0,n=a.length;i<n;++i){a[i].set(t)}};cell.init=function(){cell.num=0;if(store)store.reset();for(var _i5=0;_i5<n;++_i5){a[_i5].init()}};return cell}function Window(params){Transform.call(this,{},params);this._mlen=0;this._mods=[]}Window.Definition={type:"Window",metadata:{modifies:true},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:true},{name:"ops",type:"enum",array:true,values:ValidWindowOps.concat(ValidAggregateOps)},{name:"params",type:"number",null:true,array:true},{name:"fields",type:"field",null:true,array:true},{name:"as",type:"string",null:true,array:true},{name:"frame",type:"number",null:true,array:true,length:2,default:[null,0]},{name:"ignorePeers",type:"boolean",default:false}]};inherits(Window,Transform,{transform:function transform(_,pulse){var _this9=this;this.stamp=pulse.stamp;var mod=_.modified(),cmp=stableCompare(_.sort),key=groupkey(_.groupby),group=function group(t){return _this9.group(key(t))};var state=this.state;if(!state||mod){state=this.state=new WindowState(_)}if(mod||pulse.modified(state.inputs)){this.value={};pulse.visit(pulse.SOURCE,(function(t){return group(t).add(t)}))}else{pulse.visit(pulse.REM,(function(t){return group(t).remove(t)}));pulse.visit(pulse.ADD,(function(t){return group(t).add(t)}))}for(var i=0,n=this._mlen;i<n;++i){processPartition(this._mods[i],state,cmp,_)}this._mlen=0;this._mods=[];return pulse.reflow(mod).modifies(state.outputs)},group:function group(key){var group=this.value[key];if(!group){group=this.value[key]=SortedList(tupleid);group.stamp=-1}if(group.stamp<this.stamp){group.stamp=this.stamp;this._mods[this._mlen++]=group}return group}});function processPartition(list,state,cmp,_){var sort=_.sort,range=sort&&!_.ignorePeers,frame=_.frame||[null,0],data=list.data(cmp),n=data.length,b=range?bisector(sort):null,w={i0:0,i1:0,p0:0,p1:0,index:0,data:data,compare:sort||constant(-1)};state.init();for(var i=0;i<n;++i){setWindow(w,frame,i,n);if(range)adjustRange(w,b);state.update(w,data[i])}}function setWindow(w,f,i,n){w.p0=w.i0;w.p1=w.i1;w.i0=f[0]==null?0:Math.max(0,i-Math.abs(f[0]));w.i1=f[1]==null?n:Math.min(n,i+Math.abs(f[1])+1);w.index=i}function adjustRange(w,bisect){var r0=w.i0,r1=w.i1-1,c=w.compare,d=w.data,n=d.length-1;if(r0>0&&!c(d[r0],d[r0-1]))w.i0=bisect.left(d,d[r0]);if(r1<n&&!c(d[r1],d[r1+1]))w.i1=bisect.right(d,d[r1])}var tx=Object.freeze({__proto__:null,aggregate:Aggregate,bin:Bin,collect:Collect,compare:Compare,countpattern:CountPattern,cross:Cross,density:Density,dotbin:DotBin,expression:Expression,extent:Extent,facet:Facet,field:Field,filter:Filter,flatten:Flatten,fold:Fold,formula:Formula,generate:Generate,impute:Impute,joinaggregate:JoinAggregate,kde:KDE,key:Key,load:Load,lookup:Lookup,multiextent:MultiExtent,multivalues:MultiValues,params:Params,pivot:Pivot,prefacet:PreFacet,project:Project,proxy:Proxy,quantile:Quantile,relay:Relay,sample:Sample,sequence:Sequence,sieve:Sieve,subflow:Subflow,timeunit:TimeUnit,tupleindex:TupleIndex,values:Values,window:Window});var pi=Math.PI,tau=2*pi,epsilon$1=1e-6,tauEpsilon=tau-epsilon$1;function Path(){this._x0=this._y0=this._x1=this._y1=null;this._=""}function path(){return new Path}Path.prototype=path.prototype={constructor:Path,moveTo:function moveTo(x,y){this._+="M"+(this._x0=this._x1=+x)+","+(this._y0=this._y1=+y)},closePath:function closePath(){if(this._x1!==null){this._x1=this._x0,this._y1=this._y0;this._+="Z"}},lineTo:function lineTo(x,y){this._+="L"+(this._x1=+x)+","+(this._y1=+y)},quadraticCurveTo:function quadraticCurveTo(x1,y1,x,y){this._+="Q"+ +x1+","+ +y1+","+(this._x1=+x)+","+(this._y1=+y)},bezierCurveTo:function bezierCurveTo(x1,y1,x2,y2,x,y){this._+="C"+ +x1+","+ +y1+","+ +x2+","+ +y2+","+(this._x1=+x)+","+(this._y1=+y)},arcTo:function arcTo(x1,y1,x2,y2,r){x1=+x1,y1=+y1,x2=+x2,y2=+y2,r=+r;var x0=this._x1,y0=this._y1,x21=x2-x1,y21=y2-y1,x01=x0-x1,y01=y0-y1,l01_2=x01*x01+y01*y01;if(r<0)throw new Error("negative radius: "+r);if(this._x1===null){this._+="M"+(this._x1=x1)+","+(this._y1=y1)}else if(!(l01_2>epsilon$1));else if(!(Math.abs(y01*x21-y21*x01)>epsilon$1)||!r){this._+="L"+(this._x1=x1)+","+(this._y1=y1)}else{var x20=x2-x0,y20=y2-y0,l21_2=x21*x21+y21*y21,l20_2=x20*x20+y20*y20,l21=Math.sqrt(l21_2),l01=Math.sqrt(l01_2),l=r*Math.tan((pi-Math.acos((l21_2+l01_2-l20_2)/(2*l21*l01)))/2),t01=l/l01,t21=l/l21;if(Math.abs(t01-1)>epsilon$1){this._+="L"+(x1+t01*x01)+","+(y1+t01*y01)}this._+="A"+r+","+r+",0,0,"+ +(y01*x20>x01*y20)+","+(this._x1=x1+t21*x21)+","+(this._y1=y1+t21*y21)}},arc:function arc(x,y,r,a0,a1,ccw){x=+x,y=+y,r=+r,ccw=!!ccw;var dx=r*Math.cos(a0),dy=r*Math.sin(a0),x0=x+dx,y0=y+dy,cw=1^ccw,da=ccw?a0-a1:a1-a0;if(r<0)throw new Error("negative radius: "+r);if(this._x1===null){this._+="M"+x0+","+y0}else if(Math.abs(this._x1-x0)>epsilon$1||Math.abs(this._y1-y0)>epsilon$1){this._+="L"+x0+","+y0}if(!r)return;if(da<0)da=da%tau+tau;if(da>tauEpsilon){this._+="A"+r+","+r+",0,1,"+cw+","+(x-dx)+","+(y-dy)+"A"+r+","+r+",0,1,"+cw+","+(this._x1=x0)+","+(this._y1=y0)}else if(da>epsilon$1){this._+="A"+r+","+r+",0,"+ +(da>=pi)+","+cw+","+(this._x1=x+r*Math.cos(a1))+","+(this._y1=y+r*Math.sin(a1))}},rect:function rect(x,y,w,h){this._+="M"+(this._x0=this._x1=+x)+","+(this._y0=this._y1=+y)+"h"+ +w+"v"+ +h+"h"+-w+"Z"},toString:function toString(){return this._}};function constant$1(x){return function constant(){return x}}var abs=Math.abs;var atan2=Math.atan2;var cos=Math.cos;var max$1=Math.max;var min$1=Math.min;var sin=Math.sin;var sqrt=Math.sqrt;var epsilon$2=1e-12;var pi$1=Math.PI;var halfPi=pi$1/2;var tau$1=2*pi$1;function acos(x){return x>1?0:x<-1?pi$1:Math.acos(x)}function asin(x){return x>=1?halfPi:x<=-1?-halfPi:Math.asin(x)}function arcInnerRadius(d){return d.innerRadius}function arcOuterRadius(d){return d.outerRadius}function arcStartAngle(d){return d.startAngle}function arcEndAngle(d){return d.endAngle}function arcPadAngle(d){return d&&d.padAngle}function intersect(x0,y0,x1,y1,x2,y2,x3,y3){var x10=x1-x0,y10=y1-y0,x32=x3-x2,y32=y3-y2,t=y32*x10-x32*y10;if(t*t<epsilon$2)return;t=(x32*(y0-y2)-y32*(x0-x2))/t;return[x0+t*x10,y0+t*y10]}function cornerTangents(x0,y0,x1,y1,r1,rc,cw){var x01=x0-x1,y01=y0-y1,lo=(cw?rc:-rc)/sqrt(x01*x01+y01*y01),ox=lo*y01,oy=-lo*x01,x11=x0+ox,y11=y0+oy,x10=x1+ox,y10=y1+oy,x00=(x11+x10)/2,y00=(y11+y10)/2,dx=x10-x11,dy=y10-y11,d2=dx*dx+dy*dy,r=r1-rc,D=x11*y10-x10*y11,d=(dy<0?-1:1)*sqrt(max$1(0,r*r*d2-D*D)),cx0=(D*dy-dx*d)/d2,cy0=(-D*dx-dy*d)/d2,cx1=(D*dy+dx*d)/d2,cy1=(-D*dx+dy*d)/d2,dx0=cx0-x00,dy0=cy0-y00,dx1=cx1-x00,dy1=cy1-y00;if(dx0*dx0+dy0*dy0>dx1*dx1+dy1*dy1)cx0=cx1,cy0=cy1;return{cx:cx0,cy:cy0,x01:-ox,y01:-oy,x11:cx0*(r1/r-1),y11:cy0*(r1/r-1)}}function arc$2(){var innerRadius=arcInnerRadius,outerRadius=arcOuterRadius,cornerRadius=constant$1(0),padRadius=null,startAngle=arcStartAngle,endAngle=arcEndAngle,padAngle=arcPadAngle,context=null;function arc(){var buffer,r,r0=+innerRadius.apply(this,arguments),r1=+outerRadius.apply(this,arguments),a0=startAngle.apply(this,arguments)-halfPi,a1=endAngle.apply(this,arguments)-halfPi,da=abs(a1-a0),cw=a1>a0;if(!context)context=buffer=path();if(r1<r0)r=r1,r1=r0,r0=r;if(!(r1>epsilon$2))context.moveTo(0,0);else if(da>tau$1-epsilon$2){context.moveTo(r1*cos(a0),r1*sin(a0));context.arc(0,0,r1,a0,a1,!cw);if(r0>epsilon$2){context.moveTo(r0*cos(a1),r0*sin(a1));context.arc(0,0,r0,a1,a0,cw)}}else{var a01=a0,a11=a1,a00=a0,a10=a1,da0=da,da1=da,ap=padAngle.apply(this,arguments)/2,rp=ap>epsilon$2&&(padRadius?+padRadius.apply(this,arguments):sqrt(r0*r0+r1*r1)),rc=min$1(abs(r1-r0)/2,+cornerRadius.apply(this,arguments)),rc0=rc,rc1=rc,t0,t1;if(rp>epsilon$2){var p0=asin(rp/r0*sin(ap)),p1=asin(rp/r1*sin(ap));if((da0-=p0*2)>epsilon$2)p0*=cw?1:-1,a00+=p0,a10-=p0;else da0=0,a00=a10=(a0+a1)/2;if((da1-=p1*2)>epsilon$2)p1*=cw?1:-1,a01+=p1,a11-=p1;else da1=0,a01=a11=(a0+a1)/2}var x01=r1*cos(a01),y01=r1*sin(a01),x10=r0*cos(a10),y10=r0*sin(a10);if(rc>epsilon$2){var x11=r1*cos(a11),y11=r1*sin(a11),x00=r0*cos(a00),y00=r0*sin(a00),oc;if(da<pi$1&&(oc=intersect(x01,y01,x00,y00,x11,y11,x10,y10))){var ax=x01-oc[0],ay=y01-oc[1],bx=x11-oc[0],by=y11-oc[1],kc=1/sin(acos((ax*bx+ay*by)/(sqrt(ax*ax+ay*ay)*sqrt(bx*bx+by*by)))/2),lc=sqrt(oc[0]*oc[0]+oc[1]*oc[1]);rc0=min$1(rc,(r0-lc)/(kc-1));rc1=min$1(rc,(r1-lc)/(kc+1))}}if(!(da1>epsilon$2))context.moveTo(x01,y01);else if(rc1>epsilon$2){t0=cornerTangents(x00,y00,x01,y01,r1,rc1,cw);t1=cornerTangents(x11,y11,x10,y10,r1,rc1,cw);context.moveTo(t0.cx+t0.x01,t0.cy+t0.y01);if(rc1<rc)context.arc(t0.cx,t0.cy,rc1,atan2(t0.y01,t0.x01),atan2(t1.y01,t1.x01),!cw);else{context.arc(t0.cx,t0.cy,rc1,atan2(t0.y01,t0.x01),atan2(t0.y11,t0.x11),!cw);context.arc(0,0,r1,atan2(t0.cy+t0.y11,t0.cx+t0.x11),atan2(t1.cy+t1.y11,t1.cx+t1.x11),!cw);context.arc(t1.cx,t1.cy,rc1,atan2(t1.y11,t1.x11),atan2(t1.y01,t1.x01),!cw)}}else context.moveTo(x01,y01),context.arc(0,0,r1,a01,a11,!cw);if(!(r0>epsilon$2)||!(da0>epsilon$2))context.lineTo(x10,y10);else if(rc0>epsilon$2){t0=cornerTangents(x10,y10,x11,y11,r0,-rc0,cw);t1=cornerTangents(x01,y01,x00,y00,r0,-rc0,cw);context.lineTo(t0.cx+t0.x01,t0.cy+t0.y01);if(rc0<rc)context.arc(t0.cx,t0.cy,rc0,atan2(t0.y01,t0.x01),atan2(t1.y01,t1.x01),!cw);else{context.arc(t0.cx,t0.cy,rc0,atan2(t0.y01,t0.x01),atan2(t0.y11,t0.x11),!cw);context.arc(0,0,r0,atan2(t0.cy+t0.y11,t0.cx+t0.x11),atan2(t1.cy+t1.y11,t1.cx+t1.x11),cw);context.arc(t1.cx,t1.cy,rc0,atan2(t1.y11,t1.x11),atan2(t1.y01,t1.x01),!cw)}}else context.arc(0,0,r0,a10,a00,cw)}context.closePath();if(buffer)return context=null,buffer+""||null}arc.centroid=function(){var r=(+innerRadius.apply(this,arguments)+ +outerRadius.apply(this,arguments))/2,a=(+startAngle.apply(this,arguments)+ +endAngle.apply(this,arguments))/2-pi$1/2;return[cos(a)*r,sin(a)*r]};arc.innerRadius=function(_){return arguments.length?(innerRadius=typeof _==="function"?_:constant$1(+_),arc):innerRadius};arc.outerRadius=function(_){return arguments.length?(outerRadius=typeof _==="function"?_:constant$1(+_),arc):outerRadius};arc.cornerRadius=function(_){return arguments.length?(cornerRadius=typeof _==="function"?_:constant$1(+_),arc):cornerRadius};arc.padRadius=function(_){return arguments.length?(padRadius=_==null?null:typeof _==="function"?_:constant$1(+_),arc):padRadius};arc.startAngle=function(_){return arguments.length?(startAngle=typeof _==="function"?_:constant$1(+_),arc):startAngle};arc.endAngle=function(_){return arguments.length?(endAngle=typeof _==="function"?_:constant$1(+_),arc):endAngle};arc.padAngle=function(_){return arguments.length?(padAngle=typeof _==="function"?_:constant$1(+_),arc):padAngle};arc.context=function(_){return arguments.length?(context=_==null?null:_,arc):context};return arc}function array$1(x){return _typeof(x)==="object"&&"length"in x?x:Array.from(x)}function Linear(context){this._context=context}Linear.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._point=0},lineEnd:function lineEnd(){if(this._line||this._line!==0&&this._point===1)this._context.closePath();this._line=1-this._line},point:function point(x,y){x=+x,y=+y;switch(this._point){case 0:this._point=1;this._line?this._context.lineTo(x,y):this._context.moveTo(x,y);break;case 1:this._point=2;default:this._context.lineTo(x,y);break}}};function curveLinear(context){return new Linear(context)}function x(p){return p[0]}function y(p){return p[1]}function line$2(x$1,y$1){var defined=constant$1(true),context=null,curve=curveLinear,output=null;x$1=typeof x$1==="function"?x$1:x$1===undefined?x:constant$1(x$1);y$1=typeof y$1==="function"?y$1:y$1===undefined?y:constant$1(y$1);function line(data){var i,n=(data=array$1(data)).length,d,defined0=false,buffer;if(context==null)output=curve(buffer=path());for(i=0;i<=n;++i){if(!(i<n&&defined(d=data[i],i,data))===defined0){if(defined0=!defined0)output.lineStart();else output.lineEnd()}if(defined0)output.point(+x$1(d,i,data),+y$1(d,i,data))}if(buffer)return output=null,buffer+""||null}line.x=function(_){return arguments.length?(x$1=typeof _==="function"?_:constant$1(+_),line):x$1};line.y=function(_){return arguments.length?(y$1=typeof _==="function"?_:constant$1(+_),line):y$1};line.defined=function(_){return arguments.length?(defined=typeof _==="function"?_:constant$1(!!_),line):defined};line.curve=function(_){return arguments.length?(curve=_,context!=null&&(output=curve(context)),line):curve};line.context=function(_){return arguments.length?(_==null?context=output=null:output=curve(context=_),line):context};return line}function area$2(x0,y0,y1){var x1=null,defined=constant$1(true),context=null,curve=curveLinear,output=null;x0=typeof x0==="function"?x0:x0===undefined?x:constant$1(+x0);y0=typeof y0==="function"?y0:y0===undefined?constant$1(0):constant$1(+y0);y1=typeof y1==="function"?y1:y1===undefined?y:constant$1(+y1);function area(data){var i,j,k,n=(data=array$1(data)).length,d,defined0=false,buffer,x0z=new Array(n),y0z=new Array(n);if(context==null)output=curve(buffer=path());for(i=0;i<=n;++i){if(!(i<n&&defined(d=data[i],i,data))===defined0){if(defined0=!defined0){j=i;output.areaStart();output.lineStart()}else{output.lineEnd();output.lineStart();for(k=i-1;k>=j;--k){output.point(x0z[k],y0z[k])}output.lineEnd();output.areaEnd()}}if(defined0){x0z[i]=+x0(d,i,data),y0z[i]=+y0(d,i,data);output.point(x1?+x1(d,i,data):x0z[i],y1?+y1(d,i,data):y0z[i])}}if(buffer)return output=null,buffer+""||null}function arealine(){return line$2().defined(defined).curve(curve).context(context)}area.x=function(_){return arguments.length?(x0=typeof _==="function"?_:constant$1(+_),x1=null,area):x0};area.x0=function(_){return arguments.length?(x0=typeof _==="function"?_:constant$1(+_),area):x0};area.x1=function(_){return arguments.length?(x1=_==null?null:typeof _==="function"?_:constant$1(+_),area):x1};area.y=function(_){return arguments.length?(y0=typeof _==="function"?_:constant$1(+_),y1=null,area):y0};area.y0=function(_){return arguments.length?(y0=typeof _==="function"?_:constant$1(+_),area):y0};area.y1=function(_){return arguments.length?(y1=_==null?null:typeof _==="function"?_:constant$1(+_),area):y1};area.lineX0=area.lineY0=function(){return arealine().x(x0).y(y0)};area.lineY1=function(){return arealine().x(x0).y(y1)};area.lineX1=function(){return arealine().x(x1).y(y0)};area.defined=function(_){return arguments.length?(defined=typeof _==="function"?_:constant$1(!!_),area):defined};area.curve=function(_){return arguments.length?(curve=_,context!=null&&(output=curve(context)),area):curve};area.context=function(_){return arguments.length?(_==null?context=output=null:output=curve(context=_),area):context};return area}var circle={draw:function draw(context,size){var r=Math.sqrt(size/pi$1);context.moveTo(r,0);context.arc(0,0,r,0,tau$1)}};function symbol$2(type,size){var context=null;type=typeof type==="function"?type:constant$1(type||circle);size=typeof size==="function"?size:constant$1(size===undefined?64:+size);function symbol(){var buffer;if(!context)context=buffer=path();type.apply(this,arguments).draw(context,+size.apply(this,arguments));if(buffer)return context=null,buffer+""||null}symbol.type=function(_){return arguments.length?(type=typeof _==="function"?_:constant$1(_),symbol):type};symbol.size=function(_){return arguments.length?(size=typeof _==="function"?_:constant$1(+_),symbol):size};symbol.context=function(_){return arguments.length?(context=_==null?null:_,symbol):context};return symbol}function noop$1(){}function _point(that,x,y){that._context.bezierCurveTo((2*that._x0+that._x1)/3,(2*that._y0+that._y1)/3,(that._x0+2*that._x1)/3,(that._y0+2*that._y1)/3,(that._x0+4*that._x1+x)/6,(that._y0+4*that._y1+y)/6)}function Basis(context){this._context=context}Basis.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._x0=this._x1=this._y0=this._y1=NaN;this._point=0},lineEnd:function lineEnd(){switch(this._point){case 3:_point(this,this._x1,this._y1);case 2:this._context.lineTo(this._x1,this._y1);break}if(this._line||this._line!==0&&this._point===1)this._context.closePath();this._line=1-this._line},point:function point(x,y){x=+x,y=+y;switch(this._point){case 0:this._point=1;this._line?this._context.lineTo(x,y):this._context.moveTo(x,y);break;case 1:this._point=2;break;case 2:this._point=3;this._context.lineTo((5*this._x0+this._x1)/6,(5*this._y0+this._y1)/6);default:_point(this,x,y);break}this._x0=this._x1,this._x1=x;this._y0=this._y1,this._y1=y}};function curveBasis(context){return new Basis(context)}function BasisClosed(context){this._context=context}BasisClosed.prototype={areaStart:noop$1,areaEnd:noop$1,lineStart:function lineStart(){this._x0=this._x1=this._x2=this._x3=this._x4=this._y0=this._y1=this._y2=this._y3=this._y4=NaN;this._point=0},lineEnd:function lineEnd(){switch(this._point){case 1:{this._context.moveTo(this._x2,this._y2);this._context.closePath();break}case 2:{this._context.moveTo((this._x2+2*this._x3)/3,(this._y2+2*this._y3)/3);this._context.lineTo((this._x3+2*this._x2)/3,(this._y3+2*this._y2)/3);this._context.closePath();break}case 3:{this.point(this._x2,this._y2);this.point(this._x3,this._y3);this.point(this._x4,this._y4);break}}},point:function point(x,y){x=+x,y=+y;switch(this._point){case 0:this._point=1;this._x2=x,this._y2=y;break;case 1:this._point=2;this._x3=x,this._y3=y;break;case 2:this._point=3;this._x4=x,this._y4=y;this._context.moveTo((this._x0+4*this._x1+x)/6,(this._y0+4*this._y1+y)/6);break;default:_point(this,x,y);break}this._x0=this._x1,this._x1=x;this._y0=this._y1,this._y1=y}};function curveBasisClosed(context){return new BasisClosed(context)}function BasisOpen(context){this._context=context}BasisOpen.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._x0=this._x1=this._y0=this._y1=NaN;this._point=0},lineEnd:function lineEnd(){if(this._line||this._line!==0&&this._point===3)this._context.closePath();this._line=1-this._line},point:function point(x,y){x=+x,y=+y;switch(this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3;var x0=(this._x0+4*this._x1+x)/6,y0=(this._y0+4*this._y1+y)/6;this._line?this._context.lineTo(x0,y0):this._context.moveTo(x0,y0);break;case 3:this._point=4;default:_point(this,x,y);break}this._x0=this._x1,this._x1=x;this._y0=this._y1,this._y1=y}};function curveBasisOpen(context){return new BasisOpen(context)}function Bundle(context,beta){this._basis=new Basis(context);this._beta=beta}Bundle.prototype={lineStart:function lineStart(){this._x=[];this._y=[];this._basis.lineStart()},lineEnd:function lineEnd(){var x=this._x,y=this._y,j=x.length-1;if(j>0){var x0=x[0],y0=y[0],dx=x[j]-x0,dy=y[j]-y0,i=-1,t;while(++i<=j){t=i/j;this._basis.point(this._beta*x[i]+(1-this._beta)*(x0+t*dx),this._beta*y[i]+(1-this._beta)*(y0+t*dy))}}this._x=this._y=null;this._basis.lineEnd()},point:function point(x,y){this._x.push(+x);this._y.push(+y)}};var curveBundle=function custom(beta){function bundle(context){return beta===1?new Basis(context):new Bundle(context,beta)}bundle.beta=function(beta){return custom(+beta)};return bundle}(.85);function _point$1(that,x,y){that._context.bezierCurveTo(that._x1+that._k*(that._x2-that._x0),that._y1+that._k*(that._y2-that._y0),that._x2+that._k*(that._x1-x),that._y2+that._k*(that._y1-y),that._x2,that._y2)}function Cardinal(context,tension){this._context=context;this._k=(1-tension)/6}Cardinal.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN;this._point=0},lineEnd:function lineEnd(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:_point$1(this,this._x1,this._y1);break}if(this._line||this._line!==0&&this._point===1)this._context.closePath();this._line=1-this._line},point:function point(x,y){x=+x,y=+y;switch(this._point){case 0:this._point=1;this._line?this._context.lineTo(x,y):this._context.moveTo(x,y);break;case 1:this._point=2;this._x1=x,this._y1=y;break;case 2:this._point=3;default:_point$1(this,x,y);break}this._x0=this._x1,this._x1=this._x2,this._x2=x;this._y0=this._y1,this._y1=this._y2,this._y2=y}};var curveCardinal=function custom(tension){function cardinal(context){return new Cardinal(context,tension)}cardinal.tension=function(tension){return custom(+tension)};return cardinal}(0);function CardinalClosed(context,tension){this._context=context;this._k=(1-tension)/6}CardinalClosed.prototype={areaStart:noop$1,areaEnd:noop$1,lineStart:function lineStart(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN;this._point=0},lineEnd:function lineEnd(){switch(this._point){case 1:{this._context.moveTo(this._x3,this._y3);this._context.closePath();break}case 2:{this._context.lineTo(this._x3,this._y3);this._context.closePath();break}case 3:{this.point(this._x3,this._y3);this.point(this._x4,this._y4);this.point(this._x5,this._y5);break}}},point:function point(x,y){x=+x,y=+y;switch(this._point){case 0:this._point=1;this._x3=x,this._y3=y;break;case 1:this._point=2;this._context.moveTo(this._x4=x,this._y4=y);break;case 2:this._point=3;this._x5=x,this._y5=y;break;default:_point$1(this,x,y);break}this._x0=this._x1,this._x1=this._x2,this._x2=x;this._y0=this._y1,this._y1=this._y2,this._y2=y}};var curveCardinalClosed=function custom(tension){function cardinal(context){return new CardinalClosed(context,tension)}cardinal.tension=function(tension){return custom(+tension)};return cardinal}(0);function CardinalOpen(context,tension){this._context=context;this._k=(1-tension)/6}CardinalOpen.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN;this._point=0},lineEnd:function lineEnd(){if(this._line||this._line!==0&&this._point===3)this._context.closePath();this._line=1-this._line},point:function point(x,y){x=+x,y=+y;switch(this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3;this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:_point$1(this,x,y);break}this._x0=this._x1,this._x1=this._x2,this._x2=x;this._y0=this._y1,this._y1=this._y2,this._y2=y}};var curveCardinalOpen=function custom(tension){function cardinal(context){return new CardinalOpen(context,tension)}cardinal.tension=function(tension){return custom(+tension)};return cardinal}(0);function _point$2(that,x,y){var x1=that._x1,y1=that._y1,x2=that._x2,y2=that._y2;if(that._l01_a>epsilon$2){var a=2*that._l01_2a+3*that._l01_a*that._l12_a+that._l12_2a,n=3*that._l01_a*(that._l01_a+that._l12_a);x1=(x1*a-that._x0*that._l12_2a+that._x2*that._l01_2a)/n;y1=(y1*a-that._y0*that._l12_2a+that._y2*that._l01_2a)/n}if(that._l23_a>epsilon$2){var b=2*that._l23_2a+3*that._l23_a*that._l12_a+that._l12_2a,m=3*that._l23_a*(that._l23_a+that._l12_a);x2=(x2*b+that._x1*that._l23_2a-x*that._l12_2a)/m;y2=(y2*b+that._y1*that._l23_2a-y*that._l12_2a)/m}that._context.bezierCurveTo(x1,y1,x2,y2,that._x2,that._y2)}function CatmullRom(context,alpha){this._context=context;this._alpha=alpha}CatmullRom.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN;this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function lineEnd(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:this.point(this._x2,this._y2);break}if(this._line||this._line!==0&&this._point===1)this._context.closePath();this._line=1-this._line},point:function point(x,y){x=+x,y=+y;if(this._point){var x23=this._x2-x,y23=this._y2-y;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(x23*x23+y23*y23,this._alpha))}switch(this._point){case 0:this._point=1;this._line?this._context.lineTo(x,y):this._context.moveTo(x,y);break;case 1:this._point=2;break;case 2:this._point=3;default:_point$2(this,x,y);break}this._l01_a=this._l12_a,this._l12_a=this._l23_a;this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a;this._x0=this._x1,this._x1=this._x2,this._x2=x;this._y0=this._y1,this._y1=this._y2,this._y2=y}};var curveCatmullRom=function custom(alpha){function catmullRom(context){return alpha?new CatmullRom(context,alpha):new Cardinal(context,0)}catmullRom.alpha=function(alpha){return custom(+alpha)};return catmullRom}(.5);function CatmullRomClosed(context,alpha){this._context=context;this._alpha=alpha}CatmullRomClosed.prototype={areaStart:noop$1,areaEnd:noop$1,lineStart:function lineStart(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN;this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function lineEnd(){switch(this._point){case 1:{this._context.moveTo(this._x3,this._y3);this._context.closePath();break}case 2:{this._context.lineTo(this._x3,this._y3);this._context.closePath();break}case 3:{this.point(this._x3,this._y3);this.point(this._x4,this._y4);this.point(this._x5,this._y5);break}}},point:function point(x,y){x=+x,y=+y;if(this._point){var x23=this._x2-x,y23=this._y2-y;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(x23*x23+y23*y23,this._alpha))}switch(this._point){case 0:this._point=1;this._x3=x,this._y3=y;break;case 1:this._point=2;this._context.moveTo(this._x4=x,this._y4=y);break;case 2:this._point=3;this._x5=x,this._y5=y;break;default:_point$2(this,x,y);break}this._l01_a=this._l12_a,this._l12_a=this._l23_a;this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a;this._x0=this._x1,this._x1=this._x2,this._x2=x;this._y0=this._y1,this._y1=this._y2,this._y2=y}};var curveCatmullRomClosed=function custom(alpha){function catmullRom(context){return alpha?new CatmullRomClosed(context,alpha):new CardinalClosed(context,0)}catmullRom.alpha=function(alpha){return custom(+alpha)};return catmullRom}(.5);function CatmullRomOpen(context,alpha){this._context=context;this._alpha=alpha}CatmullRomOpen.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN;this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function lineEnd(){if(this._line||this._line!==0&&this._point===3)this._context.closePath();this._line=1-this._line},point:function point(x,y){x=+x,y=+y;if(this._point){var x23=this._x2-x,y23=this._y2-y;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(x23*x23+y23*y23,this._alpha))}switch(this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3;this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:_point$2(this,x,y);break}this._l01_a=this._l12_a,this._l12_a=this._l23_a;this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a;this._x0=this._x1,this._x1=this._x2,this._x2=x;this._y0=this._y1,this._y1=this._y2,this._y2=y}};var curveCatmullRomOpen=function custom(alpha){function catmullRom(context){return alpha?new CatmullRomOpen(context,alpha):new CardinalOpen(context,0)}catmullRom.alpha=function(alpha){return custom(+alpha)};return catmullRom}(.5);function LinearClosed(context){this._context=context}LinearClosed.prototype={areaStart:noop$1,areaEnd:noop$1,lineStart:function lineStart(){this._point=0},lineEnd:function lineEnd(){if(this._point)this._context.closePath()},point:function point(x,y){x=+x,y=+y;if(this._point)this._context.lineTo(x,y);else this._point=1,this._context.moveTo(x,y)}};function curveLinearClosed(context){return new LinearClosed(context)}function sign(x){return x<0?-1:1}function slope3(that,x2,y2){var h0=that._x1-that._x0,h1=x2-that._x1,s0=(that._y1-that._y0)/(h0||h1<0&&-0),s1=(y2-that._y1)/(h1||h0<0&&-0),p=(s0*h1+s1*h0)/(h0+h1);return(sign(s0)+sign(s1))*Math.min(Math.abs(s0),Math.abs(s1),.5*Math.abs(p))||0}function slope2(that,t){var h=that._x1-that._x0;return h?(3*(that._y1-that._y0)/h-t)/2:t}function _point$3(that,t0,t1){var x0=that._x0,y0=that._y0,x1=that._x1,y1=that._y1,dx=(x1-x0)/3;that._context.bezierCurveTo(x0+dx,y0+dx*t0,x1-dx,y1-dx*t1,x1,y1)}function MonotoneX(context){this._context=context}MonotoneX.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._x0=this._x1=this._y0=this._y1=this._t0=NaN;this._point=0},lineEnd:function lineEnd(){switch(this._point){case 2:this._context.lineTo(this._x1,this._y1);break;case 3:_point$3(this,this._t0,slope2(this,this._t0));break}if(this._line||this._line!==0&&this._point===1)this._context.closePath();this._line=1-this._line},point:function point(x,y){var t1=NaN;x=+x,y=+y;if(x===this._x1&&y===this._y1)return;switch(this._point){case 0:this._point=1;this._line?this._context.lineTo(x,y):this._context.moveTo(x,y);break;case 1:this._point=2;break;case 2:this._point=3;_point$3(this,slope2(this,t1=slope3(this,x,y)),t1);break;default:_point$3(this,this._t0,t1=slope3(this,x,y));break}this._x0=this._x1,this._x1=x;this._y0=this._y1,this._y1=y;this._t0=t1}};function MonotoneY(context){this._context=new ReflectContext(context)}(MonotoneY.prototype=Object.create(MonotoneX.prototype)).point=function(x,y){MonotoneX.prototype.point.call(this,y,x)};function ReflectContext(context){this._context=context}ReflectContext.prototype={moveTo:function moveTo(x,y){this._context.moveTo(y,x)},closePath:function closePath(){this._context.closePath()},lineTo:function lineTo(x,y){this._context.lineTo(y,x)},bezierCurveTo:function bezierCurveTo(x1,y1,x2,y2,x,y){this._context.bezierCurveTo(y1,x1,y2,x2,y,x)}};function monotoneX(context){return new MonotoneX(context)}function monotoneY(context){return new MonotoneY(context)}function Natural(context){this._context=context}Natural.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._x=[];this._y=[]},lineEnd:function lineEnd(){var x=this._x,y=this._y,n=x.length;if(n){this._line?this._context.lineTo(x[0],y[0]):this._context.moveTo(x[0],y[0]);if(n===2){this._context.lineTo(x[1],y[1])}else{var px=controlPoints(x),py=controlPoints(y);for(var i0=0,i1=1;i1<n;++i0,++i1){this._context.bezierCurveTo(px[0][i0],py[0][i0],px[1][i0],py[1][i0],x[i1],y[i1])}}}if(this._line||this._line!==0&&n===1)this._context.closePath();this._line=1-this._line;this._x=this._y=null},point:function point(x,y){this._x.push(+x);this._y.push(+y)}};function controlPoints(x){var i,n=x.length-1,m,a=new Array(n),b=new Array(n),r=new Array(n);a[0]=0,b[0]=2,r[0]=x[0]+2*x[1];for(i=1;i<n-1;++i){a[i]=1,b[i]=4,r[i]=4*x[i]+2*x[i+1]}a[n-1]=2,b[n-1]=7,r[n-1]=8*x[n-1]+x[n];for(i=1;i<n;++i){m=a[i]/b[i-1],b[i]-=m,r[i]-=m*r[i-1]}a[n-1]=r[n-1]/b[n-1];for(i=n-2;i>=0;--i){a[i]=(r[i]-a[i+1])/b[i]}b[n-1]=(x[n]+a[n-1])/2;for(i=0;i<n-1;++i){b[i]=2*x[i+1]-a[i+1]}return[a,b]}function curveNatural(context){return new Natural(context)}function Step(context,t){this._context=context;this._t=t}Step.prototype={areaStart:function areaStart(){this._line=0},areaEnd:function areaEnd(){this._line=NaN},lineStart:function lineStart(){this._x=this._y=NaN;this._point=0},lineEnd:function lineEnd(){if(0<this._t&&this._t<1&&this._point===2)this._context.lineTo(this._x,this._y);if(this._line||this._line!==0&&this._point===1)this._context.closePath();if(this._line>=0)this._t=1-this._t,this._line=1-this._line},point:function point(x,y){x=+x,y=+y;switch(this._point){case 0:this._point=1;this._line?this._context.lineTo(x,y):this._context.moveTo(x,y);break;case 1:this._point=2;default:{if(this._t<=0){this._context.lineTo(this._x,y);this._context.lineTo(x,y)}else{var x1=this._x*(1-this._t)+x*this._t;this._context.lineTo(x1,this._y);this._context.lineTo(x1,y)}break}}this._x=x,this._y=y}};function curveStep(context){return new Step(context,.5)}function stepBefore(context){return new Step(context,0)}function stepAfter(context){return new Step(context,1)}function domCanvas(w,h){if(typeof document!=="undefined"&&document.createElement){var c=document.createElement("canvas");if(c&&c.getContext){c.width=w;c.height=h;return c}}return null}var domImage=function domImage(){return typeof Image!=="undefined"?Image:null};function initRange(domain,range){switch(arguments.length){case 0:break;case 1:this.range(domain);break;default:this.range(range).domain(domain);break}return this}function initInterpolator(domain,interpolator){switch(arguments.length){case 0:break;case 1:{if(typeof domain==="function")this.interpolator(domain);else this.range(domain);break}default:{this.domain(domain);if(typeof interpolator==="function")this.interpolator(interpolator);else this.range(interpolator);break}}return this}var implicit=Symbol("implicit");function ordinal(){var index=new Map,domain=[],range=[],unknown=implicit;function scale(d){var key=d+"",i=index.get(key);if(!i){if(unknown!==implicit)return unknown;index.set(key,i=domain.push(d))}return range[(i-1)%range.length]}scale.domain=function(_){if(!arguments.length)return domain.slice();domain=[],index=new Map;var _iterator=_createForOfIteratorHelper(_),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var value=_step.value;var key=value+"";if(index.has(key))continue;index.set(key,domain.push(value))}}catch(err){_iterator.e(err)}finally{_iterator.f()}return scale};scale.range=function(_){return arguments.length?(range=Array.from(_),scale):range.slice()};scale.unknown=function(_){return arguments.length?(unknown=_,scale):unknown};scale.copy=function(){return ordinal(domain,range).unknown(unknown)};initRange.apply(scale,arguments);return scale}function define(constructor,factory,prototype){constructor.prototype=factory.prototype=prototype;prototype.constructor=constructor}function extend$1(parent,definition){var prototype=Object.create(parent.prototype);for(var key in definition){prototype[key]=definition[key]}return prototype}function Color(){}var _darker=.7;var _brighter=1/_darker;var reI="\\s*([+-]?\\d+)\\s*",reN="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\s*",reP="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)%\\s*",reHex=/^#([0-9a-f]{3,8})$/,reRgbInteger=new RegExp("^rgb\\("+[reI,reI,reI]+"\\)$"),reRgbPercent=new RegExp("^rgb\\("+[reP,reP,reP]+"\\)$"),reRgbaInteger=new RegExp("^rgba\\("+[reI,reI,reI,reN]+"\\)$"),reRgbaPercent=new RegExp("^rgba\\("+[reP,reP,reP,reN]+"\\)$"),reHslPercent=new RegExp("^hsl\\("+[reN,reP,reP]+"\\)$"),reHslaPercent=new RegExp("^hsla\\("+[reN,reP,reP,reN]+"\\)$");var named={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};define(Color,color,{copy:function copy(channels){return Object.assign(new this.constructor,this,channels)},displayable:function displayable(){return this.rgb().displayable()},hex:color_formatHex,formatHex:color_formatHex,formatHsl:color_formatHsl,formatRgb:color_formatRgb,toString:color_formatRgb});function color_formatHex(){return this.rgb().formatHex()}function color_formatHsl(){return hslConvert(this).formatHsl()}function color_formatRgb(){return this.rgb().formatRgb()}function color(format){var m,l;format=(format+"").trim().toLowerCase();return(m=reHex.exec(format))?(l=m[1].length,m=parseInt(m[1],16),l===6?rgbn(m):l===3?new Rgb(m>>8&15|m>>4&240,m>>4&15|m&240,(m&15)<<4|m&15,1):l===8?rgba(m>>24&255,m>>16&255,m>>8&255,(m&255)/255):l===4?rgba(m>>12&15|m>>8&240,m>>8&15|m>>4&240,m>>4&15|m&240,((m&15)<<4|m&15)/255):null):(m=reRgbInteger.exec(format))?new Rgb(m[1],m[2],m[3],1):(m=reRgbPercent.exec(format))?new Rgb(m[1]*255/100,m[2]*255/100,m[3]*255/100,1):(m=reRgbaInteger.exec(format))?rgba(m[1],m[2],m[3],m[4]):(m=reRgbaPercent.exec(format))?rgba(m[1]*255/100,m[2]*255/100,m[3]*255/100,m[4]):(m=reHslPercent.exec(format))?hsla(m[1],m[2]/100,m[3]/100,1):(m=reHslaPercent.exec(format))?hsla(m[1],m[2]/100,m[3]/100,m[4]):named.hasOwnProperty(format)?rgbn(named[format]):format==="transparent"?new Rgb(NaN,NaN,NaN,0):null}function rgbn(n){return new Rgb(n>>16&255,n>>8&255,n&255,1)}function rgba(r,g,b,a){if(a<=0)r=g=b=NaN;return new Rgb(r,g,b,a)}function rgbConvert(o){if(!(o instanceof Color))o=color(o);if(!o)return new Rgb;o=o.rgb();return new Rgb(o.r,o.g,o.b,o.opacity)}function rgb(r,g,b,opacity){return arguments.length===1?rgbConvert(r):new Rgb(r,g,b,opacity==null?1:opacity)}function Rgb(r,g,b,opacity){this.r=+r;this.g=+g;this.b=+b;this.opacity=+opacity}define(Rgb,rgb,extend$1(Color,{brighter:function brighter(k){k=k==null?_brighter:Math.pow(_brighter,k);return new Rgb(this.r*k,this.g*k,this.b*k,this.opacity)},darker:function darker(k){k=k==null?_darker:Math.pow(_darker,k);return new Rgb(this.r*k,this.g*k,this.b*k,this.opacity)},rgb:function rgb(){return this},displayable:function displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:rgb_formatHex,formatHex:rgb_formatHex,formatRgb:rgb_formatRgb,toString:rgb_formatRgb}));function rgb_formatHex(){return"#"+hex(this.r)+hex(this.g)+hex(this.b)}function rgb_formatRgb(){var a=this.opacity;a=isNaN(a)?1:Math.max(0,Math.min(1,a));return(a===1?"rgb(":"rgba(")+Math.max(0,Math.min(255,Math.round(this.r)||0))+", "+Math.max(0,Math.min(255,Math.round(this.g)||0))+", "+Math.max(0,Math.min(255,Math.round(this.b)||0))+(a===1?")":", "+a+")")}function hex(value){value=Math.max(0,Math.min(255,Math.round(value)||0));return(value<16?"0":"")+value.toString(16)}function hsla(h,s,l,a){if(a<=0)h=s=l=NaN;else if(l<=0||l>=1)h=s=NaN;else if(s<=0)h=NaN;return new Hsl(h,s,l,a)}function hslConvert(o){if(o instanceof Hsl)return new Hsl(o.h,o.s,o.l,o.opacity);if(!(o instanceof Color))o=color(o);if(!o)return new Hsl;if(o instanceof Hsl)return o;o=o.rgb();var r=o.r/255,g=o.g/255,b=o.b/255,min=Math.min(r,g,b),max=Math.max(r,g,b),h=NaN,s=max-min,l=(max+min)/2;if(s){if(r===max)h=(g-b)/s+(g<b)*6;else if(g===max)h=(b-r)/s+2;else h=(r-g)/s+4;s/=l<.5?max+min:2-max-min;h*=60}else{s=l>0&&l<1?0:h}return new Hsl(h,s,l,o.opacity)}function hsl(h,s,l,opacity){return arguments.length===1?hslConvert(h):new Hsl(h,s,l,opacity==null?1:opacity)}function Hsl(h,s,l,opacity){this.h=+h;this.s=+s;this.l=+l;this.opacity=+opacity}define(Hsl,hsl,extend$1(Color,{brighter:function brighter(k){k=k==null?_brighter:Math.pow(_brighter,k);return new Hsl(this.h,this.s,this.l*k,this.opacity)},darker:function darker(k){k=k==null?_darker:Math.pow(_darker,k);return new Hsl(this.h,this.s,this.l*k,this.opacity)},rgb:function rgb(){var h=this.h%360+(this.h<0)*360,s=isNaN(h)||isNaN(this.s)?0:this.s,l=this.l,m2=l+(l<.5?l:1-l)*s,m1=2*l-m2;return new Rgb(hsl2rgb(h>=240?h-240:h+120,m1,m2),hsl2rgb(h,m1,m2),hsl2rgb(h<120?h+240:h-120,m1,m2),this.opacity)},displayable:function displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl:function formatHsl(){var a=this.opacity;a=isNaN(a)?1:Math.max(0,Math.min(1,a));return(a===1?"hsl(":"hsla(")+(this.h||0)+", "+(this.s||0)*100+"%, "+(this.l||0)*100+"%"+(a===1?")":", "+a+")")}}));function hsl2rgb(h,m1,m2){return(h<60?m1+(m2-m1)*h/60:h<180?m2:h<240?m1+(m2-m1)*(240-h)/60:m1)*255}var radians=Math.PI/180;var degrees=180/Math.PI;var K=18,Xn=.96422,Yn=1,Zn=.82521,t0$2=4/29,t1$1=6/29,t2=3*t1$1*t1$1,t3=t1$1*t1$1*t1$1;function labConvert(o){if(o instanceof Lab)return new Lab(o.l,o.a,o.b,o.opacity);if(o instanceof Hcl)return hcl2lab(o);if(!(o instanceof Rgb))o=rgbConvert(o);var r=rgb2lrgb(o.r),g=rgb2lrgb(o.g),b=rgb2lrgb(o.b),y=xyz2lab((.2225045*r+.7168786*g+.0606169*b)/Yn),x,z;if(r===g&&g===b)x=z=y;else{x=xyz2lab((.4360747*r+.3850649*g+.1430804*b)/Xn);z=xyz2lab((.0139322*r+.0971045*g+.7141733*b)/Zn)}return new Lab(116*y-16,500*(x-y),200*(y-z),o.opacity)}function lab(l,a,b,opacity){return arguments.length===1?labConvert(l):new Lab(l,a,b,opacity==null?1:opacity)}function Lab(l,a,b,opacity){this.l=+l;this.a=+a;this.b=+b;this.opacity=+opacity}define(Lab,lab,extend$1(Color,{brighter:function brighter(k){return new Lab(this.l+K*(k==null?1:k),this.a,this.b,this.opacity)},darker:function darker(k){return new Lab(this.l-K*(k==null?1:k),this.a,this.b,this.opacity)},rgb:function rgb(){var y=(this.l+16)/116,x=isNaN(this.a)?y:y+this.a/500,z=isNaN(this.b)?y:y-this.b/200;x=Xn*lab2xyz(x);y=Yn*lab2xyz(y);z=Zn*lab2xyz(z);return new Rgb(lrgb2rgb(3.1338561*x-1.6168667*y-.4906146*z),lrgb2rgb(-.9787684*x+1.9161415*y+.033454*z),lrgb2rgb(.0719453*x-.2289914*y+1.4052427*z),this.opacity)}}));function xyz2lab(t){return t>t3?Math.pow(t,1/3):t/t2+t0$2}function lab2xyz(t){return t>t1$1?t*t*t:t2*(t-t0$2)}function lrgb2rgb(x){return 255*(x<=.0031308?12.92*x:1.055*Math.pow(x,1/2.4)-.055)}function rgb2lrgb(x){return(x/=255)<=.04045?x/12.92:Math.pow((x+.055)/1.055,2.4)}function hclConvert(o){if(o instanceof Hcl)return new Hcl(o.h,o.c,o.l,o.opacity);if(!(o instanceof Lab))o=labConvert(o);if(o.a===0&&o.b===0)return new Hcl(NaN,0<o.l&&o.l<100?0:NaN,o.l,o.opacity);var h=Math.atan2(o.b,o.a)*degrees;return new Hcl(h<0?h+360:h,Math.sqrt(o.a*o.a+o.b*o.b),o.l,o.opacity)}function hcl(h,c,l,opacity){return arguments.length===1?hclConvert(h):new Hcl(h,c,l,opacity==null?1:opacity)}function Hcl(h,c,l,opacity){this.h=+h;this.c=+c;this.l=+l;this.opacity=+opacity}function hcl2lab(o){if(isNaN(o.h))return new Lab(o.l,0,0,o.opacity);var h=o.h*radians;return new Lab(o.l,Math.cos(h)*o.c,Math.sin(h)*o.c,o.opacity)}define(Hcl,hcl,extend$1(Color,{brighter:function brighter(k){return new Hcl(this.h,this.c,this.l+K*(k==null?1:k),this.opacity)},darker:function darker(k){return new Hcl(this.h,this.c,this.l-K*(k==null?1:k),this.opacity)},rgb:function rgb(){return hcl2lab(this).rgb()}}));var A=-.14861,B=+1.78277,C=-.29227,D=-.90649,E=+1.97294,ED=E*D,EB=E*B,BC_DA=B*C-D*A;function cubehelixConvert(o){if(o instanceof Cubehelix)return new Cubehelix(o.h,o.s,o.l,o.opacity);if(!(o instanceof Rgb))o=rgbConvert(o);var r=o.r/255,g=o.g/255,b=o.b/255,l=(BC_DA*b+ED*r-EB*g)/(BC_DA+ED-EB),bl=b-l,k=(E*(g-l)-C*bl)/D,s=Math.sqrt(k*k+bl*bl)/(E*l*(1-l)),h=s?Math.atan2(k,bl)*degrees-120:NaN;return new Cubehelix(h<0?h+360:h,s,l,o.opacity)}function cubehelix(h,s,l,opacity){return arguments.length===1?cubehelixConvert(h):new Cubehelix(h,s,l,opacity==null?1:opacity)}function Cubehelix(h,s,l,opacity){this.h=+h;this.s=+s;this.l=+l;this.opacity=+opacity}define(Cubehelix,cubehelix,extend$1(Color,{brighter:function brighter(k){k=k==null?_brighter:Math.pow(_brighter,k);return new Cubehelix(this.h,this.s,this.l*k,this.opacity)},darker:function darker(k){k=k==null?_darker:Math.pow(_darker,k);return new Cubehelix(this.h,this.s,this.l*k,this.opacity)},rgb:function rgb(){var h=isNaN(this.h)?0:(this.h+120)*radians,l=+this.l,a=isNaN(this.s)?0:this.s*l*(1-l),cosh=Math.cos(h),sinh=Math.sin(h);return new Rgb(255*(l+a*(A*cosh+B*sinh)),255*(l+a*(C*cosh+D*sinh)),255*(l+a*(E*cosh)),this.opacity)}}));function basis(t1,v0,v1,v2,v3){var t2=t1*t1,t3=t2*t1;return((1-3*t1+3*t2-t3)*v0+(4-6*t2+3*t3)*v1+(1+3*t1+3*t2-3*t3)*v2+t3*v3)/6}function basis$1(values){var n=values.length-1;return function(t){var i=t<=0?t=0:t>=1?(t=1,n-1):Math.floor(t*n),v1=values[i],v2=values[i+1],v0=i>0?values[i-1]:2*v1-v2,v3=i<n-1?values[i+2]:2*v2-v1;return basis((t-i/n)*n,v0,v1,v2,v3)}}function basisClosed(values){var n=values.length;return function(t){var i=Math.floor(((t%=1)<0?++t:t)*n),v0=values[(i+n-1)%n],v1=values[i%n],v2=values[(i+1)%n],v3=values[(i+2)%n];return basis((t-i/n)*n,v0,v1,v2,v3)}}var constant$2=function(x){return function(){return x}};function linear$1(a,d){return function(t){return a+t*d}}function exponential(a,b,y){return a=Math.pow(a,y),b=Math.pow(b,y)-a,y=1/y,function(t){return Math.pow(a+t*b,y)}}function hue(a,b){var d=b-a;return d?linear$1(a,d>180||d<-180?d-360*Math.round(d/360):d):constant$2(isNaN(a)?b:a)}function gamma(y){return(y=+y)===1?nogamma:function(a,b){return b-a?exponential(a,b,y):constant$2(isNaN(a)?b:a)}}function nogamma(a,b){var d=b-a;return d?linear$1(a,d):constant$2(isNaN(a)?b:a)}var rgb$1=function rgbGamma(y){var color=gamma(y);function rgb$1(start,end){var r=color((start=rgb(start)).r,(end=rgb(end)).r),g=color(start.g,end.g),b=color(start.b,end.b),opacity=nogamma(start.opacity,end.opacity);return function(t){start.r=r(t);start.g=g(t);start.b=b(t);start.opacity=opacity(t);return start+""}}rgb$1.gamma=rgbGamma;return rgb$1}(1);function rgbSpline(spline){return function(colors){var n=colors.length,r=new Array(n),g=new Array(n),b=new Array(n),i,color;for(i=0;i<n;++i){color=rgb(colors[i]);r[i]=color.r||0;g[i]=color.g||0;b[i]=color.b||0}r=spline(r);g=spline(g);b=spline(b);color.opacity=1;return function(t){color.r=r(t);color.g=g(t);color.b=b(t);return color+""}}}var rgbBasis=rgbSpline(basis$1);var rgbBasisClosed=rgbSpline(basisClosed);function numberArray(a,b){if(!b)b=[];var n=a?Math.min(b.length,a.length):0,c=b.slice(),i;return function(t){for(i=0;i<n;++i){c[i]=a[i]*(1-t)+b[i]*t}return c}}function isNumberArray(x){return ArrayBuffer.isView(x)&&!(x instanceof DataView)}function array$2(a,b){return(isNumberArray(b)?numberArray:genericArray)(a,b)}function genericArray(a,b){var nb=b?b.length:0,na=a?Math.min(nb,a.length):0,x=new Array(na),c=new Array(nb),i;for(i=0;i<na;++i){x[i]=interpolate$1(a[i],b[i])}for(;i<nb;++i){c[i]=b[i]}return function(t){for(i=0;i<na;++i){c[i]=x[i](t)}return c}}function date(a,b){var d=new Date;return a=+a,b=+b,function(t){return d.setTime(a*(1-t)+b*t),d}}function interpolateNumber(a,b){return a=+a,b=+b,function(t){return a*(1-t)+b*t}}function object$1(a,b){var i={},c={},k;if(a===null||_typeof(a)!=="object")a={};if(b===null||_typeof(b)!=="object")b={};for(k in b){if(k in a){i[k]=interpolate$1(a[k],b[k])}else{c[k]=b[k]}}return function(t){for(k in i){c[k]=i[k](t)}return c}}var reA=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,reB=new RegExp(reA.source,"g");function zero$1(b){return function(){return b}}function one$1(b){return function(t){return b(t)+""}}function string(a,b){var bi=reA.lastIndex=reB.lastIndex=0,am,bm,bs,i=-1,s=[],q=[];a=a+"",b=b+"";while((am=reA.exec(a))&&(bm=reB.exec(b))){if((bs=bm.index)>bi){bs=b.slice(bi,bs);if(s[i])s[i]+=bs;else s[++i]=bs}if((am=am[0])===(bm=bm[0])){if(s[i])s[i]+=bm;else s[++i]=bm}else{s[++i]=null;q.push({i:i,x:interpolateNumber(am,bm)})}bi=reB.lastIndex}if(bi<b.length){bs=b.slice(bi);if(s[i])s[i]+=bs;else s[++i]=bs}return s.length<2?q[0]?one$1(q[0].x):zero$1(b):(b=q.length,function(t){for(var i=0,o;i<b;++i){s[(o=q[i]).i]=o.x(t)}return s.join("")})}function interpolate$1(a,b){var t=_typeof(b),c;return b==null||t==="boolean"?constant$2(b):(t==="number"?interpolateNumber:t==="string"?(c=color(b))?(b=c,rgb$1):string:b instanceof color?rgb$1:b instanceof Date?date:isNumberArray(b)?numberArray:Array.isArray(b)?genericArray:typeof b.valueOf!=="function"&&typeof b.toString!=="function"||isNaN(b)?object$1:interpolateNumber)(a,b)}function discrete(range){var n=range.length;return function(t){return range[Math.max(0,Math.min(n-1,Math.floor(t*n)))]}}function hue$1(a,b){var i=hue(+a,+b);return function(t){var x=i(t);return x-360*Math.floor(x/360)}}function interpolateRound(a,b){return a=+a,b=+b,function(t){return Math.round(a*(1-t)+b*t)}}var degrees$1=180/Math.PI;var identity$3={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function decompose(a,b,c,d,e,f){var scaleX,scaleY,skewX;if(scaleX=Math.sqrt(a*a+b*b))a/=scaleX,b/=scaleX;if(skewX=a*c+b*d)c-=a*skewX,d-=b*skewX;if(scaleY=Math.sqrt(c*c+d*d))c/=scaleY,d/=scaleY,skewX/=scaleY;if(a*d<b*c)a=-a,b=-b,skewX=-skewX,scaleX=-scaleX;return{translateX:e,translateY:f,rotate:Math.atan2(b,a)*degrees$1,skewX:Math.atan(skewX)*degrees$1,scaleX:scaleX,scaleY:scaleY}}var svgNode;function parseCss(value){var m=new(typeof DOMMatrix==="function"?DOMMatrix:WebKitCSSMatrix)(value+"");return m.isIdentity?identity$3:decompose(m.a,m.b,m.c,m.d,m.e,m.f)}function parseSvg(value){if(value==null)return identity$3;if(!svgNode)svgNode=document.createElementNS("http://www.w3.org/2000/svg","g");svgNode.setAttribute("transform",value);if(!(value=svgNode.transform.baseVal.consolidate()))return identity$3;value=value.matrix;return decompose(value.a,value.b,value.c,value.d,value.e,value.f)}function interpolateTransform(parse,pxComma,pxParen,degParen){function pop(s){return s.length?s.pop()+" ":""}function translate(xa,ya,xb,yb,s,q){if(xa!==xb||ya!==yb){var i=s.push("translate(",null,pxComma,null,pxParen);q.push({i:i-4,x:interpolateNumber(xa,xb)},{i:i-2,x:interpolateNumber(ya,yb)})}else if(xb||yb){s.push("translate("+xb+pxComma+yb+pxParen)}}function rotate(a,b,s,q){if(a!==b){if(a-b>180)b+=360;else if(b-a>180)a+=360;q.push({i:s.push(pop(s)+"rotate(",null,degParen)-2,x:interpolateNumber(a,b)})}else if(b){s.push(pop(s)+"rotate("+b+degParen)}}function skewX(a,b,s,q){if(a!==b){q.push({i:s.push(pop(s)+"skewX(",null,degParen)-2,x:interpolateNumber(a,b)})}else if(b){s.push(pop(s)+"skewX("+b+degParen)}}function scale(xa,ya,xb,yb,s,q){if(xa!==xb||ya!==yb){var i=s.push(pop(s)+"scale(",null,",",null,")");q.push({i:i-4,x:interpolateNumber(xa,xb)},{i:i-2,x:interpolateNumber(ya,yb)})}else if(xb!==1||yb!==1){s.push(pop(s)+"scale("+xb+","+yb+")")}}return function(a,b){var s=[],q=[];a=parse(a),b=parse(b);translate(a.translateX,a.translateY,b.translateX,b.translateY,s,q);rotate(a.rotate,b.rotate,s,q);skewX(a.skewX,b.skewX,s,q);scale(a.scaleX,a.scaleY,b.scaleX,b.scaleY,s,q);a=b=null;return function(t){var i=-1,n=q.length,o;while(++i<n){s[(o=q[i]).i]=o.x(t)}return s.join("")}}}var interpolateTransformCss=interpolateTransform(parseCss,"px, ","px)","deg)");var interpolateTransformSvg=interpolateTransform(parseSvg,", ",")",")");var epsilon2=1e-12;function cosh(x){return((x=Math.exp(x))+1/x)/2}function sinh(x){return((x=Math.exp(x))-1/x)/2}function tanh(x){return((x=Math.exp(2*x))-1)/(x+1)}var zoom$1=function zoomRho(rho,rho2,rho4){function zoom(p0,p1){var ux0=p0[0],uy0=p0[1],w0=p0[2],ux1=p1[0],uy1=p1[1],w1=p1[2],dx=ux1-ux0,dy=uy1-uy0,d2=dx*dx+dy*dy,i,S;if(d2<epsilon2){S=Math.log(w1/w0)/rho;i=function i(t){return[ux0+t*dx,uy0+t*dy,w0*Math.exp(rho*t*S)]}}else{var d1=Math.sqrt(d2),b0=(w1*w1-w0*w0+rho4*d2)/(2*w0*rho2*d1),b1=(w1*w1-w0*w0-rho4*d2)/(2*w1*rho2*d1),r0=Math.log(Math.sqrt(b0*b0+1)-b0),r1=Math.log(Math.sqrt(b1*b1+1)-b1);S=(r1-r0)/rho;i=function i(t){var s=t*S,coshr0=cosh(r0),u=w0/(rho2*d1)*(coshr0*tanh(rho*s+r0)-sinh(r0));return[ux0+u*dx,uy0+u*dy,w0*coshr0/cosh(rho*s+r0)]}}i.duration=S*1e3*rho/Math.SQRT2;return i}zoom.rho=function(_){var _1=Math.max(.001,+_),_2=_1*_1,_4=_2*_2;return zoomRho(_1,_2,_4)};return zoom}(Math.SQRT2,2,4);function hsl$1(hue){return function(start,end){var h=hue((start=hsl(start)).h,(end=hsl(end)).h),s=nogamma(start.s,end.s),l=nogamma(start.l,end.l),opacity=nogamma(start.opacity,end.opacity);return function(t){start.h=h(t);start.s=s(t);start.l=l(t);start.opacity=opacity(t);return start+""}}}var hsl$2=hsl$1(hue);var hslLong=hsl$1(nogamma);function lab$1(start,end){var l=nogamma((start=lab(start)).l,(end=lab(end)).l),a=nogamma(start.a,end.a),b=nogamma(start.b,end.b),opacity=nogamma(start.opacity,end.opacity);return function(t){start.l=l(t);start.a=a(t);start.b=b(t);start.opacity=opacity(t);return start+""}}function hcl$1(hue){return function(start,end){var h=hue((start=hcl(start)).h,(end=hcl(end)).h),c=nogamma(start.c,end.c),l=nogamma(start.l,end.l),opacity=nogamma(start.opacity,end.opacity);return function(t){start.h=h(t);start.c=c(t);start.l=l(t);start.opacity=opacity(t);return start+""}}}var hcl$2=hcl$1(hue);var hclLong=hcl$1(nogamma);function cubehelix$1(hue){return function cubehelixGamma(y){y=+y;function cubehelix$1(start,end){var h=hue((start=cubehelix(start)).h,(end=cubehelix(end)).h),s=nogamma(start.s,end.s),l=nogamma(start.l,end.l),opacity=nogamma(start.opacity,end.opacity);return function(t){start.h=h(t);start.s=s(t);start.l=l(Math.pow(t,y));start.opacity=opacity(t);return start+""}}cubehelix$1.gamma=cubehelixGamma;return cubehelix$1}(1)}var cubehelix$2=cubehelix$1(hue);var cubehelixLong=cubehelix$1(nogamma);function piecewise(interpolate,values){if(values===undefined)values=interpolate,interpolate=interpolate$1;var i=0,n=values.length-1,v=values[0],I=new Array(n<0?0:n);while(i<n){I[i]=interpolate(v,v=values[++i])}return function(t){var i=Math.max(0,Math.min(n-1,Math.floor(t*=n)));return I[i](t-i)}}function quantize(interpolator,n){var samples=new Array(n);for(var i=0;i<n;++i){samples[i]=interpolator(i/(n-1))}return samples}var $$1=Object.freeze({__proto__:null,interpolate:interpolate$1,interpolateArray:array$2,interpolateBasis:basis$1,interpolateBasisClosed:basisClosed,interpolateDate:date,interpolateDiscrete:discrete,interpolateHue:hue$1,interpolateNumber:interpolateNumber,interpolateNumberArray:numberArray,interpolateObject:object$1,interpolateRound:interpolateRound,interpolateString:string,interpolateTransformCss:interpolateTransformCss,interpolateTransformSvg:interpolateTransformSvg,interpolateZoom:zoom$1,interpolateRgb:rgb$1,interpolateRgbBasis:rgbBasis,interpolateRgbBasisClosed:rgbBasisClosed,interpolateHsl:hsl$2,interpolateHslLong:hslLong,interpolateLab:lab$1,interpolateHcl:hcl$2,interpolateHclLong:hclLong,interpolateCubehelix:cubehelix$2,interpolateCubehelixLong:cubehelixLong,piecewise:piecewise,quantize:quantize});function constants(x){return function(){return x}}function number$1(x){return+x}var unit=[0,1];function identity$4(x){return x}function normalize(a,b){return(b-=a=+a)?function(x){return(x-a)/b}:constants(isNaN(b)?NaN:.5)}function clamper(a,b){var t;if(a>b)t=a,a=b,b=t;return function(x){return Math.max(a,Math.min(b,x))}}function bimap(domain,range,interpolate){var d0=domain[0],d1=domain[1],r0=range[0],r1=range[1];if(d1<d0)d0=normalize(d1,d0),r0=interpolate(r1,r0);else d0=normalize(d0,d1),r0=interpolate(r0,r1);return function(x){return r0(d0(x))}}function polymap(domain,range,interpolate){var j=Math.min(domain.length,range.length)-1,d=new Array(j),r=new Array(j),i=-1;if(domain[j]<domain[0]){domain=domain.slice().reverse();range=range.slice().reverse()}while(++i<j){d[i]=normalize(domain[i],domain[i+1]);r[i]=interpolate(range[i],range[i+1])}return function(x){var i=bisectRight(domain,x,1,j)-1;return r[i](d[i](x))}}function copy(source,target){return target.domain(source.domain()).range(source.range()).interpolate(source.interpolate()).clamp(source.clamp()).unknown(source.unknown())}function transformer(){var domain=unit,range=unit,interpolate=interpolate$1,transform,untransform,unknown,clamp=identity$4,piecewise,output,input;function rescale(){var n=Math.min(domain.length,range.length);if(clamp!==identity$4)clamp=clamper(domain[0],domain[n-1]);piecewise=n>2?polymap:bimap;output=input=null;return scale}function scale(x){return isNaN(x=+x)?unknown:(output||(output=piecewise(domain.map(transform),range,interpolate)))(transform(clamp(x)))}scale.invert=function(y){return clamp(untransform((input||(input=piecewise(range,domain.map(transform),interpolateNumber)))(y)))};scale.domain=function(_){return arguments.length?(domain=Array.from(_,number$1),rescale()):domain.slice()};scale.range=function(_){return arguments.length?(range=Array.from(_),rescale()):range.slice()};scale.rangeRound=function(_){return range=Array.from(_),interpolate=interpolateRound,rescale()};scale.clamp=function(_){return arguments.length?(clamp=_?true:identity$4,rescale()):clamp!==identity$4};scale.interpolate=function(_){return arguments.length?(interpolate=_,rescale()):interpolate};scale.unknown=function(_){return arguments.length?(unknown=_,scale):unknown};return function(t,u){transform=t,untransform=u;return rescale()}}function continuous(){return transformer()(identity$4,identity$4)}function tickFormat(start,stop,count,specifier){var step=tickStep(start,stop,count),precision;specifier=formatSpecifier(specifier==null?",f":specifier);switch(specifier.type){case"s":{var value=Math.max(Math.abs(start),Math.abs(stop));if(specifier.precision==null&&!isNaN(precision=precisionPrefix(step,value)))specifier.precision=precision;return formatPrefix(specifier,value)}case"":case"e":case"g":case"p":case"r":{if(specifier.precision==null&&!isNaN(precision=precisionRound(step,Math.max(Math.abs(start),Math.abs(stop)))))specifier.precision=precision-(specifier.type==="e");break}case"f":case"%":{if(specifier.precision==null&&!isNaN(precision=precisionFixed(step)))specifier.precision=precision-(specifier.type==="%")*2;break}}return format$1(specifier)}function linearish(scale){var domain=scale.domain;scale.ticks=function(count){var d=domain();return ticks(d[0],d[d.length-1],count==null?10:count)};scale.tickFormat=function(count,specifier){var d=domain();return tickFormat(d[0],d[d.length-1],count==null?10:count,specifier)};scale.nice=function(count){if(count==null)count=10;var d=domain();var i0=0;var i1=d.length-1;var start=d[i0];var stop=d[i1];var prestep;var step;var maxIter=10;if(stop<start){step=start,start=stop,stop=step;step=i0,i0=i1,i1=step}while(maxIter-- >0){step=tickIncrement(start,stop,count);if(step===prestep){d[i0]=start;d[i1]=stop;return domain(d)}else if(step>0){start=Math.floor(start/step)*step;stop=Math.ceil(stop/step)*step}else if(step<0){start=Math.ceil(start*step)/step;stop=Math.floor(stop*step)/step}else{break}prestep=step}return scale};return scale}function linear$2(){var scale=continuous();scale.copy=function(){return copy(scale,linear$2())};initRange.apply(scale,arguments);return linearish(scale)}function identity$5(domain){var unknown;function scale(x){return isNaN(x=+x)?unknown:x}scale.invert=scale;scale.domain=scale.range=function(_){return arguments.length?(domain=Array.from(_,number$1),scale):domain.slice()};scale.unknown=function(_){return arguments.length?(unknown=_,scale):unknown};scale.copy=function(){return identity$5(domain).unknown(unknown)};domain=arguments.length?Array.from(domain,number$1):[0,1];return linearish(scale)}function nice(domain,interval){domain=domain.slice();var i0=0,i1=domain.length-1,x0=domain[i0],x1=domain[i1],t;if(x1<x0){t=i0,i0=i1,i1=t;t=x0,x0=x1,x1=t}domain[i0]=interval.floor(x0);domain[i1]=interval.ceil(x1);return domain}function transformLog(x){return Math.log(x)}function transformExp(x){return Math.exp(x)}function transformLogn(x){return-Math.log(-x)}function transformExpn(x){return-Math.exp(-x)}function pow10(x){return isFinite(x)?+("1e"+x):x<0?0:x}function powp(base){return base===10?pow10:base===Math.E?Math.exp:function(x){return Math.pow(base,x)}}function logp(base){return base===Math.E?Math.log:base===10&&Math.log10||base===2&&Math.log2||(base=Math.log(base),function(x){return Math.log(x)/base})}function reflect(f){return function(x){return-f(-x)}}function loggish(transform){var scale=transform(transformLog,transformExp),domain=scale.domain,base=10,logs,pows;function rescale(){logs=logp(base),pows=powp(base);if(domain()[0]<0){logs=reflect(logs),pows=reflect(pows);transform(transformLogn,transformExpn)}else{transform(transformLog,transformExp)}return scale}scale.base=function(_){return arguments.length?(base=+_,rescale()):base};scale.domain=function(_){return arguments.length?(domain(_),rescale()):domain()};scale.ticks=function(count){var d=domain(),u=d[0],v=d[d.length-1],r;if(r=v<u)i=u,u=v,v=i;var i=logs(u),j=logs(v),p,k,t,n=count==null?10:+count,z=[];if(!(base%1)&&j-i<n){i=Math.floor(i),j=Math.ceil(j);if(u>0)for(;i<=j;++i){for(k=1,p=pows(i);k<base;++k){t=p*k;if(t<u)continue;if(t>v)break;z.push(t)}}else for(;i<=j;++i){for(k=base-1,p=pows(i);k>=1;--k){t=p*k;if(t<u)continue;if(t>v)break;z.push(t)}}if(z.length*2<n)z=ticks(u,v,n)}else{z=ticks(i,j,Math.min(j-i,n)).map(pows)}return r?z.reverse():z};scale.tickFormat=function(count,specifier){if(specifier==null)specifier=base===10?".0e":",";if(typeof specifier!=="function")specifier=format$1(specifier);if(count===Infinity)return specifier;if(count==null)count=10;var k=Math.max(1,base*count/scale.ticks().length);return function(d){var i=d/pows(Math.round(logs(d)));if(i*base<base-.5)i*=base;return i<=k?specifier(d):""}};scale.nice=function(){return domain(nice(domain(),{floor:function floor(x){return pows(Math.floor(logs(x)))},ceil:function ceil(x){return pows(Math.ceil(logs(x)))}}))};return scale}function log$3(){var scale=loggish(transformer()).domain([1,10]);scale.copy=function(){return copy(scale,log$3()).base(scale.base())};initRange.apply(scale,arguments);return scale}function transformSymlog(c){return function(x){return Math.sign(x)*Math.log1p(Math.abs(x/c))}}function transformSymexp(c){return function(x){return Math.sign(x)*Math.expm1(Math.abs(x))*c}}function symlogish(transform){var c=1,scale=transform(transformSymlog(c),transformSymexp(c));scale.constant=function(_){return arguments.length?transform(transformSymlog(c=+_),transformSymexp(c)):c};return linearish(scale)}function symlog$1(){var scale=symlogish(transformer());scale.copy=function(){return copy(scale,symlog$1()).constant(scale.constant())};return initRange.apply(scale,arguments)}function transformPow(exponent){return function(x){return x<0?-Math.pow(-x,exponent):Math.pow(x,exponent)}}function transformSqrt(x){return x<0?-Math.sqrt(-x):Math.sqrt(x)}function transformSquare(x){return x<0?-x*x:x*x}function powish(transform){var scale=transform(identity$4,identity$4),exponent=1;function rescale(){return exponent===1?transform(identity$4,identity$4):exponent===.5?transform(transformSqrt,transformSquare):transform(transformPow(exponent),transformPow(1/exponent))}scale.exponent=function(_){return arguments.length?(exponent=+_,rescale()):exponent};return linearish(scale)}function pow$2(){var scale=powish(transformer());scale.copy=function(){return copy(scale,pow$2()).exponent(scale.exponent())};initRange.apply(scale,arguments);return scale}function sqrt$1(){return pow$2.apply(null,arguments).exponent(.5)}function quantile$1(){var domain=[],range=[],thresholds=[],unknown;function rescale(){var i=0,n=Math.max(1,range.length);thresholds=new Array(n-1);while(++i<n){thresholds[i-1]=quantileSorted(domain,i/n)}return scale}function scale(x){return isNaN(x=+x)?unknown:range[bisectRight(thresholds,x)]}scale.invertExtent=function(y){var i=range.indexOf(y);return i<0?[NaN,NaN]:[i>0?thresholds[i-1]:domain[0],i<thresholds.length?thresholds[i]:domain[domain.length-1]]};scale.domain=function(_){if(!arguments.length)return domain.slice();domain=[];var _iterator=_createForOfIteratorHelper(_),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var d=_step.value;if(d!=null&&!isNaN(d=+d))domain.push(d)}}catch(err){_iterator.e(err)}finally{_iterator.f()}domain.sort(ascending$1);return rescale()};scale.range=function(_){return arguments.length?(range=Array.from(_),rescale()):range.slice()};scale.unknown=function(_){return arguments.length?(unknown=_,scale):unknown};scale.quantiles=function(){return thresholds.slice()};scale.copy=function(){return quantile$1().domain(domain).range(range).unknown(unknown)};return initRange.apply(scale,arguments)}function quantize$1(){var x0=0,x1=1,n=1,domain=[.5],range=[0,1],unknown;function scale(x){return x<=x?range[bisectRight(domain,x,0,n)]:unknown}function rescale(){var i=-1;domain=new Array(n);while(++i<n){domain[i]=((i+1)*x1-(i-n)*x0)/(n+1)}return scale}scale.domain=function(_){var _ref,_ref2;return arguments.length?(_ref=_,_ref2=_slicedToArray(_ref,2),x0=_ref2[0],x1=_ref2[1],_ref,x0=+x0,x1=+x1,rescale()):[x0,x1]};scale.range=function(_){return arguments.length?(n=(range=Array.from(_)).length-1,rescale()):range.slice()};scale.invertExtent=function(y){var i=range.indexOf(y);return i<0?[NaN,NaN]:i<1?[x0,domain[0]]:i>=n?[domain[n-1],x1]:[domain[i-1],domain[i]]};scale.unknown=function(_){return arguments.length?(unknown=_,scale):scale};scale.thresholds=function(){return domain.slice()};scale.copy=function(){return quantize$1().domain([x0,x1]).range(range).unknown(unknown)};return initRange.apply(linearish(scale),arguments)}function threshold(){var domain=[.5],range=[0,1],unknown,n=1;function scale(x){return x<=x?range[bisectRight(domain,x,0,n)]:unknown}scale.domain=function(_){return arguments.length?(domain=Array.from(_),n=Math.min(domain.length,range.length-1),scale):domain.slice()};scale.range=function(_){return arguments.length?(range=Array.from(_),n=Math.min(domain.length,range.length-1),scale):range.slice()};scale.invertExtent=function(y){var i=range.indexOf(y);return[domain[i-1],domain[i]]};scale.unknown=function(_){return arguments.length?(unknown=_,scale):unknown};scale.copy=function(){return threshold().domain(domain).range(range).unknown(unknown)};return initRange.apply(scale,arguments)}var durationSecond$2=1e3,durationMinute$2=durationSecond$2*60,durationHour$2=durationMinute$2*60,durationDay$2=durationHour$2*24,durationWeek$2=durationDay$2*7,durationMonth$1=durationDay$2*30,durationYear$1=durationDay$2*365;function date$1(t){return new Date(t)}function number$2(t){return t instanceof Date?+t:+new Date(+t)}function calendar(year,month,week,day,hour,minute,second,millisecond,format){var scale=continuous(),invert=scale.invert,domain=scale.domain;var formatMillisecond=format(".%L"),formatSecond=format(":%S"),formatMinute=format("%I:%M"),formatHour=format("%I %p"),formatDay=format("%a %d"),formatWeek=format("%b %d"),formatMonth=format("%B"),formatYear=format("%Y");var tickIntervals=[[second,1,durationSecond$2],[second,5,5*durationSecond$2],[second,15,15*durationSecond$2],[second,30,30*durationSecond$2],[minute,1,durationMinute$2],[minute,5,5*durationMinute$2],[minute,15,15*durationMinute$2],[minute,30,30*durationMinute$2],[hour,1,durationHour$2],[hour,3,3*durationHour$2],[hour,6,6*durationHour$2],[hour,12,12*durationHour$2],[day,1,durationDay$2],[day,2,2*durationDay$2],[week,1,durationWeek$2],[month,1,durationMonth$1],[month,3,3*durationMonth$1],[year,1,durationYear$1]];function tickFormat(date){return(second(date)<date?formatMillisecond:minute(date)<date?formatSecond:hour(date)<date?formatMinute:day(date)<date?formatHour:month(date)<date?week(date)<date?formatDay:formatWeek:year(date)<date?formatMonth:formatYear)(date)}function tickInterval(interval,start,stop){if(interval==null)interval=10;if(typeof interval==="number"){var target=Math.abs(stop-start)/interval,i=bisector((function(i){return i[2]})).right(tickIntervals,target),step;if(i===tickIntervals.length){step=tickStep(start/durationYear$1,stop/durationYear$1,interval);interval=year}else if(i){i=tickIntervals[target/tickIntervals[i-1][2]<tickIntervals[i][2]/target?i-1:i];step=i[1];interval=i[0]}else{step=Math.max(tickStep(start,stop,interval),1);interval=millisecond}return interval.every(step)}return interval}scale.invert=function(y){return new Date(invert(y))};scale.domain=function(_){return arguments.length?domain(Array.from(_,number$2)):domain().map(date$1)};scale.ticks=function(interval){var d=domain(),t0=d[0],t1=d[d.length-1],r=t1<t0,t;if(r)t=t0,t0=t1,t1=t;t=tickInterval(interval,t0,t1);t=t?t.range(t0,t1+1):[];return r?t.reverse():t};scale.tickFormat=function(count,specifier){return specifier==null?tickFormat:format(specifier)};scale.nice=function(interval){var d=domain();return(interval=tickInterval(interval,d[0],d[d.length-1]))?domain(nice(d,interval)):scale};scale.copy=function(){return copy(scale,calendar(year,month,week,day,hour,minute,second,millisecond,format))};return scale}function time(){return initRange.apply(calendar(year,month,sunday,day,hour,minute,second,millisecond,timeFormat).domain([new Date(2e3,0,1),new Date(2e3,0,2)]),arguments)}function utcTime(){return initRange.apply(calendar(utcYear,utcMonth,utcSunday,utcDay,utcHour,utcMinute,second,millisecond,utcFormat).domain([Date.UTC(2e3,0,1),Date.UTC(2e3,0,2)]),arguments)}function transformer$1(){var x0=0,x1=1,t0,t1,k10,transform,interpolator=identity$4,clamp=false,unknown;function scale(x){return isNaN(x=+x)?unknown:interpolator(k10===0?.5:(x=(transform(x)-t0)*k10,clamp?Math.max(0,Math.min(1,x)):x))}scale.domain=function(_){var _ref,_ref2;return arguments.length?(_ref=_,_ref2=_slicedToArray(_ref,2),x0=_ref2[0],x1=_ref2[1],_ref,t0=transform(x0=+x0),t1=transform(x1=+x1),k10=t0===t1?0:1/(t1-t0),scale):[x0,x1]};scale.clamp=function(_){return arguments.length?(clamp=!!_,scale):clamp};scale.interpolator=function(_){return arguments.length?(interpolator=_,scale):interpolator};function range(interpolate){return function(_){var _ref3,_ref4;var r0,r1;return arguments.length?(_ref3=_,_ref4=_slicedToArray(_ref3,2),r0=_ref4[0],r1=_ref4[1],_ref3,interpolator=interpolate(r0,r1),scale):[interpolator(0),interpolator(1)]}}scale.range=range(interpolate$1);scale.rangeRound=range(interpolateRound);scale.unknown=function(_){return arguments.length?(unknown=_,scale):unknown};return function(t){transform=t,t0=t(x0),t1=t(x1),k10=t0===t1?0:1/(t1-t0);return scale}}function copy$1(source,target){return target.domain(source.domain()).interpolator(source.interpolator()).clamp(source.clamp()).unknown(source.unknown())}function sequential(){var scale=linearish(transformer$1()(identity$4));scale.copy=function(){return copy$1(scale,sequential())};return initInterpolator.apply(scale,arguments)}function sequentialLog(){var scale=loggish(transformer$1()).domain([1,10]);scale.copy=function(){return copy$1(scale,sequentialLog()).base(scale.base())};return initInterpolator.apply(scale,arguments)}function sequentialSymlog(){var scale=symlogish(transformer$1());scale.copy=function(){return copy$1(scale,sequentialSymlog()).constant(scale.constant())};return initInterpolator.apply(scale,arguments)}function sequentialPow(){var scale=powish(transformer$1());scale.copy=function(){return copy$1(scale,sequentialPow()).exponent(scale.exponent())};return initInterpolator.apply(scale,arguments)}function sequentialSqrt(){return sequentialPow.apply(null,arguments).exponent(.5)}function transformer$2(){var x0=0,x1=.5,x2=1,s=1,t0,t1,t2,k10,k21,interpolator=identity$4,transform,clamp=false,unknown;function scale(x){return isNaN(x=+x)?unknown:(x=.5+((x=+transform(x))-t1)*(s*x<s*t1?k10:k21),interpolator(clamp?Math.max(0,Math.min(1,x)):x))}scale.domain=function(_){var _ref,_ref2;return arguments.length?(_ref=_,_ref2=_slicedToArray(_ref,3),x0=_ref2[0],x1=_ref2[1],x2=_ref2[2],_ref,t0=transform(x0=+x0),t1=transform(x1=+x1),t2=transform(x2=+x2),k10=t0===t1?0:.5/(t1-t0),k21=t1===t2?0:.5/(t2-t1),s=t1<t0?-1:1,scale):[x0,x1,x2]};scale.clamp=function(_){return arguments.length?(clamp=!!_,scale):clamp};scale.interpolator=function(_){return arguments.length?(interpolator=_,scale):interpolator};function range(interpolate){return function(_){var _ref3,_ref4;var r0,r1,r2;return arguments.length?(_ref3=_,_ref4=_slicedToArray(_ref3,3),r0=_ref4[0],r1=_ref4[1],r2=_ref4[2],_ref3,interpolator=piecewise(interpolate,[r0,r1,r2]),scale):[interpolator(0),interpolator(.5),interpolator(1)]}}scale.range=range(interpolate$1);scale.rangeRound=range(interpolateRound);scale.unknown=function(_){return arguments.length?(unknown=_,scale):unknown};return function(t){transform=t,t0=t(x0),t1=t(x1),t2=t(x2),k10=t0===t1?0:.5/(t1-t0),k21=t1===t2?0:.5/(t2-t1),s=t1<t0?-1:1;return scale}}function diverging(){var scale=linearish(transformer$2()(identity$4));scale.copy=function(){return copy$1(scale,diverging())};return initInterpolator.apply(scale,arguments)}function divergingLog(){var scale=loggish(transformer$2()).domain([.1,1,10]);scale.copy=function(){return copy$1(scale,divergingLog()).base(scale.base())};return initInterpolator.apply(scale,arguments)}function divergingSymlog(){var scale=symlogish(transformer$2());scale.copy=function(){return copy$1(scale,divergingSymlog()).constant(scale.constant())};return initInterpolator.apply(scale,arguments)}function divergingPow(){var scale=powish(transformer$2());scale.copy=function(){return copy$1(scale,divergingPow()).exponent(scale.exponent())};return initInterpolator.apply(scale,arguments)}function divergingSqrt(){return divergingPow.apply(null,arguments).exponent(.5)}var _symbols,_formats;function bandSpace(count,paddingInner,paddingOuter){var space=count-paddingInner+paddingOuter*2;return count?space>0?space:1:0}var Identity="identity";var Linear$1="linear";var Log="log";var Pow="pow";var Sqrt="sqrt";var Symlog="symlog";var Time="time";var UTC="utc";var Sequential="sequential";var Diverging="diverging";var Quantile$1="quantile";var Quantize="quantize";var Threshold="threshold";var Ordinal="ordinal";var Point="point";var Band="band";var BinOrdinal="bin-ordinal";var Continuous="continuous";var Discrete="discrete";var Discretizing="discretizing";var Interpolating="interpolating";var Temporal="temporal";function invertRange(scale){return function(_){var lo=_[0],hi=_[1],t;if(hi<lo){t=lo;lo=hi;hi=t}return[scale.invert(lo),scale.invert(hi)]}}function invertRangeExtent(scale){return function(_){var range=scale.range();var lo=_[0],hi=_[1],min=-1,max,t,i,n;if(hi<lo){t=lo;lo=hi;hi=t}for(i=0,n=range.length;i<n;++i){if(range[i]>=lo&&range[i]<=hi){if(min<0)min=i;max=i}}if(min<0)return undefined;lo=scale.invertExtent(range[min]);hi=scale.invertExtent(range[max]);return[lo[0]===undefined?lo[1]:lo[0],hi[1]===undefined?hi[0]:hi[1]]}}function band(){var scale=ordinal().unknown(undefined),domain=scale.domain,ordinalRange=scale.range;var range$1$1=[0,1],step,bandwidth,round=false,paddingInner=0,paddingOuter=0,align=.5;delete scale.unknown;function rescale(){var n=domain().length,reverse=range$1$1[1]<range$1$1[0],stop=range$1$1[1-reverse],space=bandSpace(n,paddingInner,paddingOuter);var start=range$1$1[reverse-0];step=(stop-start)/(space||1);if(round){step=Math.floor(step)}start+=(stop-start-step*(n-paddingInner))*align;bandwidth=step*(1-paddingInner);if(round){start=Math.round(start);bandwidth=Math.round(bandwidth)}var values=range$1(n).map((function(i){return start+step*i}));return ordinalRange(reverse?values.reverse():values)}scale.domain=function(_){if(arguments.length){domain(_);return rescale()}else{return domain()}};scale.range=function(_){if(arguments.length){range$1$1=[+_[0],+_[1]];return rescale()}else{return range$1$1.slice()}};scale.rangeRound=function(_){range$1$1=[+_[0],+_[1]];round=true;return rescale()};scale.bandwidth=function(){return bandwidth};scale.step=function(){return step};scale.round=function(_){if(arguments.length){round=!!_;return rescale()}else{return round}};scale.padding=function(_){if(arguments.length){paddingOuter=Math.max(0,Math.min(1,_));paddingInner=paddingOuter;return rescale()}else{return paddingInner}};scale.paddingInner=function(_){if(arguments.length){paddingInner=Math.max(0,Math.min(1,_));return rescale()}else{return paddingInner}};scale.paddingOuter=function(_){if(arguments.length){paddingOuter=Math.max(0,Math.min(1,_));return rescale()}else{return paddingOuter}};scale.align=function(_){if(arguments.length){align=Math.max(0,Math.min(1,_));return rescale()}else{return align}};scale.invertRange=function(_){if(_[0]==null||_[1]==null)return;var reverse=range$1$1[1]<range$1$1[0],values=reverse?ordinalRange().reverse():ordinalRange(),n=values.length-1;var lo=+_[0],hi=+_[1],a,b,t;if(lo!==lo||hi!==hi)return;if(hi<lo){t=lo;lo=hi;hi=t}if(hi<values[0]||lo>range$1$1[1-reverse])return;a=Math.max(0,bisectRight(values,lo)-1);b=lo===hi?a:bisectRight(values,hi)-1;if(lo-values[a]>bandwidth+1e-10)++a;if(reverse){t=a;a=n-b;b=n-t}return a>b?undefined:domain().slice(a,b+1)};scale.invert=function(_){var value=scale.invertRange([_,_]);return value?value[0]:value};scale.copy=function(){return band().domain(domain()).range(range$1$1).round(round).paddingInner(paddingInner).paddingOuter(paddingOuter).align(align)};return rescale()}function pointish(scale){var copy=scale.copy;scale.padding=scale.paddingOuter;delete scale.paddingInner;scale.copy=function(){return pointish(copy())};return scale}function point(){return pointish(band().paddingInner(1))}var map$1=Array.prototype.map;function numbers$2(_){return map$1.call(_,toNumber)}var slice=Array.prototype.slice;function scaleBinOrdinal(){var domain=[],range=[];function scale(x){return x==null||x!==x?undefined:range[(bisectRight(domain,x)-1)%range.length]}scale.domain=function(_){if(arguments.length){domain=numbers$2(_);return scale}else{return domain.slice()}};scale.range=function(_){if(arguments.length){range=slice.call(_);return scale}else{return range.slice()}};scale.tickFormat=function(count,specifier){return tickFormat(domain[0],peek(domain),count==null?10:count,specifier)};scale.copy=function(){return scaleBinOrdinal().domain(scale.domain()).range(scale.range())};return scale}var scales={};function create(type,constructor,metadata){var ctr=function scale(){var s=constructor();if(!s.invertRange){s.invertRange=s.invert?invertRange(s):s.invertExtent?invertRangeExtent(s):undefined}s.type=type;return s};ctr.metadata=toSet(array(metadata));return ctr}function scale(type,scale,metadata){if(arguments.length>1){scales[type]=create(type,scale,metadata);return this}else{return isValidScaleType(type)?scales[type]:undefined}}scale(Identity,identity$5);scale(Linear$1,linear$2,Continuous);scale(Log,log$3,[Continuous,Log]);scale(Pow,pow$2,Continuous);scale(Sqrt,sqrt$1,Continuous);scale(Symlog,symlog$1,Continuous);scale(Time,time,[Continuous,Temporal]);scale(UTC,utcTime,[Continuous,Temporal]);scale(Sequential,sequential,[Continuous,Interpolating]);scale("".concat(Sequential,"-").concat(Linear$1),sequential,[Continuous,Interpolating]);scale("".concat(Sequential,"-").concat(Log),sequentialLog,[Continuous,Interpolating,Log]);scale("".concat(Sequential,"-").concat(Pow),sequentialPow,[Continuous,Interpolating]);scale("".concat(Sequential,"-").concat(Sqrt),sequentialSqrt,[Continuous,Interpolating]);scale("".concat(Sequential,"-").concat(Symlog),sequentialSymlog,[Continuous,Interpolating]);scale("".concat(Diverging,"-").concat(Linear$1),diverging,[Continuous,Interpolating]);scale("".concat(Diverging,"-").concat(Log),divergingLog,[Continuous,Interpolating,Log]);scale("".concat(Diverging,"-").concat(Pow),divergingPow,[Continuous,Interpolating]);scale("".concat(Diverging,"-").concat(Sqrt),divergingSqrt,[Continuous,Interpolating]);scale("".concat(Diverging,"-").concat(Symlog),divergingSymlog,[Continuous,Interpolating]);scale(Quantile$1,quantile$1,[Discretizing,Quantile$1]);scale(Quantize,quantize$1,Discretizing);scale(Threshold,threshold,Discretizing);scale(BinOrdinal,scaleBinOrdinal,[Discrete,Discretizing]);scale(Ordinal,ordinal,Discrete);scale(Band,band,Discrete);scale(Point,point,Discrete);function isValidScaleType(type){return _has(scales,type)}function hasType(key,type){var s=scales[key];return s&&s.metadata[type]}function isContinuous(key){return hasType(key,Continuous)}function isDiscrete(key){return hasType(key,Discrete)}function isDiscretizing(key){return hasType(key,Discretizing)}function isLogarithmic(key){return hasType(key,Log)}function isTemporal(key){return hasType(key,Temporal)}function isInterpolating(key){return hasType(key,Interpolating)}function isQuantile(key){return hasType(key,Quantile$1)}var scaleProps=["clamp","base","constant","exponent"];function interpolateRange(interpolator,range){var start=range[0],span=peek(range)-start;return function(i){return interpolator(start+i*span)}}function interpolateColors(colors,type,gamma){return piecewise(interpolate(type||"rgb",gamma),colors)}function quantizeInterpolator(interpolator,count){var samples=new Array(count),n=count+1;for(var i=0;i<count;){samples[i]=interpolator(++i/n)}return samples}function scaleFraction(scale$1,min,max){var delta=max-min;var i,t,s;if(!delta||!Number.isFinite(delta)){return constant(.5)}else{i=(t=scale$1.type).indexOf("-");t=i<0?t:t.slice(i+1);s=scale(t)().domain([min,max]).range([0,1]);scaleProps.forEach((function(m){return scale$1[m]?s[m](scale$1[m]()):0}));return s}}function interpolate(type,gamma){var interp=$$1[method(type)];return gamma!=null&&interp&&interp.gamma?interp.gamma(gamma):interp}function method(type){return"interpolate"+type.toLowerCase().split("-").map((function(s){return s[0].toUpperCase()+s.slice(1)})).join("")}var continuous$1={blues:"cfe1f2bed8eca8cee58fc1de74b2d75ba3cf4592c63181bd206fb2125ca40a4a90",greens:"d3eecdc0e6baabdda594d3917bc77d60ba6c46ab5e329a512089430e7735036429",greys:"e2e2e2d4d4d4c4c4c4b1b1b19d9d9d8888887575756262624d4d4d3535351e1e1e",oranges:"fdd8b3fdc998fdb87bfda55efc9244f87f2cf06b18e4580bd14904b93d029f3303",purples:"e2e1efd4d4e8c4c5e0b4b3d6a3a0cc928ec3827cb97566ae684ea25c3696501f8c",reds:"fdc9b4fcb49afc9e80fc8767fa7051f6573fec3f2fdc2a25c81b1db21218970b13",blueGreen:"d5efedc1e8e0a7ddd18bd2be70c6a958ba9144ad77319c5d2089460e7736036429",bluePurple:"ccddecbad0e4a8c2dd9ab0d4919cc98d85be8b6db28a55a6873c99822287730f71",greenBlue:"d3eecec5e8c3b1e1bb9bd8bb82cec269c2ca51b2cd3c9fc7288abd1675b10b60a1",orangeRed:"fddcaffdcf9bfdc18afdad77fb9562f67d53ee6545e24932d32d1ebf130da70403",purpleBlue:"dbdaebc8cee4b1c3de97b7d87bacd15b9fc93a90c01e7fb70b70ab056199045281",purpleBlueGreen:"dbd8eac8cee4b0c3de93b7d872acd1549fc83892bb1c88a3097f8702736b016353",purpleRed:"dcc9e2d3b3d7ce9eccd186c0da6bb2e14da0e23189d91e6fc61159ab07498f023a",redPurple:"fccfccfcbec0faa9b8f98faff571a5ec539ddb3695c41b8aa908808d0179700174",yellowGreen:"e4f4acd1eca0b9e2949ed68880c97c62bb6e47aa5e3297502083440e723b036034",yellowOrangeBrown:"feeaa1fedd84fecc63feb746fca031f68921eb7215db5e0bc54c05ab3d038f3204",yellowOrangeRed:"fee087fed16ffebd59fea849fd903efc7335f9522bee3423de1b20ca0b22af0225",blueOrange:"134b852f78b35da2cb9dcae1d2e5eff2f0ebfce0bafbbf74e8932fc5690d994a07",brownBlueGreen:"704108a0651ac79548e3c78af3e6c6eef1eac9e9e48ed1c74da79e187a72025147",purpleGreen:"5b1667834792a67fb6c9aed3e6d6e8eff0efd9efd5aedda971bb75368e490e5e29",purpleOrange:"4114696647968f83b7b9b4d6dadbebf3eeeafce0bafbbf74e8932fc5690d994a07",redBlue:"8c0d25bf363adf745ef4ae91fbdbc9f2efeed2e5ef9dcae15da2cb2f78b3134b85",redGrey:"8c0d25bf363adf745ef4ae91fcdccbfaf4f1e2e2e2c0c0c0969696646464343434",yellowGreenBlue:"eff9bddbf1b4bde5b594d5b969c5be45b4c22c9ec02182b82163aa23479c1c3185",redYellowBlue:"a50026d4322cf16e43fcac64fedd90faf8c1dcf1ecabd6e875abd04a74b4313695",redYellowGreen:"a50026d4322cf16e43fcac63fedd8df9f7aed7ee8ea4d86e64bc6122964f006837",pinkYellowGreen:"8e0152c0267edd72adf0b3d6faddedf5f3efe1f2cab6de8780bb474f9125276419",spectral:"9e0142d13c4bf0704afcac63fedd8dfbf8b0e0f3a1a9dda269bda94288b55e4fa2",viridis:"440154470e61481a6c482575472f7d443a834144873d4e8a39568c35608d31688e2d708e2a788e27818e23888e21918d1f988b1fa08822a8842ab07f35b77943bf7154c56866cc5d7ad1518fd744a5db36bcdf27d2e21be9e51afde725",magma:"0000040404130b0924150e3720114b2c11603b0f704a107957157e651a80721f817f24828c29819a2e80a8327db6377ac43c75d1426fde4968e95462f1605df76f5cfa7f5efc8f65fe9f6dfeaf78febf84fece91fddea0fcedaffcfdbf",inferno:"0000040403130c0826170c3b240c4f330a5f420a68500d6c5d126e6b176e781c6d86216b932667a12b62ae305cbb3755c73e4cd24644dd513ae65c30ed6925f3771af8850ffb9506fca50afcb519fac62df6d645f2e661f3f484fcffa4",plasma:"0d088723069033059742039d5002a25d01a66a00a87801a88405a7900da49c179ea72198b12a90ba3488c33d80cb4779d35171da5a69e16462e76e5bed7953f2834cf68f44fa9a3dfca636fdb32ffec029fcce25f9dc24f5ea27f0f921",cividis:"00205100235800265d002961012b65042e670831690d346b11366c16396d1c3c6e213f6e26426e2c456e31476e374a6e3c4d6e42506e47536d4c566d51586e555b6e5a5e6e5e616e62646f66676f6a6a706e6d717270717573727976737c79747f7c75827f758682768985778c8877908b78938e789691789a94789e9778a19b78a59e77a9a177aea575b2a874b6ab73bbaf71c0b26fc5b66dc9b96acebd68d3c065d8c462ddc85fe2cb5ce7cf58ebd355f0d652f3da4ff7de4cfae249fce647",rainbow:"6e40aa883eb1a43db3bf3cafd83fa4ee4395fe4b83ff576eff6659ff7847ff8c38f3a130e2b72fcfcc36bee044aff05b8ff4576ff65b52f6673af27828ea8d1ddfa319d0b81cbecb23abd82f96e03d82e14c6edb5a5dd0664dbf6e40aa",sinebow:"ff4040fc582af47218e78d0bd5a703bfbf00a7d5038de70b72f41858fc2a40ff402afc5818f4720be78d03d5a700bfbf03a7d50b8de71872f42a58fc4040ff582afc7218f48d0be7a703d5bf00bfd503a7e70b8df41872fc2a58ff4040",turbo:"23171b32204a3e2a71453493493eae4b49c54a53d7485ee44569ee4074f53c7ff8378af93295f72e9ff42ba9ef28b3e926bce125c5d925cdcf27d5c629dcbc2de3b232e9a738ee9d3ff39347f68950f9805afc7765fd6e70fe667cfd5e88fc5795fb51a1f84badf545b9f140c5ec3cd0e637dae034e4d931ecd12ef4c92bfac029ffb626ffad24ffa223ff9821ff8d1fff821dff771cfd6c1af76118f05616e84b14df4111d5380fcb2f0dc0260ab61f07ac1805a313029b0f00950c00910b00",browns:"eedbbdecca96e9b97ae4a865dc9856d18954c7784cc0673fb85536ad44339f3632",tealBlues:"bce4d89dd3d181c3cb65b3c245a2b9368fae347da0306a932c5985",teals:"bbdfdfa2d4d58ac9c975bcbb61b0af4da5a43799982b8b8c1e7f7f127273006667",warmGreys:"dcd4d0cec5c1c0b8b4b3aaa7a59c9998908c8b827f7e7673726866665c5a59504e",goldGreen:"f4d166d5ca60b6c35c98bb597cb25760a6564b9c533f8f4f33834a257740146c36",goldOrange:"f4d166f8be5cf8aa4cf5983bf3852aef701be2621fd65322c54923b142239e3a26",goldRed:"f4d166f6be59f9aa51fc964ef6834bee734ae56249db5247cf4244c43141b71d3e",lightGreyRed:"efe9e6e1dad7d5cbc8c8bdb9bbaea9cd967ddc7b43e15f19df4011dc000b",lightGreyTeal:"e4eaead6dcddc8ced2b7c2c7a6b4bc64b0bf22a6c32295c11f85be1876bc",lightMulti:"e0f1f2c4e9d0b0de9fd0e181f6e072f6c053f3993ef77440ef4a3c",lightOrange:"f2e7daf7d5baf9c499fab184fa9c73f68967ef7860e8645bde515bd43d5b",lightTealBlue:"e3e9e0c0dccf9aceca7abfc859afc0389fb9328dad2f7ca0276b95255988",darkBlue:"3232322d46681a5c930074af008cbf05a7ce25c0dd38daed50f3faffffff",darkGold:"3c3c3c584b37725e348c7631ae8b2bcfa424ecc31ef9de30fff184ffffff",darkGreen:"3a3a3a215748006f4d048942489e4276b340a6c63dd2d836ffeb2cffffaa",darkMulti:"3737371f5287197d8c29a86995ce3fffe800ffffff",darkRed:"3434347036339e3c38cc4037e75d1eec8620eeab29f0ce32ffeb2c"};var discrete$1={category10:"1f77b4ff7f0e2ca02cd627289467bd8c564be377c27f7f7fbcbd2217becf",category20:"1f77b4aec7e8ff7f0effbb782ca02c98df8ad62728ff98969467bdc5b0d58c564bc49c94e377c2f7b6d27f7f7fc7c7c7bcbd22dbdb8d17becf9edae5",category20b:"393b795254a36b6ecf9c9ede6379398ca252b5cf6bcedb9c8c6d31bd9e39e7ba52e7cb94843c39ad494ad6616be7969c7b4173a55194ce6dbdde9ed6",category20c:"3182bd6baed69ecae1c6dbefe6550dfd8d3cfdae6bfdd0a231a35474c476a1d99bc7e9c0756bb19e9ac8bcbddcdadaeb636363969696bdbdbdd9d9d9",tableau10:"4c78a8f58518e4575672b7b254a24beeca3bb279a2ff9da69d755dbab0ac",tableau20:"4c78a89ecae9f58518ffbf7954a24b88d27ab79a20f2cf5b43989483bcb6e45756ff9d9879706ebab0acd67195fcbfd2b279a2d6a5c99e765fd8b5a5",accent:"7fc97fbeaed4fdc086ffff99386cb0f0027fbf5b17666666",dark2:"1b9e77d95f027570b3e7298a66a61ee6ab02a6761d666666",paired:"a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928",pastel1:"fbb4aeb3cde3ccebc5decbe4fed9a6ffffcce5d8bdfddaecf2f2f2",pastel2:"b3e2cdfdcdaccbd5e8f4cae4e6f5c9fff2aef1e2cccccccc",set1:"e41a1c377eb84daf4a984ea3ff7f00ffff33a65628f781bf999999",set2:"66c2a5fc8d628da0cbe78ac3a6d854ffd92fe5c494b3b3b3",set3:"8dd3c7ffffb3bebadafb807280b1d3fdb462b3de69fccde5d9d9d9bc80bdccebc5ffed6f"};function colors(palette){var n=palette.length/6|0,c=new Array(n);for(var i=0;i<n;){c[i]="#"+palette.slice(i*6,++i*6)}return c}function apply(_,f){for(var k in _){scheme(k,f(_[k]))}}var schemes={};apply(discrete$1,colors);apply(continuous$1,(function(_){return interpolateColors(colors(_))}));function scheme(name,scheme){name=name&&name.toLowerCase();if(arguments.length>1){schemes[name]=scheme;return this}else{return schemes[name]}}var SymbolLegend="symbol";var DiscreteLegend="discrete";var GradientLegend="gradient";var defaultFormatter=function defaultFormatter(value){return isArray(value)?value.map((function(v){return String(v)})):String(value)};var ascending$2=function ascending(a,b){return a[1]-b[1]};var descending=function descending(a,b){return b[1]-a[1]};function tickCount(scale,count,minStep){var step;if(isNumber(count)){if(scale.bins){count=Math.max(count,scale.bins.length)}if(minStep!=null){count=Math.min(count,Math.floor(span(scale.domain())/minStep||1))}}if(isObject(count)){step=count.step;count=count.interval}if(isString(count)){count=scale.type===Time?timeInterval(count):scale.type==UTC?utcInterval(count):error("Only time and utc scales accept interval strings.");if(step)count=count.every(step)}return count}function validTicks(scale,ticks,count){var range=scale.range(),lo=range[0],hi=peek(range),cmp=ascending$2;if(lo>hi){range=hi;hi=lo;lo=range;cmp=descending}lo=Math.floor(lo);hi=Math.ceil(hi);ticks=ticks.map((function(v){return[v,scale(v)]})).filter((function(_){return lo<=_[1]&&_[1]<=hi})).sort(cmp).map((function(_){return _[0]}));if(count>0&&ticks.length>1){var endpoints=[ticks[0],peek(ticks)];while(ticks.length>count&&ticks.length>=3){ticks=ticks.filter((function(_,i){return!(i%2)}))}if(ticks.length<3){ticks=endpoints}}return ticks}function tickValues(scale,count){return scale.bins?validTicks(scale,scale.bins):scale.ticks?scale.ticks(count):scale.domain()}function tickFormat$1(locale,scale,count,specifier,formatType,noSkip){var type=scale.type;var format=defaultFormatter;if(type===Time||formatType===Time){format=locale.timeFormat(specifier)}else if(type===UTC||formatType===UTC){format=locale.utcFormat(specifier)}else if(isLogarithmic(type)){var varfmt=locale.formatFloat(specifier);if(noSkip||scale.bins){format=varfmt}else{var test=tickLog(scale,count,false);format=function format(_){return test(_)?varfmt(_):""}}}else if(scale.tickFormat){var d=scale.domain();format=locale.formatSpan(d[0],d[d.length-1],count,specifier)}else if(specifier){format=locale.format(specifier)}return format}function tickLog(scale,count,values){var ticks=tickValues(scale,count),base=scale.base(),logb=Math.log(base),k=Math.max(1,base*count/ticks.length);var test=function test(d){var i=d/Math.pow(base,Math.round(Math.log(d)/logb));if(i*base<base-.5)i*=base;return i<=k};return values?ticks.filter(test):test}var symbols=(_symbols={},_defineProperty(_symbols,Quantile$1,"quantiles"),_defineProperty(_symbols,Quantize,"thresholds"),_defineProperty(_symbols,Threshold,"domain"),_symbols);var formats$1=(_formats={},_defineProperty(_formats,Quantile$1,"quantiles"),_defineProperty(_formats,Quantize,"domain"),_formats);function labelValues(scale,count){return scale.bins?binValues(scale.bins):scale.type===Log?tickLog(scale,count,true):symbols[scale.type]?thresholdValues(scale[symbols[scale.type]]()):tickValues(scale,count)}function thresholdFormat(locale,scale,specifier){var _=scale[formats$1[scale.type]](),n=_.length;var d=n>1?_[1]-_[0]:_[0],i;for(i=1;i<n;++i){d=Math.min(d,_[i]-_[i-1])}return locale.formatSpan(0,d,3*10,specifier)}function thresholdValues(thresholds){var values=[-Infinity].concat(thresholds);values.max=+Infinity;return values}function binValues(bins){var values=bins.slice(0,-1);values.max=peek(bins);return values}var isDiscreteRange=function isDiscreteRange(scale){return symbols[scale.type]||scale.bins};function labelFormat(locale,scale,count,type,specifier,formatType,noSkip){var format=formats$1[scale.type]&&formatType!==Time&&formatType!==UTC?thresholdFormat(locale,scale,specifier):tickFormat$1(locale,scale,count,specifier,formatType,noSkip);return type===SymbolLegend&&isDiscreteRange(scale)?formatRange(format):type===DiscreteLegend?formatDiscrete(format):formatPoint(format)}var formatRange=function formatRange(format){return function(value,index,array){var limit=get$1(array[index+1],get$1(array.max,+Infinity)),lo=formatValue(value,format),hi=formatValue(limit,format);return lo&&hi?lo+"  "+hi:hi?"< "+hi:" "+lo}};var get$1=function get(value,dflt){return value!=null?value:dflt};var formatDiscrete=function formatDiscrete(format){return function(value,index){return index?format(value):null}};var formatPoint=function formatPoint(format){return function(value){return format(value)}};var formatValue=function formatValue(value,format){return Number.isFinite(value)?format(value):null};function labelFraction(scale){var domain=scale.domain(),count=domain.length-1;var lo=+domain[0],hi=+peek(domain),span=hi-lo;if(scale.type===Threshold){var adjust=count?span/count:.1;lo-=adjust;hi+=adjust;span=hi-lo}return function(value){return(value-lo)/span}}function format$2(locale,scale,specifier,formatType){var type=formatType||scale.type;if(isString(specifier)&&isTemporal(type)){specifier=specifier.replace(/%a/g,"%A").replace(/%b/g,"%B")}return!specifier&&type===Time?locale.timeFormat("%A, %d %B %Y, %X"):!specifier&&type===UTC?locale.utcFormat("%A, %d %B %Y, %X UTC"):labelFormat(locale,scale,5,null,specifier,formatType,true)}function domainCaption(locale,scale,opt){opt=opt||{};var max=Math.max(3,opt.maxlen||7),fmt=format$2(locale,scale,opt.format,opt.formatType);if(isDiscretizing(scale.type)){var v=labelValues(scale).slice(1).map(fmt),n=v.length;return"".concat(n," boundar").concat(n===1?"y":"ies",": ").concat(v.join(", "))}else if(isDiscrete(scale.type)){var d=scale.domain(),_n=d.length,_v=_n>max?d.slice(0,max-2).map(fmt).join(", ")+", ending with "+d.slice(-1).map(fmt):d.map(fmt).join(", ");return"".concat(_n," value").concat(_n===1?"":"s",": ").concat(_v)}else{var _d=scale.domain();return"values from ".concat(fmt(_d[0])," to ").concat(fmt(peek(_d)))}}var gradient_id=0;function resetSVGGradientId(){gradient_id=0}var patternPrefix="p_";function isGradient(value){return value&&value.gradient}function gradientRef(g,defs,base){var type=g.gradient;var id=g.id,prefix=type==="radial"?patternPrefix:"";if(!id){id=g.id="gradient_"+gradient_id++;if(type==="radial"){g.x1=get$2(g.x1,.5);g.y1=get$2(g.y1,.5);g.r1=get$2(g.r1,0);g.x2=get$2(g.x2,.5);g.y2=get$2(g.y2,.5);g.r2=get$2(g.r2,.5);prefix=patternPrefix}else{g.x1=get$2(g.x1,0);g.y1=get$2(g.y1,0);g.x2=get$2(g.x2,1);g.y2=get$2(g.y2,0)}}defs[id]=g;return"url("+(base||"")+"#"+prefix+id+")"}function get$2(val,def){return val!=null?val:def}function Gradient(p0,p1){var stops=[],gradient;return gradient={gradient:"linear",x1:p0?p0[0]:0,y1:p0?p0[1]:0,x2:p1?p1[0]:1,y2:p1?p1[1]:0,stops:stops,stop:function stop(offset,color){stops.push({offset:offset,color:color});return gradient}}}var lookup={basis:{curve:curveBasis},"basis-closed":{curve:curveBasisClosed},"basis-open":{curve:curveBasisOpen},bundle:{curve:curveBundle,tension:"beta",value:.85},cardinal:{curve:curveCardinal,tension:"tension",value:0},"cardinal-open":{curve:curveCardinalOpen,tension:"tension",value:0},"cardinal-closed":{curve:curveCardinalClosed,tension:"tension",value:0},"catmull-rom":{curve:curveCatmullRom,tension:"alpha",value:.5},"catmull-rom-closed":{curve:curveCatmullRomClosed,tension:"alpha",value:.5},"catmull-rom-open":{curve:curveCatmullRomOpen,tension:"alpha",value:.5},linear:{curve:curveLinear},"linear-closed":{curve:curveLinearClosed},monotone:{horizontal:monotoneY,vertical:monotoneX},natural:{curve:curveNatural},step:{curve:curveStep},"step-after":{curve:stepAfter},"step-before":{curve:stepBefore}};function curves(type,orientation,tension){var entry=_has(lookup,type)&&lookup[type],curve=null;if(entry){curve=entry.curve||entry[orientation||"vertical"];if(entry.tension&&tension!=null){curve=curve[entry.tension](tension)}}return curve}var cmdlen={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},regexp=[/([MLHVCSQTAZmlhvcsqtaz])/g,/###/,/(\.\d+)(\.\d)/g,/(\d)([-+])/g,/\s|,|###/];function pathParse(pathstr){var result=[];var curr,chunks,parsed,param,cmd,len,i,j,n,m;var path=pathstr.slice().replace(regexp[0],"###$1").split(regexp[1]).slice(1);for(i=0,n=path.length;i<n;++i){curr=path[i];chunks=curr.slice(1).trim().replace(regexp[2],"$1###$2").replace(regexp[3],"$1###$2").split(regexp[4]);cmd=curr.charAt(0);parsed=[cmd];for(j=0,m=chunks.length;j<m;++j){if((param=+chunks[j])===param){parsed.push(param)}}len=cmdlen[cmd.toLowerCase()];if(parsed.length-1>len){var _m=parsed.length;j=1;result.push([cmd].concat(parsed.slice(j,j+=len)));cmd=cmd==="M"?"L":cmd==="m"?"l":cmd;for(;j<_m;j+=len){result.push([cmd].concat(parsed.slice(j,j+len)))}}else{result.push(parsed)}}return result}var DegToRad=Math.PI/180;var Epsilon=1e-14;var HalfPi=Math.PI/2;var Tau=Math.PI*2;var HalfSqrt3=Math.sqrt(3)/2;var segmentCache={};var bezierCache={};var join=[].join;function segments(x,y,rx,ry,large,sweep,rotateX,ox,oy){var key=join.call(arguments);if(segmentCache[key]){return segmentCache[key]}var th=rotateX*DegToRad;var sin_th=Math.sin(th);var cos_th=Math.cos(th);rx=Math.abs(rx);ry=Math.abs(ry);var px=cos_th*(ox-x)*.5+sin_th*(oy-y)*.5;var py=cos_th*(oy-y)*.5-sin_th*(ox-x)*.5;var pl=px*px/(rx*rx)+py*py/(ry*ry);if(pl>1){pl=Math.sqrt(pl);rx*=pl;ry*=pl}var a00=cos_th/rx;var a01=sin_th/rx;var a10=-sin_th/ry;var a11=cos_th/ry;var x0=a00*ox+a01*oy;var y0=a10*ox+a11*oy;var x1=a00*x+a01*y;var y1=a10*x+a11*y;var d=(x1-x0)*(x1-x0)+(y1-y0)*(y1-y0);var sfactor_sq=1/d-.25;if(sfactor_sq<0)sfactor_sq=0;var sfactor=Math.sqrt(sfactor_sq);if(sweep==large)sfactor=-sfactor;var xc=.5*(x0+x1)-sfactor*(y1-y0);var yc=.5*(y0+y1)+sfactor*(x1-x0);var th0=Math.atan2(y0-yc,x0-xc);var th1=Math.atan2(y1-yc,x1-xc);var th_arc=th1-th0;if(th_arc<0&&sweep===1){th_arc+=Tau}else if(th_arc>0&&sweep===0){th_arc-=Tau}var segs=Math.ceil(Math.abs(th_arc/(HalfPi+.001)));var result=[];for(var i=0;i<segs;++i){var th2=th0+i*th_arc/segs;var th3=th0+(i+1)*th_arc/segs;result[i]=[xc,yc,th2,th3,rx,ry,sin_th,cos_th]}return segmentCache[key]=result}function bezier(params){var key=join.call(params);if(bezierCache[key]){return bezierCache[key]}var cx=params[0],cy=params[1],th0=params[2],th1=params[3],rx=params[4],ry=params[5],sin_th=params[6],cos_th=params[7];var a00=cos_th*rx;var a01=-sin_th*ry;var a10=sin_th*rx;var a11=cos_th*ry;var cos_th0=Math.cos(th0);var sin_th0=Math.sin(th0);var cos_th1=Math.cos(th1);var sin_th1=Math.sin(th1);var th_half=.5*(th1-th0);var sin_th_h2=Math.sin(th_half*.5);var t=8/3*sin_th_h2*sin_th_h2/Math.sin(th_half);var x1=cx+cos_th0-t*sin_th0;var y1=cy+sin_th0+t*cos_th0;var x3=cx+cos_th1;var y3=cy+sin_th1;var x2=x3+t*sin_th1;var y2=y3-t*cos_th1;return bezierCache[key]=[a00*x1+a01*y1,a10*x1+a11*y1,a00*x2+a01*y2,a10*x2+a11*y2,a00*x3+a01*y3,a10*x3+a11*y3]}var temp=["l",0,0,0,0,0,0,0];function scale$1(current,sX,sY){var c=temp[0]=current[0];if(c==="a"||c==="A"){temp[1]=sX*current[1];temp[2]=sY*current[2];temp[3]=current[3];temp[4]=current[4];temp[5]=current[5];temp[6]=sX*current[6];temp[7]=sY*current[7]}else if(c==="h"||c==="H"){temp[1]=sX*current[1]}else if(c==="v"||c==="V"){temp[1]=sY*current[1]}else{for(var i=1,n=current.length;i<n;++i){temp[i]=(i%2==1?sX:sY)*current[i]}}return temp}function pathRender(context,path,l,t,sX,sY){var current,previous=null,x=0,y=0,controlX=0,controlY=0,tempX,tempY,tempControlX,tempControlY;if(l==null)l=0;if(t==null)t=0;if(sX==null)sX=1;if(sY==null)sY=sX;if(context.beginPath)context.beginPath();for(var i=0,len=path.length;i<len;++i){current=path[i];if(sX!==1||sY!==1){current=scale$1(current,sX,sY)}switch(current[0]){case"l":x+=current[1];y+=current[2];context.lineTo(x+l,y+t);break;case"L":x=current[1];y=current[2];context.lineTo(x+l,y+t);break;case"h":x+=current[1];context.lineTo(x+l,y+t);break;case"H":x=current[1];context.lineTo(x+l,y+t);break;case"v":y+=current[1];context.lineTo(x+l,y+t);break;case"V":y=current[1];context.lineTo(x+l,y+t);break;case"m":x+=current[1];y+=current[2];context.moveTo(x+l,y+t);break;case"M":x=current[1];y=current[2];context.moveTo(x+l,y+t);break;case"c":tempX=x+current[5];tempY=y+current[6];controlX=x+current[3];controlY=y+current[4];context.bezierCurveTo(x+current[1]+l,y+current[2]+t,controlX+l,controlY+t,tempX+l,tempY+t);x=tempX;y=tempY;break;case"C":x=current[5];y=current[6];controlX=current[3];controlY=current[4];context.bezierCurveTo(current[1]+l,current[2]+t,controlX+l,controlY+t,x+l,y+t);break;case"s":tempX=x+current[3];tempY=y+current[4];controlX=2*x-controlX;controlY=2*y-controlY;context.bezierCurveTo(controlX+l,controlY+t,x+current[1]+l,y+current[2]+t,tempX+l,tempY+t);controlX=x+current[1];controlY=y+current[2];x=tempX;y=tempY;break;case"S":tempX=current[3];tempY=current[4];controlX=2*x-controlX;controlY=2*y-controlY;context.bezierCurveTo(controlX+l,controlY+t,current[1]+l,current[2]+t,tempX+l,tempY+t);x=tempX;y=tempY;controlX=current[1];controlY=current[2];break;case"q":tempX=x+current[3];tempY=y+current[4];controlX=x+current[1];controlY=y+current[2];context.quadraticCurveTo(controlX+l,controlY+t,tempX+l,tempY+t);x=tempX;y=tempY;break;case"Q":tempX=current[3];tempY=current[4];context.quadraticCurveTo(current[1]+l,current[2]+t,tempX+l,tempY+t);x=tempX;y=tempY;controlX=current[1];controlY=current[2];break;case"t":tempX=x+current[1];tempY=y+current[2];if(previous[0].match(/[QqTt]/)===null){controlX=x;controlY=y}else if(previous[0]==="t"){controlX=2*x-tempControlX;controlY=2*y-tempControlY}else if(previous[0]==="q"){controlX=2*x-controlX;controlY=2*y-controlY}tempControlX=controlX;tempControlY=controlY;context.quadraticCurveTo(controlX+l,controlY+t,tempX+l,tempY+t);x=tempX;y=tempY;controlX=x+current[1];controlY=y+current[2];break;case"T":tempX=current[1];tempY=current[2];controlX=2*x-controlX;controlY=2*y-controlY;context.quadraticCurveTo(controlX+l,controlY+t,tempX+l,tempY+t);x=tempX;y=tempY;break;case"a":drawArc(context,x+l,y+t,[current[1],current[2],current[3],current[4],current[5],current[6]+x+l,current[7]+y+t]);x+=current[6];y+=current[7];break;case"A":drawArc(context,x+l,y+t,[current[1],current[2],current[3],current[4],current[5],current[6]+l,current[7]+t]);x=current[6];y=current[7];break;case"z":case"Z":context.closePath();break}previous=current}}function drawArc(context,x,y,coords){var seg=segments(coords[5],coords[6],coords[0],coords[1],coords[3],coords[4],coords[2],x,y);for(var i=0;i<seg.length;++i){var bez=bezier(seg[i]);context.bezierCurveTo(bez[0],bez[1],bez[2],bez[3],bez[4],bez[5])}}var Tan30=.5773502691896257;var builtins={circle:{draw:function draw(context,size){var r=Math.sqrt(size)/2;context.moveTo(r,0);context.arc(0,0,r,0,Tau)}},cross:{draw:function draw(context,size){var r=Math.sqrt(size)/2,s=r/2.5;context.moveTo(-r,-s);context.lineTo(-r,s);context.lineTo(-s,s);context.lineTo(-s,r);context.lineTo(s,r);context.lineTo(s,s);context.lineTo(r,s);context.lineTo(r,-s);context.lineTo(s,-s);context.lineTo(s,-r);context.lineTo(-s,-r);context.lineTo(-s,-s);context.closePath()}},diamond:{draw:function draw(context,size){var r=Math.sqrt(size)/2;context.moveTo(-r,0);context.lineTo(0,-r);context.lineTo(r,0);context.lineTo(0,r);context.closePath()}},square:{draw:function draw(context,size){var w=Math.sqrt(size),x=-w/2;context.rect(x,x,w,w)}},arrow:{draw:function draw(context,size){var r=Math.sqrt(size)/2,s=r/7,t=r/2.5,v=r/8;context.moveTo(-s,r);context.lineTo(s,r);context.lineTo(s,-v);context.lineTo(t,-v);context.lineTo(0,-r);context.lineTo(-t,-v);context.lineTo(-s,-v);context.closePath()}},wedge:{draw:function draw(context,size){var r=Math.sqrt(size)/2,h=HalfSqrt3*r,o=h-r*Tan30,b=r/4;context.moveTo(0,-h-o);context.lineTo(-b,h-o);context.lineTo(b,h-o);context.closePath()}},triangle:{draw:function draw(context,size){var r=Math.sqrt(size)/2,h=HalfSqrt3*r,o=h-r*Tan30;context.moveTo(0,-h-o);context.lineTo(-r,h-o);context.lineTo(r,h-o);context.closePath()}},"triangle-up":{draw:function draw(context,size){var r=Math.sqrt(size)/2,h=HalfSqrt3*r;context.moveTo(0,-h);context.lineTo(-r,h);context.lineTo(r,h);context.closePath()}},"triangle-down":{draw:function draw(context,size){var r=Math.sqrt(size)/2,h=HalfSqrt3*r;context.moveTo(0,h);context.lineTo(-r,-h);context.lineTo(r,-h);context.closePath()}},"triangle-right":{draw:function draw(context,size){var r=Math.sqrt(size)/2,h=HalfSqrt3*r;context.moveTo(h,0);context.lineTo(-h,-r);context.lineTo(-h,r);context.closePath()}},"triangle-left":{draw:function draw(context,size){var r=Math.sqrt(size)/2,h=HalfSqrt3*r;context.moveTo(-h,0);context.lineTo(h,-r);context.lineTo(h,r);context.closePath()}},stroke:{draw:function draw(context,size){var r=Math.sqrt(size)/2;context.moveTo(-r,0);context.lineTo(r,0)}}};function symbols$1(_){return _has(builtins,_)?builtins[_]:customSymbol(_)}var custom={};function customSymbol(path){if(!_has(custom,path)){var parsed=pathParse(path);custom[path]={draw:function draw(context,size){pathRender(context,parsed,0,0,Math.sqrt(size)/2)}}}return custom[path]}var C$1=.448084975506;function rectangleX(d){return d.x}function rectangleY(d){return d.y}function rectangleWidth(d){return d.width}function rectangleHeight(d){return d.height}function number$3(_){return typeof _==="function"?_:function(){return+_}}function clamp(value,min,max){return Math.max(min,Math.min(value,max))}function vg_rect(){var x=rectangleX,y=rectangleY,width=rectangleWidth,height=rectangleHeight,crTL=number$3(0),crTR=crTL,crBL=crTL,crBR=crTL,context=null;function rectangle(_,x0,y0){var buffer,x1=x0!=null?x0:+x.call(this,_),y1=y0!=null?y0:+y.call(this,_),w=+width.call(this,_),h=+height.call(this,_),s=Math.min(w,h)/2,tl=clamp(+crTL.call(this,_),0,s),tr=clamp(+crTR.call(this,_),0,s),bl=clamp(+crBL.call(this,_),0,s),br=clamp(+crBR.call(this,_),0,s);if(!context)context=buffer=path();if(tl<=0&&tr<=0&&bl<=0&&br<=0){context.rect(x1,y1,w,h)}else{var x2=x1+w,y2=y1+h;context.moveTo(x1+tl,y1);context.lineTo(x2-tr,y1);context.bezierCurveTo(x2-C$1*tr,y1,x2,y1+C$1*tr,x2,y1+tr);context.lineTo(x2,y2-br);context.bezierCurveTo(x2,y2-C$1*br,x2-C$1*br,y2,x2-br,y2);context.lineTo(x1+bl,y2);context.bezierCurveTo(x1+C$1*bl,y2,x1,y2-C$1*bl,x1,y2-bl);context.lineTo(x1,y1+tl);context.bezierCurveTo(x1,y1+C$1*tl,x1+C$1*tl,y1,x1+tl,y1);context.closePath()}if(buffer){context=null;return buffer+""||null}}rectangle.x=function(_){if(arguments.length){x=number$3(_);return rectangle}else{return x}};rectangle.y=function(_){if(arguments.length){y=number$3(_);return rectangle}else{return y}};rectangle.width=function(_){if(arguments.length){width=number$3(_);return rectangle}else{return width}};rectangle.height=function(_){if(arguments.length){height=number$3(_);return rectangle}else{return height}};rectangle.cornerRadius=function(tl,tr,br,bl){if(arguments.length){crTL=number$3(tl);crTR=tr!=null?number$3(tr):crTL;crBR=br!=null?number$3(br):crTL;crBL=bl!=null?number$3(bl):crTR;return rectangle}else{return crTL}};rectangle.context=function(_){if(arguments.length){context=_==null?null:_;return rectangle}else{return context}};return rectangle}function vg_trail(){var x,y,size,defined,context=null,ready,x1,y1,r1;function point(x2,y2,w2){var r2=w2/2;if(ready){var ux=y1-y2,uy=x2-x1;if(ux||uy){var ud=Math.sqrt(ux*ux+uy*uy),rx=(ux/=ud)*r1,ry=(uy/=ud)*r1,t=Math.atan2(uy,ux);context.moveTo(x1-rx,y1-ry);context.lineTo(x2-ux*r2,y2-uy*r2);context.arc(x2,y2,r2,t-Math.PI,t);context.lineTo(x1+rx,y1+ry);context.arc(x1,y1,r1,t,t+Math.PI)}else{context.arc(x2,y2,r2,0,Tau)}context.closePath()}else{ready=1}x1=x2;y1=y2;r1=r2}function trail(data){var i,n=data.length,d,defined0=false,buffer;if(context==null)context=buffer=path();for(i=0;i<=n;++i){if(!(i<n&&defined(d=data[i],i,data))===defined0){if(defined0=!defined0)ready=0}if(defined0)point(+x(d,i,data),+y(d,i,data),+size(d,i,data))}if(buffer){context=null;return buffer+""||null}}trail.x=function(_){if(arguments.length){x=_;return trail}else{return x}};trail.y=function(_){if(arguments.length){y=_;return trail}else{return y}};trail.size=function(_){if(arguments.length){size=_;return trail}else{return size}};trail.defined=function(_){if(arguments.length){defined=_;return trail}else{return defined}};trail.context=function(_){if(arguments.length){if(_==null){context=null}else{context=_}return trail}else{return context}};return trail}function value(a,b){return a!=null?a:b}var x$1=function x(item){return item.x||0},y$1=function y(item){return item.y||0},w=function w(item){return item.width||0},h=function h(item){return item.height||0},xw=function xw(item){return(item.x||0)+(item.width||0)},yh=function yh(item){return(item.y||0)+(item.height||0)},sa=function sa(item){return item.startAngle||0},ea=function ea(item){return item.endAngle||0},pa=function pa(item){return item.padAngle||0},ir=function ir(item){return item.innerRadius||0},or=function or(item){return item.outerRadius||0},cr=function cr(item){return item.cornerRadius||0},tl=function tl(item){return value(item.cornerRadiusTopLeft,item.cornerRadius)||0},tr=function tr(item){return value(item.cornerRadiusTopRight,item.cornerRadius)||0},br=function br(item){return value(item.cornerRadiusBottomRight,item.cornerRadius)||0},bl=function bl(item){return value(item.cornerRadiusBottomLeft,item.cornerRadius)||0},sz=function sz(item){return value(item.size,64)},ts=function ts(item){return item.size||1},def=function def(item){return!(item.defined===false)},type=function type(item){return symbols$1(item.shape||"circle")};var arcShape=arc$2().startAngle(sa).endAngle(ea).padAngle(pa).innerRadius(ir).outerRadius(or).cornerRadius(cr),areavShape=area$2().x(x$1).y1(y$1).y0(yh).defined(def),areahShape=area$2().y(y$1).x1(x$1).x0(xw).defined(def),lineShape=line$2().x(x$1).y(y$1).defined(def),rectShape=vg_rect().x(x$1).y(y$1).width(w).height(h).cornerRadius(tl,tr,br,bl),symbolShape=symbol$2().type(type).size(sz),trailShape=vg_trail().x(x$1).y(y$1).defined(def).size(ts);function hasCornerRadius(item){return item.cornerRadius||item.cornerRadiusTopLeft||item.cornerRadiusTopRight||item.cornerRadiusBottomRight||item.cornerRadiusBottomLeft}function arc(context,item){return arcShape.context(context)(item)}function area(context,items){var item=items[0],interp=item.interpolate||"linear";return(item.orient==="horizontal"?areahShape:areavShape).curve(curves(interp,item.orient,item.tension)).context(context)(items)}function line(context,items){var item=items[0],interp=item.interpolate||"linear";return lineShape.curve(curves(interp,item.orient,item.tension)).context(context)(items)}function rectangle(context,item,x,y){return rectShape.context(context)(item,x,y)}function shape(context,item){return(item.mark.shape||item.shape).context(context)(item)}function symbol(context,item){return symbolShape.context(context)(item)}function trail(context,items){return trailShape.context(context)(items)}var clip_id=1;function resetSVGClipId(){clip_id=1}function clip(renderer,item,size){var clip=item.clip,defs=renderer._defs,id=item.clip_id||(item.clip_id="clip"+clip_id++),c=defs.clipping[id]||(defs.clipping[id]={id:id});if(isFunction(clip)){c.path=clip(null)}else if(hasCornerRadius(size)){c.path=rectangle(null,size,0,0)}else{c.width=size.width||0;c.height=size.height||0}return"url(#"+id+")"}function Bounds(b){this.clear();if(b)this.union(b)}Bounds.prototype={clone:function clone(){return new Bounds(this)},clear:function clear(){this.x1=+Number.MAX_VALUE;this.y1=+Number.MAX_VALUE;this.x2=-Number.MAX_VALUE;this.y2=-Number.MAX_VALUE;return this},empty:function empty(){return this.x1===+Number.MAX_VALUE&&this.y1===+Number.MAX_VALUE&&this.x2===-Number.MAX_VALUE&&this.y2===-Number.MAX_VALUE},equals:function equals(b){return this.x1===b.x1&&this.y1===b.y1&&this.x2===b.x2&&this.y2===b.y2},set:function set(x1,y1,x2,y2){if(x2<x1){this.x2=x1;this.x1=x2}else{this.x1=x1;this.x2=x2}if(y2<y1){this.y2=y1;this.y1=y2}else{this.y1=y1;this.y2=y2}return this},add:function add(x,y){if(x<this.x1)this.x1=x;if(y<this.y1)this.y1=y;if(x>this.x2)this.x2=x;if(y>this.y2)this.y2=y;return this},expand:function expand(d){this.x1-=d;this.y1-=d;this.x2+=d;this.y2+=d;return this},round:function round(){this.x1=Math.floor(this.x1);this.y1=Math.floor(this.y1);this.x2=Math.ceil(this.x2);this.y2=Math.ceil(this.y2);return this},scale:function scale(s){this.x1*=s;this.y1*=s;this.x2*=s;this.y2*=s;return this},translate:function translate(dx,dy){this.x1+=dx;this.x2+=dx;this.y1+=dy;this.y2+=dy;return this},rotate:function rotate(angle,x,y){var p=this.rotatedPoints(angle,x,y);return this.clear().add(p[0],p[1]).add(p[2],p[3]).add(p[4],p[5]).add(p[6],p[7])},rotatedPoints:function rotatedPoints(angle,x,y){var x1=this.x1,y1=this.y1,x2=this.x2,y2=this.y2,cos=Math.cos(angle),sin=Math.sin(angle),cx=x-x*cos+y*sin,cy=y-x*sin-y*cos;return[cos*x1-sin*y1+cx,sin*x1+cos*y1+cy,cos*x1-sin*y2+cx,sin*x1+cos*y2+cy,cos*x2-sin*y1+cx,sin*x2+cos*y1+cy,cos*x2-sin*y2+cx,sin*x2+cos*y2+cy]},union:function union(b){if(b.x1<this.x1)this.x1=b.x1;if(b.y1<this.y1)this.y1=b.y1;if(b.x2>this.x2)this.x2=b.x2;if(b.y2>this.y2)this.y2=b.y2;return this},intersect:function intersect(b){if(b.x1>this.x1)this.x1=b.x1;if(b.y1>this.y1)this.y1=b.y1;if(b.x2<this.x2)this.x2=b.x2;if(b.y2<this.y2)this.y2=b.y2;return this},encloses:function encloses(b){return b&&this.x1<=b.x1&&this.x2>=b.x2&&this.y1<=b.y1&&this.y2>=b.y2},alignsWith:function alignsWith(b){return b&&(this.x1==b.x1||this.x2==b.x2||this.y1==b.y1||this.y2==b.y2)},intersects:function intersects(b){return b&&!(this.x2<b.x1||this.x1>b.x2||this.y2<b.y1||this.y1>b.y2)},contains:function contains(x,y){return!(x<this.x1||x>this.x2||y<this.y1||y>this.y2)},width:function width(){return this.x2-this.x1},height:function height(){return this.y2-this.y1}};function Item(mark){this.mark=mark;this.bounds=this.bounds||new Bounds}function GroupItem(mark){Item.call(this,mark);this.items=this.items||[]}inherits(GroupItem,Item);function ResourceLoader(customLoader){this._pending=0;this._loader=customLoader||loader()}function increment(loader){loader._pending+=1}function decrement(loader){loader._pending-=1}ResourceLoader.prototype={pending:function pending(){return this._pending},sanitizeURL:function sanitizeURL(uri){var loader=this;increment(loader);return loader._loader.sanitize(uri,{context:"href"}).then((function(opt){decrement(loader);return opt})).catch((function(){decrement(loader);return null}))},loadImage:function loadImage(uri){var loader=this,Image=domImage();increment(loader);return loader._loader.sanitize(uri,{context:"image"}).then((function(opt){var url=opt.href;if(!url||!Image)throw{url:url};var img=new Image;var cors=_has(opt,"crossOrigin")?opt.crossOrigin:"anonymous";if(cors!=null)img.crossOrigin=cors;img.onload=function(){return decrement(loader)};img.onerror=function(){return decrement(loader)};img.src=url;return img})).catch((function(e){decrement(loader);return{complete:false,width:0,height:0,src:e&&e.url||""}}))},ready:function ready(){var loader=this;return new Promise((function(accept){function poll(value){if(!loader.pending())accept(value);else setTimeout((function(){poll(true)}),10)}poll(false)}))}};function boundStroke(bounds,item,miter){if(item.stroke&&item.opacity!==0&&item.strokeOpacity!==0){var sw=item.strokeWidth!=null?+item.strokeWidth:1;bounds.expand(sw+(miter?miterAdjustment(item,sw):0))}return bounds}function miterAdjustment(item,strokeWidth){return item.strokeJoin&&item.strokeJoin!=="miter"?0:strokeWidth}var circleThreshold=Tau-1e-8;var bounds,lx,ly,rot,ma,mb,mc,md;var add$2=function add(x,y){return bounds.add(x,y)};var addL=function addL(x,y){return add$2(lx=x,ly=y)};var addX=function addX(x){return add$2(x,bounds.y1)};var addY=function addY(y){return add$2(bounds.x1,y)};var px=function px(x,y){return ma*x+mc*y};var py=function py(x,y){return mb*x+md*y};var addp=function addp(x,y){return add$2(px(x,y),py(x,y))};var addpL=function addpL(x,y){return addL(px(x,y),py(x,y))};function boundContext(_,deg){bounds=_;if(deg){rot=deg*DegToRad;ma=md=Math.cos(rot);mb=Math.sin(rot);mc=-mb}else{ma=md=1;rot=mb=mc=0}return context}var context={beginPath:function beginPath(){},closePath:function closePath(){},moveTo:addpL,lineTo:addpL,rect:function rect(x,y,w,h){if(rot){addp(x+w,y);addp(x+w,y+h);addp(x,y+h);addpL(x,y)}else{add$2(x+w,y+h);addL(x,y)}},quadraticCurveTo:function quadraticCurveTo(x1,y1,x2,y2){var px1=px(x1,y1),py1=py(x1,y1),px2=px(x2,y2),py2=py(x2,y2);quadExtrema(lx,px1,px2,addX);quadExtrema(ly,py1,py2,addY);addL(px2,py2)},bezierCurveTo:function bezierCurveTo(x1,y1,x2,y2,x3,y3){var px1=px(x1,y1),py1=py(x1,y1),px2=px(x2,y2),py2=py(x2,y2),px3=px(x3,y3),py3=py(x3,y3);cubicExtrema(lx,px1,px2,px3,addX);cubicExtrema(ly,py1,py2,py3,addY);addL(px3,py3)},arc:function arc(cx,cy,r,sa,ea,ccw){sa+=rot;ea+=rot;lx=r*Math.cos(ea)+cx;ly=r*Math.sin(ea)+cy;if(Math.abs(ea-sa)>circleThreshold){add$2(cx-r,cy-r);add$2(cx+r,cy+r)}else{var update=function update(a){return add$2(r*Math.cos(a)+cx,r*Math.sin(a)+cy)};var s,i;update(sa);update(ea);if(ea!==sa){sa=sa%Tau;if(sa<0)sa+=Tau;ea=ea%Tau;if(ea<0)ea+=Tau;if(ea<sa){ccw=!ccw;s=sa;sa=ea;ea=s}if(ccw){ea-=Tau;s=sa-sa%HalfPi;for(i=0;i<4&&s>ea;++i,s-=HalfPi){update(s)}}else{s=sa-sa%HalfPi+HalfPi;for(i=0;i<4&&s<ea;++i,s=s+HalfPi){update(s)}}}}}};function quadExtrema(x0,x1,x2,cb){var t=(x0-x1)/(x0+x2-2*x1);if(0<t&&t<1)cb(x0+(x1-x0)*t)}function cubicExtrema(x0,x1,x2,x3,cb){var a=x3-x0+3*x1-3*x2,b=x0+x2-2*x1,c=x0-x1;var t0=0,t1=0,r;if(Math.abs(a)>Epsilon){r=b*b+c*a;if(r>=0){r=Math.sqrt(r);t0=(-b+r)/a;t1=(-b-r)/a}}else{t0=.5*c/b}if(0<t0&&t0<1)cb(cubic(t0,x0,x1,x2,x3));if(0<t1&&t1<1)cb(cubic(t1,x0,x1,x2,x3))}function cubic(t,x0,x1,x2,x3){var s=1-t,s2=s*s,t2=t*t;return s2*s*x0+3*s2*t*x1+3*s*t2*x2+t2*t*x3}var context$1=(context$1=domCanvas(1,1))?context$1.getContext("2d"):null;var b=new Bounds;function intersectPath(draw){return function(item,brush){if(!context$1)return true;draw(context$1,item);b.clear().union(item.bounds).intersect(brush).round();var x1=b.x1,y1=b.y1,x2=b.x2,y2=b.y2;for(var _y=y1;_y<=y2;++_y){for(var _x=x1;_x<=x2;++_x){if(context$1.isPointInPath(_x,_y)){return true}}}return false}}function intersectPoint(item,box){return box.contains(item.x||0,item.y||0)}function intersectRect(item,box){var x=item.x||0,y=item.y||0,w=item.width||0,h=item.height||0;return box.intersects(b.set(x,y,x+w,y+h))}function intersectRule(item,box){var x=item.x||0,y=item.y||0,x2=item.x2!=null?item.x2:x,y2=item.y2!=null?item.y2:y;return intersectBoxLine(box,x,y,x2,y2)}function intersectBoxLine(box,x,y,u,v){var x1=box.x1,y1=box.y1,x2=box.x2,y2=box.y2,dx=u-x,dy=v-y;var t0=0,t1=1,p,q,r,e;for(e=0;e<4;++e){if(e===0){p=-dx;q=-(x1-x)}if(e===1){p=dx;q=x2-x}if(e===2){p=-dy;q=-(y1-y)}if(e===3){p=dy;q=y2-y}if(Math.abs(p)<1e-10&&q<0)return false;r=q/p;if(p<0){if(r>t1)return false;else if(r>t0)t0=r}else if(p>0){if(r<t0)return false;else if(r<t1)t1=r}}return true}function blend(context,item){context.globalCompositeOperation=item.blend||"source-over"}function value$1(value,dflt){return value==null?dflt:value}function addStops(gradient,stops){var n=stops.length;for(var i=0;i<n;++i){gradient.addColorStop(stops[i].offset,stops[i].color)}return gradient}function gradient(context,spec,bounds){var w=bounds.width(),h=bounds.height();var gradient;if(spec.gradient==="radial"){gradient=context.createRadialGradient(bounds.x1+value$1(spec.x1,.5)*w,bounds.y1+value$1(spec.y1,.5)*h,Math.max(w,h)*value$1(spec.r1,0),bounds.x1+value$1(spec.x2,.5)*w,bounds.y1+value$1(spec.y2,.5)*h,Math.max(w,h)*value$1(spec.r2,.5))}else{var x1=value$1(spec.x1,0),y1=value$1(spec.y1,0),x2=value$1(spec.x2,1),y2=value$1(spec.y2,0);if(x1===x2||y1===y2||w===h){gradient=context.createLinearGradient(bounds.x1+x1*w,bounds.y1+y1*h,bounds.x1+x2*w,bounds.y1+y2*h)}else{var _image=domCanvas(Math.ceil(w),Math.ceil(h)),ictx=_image.getContext("2d");ictx.scale(w,h);ictx.fillStyle=addStops(ictx.createLinearGradient(x1,y1,x2,y2),spec.stops);ictx.fillRect(0,0,w,h);return context.createPattern(_image,"no-repeat")}}return addStops(gradient,spec.stops)}function color$1(context,item,value){return isGradient(value)?gradient(context,value,item.bounds):value}function fill(context,item,opacity){opacity*=item.fillOpacity==null?1:item.fillOpacity;if(opacity>0){context.globalAlpha=opacity;context.fillStyle=color$1(context,item,item.fill);return true}else{return false}}var Empty$1=[];function stroke(context,item,opacity){var lw=(lw=item.strokeWidth)!=null?lw:1;if(lw<=0)return false;opacity*=item.strokeOpacity==null?1:item.strokeOpacity;if(opacity>0){context.globalAlpha=opacity;context.strokeStyle=color$1(context,item,item.stroke);context.lineWidth=lw;context.lineCap=item.strokeCap||"butt";context.lineJoin=item.strokeJoin||"miter";context.miterLimit=item.strokeMiterLimit||10;if(context.setLineDash){context.setLineDash(item.strokeDash||Empty$1);context.lineDashOffset=item.strokeDashOffset||0}return true}else{return false}}function compare$1(a,b){return a.zindex-b.zindex||a.index-b.index}function zorder(scene){if(!scene.zdirty)return scene.zitems;var items=scene.items,output=[],item,i,n;for(i=0,n=items.length;i<n;++i){item=items[i];item.index=i;if(item.zindex)output.push(item)}scene.zdirty=false;return scene.zitems=output.sort(compare$1)}function visit(scene,visitor){var items=scene.items,i,n;if(!items||!items.length)return;var zitems=zorder(scene);if(zitems&&zitems.length){for(i=0,n=items.length;i<n;++i){if(!items[i].zindex)visitor(items[i])}items=zitems}for(i=0,n=items.length;i<n;++i){visitor(items[i])}}function pickVisit(scene,visitor){var items=scene.items,hit,i;if(!items||!items.length)return null;var zitems=zorder(scene);if(zitems&&zitems.length)items=zitems;for(i=items.length;--i>=0;){if(hit=visitor(items[i]))return hit}if(items===zitems){for(items=scene.items,i=items.length;--i>=0;){if(!items[i].zindex){if(hit=visitor(items[i]))return hit}}}return null}function drawAll(path){return function(context,scene,bounds){visit(scene,(function(item){if(!bounds||bounds.intersects(item.bounds)){drawPath(path,context,item,item)}}))}}function drawOne(path){return function(context,scene,bounds){if(scene.items.length&&(!bounds||bounds.intersects(scene.bounds))){drawPath(path,context,scene.items[0],scene.items)}}}function drawPath(path,context,item,items){var opacity=item.opacity==null?1:item.opacity;if(opacity===0)return;if(path(context,items))return;blend(context,item);if(item.fill&&fill(context,item,opacity)){context.fill()}if(item.stroke&&stroke(context,item,opacity)){context.stroke()}}function pick(test){test=test||truthy;return function(context,scene,x,y,gx,gy){x*=context.pixelRatio;y*=context.pixelRatio;return pickVisit(scene,(function(item){var b=item.bounds;if(b&&!b.contains(gx,gy)||!b)return;if(test(context,item,x,y,gx,gy))return item}))}}function hitPath(path,filled){return function(context,o,x,y){var item=Array.isArray(o)?o[0]:o,fill=filled==null?item.fill:filled,stroke=item.stroke&&context.isPointInStroke,lw,lc;if(stroke){lw=item.strokeWidth;lc=item.strokeCap;context.lineWidth=lw!=null?lw:1;context.lineCap=lc!=null?lc:"butt"}return path(context,o)?false:fill&&context.isPointInPath(x,y)||stroke&&context.isPointInStroke(x,y)}}function pickPath(path){return pick(hitPath(path))}function translate(x,y){return"translate("+x+","+y+")"}function rotate(a){return"rotate("+a+")"}function scale$1$1(scaleX,scaleY){return"scale("+scaleX+","+scaleY+")"}function translateItem(item){return translate(item.x||0,item.y||0)}function rotateItem(item){return translate(item.x||0,item.y||0)+(item.angle?" "+rotate(item.angle):"")}function transformItem(item){return translate(item.x||0,item.y||0)+(item.angle?" "+rotate(item.angle):"")+(item.scaleX||item.scaleY?" "+scale$1$1(item.scaleX||1,item.scaleY||1):"")}function markItemPath(type,shape,isect){function attr(emit,item){emit("transform",rotateItem(item));emit("d",shape(null,item))}function bound(bounds,item){shape(boundContext(bounds,item.angle),item);return boundStroke(bounds,item).translate(item.x||0,item.y||0)}function draw(context,item){var x=item.x||0,y=item.y||0,a=item.angle||0;context.translate(x,y);if(a)context.rotate(a*=DegToRad);context.beginPath();shape(context,item);if(a)context.rotate(-a);context.translate(-x,-y)}return{type:type,tag:"path",nested:false,attr:attr,bound:bound,draw:drawAll(draw),pick:pickPath(draw),isect:isect||intersectPath(draw)}}var arc$1=markItemPath("arc",arc);function pickArea(a,p){var v=a[0].orient==="horizontal"?p[1]:p[0],z=a[0].orient==="horizontal"?"y":"x",i=a.length,min=+Infinity,hit,d;while(--i>=0){if(a[i].defined===false)continue;d=Math.abs(a[i][z]-v);if(d<min){min=d;hit=a[i]}}return hit}function pickLine(a,p){var t=Math.pow(a[0].strokeWidth||1,2),i=a.length,dx,dy,dd;while(--i>=0){if(a[i].defined===false)continue;dx=a[i].x-p[0];dy=a[i].y-p[1];dd=dx*dx+dy*dy;if(dd<t)return a[i]}return null}function pickTrail(a,p){var i=a.length,dx,dy,dd;while(--i>=0){if(a[i].defined===false)continue;dx=a[i].x-p[0];dy=a[i].y-p[1];dd=dx*dx+dy*dy;dx=a[i].size||1;if(dd<dx*dx)return a[i]}return null}function markMultiItemPath(type,shape,tip){function attr(emit,item){var items=item.mark.items;if(items.length)emit("d",shape(null,items))}function bound(bounds,mark){var items=mark.items;if(items.length===0){return bounds}else{shape(boundContext(bounds),items);return boundStroke(bounds,items[0])}}function draw(context,items){context.beginPath();shape(context,items)}var hit=hitPath(draw);function pick(context,scene,x,y,gx,gy){var items=scene.items,b=scene.bounds;if(!items||!items.length||b&&!b.contains(gx,gy)){return null}x*=context.pixelRatio;y*=context.pixelRatio;return hit(context,items,x,y)?items[0]:null}return{type:type,tag:"path",nested:true,attr:attr,bound:bound,draw:drawOne(draw),pick:pick,isect:intersectPoint,tip:tip}}var area$1=markMultiItemPath("area",area,pickArea);function clip$1(context,scene){var clip=scene.clip;context.save();if(isFunction(clip)){context.beginPath();clip(context);context.clip()}else{clipGroup(context,scene.group)}}function clipGroup(context,group){context.beginPath();hasCornerRadius(group)?rectangle(context,group,0,0):context.rect(0,0,group.width||0,group.height||0);context.clip()}function offset$1(item){var sw=value$1(item.strokeWidth,1);return item.strokeOffset!=null?item.strokeOffset:item.stroke&&sw>.5&&sw<1.5?.5-Math.abs(sw-1):0}function attr(emit,item){emit("transform",translateItem(item))}function emitRectangle(emit,item){var off=offset$1(item);emit("d",rectangle(null,item,off,off))}function background(emit,item){emit("class","background");emit("aria-hidden",true);emitRectangle(emit,item)}function foreground(emit,item){emit("class","foreground");emit("aria-hidden",true);if(item.strokeForeground){emitRectangle(emit,item)}else{emit("d","")}}function content(emit,item,renderer){var url=item.clip?clip(renderer,item,item):null;emit("clip-path",url)}function bound(bounds,group){if(!group.clip&&group.items){var items=group.items,m=items.length;for(var j=0;j<m;++j){bounds.union(items[j].bounds)}}if((group.clip||group.width||group.height)&&!group.noBound){bounds.add(0,0).add(group.width||0,group.height||0)}boundStroke(bounds,group);return bounds.translate(group.x||0,group.y||0)}function rectanglePath(context,group,x,y){var off=offset$1(group);context.beginPath();rectangle(context,group,(x||0)+off,(y||0)+off)}var hitBackground=hitPath(rectanglePath);var hitForeground=hitPath(rectanglePath,false);var hitCorner=hitPath(rectanglePath,true);function draw(context,scene,bounds){var _this=this;visit(scene,(function(group){var gx=group.x||0,gy=group.y||0,fore=group.strokeForeground,opacity=group.opacity==null?1:group.opacity;if((group.stroke||group.fill)&&opacity){rectanglePath(context,group,gx,gy);blend(context,group);if(group.fill&&fill(context,group,opacity)){context.fill()}if(group.stroke&&!fore&&stroke(context,group,opacity)){context.stroke()}}context.save();context.translate(gx,gy);if(group.clip)clipGroup(context,group);if(bounds)bounds.translate(-gx,-gy);visit(group,(function(item){_this.draw(context,item,bounds)}));if(bounds)bounds.translate(gx,gy);context.restore();if(fore&&group.stroke&&opacity){rectanglePath(context,group,gx,gy);blend(context,group);if(stroke(context,group,opacity)){context.stroke()}}}))}function pick$1(context,scene,x,y,gx,gy){var _this2=this;if(scene.bounds&&!scene.bounds.contains(gx,gy)||!scene.items){return null}var cx=x*context.pixelRatio,cy=y*context.pixelRatio;return pickVisit(scene,(function(group){var hit,dx,dy;var b=group.bounds;if(b&&!b.contains(gx,gy))return;dx=group.x||0;dy=group.y||0;var dw=dx+(group.width||0),dh=dy+(group.height||0),c=group.clip;if(c&&(gx<dx||gx>dw||gy<dy||gy>dh))return;context.save();context.translate(dx,dy);dx=gx-dx;dy=gy-dy;if(c&&hasCornerRadius(group)&&!hitCorner(context,group,cx,cy)){context.restore();return null}var fore=group.strokeForeground,ix=scene.interactive!==false;if(ix&&fore&&group.stroke&&hitForeground(context,group,cx,cy)){context.restore();return group}hit=pickVisit(group,(function(mark){return pickMark(mark,dx,dy)?_this2.pick(mark,x,y,dx,dy):null}));if(!hit&&ix&&(group.fill||!fore&&group.stroke)&&hitBackground(context,group,cx,cy)){hit=group}context.restore();return hit||null}))}function pickMark(mark,x,y){return(mark.interactive!==false||mark.marktype==="group")&&mark.bounds&&mark.bounds.contains(x,y)}var group={type:"group",tag:"g",nested:false,attr:attr,bound:bound,draw:draw,pick:pick$1,isect:intersectRect,content:content,background:background,foreground:foreground};var metadata={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",version:"1.1"};function getImage(item,renderer){var image=item.image;if(!image||item.url&&item.url!==image.url){image={complete:false,width:0,height:0};renderer.loadImage(item.url).then((function(image){item.image=image;item.image.url=item.url}))}return image}function imageWidth(item,image){return item.width!=null?item.width:!image||!image.width?0:item.aspect!==false&&item.height?item.height*image.width/image.height:image.width}function imageHeight(item,image){return item.height!=null?item.height:!image||!image.height?0:item.aspect!==false&&item.width?item.width*image.height/image.width:image.height}function imageXOffset(align,w){return align==="center"?w/2:align==="right"?w:0}function imageYOffset(baseline,h){return baseline==="middle"?h/2:baseline==="bottom"?h:0}function attr$1(emit,item,renderer){var img=getImage(item,renderer),w=imageWidth(item,img),h=imageHeight(item,img),x=(item.x||0)-imageXOffset(item.align,w),y=(item.y||0)-imageYOffset(item.baseline,h),i=!img.src&&img.toDataURL?img.toDataURL():img.src||"";emit("href",i,metadata["xmlns:xlink"],"xlink:href");emit("transform",translate(x,y));emit("width",w);emit("height",h);emit("preserveAspectRatio",item.aspect===false?"none":"xMidYMid")}function bound$1(bounds,item){var img=item.image,w=imageWidth(item,img),h=imageHeight(item,img),x=(item.x||0)-imageXOffset(item.align,w),y=(item.y||0)-imageYOffset(item.baseline,h);return bounds.set(x,y,x+w,y+h)}function draw$1(context,scene,bounds){var _this3=this;visit(scene,(function(item){if(bounds&&!bounds.intersects(item.bounds))return;var img=getImage(item,_this3);var w=imageWidth(item,img),h=imageHeight(item,img),x=(item.x||0)-imageXOffset(item.align,w),y=(item.y||0)-imageYOffset(item.baseline,h),opacity,ar0,ar1,t;if(item.aspect!==false){ar0=img.width/img.height;ar1=item.width/item.height;if(ar0===ar0&&ar1===ar1&&ar0!==ar1){if(ar1<ar0){t=w/ar0;y+=(h-t)/2;h=t}else{t=h*ar0;x+=(w-t)/2;w=t}}}if(img.complete||img.toDataURL){blend(context,item);context.globalAlpha=(opacity=item.opacity)!=null?opacity:1;context.imageSmoothingEnabled=item.smooth!==false;context.drawImage(img,x,y,w,h)}}))}var image={type:"image",tag:"image",nested:false,attr:attr$1,bound:bound$1,draw:draw$1,pick:pick(),isect:truthy,get:getImage,xOffset:imageXOffset,yOffset:imageYOffset};var line$1=markMultiItemPath("line",line,pickLine);function attr$2(emit,item){var sx=item.scaleX||1,sy=item.scaleY||1;if(sx!==1||sy!==1){emit("vector-effect","non-scaling-stroke")}emit("transform",transformItem(item));emit("d",item.path)}function path$1(context,item){var path=item.path;if(path==null)return true;var x=item.x||0,y=item.y||0,sx=item.scaleX||1,sy=item.scaleY||1,a=(item.angle||0)*DegToRad,cache=item.pathCache;if(!cache||cache.path!==path){(item.pathCache=cache=pathParse(path)).path=path}if(a&&context.rotate&&context.translate){context.translate(x,y);context.rotate(a);pathRender(context,cache,0,0,sx,sy);context.rotate(-a);context.translate(-x,-y)}else{pathRender(context,cache,x,y,sx,sy)}}function bound$2(bounds,item){return path$1(boundContext(bounds,item.angle),item)?bounds.set(0,0,0,0):boundStroke(bounds,item,true)}var path$1$1={type:"path",tag:"path",nested:false,attr:attr$2,bound:bound$2,draw:drawAll(path$1),pick:pickPath(path$1),isect:intersectPath(path$1)};function attr$3(emit,item){emit("d",rectangle(null,item))}function bound$3(bounds,item){var x,y;return boundStroke(bounds.set(x=item.x||0,y=item.y||0,x+item.width||0,y+item.height||0),item)}function draw$2(context,item){context.beginPath();rectangle(context,item)}var rect={type:"rect",tag:"path",nested:false,attr:attr$3,bound:bound$3,draw:drawAll(draw$2),pick:pickPath(draw$2),isect:intersectRect};function attr$4(emit,item){emit("transform",translateItem(item));emit("x2",item.x2!=null?item.x2-(item.x||0):0);emit("y2",item.y2!=null?item.y2-(item.y||0):0)}function bound$4(bounds,item){var x1,y1;return boundStroke(bounds.set(x1=item.x||0,y1=item.y||0,item.x2!=null?item.x2:x1,item.y2!=null?item.y2:y1),item)}function path$2(context,item,opacity){var x1,y1,x2,y2;if(item.stroke&&stroke(context,item,opacity)){x1=item.x||0;y1=item.y||0;x2=item.x2!=null?item.x2:x1;y2=item.y2!=null?item.y2:y1;context.beginPath();context.moveTo(x1,y1);context.lineTo(x2,y2);return true}return false}function draw$3(context,scene,bounds){visit(scene,(function(item){if(bounds&&!bounds.intersects(item.bounds))return;var opacity=item.opacity==null?1:item.opacity;if(opacity&&path$2(context,item,opacity)){blend(context,item);context.stroke()}}))}function hit(context,item,x,y){if(!context.isPointInStroke)return false;return path$2(context,item,1)&&context.isPointInStroke(x,y)}var rule={type:"rule",tag:"line",nested:false,attr:attr$4,bound:bound$4,draw:draw$3,pick:pick(hit),isect:intersectRule};var shape$1=markItemPath("shape",shape);var symbol$1=markItemPath("symbol",symbol,intersectPoint);var widthCache=lruCache();var textMetrics={height:fontSize,measureWidth:measureWidth,estimateWidth:estimateWidth,width:estimateWidth,canvas:useCanvas};useCanvas(true);function useCanvas(use){textMetrics.width=use&&context$1?measureWidth:estimateWidth}function estimateWidth(item,text){return _estimateWidth(textValue(item,text),fontSize(item))}function _estimateWidth(text,currentFontHeight){return~~(.8*text.length*currentFontHeight)}function measureWidth(item,text){return fontSize(item)<=0||!(text=textValue(item,text))?0:_measureWidth(text,font(item))}function _measureWidth(text,currentFont){var key="(".concat(currentFont,") ").concat(text);var width=widthCache.get(key);if(width===undefined){context$1.font=currentFont;width=context$1.measureText(text).width;widthCache.set(key,width)}return width}function fontSize(item){return item.fontSize!=null?+item.fontSize||0:11}function lineHeight(item){return item.lineHeight!=null?item.lineHeight:fontSize(item)+2}function lineArray(_){return isArray(_)?_.length>1?_:_[0]:_}function textLines(item){return lineArray(item.lineBreak&&item.text&&!isArray(item.text)?item.text.split(item.lineBreak):item.text)}function multiLineOffset(item){var tl=textLines(item);return(isArray(tl)?tl.length-1:0)*lineHeight(item)}function textValue(item,line){var text=line==null?"":(line+"").trim();return item.limit>0&&text.length?truncate$1(item,text):text}function widthGetter(item){if(textMetrics.width===measureWidth){var currentFont=font(item);return function(text){return _measureWidth(text,currentFont)}}else{var currentFontHeight=fontSize(item);return function(text){return _estimateWidth(text,currentFontHeight)}}}function truncate$1(item,text){var limit=+item.limit,width=widthGetter(item);if(width(text)<limit)return text;var ellipsis=item.ellipsis||"",rtl=item.dir==="rtl",lo=0,hi=text.length,mid;limit-=width(ellipsis);if(rtl){while(lo<hi){mid=lo+hi>>>1;if(width(text.slice(mid))>limit)lo=mid+1;else hi=mid}return ellipsis+text.slice(lo)}else{while(lo<hi){mid=1+(lo+hi>>>1);if(width(text.slice(0,mid))<limit)lo=mid;else hi=mid-1}return text.slice(0,lo)+ellipsis}}function fontFamily(item,quote){var font=item.font;return(quote&&font?String(font).replace(/"/g,"'"):font)||"sans-serif"}function font(item,quote){return""+(item.fontStyle?item.fontStyle+" ":"")+(item.fontVariant?item.fontVariant+" ":"")+(item.fontWeight?item.fontWeight+" ":"")+fontSize(item)+"px "+fontFamily(item,quote)}function offset$1$1(item){var baseline=item.baseline,h=fontSize(item);return Math.round(baseline==="top"?.79*h:baseline==="middle"?.3*h:baseline==="bottom"?-.21*h:baseline==="line-top"?.29*h+.5*lineHeight(item):baseline==="line-bottom"?.29*h-.5*lineHeight(item):0)}var textAlign={left:"start",center:"middle",right:"end"};var tempBounds=new Bounds;function anchorPoint(item){var x=item.x||0,y=item.y||0,r=item.radius||0,t;if(r){t=(item.theta||0)-HalfPi;x+=r*Math.cos(t);y+=r*Math.sin(t)}tempBounds.x1=x;tempBounds.y1=y;return tempBounds}function attr$5(emit,item){var dx=item.dx||0,dy=(item.dy||0)+offset$1$1(item),p=anchorPoint(item),x=p.x1,y=p.y1,a=item.angle||0,t;emit("text-anchor",textAlign[item.align]||"start");if(a){t=translate(x,y)+" "+rotate(a);if(dx||dy)t+=" "+translate(dx,dy)}else{t=translate(x+dx,y+dy)}emit("transform",t)}function bound$5(bounds,item,mode){var h=textMetrics.height(item),a=item.align,p=anchorPoint(item),x=p.x1,y=p.y1,dx=item.dx||0,dy=(item.dy||0)+offset$1$1(item)-Math.round(.8*h),tl=textLines(item),w;if(isArray(tl)){h+=lineHeight(item)*(tl.length-1);w=tl.reduce((function(w,t){return Math.max(w,textMetrics.width(item,t))}),0)}else{w=textMetrics.width(item,tl)}if(a==="center"){dx-=w/2}else if(a==="right"){dx-=w}else;bounds.set(dx+=x,dy+=y,dx+w,dy+h);if(item.angle&&!mode){bounds.rotate(item.angle*DegToRad,x,y)}else if(mode===2){return bounds.rotatedPoints(item.angle*DegToRad,x,y)}return bounds}function draw$4(context,scene,bounds){visit(scene,(function(item){var opacity=item.opacity==null?1:item.opacity,p,x,y,i,lh,tl,str;if(bounds&&!bounds.intersects(item.bounds)||opacity===0||item.fontSize<=0||item.text==null||item.text.length===0)return;context.font=font(item);context.textAlign=item.align||"left";p=anchorPoint(item);x=p.x1,y=p.y1;if(item.angle){context.save();context.translate(x,y);context.rotate(item.angle*DegToRad);x=y=0}x+=item.dx||0;y+=(item.dy||0)+offset$1$1(item);tl=textLines(item);blend(context,item);if(isArray(tl)){lh=lineHeight(item);for(i=0;i<tl.length;++i){str=textValue(item,tl[i]);if(item.fill&&fill(context,item,opacity)){context.fillText(str,x,y)}if(item.stroke&&stroke(context,item,opacity)){context.strokeText(str,x,y)}y+=lh}}else{str=textValue(item,tl);if(item.fill&&fill(context,item,opacity)){context.fillText(str,x,y)}if(item.stroke&&stroke(context,item,opacity)){context.strokeText(str,x,y)}}if(item.angle)context.restore()}))}function hit$1(context,item,x,y,gx,gy){if(item.fontSize<=0)return false;if(!item.angle)return true;var p=anchorPoint(item),ax=p.x1,ay=p.y1,b=bound$5(tempBounds,item,1),a=-item.angle*DegToRad,cos=Math.cos(a),sin=Math.sin(a),px=cos*gx-sin*gy+(ax-cos*ax+sin*ay),py=sin*gx+cos*gy+(ay-sin*ax-cos*ay);return b.contains(px,py)}function intersectText(item,box){var p=bound$5(tempBounds,item,2);return intersectBoxLine(box,p[0],p[1],p[2],p[3])||intersectBoxLine(box,p[0],p[1],p[4],p[5])||intersectBoxLine(box,p[4],p[5],p[6],p[7])||intersectBoxLine(box,p[2],p[3],p[6],p[7])}var text={type:"text",tag:"text",nested:false,attr:attr$5,bound:bound$5,draw:draw$4,pick:pick(hit$1),isect:intersectText};var trail$1=markMultiItemPath("trail",trail,pickTrail);var Marks={arc:arc$1,area:area$1,group:group,image:image,line:line$1,path:path$1$1,rect:rect,rule:rule,shape:shape$1,symbol:symbol$1,text:text,trail:trail$1};function boundItem(item,func,opt){var type=Marks[item.mark.marktype],bound=func||type.bound;if(type.nested)item=item.mark;return bound(item.bounds||(item.bounds=new Bounds),item,opt)}var DUMMY={mark:null};function boundMark(mark,bounds,opt){var type=Marks[mark.marktype],bound=type.bound,items=mark.items,hasItems=items&&items.length,i,n,item,b;if(type.nested){if(hasItems){item=items[0]}else{DUMMY.mark=mark;item=DUMMY}b=boundItem(item,bound,opt);bounds=bounds&&bounds.union(b)||b;return bounds}bounds=bounds||mark.bounds&&mark.bounds.clear()||new Bounds;if(hasItems){for(i=0,n=items.length;i<n;++i){bounds.union(boundItem(items[i],bound,opt))}}return mark.bounds=bounds}var keys=["marktype","name","role","interactive","clip","items","zindex","x","y","width","height","align","baseline","fill","fillOpacity","opacity","blend","stroke","strokeOpacity","strokeWidth","strokeCap","strokeDash","strokeDashOffset","strokeForeground","strokeOffset","startAngle","endAngle","innerRadius","outerRadius","cornerRadius","padAngle","cornerRadiusTopLeft","cornerRadiusTopRight","cornerRadiusBottomLeft","cornerRadiusBottomRight","interpolate","tension","orient","defined","url","aspect","smooth","path","scaleX","scaleY","x2","y2","size","shape","text","angle","theta","radius","dir","dx","dy","ellipsis","limit","lineBreak","lineHeight","font","fontSize","fontWeight","fontStyle","fontVariant","description","aria","ariaRole","ariaRoleDescription"];function sceneToJSON(scene,indent){return JSON.stringify(scene,keys,indent)}function sceneFromJSON(json){var scene=typeof json==="string"?JSON.parse(json):json;return initialize(scene)}function initialize(scene){var type=scene.marktype,items=scene.items,parent,i,n;if(items){for(i=0,n=items.length;i<n;++i){parent=type?"mark":"group";items[i][parent]=scene;if(items[i].zindex)items[i][parent].zdirty=true;if("group"===(type||parent))initialize(items[i])}}if(type)boundMark(scene);return scene}function Scenegraph(scene){if(arguments.length){this.root=sceneFromJSON(scene)}else{this.root=createMark({marktype:"group",name:"root",role:"frame"});this.root.items=[new GroupItem(this.root)]}}Scenegraph.prototype={toJSON:function toJSON(indent){return sceneToJSON(this.root,indent||0)},mark:function mark(markdef,group,index){group=group||this.root.items[0];var mark=createMark(markdef,group);group.items[index]=mark;if(mark.zindex)mark.group.zdirty=true;return mark}};function createMark(def,group){var mark={bounds:new Bounds,clip:!!def.clip,group:group,interactive:def.interactive===false?false:true,items:[],marktype:def.marktype,name:def.name||undefined,role:def.role||undefined,zindex:def.zindex||0};if(def.aria!=null){mark.aria=def.aria}if(def.description){mark.description=def.description}return mark}function domCreate(doc,tag,ns){if(!doc&&typeof document!=="undefined"&&document.createElement){doc=document}return doc?ns?doc.createElementNS(ns,tag):doc.createElement(tag):null}function domFind(el,tag){tag=tag.toLowerCase();var nodes=el.childNodes,i=0,n=nodes.length;for(;i<n;++i){if(nodes[i].tagName.toLowerCase()===tag){return nodes[i]}}}function domChild(el,index,tag,ns){var a=el.childNodes[index],b;if(!a||a.tagName.toLowerCase()!==tag.toLowerCase()){b=a||null;a=domCreate(el.ownerDocument,tag,ns);el.insertBefore(a,b)}return a}function domClear(el,index){var nodes=el.childNodes,curr=nodes.length;while(curr>index){el.removeChild(nodes[--curr])}return el}function cssClass(mark){return"mark-"+mark.marktype+(mark.role?" role-"+mark.role:"")+(mark.name?" "+mark.name:"")}function point$1(event,el){var rect=el.getBoundingClientRect();return[event.clientX-rect.left-(el.clientLeft||0),event.clientY-rect.top-(el.clientTop||0)]}function resolveItem(item,event,el,origin){var mark=item&&item.mark,mdef,p;if(mark&&(mdef=Marks[mark.marktype]).tip){p=point$1(event,el);p[0]-=origin[0];p[1]-=origin[1];while(item=item.mark.group){p[0]-=item.x||0;p[1]-=item.y||0}item=mdef.tip(mark.items,p)}return item}function Handler(customLoader,customTooltip){this._active=null;this._handlers={};this._loader=customLoader||loader();this._tooltip=customTooltip||defaultTooltip}function defaultTooltip(handler,event,item,value){handler.element().setAttribute("title",value||"")}Handler.prototype={initialize:function initialize(el,origin,obj){this._el=el;this._obj=obj||null;return this.origin(origin)},element:function element(){return this._el},canvas:function canvas(){return this._el&&this._el.firstChild},origin:function origin(_origin){if(arguments.length){this._origin=_origin||[0,0];return this}else{return this._origin.slice()}},scene:function scene(_scene){if(!arguments.length)return this._scene;this._scene=_scene;return this},on:function on(){},off:function off(){},_handlerIndex:function _handlerIndex(h,type,handler){for(var i=h?h.length:0;--i>=0;){if(h[i].type===type&&(!handler||h[i].handler===handler)){return i}}return-1},handlers:function handlers(type){var h=this._handlers,a=[];if(type){a.push.apply(a,_toConsumableArray(h[this.eventName(type)]))}else{for(var k in h){a.push.apply(a,_toConsumableArray(h[k]))}}return a},eventName:function eventName(name){var i=name.indexOf(".");return i<0?name:name.slice(0,i)},handleHref:function handleHref(event,item,href){this._loader.sanitize(href,{context:"href"}).then((function(opt){var e=new MouseEvent(event.type,event),a=domCreate(null,"a");for(var name in opt){a.setAttribute(name,opt[name])}a.dispatchEvent(e)})).catch((function(){}))},handleTooltip:function handleTooltip(event,item,show){if(item&&item.tooltip!=null){item=resolveItem(item,event,this.canvas(),this._origin);var _value=show&&item&&item.tooltip||null;this._tooltip.call(this._obj,this,event,item,_value)}},getItemBoundingClientRect:function getItemBoundingClientRect(item){var el=this.canvas();if(!el)return;var rect=el.getBoundingClientRect(),origin=this._origin,bounds=item.bounds,width=bounds.width(),height=bounds.height();var x=bounds.x1+origin[0]+rect.left,y=bounds.y1+origin[1]+rect.top;while(item.mark&&(item=item.mark.group)){x+=item.x||0;y+=item.y||0}return{x:x,y:y,width:width,height:height,left:x,top:y,right:x+width,bottom:y+height}}};function Renderer(loader){this._el=null;this._bgcolor=null;this._loader=new ResourceLoader(loader)}Renderer.prototype={initialize:function initialize(el,width,height,origin,scaleFactor){this._el=el;return this.resize(width,height,origin,scaleFactor)},element:function element(){return this._el},canvas:function canvas(){return this._el&&this._el.firstChild},background:function background(bgcolor){if(arguments.length===0)return this._bgcolor;this._bgcolor=bgcolor;return this},resize:function resize(width,height,origin,scaleFactor){this._width=width;this._height=height;this._origin=origin||[0,0];this._scale=scaleFactor||1;return this},dirty:function dirty(){},render:function render(scene){var r=this;r._call=function(){r._render(scene)};r._call();r._call=null;return r},_render:function _render(){},renderAsync:function renderAsync(scene){var r=this.render(scene);return this._ready?this._ready.then((function(){return r})):Promise.resolve(r)},_load:function _load(method,uri){var r=this,p=r._loader[method](uri);if(!r._ready){var call=r._call;r._ready=r._loader.ready().then((function(redraw){if(redraw)call();r._ready=null}))}return p},sanitizeURL:function sanitizeURL(uri){return this._load("sanitizeURL",uri)},loadImage:function loadImage(uri){return this._load("loadImage",uri)}};var KeyDownEvent="keydown";var KeyPressEvent="keypress";var KeyUpEvent="keyup";var DragEnterEvent="dragenter";var DragLeaveEvent="dragleave";var DragOverEvent="dragover";var MouseDownEvent="mousedown";var MouseUpEvent="mouseup";var MouseMoveEvent="mousemove";var MouseOutEvent="mouseout";var MouseOverEvent="mouseover";var ClickEvent="click";var DoubleClickEvent="dblclick";var WheelEvent="wheel";var MouseWheelEvent="mousewheel";var TouchStartEvent="touchstart";var TouchMoveEvent="touchmove";var TouchEndEvent="touchend";var Events=[KeyDownEvent,KeyPressEvent,KeyUpEvent,DragEnterEvent,DragLeaveEvent,DragOverEvent,MouseDownEvent,MouseUpEvent,MouseMoveEvent,MouseOutEvent,MouseOverEvent,ClickEvent,DoubleClickEvent,WheelEvent,MouseWheelEvent,TouchStartEvent,TouchMoveEvent,TouchEndEvent];var TooltipShowEvent=MouseMoveEvent;var TooltipHideEvent=MouseOutEvent;var HrefEvent=ClickEvent;function CanvasHandler(loader,tooltip){Handler.call(this,loader,tooltip);this._down=null;this._touch=null;this._first=true;this._events={}}var eventBundle=function eventBundle(type){return type===TouchStartEvent||type===TouchMoveEvent||type===TouchEndEvent?[TouchStartEvent,TouchMoveEvent,TouchEndEvent]:[type]};function eventListenerCheck(handler,type){eventBundle(type).forEach((function(_){return addEventListener(handler,_)}))}function addEventListener(handler,type){var canvas=handler.canvas();if(canvas&&!handler._events[type]){handler._events[type]=1;canvas.addEventListener(type,handler[type]?function(evt){return handler[type](evt)}:function(evt){return handler.fire(type,evt)})}}function move(moveEvent,overEvent,outEvent){return function(evt){var a=this._active,p=this.pickEvent(evt);if(p===a){this.fire(moveEvent,evt)}else{if(!a||!a.exit){this.fire(outEvent,evt)}this._active=p;this.fire(overEvent,evt);this.fire(moveEvent,evt)}}}function inactive(type){return function(evt){this.fire(type,evt);this._active=null}}inherits(CanvasHandler,Handler,{initialize:function initialize(el,origin,obj){var _this4=this;this._canvas=el&&domFind(el,"canvas");[ClickEvent,MouseDownEvent,MouseMoveEvent,MouseOutEvent,DragLeaveEvent].forEach((function(type){return eventListenerCheck(_this4,type)}));return Handler.prototype.initialize.call(this,el,origin,obj)},canvas:function canvas(){return this._canvas},context:function context(){return this._canvas.getContext("2d")},events:Events,DOMMouseScroll:function DOMMouseScroll(evt){this.fire(MouseWheelEvent,evt)},mousemove:move(MouseMoveEvent,MouseOverEvent,MouseOutEvent),dragover:move(DragOverEvent,DragEnterEvent,DragLeaveEvent),mouseout:inactive(MouseOutEvent),dragleave:inactive(DragLeaveEvent),mousedown:function mousedown(evt){this._down=this._active;this.fire(MouseDownEvent,evt)},click:function click(evt){if(this._down===this._active){this.fire(ClickEvent,evt);this._down=null}},touchstart:function touchstart(evt){this._touch=this.pickEvent(evt.changedTouches[0]);if(this._first){this._active=this._touch;this._first=false}this.fire(TouchStartEvent,evt,true)},touchmove:function touchmove(evt){this.fire(TouchMoveEvent,evt,true)},touchend:function touchend(evt){this.fire(TouchEndEvent,evt,true);this._touch=null},fire:function fire(type,evt,touch){var a=touch?this._touch:this._active,h=this._handlers[type];evt.vegaType=type;if(type===HrefEvent&&a&&a.href){this.handleHref(evt,a,a.href)}else if(type===TooltipShowEvent||type===TooltipHideEvent){this.handleTooltip(evt,a,type!==TooltipHideEvent)}if(h){for(var i=0,len=h.length;i<len;++i){h[i].handler.call(this._obj,evt,a)}}},on:function on(type,handler){var name=this.eventName(type),h=this._handlers,i=this._handlerIndex(h[name],type,handler);if(i<0){eventListenerCheck(this,type);(h[name]||(h[name]=[])).push({type:type,handler:handler})}return this},off:function off(type,handler){var name=this.eventName(type),h=this._handlers[name],i=this._handlerIndex(h,type,handler);if(i>=0){h.splice(i,1)}return this},pickEvent:function pickEvent(evt){var p=point$1(evt,this._canvas),o=this._origin;return this.pick(this._scene,p[0],p[1],p[0]-o[0],p[1]-o[1])},pick:function pick(scene,x,y,gx,gy){var g=this.context(),mark=Marks[scene.marktype];return mark.pick.call(this,g,scene,x,y,gx,gy)}});function devicePixelRatio(){return typeof window!=="undefined"?window.devicePixelRatio||1:1}var pixelRatio=devicePixelRatio();function _resize(canvas,width,height,origin,scaleFactor,opt){var inDOM=typeof HTMLElement!=="undefined"&&canvas instanceof HTMLElement&&canvas.parentNode!=null,context=canvas.getContext("2d"),ratio=inDOM?pixelRatio:scaleFactor;canvas.width=width*ratio;canvas.height=height*ratio;for(var key in opt){context[key]=opt[key]}if(inDOM&&ratio!==1){canvas.style.width=width+"px";canvas.style.height=height+"px"}context.pixelRatio=ratio;context.setTransform(ratio,0,0,ratio,ratio*origin[0],ratio*origin[1]);return canvas}function CanvasRenderer(loader){Renderer.call(this,loader);this._options={};this._redraw=false;this._dirty=new Bounds;this._tempb=new Bounds}var base=Renderer.prototype;var viewBounds=function viewBounds(origin,width,height){return(new Bounds).set(0,0,width,height).translate(-origin[0],-origin[1])};function clipToBounds(g,b,origin){b.expand(1).round();if(g.pixelRatio%1){b.scale(g.pixelRatio).round().scale(1/g.pixelRatio)}b.translate(-(origin[0]%1),-(origin[1]%1));g.beginPath();g.rect(b.x1,b.y1,b.width(),b.height());g.clip();return b}inherits(CanvasRenderer,Renderer,{initialize:function initialize(el,width,height,origin,scaleFactor,options){this._options=options||{};this._canvas=this._options.externalContext?null:domCanvas(1,1,this._options.type);if(el&&this._canvas){domClear(el,0).appendChild(this._canvas);this._canvas.setAttribute("class","marks")}return base.initialize.call(this,el,width,height,origin,scaleFactor)},resize:function resize(width,height,origin,scaleFactor){base.resize.call(this,width,height,origin,scaleFactor);if(this._canvas){_resize(this._canvas,this._width,this._height,this._origin,this._scale,this._options.context)}else{var ctx=this._options.externalContext;if(!ctx)error("CanvasRenderer is missing a valid canvas or context");ctx.scale(this._scale,this._scale);ctx.translate(this._origin[0],this._origin[1])}this._redraw=true;return this},canvas:function canvas(){return this._canvas},context:function context(){return this._options.externalContext||(this._canvas?this._canvas.getContext("2d"):null)},dirty:function dirty(item){var b=this._tempb.clear().union(item.bounds);var g=item.mark.group;while(g){b.translate(g.x||0,g.y||0);g=g.mark.group}this._dirty.union(b)},_render:function _render(scene){var g=this.context(),o=this._origin,w=this._width,h=this._height,db=this._dirty,vb=viewBounds(o,w,h);g.save();var b=this._redraw||db.empty()?(this._redraw=false,vb.expand(1)):clipToBounds(g,vb.intersect(db),o);this.clear(-o[0],-o[1],w,h);this.draw(g,scene,b);g.restore();db.clear();return this},draw:function draw(ctx,scene,bounds){var mark=Marks[scene.marktype];if(scene.clip)clip$1(ctx,scene);mark.draw.call(this,ctx,scene,bounds);if(scene.clip)ctx.restore()},clear:function clear(x,y,w,h){var opt=this._options,g=this.context();if(opt.type!=="pdf"&&!opt.externalContext){g.clearRect(x,y,w,h)}if(this._bgcolor!=null){g.fillStyle=this._bgcolor;g.fillRect(x,y,w,h)}}});function SVGHandler(loader,tooltip){Handler.call(this,loader,tooltip);var h=this;h._hrefHandler=listener(h,(function(evt,item){if(item&&item.href)h.handleHref(evt,item,item.href)}));h._tooltipHandler=listener(h,(function(evt,item){h.handleTooltip(evt,item,evt.type!==TooltipHideEvent)}))}var listener=function listener(context,handler){return function(evt){var item=evt.target.__data__;item=Array.isArray(item)?item[0]:item;evt.vegaType=evt.type;handler.call(context._obj,evt,item)}};inherits(SVGHandler,Handler,{initialize:function initialize(el,origin,obj){var svg=this._svg;if(svg){svg.removeEventListener(HrefEvent,this._hrefHandler);svg.removeEventListener(TooltipShowEvent,this._tooltipHandler);svg.removeEventListener(TooltipHideEvent,this._tooltipHandler)}this._svg=svg=el&&domFind(el,"svg");if(svg){svg.addEventListener(HrefEvent,this._hrefHandler);svg.addEventListener(TooltipShowEvent,this._tooltipHandler);svg.addEventListener(TooltipHideEvent,this._tooltipHandler)}return Handler.prototype.initialize.call(this,el,origin,obj)},canvas:function canvas(){return this._svg},on:function on(type,handler){var name=this.eventName(type),h=this._handlers,i=this._handlerIndex(h[name],type,handler);if(i<0){var _x2={type:type,handler:handler,listener:listener(this,handler)};(h[name]||(h[name]=[])).push(_x2);if(this._svg){this._svg.addEventListener(name,_x2.listener)}}return this},off:function off(type,handler){var name=this.eventName(type),h=this._handlers[name],i=this._handlerIndex(h,type,handler);if(i>=0){if(this._svg){this._svg.removeEventListener(name,h[i].listener)}h.splice(i,1)}return this}});var ARIA_HIDDEN="aria-hidden";var ARIA_LABEL="aria-label";var ARIA_ROLE="role";var ARIA_ROLEDESCRIPTION="aria-roledescription";var GRAPHICS_OBJECT="graphics-object";var GRAPHICS_SYMBOL="graphics-symbol";var bundle=function bundle(role,roledesc,label){var _ref;return _ref={},_defineProperty(_ref,ARIA_ROLE,role),_defineProperty(_ref,ARIA_ROLEDESCRIPTION,roledesc),_defineProperty(_ref,ARIA_LABEL,label||undefined),_ref};var AriaIgnore=toSet(["axis-domain","axis-grid","axis-label","axis-tick","axis-title","legend-band","legend-entry","legend-gradient","legend-label","legend-title","legend-symbol","title"]);var AriaGuides={axis:{desc:"axis",caption:axisCaption},legend:{desc:"legend",caption:legendCaption},"title-text":{desc:"title",caption:function caption(item){return"Title text '".concat(titleCaption(item),"'")}},"title-subtitle":{desc:"subtitle",caption:function caption(item){return"Subtitle text '".concat(titleCaption(item),"'")}}};var AriaEncode={ariaRole:ARIA_ROLE,ariaRoleDescription:ARIA_ROLEDESCRIPTION,description:ARIA_LABEL};function ariaItemAttributes(emit,item){var hide=item.aria===false;emit(ARIA_HIDDEN,hide||undefined);if(hide||item.description==null){for(var prop in AriaEncode){emit(AriaEncode[prop],undefined)}}else{var _type=item.mark.marktype;emit(ARIA_LABEL,item.description);emit(ARIA_ROLE,item.ariaRole||(_type==="group"?GRAPHICS_OBJECT:GRAPHICS_SYMBOL));emit(ARIA_ROLEDESCRIPTION,item.ariaRoleDescription||"".concat(_type," mark"))}}function ariaMarkAttributes(mark){return mark.aria===false?_defineProperty({},ARIA_HIDDEN,true):AriaIgnore[mark.role]?null:AriaGuides[mark.role]?ariaGuide(mark,AriaGuides[mark.role]):ariaMark(mark)}function ariaMark(mark){var type=mark.marktype;var recurse=type==="group"||type==="text"||mark.items.some((function(_){return _.description!=null&&_.aria!==false}));return bundle(recurse?GRAPHICS_OBJECT:GRAPHICS_SYMBOL,"".concat(type," mark container"),mark.description)}function ariaGuide(mark,opt){try{var item=mark.items[0],caption=opt.caption||function(){return""};return bundle(opt.role||GRAPHICS_SYMBOL,opt.desc,item.description||caption(item))}catch(err){return null}}function titleCaption(item){return array(item.text).join(" ")}function axisCaption(item){var datum=item.datum,orient=item.orient,title=datum.title?extractTitle(item):null,ctx=item.context,scale=ctx.scales[datum.scale].value,locale=ctx.dataflow.locale(),type=scale.type,xy=orient==="left"||orient==="right"?"Y":"X";return"".concat(xy,"-axis")+(title?" titled '".concat(title,"'"):"")+" for a ".concat(isDiscrete(type)?"discrete":type," scale")+" with ".concat(domainCaption(locale,scale,item))}function legendCaption(item){var datum=item.datum,title=datum.title?extractTitle(item):null,type="".concat(datum.type||""," legend").trim(),scales=datum.scales,props=Object.keys(scales),ctx=item.context,scale=ctx.scales[scales[props[0]]].value,locale=ctx.dataflow.locale();return capitalize(type)+(title?" titled '".concat(title,"'"):"")+" for ".concat(channelCaption(props))+" with ".concat(domainCaption(locale,scale,item))}function extractTitle(item){try{return array(peek(item.items).items[0].text).join(" ")}catch(err){return null}}function channelCaption(props){props=props.map((function(p){return p+(p==="fill"||p==="stroke"?" color":"")}));return props.length<2?props[0]:props.slice(0,-1).join(", ")+" and "+peek(props)}function capitalize(s){return s.length?s[0].toUpperCase()+s.slice(1):s}var innerText=function innerText(val){return(val+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};var attrText=function attrText(val){return innerText(val).replace(/"/g,"&quot;").replace(/\t/g,"&#x9;").replace(/\n/g,"&#xA;").replace(/\r/g,"&#xD;")};function markup(){var buf="",outer="",inner="";var stack=[],clear=function clear(){return outer=inner=""},push=function push(tag){if(outer){buf+="".concat(outer,">").concat(inner);clear()}stack.push(tag)},attr=function attr(name,value){if(value!=null)outer+=" ".concat(name,'="').concat(attrText(value),'"');return m},m={open:function open(tag){push(tag);outer="<"+tag;for(var _len=arguments.length,attrs=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){attrs[_key-1]=arguments[_key]}for(var _i=0,_attrs=attrs;_i<_attrs.length;_i++){var set=_attrs[_i];for(var key in set){attr(key,set[key])}}return m},close:function close(){var tag=stack.pop();if(outer){buf+=outer+(inner?">".concat(inner,"</").concat(tag,">"):"/>")}else{buf+="</".concat(tag,">")}clear();return m},attr:attr,text:function text(t){return inner+=innerText(t),m},toString:function toString(){return buf}};return m}var serializeXML=function serializeXML(node){return _serialize(markup(),node)+""};function _serialize(m,node){m.open(node.tagName);if(node.hasAttributes()){var attrs=node.attributes,n=attrs.length;for(var i=0;i<n;++i){m.attr(attrs[i].name,attrs[i].value)}}if(node.hasChildNodes()){var children=node.childNodes,_n=children.length;for(var _i2=0;_i2<_n;_i2++){var child=children[_i2];child.nodeType===3?m.text(child.nodeValue):_serialize(m,child)}}return m.close()}var styles={fill:"fill",fillOpacity:"fill-opacity",stroke:"stroke",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",strokeCap:"stroke-linecap",strokeJoin:"stroke-linejoin",strokeDash:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeMiterLimit:"stroke-miterlimit",opacity:"opacity",blend:"mix-blend-mode"};var rootAttributes={fill:"none","stroke-miterlimit":10};var RootIndex=0,ns=metadata.xmlns;function SVGRenderer(loader){Renderer.call(this,loader);this._dirtyID=0;this._dirty=[];this._svg=null;this._root=null;this._defs=null}var base$1=Renderer.prototype;inherits(SVGRenderer,Renderer,{initialize:function initialize(el,width,height,origin,scaleFactor){this._defs={};this._clearDefs();if(el){this._svg=domChild(el,0,"svg",ns);setAttributes(this._svg,metadata);this._svg.setAttribute("class","marks");domClear(el,1);this._root=domChild(this._svg,RootIndex,"g",ns);setAttributes(this._root,rootAttributes);domClear(this._svg,RootIndex+1)}this.background(this._bgcolor);return base$1.initialize.call(this,el,width,height,origin,scaleFactor)},background:function background(bgcolor){if(arguments.length&&this._svg){this._svg.style.setProperty("background-color",bgcolor)}return base$1.background.apply(this,arguments)},resize:function resize(width,height,origin,scaleFactor){base$1.resize.call(this,width,height,origin,scaleFactor);if(this._svg){setAttributes(this._svg,{width:this._width*this._scale,height:this._height*this._scale,viewBox:"0 0 ".concat(this._width," ").concat(this._height)});this._root.setAttribute("transform","translate(".concat(this._origin,")"))}this._dirty=[];return this},canvas:function canvas(){return this._svg},svg:function svg(){var svg=this._svg,bg=this._bgcolor;if(!svg)return null;var node;if(bg){svg.removeAttribute("style");node=domChild(svg,RootIndex,"rect",ns);setAttributes(node,{width:this._width,height:this._height,fill:bg})}var text=serializeXML(svg);if(bg){svg.removeChild(node);this._svg.style.setProperty("background-color",bg)}return text},_render:function _render(scene){if(this._dirtyCheck()){if(this._dirtyAll)this._clearDefs();this.mark(this._root,scene);domClear(this._root,1)}this.defs();this._dirty=[];++this._dirtyID;return this},dirty:function dirty(item){if(item.dirty!==this._dirtyID){item.dirty=this._dirtyID;this._dirty.push(item)}},isDirty:function isDirty(item){return this._dirtyAll||!item._svg||item.dirty===this._dirtyID},_dirtyCheck:function _dirtyCheck(){this._dirtyAll=true;var items=this._dirty;if(!items.length||!this._dirtyID)return true;var id=++this._dirtyID;var item,mark,type,mdef,i,n,o;for(i=0,n=items.length;i<n;++i){item=items[i];mark=item.mark;if(mark.marktype!==type){type=mark.marktype;mdef=Marks[type]}if(mark.zdirty&&mark.dirty!==id){this._dirtyAll=false;dirtyParents(item,id);mark.items.forEach((function(i){i.dirty=id}))}if(mark.zdirty)continue;if(item.exit){if(mdef.nested&&mark.items.length){o=mark.items[0];if(o._svg)this._update(mdef,o._svg,o)}else if(item._svg){o=item._svg.parentNode;if(o)o.removeChild(item._svg)}item._svg=null;continue}item=mdef.nested?mark.items[0]:item;if(item._update===id)continue;if(!item._svg||!item._svg.ownerSVGElement){this._dirtyAll=false;dirtyParents(item,id)}else{this._update(mdef,item._svg,item)}item._update=id}return!this._dirtyAll},mark:function mark(el,scene,prev){var _this5=this;if(!this.isDirty(scene))return scene._svg;var svg=this._svg,mdef=Marks[scene.marktype],events=scene.interactive===false?"none":null,isGroup=mdef.tag==="g";var sibling=null,i=0;var parent=bind(scene,el,prev,"g",svg);parent.setAttribute("class",cssClass(scene));var aria=ariaMarkAttributes(scene);for(var key in aria){setAttribute(parent,key,aria[key])}if(!isGroup){setAttribute(parent,"pointer-events",events)}setAttribute(parent,"clip-path",scene.clip?clip(this,scene,scene.group):null);var process=function process(item){var dirty=_this5.isDirty(item),node=bind(item,parent,sibling,mdef.tag,svg);if(dirty){_this5._update(mdef,node,item);if(isGroup)recurse(_this5,node,item)}sibling=node;++i};if(mdef.nested){if(scene.items.length)process(scene.items[0])}else{visit(scene,process)}domClear(parent,i);return parent},_update:function _update(mdef,el,item){element=el;values=el.__values__;ariaItemAttributes(emit,item);mdef.attr(emit,item,this);var extra=mark_extras[mdef.type];if(extra)extra.call(this,mdef,el,item);if(element)this.style(element,item)},style:function style(el,item){if(item==null)return;for(var prop in styles){var _value2=prop==="font"?fontFamily(item):item[prop];if(_value2===values[prop])continue;var name=styles[prop];if(_value2==null){el.removeAttribute(name)}else{if(isGradient(_value2)){_value2=gradientRef(_value2,this._defs.gradient,href())}el.setAttribute(name,_value2+"")}values[prop]=_value2}},defs:function defs(){var svg=this._svg,defs=this._defs;var el=defs.el,index=0;for(var id in defs.gradient){if(!el)defs.el=el=domChild(svg,RootIndex+1,"defs",ns);index=updateGradient(el,defs.gradient[id],index)}for(var _id in defs.clipping){if(!el)defs.el=el=domChild(svg,RootIndex+1,"defs",ns);index=updateClipping(el,defs.clipping[_id],index)}if(el){index===0?(svg.removeChild(el),defs.el=null):domClear(el,index)}},_clearDefs:function _clearDefs(){var def=this._defs;def.gradient={};def.clipping={}}});function dirtyParents(item,id){for(;item&&item.dirty!==id;item=item.mark.group){item.dirty=id;if(item.mark&&item.mark.dirty!==id){item.mark.dirty=id}else return}}function updateGradient(el,grad,index){var i,n,stop;if(grad.gradient==="radial"){var pt=domChild(el,index++,"pattern",ns);setAttributes(pt,{id:patternPrefix+grad.id,viewBox:"0,0,1,1",width:"100%",height:"100%",preserveAspectRatio:"xMidYMid slice"});pt=domChild(pt,0,"rect",ns);setAttributes(pt,{width:1,height:1,fill:"url(".concat(href(),"#").concat(grad.id,")")});el=domChild(el,index++,"radialGradient",ns);setAttributes(el,{id:grad.id,fx:grad.x1,fy:grad.y1,fr:grad.r1,cx:grad.x2,cy:grad.y2,r:grad.r2})}else{el=domChild(el,index++,"linearGradient",ns);setAttributes(el,{id:grad.id,x1:grad.x1,x2:grad.x2,y1:grad.y1,y2:grad.y2})}for(i=0,n=grad.stops.length;i<n;++i){stop=domChild(el,i,"stop",ns);stop.setAttribute("offset",grad.stops[i].offset);stop.setAttribute("stop-color",grad.stops[i].color)}domClear(el,i);return index}function updateClipping(el,clip,index){var mask;el=domChild(el,index,"clipPath",ns);el.setAttribute("id",clip.id);if(clip.path){mask=domChild(el,0,"path",ns);mask.setAttribute("d",clip.path)}else{mask=domChild(el,0,"rect",ns);setAttributes(mask,{x:0,y:0,width:clip.width,height:clip.height})}domClear(el,1);return index+1}function recurse(renderer,el,group){el=el.lastChild.previousSibling;var prev,idx=0;visit(group,(function(item){prev=renderer.mark(el,item,prev);++idx}));domClear(el,1+idx)}function bind(item,el,sibling,tag,svg){var node=item._svg,doc;if(!node){doc=el.ownerDocument;node=domCreate(doc,tag,ns);item._svg=node;if(item.mark){node.__data__=item;node.__values__={fill:"default"};if(tag==="g"){var bg=domCreate(doc,"path",ns);node.appendChild(bg);bg.__data__=item;var cg=domCreate(doc,"g",ns);node.appendChild(cg);cg.__data__=item;var fg=domCreate(doc,"path",ns);node.appendChild(fg);fg.__data__=item;fg.__values__={fill:"default"}}}}if(node.ownerSVGElement!==svg||siblingCheck(node,sibling)){el.insertBefore(node,sibling?sibling.nextSibling:el.firstChild)}return node}function siblingCheck(node,sibling){return node.parentNode&&node.parentNode.childNodes.length>1&&node.previousSibling!=sibling}var element=null,values=null;var mark_extras={group:function group(mdef,el,item){var fg=element=el.childNodes[2];values=fg.__values__;mdef.foreground(emit,item,this);values=el.__values__;element=el.childNodes[1];mdef.content(emit,item,this);var bg=element=el.childNodes[0];mdef.background(emit,item,this);var value=item.mark.interactive===false?"none":null;if(value!==values.events){setAttribute(fg,"pointer-events",value);setAttribute(bg,"pointer-events",value);values.events=value}if(item.strokeForeground&&item.stroke){var _fill=item.fill;setAttribute(fg,"display",null);this.style(bg,item);setAttribute(bg,"stroke",null);if(_fill)item.fill=null;values=fg.__values__;this.style(fg,item);if(_fill)item.fill=_fill;element=null}else{setAttribute(fg,"display","none")}},image:function image(mdef,el,item){if(item.smooth===false){setStyle(el,"image-rendering","optimizeSpeed");setStyle(el,"image-rendering","pixelated")}else{setStyle(el,"image-rendering",null)}},text:function text(mdef,el,item){var tl=textLines(item);var key,value,doc,lh;if(isArray(tl)){value=tl.map((function(_){return textValue(item,_)}));key=value.join("\n");if(key!==values.text){domClear(el,0);doc=el.ownerDocument;lh=lineHeight(item);value.forEach((function(t,i){var ts=domCreate(doc,"tspan",ns);ts.__data__=item;ts.textContent=t;if(i){ts.setAttribute("x",0);ts.setAttribute("dy",lh)}el.appendChild(ts)}));values.text=key}}else{value=textValue(item,tl);if(value!==values.text){el.textContent=value;values.text=value}}setAttribute(el,"font-family",fontFamily(item));setAttribute(el,"font-size",fontSize(item)+"px");setAttribute(el,"font-style",item.fontStyle);setAttribute(el,"font-variant",item.fontVariant);setAttribute(el,"font-weight",item.fontWeight)}};function emit(name,value,ns){if(value===values[name])return;if(ns){setAttributeNS(element,name,value,ns)}else{setAttribute(element,name,value)}values[name]=value}function setStyle(el,name,value){if(value!==values[name]){if(value==null){el.style.removeProperty(name)}else{el.style.setProperty(name,value+"")}values[name]=value}}function setAttributes(el,attrs){for(var key in attrs){setAttribute(el,key,attrs[key])}}function setAttribute(el,name,value){if(value!=null){el.setAttribute(name,value)}else{el.removeAttribute(name)}}function setAttributeNS(el,name,value,ns){if(value!=null){el.setAttributeNS(ns,name,value)}else{el.removeAttributeNS(ns,name)}}function href(){var loc;return typeof window==="undefined"?"":(loc=window.location).hash?loc.href.slice(0,-loc.hash.length):loc.href}function SVGStringRenderer(loader){Renderer.call(this,loader);this._text=null;this._defs={gradient:{},clipping:{}}}inherits(SVGStringRenderer,Renderer,{svg:function svg(){return this._text},_render:function _render(scene){var m=markup();m.open("svg",extend({},metadata,{class:"marks",width:this._width*this._scale,height:this._height*this._scale,viewBox:"0 0 ".concat(this._width," ").concat(this._height)}));var bg=this._bgcolor;if(bg&&bg!=="transparent"&&bg!=="none"){m.open("rect",{width:this._width,height:this._height,fill:bg}).close()}m.open("g",rootAttributes,{transform:"translate("+this._origin+")"});this.mark(m,scene);m.close();this.defs(m);this._text=m.close()+"";return this},mark:function mark(m,scene){var _this6=this;var mdef=Marks[scene.marktype],tag=mdef.tag,attrList=[ariaItemAttributes,mdef.attr];m.open("g",{class:cssClass(scene),"clip-path":scene.clip?clip(this,scene,scene.group):null},ariaMarkAttributes(scene),{"pointer-events":tag!=="g"&&scene.interactive===false?"none":null});var process=function process(item){var href=_this6.href(item);if(href)m.open("a",href);m.open(tag,_this6.attr(scene,item,attrList,tag!=="g"?tag:null));if(tag==="text"){var _tl=textLines(item);if(isArray(_tl)){var attrs={x:0,dy:lineHeight(item)};for(var i=0;i<_tl.length;++i){m.open("tspan",i?attrs:null).text(textValue(item,_tl[i])).close()}}else{m.text(textValue(item,_tl))}}else if(tag==="g"){var fore=item.strokeForeground,_fill2=item.fill,_stroke=item.stroke;if(fore&&_stroke){item.stroke=null}m.open("path",_this6.attr(scene,item,mdef.background,"bgrect")).close();m.open("g",_this6.attr(scene,item,mdef.content));visit(item,(function(scene){return _this6.mark(m,scene)}));m.close();if(fore&&_stroke){if(_fill2)item.fill=null;item.stroke=_stroke;m.open("path",_this6.attr(scene,item,mdef.foreground,"bgrect")).close();if(_fill2)item.fill=_fill2}else{m.open("path",_this6.attr(scene,item,mdef.foreground,"bgfore")).close()}}m.close();if(href)m.close()};if(mdef.nested){if(scene.items&&scene.items.length)process(scene.items[0])}else{visit(scene,process)}return m.close()},href:function href(item){var _this7=this;var href=item.href;var attr;if(href){if(attr=this._hrefs&&this._hrefs[href]){return attr}else{this.sanitizeURL(href).then((function(attr){attr["xlink:href"]=attr.href;attr.href=null;(_this7._hrefs||(_this7._hrefs={}))[href]=attr}))}}return null},attr:function attr(scene,item,attrs,tag){var _this8=this;var object={},emit=function emit(name,value,ns,prefixed){object[prefixed||name]=value};if(Array.isArray(attrs)){attrs.forEach((function(fn){return fn(emit,item,_this8)}))}else{attrs(emit,item,this)}if(tag){style(object,item,scene,tag,this._defs)}return object},defs:function defs(m){var gradient=this._defs.gradient,clipping=this._defs.clipping,count=Object.keys(gradient).length+Object.keys(clipping).length;if(count===0)return;m.open("defs");for(var id in gradient){var _def=gradient[id],stops=_def.stops;if(_def.gradient==="radial"){m.open("pattern",{id:patternPrefix+id,viewBox:"0,0,1,1",width:"100%",height:"100%",preserveAspectRatio:"xMidYMid slice"});m.open("rect",{width:"1",height:"1",fill:"url(#"+id+")"}).close();m.close();m.open("radialGradient",{id:id,fx:_def.x1,fy:_def.y1,fr:_def.r1,cx:_def.x2,cy:_def.y2,r:_def.r2})}else{m.open("linearGradient",{id:id,x1:_def.x1,x2:_def.x2,y1:_def.y1,y2:_def.y2})}for(var i=0;i<stops.length;++i){m.open("stop",{offset:stops[i].offset,"stop-color":stops[i].color}).close()}m.close()}for(var _id2 in clipping){var _def2=clipping[_id2];m.open("clipPath",{id:_id2});if(_def2.path){m.open("path",{d:_def2.path}).close()}else{m.open("rect",{x:0,y:0,width:_def2.width,height:_def2.height}).close()}m.close()}m.close()}});function style(s,item,scene,tag,defs){if(item==null)return s;if(tag==="bgrect"&&scene.interactive===false){s["pointer-events"]="none"}if(tag==="bgfore"){if(scene.interactive===false){s["pointer-events"]="none"}s.display="none";if(item.fill!==null)return s}if(tag==="image"&&item.smooth===false){s.style="image-rendering: optimizeSpeed; image-rendering: pixelated;"}if(tag==="text"){s["font-family"]=fontFamily(item);s["font-size"]=fontSize(item)+"px";s["font-style"]=item.fontStyle;s["font-variant"]=item.fontVariant;s["font-weight"]=item.fontWeight}for(var prop in styles){var _value3=item[prop];var name=styles[prop];if(_value3==="transparent"&&(name==="fill"||name==="stroke"));else if(_value3!=null){if(isGradient(_value3)){_value3=gradientRef(_value3,defs.gradient,"")}s[name]=_value3}}return s}var Canvas="canvas";var PNG="png";var SVG="svg";var None$1="none";var RenderType={Canvas:Canvas,PNG:PNG,SVG:SVG,None:None$1};var modules={};modules[Canvas]=modules[PNG]={renderer:CanvasRenderer,headless:CanvasRenderer,handler:CanvasHandler};modules[SVG]={renderer:SVGRenderer,headless:SVGStringRenderer,handler:SVGHandler};modules[None$1]={};function renderModule(name,_){name=String(name||"").toLowerCase();if(arguments.length>1){modules[name]=_;return this}else{return modules[name]}}function intersect$1(scene,bounds,filter){var hits=[],box=(new Bounds).union(bounds),type=scene.marktype;return type?intersectMark(scene,box,filter,hits):type==="group"?intersectGroup(scene,box,filter,hits):error("Intersect scene must be mark node or group item.")}function intersectMark(mark,box,filter,hits){if(visitMark(mark,box,filter)){var items=mark.items,_type2=mark.marktype,n=items.length;var i=0;if(_type2==="group"){for(;i<n;++i){intersectGroup(items[i],box,filter,hits)}}else{for(var test=Marks[_type2].isect;i<n;++i){var item=items[i];if(intersectItem(item,box,test))hits.push(item)}}}return hits}function visitMark(mark,box,filter){return mark.bounds&&box.intersects(mark.bounds)&&(mark.marktype==="group"||mark.interactive!==false&&(!filter||filter(mark)))}function intersectGroup(group,box,filter,hits){if(filter&&filter(group.mark)&&intersectItem(group,box,Marks.group.isect)){hits.push(group)}var marks=group.items,n=marks&&marks.length;if(n){var _x3=group.x||0,_y2=group.y||0;box.translate(-_x3,-_y2);for(var i=0;i<n;++i){intersectMark(marks[i],box,filter,hits)}box.translate(_x3,_y2)}return hits}function intersectItem(item,box,test){var bounds=item.bounds;return box.encloses(bounds)||box.intersects(bounds)&&test(item,box)}var clipBounds=new Bounds;function boundClip(mark){var clip=mark.clip;if(isFunction(clip)){clip(boundContext(clipBounds.clear()))}else if(clip){clipBounds.set(0,0,mark.group.width,mark.group.height)}else return;mark.bounds.intersect(clipBounds)}var TOLERANCE=1e-9;function sceneEqual(a,b,key){return a===b?true:key==="path"?pathEqual(a,b):a instanceof Date&&b instanceof Date?+a===+b:isNumber(a)&&isNumber(b)?Math.abs(a-b)<=TOLERANCE:!a||!b||!isObject(a)&&!isObject(b)?a==b:objectEqual(a,b)}function pathEqual(a,b){return sceneEqual(pathParse(a),pathParse(b))}function objectEqual(a,b){var ka=Object.keys(a),kb=Object.keys(b),key,i;if(ka.length!==kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!sceneEqual(a[key],b[key],key))return false}return _typeof(a)===_typeof(b)}function resetSVGDefIds(){resetSVGClipId();resetSVGGradientId()}var Top="top";var Left="left";var Right="right";var Bottom="bottom";var TopLeft="top-left";var TopRight="top-right";var BottomLeft="bottom-left";var BottomRight="bottom-right";var Start="start";var Middle="middle";var End="end";var X="x";var Y="y";var Group="group";var AxisRole="axis";var TitleRole="title";var FrameRole="frame";var ScopeRole="scope";var LegendRole="legend";var RowHeader="row-header";var RowFooter="row-footer";var RowTitle="row-title";var ColHeader="column-header";var ColFooter="column-footer";var ColTitle="column-title";var Padding="padding";var Symbols="symbol";var Fit="fit";var FitX="fit-x";var FitY="fit-y";var Pad="pad";var None$2="none";var All="all";var Each="each";var Flush="flush";var Column="column";var Row="row";function Bound(params){Transform.call(this,null,params)}inherits(Bound,Transform,{transform:function transform(_,pulse){var view=pulse.dataflow,mark=_.mark,type=mark.marktype,entry=Marks[type],bound=entry.bound;var markBounds=mark.bounds,rebound;if(entry.nested){if(mark.items.length)view.dirty(mark.items[0]);markBounds=boundItem$1(mark,bound);mark.items.forEach((function(item){item.bounds.clear().union(markBounds)}))}else if(type===Group||_.modified()){pulse.visit(pulse.MOD,(function(item){return view.dirty(item)}));markBounds.clear();mark.items.forEach((function(item){return markBounds.union(boundItem$1(item,bound))}));switch(mark.role){case AxisRole:case LegendRole:case TitleRole:pulse.reflow()}}else{rebound=pulse.changed(pulse.REM);pulse.visit(pulse.ADD,(function(item){markBounds.union(boundItem$1(item,bound))}));pulse.visit(pulse.MOD,(function(item){rebound=rebound||markBounds.alignsWith(item.bounds);view.dirty(item);markBounds.union(boundItem$1(item,bound))}));if(rebound){markBounds.clear();mark.items.forEach((function(item){return markBounds.union(item.bounds)}))}}boundClip(mark);return pulse.modifies("bounds")}});function boundItem$1(item,bound,opt){return bound(item.bounds.clear(),item,opt)}var COUNTER_NAME=":vega_identifier:";function Identifier(params){Transform.call(this,0,params)}Identifier.Definition={type:"Identifier",metadata:{modifies:true},params:[{name:"as",type:"string",required:true}]};inherits(Identifier,Transform,{transform:function transform(_,pulse){var counter=getCounter(pulse.dataflow),as=_.as;var id=counter.value;pulse.visit(pulse.ADD,(function(t){return t[as]=t[as]||++id}));counter.set(this.value=id);return pulse}});function getCounter(view){return view._signals[COUNTER_NAME]||(view._signals[COUNTER_NAME]=view.add(0))}function Mark(params){Transform.call(this,null,params)}inherits(Mark,Transform,{transform:function transform(_,pulse){var mark=this.value;if(!mark){mark=pulse.dataflow.scenegraph().mark(_.markdef,lookup$1(_),_.index);mark.group.context=_.context;if(!_.context.group)_.context.group=mark.group;mark.source=this.source;mark.clip=_.clip;mark.interactive=_.interactive;this.value=mark}var Init=mark.marktype===Group?GroupItem:Item;pulse.visit(pulse.ADD,(function(item){return Init.call(item,mark)}));if(_.modified("clip")||_.modified("interactive")){mark.clip=_.clip;mark.interactive=!!_.interactive;mark.zdirty=true;pulse.reflow()}mark.items=pulse.source;return pulse}});function lookup$1(_){var g=_.groups,p=_.parent;return g&&g.size===1?g.get(Object.keys(g.object)[0]):g&&p?g.lookup(p):null}function Overlap(params){Transform.call(this,null,params)}var methods={parity:function parity(items){return items.filter((function(item,i){return i%2?item.opacity=0:1}))},greedy:function greedy(items,sep){var a;return items.filter((function(b,i){return!i||!intersect$2(a.bounds,b.bounds,sep)?(a=b,1):b.opacity=0}))}};var intersect$2=function intersect(a,b,sep){return sep>Math.max(b.x1-a.x2,a.x1-b.x2,b.y1-a.y2,a.y1-b.y2)};var hasOverlap=function hasOverlap(items,pad){for(var i=1,n=items.length,a=items[0].bounds,b;i<n;a=b,++i){if(intersect$2(a,b=items[i].bounds,pad))return true}};var hasBounds=function hasBounds(item){var b=item.bounds;return b.width()>1&&b.height()>1};var boundTest=function boundTest(scale,orient,tolerance){var range=scale.range(),b=new Bounds;if(orient===Top||orient===Bottom){b.set(range[0],-Infinity,range[1],+Infinity)}else{b.set(-Infinity,range[0],+Infinity,range[1])}b.expand(tolerance||1);return function(item){return b.encloses(item.bounds)}};var reset=function reset(source){source.forEach((function(item){return item.opacity=1}));return source};var reflow=function reflow(pulse,_){return pulse.reflow(_.modified()).modifies("opacity")};inherits(Overlap,Transform,{transform:function transform(_,pulse){var reduce=methods[_.method]||methods.parity,sep=_.separation||0;var source=pulse.materialize(pulse.SOURCE).source,items,test;if(!source||!source.length)return;if(!_.method){if(_.modified("method")){reset(source);pulse=reflow(pulse,_)}return pulse}source=source.filter(hasBounds);if(!source.length)return;if(_.sort){source=source.slice().sort(_.sort)}items=reset(source);pulse=reflow(pulse,_);if(items.length>=3&&hasOverlap(items,sep)){do{items=reduce(items,sep)}while(items.length>=3&&hasOverlap(items,sep));if(items.length<3&&!peek(source).opacity){if(items.length>1)peek(items).opacity=0;peek(source).opacity=1}}if(_.boundScale&&_.boundTolerance>=0){test=boundTest(_.boundScale,_.boundOrient,+_.boundTolerance);source.forEach((function(item){if(!test(item))item.opacity=0}))}var bounds=items[0].mark.bounds.clear();source.forEach((function(item){if(item.opacity)bounds.union(item.bounds)}));return pulse}});function Render(params){Transform.call(this,null,params)}inherits(Render,Transform,{transform:function transform(_,pulse){var view=pulse.dataflow;pulse.visit(pulse.ALL,(function(item){return view.dirty(item)}));if(pulse.fields&&pulse.fields["zindex"]){var item=pulse.source&&pulse.source[0];if(item)item.mark.zdirty=true}}});var tempBounds$1=new Bounds;function set$1(item,property,value){return item[property]===value?0:(item[property]=value,1)}function isYAxis(mark){var orient=mark.items[0].orient;return orient===Left||orient===Right}function axisIndices(datum){var index=+datum.grid;return[datum.ticks?index++:-1,datum.labels?index++:-1,index+ +datum.domain]}function axisLayout(view,axis,width,height){var item=axis.items[0],datum=item.datum,delta=item.translate!=null?item.translate:.5,orient=item.orient,indices=axisIndices(datum),range=item.range,offset=item.offset,position=item.position,minExtent=item.minExtent,maxExtent=item.maxExtent,title=datum.title&&item.items[indices[2]].items[0],titlePadding=item.titlePadding,bounds=item.bounds,dl=title&&multiLineOffset(title),x=0,y=0,i,s;tempBounds$1.clear().union(bounds);bounds.clear();if((i=indices[0])>-1)bounds.union(item.items[i].bounds);if((i=indices[1])>-1)bounds.union(item.items[i].bounds);switch(orient){case Top:x=position||0;y=-offset;s=Math.max(minExtent,Math.min(maxExtent,-bounds.y1));bounds.add(0,-s).add(range,0);if(title)axisTitleLayout(view,title,s,titlePadding,dl,0,-1,bounds);break;case Left:x=-offset;y=position||0;s=Math.max(minExtent,Math.min(maxExtent,-bounds.x1));bounds.add(-s,0).add(0,range);if(title)axisTitleLayout(view,title,s,titlePadding,dl,1,-1,bounds);break;case Right:x=width+offset;y=position||0;s=Math.max(minExtent,Math.min(maxExtent,bounds.x2));bounds.add(0,0).add(s,range);if(title)axisTitleLayout(view,title,s,titlePadding,dl,1,1,bounds);break;case Bottom:x=position||0;y=height+offset;s=Math.max(minExtent,Math.min(maxExtent,bounds.y2));bounds.add(0,0).add(range,s);if(title)axisTitleLayout(view,title,s,titlePadding,0,0,1,bounds);break;default:x=item.x;y=item.y}boundStroke(bounds.translate(x,y),item);if(set$1(item,"x",x+delta)|set$1(item,"y",y+delta)){item.bounds=tempBounds$1;view.dirty(item);item.bounds=bounds;view.dirty(item)}return item.mark.bounds.clear().union(bounds)}function axisTitleLayout(view,title,offset,pad,dl,isYAxis,sign,bounds){var b=title.bounds;if(title.auto){var v=sign*(offset+dl+pad);var dx=0,dy=0;view.dirty(title);isYAxis?dx=(title.x||0)-(title.x=v):dy=(title.y||0)-(title.y=v);title.mark.bounds.clear().union(b.translate(-dx,-dy));view.dirty(title)}bounds.union(b)}var min$2=function min(a,b){return Math.floor(Math.min(a,b))};var max$2=function max(a,b){return Math.ceil(Math.max(a,b))};function gridLayoutGroups(group){var _views$rowheaders,_views$rowfooters,_views$colheaders,_views$colfooters,_views$marks;var groups=group.items,n=groups.length,i=0,mark,items;var views={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};for(;i<n;++i){mark=groups[i];items=mark.items;if(mark.marktype===Group){switch(mark.role){case AxisRole:case LegendRole:case TitleRole:break;case RowHeader:(_views$rowheaders=views.rowheaders).push.apply(_views$rowheaders,_toConsumableArray(items));break;case RowFooter:(_views$rowfooters=views.rowfooters).push.apply(_views$rowfooters,_toConsumableArray(items));break;case ColHeader:(_views$colheaders=views.colheaders).push.apply(_views$colheaders,_toConsumableArray(items));break;case ColFooter:(_views$colfooters=views.colfooters).push.apply(_views$colfooters,_toConsumableArray(items));break;case RowTitle:views.rowtitle=items[0];break;case ColTitle:views.coltitle=items[0];break;default:(_views$marks=views.marks).push.apply(_views$marks,_toConsumableArray(items))}}}return views}function bboxFlush(item){return(new Bounds).set(0,0,item.width||0,item.height||0)}function bboxFull(item){var b=item.bounds.clone();return b.empty()?b.set(0,0,0,0):b.translate(-(item.x||0),-(item.y||0))}function get$3(opt,key,d){var v=isObject(opt)?opt[key]:opt;return v!=null?v:d!==undefined?d:0}function offsetValue(v){return v<0?Math.ceil(-v):0}function gridLayout(view,groups,opt){var dirty=!opt.nodirty,bbox=opt.bounds===Flush?bboxFlush:bboxFull,bounds=tempBounds$1.set(0,0,0,0),alignCol=get$3(opt.align,Column),alignRow=get$3(opt.align,Row),padCol=get$3(opt.padding,Column),padRow=get$3(opt.padding,Row),ncols=opt.columns||groups.length,nrows=ncols<=0?1:Math.ceil(groups.length/ncols),n=groups.length,xOffset=Array(n),xExtent=Array(ncols),xMax=0,yOffset=Array(n),yExtent=Array(nrows),yMax=0,dx=Array(n),dy=Array(n),boxes=Array(n),m,i,c,r,b,g,px,py,x,y,offset;for(i=0;i<ncols;++i){xExtent[i]=0}for(i=0;i<nrows;++i){yExtent[i]=0}for(i=0;i<n;++i){g=groups[i];b=boxes[i]=bbox(g);g.x=g.x||0;dx[i]=0;g.y=g.y||0;dy[i]=0;c=i%ncols;r=~~(i/ncols);xMax=Math.max(xMax,px=Math.ceil(b.x2));yMax=Math.max(yMax,py=Math.ceil(b.y2));xExtent[c]=Math.max(xExtent[c],px);yExtent[r]=Math.max(yExtent[r],py);xOffset[i]=padCol+offsetValue(b.x1);yOffset[i]=padRow+offsetValue(b.y1);if(dirty)view.dirty(groups[i])}for(i=0;i<n;++i){if(i%ncols===0)xOffset[i]=0;if(i<ncols)yOffset[i]=0}if(alignCol===Each){for(c=1;c<ncols;++c){for(offset=0,i=c;i<n;i+=ncols){if(offset<xOffset[i])offset=xOffset[i]}for(i=c;i<n;i+=ncols){xOffset[i]=offset+xExtent[c-1]}}}else if(alignCol===All){for(offset=0,i=0;i<n;++i){if(i%ncols&&offset<xOffset[i])offset=xOffset[i]}for(i=0;i<n;++i){if(i%ncols)xOffset[i]=offset+xMax}}else{for(alignCol=false,c=1;c<ncols;++c){for(i=c;i<n;i+=ncols){xOffset[i]+=xExtent[c-1]}}}if(alignRow===Each){for(r=1;r<nrows;++r){for(offset=0,i=r*ncols,m=i+ncols;i<m;++i){if(offset<yOffset[i])offset=yOffset[i]}for(i=r*ncols;i<m;++i){yOffset[i]=offset+yExtent[r-1]}}}else if(alignRow===All){for(offset=0,i=ncols;i<n;++i){if(offset<yOffset[i])offset=yOffset[i]}for(i=ncols;i<n;++i){yOffset[i]=offset+yMax}}else{for(alignRow=false,r=1;r<nrows;++r){for(i=r*ncols,m=i+ncols;i<m;++i){yOffset[i]+=yExtent[r-1]}}}for(x=0,i=0;i<n;++i){x=xOffset[i]+(i%ncols?x:0);dx[i]+=x-groups[i].x}for(c=0;c<ncols;++c){for(y=0,i=c;i<n;i+=ncols){y+=yOffset[i];dy[i]+=y-groups[i].y}}if(alignCol&&get$3(opt.center,Column)&&nrows>1){for(i=0;i<n;++i){b=alignCol===All?xMax:xExtent[i%ncols];x=b-boxes[i].x2-groups[i].x-dx[i];if(x>0)dx[i]+=x/2}}if(alignRow&&get$3(opt.center,Row)&&ncols!==1){for(i=0;i<n;++i){b=alignRow===All?yMax:yExtent[~~(i/ncols)];y=b-boxes[i].y2-groups[i].y-dy[i];if(y>0)dy[i]+=y/2}}for(i=0;i<n;++i){bounds.union(boxes[i].translate(dx[i],dy[i]))}x=get$3(opt.anchor,X);y=get$3(opt.anchor,Y);switch(get$3(opt.anchor,Column)){case End:x-=bounds.width();break;case Middle:x-=bounds.width()/2}switch(get$3(opt.anchor,Row)){case End:y-=bounds.height();break;case Middle:y-=bounds.height()/2}x=Math.round(x);y=Math.round(y);bounds.clear();for(i=0;i<n;++i){groups[i].mark.bounds.clear()}for(i=0;i<n;++i){g=groups[i];g.x+=dx[i]+=x;g.y+=dy[i]+=y;bounds.union(g.mark.bounds.union(g.bounds.translate(dx[i],dy[i])));if(dirty)view.dirty(g)}return bounds}function trellisLayout(view,group,opt){var views=gridLayoutGroups(group),groups=views.marks,bbox=opt.bounds===Flush?boundFlush:boundFull,off=opt.offset,ncols=opt.columns||groups.length,nrows=ncols<=0?1:Math.ceil(groups.length/ncols),cells=nrows*ncols,x,y,x2,y2,anchor,band,offset;var bounds=gridLayout(view,groups,opt);if(bounds.empty())bounds.set(0,0,0,0);if(views.rowheaders){band=get$3(opt.headerBand,Row,null);x=layoutHeaders(view,views.rowheaders,groups,ncols,nrows,-get$3(off,"rowHeader"),min$2,0,bbox,"x1",0,ncols,1,band)}if(views.colheaders){band=get$3(opt.headerBand,Column,null);y=layoutHeaders(view,views.colheaders,groups,ncols,ncols,-get$3(off,"columnHeader"),min$2,1,bbox,"y1",0,1,ncols,band)}if(views.rowfooters){band=get$3(opt.footerBand,Row,null);x2=layoutHeaders(view,views.rowfooters,groups,ncols,nrows,get$3(off,"rowFooter"),max$2,0,bbox,"x2",ncols-1,ncols,1,band)}if(views.colfooters){band=get$3(opt.footerBand,Column,null);y2=layoutHeaders(view,views.colfooters,groups,ncols,ncols,get$3(off,"columnFooter"),max$2,1,bbox,"y2",cells-ncols,1,ncols,band)}if(views.rowtitle){anchor=get$3(opt.titleAnchor,Row);offset=get$3(off,"rowTitle");offset=anchor===End?x2+offset:x-offset;band=get$3(opt.titleBand,Row,.5);layoutTitle(view,views.rowtitle,offset,0,bounds,band)}if(views.coltitle){anchor=get$3(opt.titleAnchor,Column);offset=get$3(off,"columnTitle");offset=anchor===End?y2+offset:y-offset;band=get$3(opt.titleBand,Column,.5);layoutTitle(view,views.coltitle,offset,1,bounds,band)}}function boundFlush(item,field){return field==="x1"?item.x||0:field==="y1"?item.y||0:field==="x2"?(item.x||0)+(item.width||0):field==="y2"?(item.y||0)+(item.height||0):undefined}function boundFull(item,field){return item.bounds[field]}function layoutHeaders(view,headers,groups,ncols,limit,offset,agg,isX,bound,bf,start,stride,back,band){var n=groups.length,init=0,edge=0,i,j,k,m,b,h,g,x,y;if(!n)return init;for(i=start;i<n;i+=stride){if(groups[i])init=agg(init,bound(groups[i],bf))}if(!headers.length)return init;if(headers.length>limit){view.warn("Grid headers exceed limit: "+limit);headers=headers.slice(0,limit)}init+=offset;for(j=0,m=headers.length;j<m;++j){view.dirty(headers[j]);headers[j].mark.bounds.clear()}for(i=start,j=0,m=headers.length;j<m;++j,i+=stride){h=headers[j];b=h.mark.bounds;for(k=i;k>=0&&(g=groups[k])==null;k-=back){}if(isX){x=band==null?g.x:Math.round(g.bounds.x1+band*g.bounds.width());y=init}else{x=init;y=band==null?g.y:Math.round(g.bounds.y1+band*g.bounds.height())}b.union(h.bounds.translate(x-(h.x||0),y-(h.y||0)));h.x=x;h.y=y;view.dirty(h);edge=agg(edge,b[bf])}return edge}function layoutTitle(view,g,offset,isX,bounds,band){if(!g)return;view.dirty(g);var x=offset,y=offset;isX?x=Math.round(bounds.x1+band*bounds.width()):y=Math.round(bounds.y1+band*bounds.height());g.bounds.translate(x-(g.x||0),y-(g.y||0));g.mark.bounds.clear().union(g.bounds);g.x=x;g.y=y;view.dirty(g)}function lookup$1$1(config,orient){var opt=config[orient]||{};return function(key,d){return opt[key]!=null?opt[key]:config[key]!=null?config[key]:d}}function offsets(legends,value){var max=-Infinity;legends.forEach((function(item){if(item.offset!=null)max=Math.max(max,item.offset)}));return max>-Infinity?max:value}function legendParams(g,orient,config,xb,yb,w,h){var _=lookup$1$1(config,orient),offset=offsets(g,_("offset",0)),anchor=_("anchor",Start),mult=anchor===End?1:anchor===Middle?.5:0;var p={align:Each,bounds:_("bounds",Flush),columns:_("direction")==="vertical"?1:g.length,padding:_("margin",8),center:_("center"),nodirty:true};switch(orient){case Left:p.anchor={x:Math.floor(xb.x1)-offset,column:End,y:mult*(h||xb.height()+2*xb.y1),row:anchor};break;case Right:p.anchor={x:Math.ceil(xb.x2)+offset,y:mult*(h||xb.height()+2*xb.y1),row:anchor};break;case Top:p.anchor={y:Math.floor(yb.y1)-offset,row:End,x:mult*(w||yb.width()+2*yb.x1),column:anchor};break;case Bottom:p.anchor={y:Math.ceil(yb.y2)+offset,x:mult*(w||yb.width()+2*yb.x1),column:anchor};break;case TopLeft:p.anchor={x:offset,y:offset};break;case TopRight:p.anchor={x:w-offset,y:offset,column:End};break;case BottomLeft:p.anchor={x:offset,y:h-offset,row:End};break;case BottomRight:p.anchor={x:w-offset,y:h-offset,column:End,row:End};break}return p}function legendLayout(view,legend){var item=legend.items[0],datum=item.datum,orient=item.orient,bounds=item.bounds,x=item.x,y=item.y,w,h;item._bounds?item._bounds.clear().union(bounds):item._bounds=bounds.clone();bounds.clear();legendGroupLayout(view,item,item.items[0].items[0]);bounds=legendBounds(item,bounds);w=2*item.padding;h=2*item.padding;if(!bounds.empty()){w=Math.ceil(bounds.width()+w);h=Math.ceil(bounds.height()+h)}if(datum.type===Symbols){legendEntryLayout(item.items[0].items[0].items[0].items)}if(orient!==None$2){item.x=x=0;item.y=y=0}item.width=w;item.height=h;boundStroke(bounds.set(x,y,x+w,y+h),item);item.mark.bounds.clear().union(bounds);return item}function legendBounds(item,b){item.items.forEach((function(_){return b.union(_.bounds)}));b.x1=item.padding;b.y1=item.padding;return b}function legendGroupLayout(view,item,entry){var pad=item.padding,ex=pad-entry.x,ey=pad-entry.y;if(!item.datum.title){if(ex||ey)translate$1(view,entry,ex,ey)}else{var title=item.items[1].items[0],anchor=title.anchor,tpad=item.titlePadding||0,tx=pad-title.x,ty=pad-title.y;switch(title.orient){case Left:ex+=Math.ceil(title.bounds.width())+tpad;break;case Right:case Bottom:break;default:ey+=title.bounds.height()+tpad}if(ex||ey)translate$1(view,entry,ex,ey);switch(title.orient){case Left:ty+=legendTitleOffset(item,entry,title,anchor,1,1);break;case Right:tx+=legendTitleOffset(item,entry,title,End,0,0)+tpad;ty+=legendTitleOffset(item,entry,title,anchor,1,1);break;case Bottom:tx+=legendTitleOffset(item,entry,title,anchor,0,0);ty+=legendTitleOffset(item,entry,title,End,-1,0,1)+tpad;break;default:tx+=legendTitleOffset(item,entry,title,anchor,0,0)}if(tx||ty)translate$1(view,title,tx,ty);if((tx=Math.round(title.bounds.x1-pad))<0){translate$1(view,entry,-tx,0);translate$1(view,title,-tx,0)}}}function legendTitleOffset(item,entry,title,anchor,y,lr,noBar){var grad=item.datum.type!=="symbol",vgrad=title.datum.vgrad,e=grad&&(lr||!vgrad)&&!noBar?entry.items[0]:entry,s=e.bounds[y?"y2":"x2"]-item.padding,u=vgrad&&lr?s:0,v=vgrad&&lr?0:s,o=y<=0?0:multiLineOffset(title);return Math.round(anchor===Start?u:anchor===End?v-o:.5*(s-o))}function translate$1(view,item,dx,dy){item.x+=dx;item.y+=dy;item.bounds.translate(dx,dy);item.mark.bounds.translate(dx,dy);view.dirty(item)}function legendEntryLayout(entries){var widths=entries.reduce((function(w,g){w[g.column]=Math.max(g.bounds.x2-g.x,w[g.column]||0);return w}),{});entries.forEach((function(g){g.width=widths[g.column];g.height=g.bounds.y2-g.y}))}function titleLayout(view,mark,width,height,viewBounds){var group=mark.items[0],frame=group.frame,orient=group.orient,anchor=group.anchor,offset=group.offset,padding=group.padding,title=group.items[0].items[0],subtitle=group.items[1]&&group.items[1].items[0],end=orient===Left||orient===Right?height:width,start=0,x=0,y=0,sx=0,sy=0,pos;if(frame!==Group){orient===Left?(start=viewBounds.y2,end=viewBounds.y1):orient===Right?(start=viewBounds.y1,end=viewBounds.y2):(start=viewBounds.x1,end=viewBounds.x2)}else if(orient===Left){start=height,end=0}pos=anchor===Start?start:anchor===End?end:(start+end)/2;if(subtitle&&subtitle.text){switch(orient){case Top:case Bottom:sy=title.bounds.height()+padding;break;case Left:sx=title.bounds.width()+padding;break;case Right:sx=-title.bounds.width()-padding;break}tempBounds$1.clear().union(subtitle.bounds);tempBounds$1.translate(sx-(subtitle.x||0),sy-(subtitle.y||0));if(set$1(subtitle,"x",sx)|set$1(subtitle,"y",sy)){view.dirty(subtitle);subtitle.bounds.clear().union(tempBounds$1);subtitle.mark.bounds.clear().union(tempBounds$1);view.dirty(subtitle)}tempBounds$1.clear().union(subtitle.bounds)}else{tempBounds$1.clear()}tempBounds$1.union(title.bounds);switch(orient){case Top:x=pos;y=viewBounds.y1-tempBounds$1.height()-offset;break;case Left:x=viewBounds.x1-tempBounds$1.width()-offset;y=pos;break;case Right:x=viewBounds.x2+tempBounds$1.width()+offset;y=pos;break;case Bottom:x=pos;y=viewBounds.y2+offset;break;default:x=group.x;y=group.y}if(set$1(group,"x",x)|set$1(group,"y",y)){tempBounds$1.translate(x,y);view.dirty(group);group.bounds.clear().union(tempBounds$1);mark.bounds.clear().union(tempBounds$1);view.dirty(group)}return group.bounds}function ViewLayout(params){Transform.call(this,null,params)}inherits(ViewLayout,Transform,{transform:function transform(_,pulse){var view=pulse.dataflow;_.mark.items.forEach((function(group){if(_.layout)trellisLayout(view,group,_.layout);layoutGroup(view,group,_)}));return shouldReflow(_.mark.group)?pulse.reflow():pulse}});function shouldReflow(group){return group&&group.mark.role!=="legend-entry"}function layoutGroup(view,group,_){var items=group.items,width=Math.max(0,group.width||0),height=Math.max(0,group.height||0),viewBounds=(new Bounds).set(0,0,width,height),xBounds=viewBounds.clone(),yBounds=viewBounds.clone(),legends=[],title,mark,orient,b,i,n;for(i=0,n=items.length;i<n;++i){mark=items[i];switch(mark.role){case AxisRole:b=isYAxis(mark)?xBounds:yBounds;b.union(axisLayout(view,mark,width,height));break;case TitleRole:title=mark;break;case LegendRole:legends.push(legendLayout(view,mark));break;case FrameRole:case ScopeRole:case RowHeader:case RowFooter:case RowTitle:case ColHeader:case ColFooter:case ColTitle:xBounds.union(mark.bounds);yBounds.union(mark.bounds);break;default:viewBounds.union(mark.bounds)}}if(legends.length){var l={};legends.forEach((function(item){orient=item.orient||Right;if(orient!==None$2)(l[orient]||(l[orient]=[])).push(item)}));for(var _orient in l){var g=l[_orient];gridLayout(view,g,legendParams(g,_orient,_.legends,xBounds,yBounds,width,height))}legends.forEach((function(item){var b=item.bounds;if(!b.equals(item._bounds)){item.bounds=item._bounds;view.dirty(item);item.bounds=b;view.dirty(item)}if(_.autosize&&_.autosize.type===Fit){switch(item.orient){case Left:case Right:viewBounds.add(b.x1,0).add(b.x2,0);break;case Top:case Bottom:viewBounds.add(0,b.y1).add(0,b.y2)}}else{viewBounds.union(b)}}))}viewBounds.union(xBounds).union(yBounds);if(title){viewBounds.union(titleLayout(view,title,width,height,viewBounds))}if(group.clip){viewBounds.set(0,0,group.width||0,group.height||0)}viewSizeLayout(view,group,viewBounds,_)}function viewSizeLayout(view,group,viewBounds,_){var auto=_.autosize||{},type=auto.type;if(view._autosize<1||!type)return;var viewWidth=view._width,viewHeight=view._height,width=Math.max(0,group.width||0),left=Math.max(0,Math.ceil(-viewBounds.x1)),height=Math.max(0,group.height||0),top=Math.max(0,Math.ceil(-viewBounds.y1));var right=Math.max(0,Math.ceil(viewBounds.x2-width)),bottom=Math.max(0,Math.ceil(viewBounds.y2-height));if(auto.contains===Padding){var padding=view.padding();viewWidth-=padding.left+padding.right;viewHeight-=padding.top+padding.bottom}if(type===None$2){left=0;top=0;width=viewWidth;height=viewHeight}else if(type===Fit){width=Math.max(0,viewWidth-left-right);height=Math.max(0,viewHeight-top-bottom)}else if(type===FitX){width=Math.max(0,viewWidth-left-right);viewHeight=height+top+bottom}else if(type===FitY){viewWidth=width+left+right;height=Math.max(0,viewHeight-top-bottom)}else if(type===Pad){viewWidth=width+left+right;viewHeight=height+top+bottom}view._resizeView(viewWidth,viewHeight,width,height,[left,top],auto.resize)}var vtx=Object.freeze({__proto__:null,bound:Bound,identifier:Identifier,mark:Mark,overlap:Overlap,render:Render,viewlayout:ViewLayout});function AxisTicks(params){Transform.call(this,null,params)}inherits(AxisTicks,Transform,{transform:function transform(_,pulse){if(this.value&&!_.modified()){return pulse.StopPropagation}var locale=pulse.dataflow.locale(),out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),ticks=this.value,scale=_.scale,tally=_.count==null?_.values?_.values.length:10:_.count,count=tickCount(scale,tally,_.minstep),format=_.format||tickFormat$1(locale,scale,count,_.formatSpecifier,_.formatType,!!_.values),values=_.values?validTicks(scale,_.values,count):tickValues(scale,count);if(ticks)out.rem=ticks;ticks=values.map((function(value,i){return ingest({index:i/(values.length-1||1),value:value,label:format(value)})}));if(_.extra&&ticks.length){ticks.push(ingest({index:-1,extra:{value:ticks[0].value},label:""}))}out.source=ticks;out.add=ticks;this.value=ticks;return out}});function DataJoin(params){Transform.call(this,null,params)}function defaultItemCreate(){return ingest({})}function newMap(key){var map=fastmap().test((function(t){return t.exit}));map.lookup=function(t){return map.get(key(t))};return map}inherits(DataJoin,Transform,{transform:function transform(_,pulse){var df=pulse.dataflow,out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),item=_.item||defaultItemCreate,key=_.key||tupleid,map=this.value;if(isArray(out.encode)){out.encode=null}if(map&&(_.modified("key")||pulse.modified(key))){error("DataJoin does not support modified key function or fields.")}if(!map){pulse=pulse.addAll();this.value=map=newMap(key)}pulse.visit(pulse.ADD,(function(t){var k=key(t);var x=map.get(k);if(x){if(x.exit){map.empty--;out.add.push(x)}else{out.mod.push(x)}}else{x=item(t);map.set(k,x);out.add.push(x)}x.datum=t;x.exit=false}));pulse.visit(pulse.MOD,(function(t){var k=key(t),x=map.get(k);if(x){x.datum=t;out.mod.push(x)}}));pulse.visit(pulse.REM,(function(t){var k=key(t),x=map.get(k);if(t===x.datum&&!x.exit){out.rem.push(x);x.exit=true;++map.empty}}));if(pulse.changed(pulse.ADD_MOD))out.modifies("datum");if(pulse.clean()||_.clean&&map.empty>df.cleanThreshold){df.runAfter(map.clean)}return out}});function Encode(params){Transform.call(this,null,params)}inherits(Encode,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.ADD_REM),fmod=_.mod||false,encoders=_.encoders,encode=pulse.encode;if(isArray(encode)){if(out.changed()||encode.every((function(e){return encoders[e]}))){encode=encode[0];out.encode=null}else{return pulse.StopPropagation}}var reenter=encode==="enter",update=encoders.update||falsy,enter=encoders.enter||falsy,exit=encoders.exit||falsy,set=(encode&&!reenter?encoders[encode]:update)||falsy;if(pulse.changed(pulse.ADD)){pulse.visit(pulse.ADD,(function(t){enter(t,_);update(t,_)}));out.modifies(enter.output);out.modifies(update.output);if(set!==falsy&&set!==update){pulse.visit(pulse.ADD,(function(t){set(t,_)}));out.modifies(set.output)}}if(pulse.changed(pulse.REM)&&exit!==falsy){pulse.visit(pulse.REM,(function(t){exit(t,_)}));out.modifies(exit.output)}if(reenter||set!==falsy){var flag=pulse.MOD|(_.modified()?pulse.REFLOW:0);if(reenter){pulse.visit(flag,(function(t){var mod=enter(t,_)||fmod;if(set(t,_)||mod)out.mod.push(t)}));if(out.mod.length)out.modifies(enter.output)}else{pulse.visit(flag,(function(t){if(set(t,_)||fmod)out.mod.push(t)}))}if(out.mod.length)out.modifies(set.output)}return out.changed()?out:pulse.StopPropagation}});function LegendEntries(params){Transform.call(this,[],params)}inherits(LegendEntries,Transform,{transform:function transform(_,pulse){if(this.value!=null&&!_.modified()){return pulse.StopPropagation}var locale=pulse.dataflow.locale(),out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),items=this.value,type=_.type||SymbolLegend,scale=_.scale,limit=+_.limit,count=tickCount(scale,_.count==null?5:_.count,_.minstep),lskip=!!_.values||type===SymbolLegend,format=_.format||labelFormat(locale,scale,count,type,_.formatSpecifier,_.formatType,lskip),values=_.values||labelValues(scale,count),domain,fraction,size,offset,ellipsis;if(items)out.rem=items;if(type===SymbolLegend){if(limit&&values.length>limit){pulse.dataflow.warn("Symbol legend count exceeds limit, filtering items.");items=values.slice(0,limit-1);ellipsis=true}else{items=values}if(isFunction(size=_.size)){if(!_.values&&scale(items[0])===0){items=items.slice(1)}offset=items.reduce((function(max,value){return Math.max(max,size(value,_))}),0)}else{size=constant(offset=size||8)}items=items.map((function(value,index){return ingest({index:index,label:format(value,index,items),value:value,offset:offset,size:size(value,_)})}));if(ellipsis){ellipsis=values[items.length];items.push(ingest({index:items.length,label:"".concat(values.length-items.length," entries"),value:ellipsis,offset:offset,size:size(ellipsis,_)}))}}else if(type===GradientLegend){domain=scale.domain(),fraction=scaleFraction(scale,domain[0],peek(domain));if(values.length<3&&!_.values&&domain[0]!==peek(domain)){values=[domain[0],peek(domain)]}items=values.map((function(value,index){return ingest({index:index,label:format(value,index,values),value:value,perc:fraction(value)})}))}else{size=values.length-1;fraction=labelFraction(scale);items=values.map((function(value,index){return ingest({index:index,label:format(value,index,values),value:value,perc:index?fraction(value):0,perc2:index===size?1:fraction(values[index+1])})}))}out.source=items;out.add=items;this.value=items;return out}});var sourceX=function sourceX(t){return t.source.x};var sourceY=function sourceY(t){return t.source.y};var targetX=function targetX(t){return t.target.x};var targetY=function targetY(t){return t.target.y};function LinkPath(params){Transform.call(this,{},params)}LinkPath.Definition={type:"LinkPath",metadata:{modifies:true},params:[{name:"sourceX",type:"field",default:"source.x"},{name:"sourceY",type:"field",default:"source.y"},{name:"targetX",type:"field",default:"target.x"},{name:"targetY",type:"field",default:"target.y"},{name:"orient",type:"enum",default:"vertical",values:["horizontal","vertical","radial"]},{name:"shape",type:"enum",default:"line",values:["line","arc","curve","diagonal","orthogonal"]},{name:"require",type:"signal"},{name:"as",type:"string",default:"path"}]};inherits(LinkPath,Transform,{transform:function transform(_,pulse){var sx=_.sourceX||sourceX,sy=_.sourceY||sourceY,tx=_.targetX||targetX,ty=_.targetY||targetY,as=_.as||"path",orient=_.orient||"vertical",shape=_.shape||"line",path=Paths.get(shape+"-"+orient)||Paths.get(shape);if(!path){error("LinkPath unsupported type: "+_.shape+(_.orient?"-"+_.orient:""))}pulse.visit(pulse.SOURCE,(function(t){t[as]=path(sx(t),sy(t),tx(t),ty(t))}));return pulse.reflow(_.modified()).modifies(as)}});var line$3=function line(sx,sy,tx,ty){return"M"+sx+","+sy+"L"+tx+","+ty};var lineR=function lineR(sa,sr,ta,tr){return line$3(sr*Math.cos(sa),sr*Math.sin(sa),tr*Math.cos(ta),tr*Math.sin(ta))};var arc$3=function arc(sx,sy,tx,ty){var dx=tx-sx,dy=ty-sy,rr=Math.sqrt(dx*dx+dy*dy)/2,ra=180*Math.atan2(dy,dx)/Math.PI;return"M"+sx+","+sy+"A"+rr+","+rr+" "+ra+" 0 1"+" "+tx+","+ty};var arcR=function arcR(sa,sr,ta,tr){return arc$3(sr*Math.cos(sa),sr*Math.sin(sa),tr*Math.cos(ta),tr*Math.sin(ta))};var curve=function curve(sx,sy,tx,ty){var dx=tx-sx,dy=ty-sy,ix=.2*(dx+dy),iy=.2*(dy-dx);return"M"+sx+","+sy+"C"+(sx+ix)+","+(sy+iy)+" "+(tx+iy)+","+(ty-ix)+" "+tx+","+ty};var curveR=function curveR(sa,sr,ta,tr){return curve(sr*Math.cos(sa),sr*Math.sin(sa),tr*Math.cos(ta),tr*Math.sin(ta))};var orthoX=function orthoX(sx,sy,tx,ty){return"M"+sx+","+sy+"V"+ty+"H"+tx};var orthoY=function orthoY(sx,sy,tx,ty){return"M"+sx+","+sy+"H"+tx+"V"+ty};var orthoR=function orthoR(sa,sr,ta,tr){var sc=Math.cos(sa),ss=Math.sin(sa),tc=Math.cos(ta),ts=Math.sin(ta),sf=Math.abs(ta-sa)>Math.PI?ta<=sa:ta>sa;return"M"+sr*sc+","+sr*ss+"A"+sr+","+sr+" 0 0,"+(sf?1:0)+" "+sr*tc+","+sr*ts+"L"+tr*tc+","+tr*ts};var diagonalX=function diagonalX(sx,sy,tx,ty){var m=(sx+tx)/2;return"M"+sx+","+sy+"C"+m+","+sy+" "+m+","+ty+" "+tx+","+ty};var diagonalY=function diagonalY(sx,sy,tx,ty){var m=(sy+ty)/2;return"M"+sx+","+sy+"C"+sx+","+m+" "+tx+","+m+" "+tx+","+ty};var diagonalR=function diagonalR(sa,sr,ta,tr){var sc=Math.cos(sa),ss=Math.sin(sa),tc=Math.cos(ta),ts=Math.sin(ta),mr=(sr+tr)/2;return"M"+sr*sc+","+sr*ss+"C"+mr*sc+","+mr*ss+" "+mr*tc+","+mr*ts+" "+tr*tc+","+tr*ts};var Paths=fastmap({line:line$3,"line-radial":lineR,arc:arc$3,"arc-radial":arcR,curve:curve,"curve-radial":curveR,"orthogonal-horizontal":orthoX,"orthogonal-vertical":orthoY,"orthogonal-radial":orthoR,"diagonal-horizontal":diagonalX,"diagonal-vertical":diagonalY,"diagonal-radial":diagonalR});function Pie(params){Transform.call(this,null,params)}Pie.Definition={type:"Pie",metadata:{modifies:true},params:[{name:"field",type:"field"},{name:"startAngle",type:"number",default:0},{name:"endAngle",type:"number",default:6.283185307179586},{name:"sort",type:"boolean",default:false},{name:"as",type:"string",array:true,length:2,default:["startAngle","endAngle"]}]};inherits(Pie,Transform,{transform:function transform(_,pulse){var as=_.as||["startAngle","endAngle"],startAngle=as[0],endAngle=as[1],field=_.field||one,start=_.startAngle||0,stop=_.endAngle!=null?_.endAngle:2*Math.PI,data=pulse.source,values=data.map(field),n=values.length,a=start,k=(stop-start)/sum(values),index=range$1(n),i,t,v;if(_.sort){index.sort((function(a,b){return values[a]-values[b]}))}for(i=0;i<n;++i){v=values[index[i]];t=data[index[i]];t[startAngle]=a;t[endAngle]=a+=v*k}this.value=values;return pulse.reflow(_.modified()).modifies(as)}});var DEFAULT_COUNT=5;function includeZero(scale){var type=scale.type;return!scale.bins&&(type===Linear$1||type===Pow||type===Sqrt)}function includePad(type){return isContinuous(type)&&type!==Sequential}var SKIP$2=toSet(["set","modified","clear","type","scheme","schemeExtent","schemeCount","domain","domainMin","domainMid","domainMax","domainRaw","domainImplicit","nice","zero","bins","range","rangeStep","round","reverse","interpolate","interpolateGamma"]);function Scale(params){Transform.call(this,null,params);this.modified(true)}inherits(Scale,Transform,{transform:function transform(_,pulse){var df=pulse.dataflow,scale$1=this.value,key=scaleKey(_);if(!scale$1||key!==scale$1.type){this.value=scale$1=scale(key)()}for(key in _){if(!SKIP$2[key]){if(key==="padding"&&includePad(scale$1.type))continue;isFunction(scale$1[key])?scale$1[key](_[key]):df.warn("Unsupported scale property: "+key)}}configureRange(scale$1,_,configureBins(scale$1,_,configureDomain(scale$1,_,df)));return pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS)}});function scaleKey(_){var t=_.type,d="",n;if(t===Sequential)return Sequential+"-"+Linear$1;if(isContinuousColor(_)){n=_.rawDomain?_.rawDomain.length:_.domain?_.domain.length+ +(_.domainMid!=null):0;d=n===2?Sequential+"-":n===3?Diverging+"-":""}return(d+t||Linear$1).toLowerCase()}function isContinuousColor(_){var t=_.type;return isContinuous(t)&&t!==Time&&t!==UTC&&(_.scheme||_.range&&_.range.length&&_.range.every(isString))}function configureDomain(scale,_,df){var raw=rawDomain(scale,_.domainRaw,df);if(raw>-1)return raw;var domain=_.domain,type=scale.type,zero=_.zero||_.zero===undefined&&includeZero(scale),n,mid;if(!domain)return 0;if(includePad(type)&&_.padding&&domain[0]!==peek(domain)){domain=padDomain(type,domain,_.range,_.padding,_.exponent,_.constant)}if(zero||_.domainMin!=null||_.domainMax!=null||_.domainMid!=null){n=(domain=domain.slice()).length-1||1;if(zero){if(domain[0]>0)domain[0]=0;if(domain[n]<0)domain[n]=0}if(_.domainMin!=null)domain[0]=_.domainMin;if(_.domainMax!=null)domain[n]=_.domainMax;if(_.domainMid!=null){mid=_.domainMid;var i=mid>domain[n]?n+1:mid<domain[0]?0:n;if(i!==n)df.warn("Scale domainMid exceeds domain min or max.",mid);domain.splice(i,0,mid)}}scale.domain(domainCheck(type,domain,df));if(type===Ordinal){scale.unknown(_.domainImplicit?implicit:undefined)}if(_.nice&&scale.nice){scale.nice(_.nice!==true&&tickCount(scale,_.nice)||null)}return domain.length}function rawDomain(scale,raw,df){if(raw){scale.domain(domainCheck(scale.type,raw,df));return raw.length}else{return-1}}function padDomain(type,domain,range,pad,exponent,constant){var span=Math.abs(peek(range)-range[0]),frac=span/(span-2*pad),d=type===Log?zoomLog(domain,null,frac):type===Sqrt?zoomPow(domain,null,frac,.5):type===Pow?zoomPow(domain,null,frac,exponent||1):type===Symlog?zoomSymlog(domain,null,frac,constant||1):zoomLinear(domain,null,frac);domain=domain.slice();domain[0]=d[0];domain[domain.length-1]=d[1];return domain}function domainCheck(type,domain,df){if(isLogarithmic(type)){var s=Math.abs(domain.reduce((function(s,v){return s+(v<0?-1:v>0?1:0)}),0));if(s!==domain.length){df.warn("Log scale domain includes zero: "+$(domain))}}return domain}function configureBins(scale,_,count){var bins=_.bins;if(bins&&!isArray(bins)){var domain=scale.domain(),lo=domain[0],hi=peek(domain),step=bins.step;var start=bins.start==null?lo:bins.start,stop=bins.stop==null?hi:bins.stop;if(!step)error("Scale bins parameter missing step property.");if(start<lo)start=step*Math.ceil(lo/step);if(stop>hi)stop=step*Math.floor(hi/step);bins=range$1(start,stop+step/2,step)}if(bins){scale.bins=bins}else if(scale.bins){delete scale.bins}if(scale.type===BinOrdinal){if(!bins){scale.bins=scale.domain()}else if(!_.domain&&!_.domainRaw){scale.domain(bins);count=bins.length}}return count}function configureRange(scale,_,count){var type=scale.type,round=_.round||false,range=_.range;if(_.rangeStep!=null){range=configureRangeStep(type,_,count)}else if(_.scheme){range=configureScheme(type,_,count);if(isFunction(range)){if(scale.interpolator){return scale.interpolator(range)}else{error("Scale type ".concat(type," does not support interpolating color schemes."))}}}if(range&&isInterpolating(type)){return scale.interpolator(interpolateColors(flip(range,_.reverse),_.interpolate,_.interpolateGamma))}if(range&&_.interpolate&&scale.interpolate){scale.interpolate(interpolate(_.interpolate,_.interpolateGamma))}else if(isFunction(scale.round)){scale.round(round)}else if(isFunction(scale.rangeRound)){scale.interpolate(round?interpolateRound:interpolate$1)}if(range)scale.range(flip(range,_.reverse))}function configureRangeStep(type,_,count){if(type!==Band&&type!==Point){error("Only band and point scales support rangeStep.")}var outer=(_.paddingOuter!=null?_.paddingOuter:_.padding)||0,inner=type===Point?1:(_.paddingInner!=null?_.paddingInner:_.padding)||0;return[0,_.rangeStep*bandSpace(count,inner,outer)]}function configureScheme(type,_,count){var extent=_.schemeExtent,name,scheme$1;if(isArray(_.scheme)){scheme$1=interpolateColors(_.scheme,_.interpolate,_.interpolateGamma)}else{name=_.scheme.toLowerCase();scheme$1=scheme(name);if(!scheme$1)error("Unrecognized scheme name: ".concat(_.scheme))}count=type===Threshold?count+1:type===BinOrdinal?count-1:type===Quantile$1||type===Quantize?+_.schemeCount||DEFAULT_COUNT:count;return isInterpolating(type)?adjustScheme(scheme$1,extent,_.reverse):isFunction(scheme$1)?quantizeInterpolator(adjustScheme(scheme$1,extent),count):type===Ordinal?scheme$1:scheme$1.slice(0,count)}function adjustScheme(scheme,extent,reverse){return isFunction(scheme)&&(extent||reverse)?interpolateRange(scheme,flip(extent||[0,1],reverse)):scheme}function flip(array,reverse){return reverse?array.slice().reverse():array}function SortItems(params){Transform.call(this,null,params)}inherits(SortItems,Transform,{transform:function transform(_,pulse){var mod=_.modified("sort")||pulse.changed(pulse.ADD)||pulse.modified(_.sort.fields)||pulse.modified("datum");if(mod)pulse.source.sort(stableCompare(_.sort));this.modified(mod);return pulse}});var Zero="zero",Center="center",Normalize="normalize",DefOutput=["y0","y1"];function Stack(params){Transform.call(this,null,params)}Stack.Definition={type:"Stack",metadata:{modifies:true},params:[{name:"field",type:"field"},{name:"groupby",type:"field",array:true},{name:"sort",type:"compare"},{name:"offset",type:"enum",default:Zero,values:[Zero,Center,Normalize]},{name:"as",type:"string",array:true,length:2,default:DefOutput}]};inherits(Stack,Transform,{transform:function transform(_,pulse){var as=_.as||DefOutput,y0=as[0],y1=as[1],sort=stableCompare(_.sort),field=_.field||one,stack=_.offset===Center?stackCenter:_.offset===Normalize?stackNormalize:stackZero,groups,i,n,max;groups=partition$2(pulse.source,_.groupby,sort,field);for(i=0,n=groups.length,max=groups.max;i<n;++i){stack(groups[i],max,field,y0,y1)}return pulse.reflow(_.modified()).modifies(as)}});function stackCenter(group,max,field,y0,y1){var last=(max-group.sum)/2,m=group.length,j=0,t;for(;j<m;++j){t=group[j];t[y0]=last;t[y1]=last+=Math.abs(field(t))}}function stackNormalize(group,max,field,y0,y1){var scale=1/group.sum,last=0,m=group.length,j=0,v=0,t;for(;j<m;++j){t=group[j];t[y0]=last;t[y1]=last=scale*(v+=Math.abs(field(t)))}}function stackZero(group,max,field,y0,y1){var lastPos=0,lastNeg=0,m=group.length,j=0,v,t;for(;j<m;++j){t=group[j];v=+field(t);if(v<0){t[y0]=lastNeg;t[y1]=lastNeg+=v}else{t[y0]=lastPos;t[y1]=lastPos+=v}}}function partition$2(data,groupby,sort,field){var groups=[],get=function get(f){return f(t)},map,i,n,m,t,k,g,s,max;if(groupby==null){groups.push(data.slice())}else{for(map={},i=0,n=data.length;i<n;++i){t=data[i];k=groupby.map(get);g=map[k];if(!g){map[k]=g=[];groups.push(g)}g.push(t)}}for(k=0,max=0,m=groups.length;k<m;++k){g=groups[k];for(i=0,s=0,n=g.length;i<n;++i){s+=Math.abs(field(g[i]))}g.sum=s;if(s>max)max=s;if(sort)g.sort(sort)}groups.max=max;return groups}var encode=Object.freeze({__proto__:null,axisticks:AxisTicks,datajoin:DataJoin,encode:Encode,legendentries:LegendEntries,linkpath:LinkPath,pie:Pie,scale:Scale,sortitems:SortItems,stack:Stack});var epsilon$3=1e-6;var epsilon2$1=1e-12;var pi$2=Math.PI;var halfPi$1=pi$2/2;var quarterPi=pi$2/4;var tau$2=pi$2*2;var degrees$2=180/pi$2;var radians$1=pi$2/180;var abs$1=Math.abs;var atan=Math.atan;var atan2$1=Math.atan2;var cos$1=Math.cos;var ceil=Math.ceil;var exp$2=Math.exp;var hypot=Math.hypot;var log$4=Math.log;var pow$3=Math.pow;var sin$1=Math.sin;var sign$1=Math.sign||function(x){return x>0?1:x<0?-1:0};var sqrt$2=Math.sqrt;var tan=Math.tan;function acos$1(x){return x>1?0:x<-1?pi$2:Math.acos(x)}function asin$1(x){return x>1?halfPi$1:x<-1?-halfPi$1:Math.asin(x)}function noop$2(){}function streamGeometry(geometry,stream){if(geometry&&streamGeometryType.hasOwnProperty(geometry.type)){streamGeometryType[geometry.type](geometry,stream)}}var streamObjectType={Feature:function Feature(object,stream){streamGeometry(object.geometry,stream)},FeatureCollection:function FeatureCollection(object,stream){var features=object.features,i=-1,n=features.length;while(++i<n){streamGeometry(features[i].geometry,stream)}}};var streamGeometryType={Sphere:function Sphere(object,stream){stream.sphere()},Point:function Point(object,stream){object=object.coordinates;stream.point(object[0],object[1],object[2])},MultiPoint:function MultiPoint(object,stream){var coordinates=object.coordinates,i=-1,n=coordinates.length;while(++i<n){object=coordinates[i],stream.point(object[0],object[1],object[2])}},LineString:function LineString(object,stream){streamLine(object.coordinates,stream,0)},MultiLineString:function MultiLineString(object,stream){var coordinates=object.coordinates,i=-1,n=coordinates.length;while(++i<n){streamLine(coordinates[i],stream,0)}},Polygon:function Polygon(object,stream){streamPolygon(object.coordinates,stream)},MultiPolygon:function MultiPolygon(object,stream){var coordinates=object.coordinates,i=-1,n=coordinates.length;while(++i<n){streamPolygon(coordinates[i],stream)}},GeometryCollection:function GeometryCollection(object,stream){var geometries=object.geometries,i=-1,n=geometries.length;while(++i<n){streamGeometry(geometries[i],stream)}}};function streamLine(coordinates,stream,closed){var i=-1,n=coordinates.length-closed,coordinate;stream.lineStart();while(++i<n){coordinate=coordinates[i],stream.point(coordinate[0],coordinate[1],coordinate[2])}stream.lineEnd()}function streamPolygon(coordinates,stream){var i=-1,n=coordinates.length;stream.polygonStart();while(++i<n){streamLine(coordinates[i],stream,1)}stream.polygonEnd()}function geoStream(object,stream){if(object&&streamObjectType.hasOwnProperty(object.type)){streamObjectType[object.type](object,stream)}else{streamGeometry(object,stream)}}var areaRingSum=new Adder;var areaSum=new Adder,lambda00,phi00,lambda0,cosPhi0,sinPhi0;var areaStream={point:noop$2,lineStart:noop$2,lineEnd:noop$2,polygonStart:function polygonStart(){areaRingSum=new Adder;areaStream.lineStart=areaRingStart;areaStream.lineEnd=areaRingEnd},polygonEnd:function polygonEnd(){var areaRing=+areaRingSum;areaSum.add(areaRing<0?tau$2+areaRing:areaRing);this.lineStart=this.lineEnd=this.point=noop$2},sphere:function sphere(){areaSum.add(tau$2)}};function areaRingStart(){areaStream.point=areaPointFirst}function areaRingEnd(){areaPoint(lambda00,phi00)}function areaPointFirst(lambda,phi){areaStream.point=areaPoint;lambda00=lambda,phi00=phi;lambda*=radians$1,phi*=radians$1;lambda0=lambda,cosPhi0=cos$1(phi=phi/2+quarterPi),sinPhi0=sin$1(phi)}function areaPoint(lambda,phi){lambda*=radians$1,phi*=radians$1;phi=phi/2+quarterPi;var dLambda=lambda-lambda0,sdLambda=dLambda>=0?1:-1,adLambda=sdLambda*dLambda,cosPhi=cos$1(phi),sinPhi=sin$1(phi),k=sinPhi0*sinPhi,u=cosPhi0*cosPhi+k*cos$1(adLambda),v=k*sdLambda*sin$1(adLambda);areaRingSum.add(atan2$1(v,u));lambda0=lambda,cosPhi0=cosPhi,sinPhi0=sinPhi}function geoArea$1(object){areaSum=new Adder;geoStream(object,areaStream);return areaSum*2}function spherical(cartesian){return[atan2$1(cartesian[1],cartesian[0]),asin$1(cartesian[2])]}function cartesian(spherical){var lambda=spherical[0],phi=spherical[1],cosPhi=cos$1(phi);return[cosPhi*cos$1(lambda),cosPhi*sin$1(lambda),sin$1(phi)]}function cartesianDot(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]}function cartesianCross(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]}function cartesianAddInPlace(a,b){a[0]+=b[0],a[1]+=b[1],a[2]+=b[2]}function cartesianScale(vector,k){return[vector[0]*k,vector[1]*k,vector[2]*k]}function cartesianNormalizeInPlace(d){var l=sqrt$2(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]);d[0]/=l,d[1]/=l,d[2]/=l}var lambda0$1,phi0,lambda1,phi1,lambda2,lambda00$1,phi00$1,p0,deltaSum,ranges,range;var boundsStream={point:boundsPoint,lineStart:boundsLineStart,lineEnd:boundsLineEnd,polygonStart:function polygonStart(){boundsStream.point=boundsRingPoint;boundsStream.lineStart=boundsRingStart;boundsStream.lineEnd=boundsRingEnd;deltaSum=new Adder;areaStream.polygonStart()},polygonEnd:function polygonEnd(){areaStream.polygonEnd();boundsStream.point=boundsPoint;boundsStream.lineStart=boundsLineStart;boundsStream.lineEnd=boundsLineEnd;if(areaRingSum<0)lambda0$1=-(lambda1=180),phi0=-(phi1=90);else if(deltaSum>epsilon$3)phi1=90;else if(deltaSum<-epsilon$3)phi0=-90;range[0]=lambda0$1,range[1]=lambda1},sphere:function sphere(){lambda0$1=-(lambda1=180),phi0=-(phi1=90)}};function boundsPoint(lambda,phi){ranges.push(range=[lambda0$1=lambda,lambda1=lambda]);if(phi<phi0)phi0=phi;if(phi>phi1)phi1=phi}function linePoint(lambda,phi){var p=cartesian([lambda*radians$1,phi*radians$1]);if(p0){var normal=cartesianCross(p0,p),equatorial=[normal[1],-normal[0],0],inflection=cartesianCross(equatorial,normal);cartesianNormalizeInPlace(inflection);inflection=spherical(inflection);var delta=lambda-lambda2,sign=delta>0?1:-1,lambdai=inflection[0]*degrees$2*sign,phii,antimeridian=abs$1(delta)>180;if(antimeridian^(sign*lambda2<lambdai&&lambdai<sign*lambda)){phii=inflection[1]*degrees$2;if(phii>phi1)phi1=phii}else if(lambdai=(lambdai+360)%360-180,antimeridian^(sign*lambda2<lambdai&&lambdai<sign*lambda)){phii=-inflection[1]*degrees$2;if(phii<phi0)phi0=phii}else{if(phi<phi0)phi0=phi;if(phi>phi1)phi1=phi}if(antimeridian){if(lambda<lambda2){if(angle(lambda0$1,lambda)>angle(lambda0$1,lambda1))lambda1=lambda}else{if(angle(lambda,lambda1)>angle(lambda0$1,lambda1))lambda0$1=lambda}}else{if(lambda1>=lambda0$1){if(lambda<lambda0$1)lambda0$1=lambda;if(lambda>lambda1)lambda1=lambda}else{if(lambda>lambda2){if(angle(lambda0$1,lambda)>angle(lambda0$1,lambda1))lambda1=lambda}else{if(angle(lambda,lambda1)>angle(lambda0$1,lambda1))lambda0$1=lambda}}}}else{ranges.push(range=[lambda0$1=lambda,lambda1=lambda])}if(phi<phi0)phi0=phi;if(phi>phi1)phi1=phi;p0=p,lambda2=lambda}function boundsLineStart(){boundsStream.point=linePoint}function boundsLineEnd(){range[0]=lambda0$1,range[1]=lambda1;boundsStream.point=boundsPoint;p0=null}function boundsRingPoint(lambda,phi){if(p0){var delta=lambda-lambda2;deltaSum.add(abs$1(delta)>180?delta+(delta>0?360:-360):delta)}else{lambda00$1=lambda,phi00$1=phi}areaStream.point(lambda,phi);linePoint(lambda,phi)}function boundsRingStart(){areaStream.lineStart()}function boundsRingEnd(){boundsRingPoint(lambda00$1,phi00$1);areaStream.lineEnd();if(abs$1(deltaSum)>epsilon$3)lambda0$1=-(lambda1=180);range[0]=lambda0$1,range[1]=lambda1;p0=null}function angle(lambda0,lambda1){return(lambda1-=lambda0)<0?lambda1+360:lambda1}function rangeCompare(a,b){return a[0]-b[0]}function rangeContains(range,x){return range[0]<=range[1]?range[0]<=x&&x<=range[1]:x<range[0]||range[1]<x}function geoBounds$1(feature){var i,n,a,b,merged,deltaMax,delta;phi1=lambda1=-(lambda0$1=phi0=Infinity);ranges=[];geoStream(feature,boundsStream);if(n=ranges.length){ranges.sort(rangeCompare);for(i=1,a=ranges[0],merged=[a];i<n;++i){b=ranges[i];if(rangeContains(a,b[0])||rangeContains(a,b[1])){if(angle(a[0],b[1])>angle(a[0],a[1]))a[1]=b[1];if(angle(b[0],a[1])>angle(a[0],a[1]))a[0]=b[0]}else{merged.push(a=b)}}for(deltaMax=-Infinity,n=merged.length-1,i=0,a=merged[n];i<=n;a=b,++i){b=merged[i];if((delta=angle(a[1],b[0]))>deltaMax)deltaMax=delta,lambda0$1=b[0],lambda1=a[1]}}ranges=range=null;return lambda0$1===Infinity||phi0===Infinity?[[NaN,NaN],[NaN,NaN]]:[[lambda0$1,phi0],[lambda1,phi1]]}var W0,W1,X0,Y0,Z0,X1,Y1,Z1,X2,Y2,Z2,lambda00$2,phi00$2,x0,y0,z0;var centroidStream={sphere:noop$2,point:centroidPoint,lineStart:centroidLineStart,lineEnd:centroidLineEnd,polygonStart:function polygonStart(){centroidStream.lineStart=centroidRingStart;centroidStream.lineEnd=centroidRingEnd},polygonEnd:function polygonEnd(){centroidStream.lineStart=centroidLineStart;centroidStream.lineEnd=centroidLineEnd}};function centroidPoint(lambda,phi){lambda*=radians$1,phi*=radians$1;var cosPhi=cos$1(phi);centroidPointCartesian(cosPhi*cos$1(lambda),cosPhi*sin$1(lambda),sin$1(phi))}function centroidPointCartesian(x,y,z){++W0;X0+=(x-X0)/W0;Y0+=(y-Y0)/W0;Z0+=(z-Z0)/W0}function centroidLineStart(){centroidStream.point=centroidLinePointFirst}function centroidLinePointFirst(lambda,phi){lambda*=radians$1,phi*=radians$1;var cosPhi=cos$1(phi);x0=cosPhi*cos$1(lambda);y0=cosPhi*sin$1(lambda);z0=sin$1(phi);centroidStream.point=centroidLinePoint;centroidPointCartesian(x0,y0,z0)}function centroidLinePoint(lambda,phi){lambda*=radians$1,phi*=radians$1;var cosPhi=cos$1(phi),x=cosPhi*cos$1(lambda),y=cosPhi*sin$1(lambda),z=sin$1(phi),w=atan2$1(sqrt$2((w=y0*z-z0*y)*w+(w=z0*x-x0*z)*w+(w=x0*y-y0*x)*w),x0*x+y0*y+z0*z);W1+=w;X1+=w*(x0+(x0=x));Y1+=w*(y0+(y0=y));Z1+=w*(z0+(z0=z));centroidPointCartesian(x0,y0,z0)}function centroidLineEnd(){centroidStream.point=centroidPoint}function centroidRingStart(){centroidStream.point=centroidRingPointFirst}function centroidRingEnd(){centroidRingPoint(lambda00$2,phi00$2);centroidStream.point=centroidPoint}function centroidRingPointFirst(lambda,phi){lambda00$2=lambda,phi00$2=phi;lambda*=radians$1,phi*=radians$1;centroidStream.point=centroidRingPoint;var cosPhi=cos$1(phi);x0=cosPhi*cos$1(lambda);y0=cosPhi*sin$1(lambda);z0=sin$1(phi);centroidPointCartesian(x0,y0,z0)}function centroidRingPoint(lambda,phi){lambda*=radians$1,phi*=radians$1;var cosPhi=cos$1(phi),x=cosPhi*cos$1(lambda),y=cosPhi*sin$1(lambda),z=sin$1(phi),cx=y0*z-z0*y,cy=z0*x-x0*z,cz=x0*y-y0*x,m=hypot(cx,cy,cz),w=asin$1(m),v=m&&-w/m;X2.add(v*cx);Y2.add(v*cy);Z2.add(v*cz);W1+=w;X1+=w*(x0+(x0=x));Y1+=w*(y0+(y0=y));Z1+=w*(z0+(z0=z));centroidPointCartesian(x0,y0,z0)}function geoCentroid$1(object){W0=W1=X0=Y0=Z0=X1=Y1=Z1=0;X2=new Adder;Y2=new Adder;Z2=new Adder;geoStream(object,centroidStream);var x=+X2,y=+Y2,z=+Z2,m=hypot(x,y,z);if(m<epsilon2$1){x=X1,y=Y1,z=Z1;if(W1<epsilon$3)x=X0,y=Y0,z=Z0;m=hypot(x,y,z);if(m<epsilon2$1)return[NaN,NaN]}return[atan2$1(y,x)*degrees$2,asin$1(z/m)*degrees$2]}function compose(a,b){function compose(x,y){return x=a(x,y),b(x[0],x[1])}if(a.invert&&b.invert)compose.invert=function(x,y){return x=b.invert(x,y),x&&a.invert(x[0],x[1])};return compose}function rotationIdentity(lambda,phi){return[abs$1(lambda)>pi$2?lambda+Math.round(-lambda/tau$2)*tau$2:lambda,phi]}rotationIdentity.invert=rotationIdentity;function rotateRadians(deltaLambda,deltaPhi,deltaGamma){return(deltaLambda%=tau$2)?deltaPhi||deltaGamma?compose(rotationLambda(deltaLambda),rotationPhiGamma(deltaPhi,deltaGamma)):rotationLambda(deltaLambda):deltaPhi||deltaGamma?rotationPhiGamma(deltaPhi,deltaGamma):rotationIdentity}function forwardRotationLambda(deltaLambda){return function(lambda,phi){return lambda+=deltaLambda,[lambda>pi$2?lambda-tau$2:lambda<-pi$2?lambda+tau$2:lambda,phi]}}function rotationLambda(deltaLambda){var rotation=forwardRotationLambda(deltaLambda);rotation.invert=forwardRotationLambda(-deltaLambda);return rotation}function rotationPhiGamma(deltaPhi,deltaGamma){var cosDeltaPhi=cos$1(deltaPhi),sinDeltaPhi=sin$1(deltaPhi),cosDeltaGamma=cos$1(deltaGamma),sinDeltaGamma=sin$1(deltaGamma);function rotation(lambda,phi){var cosPhi=cos$1(phi),x=cos$1(lambda)*cosPhi,y=sin$1(lambda)*cosPhi,z=sin$1(phi),k=z*cosDeltaPhi+x*sinDeltaPhi;return[atan2$1(y*cosDeltaGamma-k*sinDeltaGamma,x*cosDeltaPhi-z*sinDeltaPhi),asin$1(k*cosDeltaGamma+y*sinDeltaGamma)]}rotation.invert=function(lambda,phi){var cosPhi=cos$1(phi),x=cos$1(lambda)*cosPhi,y=sin$1(lambda)*cosPhi,z=sin$1(phi),k=z*cosDeltaGamma-y*sinDeltaGamma;return[atan2$1(y*cosDeltaGamma+z*sinDeltaGamma,x*cosDeltaPhi+k*sinDeltaPhi),asin$1(k*cosDeltaPhi-x*sinDeltaPhi)]};return rotation}function rotation(rotate){rotate=rotateRadians(rotate[0]*radians$1,rotate[1]*radians$1,rotate.length>2?rotate[2]*radians$1:0);function forward(coordinates){coordinates=rotate(coordinates[0]*radians$1,coordinates[1]*radians$1);return coordinates[0]*=degrees$2,coordinates[1]*=degrees$2,coordinates}forward.invert=function(coordinates){coordinates=rotate.invert(coordinates[0]*radians$1,coordinates[1]*radians$1);return coordinates[0]*=degrees$2,coordinates[1]*=degrees$2,coordinates};return forward}function circleStream(stream,radius,delta,direction,t0,t1){if(!delta)return;var cosRadius=cos$1(radius),sinRadius=sin$1(radius),step=direction*delta;if(t0==null){t0=radius+direction*tau$2;t1=radius-step/2}else{t0=circleRadius(cosRadius,t0);t1=circleRadius(cosRadius,t1);if(direction>0?t0<t1:t0>t1)t0+=direction*tau$2}for(var point,t=t0;direction>0?t>t1:t<t1;t-=step){point=spherical([cosRadius,-sinRadius*cos$1(t),-sinRadius*sin$1(t)]);stream.point(point[0],point[1])}}function circleRadius(cosRadius,point){point=cartesian(point),point[0]-=cosRadius;cartesianNormalizeInPlace(point);var radius=acos$1(-point[1]);return((-point[2]<0?-radius:radius)+tau$2-epsilon$3)%tau$2}function clipBuffer(){var lines=[],line;return{point:function point(x,y,m){line.push([x,y,m])},lineStart:function lineStart(){lines.push(line=[])},lineEnd:noop$2,rejoin:function rejoin(){if(lines.length>1)lines.push(lines.pop().concat(lines.shift()))},result:function result(){var result=lines;lines=[];line=null;return result}}}function pointEqual(a,b){return abs$1(a[0]-b[0])<epsilon$3&&abs$1(a[1]-b[1])<epsilon$3}function Intersection(point,points,other,entry){this.x=point;this.z=points;this.o=other;this.e=entry;this.v=false;this.n=this.p=null}function clipRejoin(segments,compareIntersection,startInside,interpolate,stream){var subject=[],clip=[],i,n;segments.forEach((function(segment){if((n=segment.length-1)<=0)return;var n,p0=segment[0],p1=segment[n],x;if(pointEqual(p0,p1)){if(!p0[2]&&!p1[2]){stream.lineStart();for(i=0;i<n;++i){stream.point((p0=segment[i])[0],p0[1])}stream.lineEnd();return}p1[0]+=2*epsilon$3}subject.push(x=new Intersection(p0,segment,null,true));clip.push(x.o=new Intersection(p0,null,x,false));subject.push(x=new Intersection(p1,segment,null,false));clip.push(x.o=new Intersection(p1,null,x,true))}));if(!subject.length)return;clip.sort(compareIntersection);link(subject);link(clip);for(i=0,n=clip.length;i<n;++i){clip[i].e=startInside=!startInside}var start=subject[0],points,point;while(1){var current=start,isSubject=true;while(current.v){if((current=current.n)===start)return}points=current.z;stream.lineStart();do{current.v=current.o.v=true;if(current.e){if(isSubject){for(i=0,n=points.length;i<n;++i){stream.point((point=points[i])[0],point[1])}}else{interpolate(current.x,current.n.x,1,stream)}current=current.n}else{if(isSubject){points=current.p.z;for(i=points.length-1;i>=0;--i){stream.point((point=points[i])[0],point[1])}}else{interpolate(current.x,current.p.x,-1,stream)}current=current.p}current=current.o;points=current.z;isSubject=!isSubject}while(!current.v);stream.lineEnd()}}function link(array){if(!(n=array.length))return;var n,i=0,a=array[0],b;while(++i<n){a.n=b=array[i];b.p=a;a=b}a.n=b=array[0];b.p=a}function longitude(point){if(abs$1(point[0])<=pi$2)return point[0];else return sign$1(point[0])*((abs$1(point[0])+pi$2)%tau$2-pi$2)}function polygonContains(polygon,point){var lambda=longitude(point),phi=point[1],sinPhi=sin$1(phi),normal=[sin$1(lambda),-cos$1(lambda),0],angle=0,winding=0;var sum=new Adder;if(sinPhi===1)phi=halfPi$1+epsilon$3;else if(sinPhi===-1)phi=-halfPi$1-epsilon$3;for(var i=0,n=polygon.length;i<n;++i){if(!(m=(ring=polygon[i]).length))continue;var ring,m,point0=ring[m-1],lambda0=longitude(point0),phi0=point0[1]/2+quarterPi,sinPhi0=sin$1(phi0),cosPhi0=cos$1(phi0);for(var j=0;j<m;++j,lambda0=lambda1,sinPhi0=sinPhi1,cosPhi0=cosPhi1,point0=point1){var point1=ring[j],lambda1=longitude(point1),phi1=point1[1]/2+quarterPi,sinPhi1=sin$1(phi1),cosPhi1=cos$1(phi1),delta=lambda1-lambda0,sign=delta>=0?1:-1,absDelta=sign*delta,antimeridian=absDelta>pi$2,k=sinPhi0*sinPhi1;sum.add(atan2$1(k*sign*sin$1(absDelta),cosPhi0*cosPhi1+k*cos$1(absDelta)));angle+=antimeridian?delta+sign*tau$2:delta;if(antimeridian^lambda0>=lambda^lambda1>=lambda){var arc=cartesianCross(cartesian(point0),cartesian(point1));cartesianNormalizeInPlace(arc);var intersection=cartesianCross(normal,arc);cartesianNormalizeInPlace(intersection);var phiArc=(antimeridian^delta>=0?-1:1)*asin$1(intersection[2]);if(phi>phiArc||phi===phiArc&&(arc[0]||arc[1])){winding+=antimeridian^delta>=0?1:-1}}}}return(angle<-epsilon$3||angle<epsilon$3&&sum<-epsilon2$1)^winding&1}function clip$2(pointVisible,clipLine,interpolate,start){return function(sink){var line=clipLine(sink),ringBuffer=clipBuffer(),ringSink=clipLine(ringBuffer),polygonStarted=false,polygon,segments,ring;var clip={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function polygonStart(){clip.point=pointRing;clip.lineStart=ringStart;clip.lineEnd=ringEnd;segments=[];polygon=[]},polygonEnd:function polygonEnd(){clip.point=point;clip.lineStart=lineStart;clip.lineEnd=lineEnd;segments=merge$1(segments);var startInside=polygonContains(polygon,start);if(segments.length){if(!polygonStarted)sink.polygonStart(),polygonStarted=true;clipRejoin(segments,compareIntersection,startInside,interpolate,sink)}else if(startInside){if(!polygonStarted)sink.polygonStart(),polygonStarted=true;sink.lineStart();interpolate(null,null,1,sink);sink.lineEnd()}if(polygonStarted)sink.polygonEnd(),polygonStarted=false;segments=polygon=null},sphere:function sphere(){sink.polygonStart();sink.lineStart();interpolate(null,null,1,sink);sink.lineEnd();sink.polygonEnd()}};function point(lambda,phi){if(pointVisible(lambda,phi))sink.point(lambda,phi)}function pointLine(lambda,phi){line.point(lambda,phi)}function lineStart(){clip.point=pointLine;line.lineStart()}function lineEnd(){clip.point=point;line.lineEnd()}function pointRing(lambda,phi){ring.push([lambda,phi]);ringSink.point(lambda,phi)}function ringStart(){ringSink.lineStart();ring=[]}function ringEnd(){pointRing(ring[0][0],ring[0][1]);ringSink.lineEnd();var clean=ringSink.clean(),ringSegments=ringBuffer.result(),i,n=ringSegments.length,m,segment,point;ring.pop();polygon.push(ring);ring=null;if(!n)return;if(clean&1){segment=ringSegments[0];if((m=segment.length-1)>0){if(!polygonStarted)sink.polygonStart(),polygonStarted=true;sink.lineStart();for(i=0;i<m;++i){sink.point((point=segment[i])[0],point[1])}sink.lineEnd()}return}if(n>1&&clean&2)ringSegments.push(ringSegments.pop().concat(ringSegments.shift()));segments.push(ringSegments.filter(validSegment))}return clip}}function validSegment(segment){return segment.length>1}function compareIntersection(a,b){return((a=a.x)[0]<0?a[1]-halfPi$1-epsilon$3:halfPi$1-a[1])-((b=b.x)[0]<0?b[1]-halfPi$1-epsilon$3:halfPi$1-b[1])}var clipAntimeridian=clip$2((function(){return true}),clipAntimeridianLine,clipAntimeridianInterpolate,[-pi$2,-halfPi$1]);function clipAntimeridianLine(stream){var lambda0=NaN,phi0=NaN,sign0=NaN,_clean;return{lineStart:function lineStart(){stream.lineStart();_clean=1},point:function point(lambda1,phi1){var sign1=lambda1>0?pi$2:-pi$2,delta=abs$1(lambda1-lambda0);if(abs$1(delta-pi$2)<epsilon$3){stream.point(lambda0,phi0=(phi0+phi1)/2>0?halfPi$1:-halfPi$1);stream.point(sign0,phi0);stream.lineEnd();stream.lineStart();stream.point(sign1,phi0);stream.point(lambda1,phi0);_clean=0}else if(sign0!==sign1&&delta>=pi$2){if(abs$1(lambda0-sign0)<epsilon$3)lambda0-=sign0*epsilon$3;if(abs$1(lambda1-sign1)<epsilon$3)lambda1-=sign1*epsilon$3;phi0=clipAntimeridianIntersect(lambda0,phi0,lambda1,phi1);stream.point(sign0,phi0);stream.lineEnd();stream.lineStart();stream.point(sign1,phi0);_clean=0}stream.point(lambda0=lambda1,phi0=phi1);sign0=sign1},lineEnd:function lineEnd(){stream.lineEnd();lambda0=phi0=NaN},clean:function clean(){return 2-_clean}}}function clipAntimeridianIntersect(lambda0,phi0,lambda1,phi1){var cosPhi0,cosPhi1,sinLambda0Lambda1=sin$1(lambda0-lambda1);return abs$1(sinLambda0Lambda1)>epsilon$3?atan((sin$1(phi0)*(cosPhi1=cos$1(phi1))*sin$1(lambda1)-sin$1(phi1)*(cosPhi0=cos$1(phi0))*sin$1(lambda0))/(cosPhi0*cosPhi1*sinLambda0Lambda1)):(phi0+phi1)/2}function clipAntimeridianInterpolate(from,to,direction,stream){var phi;if(from==null){phi=direction*halfPi$1;stream.point(-pi$2,phi);stream.point(0,phi);stream.point(pi$2,phi);stream.point(pi$2,0);stream.point(pi$2,-phi);stream.point(0,-phi);stream.point(-pi$2,-phi);stream.point(-pi$2,0);stream.point(-pi$2,phi)}else if(abs$1(from[0]-to[0])>epsilon$3){var lambda=from[0]<to[0]?pi$2:-pi$2;phi=direction*lambda/2;stream.point(-lambda,phi);stream.point(0,phi);stream.point(lambda,phi)}else{stream.point(to[0],to[1])}}function clipCircle(radius){var cr=cos$1(radius),delta=6*radians$1,smallRadius=cr>0,notHemisphere=abs$1(cr)>epsilon$3;function interpolate(from,to,direction,stream){circleStream(stream,radius,delta,direction,from,to)}function visible(lambda,phi){return cos$1(lambda)*cos$1(phi)>cr}function clipLine(stream){var point0,c0,v0,v00,_clean;return{lineStart:function lineStart(){v00=v0=false;_clean=1},point:function point(lambda,phi){var point1=[lambda,phi],point2,v=visible(lambda,phi),c=smallRadius?v?0:code(lambda,phi):v?code(lambda+(lambda<0?pi$2:-pi$2),phi):0;if(!point0&&(v00=v0=v))stream.lineStart();if(v!==v0){point2=intersect(point0,point1);if(!point2||pointEqual(point0,point2)||pointEqual(point1,point2))point1[2]=1}if(v!==v0){_clean=0;if(v){stream.lineStart();point2=intersect(point1,point0);stream.point(point2[0],point2[1])}else{point2=intersect(point0,point1);stream.point(point2[0],point2[1],2);stream.lineEnd()}point0=point2}else if(notHemisphere&&point0&&smallRadius^v){var t;if(!(c&c0)&&(t=intersect(point1,point0,true))){_clean=0;if(smallRadius){stream.lineStart();stream.point(t[0][0],t[0][1]);stream.point(t[1][0],t[1][1]);stream.lineEnd()}else{stream.point(t[1][0],t[1][1]);stream.lineEnd();stream.lineStart();stream.point(t[0][0],t[0][1],3)}}}if(v&&(!point0||!pointEqual(point0,point1))){stream.point(point1[0],point1[1])}point0=point1,v0=v,c0=c},lineEnd:function lineEnd(){if(v0)stream.lineEnd();point0=null},clean:function clean(){return _clean|(v00&&v0)<<1}}}function intersect(a,b,two){var pa=cartesian(a),pb=cartesian(b);var n1=[1,0,0],n2=cartesianCross(pa,pb),n2n2=cartesianDot(n2,n2),n1n2=n2[0],determinant=n2n2-n1n2*n1n2;if(!determinant)return!two&&a;var c1=cr*n2n2/determinant,c2=-cr*n1n2/determinant,n1xn2=cartesianCross(n1,n2),A=cartesianScale(n1,c1),B=cartesianScale(n2,c2);cartesianAddInPlace(A,B);var u=n1xn2,w=cartesianDot(A,u),uu=cartesianDot(u,u),t2=w*w-uu*(cartesianDot(A,A)-1);if(t2<0)return;var t=sqrt$2(t2),q=cartesianScale(u,(-w-t)/uu);cartesianAddInPlace(q,A);q=spherical(q);if(!two)return q;var lambda0=a[0],lambda1=b[0],phi0=a[1],phi1=b[1],z;if(lambda1<lambda0)z=lambda0,lambda0=lambda1,lambda1=z;var delta=lambda1-lambda0,polar=abs$1(delta-pi$2)<epsilon$3,meridian=polar||delta<epsilon$3;if(!polar&&phi1<phi0)z=phi0,phi0=phi1,phi1=z;if(meridian?polar?phi0+phi1>0^q[1]<(abs$1(q[0]-lambda0)<epsilon$3?phi0:phi1):phi0<=q[1]&&q[1]<=phi1:delta>pi$2^(lambda0<=q[0]&&q[0]<=lambda1)){var q1=cartesianScale(u,(-w+t)/uu);cartesianAddInPlace(q1,A);return[q,spherical(q1)]}}function code(lambda,phi){var r=smallRadius?radius:pi$2-radius,code=0;if(lambda<-r)code|=1;else if(lambda>r)code|=2;if(phi<-r)code|=4;else if(phi>r)code|=8;return code}return clip$2(visible,clipLine,interpolate,smallRadius?[0,-radius]:[-pi$2,radius-pi$2])}function clipLine(a,b,x0,y0,x1,y1){var ax=a[0],ay=a[1],bx=b[0],by=b[1],t0=0,t1=1,dx=bx-ax,dy=by-ay,r;r=x0-ax;if(!dx&&r>0)return;r/=dx;if(dx<0){if(r<t0)return;if(r<t1)t1=r}else if(dx>0){if(r>t1)return;if(r>t0)t0=r}r=x1-ax;if(!dx&&r<0)return;r/=dx;if(dx<0){if(r>t1)return;if(r>t0)t0=r}else if(dx>0){if(r<t0)return;if(r<t1)t1=r}r=y0-ay;if(!dy&&r>0)return;r/=dy;if(dy<0){if(r<t0)return;if(r<t1)t1=r}else if(dy>0){if(r>t1)return;if(r>t0)t0=r}r=y1-ay;if(!dy&&r<0)return;r/=dy;if(dy<0){if(r>t1)return;if(r>t0)t0=r}else if(dy>0){if(r<t0)return;if(r<t1)t1=r}if(t0>0)a[0]=ax+t0*dx,a[1]=ay+t0*dy;if(t1<1)b[0]=ax+t1*dx,b[1]=ay+t1*dy;return true}var clipMax=1e9,clipMin=-clipMax;function clipRectangle(x0,y0,x1,y1){function visible(x,y){return x0<=x&&x<=x1&&y0<=y&&y<=y1}function interpolate(from,to,direction,stream){var a=0,a1=0;if(from==null||(a=corner(from,direction))!==(a1=corner(to,direction))||comparePoint(from,to)<0^direction>0){do{stream.point(a===0||a===3?x0:x1,a>1?y1:y0)}while((a=(a+direction+4)%4)!==a1)}else{stream.point(to[0],to[1])}}function corner(p,direction){return abs$1(p[0]-x0)<epsilon$3?direction>0?0:3:abs$1(p[0]-x1)<epsilon$3?direction>0?2:1:abs$1(p[1]-y0)<epsilon$3?direction>0?1:0:direction>0?3:2}function compareIntersection(a,b){return comparePoint(a.x,b.x)}function comparePoint(a,b){var ca=corner(a,1),cb=corner(b,1);return ca!==cb?ca-cb:ca===0?b[1]-a[1]:ca===1?a[0]-b[0]:ca===2?a[1]-b[1]:b[0]-a[0]}return function(stream){var activeStream=stream,bufferStream=clipBuffer(),segments,polygon,ring,x__,y__,v__,x_,y_,v_,first,clean;var clipStream={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:polygonStart,polygonEnd:polygonEnd};function point(x,y){if(visible(x,y))activeStream.point(x,y)}function polygonInside(){var winding=0;for(var i=0,n=polygon.length;i<n;++i){for(var ring=polygon[i],j=1,m=ring.length,point=ring[0],a0,a1,b0=point[0],b1=point[1];j<m;++j){a0=b0,a1=b1,point=ring[j],b0=point[0],b1=point[1];if(a1<=y1){if(b1>y1&&(b0-a0)*(y1-a1)>(b1-a1)*(x0-a0))++winding}else{if(b1<=y1&&(b0-a0)*(y1-a1)<(b1-a1)*(x0-a0))--winding}}}return winding}function polygonStart(){activeStream=bufferStream,segments=[],polygon=[],clean=true}function polygonEnd(){var startInside=polygonInside(),cleanInside=clean&&startInside,visible=(segments=merge$1(segments)).length;if(cleanInside||visible){stream.polygonStart();if(cleanInside){stream.lineStart();interpolate(null,null,1,stream);stream.lineEnd()}if(visible){clipRejoin(segments,compareIntersection,startInside,interpolate,stream)}stream.polygonEnd()}activeStream=stream,segments=polygon=ring=null}function lineStart(){clipStream.point=linePoint;if(polygon)polygon.push(ring=[]);first=true;v_=false;x_=y_=NaN}function lineEnd(){if(segments){linePoint(x__,y__);if(v__&&v_)bufferStream.rejoin();segments.push(bufferStream.result())}clipStream.point=point;if(v_)activeStream.lineEnd()}function linePoint(x,y){var v=visible(x,y);if(polygon)ring.push([x,y]);if(first){x__=x,y__=y,v__=v;first=false;if(v){activeStream.lineStart();activeStream.point(x,y)}}else{if(v&&v_)activeStream.point(x,y);else{var a=[x_=Math.max(clipMin,Math.min(clipMax,x_)),y_=Math.max(clipMin,Math.min(clipMax,y_))],b=[x=Math.max(clipMin,Math.min(clipMax,x)),y=Math.max(clipMin,Math.min(clipMax,y))];if(clipLine(a,b,x0,y0,x1,y1)){if(!v_){activeStream.lineStart();activeStream.point(a[0],a[1])}activeStream.point(b[0],b[1]);if(!v)activeStream.lineEnd();clean=false}else if(v){activeStream.lineStart();activeStream.point(x,y);clean=false}}}x_=x,y_=y,v_=v}return clipStream}}function graticuleX(y0,y1,dy){var y=range$1(y0,y1-epsilon$3,dy).concat(y1);return function(x){return y.map((function(y){return[x,y]}))}}function graticuleY(x0,x1,dx){var x=range$1(x0,x1-epsilon$3,dx).concat(x1);return function(y){return x.map((function(x){return[x,y]}))}}function graticule(){var x1,x0,X1,X0,y1,y0,Y1,Y0,dx=10,dy=dx,DX=90,DY=360,x,y,X,Y,precision=2.5;function graticule(){return{type:"MultiLineString",coordinates:lines()}}function lines(){return range$1(ceil(X0/DX)*DX,X1,DX).map(X).concat(range$1(ceil(Y0/DY)*DY,Y1,DY).map(Y)).concat(range$1(ceil(x0/dx)*dx,x1,dx).filter((function(x){return abs$1(x%DX)>epsilon$3})).map(x)).concat(range$1(ceil(y0/dy)*dy,y1,dy).filter((function(y){return abs$1(y%DY)>epsilon$3})).map(y))}graticule.lines=function(){return lines().map((function(coordinates){return{type:"LineString",coordinates:coordinates}}))};graticule.outline=function(){return{type:"Polygon",coordinates:[X(X0).concat(Y(Y1).slice(1),X(X1).reverse().slice(1),Y(Y0).reverse().slice(1))]}};graticule.extent=function(_){if(!arguments.length)return graticule.extentMinor();return graticule.extentMajor(_).extentMinor(_)};graticule.extentMajor=function(_){if(!arguments.length)return[[X0,Y0],[X1,Y1]];X0=+_[0][0],X1=+_[1][0];Y0=+_[0][1],Y1=+_[1][1];if(X0>X1)_=X0,X0=X1,X1=_;if(Y0>Y1)_=Y0,Y0=Y1,Y1=_;return graticule.precision(precision)};graticule.extentMinor=function(_){if(!arguments.length)return[[x0,y0],[x1,y1]];x0=+_[0][0],x1=+_[1][0];y0=+_[0][1],y1=+_[1][1];if(x0>x1)_=x0,x0=x1,x1=_;if(y0>y1)_=y0,y0=y1,y1=_;return graticule.precision(precision)};graticule.step=function(_){if(!arguments.length)return graticule.stepMinor();return graticule.stepMajor(_).stepMinor(_)};graticule.stepMajor=function(_){if(!arguments.length)return[DX,DY];DX=+_[0],DY=+_[1];return graticule};graticule.stepMinor=function(_){if(!arguments.length)return[dx,dy];dx=+_[0],dy=+_[1];return graticule};graticule.precision=function(_){if(!arguments.length)return precision;precision=+_;x=graticuleX(y0,y1,90);y=graticuleY(x0,x1,precision);X=graticuleX(Y0,Y1,90);Y=graticuleY(X0,X1,precision);return graticule};return graticule.extentMajor([[-180,-90+epsilon$3],[180,90-epsilon$3]]).extentMinor([[-180,-80-epsilon$3],[180,80+epsilon$3]])}var identity$6=function(x){return x};var areaSum$1=new Adder,areaRingSum$1=new Adder,x00,y00,x0$1,y0$1;var areaStream$1={point:noop$2,lineStart:noop$2,lineEnd:noop$2,polygonStart:function polygonStart(){areaStream$1.lineStart=areaRingStart$1;areaStream$1.lineEnd=areaRingEnd$1},polygonEnd:function polygonEnd(){areaStream$1.lineStart=areaStream$1.lineEnd=areaStream$1.point=noop$2;areaSum$1.add(abs$1(areaRingSum$1));areaRingSum$1=new Adder},result:function result(){var area=areaSum$1/2;areaSum$1=new Adder;return area}};function areaRingStart$1(){areaStream$1.point=areaPointFirst$1}function areaPointFirst$1(x,y){areaStream$1.point=areaPoint$1;x00=x0$1=x,y00=y0$1=y}function areaPoint$1(x,y){areaRingSum$1.add(y0$1*x-x0$1*y);x0$1=x,y0$1=y}function areaRingEnd$1(){areaPoint$1(x00,y00)}var x0$2=Infinity,y0$2=x0$2,x1=-x0$2,y1=x1;var boundsStream$1={point:boundsPoint$1,lineStart:noop$2,lineEnd:noop$2,polygonStart:noop$2,polygonEnd:noop$2,result:function result(){var bounds=[[x0$2,y0$2],[x1,y1]];x1=y1=-(y0$2=x0$2=Infinity);return bounds}};function boundsPoint$1(x,y){if(x<x0$2)x0$2=x;if(x>x1)x1=x;if(y<y0$2)y0$2=y;if(y>y1)y1=y}var X0$1=0,Y0$1=0,Z0$1=0,X1$1=0,Y1$1=0,Z1$1=0,X2$1=0,Y2$1=0,Z2$1=0,x00$1,y00$1,x0$3,y0$3;var centroidStream$1={point:centroidPoint$1,lineStart:centroidLineStart$1,lineEnd:centroidLineEnd$1,polygonStart:function polygonStart(){centroidStream$1.lineStart=centroidRingStart$1;centroidStream$1.lineEnd=centroidRingEnd$1},polygonEnd:function polygonEnd(){centroidStream$1.point=centroidPoint$1;centroidStream$1.lineStart=centroidLineStart$1;centroidStream$1.lineEnd=centroidLineEnd$1},result:function result(){var centroid=Z2$1?[X2$1/Z2$1,Y2$1/Z2$1]:Z1$1?[X1$1/Z1$1,Y1$1/Z1$1]:Z0$1?[X0$1/Z0$1,Y0$1/Z0$1]:[NaN,NaN];X0$1=Y0$1=Z0$1=X1$1=Y1$1=Z1$1=X2$1=Y2$1=Z2$1=0;return centroid}};function centroidPoint$1(x,y){X0$1+=x;Y0$1+=y;++Z0$1}function centroidLineStart$1(){centroidStream$1.point=centroidPointFirstLine}function centroidPointFirstLine(x,y){centroidStream$1.point=centroidPointLine;centroidPoint$1(x0$3=x,y0$3=y)}function centroidPointLine(x,y){var dx=x-x0$3,dy=y-y0$3,z=sqrt$2(dx*dx+dy*dy);X1$1+=z*(x0$3+x)/2;Y1$1+=z*(y0$3+y)/2;Z1$1+=z;centroidPoint$1(x0$3=x,y0$3=y)}function centroidLineEnd$1(){centroidStream$1.point=centroidPoint$1}function centroidRingStart$1(){centroidStream$1.point=centroidPointFirstRing}function centroidRingEnd$1(){centroidPointRing(x00$1,y00$1)}function centroidPointFirstRing(x,y){centroidStream$1.point=centroidPointRing;centroidPoint$1(x00$1=x0$3=x,y00$1=y0$3=y)}function centroidPointRing(x,y){var dx=x-x0$3,dy=y-y0$3,z=sqrt$2(dx*dx+dy*dy);X1$1+=z*(x0$3+x)/2;Y1$1+=z*(y0$3+y)/2;Z1$1+=z;z=y0$3*x-x0$3*y;X2$1+=z*(x0$3+x);Y2$1+=z*(y0$3+y);Z2$1+=z*3;centroidPoint$1(x0$3=x,y0$3=y)}function PathContext(context){this._context=context}PathContext.prototype={_radius:4.5,pointRadius:function pointRadius(_){return this._radius=_,this},polygonStart:function polygonStart(){this._line=0},polygonEnd:function polygonEnd(){this._line=NaN},lineStart:function lineStart(){this._point=0},lineEnd:function lineEnd(){if(this._line===0)this._context.closePath();this._point=NaN},point:function point(x,y){switch(this._point){case 0:{this._context.moveTo(x,y);this._point=1;break}case 1:{this._context.lineTo(x,y);break}default:{this._context.moveTo(x+this._radius,y);this._context.arc(x,y,this._radius,0,tau$2);break}}},result:noop$2};var lengthSum=new Adder,lengthRing,x00$2,y00$2,x0$4,y0$4;var lengthStream={point:noop$2,lineStart:function lineStart(){lengthStream.point=lengthPointFirst},lineEnd:function lineEnd(){if(lengthRing)lengthPoint(x00$2,y00$2);lengthStream.point=noop$2},polygonStart:function polygonStart(){lengthRing=true},polygonEnd:function polygonEnd(){lengthRing=null},result:function result(){var length=+lengthSum;lengthSum=new Adder;return length}};function lengthPointFirst(x,y){lengthStream.point=lengthPoint;x00$2=x0$4=x,y00$2=y0$4=y}function lengthPoint(x,y){x0$4-=x,y0$4-=y;lengthSum.add(sqrt$2(x0$4*x0$4+y0$4*y0$4));x0$4=x,y0$4=y}function PathString(){this._string=[]}PathString.prototype={_radius:4.5,_circle:circle$1(4.5),pointRadius:function pointRadius(_){if((_=+_)!==this._radius)this._radius=_,this._circle=null;return this},polygonStart:function polygonStart(){this._line=0},polygonEnd:function polygonEnd(){this._line=NaN},lineStart:function lineStart(){this._point=0},lineEnd:function lineEnd(){if(this._line===0)this._string.push("Z");this._point=NaN},point:function point(x,y){switch(this._point){case 0:{this._string.push("M",x,",",y);this._point=1;break}case 1:{this._string.push("L",x,",",y);break}default:{if(this._circle==null)this._circle=circle$1(this._radius);this._string.push("M",x,",",y,this._circle);break}}},result:function result(){if(this._string.length){var result=this._string.join("");this._string=[];return result}else{return null}}};function circle$1(radius){return"m0,"+radius+"a"+radius+","+radius+" 0 1,1 0,"+-2*radius+"a"+radius+","+radius+" 0 1,1 0,"+2*radius+"z"}function geoPath(projection,context){var pointRadius=4.5,projectionStream,contextStream;function path(object){if(object){if(typeof pointRadius==="function")contextStream.pointRadius(+pointRadius.apply(this,arguments));geoStream(object,projectionStream(contextStream))}return contextStream.result()}path.area=function(object){geoStream(object,projectionStream(areaStream$1));return areaStream$1.result()};path.measure=function(object){geoStream(object,projectionStream(lengthStream));return lengthStream.result()};path.bounds=function(object){geoStream(object,projectionStream(boundsStream$1));return boundsStream$1.result()};path.centroid=function(object){geoStream(object,projectionStream(centroidStream$1));return centroidStream$1.result()};path.projection=function(_){return arguments.length?(projectionStream=_==null?(projection=null,identity$6):(projection=_).stream,path):projection};path.context=function(_){if(!arguments.length)return context;contextStream=_==null?(context=null,new PathString):new PathContext(context=_);if(typeof pointRadius!=="function")contextStream.pointRadius(pointRadius);return path};path.pointRadius=function(_){if(!arguments.length)return pointRadius;pointRadius=typeof _==="function"?_:(contextStream.pointRadius(+_),+_);return path};return path.projection(projection).context(context)}function transformer$3(methods){return function(stream){var s=new TransformStream;for(var key in methods){s[key]=methods[key]}s.stream=stream;return s}}function TransformStream(){}TransformStream.prototype={constructor:TransformStream,point:function point(x,y){this.stream.point(x,y)},sphere:function sphere(){this.stream.sphere()},lineStart:function lineStart(){this.stream.lineStart()},lineEnd:function lineEnd(){this.stream.lineEnd()},polygonStart:function polygonStart(){this.stream.polygonStart()},polygonEnd:function polygonEnd(){this.stream.polygonEnd()}};function fit(projection,fitBounds,object){var clip=projection.clipExtent&&projection.clipExtent();projection.scale(150).translate([0,0]);if(clip!=null)projection.clipExtent(null);geoStream(object,projection.stream(boundsStream$1));fitBounds(boundsStream$1.result());if(clip!=null)projection.clipExtent(clip);return projection}function fitExtent(projection,extent,object){return fit(projection,(function(b){var w=extent[1][0]-extent[0][0],h=extent[1][1]-extent[0][1],k=Math.min(w/(b[1][0]-b[0][0]),h/(b[1][1]-b[0][1])),x=+extent[0][0]+(w-k*(b[1][0]+b[0][0]))/2,y=+extent[0][1]+(h-k*(b[1][1]+b[0][1]))/2;projection.scale(150*k).translate([x,y])}),object)}function fitSize(projection,size,object){return fitExtent(projection,[[0,0],size],object)}function fitWidth(projection,width,object){return fit(projection,(function(b){var w=+width,k=w/(b[1][0]-b[0][0]),x=(w-k*(b[1][0]+b[0][0]))/2,y=-k*b[0][1];projection.scale(150*k).translate([x,y])}),object)}function fitHeight(projection,height,object){return fit(projection,(function(b){var h=+height,k=h/(b[1][1]-b[0][1]),x=-k*b[0][0],y=(h-k*(b[1][1]+b[0][1]))/2;projection.scale(150*k).translate([x,y])}),object)}var maxDepth=16,cosMinDistance=cos$1(30*radians$1);function resample(project,delta2){return+delta2?resample$1(project,delta2):resampleNone(project)}function resampleNone(project){return transformer$3({point:function point(x,y){x=project(x,y);this.stream.point(x[0],x[1])}})}function resample$1(project,delta2){function resampleLineTo(x0,y0,lambda0,a0,b0,c0,x1,y1,lambda1,a1,b1,c1,depth,stream){var dx=x1-x0,dy=y1-y0,d2=dx*dx+dy*dy;if(d2>4*delta2&&depth--){var a=a0+a1,b=b0+b1,c=c0+c1,m=sqrt$2(a*a+b*b+c*c),phi2=asin$1(c/=m),lambda2=abs$1(abs$1(c)-1)<epsilon$3||abs$1(lambda0-lambda1)<epsilon$3?(lambda0+lambda1)/2:atan2$1(b,a),p=project(lambda2,phi2),x2=p[0],y2=p[1],dx2=x2-x0,dy2=y2-y0,dz=dy*dx2-dx*dy2;if(dz*dz/d2>delta2||abs$1((dx*dx2+dy*dy2)/d2-.5)>.3||a0*a1+b0*b1+c0*c1<cosMinDistance){resampleLineTo(x0,y0,lambda0,a0,b0,c0,x2,y2,lambda2,a/=m,b/=m,c,depth,stream);stream.point(x2,y2);resampleLineTo(x2,y2,lambda2,a,b,c,x1,y1,lambda1,a1,b1,c1,depth,stream)}}}return function(stream){var lambda00,x00,y00,a00,b00,c00,lambda0,x0,y0,a0,b0,c0;var resampleStream={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function polygonStart(){stream.polygonStart();resampleStream.lineStart=ringStart},polygonEnd:function polygonEnd(){stream.polygonEnd();resampleStream.lineStart=lineStart}};function point(x,y){x=project(x,y);stream.point(x[0],x[1])}function lineStart(){x0=NaN;resampleStream.point=linePoint;stream.lineStart()}function linePoint(lambda,phi){var c=cartesian([lambda,phi]),p=project(lambda,phi);resampleLineTo(x0,y0,lambda0,a0,b0,c0,x0=p[0],y0=p[1],lambda0=lambda,a0=c[0],b0=c[1],c0=c[2],maxDepth,stream);stream.point(x0,y0)}function lineEnd(){resampleStream.point=point;stream.lineEnd()}function ringStart(){lineStart();resampleStream.point=ringPoint;resampleStream.lineEnd=ringEnd}function ringPoint(lambda,phi){linePoint(lambda00=lambda,phi),x00=x0,y00=y0,a00=a0,b00=b0,c00=c0;resampleStream.point=linePoint}function ringEnd(){resampleLineTo(x0,y0,lambda0,a0,b0,c0,x00,y00,lambda00,a00,b00,c00,maxDepth,stream);resampleStream.lineEnd=lineEnd;lineEnd()}return resampleStream}}var transformRadians=transformer$3({point:function point(x,y){this.stream.point(x*radians$1,y*radians$1)}});function transformRotate(rotate){return transformer$3({point:function point(x,y){var r=rotate(x,y);return this.stream.point(r[0],r[1])}})}function scaleTranslate(k,dx,dy,sx,sy){function transform(x,y){x*=sx;y*=sy;return[dx+k*x,dy-k*y]}transform.invert=function(x,y){return[(x-dx)/k*sx,(dy-y)/k*sy]};return transform}function scaleTranslateRotate(k,dx,dy,sx,sy,alpha){if(!alpha)return scaleTranslate(k,dx,dy,sx,sy);var cosAlpha=cos$1(alpha),sinAlpha=sin$1(alpha),a=cosAlpha*k,b=sinAlpha*k,ai=cosAlpha/k,bi=sinAlpha/k,ci=(sinAlpha*dy-cosAlpha*dx)/k,fi=(sinAlpha*dx+cosAlpha*dy)/k;function transform(x,y){x*=sx;y*=sy;return[a*x-b*y+dx,dy-b*x-a*y]}transform.invert=function(x,y){return[sx*(ai*x-bi*y+ci),sy*(fi-bi*x-ai*y)]};return transform}function projection(project){return projectionMutator((function(){return project}))()}function projectionMutator(projectAt){var project,k=150,x=480,y=250,lambda=0,phi=0,deltaLambda=0,deltaPhi=0,deltaGamma=0,rotate,alpha=0,sx=1,sy=1,theta=null,preclip=clipAntimeridian,x0=null,y0,x1,y1,postclip=identity$6,delta2=.5,projectResample,projectTransform,projectRotateTransform,cache,cacheStream;function projection(point){return projectRotateTransform(point[0]*radians$1,point[1]*radians$1)}function invert(point){point=projectRotateTransform.invert(point[0],point[1]);return point&&[point[0]*degrees$2,point[1]*degrees$2]}projection.stream=function(stream){return cache&&cacheStream===stream?cache:cache=transformRadians(transformRotate(rotate)(preclip(projectResample(postclip(cacheStream=stream)))))};projection.preclip=function(_){return arguments.length?(preclip=_,theta=undefined,reset()):preclip};projection.postclip=function(_){return arguments.length?(postclip=_,x0=y0=x1=y1=null,reset()):postclip};projection.clipAngle=function(_){return arguments.length?(preclip=+_?clipCircle(theta=_*radians$1):(theta=null,clipAntimeridian),reset()):theta*degrees$2};projection.clipExtent=function(_){return arguments.length?(postclip=_==null?(x0=y0=x1=y1=null,identity$6):clipRectangle(x0=+_[0][0],y0=+_[0][1],x1=+_[1][0],y1=+_[1][1]),reset()):x0==null?null:[[x0,y0],[x1,y1]]};projection.scale=function(_){return arguments.length?(k=+_,recenter()):k};projection.translate=function(_){return arguments.length?(x=+_[0],y=+_[1],recenter()):[x,y]};projection.center=function(_){return arguments.length?(lambda=_[0]%360*radians$1,phi=_[1]%360*radians$1,recenter()):[lambda*degrees$2,phi*degrees$2]};projection.rotate=function(_){return arguments.length?(deltaLambda=_[0]%360*radians$1,deltaPhi=_[1]%360*radians$1,deltaGamma=_.length>2?_[2]%360*radians$1:0,recenter()):[deltaLambda*degrees$2,deltaPhi*degrees$2,deltaGamma*degrees$2]};projection.angle=function(_){return arguments.length?(alpha=_%360*radians$1,recenter()):alpha*degrees$2};projection.reflectX=function(_){return arguments.length?(sx=_?-1:1,recenter()):sx<0};projection.reflectY=function(_){return arguments.length?(sy=_?-1:1,recenter()):sy<0};projection.precision=function(_){return arguments.length?(projectResample=resample(projectTransform,delta2=_*_),reset()):sqrt$2(delta2)};projection.fitExtent=function(extent,object){return fitExtent(projection,extent,object)};projection.fitSize=function(size,object){return fitSize(projection,size,object)};projection.fitWidth=function(width,object){return fitWidth(projection,width,object)};projection.fitHeight=function(height,object){return fitHeight(projection,height,object)};function recenter(){var center=scaleTranslateRotate(k,0,0,sx,sy,alpha).apply(null,project(lambda,phi)),transform=scaleTranslateRotate(k,x-center[0],y-center[1],sx,sy,alpha);rotate=rotateRadians(deltaLambda,deltaPhi,deltaGamma);projectTransform=compose(project,transform);projectRotateTransform=compose(rotate,projectTransform);projectResample=resample(projectTransform,delta2);return reset()}function reset(){cache=cacheStream=null;return projection}return function(){project=projectAt.apply(this,arguments);projection.invert=project.invert&&invert;return recenter()}}function conicProjection(projectAt){var phi0=0,phi1=pi$2/3,m=projectionMutator(projectAt),p=m(phi0,phi1);p.parallels=function(_){return arguments.length?m(phi0=_[0]*radians$1,phi1=_[1]*radians$1):[phi0*degrees$2,phi1*degrees$2]};return p}function cylindricalEqualAreaRaw(phi0){var cosPhi0=cos$1(phi0);function forward(lambda,phi){return[lambda*cosPhi0,sin$1(phi)/cosPhi0]}forward.invert=function(x,y){return[x/cosPhi0,asin$1(y*cosPhi0)]};return forward}function conicEqualAreaRaw(y0,y1){var sy0=sin$1(y0),n=(sy0+sin$1(y1))/2;if(abs$1(n)<epsilon$3)return cylindricalEqualAreaRaw(y0);var c=1+sy0*(2*n-sy0),r0=sqrt$2(c)/n;function project(x,y){var r=sqrt$2(c-2*n*sin$1(y))/n;return[r*sin$1(x*=n),r0-r*cos$1(x)]}project.invert=function(x,y){var r0y=r0-y,l=atan2$1(x,abs$1(r0y))*sign$1(r0y);if(r0y*n<0)l-=pi$2*sign$1(x)*sign$1(r0y);return[l/n,asin$1((c-(x*x+r0y*r0y)*n*n)/(2*n))]};return project}function geoConicEqualArea(){return conicProjection(conicEqualAreaRaw).scale(155.424).center([0,33.6442])}function geoAlbers(){return geoConicEqualArea().parallels([29.5,45.5]).scale(1070).translate([480,250]).rotate([96,0]).center([-.6,38.7])}function multiplex(streams){var n=streams.length;return{point:function point(x,y){var i=-1;while(++i<n){streams[i].point(x,y)}},sphere:function sphere(){var i=-1;while(++i<n){streams[i].sphere()}},lineStart:function lineStart(){var i=-1;while(++i<n){streams[i].lineStart()}},lineEnd:function lineEnd(){var i=-1;while(++i<n){streams[i].lineEnd()}},polygonStart:function polygonStart(){var i=-1;while(++i<n){streams[i].polygonStart()}},polygonEnd:function polygonEnd(){var i=-1;while(++i<n){streams[i].polygonEnd()}}}}function geoAlbersUsa(){var cache,cacheStream,lower48=geoAlbers(),lower48Point,alaska=geoConicEqualArea().rotate([154,0]).center([-2,58.5]).parallels([55,65]),alaskaPoint,hawaii=geoConicEqualArea().rotate([157,0]).center([-3,19.9]).parallels([8,18]),hawaiiPoint,_point,pointStream={point:function point(x,y){_point=[x,y]}};function albersUsa(coordinates){var x=coordinates[0],y=coordinates[1];return _point=null,(lower48Point.point(x,y),_point)||(alaskaPoint.point(x,y),_point)||(hawaiiPoint.point(x,y),_point)}albersUsa.invert=function(coordinates){var k=lower48.scale(),t=lower48.translate(),x=(coordinates[0]-t[0])/k,y=(coordinates[1]-t[1])/k;return(y>=.12&&y<.234&&x>=-.425&&x<-.214?alaska:y>=.166&&y<.234&&x>=-.214&&x<-.115?hawaii:lower48).invert(coordinates)};albersUsa.stream=function(stream){return cache&&cacheStream===stream?cache:cache=multiplex([lower48.stream(cacheStream=stream),alaska.stream(stream),hawaii.stream(stream)])};albersUsa.precision=function(_){if(!arguments.length)return lower48.precision();lower48.precision(_),alaska.precision(_),hawaii.precision(_);return reset()};albersUsa.scale=function(_){if(!arguments.length)return lower48.scale();lower48.scale(_),alaska.scale(_*.35),hawaii.scale(_);return albersUsa.translate(lower48.translate())};albersUsa.translate=function(_){if(!arguments.length)return lower48.translate();var k=lower48.scale(),x=+_[0],y=+_[1];lower48Point=lower48.translate(_).clipExtent([[x-.455*k,y-.238*k],[x+.455*k,y+.238*k]]).stream(pointStream);alaskaPoint=alaska.translate([x-.307*k,y+.201*k]).clipExtent([[x-.425*k+epsilon$3,y+.12*k+epsilon$3],[x-.214*k-epsilon$3,y+.234*k-epsilon$3]]).stream(pointStream);hawaiiPoint=hawaii.translate([x-.205*k,y+.212*k]).clipExtent([[x-.214*k+epsilon$3,y+.166*k+epsilon$3],[x-.115*k-epsilon$3,y+.234*k-epsilon$3]]).stream(pointStream);return reset()};albersUsa.fitExtent=function(extent,object){return fitExtent(albersUsa,extent,object)};albersUsa.fitSize=function(size,object){return fitSize(albersUsa,size,object)};albersUsa.fitWidth=function(width,object){return fitWidth(albersUsa,width,object)};albersUsa.fitHeight=function(height,object){return fitHeight(albersUsa,height,object)};function reset(){cache=cacheStream=null;return albersUsa}return albersUsa.scale(1070)}function azimuthalRaw(scale){return function(x,y){var cx=cos$1(x),cy=cos$1(y),k=scale(cx*cy);if(k===Infinity)return[2,0];return[k*cy*sin$1(x),k*sin$1(y)]}}function azimuthalInvert(angle){return function(x,y){var z=sqrt$2(x*x+y*y),c=angle(z),sc=sin$1(c),cc=cos$1(c);return[atan2$1(x*sc,z*cc),asin$1(z&&y*sc/z)]}}var azimuthalEqualAreaRaw=azimuthalRaw((function(cxcy){return sqrt$2(2/(1+cxcy))}));azimuthalEqualAreaRaw.invert=azimuthalInvert((function(z){return 2*asin$1(z/2)}));function geoAzimuthalEqualArea(){return projection(azimuthalEqualAreaRaw).scale(124.75).clipAngle(180-.001)}var azimuthalEquidistantRaw=azimuthalRaw((function(c){return(c=acos$1(c))&&c/sin$1(c)}));azimuthalEquidistantRaw.invert=azimuthalInvert((function(z){return z}));function geoAzimuthalEquidistant(){return projection(azimuthalEquidistantRaw).scale(79.4188).clipAngle(180-.001)}function mercatorRaw(lambda,phi){return[lambda,log$4(tan((halfPi$1+phi)/2))]}mercatorRaw.invert=function(x,y){return[x,2*atan(exp$2(y))-halfPi$1]};function geoMercator(){return mercatorProjection(mercatorRaw).scale(961/tau$2)}function mercatorProjection(project){var m=projection(project),center=m.center,scale=m.scale,translate=m.translate,clipExtent=m.clipExtent,x0=null,y0,x1,y1;m.scale=function(_){return arguments.length?(scale(_),reclip()):scale()};m.translate=function(_){return arguments.length?(translate(_),reclip()):translate()};m.center=function(_){return arguments.length?(center(_),reclip()):center()};m.clipExtent=function(_){return arguments.length?(_==null?x0=y0=x1=y1=null:(x0=+_[0][0],y0=+_[0][1],x1=+_[1][0],y1=+_[1][1]),reclip()):x0==null?null:[[x0,y0],[x1,y1]]};function reclip(){var k=pi$2*scale(),t=m(rotation(m.rotate()).invert([0,0]));return clipExtent(x0==null?[[t[0]-k,t[1]-k],[t[0]+k,t[1]+k]]:project===mercatorRaw?[[Math.max(t[0]-k,x0),y0],[Math.min(t[0]+k,x1),y1]]:[[x0,Math.max(t[1]-k,y0)],[x1,Math.min(t[1]+k,y1)]])}return reclip()}function tany(y){return tan((halfPi$1+y)/2)}function conicConformalRaw(y0,y1){var cy0=cos$1(y0),n=y0===y1?sin$1(y0):log$4(cy0/cos$1(y1))/log$4(tany(y1)/tany(y0)),f=cy0*pow$3(tany(y0),n)/n;if(!n)return mercatorRaw;function project(x,y){if(f>0){if(y<-halfPi$1+epsilon$3)y=-halfPi$1+epsilon$3}else{if(y>halfPi$1-epsilon$3)y=halfPi$1-epsilon$3}var r=f/pow$3(tany(y),n);return[r*sin$1(n*x),f-r*cos$1(n*x)]}project.invert=function(x,y){var fy=f-y,r=sign$1(n)*sqrt$2(x*x+fy*fy),l=atan2$1(x,abs$1(fy))*sign$1(fy);if(fy*n<0)l-=pi$2*sign$1(x)*sign$1(fy);return[l/n,2*atan(pow$3(f/r,1/n))-halfPi$1]};return project}function geoConicConformal(){return conicProjection(conicConformalRaw).scale(109.5).parallels([30,30])}function equirectangularRaw(lambda,phi){return[lambda,phi]}equirectangularRaw.invert=equirectangularRaw;function geoEquirectangular(){return projection(equirectangularRaw).scale(152.63)}function conicEquidistantRaw(y0,y1){var cy0=cos$1(y0),n=y0===y1?sin$1(y0):(cy0-cos$1(y1))/(y1-y0),g=cy0/n+y0;if(abs$1(n)<epsilon$3)return equirectangularRaw;function project(x,y){var gy=g-y,nx=n*x;return[gy*sin$1(nx),g-gy*cos$1(nx)]}project.invert=function(x,y){var gy=g-y,l=atan2$1(x,abs$1(gy))*sign$1(gy);if(gy*n<0)l-=pi$2*sign$1(x)*sign$1(gy);return[l/n,g-sign$1(n)*sqrt$2(x*x+gy*gy)]};return project}function geoConicEquidistant(){return conicProjection(conicEquidistantRaw).scale(131.154).center([0,13.9389])}var A1=1.340264,A2=-.081106,A3=893e-6,A4=.003796,M=sqrt$2(3)/2,iterations=12;function equalEarthRaw(lambda,phi){var l=asin$1(M*sin$1(phi)),l2=l*l,l6=l2*l2*l2;return[lambda*cos$1(l)/(M*(A1+3*A2*l2+l6*(7*A3+9*A4*l2))),l*(A1+A2*l2+l6*(A3+A4*l2))]}equalEarthRaw.invert=function(x,y){var l=y,l2=l*l,l6=l2*l2*l2;for(var i=0,delta,fy,fpy;i<iterations;++i){fy=l*(A1+A2*l2+l6*(A3+A4*l2))-y;fpy=A1+3*A2*l2+l6*(7*A3+9*A4*l2);l-=delta=fy/fpy,l2=l*l,l6=l2*l2*l2;if(abs$1(delta)<epsilon2$1)break}return[M*x*(A1+3*A2*l2+l6*(7*A3+9*A4*l2))/cos$1(l),asin$1(sin$1(l)/M)]};function geoEqualEarth(){return projection(equalEarthRaw).scale(177.158)}function gnomonicRaw(x,y){var cy=cos$1(y),k=cos$1(x)*cy;return[cy*sin$1(x)/k,sin$1(y)/k]}gnomonicRaw.invert=azimuthalInvert(atan);function geoGnomonic(){return projection(gnomonicRaw).scale(144.049).clipAngle(60)}function geoIdentity(){var k=1,tx=0,ty=0,sx=1,sy=1,alpha=0,ca,sa,x0=null,y0,x1,y1,kx=1,ky=1,transform=transformer$3({point:function point(x,y){var p=projection([x,y]);this.stream.point(p[0],p[1])}}),postclip=identity$6,cache,cacheStream;function reset(){kx=k*sx;ky=k*sy;cache=cacheStream=null;return projection}function projection(p){var x=p[0]*kx,y=p[1]*ky;if(alpha){var t=y*ca-x*sa;x=x*ca+y*sa;y=t}return[x+tx,y+ty]}projection.invert=function(p){var x=p[0]-tx,y=p[1]-ty;if(alpha){var t=y*ca+x*sa;x=x*ca-y*sa;y=t}return[x/kx,y/ky]};projection.stream=function(stream){return cache&&cacheStream===stream?cache:cache=transform(postclip(cacheStream=stream))};projection.postclip=function(_){return arguments.length?(postclip=_,x0=y0=x1=y1=null,reset()):postclip};projection.clipExtent=function(_){return arguments.length?(postclip=_==null?(x0=y0=x1=y1=null,identity$6):clipRectangle(x0=+_[0][0],y0=+_[0][1],x1=+_[1][0],y1=+_[1][1]),reset()):x0==null?null:[[x0,y0],[x1,y1]]};projection.scale=function(_){return arguments.length?(k=+_,reset()):k};projection.translate=function(_){return arguments.length?(tx=+_[0],ty=+_[1],reset()):[tx,ty]};projection.angle=function(_){return arguments.length?(alpha=_%360*radians$1,sa=sin$1(alpha),ca=cos$1(alpha),reset()):alpha*degrees$2};projection.reflectX=function(_){return arguments.length?(sx=_?-1:1,reset()):sx<0};projection.reflectY=function(_){return arguments.length?(sy=_?-1:1,reset()):sy<0};projection.fitExtent=function(extent,object){return fitExtent(projection,extent,object)};projection.fitSize=function(size,object){return fitSize(projection,size,object)};projection.fitWidth=function(width,object){return fitWidth(projection,width,object)};projection.fitHeight=function(height,object){return fitHeight(projection,height,object)};return projection}function naturalEarth1Raw(lambda,phi){var phi2=phi*phi,phi4=phi2*phi2;return[lambda*(.8707-.131979*phi2+phi4*(-.013791+phi4*(.003971*phi2-.001529*phi4))),phi*(1.007226+phi2*(.015085+phi4*(-.044475+.028874*phi2-.005916*phi4)))]}naturalEarth1Raw.invert=function(x,y){var phi=y,i=25,delta;do{var phi2=phi*phi,phi4=phi2*phi2;phi-=delta=(phi*(1.007226+phi2*(.015085+phi4*(-.044475+.028874*phi2-.005916*phi4)))-y)/(1.007226+phi2*(.015085*3+phi4*(-.044475*7+.028874*9*phi2-.005916*11*phi4)))}while(abs$1(delta)>epsilon$3&&--i>0);return[x/(.8707+(phi2=phi*phi)*(-.131979+phi2*(-.013791+phi2*phi2*phi2*(.003971-.001529*phi2)))),phi]};function geoNaturalEarth1(){return projection(naturalEarth1Raw).scale(175.295)}function orthographicRaw(x,y){return[cos$1(y)*sin$1(x),sin$1(y)]}orthographicRaw.invert=azimuthalInvert(asin$1);function geoOrthographic(){return projection(orthographicRaw).scale(249.5).clipAngle(90+epsilon$3)}function stereographicRaw(x,y){var cy=cos$1(y),k=1+cos$1(x)*cy;return[cy*sin$1(x)/k,sin$1(y)/k]}stereographicRaw.invert=azimuthalInvert((function(z){return 2*atan(z)}));function geoStereographic(){return projection(stereographicRaw).scale(250).clipAngle(142)}function transverseMercatorRaw(lambda,phi){return[log$4(tan((halfPi$1+phi)/2)),-lambda]}transverseMercatorRaw.invert=function(x,y){return[-y,2*atan(exp$2(x))-halfPi$1]};function geoTransverseMercator(){var m=mercatorProjection(transverseMercatorRaw),center=m.center,rotate=m.rotate;m.center=function(_){return arguments.length?center([-_[1],_[0]]):(_=center(),[_[1],-_[0]])};m.rotate=function(_){return arguments.length?rotate([_[0],_[1],_.length>2?_[2]+90:90]):(_=rotate(),[_[0],_[1],_[2]-90])};return rotate([0,0,90]).scale(159.155)}var abs$2=Math.abs;var cos$2=Math.cos;var sin$2=Math.sin;var epsilon$4=1e-6;var pi$3=Math.PI;var halfPi$2=pi$3/2;var sqrt2=sqrt$3(2);function asin$2(x){return x>1?halfPi$2:x<-1?-halfPi$2:Math.asin(x)}function sqrt$3(x){return x>0?Math.sqrt(x):0}function mollweideBromleyTheta(cp,phi){var cpsinPhi=cp*sin$2(phi),i=30,delta;do{phi-=delta=(phi+sin$2(phi)-cpsinPhi)/(1+cos$2(phi))}while(abs$2(delta)>epsilon$4&&--i>0);return phi/2}function mollweideBromleyRaw(cx,cy,cp){function forward(lambda,phi){return[cx*lambda*cos$2(phi=mollweideBromleyTheta(cp,phi)),cy*sin$2(phi)]}forward.invert=function(x,y){return y=asin$2(y/cy),[x/(cx*cos$2(y)),asin$2((2*y+sin$2(2*y))/cp)]};return forward}var mollweideRaw=mollweideBromleyRaw(sqrt2/halfPi$2,sqrt2,pi$3);function geoMollweide(){return projection(mollweideRaw).scale(169.529)}var defaultPath=geoPath();var projectionProperties=["clipAngle","clipExtent","scale","translate","center","rotate","parallels","precision","reflectX","reflectY","coefficient","distance","fraction","lobes","parallel","radius","ratio","spacing","tilt"];function create$1(type,constructor){return function projection(){var p=constructor();p.type=type;p.path=geoPath().projection(p);p.copy=p.copy||function(){var c=projection();projectionProperties.forEach((function(prop){if(p[prop])c[prop](p[prop]())}));c.path.pointRadius(p.path.pointRadius());return c};return p}}function projection$1(type,proj){if(!type||typeof type!=="string"){throw new Error("Projection type must be a name string.")}type=type.toLowerCase();if(arguments.length>1){projections[type]=create$1(type,proj);return this}else{return projections[type]||null}}function getProjectionPath(proj){return proj&&proj.path||defaultPath}var projections={albers:geoAlbers,albersusa:geoAlbersUsa,azimuthalequalarea:geoAzimuthalEqualArea,azimuthalequidistant:geoAzimuthalEquidistant,conicconformal:geoConicConformal,conicequalarea:geoConicEqualArea,conicequidistant:geoConicEquidistant,equalEarth:geoEqualEarth,equirectangular:geoEquirectangular,gnomonic:geoGnomonic,identity:geoIdentity,mercator:geoMercator,mollweide:geoMollweide,naturalEarth1:geoNaturalEarth1,orthographic:geoOrthographic,stereographic:geoStereographic,transversemercator:geoTransverseMercator};for(var key$1 in projections){projection$1(key$1,projections[key$1])}function noop$3(){}var cases=[[],[[[1,1.5],[.5,1]]],[[[1.5,1],[1,1.5]]],[[[1.5,1],[.5,1]]],[[[1,.5],[1.5,1]]],[[[1,1.5],[.5,1]],[[1,.5],[1.5,1]]],[[[1,.5],[1,1.5]]],[[[1,.5],[.5,1]]],[[[.5,1],[1,.5]]],[[[1,1.5],[1,.5]]],[[[.5,1],[1,.5]],[[1.5,1],[1,1.5]]],[[[1.5,1],[1,.5]]],[[[.5,1],[1.5,1]]],[[[1,1.5],[1.5,1]]],[[[.5,1],[1,1.5]]],[]];function contours(){var dx=1,dy=1,smooth=smoothLinear;function contours(values,tz){return tz.map((function(value){return contour(values,value)}))}function contour(values,value){var polygons=[],holes=[];isorings(values,value,(function(ring){smooth(ring,values,value);if(area$3(ring)>0)polygons.push([ring]);else holes.push(ring)}));holes.forEach((function(hole){for(var i=0,n=polygons.length,polygon;i<n;++i){if(contains((polygon=polygons[i])[0],hole)!==-1){polygon.push(hole);return}}}));return{type:"MultiPolygon",value:value,coordinates:polygons}}function isorings(values,value,callback){var fragmentByStart=new Array,fragmentByEnd=new Array,x,y,t0,t1,t2,t3;x=y=-1;t1=values[0]>=value;cases[t1<<1].forEach(stitch);while(++x<dx-1){t0=t1,t1=values[x+1]>=value;cases[t0|t1<<1].forEach(stitch)}cases[t1<<0].forEach(stitch);while(++y<dy-1){x=-1;t1=values[y*dx+dx]>=value;t2=values[y*dx]>=value;cases[t1<<1|t2<<2].forEach(stitch);while(++x<dx-1){t0=t1,t1=values[y*dx+dx+x+1]>=value;t3=t2,t2=values[y*dx+x+1]>=value;cases[t0|t1<<1|t2<<2|t3<<3].forEach(stitch)}cases[t1|t2<<3].forEach(stitch)}x=-1;t2=values[y*dx]>=value;cases[t2<<2].forEach(stitch);while(++x<dx-1){t3=t2,t2=values[y*dx+x+1]>=value;cases[t2<<2|t3<<3].forEach(stitch)}cases[t2<<3].forEach(stitch);function stitch(line){var start=[line[0][0]+x,line[0][1]+y],end=[line[1][0]+x,line[1][1]+y],startIndex=index(start),endIndex=index(end),f,g;if(f=fragmentByEnd[startIndex]){if(g=fragmentByStart[endIndex]){delete fragmentByEnd[f.end];delete fragmentByStart[g.start];if(f===g){f.ring.push(end);callback(f.ring)}else{fragmentByStart[f.start]=fragmentByEnd[g.end]={start:f.start,end:g.end,ring:f.ring.concat(g.ring)}}}else{delete fragmentByEnd[f.end];f.ring.push(end);fragmentByEnd[f.end=endIndex]=f}}else if(f=fragmentByStart[endIndex]){if(g=fragmentByEnd[startIndex]){delete fragmentByStart[f.start];delete fragmentByEnd[g.end];if(f===g){f.ring.push(end);callback(f.ring)}else{fragmentByStart[g.start]=fragmentByEnd[f.end]={start:g.start,end:f.end,ring:g.ring.concat(f.ring)}}}else{delete fragmentByStart[f.start];f.ring.unshift(start);fragmentByStart[f.start=startIndex]=f}}else{fragmentByStart[startIndex]=fragmentByEnd[endIndex]={start:startIndex,end:endIndex,ring:[start,end]}}}}function index(point){return point[0]*2+point[1]*(dx+1)*4}function smoothLinear(ring,values,value){ring.forEach((function(point){var x=point[0],y=point[1],xt=x|0,yt=y|0,v0,v1=values[yt*dx+xt];if(x>0&&x<dx&&xt===x){v0=values[yt*dx+xt-1];point[0]=x+(value-v0)/(v1-v0)-.5}if(y>0&&y<dy&&yt===y){v0=values[(yt-1)*dx+xt];point[1]=y+(value-v0)/(v1-v0)-.5}}))}contours.contour=contour;contours.size=function(_){if(!arguments.length)return[dx,dy];var _0=Math.floor(_[0]),_1=Math.floor(_[1]);if(!(_0>=0&&_1>=0))error("invalid size");return dx=_0,dy=_1,contours};contours.smooth=function(_){return arguments.length?(smooth=_?smoothLinear:noop$3,contours):smooth===smoothLinear};return contours}function area$3(ring){var i=0,n=ring.length,area=ring[n-1][1]*ring[0][0]-ring[n-1][0]*ring[0][1];while(++i<n){area+=ring[i-1][1]*ring[i][0]-ring[i-1][0]*ring[i][1]}return area}function contains(ring,hole){var i=-1,n=hole.length,c;while(++i<n){if(c=ringContains(ring,hole[i]))return c}return 0}function ringContains(ring,point){var x=point[0],y=point[1],contains=-1;for(var i=0,n=ring.length,j=n-1;i<n;j=i++){var pi=ring[i],xi=pi[0],yi=pi[1],pj=ring[j],xj=pj[0],yj=pj[1];if(segmentContains(pi,pj,point))return 0;if(yi>y!==yj>y&&x<(xj-xi)*(y-yi)/(yj-yi)+xi)contains=-contains}return contains}function segmentContains(a,b,c){var i;return collinear(a,b,c)&&within(a[i=+(a[0]===b[0])],c[i],b[i])}function collinear(a,b,c){return(b[0]-a[0])*(c[1]-a[1])===(c[0]-a[0])*(b[1]-a[1])}function within(p,q,r){return p<=q&&q<=r||r<=q&&q<=p}function quantize$2(k,nice,zero){return function(values){var ex=extent(values),start=zero?Math.min(ex[0],0):ex[0],stop=ex[1],span=stop-start,step=nice?tickStep(start,stop,k):span/(k+1);return range$1(start+step,stop,step)}}function Isocontour(params){Transform.call(this,null,params)}Isocontour.Definition={type:"Isocontour",metadata:{generates:true},params:[{name:"field",type:"field"},{name:"thresholds",type:"number",array:true},{name:"levels",type:"number"},{name:"nice",type:"boolean",default:false},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"zero",type:"boolean",default:true},{name:"smooth",type:"boolean",default:true},{name:"scale",type:"number",expr:true},{name:"translate",type:"number",array:true,expr:true},{name:"as",type:"string",null:true,default:"contour"}]};inherits(Isocontour,Transform,{transform:function transform(_,pulse){if(this.value&&!pulse.changed()&&!_.modified()){return pulse.StopPropagation}var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),source=pulse.materialize(pulse.SOURCE).source,field=_.field||identity,contour=contours().smooth(_.smooth!==false),tz=_.thresholds||levels(source,field,_),as=_.as===null?null:_.as||"contour",values=[];source.forEach((function(t){var grid=field(t);var paths=contour.size([grid.width,grid.height])(grid.values,isArray(tz)?tz:tz(grid.values));transformPaths(paths,grid,t,_);paths.forEach((function(p){values.push(rederive(t,ingest(as!=null?_defineProperty({},as,p):p)))}))}));if(this.value)out.rem=this.value;this.value=out.source=out.add=values;return out}});function levels(values,f,_){var q=quantize$2(_.levels||10,_.nice,_.zero!==false);return _.resolve!=="shared"?q:q(values.map((function(t){return max(f(t).values)})))}function transformPaths(paths,grid,datum,_){var s=_.scale||grid.scale,t=_.translate||grid.translate;if(isFunction(s))s=s(datum,_);if(isFunction(t))t=t(datum,_);if((s===1||s==null)&&!t)return;var sx=(isNumber(s)?s:s[0])||1,sy=(isNumber(s)?s:s[1])||1,tx=t&&t[0]||0,ty=t&&t[1]||0;paths.forEach(_transform(grid,sx,sy,tx,ty))}function _transform(grid,sx,sy,tx,ty){var x1=grid.x1||0,y1=grid.y1||0,flip=sx*sy<0;function transformPolygon(coordinates){coordinates.forEach(transformRing)}function transformRing(coordinates){if(flip)coordinates.reverse();coordinates.forEach(transformPoint)}function transformPoint(coordinates){coordinates[0]=(coordinates[0]-x1)*sx+tx;coordinates[1]=(coordinates[1]-y1)*sy+ty}return function(geometry){geometry.coordinates.forEach(transformPolygon);return geometry}}function radius(bw,data,f){var v=bw>=0?bw:estimateBandwidth(data,f);return Math.round((Math.sqrt(4*v*v+1)-1)/2)}function number$4(_){return isFunction(_)?_:constant(+_)}function density2D(){var x=function x(d){return d[0]},y=function y(d){return d[1]},weight=one,bandwidth=[-1,-1],dx=960,dy=500,k=2;function density(data,counts){var rx=radius(bandwidth[0],data,x)>>k,ry=radius(bandwidth[1],data,y)>>k,ox=rx?rx+2:0,oy=ry?ry+2:0,n=2*ox+(dx>>k),m=2*oy+(dy>>k),values0=new Float32Array(n*m),values1=new Float32Array(n*m);var values=values0;data.forEach((function(d){var xi=ox+(+x(d)>>k),yi=oy+(+y(d)>>k);if(xi>=0&&xi<n&&yi>=0&&yi<m){values0[xi+yi*n]+=+weight(d)}}));if(rx>0&&ry>0){blurX(n,m,values0,values1,rx);blurY(n,m,values1,values0,ry);blurX(n,m,values0,values1,rx);blurY(n,m,values1,values0,ry);blurX(n,m,values0,values1,rx);blurY(n,m,values1,values0,ry)}else if(rx>0){blurX(n,m,values0,values1,rx);blurX(n,m,values1,values0,rx);blurX(n,m,values0,values1,rx);values=values1}else if(ry>0){blurY(n,m,values0,values1,ry);blurY(n,m,values1,values0,ry);blurY(n,m,values0,values1,ry);values=values1}var s=counts?Math.pow(2,-2*k):1/sum(values);for(var i=0,sz=n*m;i<sz;++i){values[i]*=s}return{values:values,scale:1<<k,width:n,height:m,x1:ox,y1:oy,x2:ox+(dx>>k),y2:oy+(dy>>k)}}density.x=function(_){return arguments.length?(x=number$4(_),density):x};density.y=function(_){return arguments.length?(y=number$4(_),density):y};density.weight=function(_){return arguments.length?(weight=number$4(_),density):weight};density.size=function(_){if(!arguments.length)return[dx,dy];var _0=+_[0],_1=+_[1];if(!(_0>=0&&_1>=0))error("invalid size");return dx=_0,dy=_1,density};density.cellSize=function(_){if(!arguments.length)return 1<<k;if(!((_=+_)>=1))error("invalid cell size");k=Math.floor(Math.log(_)/Math.LN2);return density};density.bandwidth=function(_){if(!arguments.length)return bandwidth;_=array(_);if(_.length===1)_=[+_[0],+_[0]];if(_.length!==2)error("invalid bandwidth");return bandwidth=_,density};return density}function blurX(n,m,source,target,r){var w=(r<<1)+1;for(var j=0;j<m;++j){for(var i=0,sr=0;i<n+r;++i){if(i<n){sr+=source[i+j*n]}if(i>=r){if(i>=w){sr-=source[i-w+j*n]}target[i-r+j*n]=sr/Math.min(i+1,n-1+w-i,w)}}}}function blurY(n,m,source,target,r){var w=(r<<1)+1;for(var i=0;i<n;++i){for(var j=0,sr=0;j<m+r;++j){if(j<m){sr+=source[i+j*n]}if(j>=r){if(j>=w){sr-=source[i+(j-w)*n]}target[i+(j-r)*n]=sr/Math.min(j+1,m-1+w-j,w)}}}}function KDE2D(params){Transform.call(this,null,params)}KDE2D.Definition={type:"KDE2D",metadata:{generates:true},params:[{name:"size",type:"number",array:true,length:2,required:true},{name:"x",type:"field",required:true},{name:"y",type:"field",required:true},{name:"weight",type:"field"},{name:"groupby",type:"field",array:true},{name:"cellSize",type:"number"},{name:"bandwidth",type:"number",array:true,length:2},{name:"counts",type:"boolean",default:false},{name:"as",type:"string",default:"grid"}]};var PARAMS=["x","y","weight","size","cellSize","bandwidth"];function params(obj,_){PARAMS.forEach((function(param){return _[param]!=null?obj[param](_[param]):0}));return obj}inherits(KDE2D,Transform,{transform:function transform(_,pulse){if(this.value&&!pulse.changed()&&!_.modified())return pulse.StopPropagation;var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),source=pulse.materialize(pulse.SOURCE).source,groups=partition$3(source,_.groupby),names=(_.groupby||[]).map(accessorName),kde=params(density2D(),_),as=_.as||"grid",values=[];function set(t,vals){for(var i=0;i<names.length;++i){t[names[i]]=vals[i]}return t}values=groups.map((function(g){return ingest(set(_defineProperty({},as,kde(g,_.counts)),g.dims))}));if(this.value)out.rem=this.value;this.value=out.source=out.add=values;return out}});function partition$3(data,groupby){var groups=[],get=function get(f){return f(t)},map,i,n,t,k,g;if(groupby==null){groups.push(data)}else{for(map={},i=0,n=data.length;i<n;++i){t=data[i];k=groupby.map(get);g=map[k];if(!g){map[k]=g=[];g.dims=k;groups.push(g)}g.push(t)}}return groups}function Contour(params){Transform.call(this,null,params)}Contour.Definition={type:"Contour",metadata:{generates:true},params:[{name:"size",type:"number",array:true,length:2,required:true},{name:"values",type:"number",array:true},{name:"x",type:"field"},{name:"y",type:"field"},{name:"weight",type:"field"},{name:"cellSize",type:"number"},{name:"bandwidth",type:"number"},{name:"count",type:"number"},{name:"nice",type:"boolean",default:false},{name:"thresholds",type:"number",array:true},{name:"smooth",type:"boolean",default:true}]};inherits(Contour,Transform,{transform:function transform(_,pulse){if(this.value&&!pulse.changed()&&!_.modified()){return pulse.StopPropagation}var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS),contour=contours().smooth(_.smooth!==false),values=_.values,thresh=_.thresholds||quantize$2(_.count||10,_.nice,!!values),size=_.size,grid,post;if(!values){values=pulse.materialize(pulse.SOURCE).source;grid=params(density2D(),_)(values,true);post=_transform(grid,grid.scale||1,grid.scale||1,0,0);size=[grid.width,grid.height];values=grid.values}thresh=isArray(thresh)?thresh:thresh(values);values=contour.size(size)(values,thresh);if(post)values.forEach(post);if(this.value)out.rem=this.value;this.value=out.source=out.add=(values||[]).map(ingest);return out}});var Feature="Feature";var FeatureCollection="FeatureCollection";var MultiPoint="MultiPoint";function GeoJSON(params){Transform.call(this,null,params)}GeoJSON.Definition={type:"GeoJSON",metadata:{},params:[{name:"fields",type:"field",array:true,length:2},{name:"geojson",type:"field"}]};inherits(GeoJSON,Transform,{transform:function transform(_,pulse){var features=this._features,points=this._points,fields=_.fields,lon=fields&&fields[0],lat=fields&&fields[1],geojson=_.geojson||!fields&&identity,flag=pulse.ADD,mod;mod=_.modified()||pulse.changed(pulse.REM)||pulse.modified(accessorFields(geojson))||lon&&pulse.modified(accessorFields(lon))||lat&&pulse.modified(accessorFields(lat));if(!this.value||mod){flag=pulse.SOURCE;this._features=features=[];this._points=points=[]}if(geojson){pulse.visit(flag,(function(t){return features.push(geojson(t))}))}if(lon&&lat){pulse.visit(flag,(function(t){var x=lon(t),y=lat(t);if(x!=null&&y!=null&&(x=+x)===x&&(y=+y)===y){points.push([x,y])}}));features=features.concat({type:Feature,geometry:{type:MultiPoint,coordinates:points}})}this.value={type:FeatureCollection,features:features}}});function GeoPath(params){Transform.call(this,null,params)}GeoPath.Definition={type:"GeoPath",metadata:{modifies:true},params:[{name:"projection",type:"projection"},{name:"field",type:"field"},{name:"pointRadius",type:"number",expr:true},{name:"as",type:"string",default:"path"}]};inherits(GeoPath,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.ALL),path=this.value,field=_.field||identity,as=_.as||"path",flag=out.SOURCE;if(!path||_.modified()){this.value=path=getProjectionPath(_.projection);out.materialize().reflow()}else{flag=field===identity||pulse.modified(field.fields)?out.ADD_MOD:out.ADD}var prev=initPath(path,_.pointRadius);out.visit(flag,(function(t){return t[as]=path(field(t))}));path.pointRadius(prev);return out.modifies(as)}});function initPath(path,pointRadius){var prev=path.pointRadius();path.context(null);if(pointRadius!=null){path.pointRadius(pointRadius)}return prev}function GeoPoint(params){Transform.call(this,null,params)}GeoPoint.Definition={type:"GeoPoint",metadata:{modifies:true},params:[{name:"projection",type:"projection",required:true},{name:"fields",type:"field",array:true,required:true,length:2},{name:"as",type:"string",array:true,length:2,default:["x","y"]}]};inherits(GeoPoint,Transform,{transform:function transform(_,pulse){var proj=_.projection,lon=_.fields[0],lat=_.fields[1],as=_.as||["x","y"],x=as[0],y=as[1],mod;function set(t){var xy=proj([lon(t),lat(t)]);if(xy){t[x]=xy[0];t[y]=xy[1]}else{t[x]=undefined;t[y]=undefined}}if(_.modified()){pulse=pulse.materialize().reflow(true).visit(pulse.SOURCE,set)}else{mod=pulse.modified(lon.fields)||pulse.modified(lat.fields);pulse.visit(mod?pulse.ADD_MOD:pulse.ADD,set)}return pulse.modifies(as)}});function GeoShape(params){Transform.call(this,null,params)}GeoShape.Definition={type:"GeoShape",metadata:{modifies:true,nomod:true},params:[{name:"projection",type:"projection"},{name:"field",type:"field",default:"datum"},{name:"pointRadius",type:"number",expr:true},{name:"as",type:"string",default:"shape"}]};inherits(GeoShape,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.ALL),shape=this.value,as=_.as||"shape",flag=out.ADD;if(!shape||_.modified()){this.value=shape=shapeGenerator(getProjectionPath(_.projection),_.field||field("datum"),_.pointRadius);out.materialize().reflow();flag=out.SOURCE}out.visit(flag,(function(t){return t[as]=shape}));return out.modifies(as)}});function shapeGenerator(path,field,pointRadius){var shape=pointRadius==null?function(_){return path(field(_))}:function(_){var prev=path.pointRadius(),value=path.pointRadius(pointRadius)(field(_));path.pointRadius(prev);return value};shape.context=function(_){path.context(_);return shape};return shape}function Graticule(params){Transform.call(this,[],params);this.generator=graticule()}Graticule.Definition={type:"Graticule",metadata:{changes:true,generates:true},params:[{name:"extent",type:"array",array:true,length:2,content:{type:"number",array:true,length:2}},{name:"extentMajor",type:"array",array:true,length:2,content:{type:"number",array:true,length:2}},{name:"extentMinor",type:"array",array:true,length:2,content:{type:"number",array:true,length:2}},{name:"step",type:"number",array:true,length:2},{name:"stepMajor",type:"number",array:true,length:2,default:[90,360]},{name:"stepMinor",type:"number",array:true,length:2,default:[10,10]},{name:"precision",type:"number",default:2.5}]};inherits(Graticule,Transform,{transform:function transform(_,pulse){var src=this.value,gen=this.generator,t;if(!src.length||_.modified()){for(var prop in _){if(isFunction(gen[prop])){gen[prop](_[prop])}}}t=gen();if(src.length){pulse.mod.push(replace(src[0],t))}else{pulse.add.push(ingest(t))}src[0]=t;return pulse}});function Heatmap(params){Transform.call(this,null,params)}Heatmap.Definition={type:"heatmap",metadata:{modifies:true},params:[{name:"field",type:"field"},{name:"color",type:"string",expr:true},{name:"opacity",type:"number",expr:true},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"as",type:"string",default:"image"}]};inherits(Heatmap,Transform,{transform:function transform(_,pulse){if(!pulse.changed()&&!_.modified()){return pulse.StopPropagation}var source=pulse.materialize(pulse.SOURCE).source,shared=_.resolve==="shared",field=_.field||identity,opacity=opacity_(_.opacity,_),color=color_(_.color,_),as=_.as||"image",obj={$x:0,$y:0,$value:0,$max:shared?max(source.map((function(t){return max(field(t).values)}))):0};source.forEach((function(t){var v=field(t);var o=extend({},t,obj);if(!shared)o.$max=max(v.values||[]);t[as]=toCanvas(v,o,color.dep?color:constant(color(o)),opacity.dep?opacity:constant(opacity(o)))}));return pulse.reflow(true).modifies(as)}});function color_(color,_){var f;if(isFunction(color)){f=function f(obj){return rgb(color(obj,_))};f.dep=dependency(color)}else{f=constant(rgb(color||"#888"))}return f}function opacity_(opacity,_){var f;if(isFunction(opacity)){f=function f(obj){return opacity(obj,_)};f.dep=dependency(opacity)}else if(opacity){f=constant(opacity)}else{f=function f(obj){return obj.$value/obj.$max||0};f.dep=true}return f}function dependency(f){if(!isFunction(f))return false;var set=toSet(accessorFields(f));return set.$x||set.$y||set.$value||set.$max}function toCanvas(grid,obj,color,opacity){var n=grid.width,m=grid.height,x1=grid.x1||0,y1=grid.y1||0,x2=grid.x2||n,y2=grid.y2||m,val=grid.values,value=val?function(i){return val[i]}:zero,can=domCanvas(x2-x1,y2-y1),ctx=can.getContext("2d"),img=ctx.getImageData(0,0,x2-x1,y2-y1),pix=img.data;for(var j=y1,k=0;j<y2;++j){obj.$y=j-y1;for(var i=x1,r=j*n;i<x2;++i,k+=4){obj.$x=i-x1;obj.$value=value(i+r);var v=color(obj);pix[k+0]=v.r;pix[k+1]=v.g;pix[k+2]=v.b;pix[k+3]=~~(255*opacity(obj))}}ctx.putImageData(img,0,0);return can}function Projection(params){Transform.call(this,null,params);this.modified(true)}inherits(Projection,Transform,{transform:function transform(_,pulse){var proj=this.value;if(!proj||_.modified("type")){this.value=proj=create$2(_.type);projectionProperties.forEach((function(prop){if(_[prop]!=null)set$2(proj,prop,_[prop])}))}else{projectionProperties.forEach((function(prop){if(_.modified(prop))set$2(proj,prop,_[prop])}))}if(_.pointRadius!=null)proj.path.pointRadius(_.pointRadius);if(_.fit)fit$1(proj,_);return pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS)}});function fit$1(proj,_){var data=collectGeoJSON(_.fit);_.extent?proj.fitExtent(_.extent,data):_.size?proj.fitSize(_.size,data):0}function create$2(type){var constructor=projection$1((type||"mercator").toLowerCase());if(!constructor)error("Unrecognized projection type: "+type);return constructor()}function set$2(proj,key,value){if(isFunction(proj[key]))proj[key](value)}function collectGeoJSON(data){data=array(data);return data.length===1?data[0]:{type:FeatureCollection,features:data.reduce((function(a,f){return a.concat(featurize(f))}),[])}}function featurize(f){return f.type===FeatureCollection?f.features:array(f).filter((function(d){return d!=null})).map((function(d){return d.type===Feature?d:{type:Feature,geometry:d}}))}var geo=Object.freeze({__proto__:null,contour:Contour,geojson:GeoJSON,geopath:GeoPath,geopoint:GeoPoint,geoshape:GeoShape,graticule:Graticule,heatmap:Heatmap,isocontour:Isocontour,kde2d:KDE2D,projection:Projection});function forceCenter(x,y){var nodes,strength=1;if(x==null)x=0;if(y==null)y=0;function force(){var i,n=nodes.length,node,sx=0,sy=0;for(i=0;i<n;++i){node=nodes[i],sx+=node.x,sy+=node.y}for(sx=(sx/n-x)*strength,sy=(sy/n-y)*strength,i=0;i<n;++i){node=nodes[i],node.x-=sx,node.y-=sy}}force.initialize=function(_){nodes=_};force.x=function(_){return arguments.length?(x=+_,force):x};force.y=function(_){return arguments.length?(y=+_,force):y};force.strength=function(_){return arguments.length?(strength=+_,force):strength};return force}function tree_add(d){var x=+this._x.call(null,d),y=+this._y.call(null,d);return add$3(this.cover(x,y),x,y,d)}function add$3(tree,x,y,d){if(isNaN(x)||isNaN(y))return tree;var parent,node=tree._root,leaf={data:d},x0=tree._x0,y0=tree._y0,x1=tree._x1,y1=tree._y1,xm,ym,xp,yp,right,bottom,i,j;if(!node)return tree._root=leaf,tree;while(node.length){if(right=x>=(xm=(x0+x1)/2))x0=xm;else x1=xm;if(bottom=y>=(ym=(y0+y1)/2))y0=ym;else y1=ym;if(parent=node,!(node=node[i=bottom<<1|right]))return parent[i]=leaf,tree}xp=+tree._x.call(null,node.data);yp=+tree._y.call(null,node.data);if(x===xp&&y===yp)return leaf.next=node,parent?parent[i]=leaf:tree._root=leaf,tree;do{parent=parent?parent[i]=new Array(4):tree._root=new Array(4);if(right=x>=(xm=(x0+x1)/2))x0=xm;else x1=xm;if(bottom=y>=(ym=(y0+y1)/2))y0=ym;else y1=ym}while((i=bottom<<1|right)===(j=(yp>=ym)<<1|xp>=xm));return parent[j]=node,parent[i]=leaf,tree}function addAll(data){var d,i,n=data.length,x,y,xz=new Array(n),yz=new Array(n),x0=Infinity,y0=Infinity,x1=-Infinity,y1=-Infinity;for(i=0;i<n;++i){if(isNaN(x=+this._x.call(null,d=data[i]))||isNaN(y=+this._y.call(null,d)))continue;xz[i]=x;yz[i]=y;if(x<x0)x0=x;if(x>x1)x1=x;if(y<y0)y0=y;if(y>y1)y1=y}if(x0>x1||y0>y1)return this;this.cover(x0,y0).cover(x1,y1);for(i=0;i<n;++i){add$3(this,xz[i],yz[i],data[i])}return this}function tree_cover(x,y){if(isNaN(x=+x)||isNaN(y=+y))return this;var x0=this._x0,y0=this._y0,x1=this._x1,y1=this._y1;if(isNaN(x0)){x1=(x0=Math.floor(x))+1;y1=(y0=Math.floor(y))+1}else{var z=x1-x0||1,node=this._root,parent,i;while(x0>x||x>=x1||y0>y||y>=y1){i=(y<y0)<<1|x<x0;parent=new Array(4),parent[i]=node,node=parent,z*=2;switch(i){case 0:x1=x0+z,y1=y0+z;break;case 1:x0=x1-z,y1=y0+z;break;case 2:x1=x0+z,y0=y1-z;break;case 3:x0=x1-z,y0=y1-z;break}}if(this._root&&this._root.length)this._root=node}this._x0=x0;this._y0=y0;this._x1=x1;this._y1=y1;return this}function tree_data(){var data=[];this.visit((function(node){if(!node.length)do{data.push(node.data)}while(node=node.next)}));return data}function tree_extent(_){return arguments.length?this.cover(+_[0][0],+_[0][1]).cover(+_[1][0],+_[1][1]):isNaN(this._x0)?undefined:[[this._x0,this._y0],[this._x1,this._y1]]}function Quad(node,x0,y0,x1,y1){this.node=node;this.x0=x0;this.y0=y0;this.x1=x1;this.y1=y1}function tree_find(x,y,radius){var data,x0=this._x0,y0=this._y0,x1,y1,x2,y2,x3=this._x1,y3=this._y1,quads=[],node=this._root,q,i;if(node)quads.push(new Quad(node,x0,y0,x3,y3));if(radius==null)radius=Infinity;else{x0=x-radius,y0=y-radius;x3=x+radius,y3=y+radius;radius*=radius}while(q=quads.pop()){if(!(node=q.node)||(x1=q.x0)>x3||(y1=q.y0)>y3||(x2=q.x1)<x0||(y2=q.y1)<y0)continue;if(node.length){var xm=(x1+x2)/2,ym=(y1+y2)/2;quads.push(new Quad(node[3],xm,ym,x2,y2),new Quad(node[2],x1,ym,xm,y2),new Quad(node[1],xm,y1,x2,ym),new Quad(node[0],x1,y1,xm,ym));if(i=(y>=ym)<<1|x>=xm){q=quads[quads.length-1];quads[quads.length-1]=quads[quads.length-1-i];quads[quads.length-1-i]=q}}else{var dx=x-+this._x.call(null,node.data),dy=y-+this._y.call(null,node.data),d2=dx*dx+dy*dy;if(d2<radius){var d=Math.sqrt(radius=d2);x0=x-d,y0=y-d;x3=x+d,y3=y+d;data=node.data}}}return data}function tree_remove(d){if(isNaN(x=+this._x.call(null,d))||isNaN(y=+this._y.call(null,d)))return this;var parent,node=this._root,retainer,previous,next,x0=this._x0,y0=this._y0,x1=this._x1,y1=this._y1,x,y,xm,ym,right,bottom,i,j;if(!node)return this;if(node.length)while(true){if(right=x>=(xm=(x0+x1)/2))x0=xm;else x1=xm;if(bottom=y>=(ym=(y0+y1)/2))y0=ym;else y1=ym;if(!(parent=node,node=node[i=bottom<<1|right]))return this;if(!node.length)break;if(parent[i+1&3]||parent[i+2&3]||parent[i+3&3])retainer=parent,j=i}while(node.data!==d){if(!(previous=node,node=node.next))return this}if(next=node.next)delete node.next;if(previous)return next?previous.next=next:delete previous.next,this;if(!parent)return this._root=next,this;next?parent[i]=next:delete parent[i];if((node=parent[0]||parent[1]||parent[2]||parent[3])&&node===(parent[3]||parent[2]||parent[1]||parent[0])&&!node.length){if(retainer)retainer[j]=node;else this._root=node}return this}function removeAll(data){for(var i=0,n=data.length;i<n;++i){this.remove(data[i])}return this}function tree_root(){return this._root}function tree_size(){var size=0;this.visit((function(node){if(!node.length)do{++size}while(node=node.next)}));return size}function tree_visit(callback){var quads=[],q,node=this._root,child,x0,y0,x1,y1;if(node)quads.push(new Quad(node,this._x0,this._y0,this._x1,this._y1));while(q=quads.pop()){if(!callback(node=q.node,x0=q.x0,y0=q.y0,x1=q.x1,y1=q.y1)&&node.length){var xm=(x0+x1)/2,ym=(y0+y1)/2;if(child=node[3])quads.push(new Quad(child,xm,ym,x1,y1));if(child=node[2])quads.push(new Quad(child,x0,ym,xm,y1));if(child=node[1])quads.push(new Quad(child,xm,y0,x1,ym));if(child=node[0])quads.push(new Quad(child,x0,y0,xm,ym))}}return this}function tree_visitAfter(callback){var quads=[],next=[],q;if(this._root)quads.push(new Quad(this._root,this._x0,this._y0,this._x1,this._y1));while(q=quads.pop()){var node=q.node;if(node.length){var child,x0=q.x0,y0=q.y0,x1=q.x1,y1=q.y1,xm=(x0+x1)/2,ym=(y0+y1)/2;if(child=node[0])quads.push(new Quad(child,x0,y0,xm,ym));if(child=node[1])quads.push(new Quad(child,xm,y0,x1,ym));if(child=node[2])quads.push(new Quad(child,x0,ym,xm,y1));if(child=node[3])quads.push(new Quad(child,xm,ym,x1,y1))}next.push(q)}while(q=next.pop()){callback(q.node,q.x0,q.y0,q.x1,q.y1)}return this}function defaultX(d){return d[0]}function tree_x(_){return arguments.length?(this._x=_,this):this._x}function defaultY(d){return d[1]}function tree_y(_){return arguments.length?(this._y=_,this):this._y}function quadtree(nodes,x,y){var tree=new Quadtree(x==null?defaultX:x,y==null?defaultY:y,NaN,NaN,NaN,NaN);return nodes==null?tree:tree.addAll(nodes)}function Quadtree(x,y,x0,y0,x1,y1){this._x=x;this._y=y;this._x0=x0;this._y0=y0;this._x1=x1;this._y1=y1;this._root=undefined}function leaf_copy(leaf){var copy={data:leaf.data},next=copy;while(leaf=leaf.next){next=next.next={data:leaf.data}}return copy}var treeProto=quadtree.prototype=Quadtree.prototype;treeProto.copy=function(){var copy=new Quadtree(this._x,this._y,this._x0,this._y0,this._x1,this._y1),node=this._root,nodes,child;if(!node)return copy;if(!node.length)return copy._root=leaf_copy(node),copy;nodes=[{source:node,target:copy._root=new Array(4)}];while(node=nodes.pop()){for(var i=0;i<4;++i){if(child=node.source[i]){if(child.length)nodes.push({source:child,target:node.target[i]=new Array(4)});else node.target[i]=leaf_copy(child)}}}return copy};treeProto.add=tree_add;treeProto.addAll=addAll;treeProto.cover=tree_cover;treeProto.data=tree_data;treeProto.extent=tree_extent;treeProto.find=tree_find;treeProto.remove=tree_remove;treeProto.removeAll=removeAll;treeProto.root=tree_root;treeProto.size=tree_size;treeProto.visit=tree_visit;treeProto.visitAfter=tree_visitAfter;treeProto.x=tree_x;treeProto.y=tree_y;function constant$3(x){return function(){return x}}function jiggle(random){return(random()-.5)*1e-6}function x$2(d){return d.x+d.vx}function y$2(d){return d.y+d.vy}function forceCollide(radius){var nodes,radii,random,strength=1,iterations=1;if(typeof radius!=="function")radius=constant$3(radius==null?1:+radius);function force(){var i,n=nodes.length,tree,node,xi,yi,ri,ri2;for(var k=0;k<iterations;++k){tree=quadtree(nodes,x$2,y$2).visitAfter(prepare);for(i=0;i<n;++i){node=nodes[i];ri=radii[node.index],ri2=ri*ri;xi=node.x+node.vx;yi=node.y+node.vy;tree.visit(apply)}}function apply(quad,x0,y0,x1,y1){var data=quad.data,rj=quad.r,r=ri+rj;if(data){if(data.index>node.index){var x=xi-data.x-data.vx,y=yi-data.y-data.vy,l=x*x+y*y;if(l<r*r){if(x===0)x=jiggle(random),l+=x*x;if(y===0)y=jiggle(random),l+=y*y;l=(r-(l=Math.sqrt(l)))/l*strength;node.vx+=(x*=l)*(r=(rj*=rj)/(ri2+rj));node.vy+=(y*=l)*r;data.vx-=x*(r=1-r);data.vy-=y*r}}return}return x0>xi+r||x1<xi-r||y0>yi+r||y1<yi-r}}function prepare(quad){if(quad.data)return quad.r=radii[quad.data.index];for(var i=quad.r=0;i<4;++i){if(quad[i]&&quad[i].r>quad.r){quad.r=quad[i].r}}}function initialize(){if(!nodes)return;var i,n=nodes.length,node;radii=new Array(n);for(i=0;i<n;++i){node=nodes[i],radii[node.index]=+radius(node,i,nodes)}}force.initialize=function(_nodes,_random){nodes=_nodes;random=_random;initialize()};force.iterations=function(_){return arguments.length?(iterations=+_,force):iterations};force.strength=function(_){return arguments.length?(strength=+_,force):strength};force.radius=function(_){return arguments.length?(radius=typeof _==="function"?_:constant$3(+_),initialize(),force):radius};return force}function index(d){return d.index}function find$1(nodeById,nodeId){var node=nodeById.get(nodeId);if(!node)throw new Error("node not found: "+nodeId);return node}function forceLink(links){var id=index,strength=defaultStrength,strengths,distance=constant$3(30),distances,nodes,count,bias,random,iterations=1;if(links==null)links=[];function defaultStrength(link){return 1/Math.min(count[link.source.index],count[link.target.index])}function force(alpha){for(var k=0,n=links.length;k<iterations;++k){for(var i=0,link,source,target,x,y,l,b;i<n;++i){link=links[i],source=link.source,target=link.target;x=target.x+target.vx-source.x-source.vx||jiggle(random);y=target.y+target.vy-source.y-source.vy||jiggle(random);l=Math.sqrt(x*x+y*y);l=(l-distances[i])/l*alpha*strengths[i];x*=l,y*=l;target.vx-=x*(b=bias[i]);target.vy-=y*b;source.vx+=x*(b=1-b);source.vy+=y*b}}}function initialize(){if(!nodes)return;var i,n=nodes.length,m=links.length,nodeById=new Map(nodes.map((function(d,i){return[id(d,i,nodes),d]}))),link;for(i=0,count=new Array(n);i<m;++i){link=links[i],link.index=i;if(_typeof(link.source)!=="object")link.source=find$1(nodeById,link.source);if(_typeof(link.target)!=="object")link.target=find$1(nodeById,link.target);count[link.source.index]=(count[link.source.index]||0)+1;count[link.target.index]=(count[link.target.index]||0)+1}for(i=0,bias=new Array(m);i<m;++i){link=links[i],bias[i]=count[link.source.index]/(count[link.source.index]+count[link.target.index])}strengths=new Array(m),initializeStrength();distances=new Array(m),initializeDistance()}function initializeStrength(){if(!nodes)return;for(var i=0,n=links.length;i<n;++i){strengths[i]=+strength(links[i],i,links)}}function initializeDistance(){if(!nodes)return;for(var i=0,n=links.length;i<n;++i){distances[i]=+distance(links[i],i,links)}}force.initialize=function(_nodes,_random){nodes=_nodes;random=_random;initialize()};force.links=function(_){return arguments.length?(links=_,initialize(),force):links};force.id=function(_){return arguments.length?(id=_,force):id};force.iterations=function(_){return arguments.length?(iterations=+_,force):iterations};force.strength=function(_){return arguments.length?(strength=typeof _==="function"?_:constant$3(+_),initializeStrength(),force):strength};force.distance=function(_){return arguments.length?(distance=typeof _==="function"?_:constant$3(+_),initializeDistance(),force):distance};return force}var noop$4={value:function value(){}};function dispatch(){for(var i=0,n=arguments.length,_={},t;i<n;++i){if(!(t=arguments[i]+"")||t in _||/[\s.]/.test(t))throw new Error("illegal type: "+t);_[t]=[]}return new Dispatch(_)}function Dispatch(_){this._=_}function parseTypenames(typenames,types){return typenames.trim().split(/^|\s+/).map((function(t){var name="",i=t.indexOf(".");if(i>=0)name=t.slice(i+1),t=t.slice(0,i);if(t&&!types.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:name}}))}Dispatch.prototype=dispatch.prototype={constructor:Dispatch,on:function on(typename,callback){var _=this._,T=parseTypenames(typename+"",_),t,i=-1,n=T.length;if(arguments.length<2){while(++i<n){if((t=(typename=T[i]).type)&&(t=get$4(_[t],typename.name)))return t}return}if(callback!=null&&typeof callback!=="function")throw new Error("invalid callback: "+callback);while(++i<n){if(t=(typename=T[i]).type)_[t]=set$3(_[t],typename.name,callback);else if(callback==null)for(t in _){_[t]=set$3(_[t],typename.name,null)}}return this},copy:function copy(){var copy={},_=this._;for(var t in _){copy[t]=_[t].slice()}return new Dispatch(copy)},call:function call(type,that){if((n=arguments.length-2)>0)for(var args=new Array(n),i=0,n,t;i<n;++i){args[i]=arguments[i+2]}if(!this._.hasOwnProperty(type))throw new Error("unknown type: "+type);for(t=this._[type],i=0,n=t.length;i<n;++i){t[i].value.apply(that,args)}},apply:function apply(type,that,args){if(!this._.hasOwnProperty(type))throw new Error("unknown type: "+type);for(var t=this._[type],i=0,n=t.length;i<n;++i){t[i].value.apply(that,args)}}};function get$4(type,name){for(var i=0,n=type.length,c;i<n;++i){if((c=type[i]).name===name){return c.value}}}function set$3(type,name,callback){for(var i=0,n=type.length;i<n;++i){if(type[i].name===name){type[i]=noop$4,type=type.slice(0,i).concat(type.slice(i+1));break}}if(callback!=null)type.push({name:name,value:callback});return type}var frame=0,timeout=0,interval=0,pokeDelay=1e3,taskHead,taskTail,clockLast=0,clockNow=0,clockSkew=0,clock=(typeof performance==="undefined"?"undefined":_typeof(performance))==="object"&&performance.now?performance:Date,setFrame=(typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(f){setTimeout(f,17)};function now(){return clockNow||(setFrame(clearNow),clockNow=clock.now()+clockSkew)}function clearNow(){clockNow=0}function Timer(){this._call=this._time=this._next=null}Timer.prototype=timer.prototype={constructor:Timer,restart:function restart(callback,delay,time){if(typeof callback!=="function")throw new TypeError("callback is not a function");time=(time==null?now():+time)+(delay==null?0:+delay);if(!this._next&&taskTail!==this){if(taskTail)taskTail._next=this;else taskHead=this;taskTail=this}this._call=callback;this._time=time;sleep()},stop:function stop(){if(this._call){this._call=null;this._time=Infinity;sleep()}}};function timer(callback,delay,time){var t=new Timer;t.restart(callback,delay,time);return t}function timerFlush(){now();++frame;var t=taskHead,e;while(t){if((e=clockNow-t._time)>=0)t._call.call(null,e);t=t._next}--frame}function wake(){clockNow=(clockLast=clock.now())+clockSkew;frame=timeout=0;try{timerFlush()}finally{frame=0;nap();clockNow=0}}function poke(){var now=clock.now(),delay=now-clockLast;if(delay>pokeDelay)clockSkew-=delay,clockLast=now}function nap(){var t0,t1=taskHead,t2,time=Infinity;while(t1){if(t1._call){if(time>t1._time)time=t1._time;t0=t1,t1=t1._next}else{t2=t1._next,t1._next=null;t1=t0?t0._next=t2:taskHead=t2}}taskTail=t0;sleep(time)}function sleep(time){if(frame)return;if(timeout)timeout=clearTimeout(timeout);var delay=time-clockNow;if(delay>24){if(time<Infinity)timeout=setTimeout(wake,time-clock.now()-clockSkew);if(interval)interval=clearInterval(interval)}else{if(!interval)clockLast=clock.now(),interval=setInterval(poke,pokeDelay);frame=1,setFrame(wake)}}function interval$1(callback,delay,time){var t=new Timer,total=delay;if(delay==null)return t.restart(callback,delay,time),t;t._restart=t.restart;t.restart=function(callback,delay,time){delay=+delay,time=time==null?now():+time;t._restart((function tick(elapsed){elapsed+=total;t._restart(tick,total+=delay,time);callback(elapsed)}),delay,time)};t.restart(callback,delay,time);return t}var a=1664525;var c=1013904223;var m=4294967296;function lcg$1(){var s=1;return function(){return(s=(a*s+c)%m)/m}}function x$3(d){return d.x}function y$3(d){return d.y}var initialRadius=10,initialAngle=Math.PI*(3-Math.sqrt(5));function forceSimulation(_nodes){var simulation,_alpha=1,_alphaMin=.001,_alphaDecay=1-Math.pow(_alphaMin,1/300),_alphaTarget=0,_velocityDecay=.6,forces=new Map,stepper=timer(step),event=dispatch("tick","end"),random=lcg$1();if(_nodes==null)_nodes=[];function step(){tick();event.call("tick",simulation);if(_alpha<_alphaMin){stepper.stop();event.call("end",simulation)}}function tick(iterations){var i,n=_nodes.length,node;if(iterations===undefined)iterations=1;for(var k=0;k<iterations;++k){_alpha+=(_alphaTarget-_alpha)*_alphaDecay;forces.forEach((function(force){force(_alpha)}));for(i=0;i<n;++i){node=_nodes[i];if(node.fx==null)node.x+=node.vx*=_velocityDecay;else node.x=node.fx,node.vx=0;if(node.fy==null)node.y+=node.vy*=_velocityDecay;else node.y=node.fy,node.vy=0}}return simulation}function initializeNodes(){for(var i=0,n=_nodes.length,node;i<n;++i){node=_nodes[i],node.index=i;if(node.fx!=null)node.x=node.fx;if(node.fy!=null)node.y=node.fy;if(isNaN(node.x)||isNaN(node.y)){var radius=initialRadius*Math.sqrt(.5+i),angle=i*initialAngle;node.x=radius*Math.cos(angle);node.y=radius*Math.sin(angle)}if(isNaN(node.vx)||isNaN(node.vy)){node.vx=node.vy=0}}}function initializeForce(force){if(force.initialize)force.initialize(_nodes,random);return force}initializeNodes();return simulation={tick:tick,restart:function restart(){return stepper.restart(step),simulation},stop:function stop(){return stepper.stop(),simulation},nodes:function nodes(_){return arguments.length?(_nodes=_,initializeNodes(),forces.forEach(initializeForce),simulation):_nodes},alpha:function alpha(_){return arguments.length?(_alpha=+_,simulation):_alpha},alphaMin:function alphaMin(_){return arguments.length?(_alphaMin=+_,simulation):_alphaMin},alphaDecay:function alphaDecay(_){return arguments.length?(_alphaDecay=+_,simulation):+_alphaDecay},alphaTarget:function alphaTarget(_){return arguments.length?(_alphaTarget=+_,simulation):_alphaTarget},velocityDecay:function velocityDecay(_){return arguments.length?(_velocityDecay=1-_,simulation):1-_velocityDecay},randomSource:function randomSource(_){return arguments.length?(random=_,forces.forEach(initializeForce),simulation):random},force:function force(name,_){return arguments.length>1?(_==null?forces.delete(name):forces.set(name,initializeForce(_)),simulation):forces.get(name)},find:function find(x,y,radius){var i=0,n=_nodes.length,dx,dy,d2,node,closest;if(radius==null)radius=Infinity;else radius*=radius;for(i=0;i<n;++i){node=_nodes[i];dx=x-node.x;dy=y-node.y;d2=dx*dx+dy*dy;if(d2<radius)closest=node,radius=d2}return closest},on:function on(name,_){return arguments.length>1?(event.on(name,_),simulation):event.on(name)}}}function forceManyBody(){var nodes,node,random,alpha,strength=constant$3(-30),strengths,distanceMin2=1,distanceMax2=Infinity,theta2=.81;function force(_){var i,n=nodes.length,tree=quadtree(nodes,x$3,y$3).visitAfter(accumulate);for(alpha=_,i=0;i<n;++i){node=nodes[i],tree.visit(apply)}}function initialize(){if(!nodes)return;var i,n=nodes.length,node;strengths=new Array(n);for(i=0;i<n;++i){node=nodes[i],strengths[node.index]=+strength(node,i,nodes)}}function accumulate(quad){var strength=0,q,c,weight=0,x,y,i;if(quad.length){for(x=y=i=0;i<4;++i){if((q=quad[i])&&(c=Math.abs(q.value))){strength+=q.value,weight+=c,x+=c*q.x,y+=c*q.y}}quad.x=x/weight;quad.y=y/weight}else{q=quad;q.x=q.data.x;q.y=q.data.y;do{strength+=strengths[q.data.index]}while(q=q.next)}quad.value=strength}function apply(quad,x1,_,x2){if(!quad.value)return true;var x=quad.x-node.x,y=quad.y-node.y,w=x2-x1,l=x*x+y*y;if(w*w/theta2<l){if(l<distanceMax2){if(x===0)x=jiggle(random),l+=x*x;if(y===0)y=jiggle(random),l+=y*y;if(l<distanceMin2)l=Math.sqrt(distanceMin2*l);node.vx+=x*quad.value*alpha/l;node.vy+=y*quad.value*alpha/l}return true}else if(quad.length||l>=distanceMax2)return;if(quad.data!==node||quad.next){if(x===0)x=jiggle(random),l+=x*x;if(y===0)y=jiggle(random),l+=y*y;if(l<distanceMin2)l=Math.sqrt(distanceMin2*l)}do{if(quad.data!==node){w=strengths[quad.data.index]*alpha/l;node.vx+=x*w;node.vy+=y*w}}while(quad=quad.next)}force.initialize=function(_nodes,_random){nodes=_nodes;random=_random;initialize()};force.strength=function(_){return arguments.length?(strength=typeof _==="function"?_:constant$3(+_),initialize(),force):strength};force.distanceMin=function(_){return arguments.length?(distanceMin2=_*_,force):Math.sqrt(distanceMin2)};force.distanceMax=function(_){return arguments.length?(distanceMax2=_*_,force):Math.sqrt(distanceMax2)};force.theta=function(_){return arguments.length?(theta2=_*_,force):Math.sqrt(theta2)};return force}function forceX(x){var strength=constant$3(.1),nodes,strengths,xz;if(typeof x!=="function")x=constant$3(x==null?0:+x);function force(alpha){for(var i=0,n=nodes.length,node;i<n;++i){node=nodes[i],node.vx+=(xz[i]-node.x)*strengths[i]*alpha}}function initialize(){if(!nodes)return;var i,n=nodes.length;strengths=new Array(n);xz=new Array(n);for(i=0;i<n;++i){strengths[i]=isNaN(xz[i]=+x(nodes[i],i,nodes))?0:+strength(nodes[i],i,nodes)}}force.initialize=function(_){nodes=_;initialize()};force.strength=function(_){return arguments.length?(strength=typeof _==="function"?_:constant$3(+_),initialize(),force):strength};force.x=function(_){return arguments.length?(x=typeof _==="function"?_:constant$3(+_),initialize(),force):x};return force}function forceY(y){var strength=constant$3(.1),nodes,strengths,yz;if(typeof y!=="function")y=constant$3(y==null?0:+y);function force(alpha){for(var i=0,n=nodes.length,node;i<n;++i){node=nodes[i],node.vy+=(yz[i]-node.y)*strengths[i]*alpha}}function initialize(){if(!nodes)return;var i,n=nodes.length;strengths=new Array(n);yz=new Array(n);for(i=0;i<n;++i){strengths[i]=isNaN(yz[i]=+y(nodes[i],i,nodes))?0:+strength(nodes[i],i,nodes)}}force.initialize=function(_){nodes=_;initialize()};force.strength=function(_){return arguments.length?(strength=typeof _==="function"?_:constant$3(+_),initialize(),force):strength};force.y=function(_){return arguments.length?(y=typeof _==="function"?_:constant$3(+_),initialize(),force):y};return force}var ForceMap={center:forceCenter,collide:forceCollide,nbody:forceManyBody,link:forceLink,x:forceX,y:forceY};var Forces="forces",ForceParams=["alpha","alphaMin","alphaTarget","velocityDecay","forces"],ForceConfig=["static","iterations"],ForceOutput=["x","y","vx","vy"];function Force(params){Transform.call(this,null,params)}Force.Definition={type:"Force",metadata:{modifies:true},params:[{name:"static",type:"boolean",default:false},{name:"restart",type:"boolean",default:false},{name:"iterations",type:"number",default:300},{name:"alpha",type:"number",default:1},{name:"alphaMin",type:"number",default:.001},{name:"alphaTarget",type:"number",default:0},{name:"velocityDecay",type:"number",default:.4},{name:"forces",type:"param",array:true,params:[{key:{force:"center"},params:[{name:"x",type:"number",default:0},{name:"y",type:"number",default:0}]},{key:{force:"collide"},params:[{name:"radius",type:"number",expr:true},{name:"strength",type:"number",default:.7},{name:"iterations",type:"number",default:1}]},{key:{force:"nbody"},params:[{name:"strength",type:"number",default:-30},{name:"theta",type:"number",default:.9},{name:"distanceMin",type:"number",default:1},{name:"distanceMax",type:"number"}]},{key:{force:"link"},params:[{name:"links",type:"data"},{name:"id",type:"field"},{name:"distance",type:"number",default:30,expr:true},{name:"strength",type:"number",expr:true},{name:"iterations",type:"number",default:1}]},{key:{force:"x"},params:[{name:"strength",type:"number",default:.1},{name:"x",type:"field"}]},{key:{force:"y"},params:[{name:"strength",type:"number",default:.1},{name:"y",type:"field"}]}]},{name:"as",type:"string",array:true,modify:false,default:ForceOutput}]};inherits(Force,Transform,{transform:function transform(_,pulse){var sim=this.value,change=pulse.changed(pulse.ADD_REM),params=_.modified(ForceParams),iters=_.iterations||300;if(!sim){this.value=sim=simulation(pulse.source,_);sim.on("tick",rerun(pulse.dataflow,this));if(!_.static){change=true;sim.tick()}pulse.modifies("index")}else{if(change){pulse.modifies("index");sim.nodes(pulse.source)}if(params||pulse.changed(pulse.MOD)){setup(sim,_,0,pulse)}}if(params||change||_.modified(ForceConfig)||pulse.changed()&&_.restart){sim.alpha(Math.max(sim.alpha(),_.alpha||1)).alphaDecay(1-Math.pow(sim.alphaMin(),1/iters));if(_.static){for(sim.stop();--iters>=0;){sim.tick()}}else{if(sim.stopped())sim.restart();if(!change)return pulse.StopPropagation}}return this.finish(_,pulse)},finish:function finish(_,pulse){var dataflow=pulse.dataflow;for(var args=this._argops,j=0,m=args.length,arg;j<m;++j){arg=args[j];if(arg.name!==Forces||arg.op._argval.force!=="link"){continue}for(var ops=arg.op._argops,i=0,n=ops.length,op;i<n;++i){if(ops[i].name==="links"&&(op=ops[i].op.source)){dataflow.pulse(op,dataflow.changeset().reflow());break}}}return pulse.reflow(_.modified()).modifies(ForceOutput)}});function rerun(df,op){return function(){return df.touch(op).run()}}function simulation(nodes,_){var sim=forceSimulation(nodes),stop=sim.stop,restart=sim.restart;var stopped=false;sim.stopped=function(){return stopped};sim.restart=function(){return stopped=false,restart()};sim.stop=function(){return stopped=true,stop()};return setup(sim,_,true).on("end",(function(){return stopped=true}))}function setup(sim,_,init,pulse){var f=array(_.forces),i,n,p,name;for(i=0,n=ForceParams.length;i<n;++i){p=ForceParams[i];if(p!==Forces&&_.modified(p))sim[p](_[p])}for(i=0,n=f.length;i<n;++i){name=Forces+i;p=init||_.modified(Forces,i)?getForce(f[i]):pulse&&modified(f[i],pulse)?sim.force(name):null;if(p)sim.force(name,p)}for(n=sim.numForces||0;i<n;++i){sim.force(Forces+i,null)}sim.numForces=f.length;return sim}function modified(f,pulse){var k,v;for(k in f){if(isFunction(v=f[k])&&pulse.modified(accessorFields(v)))return 1}return 0}function getForce(_){var f,p;if(!_has(ForceMap,_.force)){error("Unrecognized force: "+_.force)}f=ForceMap[_.force]();for(p in _){if(isFunction(f[p]))setForceParam(f[p],_[p],_)}return f}function setForceParam(f,v,_){f(isFunction(v)?function(d){return v(d,_)}:v)}var force=Object.freeze({__proto__:null,force:Force});function defaultSeparation(a,b){return a.parent===b.parent?1:2}function meanX(children){return children.reduce(meanXReduce,0)/children.length}function meanXReduce(x,c){return x+c.x}function maxY(children){return 1+children.reduce(maxYReduce,0)}function maxYReduce(y,c){return Math.max(y,c.y)}function leafLeft(node){var children;while(children=node.children){node=children[0]}return node}function leafRight(node){var children;while(children=node.children){node=children[children.length-1]}return node}function cluster(){var separation=defaultSeparation,dx=1,dy=1,nodeSize=false;function cluster(root){var previousNode,x=0;root.eachAfter((function(node){var children=node.children;if(children){node.x=meanX(children);node.y=maxY(children)}else{node.x=previousNode?x+=separation(node,previousNode):0;node.y=0;previousNode=node}}));var left=leafLeft(root),right=leafRight(root),x0=left.x-separation(left,right)/2,x1=right.x+separation(right,left)/2;return root.eachAfter(nodeSize?function(node){node.x=(node.x-root.x)*dx;node.y=(root.y-node.y)*dy}:function(node){node.x=(node.x-x0)/(x1-x0)*dx;node.y=(1-(root.y?node.y/root.y:1))*dy})}cluster.separation=function(x){return arguments.length?(separation=x,cluster):separation};cluster.size=function(x){return arguments.length?(nodeSize=false,dx=+x[0],dy=+x[1],cluster):nodeSize?null:[dx,dy]};cluster.nodeSize=function(x){return arguments.length?(nodeSize=true,dx=+x[0],dy=+x[1],cluster):nodeSize?[dx,dy]:null};return cluster}function count(node){var sum=0,children=node.children,i=children&&children.length;if(!i)sum=1;else while(--i>=0){sum+=children[i].value}node.value=sum}function node_count(){return this.eachAfter(count)}function node_each(callback,that){var index=-1;var _iterator=_createForOfIteratorHelper(this),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var node=_step.value;callback.call(that,node,++index,this)}}catch(err){_iterator.e(err)}finally{_iterator.f()}return this}function node_eachBefore(callback,that){var node=this,nodes=[node],children,i,index=-1;while(node=nodes.pop()){callback.call(that,node,++index,this);if(children=node.children){for(i=children.length-1;i>=0;--i){nodes.push(children[i])}}}return this}function node_eachAfter(callback,that){var node=this,nodes=[node],next=[],children,i,n,index=-1;while(node=nodes.pop()){next.push(node);if(children=node.children){for(i=0,n=children.length;i<n;++i){nodes.push(children[i])}}}while(node=next.pop()){callback.call(that,node,++index,this)}return this}function node_find(callback,that){var index=-1;var _iterator=_createForOfIteratorHelper(this),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var node=_step.value;if(callback.call(that,node,++index,this)){return node}}}catch(err){_iterator.e(err)}finally{_iterator.f()}}function node_sum(value){return this.eachAfter((function(node){var sum=+value(node.data)||0,children=node.children,i=children&&children.length;while(--i>=0){sum+=children[i].value}node.value=sum}))}function node_sort(compare){return this.eachBefore((function(node){if(node.children){node.children.sort(compare)}}))}function node_path(end){var start=this,ancestor=leastCommonAncestor(start,end),nodes=[start];while(start!==ancestor){start=start.parent;nodes.push(start)}var k=nodes.length;while(end!==ancestor){nodes.splice(k,0,end);end=end.parent}return nodes}function leastCommonAncestor(a,b){if(a===b)return a;var aNodes=a.ancestors(),bNodes=b.ancestors(),c=null;a=aNodes.pop();b=bNodes.pop();while(a===b){c=a;a=aNodes.pop();b=bNodes.pop()}return c}function node_ancestors(){var node=this,nodes=[node];while(node=node.parent){nodes.push(node)}return nodes}function node_descendants(){return Array.from(this)}function node_leaves(){var leaves=[];this.eachBefore((function(node){if(!node.children){leaves.push(node)}}));return leaves}function node_links(){var root=this,links=[];root.each((function(node){if(node!==root){links.push({source:node.parent,target:node})}}));return links}var _marked$3=regeneratorRuntime.mark(_callee);function _callee(){var node,current,next,children,i,n;return regeneratorRuntime.wrap((function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:node=this,next=[node];case 1:current=next.reverse(),next=[];case 2:if(!(node=current.pop())){_context.next=8;break}_context.next=5;return node;case 5:if(children=node.children){for(i=0,n=children.length;i<n;++i){next.push(children[i])}}_context.next=2;break;case 8:if(next.length){_context.next=1;break}case 9:case"end":return _context.stop()}}}),_marked$3,this)}function hierarchy(data,children){if(data instanceof Map){data=[undefined,data];if(children===undefined)children=mapChildren}else if(children===undefined){children=objectChildren}var root=new Node(data),node,nodes=[root],child,childs,i,n;while(node=nodes.pop()){if((childs=children(node.data))&&(n=(childs=Array.from(childs)).length)){node.children=childs;for(i=n-1;i>=0;--i){nodes.push(child=childs[i]=new Node(childs[i]));child.parent=node;child.depth=node.depth+1}}}return root.eachBefore(computeHeight)}function node_copy(){return hierarchy(this).eachBefore(copyData)}function objectChildren(d){return d.children}function mapChildren(d){return Array.isArray(d)?d[1]:null}function copyData(node){if(node.data.value!==undefined)node.value=node.data.value;node.data=node.data.data}function computeHeight(node){var height=0;do{node.height=height}while((node=node.parent)&&node.height<++height)}function Node(data){this.data=data;this.depth=this.height=0;this.parent=null}Node.prototype=hierarchy.prototype=_defineProperty({constructor:Node,count:node_count,each:node_each,eachAfter:node_eachAfter,eachBefore:node_eachBefore,find:node_find,sum:node_sum,sort:node_sort,path:node_path,ancestors:node_ancestors,descendants:node_descendants,leaves:node_leaves,links:node_links,copy:node_copy},Symbol.iterator,_callee);function array$3(x){return _typeof(x)==="object"&&"length"in x?x:Array.from(x)}function shuffle(array){var m=array.length,t,i;while(m){i=Math.random()*m--|0;t=array[m];array[m]=array[i];array[i]=t}return array}function enclose(circles){var i=0,n=(circles=shuffle(Array.from(circles))).length,B=[],p,e;while(i<n){p=circles[i];if(e&&enclosesWeak(e,p))++i;else e=encloseBasis(B=extendBasis(B,p)),i=0}return e}function extendBasis(B,p){var i,j;if(enclosesWeakAll(p,B))return[p];for(i=0;i<B.length;++i){if(enclosesNot(p,B[i])&&enclosesWeakAll(encloseBasis2(B[i],p),B)){return[B[i],p]}}for(i=0;i<B.length-1;++i){for(j=i+1;j<B.length;++j){if(enclosesNot(encloseBasis2(B[i],B[j]),p)&&enclosesNot(encloseBasis2(B[i],p),B[j])&&enclosesNot(encloseBasis2(B[j],p),B[i])&&enclosesWeakAll(encloseBasis3(B[i],B[j],p),B)){return[B[i],B[j],p]}}}throw new Error}function enclosesNot(a,b){var dr=a.r-b.r,dx=b.x-a.x,dy=b.y-a.y;return dr<0||dr*dr<dx*dx+dy*dy}function enclosesWeak(a,b){var dr=a.r-b.r+Math.max(a.r,b.r,1)*1e-9,dx=b.x-a.x,dy=b.y-a.y;return dr>0&&dr*dr>dx*dx+dy*dy}function enclosesWeakAll(a,B){for(var i=0;i<B.length;++i){if(!enclosesWeak(a,B[i])){return false}}return true}function encloseBasis(B){switch(B.length){case 1:return encloseBasis1(B[0]);case 2:return encloseBasis2(B[0],B[1]);case 3:return encloseBasis3(B[0],B[1],B[2])}}function encloseBasis1(a){return{x:a.x,y:a.y,r:a.r}}function encloseBasis2(a,b){var x1=a.x,y1=a.y,r1=a.r,x2=b.x,y2=b.y,r2=b.r,x21=x2-x1,y21=y2-y1,r21=r2-r1,l=Math.sqrt(x21*x21+y21*y21);return{x:(x1+x2+x21/l*r21)/2,y:(y1+y2+y21/l*r21)/2,r:(l+r1+r2)/2}}function encloseBasis3(a,b,c){var x1=a.x,y1=a.y,r1=a.r,x2=b.x,y2=b.y,r2=b.r,x3=c.x,y3=c.y,r3=c.r,a2=x1-x2,a3=x1-x3,b2=y1-y2,b3=y1-y3,c2=r2-r1,c3=r3-r1,d1=x1*x1+y1*y1-r1*r1,d2=d1-x2*x2-y2*y2+r2*r2,d3=d1-x3*x3-y3*y3+r3*r3,ab=a3*b2-a2*b3,xa=(b2*d3-b3*d2)/(ab*2)-x1,xb=(b3*c2-b2*c3)/ab,ya=(a3*d2-a2*d3)/(ab*2)-y1,yb=(a2*c3-a3*c2)/ab,A=xb*xb+yb*yb-1,B=2*(r1+xa*xb+ya*yb),C=xa*xa+ya*ya-r1*r1,r=-(A?(B+Math.sqrt(B*B-4*A*C))/(2*A):C/B);return{x:x1+xa+xb*r,y:y1+ya+yb*r,r:r}}function place(b,a,c){var dx=b.x-a.x,x,a2,dy=b.y-a.y,y,b2,d2=dx*dx+dy*dy;if(d2){a2=a.r+c.r,a2*=a2;b2=b.r+c.r,b2*=b2;if(a2>b2){x=(d2+b2-a2)/(2*d2);y=Math.sqrt(Math.max(0,b2/d2-x*x));c.x=b.x-x*dx-y*dy;c.y=b.y-x*dy+y*dx}else{x=(d2+a2-b2)/(2*d2);y=Math.sqrt(Math.max(0,a2/d2-x*x));c.x=a.x+x*dx-y*dy;c.y=a.y+x*dy+y*dx}}else{c.x=a.x+c.r;c.y=a.y}}function intersects(a,b){var dr=a.r+b.r-1e-6,dx=b.x-a.x,dy=b.y-a.y;return dr>0&&dr*dr>dx*dx+dy*dy}function score(node){var a=node._,b=node.next._,ab=a.r+b.r,dx=(a.x*b.r+b.x*a.r)/ab,dy=(a.y*b.r+b.y*a.r)/ab;return dx*dx+dy*dy}function Node$1(circle){this._=circle;this.next=null;this.previous=null}function packEnclose(circles){if(!(n=(circles=array$3(circles)).length))return 0;var a,b,c,n,aa,ca,i,j,k,sj,sk;a=circles[0],a.x=0,a.y=0;if(!(n>1))return a.r;b=circles[1],a.x=-b.r,b.x=a.r,b.y=0;if(!(n>2))return a.r+b.r;place(b,a,c=circles[2]);a=new Node$1(a),b=new Node$1(b),c=new Node$1(c);a.next=c.previous=b;b.next=a.previous=c;c.next=b.previous=a;pack:for(i=3;i<n;++i){place(a._,b._,c=circles[i]),c=new Node$1(c);j=b.next,k=a.previous,sj=b._.r,sk=a._.r;do{if(sj<=sk){if(intersects(j._,c._)){b=j,a.next=b,b.previous=a,--i;continue pack}sj+=j._.r,j=j.next}else{if(intersects(k._,c._)){a=k,a.next=b,b.previous=a,--i;continue pack}sk+=k._.r,k=k.previous}}while(j!==k.next);c.previous=a,c.next=b,a.next=b.previous=b=c;aa=score(a);while((c=c.next)!==b){if((ca=score(c))<aa){a=c,aa=ca}}b=a.next}a=[b._],c=b;while((c=c.next)!==b){a.push(c._)}c=enclose(a);for(i=0;i<n;++i){a=circles[i],a.x-=c.x,a.y-=c.y}return c.r}function optional(f){return f==null?null:required(f)}function required(f){if(typeof f!=="function")throw new Error;return f}function constantZero(){return 0}function constant$4(x){return function(){return x}}function defaultRadius(d){return Math.sqrt(d.value)}function pack(){var radius=null,dx=1,dy=1,padding=constantZero;function pack(root){root.x=dx/2,root.y=dy/2;if(radius){root.eachBefore(radiusLeaf(radius)).eachAfter(packChildren(padding,.5)).eachBefore(translateChild(1))}else{root.eachBefore(radiusLeaf(defaultRadius)).eachAfter(packChildren(constantZero,1)).eachAfter(packChildren(padding,root.r/Math.min(dx,dy))).eachBefore(translateChild(Math.min(dx,dy)/(2*root.r)))}return root}pack.radius=function(x){return arguments.length?(radius=optional(x),pack):radius};pack.size=function(x){return arguments.length?(dx=+x[0],dy=+x[1],pack):[dx,dy]};pack.padding=function(x){return arguments.length?(padding=typeof x==="function"?x:constant$4(+x),pack):padding};return pack}function radiusLeaf(radius){return function(node){if(!node.children){node.r=Math.max(0,+radius(node)||0)}}}function packChildren(padding,k){return function(node){if(children=node.children){var children,i,n=children.length,r=padding(node)*k||0,e;if(r)for(i=0;i<n;++i){children[i].r+=r}e=packEnclose(children);if(r)for(i=0;i<n;++i){children[i].r-=r}node.r=e+r}}}function translateChild(k){return function(node){var parent=node.parent;node.r*=k;if(parent){node.x=parent.x+k*node.x;node.y=parent.y+k*node.y}}}function roundNode(node){node.x0=Math.round(node.x0);node.y0=Math.round(node.y0);node.x1=Math.round(node.x1);node.y1=Math.round(node.y1)}function treemapDice(parent,x0,y0,x1,y1){var nodes=parent.children,node,i=-1,n=nodes.length,k=parent.value&&(x1-x0)/parent.value;while(++i<n){node=nodes[i],node.y0=y0,node.y1=y1;node.x0=x0,node.x1=x0+=node.value*k}}function partition$4(){var dx=1,dy=1,padding=0,round=false;function partition(root){var n=root.height+1;root.x0=root.y0=padding;root.x1=dx;root.y1=dy/n;root.eachBefore(positionNode(dy,n));if(round)root.eachBefore(roundNode);return root}function positionNode(dy,n){return function(node){if(node.children){treemapDice(node,node.x0,dy*(node.depth+1)/n,node.x1,dy*(node.depth+2)/n)}var x0=node.x0,y0=node.y0,x1=node.x1-padding,y1=node.y1-padding;if(x1<x0)x0=x1=(x0+x1)/2;if(y1<y0)y0=y1=(y0+y1)/2;node.x0=x0;node.y0=y0;node.x1=x1;node.y1=y1}}partition.round=function(x){return arguments.length?(round=!!x,partition):round};partition.size=function(x){return arguments.length?(dx=+x[0],dy=+x[1],partition):[dx,dy]};partition.padding=function(x){return arguments.length?(padding=+x,partition):padding};return partition}var preroot={depth:-1},ambiguous={};function defaultId(d){return d.id}function defaultParentId(d){return d.parentId}function stratify(){var id=defaultId,parentId=defaultParentId;function stratify(data){var nodes=Array.from(data),n=nodes.length,d,i,root,parent,node,nodeId,nodeKey,nodeByKey=new Map;for(i=0;i<n;++i){d=nodes[i],node=nodes[i]=new Node(d);if((nodeId=id(d,i,data))!=null&&(nodeId+="")){nodeKey=node.id=nodeId;nodeByKey.set(nodeKey,nodeByKey.has(nodeKey)?ambiguous:node)}if((nodeId=parentId(d,i,data))!=null&&(nodeId+="")){node.parent=nodeId}}for(i=0;i<n;++i){node=nodes[i];if(nodeId=node.parent){parent=nodeByKey.get(nodeId);if(!parent)throw new Error("missing: "+nodeId);if(parent===ambiguous)throw new Error("ambiguous: "+nodeId);if(parent.children)parent.children.push(node);else parent.children=[node];node.parent=parent}else{if(root)throw new Error("multiple roots");root=node}}if(!root)throw new Error("no root");root.parent=preroot;root.eachBefore((function(node){node.depth=node.parent.depth+1;--n})).eachBefore(computeHeight);root.parent=null;if(n>0)throw new Error("cycle");return root}stratify.id=function(x){return arguments.length?(id=required(x),stratify):id};stratify.parentId=function(x){return arguments.length?(parentId=required(x),stratify):parentId};return stratify}function defaultSeparation$1(a,b){return a.parent===b.parent?1:2}function nextLeft(v){var children=v.children;return children?children[0]:v.t}function nextRight(v){var children=v.children;return children?children[children.length-1]:v.t}function moveSubtree(wm,wp,shift){var change=shift/(wp.i-wm.i);wp.c-=change;wp.s+=shift;wm.c+=change;wp.z+=shift;wp.m+=shift}function executeShifts(v){var shift=0,change=0,children=v.children,i=children.length,w;while(--i>=0){w=children[i];w.z+=shift;w.m+=shift;shift+=w.s+(change+=w.c)}}function nextAncestor(vim,v,ancestor){return vim.a.parent===v.parent?vim.a:ancestor}function TreeNode(node,i){this._=node;this.parent=null;this.children=null;this.A=null;this.a=this;this.z=0;this.m=0;this.c=0;this.s=0;this.t=null;this.i=i}TreeNode.prototype=Object.create(Node.prototype);function treeRoot(root){var tree=new TreeNode(root,0),node,nodes=[tree],child,children,i,n;while(node=nodes.pop()){if(children=node._.children){node.children=new Array(n=children.length);for(i=n-1;i>=0;--i){nodes.push(child=node.children[i]=new TreeNode(children[i],i));child.parent=node}}}(tree.parent=new TreeNode(null,0)).children=[tree];return tree}function tree(){var separation=defaultSeparation$1,dx=1,dy=1,nodeSize=null;function tree(root){var t=treeRoot(root);t.eachAfter(firstWalk),t.parent.m=-t.z;t.eachBefore(secondWalk);if(nodeSize)root.eachBefore(sizeNode);else{var left=root,right=root,bottom=root;root.eachBefore((function(node){if(node.x<left.x)left=node;if(node.x>right.x)right=node;if(node.depth>bottom.depth)bottom=node}));var s=left===right?1:separation(left,right)/2,tx=s-left.x,kx=dx/(right.x+s+tx),ky=dy/(bottom.depth||1);root.eachBefore((function(node){node.x=(node.x+tx)*kx;node.y=node.depth*ky}))}return root}function firstWalk(v){var children=v.children,siblings=v.parent.children,w=v.i?siblings[v.i-1]:null;if(children){executeShifts(v);var midpoint=(children[0].z+children[children.length-1].z)/2;if(w){v.z=w.z+separation(v._,w._);v.m=v.z-midpoint}else{v.z=midpoint}}else if(w){v.z=w.z+separation(v._,w._)}v.parent.A=apportion(v,w,v.parent.A||siblings[0])}function secondWalk(v){v._.x=v.z+v.parent.m;v.m+=v.parent.m}function apportion(v,w,ancestor){if(w){var vip=v,vop=v,vim=w,vom=vip.parent.children[0],sip=vip.m,sop=vop.m,sim=vim.m,som=vom.m,shift;while(vim=nextRight(vim),vip=nextLeft(vip),vim&&vip){vom=nextLeft(vom);vop=nextRight(vop);vop.a=v;shift=vim.z+sim-vip.z-sip+separation(vim._,vip._);if(shift>0){moveSubtree(nextAncestor(vim,v,ancestor),v,shift);sip+=shift;sop+=shift}sim+=vim.m;sip+=vip.m;som+=vom.m;sop+=vop.m}if(vim&&!nextRight(vop)){vop.t=vim;vop.m+=sim-sop}if(vip&&!nextLeft(vom)){vom.t=vip;vom.m+=sip-som;ancestor=v}}return ancestor}function sizeNode(node){node.x*=dx;node.y=node.depth*dy}tree.separation=function(x){return arguments.length?(separation=x,tree):separation};tree.size=function(x){return arguments.length?(nodeSize=false,dx=+x[0],dy=+x[1],tree):nodeSize?null:[dx,dy]};tree.nodeSize=function(x){return arguments.length?(nodeSize=true,dx=+x[0],dy=+x[1],tree):nodeSize?[dx,dy]:null};return tree}function treemapSlice(parent,x0,y0,x1,y1){var nodes=parent.children,node,i=-1,n=nodes.length,k=parent.value&&(y1-y0)/parent.value;while(++i<n){node=nodes[i],node.x0=x0,node.x1=x1;node.y0=y0,node.y1=y0+=node.value*k}}var phi=(1+Math.sqrt(5))/2;function squarifyRatio(ratio,parent,x0,y0,x1,y1){var rows=[],nodes=parent.children,row,nodeValue,i0=0,i1=0,n=nodes.length,dx,dy,value=parent.value,sumValue,minValue,maxValue,newRatio,minRatio,alpha,beta;while(i0<n){dx=x1-x0,dy=y1-y0;do{sumValue=nodes[i1++].value}while(!sumValue&&i1<n);minValue=maxValue=sumValue;alpha=Math.max(dy/dx,dx/dy)/(value*ratio);beta=sumValue*sumValue*alpha;minRatio=Math.max(maxValue/beta,beta/minValue);for(;i1<n;++i1){sumValue+=nodeValue=nodes[i1].value;if(nodeValue<minValue)minValue=nodeValue;if(nodeValue>maxValue)maxValue=nodeValue;beta=sumValue*sumValue*alpha;newRatio=Math.max(maxValue/beta,beta/minValue);if(newRatio>minRatio){sumValue-=nodeValue;break}minRatio=newRatio}rows.push(row={value:sumValue,dice:dx<dy,children:nodes.slice(i0,i1)});if(row.dice)treemapDice(row,x0,y0,x1,value?y0+=dy*sumValue/value:y1);else treemapSlice(row,x0,y0,value?x0+=dx*sumValue/value:x1,y1);value-=sumValue,i0=i1}return rows}var treemapSquarify=function custom(ratio){function squarify(parent,x0,y0,x1,y1){squarifyRatio(ratio,parent,x0,y0,x1,y1)}squarify.ratio=function(x){return custom((x=+x)>1?x:1)};return squarify}(phi);function treemap(){var tile=treemapSquarify,round=false,dx=1,dy=1,paddingStack=[0],paddingInner=constantZero,paddingTop=constantZero,paddingRight=constantZero,paddingBottom=constantZero,paddingLeft=constantZero;function treemap(root){root.x0=root.y0=0;root.x1=dx;root.y1=dy;root.eachBefore(positionNode);paddingStack=[0];if(round)root.eachBefore(roundNode);return root}function positionNode(node){var p=paddingStack[node.depth],x0=node.x0+p,y0=node.y0+p,x1=node.x1-p,y1=node.y1-p;if(x1<x0)x0=x1=(x0+x1)/2;if(y1<y0)y0=y1=(y0+y1)/2;node.x0=x0;node.y0=y0;node.x1=x1;node.y1=y1;if(node.children){p=paddingStack[node.depth+1]=paddingInner(node)/2;x0+=paddingLeft(node)-p;y0+=paddingTop(node)-p;x1-=paddingRight(node)-p;y1-=paddingBottom(node)-p;if(x1<x0)x0=x1=(x0+x1)/2;if(y1<y0)y0=y1=(y0+y1)/2;tile(node,x0,y0,x1,y1)}}treemap.round=function(x){return arguments.length?(round=!!x,treemap):round};treemap.size=function(x){return arguments.length?(dx=+x[0],dy=+x[1],treemap):[dx,dy]};treemap.tile=function(x){return arguments.length?(tile=required(x),treemap):tile};treemap.padding=function(x){return arguments.length?treemap.paddingInner(x).paddingOuter(x):treemap.paddingInner()};treemap.paddingInner=function(x){return arguments.length?(paddingInner=typeof x==="function"?x:constant$4(+x),treemap):paddingInner};treemap.paddingOuter=function(x){return arguments.length?treemap.paddingTop(x).paddingRight(x).paddingBottom(x).paddingLeft(x):treemap.paddingTop()};treemap.paddingTop=function(x){return arguments.length?(paddingTop=typeof x==="function"?x:constant$4(+x),treemap):paddingTop};treemap.paddingRight=function(x){return arguments.length?(paddingRight=typeof x==="function"?x:constant$4(+x),treemap):paddingRight};treemap.paddingBottom=function(x){return arguments.length?(paddingBottom=typeof x==="function"?x:constant$4(+x),treemap):paddingBottom};treemap.paddingLeft=function(x){return arguments.length?(paddingLeft=typeof x==="function"?x:constant$4(+x),treemap):paddingLeft};return treemap}function treemapBinary(parent,x0,y0,x1,y1){var nodes=parent.children,i,n=nodes.length,sum,sums=new Array(n+1);for(sums[0]=sum=i=0;i<n;++i){sums[i+1]=sum+=nodes[i].value}partition(0,n,parent.value,x0,y0,x1,y1);function partition(i,j,value,x0,y0,x1,y1){if(i>=j-1){var node=nodes[i];node.x0=x0,node.y0=y0;node.x1=x1,node.y1=y1;return}var valueOffset=sums[i],valueTarget=value/2+valueOffset,k=i+1,hi=j-1;while(k<hi){var mid=k+hi>>>1;if(sums[mid]<valueTarget)k=mid+1;else hi=mid}if(valueTarget-sums[k-1]<sums[k]-valueTarget&&i+1<k)--k;var valueLeft=sums[k]-valueOffset,valueRight=value-valueLeft;if(x1-x0>y1-y0){var xk=value?(x0*valueRight+x1*valueLeft)/value:x1;partition(i,k,valueLeft,x0,y0,xk,y1);partition(k,j,valueRight,xk,y0,x1,y1)}else{var yk=value?(y0*valueRight+y1*valueLeft)/value:y1;partition(i,k,valueLeft,x0,y0,x1,yk);partition(k,j,valueRight,x0,yk,x1,y1)}}}function treemapSliceDice(parent,x0,y0,x1,y1){(parent.depth&1?treemapSlice:treemapDice)(parent,x0,y0,x1,y1)}var treemapResquarify=function custom(ratio){function resquarify(parent,x0,y0,x1,y1){if((rows=parent._squarify)&&rows.ratio===ratio){var rows,row,nodes,i,j=-1,n,m=rows.length,value=parent.value;while(++j<m){row=rows[j],nodes=row.children;for(i=row.value=0,n=nodes.length;i<n;++i){row.value+=nodes[i].value}if(row.dice)treemapDice(row,x0,y0,x1,value?y0+=(y1-y0)*row.value/value:y1);else treemapSlice(row,x0,y0,value?x0+=(x1-x0)*row.value/value:x1,y1);value-=row.value}}else{parent._squarify=rows=squarifyRatio(ratio,parent,x0,y0,x1,y1);rows.ratio=ratio}}resquarify.ratio=function(x){return custom((x=+x)>1?x:1)};return resquarify}(phi);function lookup$2(tree,key,filter){var map={};tree.each((function(node){var t=node.data;if(filter(t))map[key(t)]=node}));tree.lookup=map;return tree}function Nest(params){Transform.call(this,null,params)}Nest.Definition={type:"Nest",metadata:{treesource:true,changes:true},params:[{name:"keys",type:"field",array:true},{name:"generate",type:"boolean"}]};var children=function children(n){return n.values};inherits(Nest,Transform,{transform:function transform(_,pulse){if(!pulse.source){error("Nest transform requires an upstream data source.")}var gen=_.generate,mod=_.modified(),out=pulse.clone(),tree=this.value;if(!tree||mod||pulse.changed()){if(tree){tree.each((function(node){if(node.children&&isTuple(node.data)){out.rem.push(node.data)}}))}this.value=tree=hierarchy({values:array(_.keys).reduce((function(n,k){n.key(k);return n}),nest()).entries(out.source)},children);if(gen){tree.each((function(node){if(node.children){node=ingest(node.data);out.add.push(node);out.source.push(node)}}))}lookup$2(tree,tupleid,tupleid)}out.source.root=tree;return out}});function nest(){var keys=[],nest={entries:function entries(array){return _entries(apply(array,0),0)},key:function key(d){return keys.push(d),nest}};function apply(array,depth){if(depth>=keys.length){return array}var n=array.length,key=keys[depth++],valuesByKey={},result={};var i=-1,keyValue,value,values;while(++i<n){keyValue=key(value=array[i])+"";if(values=valuesByKey[keyValue]){values.push(value)}else{valuesByKey[keyValue]=[value]}}for(keyValue in valuesByKey){result[keyValue]=apply(valuesByKey[keyValue],depth)}return result}function _entries(map,depth){if(++depth>keys.length)return map;var array=[];for(var key in map){array.push({key:key,values:_entries(map[key],depth)})}return array}return nest}function HierarchyLayout(params){Transform.call(this,null,params)}var defaultSeparation$2=function defaultSeparation(a,b){return a.parent===b.parent?1:2};inherits(HierarchyLayout,Transform,{transform:function transform(_,pulse){if(!pulse.source||!pulse.source.root){error(this.constructor.name+" transform requires a backing tree data source.")}var layout=this.layout(_.method),fields=this.fields,root=pulse.source.root,as=_.as||fields;if(_.field)root.sum(_.field);else root.count();if(_.sort)root.sort(stableCompare(_.sort,(function(d){return d.data})));setParams(layout,this.params,_);if(layout.separation){layout.separation(_.separation!==false?defaultSeparation$2:one)}try{this.value=layout(root)}catch(err){error(err)}root.each((function(node){return setFields(node,fields,as)}));return pulse.reflow(_.modified()).modifies(as).modifies("leaf")}});function setParams(layout,params,_){for(var p,i=0,n=params.length;i<n;++i){p=params[i];if(p in _)layout[p](_[p])}}function setFields(node,fields,as){var t=node.data,n=fields.length-1;for(var i=0;i<n;++i){t[as[i]]=node[fields[i]]}t[as[n]]=node.children?node.children.length:0}var Output$1=["x","y","r","depth","children"];function Pack(params){HierarchyLayout.call(this,params)}Pack.Definition={type:"Pack",metadata:{tree:true,modifies:true},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"padding",type:"number",default:0},{name:"radius",type:"field",default:null},{name:"size",type:"number",array:true,length:2},{name:"as",type:"string",array:true,length:Output$1.length,default:Output$1}]};inherits(Pack,HierarchyLayout,{layout:pack,params:["radius","size","padding"],fields:Output$1});var Output$1$1=["x0","y0","x1","y1","depth","children"];function Partition(params){HierarchyLayout.call(this,params)}Partition.Definition={type:"Partition",metadata:{tree:true,modifies:true},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"padding",type:"number",default:0},{name:"round",type:"boolean",default:false},{name:"size",type:"number",array:true,length:2},{name:"as",type:"string",array:true,length:Output$1$1.length,default:Output$1$1}]};inherits(Partition,HierarchyLayout,{layout:partition$4,params:["size","round","padding"],fields:Output$1$1});function Stratify(params){Transform.call(this,null,params)}Stratify.Definition={type:"Stratify",metadata:{treesource:true},params:[{name:"key",type:"field",required:true},{name:"parentKey",type:"field",required:true}]};inherits(Stratify,Transform,{transform:function transform(_,pulse){if(!pulse.source){error("Stratify transform requires an upstream data source.")}var tree=this.value;var mod=_.modified(),out=pulse.fork(pulse.ALL).materialize(pulse.SOURCE),run=!tree||mod||pulse.changed(pulse.ADD_REM)||pulse.modified(_.key.fields)||pulse.modified(_.parentKey.fields);out.source=out.source.slice();if(run){tree=out.source.length?lookup$2(stratify().id(_.key).parentId(_.parentKey)(out.source),_.key,truthy):lookup$2(stratify()([{}]),_.key,_.key)}out.source.root=this.value=tree;return out}});var Layouts={tidy:tree,cluster:cluster};var Output$2=["x","y","depth","children"];function Tree(params){HierarchyLayout.call(this,params)}Tree.Definition={type:"Tree",metadata:{tree:true,modifies:true},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"method",type:"enum",default:"tidy",values:["tidy","cluster"]},{name:"size",type:"number",array:true,length:2},{name:"nodeSize",type:"number",array:true,length:2},{name:"separation",type:"boolean",default:true},{name:"as",type:"string",array:true,length:Output$2.length,default:Output$2}]};inherits(Tree,HierarchyLayout,{layout:function layout(method){var m=method||"tidy";if(_has(Layouts,m))return Layouts[m]();else error("Unrecognized Tree layout method: "+m)},params:["size","nodeSize"],fields:Output$2});function TreeLinks(params){Transform.call(this,[],params)}TreeLinks.Definition={type:"TreeLinks",metadata:{tree:true,generates:true,changes:true},params:[]};inherits(TreeLinks,Transform,{transform:function transform(_,pulse){var links=this.value,tree=pulse.source&&pulse.source.root,out=pulse.fork(pulse.NO_SOURCE),lut={};if(!tree)error("TreeLinks transform requires a tree data source.");if(pulse.changed(pulse.ADD_REM)){out.rem=links;pulse.visit(pulse.SOURCE,(function(t){return lut[tupleid(t)]=1}));tree.each((function(node){var t=node.data,p=node.parent&&node.parent.data;if(p&&lut[tupleid(t)]&&lut[tupleid(p)]){out.add.push(ingest({source:p,target:t}))}}));this.value=out.add}else if(pulse.changed(pulse.MOD)){pulse.visit(pulse.MOD,(function(t){return lut[tupleid(t)]=1}));links.forEach((function(link){if(lut[tupleid(link.source)]||lut[tupleid(link.target)]){out.mod.push(link)}}))}return out}});var Tiles={binary:treemapBinary,dice:treemapDice,slice:treemapSlice,slicedice:treemapSliceDice,squarify:treemapSquarify,resquarify:treemapResquarify};var Output$3=["x0","y0","x1","y1","depth","children"];function Treemap(params){HierarchyLayout.call(this,params)}Treemap.Definition={type:"Treemap",metadata:{tree:true,modifies:true},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"method",type:"enum",default:"squarify",values:["squarify","resquarify","binary","dice","slice","slicedice"]},{name:"padding",type:"number",default:0},{name:"paddingInner",type:"number",default:0},{name:"paddingOuter",type:"number",default:0},{name:"paddingTop",type:"number",default:0},{name:"paddingRight",type:"number",default:0},{name:"paddingBottom",type:"number",default:0},{name:"paddingLeft",type:"number",default:0},{name:"ratio",type:"number",default:1.618033988749895},{name:"round",type:"boolean",default:false},{name:"size",type:"number",array:true,length:2},{name:"as",type:"string",array:true,length:Output$3.length,default:Output$3}]};inherits(Treemap,HierarchyLayout,{layout:function layout(){var x=treemap();x.ratio=function(_){var t=x.tile();if(t.ratio)x.tile(t.ratio(_))};x.method=function(_){if(_has(Tiles,_))x.tile(Tiles[_]);else error("Unrecognized Treemap layout method: "+_)};return x},params:["method","ratio","size","round","padding","paddingInner","paddingOuter","paddingTop","paddingRight","paddingBottom","paddingLeft"],fields:Output$3});var tree$1=Object.freeze({__proto__:null,nest:Nest,pack:Pack,partition:Partition,stratify:Stratify,tree:Tree,treelinks:TreeLinks,treemap:Treemap});var ALPHA_MASK=4278190080;var INSIDE_OPACITY_IN_ALPHA=268435456;var INSIDE_OPACITY=.0625;function baseBitmaps($,data){var bitmap=$.bitmap();(data||[]).forEach((function(d){return bitmap.set($(d.boundary[0]),$(d.boundary[3]))}));return[bitmap,undefined]}function markBitmaps($,avoidMarks,labelInside,isGroupArea){var width=$.width,height=$.height,border=labelInside||isGroupArea,context=domCanvas(width,height).getContext("2d");avoidMarks.forEach((function(items){return draw$5(context,items,border)}));var buffer=new Uint32Array(context.getImageData(0,0,width,height).data.buffer),layer1=$.bitmap(),layer2=border&&$.bitmap();var x,y,u,v,alpha;for(y=0;y<height;++y){for(x=0;x<width;++x){alpha=buffer[y*width+x]&ALPHA_MASK;if(alpha){u=$(x);v=$(y);if(!isGroupArea)layer1.set(u,v);if(border&&alpha^INSIDE_OPACITY_IN_ALPHA)layer2.set(u,v)}}}return[layer1,layer2]}function draw$5(context,items,interior){if(!items.length)return;var type=items[0].mark.marktype;if(type==="group"){items.forEach((function(group){group.items.forEach((function(mark){return draw$5(context,mark.items,interior)}))}))}else{Marks[type].draw(context,{items:interior?items.map(prepare):items})}}function prepare(source){var item=rederive(source,{});if(item.stroke){item.strokeOpacity=1}if(item.fill){item.fillOpacity=INSIDE_OPACITY;item.stroke="#000";item.strokeOpacity=1;item.strokeWidth=2}return item}var DIV=5,MOD$1=31,SIZE=32,RIGHT0=new Uint32Array(SIZE+1),RIGHT1=new Uint32Array(SIZE+1);RIGHT1[0]=0;RIGHT0[0]=~RIGHT1[0];for(var i=1;i<=SIZE;++i){RIGHT1[i]=RIGHT1[i-1]<<1|1;RIGHT0[i]=~RIGHT1[i]}function Bitmap(w,h){var array=new Uint32Array(~~((w*h+SIZE)/SIZE));function _set(index,mask){array[index]|=mask}function _clear(index,mask){array[index]&=mask}return{array:array,get:function get(x,y){var index=y*w+x;return array[index>>>DIV]&1<<(index&MOD$1)},set:function set(x,y){var index=y*w+x;_set(index>>>DIV,1<<(index&MOD$1))},clear:function clear(x,y){var index=y*w+x;_clear(index>>>DIV,~(1<<(index&MOD$1)))},getRange:function getRange(x,y,x2,y2){var r=y2,start,end,indexStart,indexEnd;for(;r>=y;--r){start=r*w+x;end=r*w+x2;indexStart=start>>>DIV;indexEnd=end>>>DIV;if(indexStart===indexEnd){if(array[indexStart]&RIGHT0[start&MOD$1]&RIGHT1[(end&MOD$1)+1]){return true}}else{if(array[indexStart]&RIGHT0[start&MOD$1])return true;if(array[indexEnd]&RIGHT1[(end&MOD$1)+1])return true;for(var _i=indexStart+1;_i<indexEnd;++_i){if(array[_i])return true}}}return false},setRange:function setRange(x,y,x2,y2){var start,end,indexStart,indexEnd,i;for(;y<=y2;++y){start=y*w+x;end=y*w+x2;indexStart=start>>>DIV;indexEnd=end>>>DIV;if(indexStart===indexEnd){_set(indexStart,RIGHT0[start&MOD$1]&RIGHT1[(end&MOD$1)+1])}else{_set(indexStart,RIGHT0[start&MOD$1]);_set(indexEnd,RIGHT1[(end&MOD$1)+1]);for(i=indexStart+1;i<indexEnd;++i){_set(i,4294967295)}}}},clearRange:function clearRange(x,y,x2,y2){var start,end,indexStart,indexEnd,i;for(;y<=y2;++y){start=y*w+x;end=y*w+x2;indexStart=start>>>DIV;indexEnd=end>>>DIV;if(indexStart===indexEnd){_clear(indexStart,RIGHT1[start&MOD$1]|RIGHT0[(end&MOD$1)+1])}else{_clear(indexStart,RIGHT1[start&MOD$1]);_clear(indexEnd,RIGHT0[(end&MOD$1)+1]);for(i=indexStart+1;i<indexEnd;++i){_clear(i,0)}}}},outOfBounds:function outOfBounds(x,y,x2,y2){return x<0||y<0||y2>=h||x2>=w}}}function scaler(width,height,padding){var ratio=Math.max(1,Math.sqrt(width*height/1e6)),w=~~((width+2*padding+ratio)/ratio),h=~~((height+2*padding+ratio)/ratio),scale=function scale(_){return~~((_+padding)/ratio)};scale.invert=function(_){return _*ratio-padding};scale.bitmap=function(){return Bitmap(w,h)};scale.ratio=ratio;scale.padding=padding;scale.width=width;scale.height=height;return scale}function placeAreaLabelNaive($,bitmaps,avoidBaseMark,markIndex){var width=$.width,height=$.height;return function(d){var items=d.datum.datum.items[markIndex].items,n=items.length,textHeight=d.datum.fontSize,textWidth=textMetrics.width(d.datum,d.datum.text);var maxAreaWidth=0,x1,x2,y1,y2,x,y,areaWidth;for(var _i2=0;_i2<n;++_i2){x1=items[_i2].x;y1=items[_i2].y;x2=items[_i2].x2===undefined?x1:items[_i2].x2;y2=items[_i2].y2===undefined?y1:items[_i2].y2;x=(x1+x2)/2;y=(y1+y2)/2;areaWidth=Math.abs(x2-x1+y2-y1);if(areaWidth>=maxAreaWidth){maxAreaWidth=areaWidth;d.x=x;d.y=y}}x=textWidth/2;y=textHeight/2;x1=d.x-x;x2=d.x+x;y1=d.y-y;y2=d.y+y;d.align="center";if(x1<0&&x2<=width){d.align="left"}else if(0<=x1&&width<x2){d.align="right"}d.baseline="middle";if(y1<0&&y2<=height){d.baseline="top"}else if(0<=y1&&height<y2){d.baseline="bottom"}return true}}function outOfBounds(x,y,textWidth,textHeight,width,height){var r=textWidth/2;return x-r<0||x+r>width||y-(r=textHeight/2)<0||y+r>height}function collision($,x,y,textHeight,textWidth,h,bm0,bm1){var w=textWidth*h/(textHeight*2),x1=$(x-w),x2=$(x+w),y1=$(y-(h=h/2)),y2=$(y+h);return bm0.outOfBounds(x1,y1,x2,y2)||bm0.getRange(x1,y1,x2,y2)||bm1&&bm1.getRange(x1,y1,x2,y2)}function placeAreaLabelReducedSearch($,bitmaps,avoidBaseMark,markIndex){var width=$.width,height=$.height,bm0=bitmaps[0],bm1=bitmaps[1];function tryLabel(_x,_y,maxSize,textWidth,textHeight){var x=$.invert(_x),y=$.invert(_y);var lo=maxSize,hi=height,mid;if(!outOfBounds(x,y,textWidth,textHeight,width,height)&&!collision($,x,y,textHeight,textWidth,lo,bm0,bm1)&&!collision($,x,y,textHeight,textWidth,textHeight,bm0,null)){while(hi-lo>=1){mid=(lo+hi)/2;if(collision($,x,y,textHeight,textWidth,mid,bm0,bm1)){hi=mid}else{lo=mid}}if(lo>maxSize){return[x,y,lo,true]}}}return function(d){var items=d.datum.datum.items[markIndex].items,n=items.length,textHeight=d.datum.fontSize,textWidth=textMetrics.width(d.datum,d.datum.text);var maxSize=avoidBaseMark?textHeight:0,labelPlaced=false,labelPlaced2=false,maxAreaWidth=0,x1,x2,y1,y2,x,y,_x,_y,_x1,_xMid,_x2,_y1,_yMid,_y2,areaWidth,result,swapTmp;for(var _i3=0;_i3<n;++_i3){x1=items[_i3].x;y1=items[_i3].y;x2=items[_i3].x2===undefined?x1:items[_i3].x2;y2=items[_i3].y2===undefined?y1:items[_i3].y2;if(x1>x2){swapTmp=x1;x1=x2;x2=swapTmp}if(y1>y2){swapTmp=y1;y1=y2;y2=swapTmp}_x1=$(x1);_x2=$(x2);_xMid=~~((_x1+_x2)/2);_y1=$(y1);_y2=$(y2);_yMid=~~((_y1+_y2)/2);for(_x=_xMid;_x>=_x1;--_x){for(_y=_yMid;_y>=_y1;--_y){result=tryLabel(_x,_y,maxSize,textWidth,textHeight);if(result){var _result=result;var _result2=_slicedToArray(_result,4);d.x=_result2[0];d.y=_result2[1];maxSize=_result2[2];labelPlaced=_result2[3]}}}for(_x=_xMid;_x<=_x2;++_x){for(_y=_yMid;_y<=_y2;++_y){result=tryLabel(_x,_y,maxSize,textWidth,textHeight);if(result){var _result3=result;var _result4=_slicedToArray(_result3,4);d.x=_result4[0];d.y=_result4[1];maxSize=_result4[2];labelPlaced=_result4[3]}}}if(!labelPlaced&&!avoidBaseMark){areaWidth=Math.abs(x2-x1+y2-y1);x=(x1+x2)/2;y=(y1+y2)/2;if(areaWidth>=maxAreaWidth&&!outOfBounds(x,y,textWidth,textHeight,width,height)&&!collision($,x,y,textHeight,textWidth,textHeight,bm0,null)){maxAreaWidth=areaWidth;d.x=x;d.y=y;labelPlaced2=true}}}if(labelPlaced||labelPlaced2){x=textWidth/2;y=textHeight/2;bm0.setRange($(d.x-x),$(d.y-y),$(d.x+x),$(d.y+y));d.align="center";d.baseline="middle";return true}else{return false}}}var X_DIR=[-1,-1,1,1];var Y_DIR=[-1,1,-1,1];function placeAreaLabelFloodFill($,bitmaps,avoidBaseMark,markIndex){var width=$.width,height=$.height,bm0=bitmaps[0],bm1=bitmaps[1],bm2=$.bitmap();return function(d){var items=d.datum.datum.items[markIndex].items,n=items.length,textHeight=d.datum.fontSize,textWidth=textMetrics.width(d.datum,d.datum.text),stack=[];var maxSize=avoidBaseMark?textHeight:0,labelPlaced=false,labelPlaced2=false,maxAreaWidth=0,x1,x2,y1,y2,x,y,_x,_y,lo,hi,mid,areaWidth;for(var _i4=0;_i4<n;++_i4){x1=items[_i4].x;y1=items[_i4].y;x2=items[_i4].x2===undefined?x1:items[_i4].x2;y2=items[_i4].y2===undefined?y1:items[_i4].y2;stack.push([$((x1+x2)/2),$((y1+y2)/2)]);while(stack.length){var _stack$pop=stack.pop();var _stack$pop2=_slicedToArray(_stack$pop,2);_x=_stack$pop2[0];_y=_stack$pop2[1];if(bm0.get(_x,_y)||bm1.get(_x,_y)||bm2.get(_x,_y))continue;bm2.set(_x,_y);for(var j=0;j<4;++j){x=_x+X_DIR[j];y=_y+Y_DIR[j];if(!bm2.outOfBounds(x,y,x,y))stack.push([x,y])}x=$.invert(_x);y=$.invert(_y);lo=maxSize;hi=height;if(!outOfBounds(x,y,textWidth,textHeight,width,height)&&!collision($,x,y,textHeight,textWidth,lo,bm0,bm1)&&!collision($,x,y,textHeight,textWidth,textHeight,bm0,null)){while(hi-lo>=1){mid=(lo+hi)/2;if(collision($,x,y,textHeight,textWidth,mid,bm0,bm1)){hi=mid}else{lo=mid}}if(lo>maxSize){d.x=x;d.y=y;maxSize=lo;labelPlaced=true}}}if(!labelPlaced&&!avoidBaseMark){areaWidth=Math.abs(x2-x1+y2-y1);x=(x1+x2)/2;y=(y1+y2)/2;if(areaWidth>=maxAreaWidth&&!outOfBounds(x,y,textWidth,textHeight,width,height)&&!collision($,x,y,textHeight,textWidth,textHeight,bm0,null)){maxAreaWidth=areaWidth;d.x=x;d.y=y;labelPlaced2=true}}}if(labelPlaced||labelPlaced2){x=textWidth/2;y=textHeight/2;bm0.setRange($(d.x-x),$(d.y-y),$(d.x+x),$(d.y+y));d.align="center";d.baseline="middle";return true}else{return false}}}var Aligns=["right","center","left"],Baselines=["bottom","middle","top"];function placeMarkLabel($,bitmaps,anchors,offsets){var width=$.width,height=$.height,bm0=bitmaps[0],bm1=bitmaps[1],n=offsets.length;return function(d){var boundary=d.boundary,textHeight=d.datum.fontSize;if(boundary[2]<0||boundary[5]<0||boundary[0]>width||boundary[3]>height){return false}var textWidth=0,dx,dy,isInside,sizeFactor,insideFactor,x1,x2,y1,y2,xc,yc,_x1,_x2,_y1,_y2;for(var _i5=0;_i5<n;++_i5){dx=(anchors[_i5]&3)-1;dy=(anchors[_i5]>>>2&3)-1;isInside=dx===0&&dy===0||offsets[_i5]<0;sizeFactor=dx&&dy?Math.SQRT1_2:1;insideFactor=offsets[_i5]<0?-1:1;x1=boundary[1+dx]+offsets[_i5]*dx*sizeFactor;yc=boundary[4+dy]+insideFactor*textHeight*dy/2+offsets[_i5]*dy*sizeFactor;y1=yc-textHeight/2;y2=yc+textHeight/2;_x1=$(x1);_y1=$(y1);_y2=$(y2);if(!textWidth){if(!test(_x1,_x1,_y1,_y2,bm0,bm1,x1,x1,y1,y2,boundary,isInside)){continue}else{textWidth=textMetrics.width(d.datum,d.datum.text)}}xc=x1+insideFactor*textWidth*dx/2;x1=xc-textWidth/2;x2=xc+textWidth/2;_x1=$(x1);_x2=$(x2);if(test(_x1,_x2,_y1,_y2,bm0,bm1,x1,x2,y1,y2,boundary,isInside)){d.x=!dx?xc:dx*insideFactor<0?x2:x1;d.y=!dy?yc:dy*insideFactor<0?y2:y1;d.align=Aligns[dx*insideFactor+1];d.baseline=Baselines[dy*insideFactor+1];bm0.setRange(_x1,_y1,_x2,_y2);return true}}return false}}function test(_x1,_x2,_y1,_y2,bm0,bm1,x1,x2,y1,y2,boundary,isInside){return!(bm0.outOfBounds(_x1,_y1,_x2,_y2)||(isInside&&bm1?bm1.getRange(_x1,_y1,_x2,_y2)||!isInMarkBound(x1,y1,x2,y2,boundary):bm0.getRange(_x1,_y1,_x2,_y2)))}function isInMarkBound(x1,y1,x2,y2,boundary){return boundary[0]<=x1&&x2<=boundary[2]&&boundary[3]<=y1&&y2<=boundary[5]}var TOP=0,MIDDLE=4,BOTTOM=8,LEFT=0,CENTER=1,RIGHT=2;var anchorCode={"top-left":TOP+LEFT,top:TOP+CENTER,"top-right":TOP+RIGHT,left:MIDDLE+LEFT,middle:MIDDLE+CENTER,right:MIDDLE+RIGHT,"bottom-left":BOTTOM+LEFT,bottom:BOTTOM+CENTER,"bottom-right":BOTTOM+RIGHT};var placeAreaLabel={naive:placeAreaLabelNaive,"reduced-search":placeAreaLabelReducedSearch,floodfill:placeAreaLabelFloodFill};function labelLayout(texts,size,compare,offset,anchor,avoidMarks,avoidBaseMark,lineAnchor,markIndex,padding,method){if(!texts.length)return texts;var positions=Math.max(offset.length,anchor.length),offsets=getOffsets(offset,positions),anchors=getAnchors(anchor,positions),marktype=markType(texts[0].datum),grouptype=marktype==="group"&&texts[0].datum.items[markIndex].marktype,isGroupArea=grouptype==="area",boundary=markBoundary(marktype,grouptype,lineAnchor,markIndex),$=scaler(size[0],size[1],padding),isNaiveGroupArea=isGroupArea&&method==="naive";var data=texts.map((function(d){return{datum:d,opacity:0,x:undefined,y:undefined,align:undefined,baseline:undefined,boundary:boundary(d)}}));var bitmaps;if(!isNaiveGroupArea){if(compare){data.sort((function(a,b){return compare(a.datum,b.datum)}))}var labelInside=false;for(var _i6=0;_i6<anchors.length&&!labelInside;++_i6){labelInside=anchors[_i6]===5||offsets[_i6]<0}if(marktype&&(avoidBaseMark||isGroupArea)){avoidMarks=[texts.map((function(d){return d.datum}))].concat(avoidMarks)}bitmaps=avoidMarks.length?markBitmaps($,avoidMarks,labelInside,isGroupArea):baseBitmaps($,avoidBaseMark&&data)}var place=isGroupArea?placeAreaLabel[method]($,bitmaps,avoidBaseMark,markIndex):placeMarkLabel($,bitmaps,anchors,offsets);data.forEach((function(d){return d.opacity=+place(d)}));return data}function getOffsets(_,count){var offsets=new Float64Array(count),n=_.length;for(var _i7=0;_i7<n;++_i7){offsets[_i7]=_[_i7]||0}for(var _i8=n;_i8<count;++_i8){offsets[_i8]=offsets[n-1]}return offsets}function getAnchors(_,count){var anchors=new Int8Array(count),n=_.length;for(var _i9=0;_i9<n;++_i9){anchors[_i9]|=anchorCode[_[_i9]]}for(var _i10=n;_i10<count;++_i10){anchors[_i10]=anchors[n-1]}return anchors}function markType(item){return item&&item.mark&&item.mark.marktype}function markBoundary(marktype,grouptype,lineAnchor,markIndex){var xy=function xy(d){return[d.x,d.x,d.x,d.y,d.y,d.y]};if(!marktype){return xy}else if(marktype==="line"||marktype==="area"){return function(d){return xy(d.datum)}}else if(grouptype==="line"){return function(d){var items=d.datum.items[markIndex].items;return xy(items.length?items[lineAnchor==="start"?0:items.length-1]:{x:NaN,y:NaN})}}else{return function(d){var b=d.datum.bounds;return[b.x1,(b.x1+b.x2)/2,b.x2,b.y1,(b.y1+b.y2)/2,b.y2]}}}var Output$4=["x","y","opacity","align","baseline"];var Anchors=["top-left","left","bottom-left","top","bottom","top-right","right","bottom-right"];function Label(params){Transform.call(this,null,params)}Label.Definition={type:"Label",metadata:{modifies:true},params:[{name:"size",type:"number",array:true,length:2,required:true},{name:"sort",type:"compare"},{name:"anchor",type:"string",array:true,default:Anchors},{name:"offset",type:"number",array:true,default:[1]},{name:"padding",type:"number",default:0},{name:"lineAnchor",type:"string",values:["start","end"],default:"end"},{name:"markIndex",type:"number",default:0},{name:"avoidBaseMark",type:"boolean",default:true},{name:"avoidMarks",type:"data",array:true},{name:"method",type:"string",default:"naive"},{name:"as",type:"string",array:true,length:Output$4.length,default:Output$4}]};inherits(Label,Transform,{transform:function transform(_,pulse){function modp(param){var p=_[param];return isFunction(p)&&pulse.modified(p.fields)}var mod=_.modified();if(!(mod||pulse.changed(pulse.ADD_REM)||modp("sort")))return;if(!_.size||_.size.length!==2){error("Size parameter should be specified as a [width, height] array.")}var as=_.as||Output$4;labelLayout(pulse.materialize(pulse.SOURCE).source,_.size,_.sort,array(_.offset||1),array(_.anchor||Anchors),_.avoidMarks||[],_.avoidBaseMark===false?false:true,_.lineAnchor||"end",_.markIndex||0,_.padding||0,_.method||"naive").forEach((function(l){var t=l.datum;t[as[0]]=l.x;t[as[1]]=l.y;t[as[2]]=l.opacity;t[as[3]]=l.align;t[as[4]]=l.baseline}));return pulse.reflow(mod).modifies(as)}});var label=Object.freeze({__proto__:null,label:Label});function partition$5(data,groupby){var groups=[],get=function get(f){return f(t)},map,i,n,t,k,g;if(groupby==null){groups.push(data)}else{for(map={},i=0,n=data.length;i<n;++i){t=data[i];k=groupby.map(get);g=map[k];if(!g){map[k]=g=[];g.dims=k;groups.push(g)}g.push(t)}}return groups}function Loess(params){Transform.call(this,null,params)}Loess.Definition={type:"Loess",metadata:{generates:true},params:[{name:"x",type:"field",required:true},{name:"y",type:"field",required:true},{name:"groupby",type:"field",array:true},{name:"bandwidth",type:"number",default:.3},{name:"as",type:"string",array:true}]};inherits(Loess,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS);if(!this.value||pulse.changed()||_.modified()){var source=pulse.materialize(pulse.SOURCE).source,groups=partition$5(source,_.groupby),names=(_.groupby||[]).map(accessorName),m=names.length,as=_.as||[accessorName(_.x),accessorName(_.y)],values=[];groups.forEach((function(g){loess(g,_.x,_.y,_.bandwidth||.3).forEach((function(p){var t={};for(var i=0;i<m;++i){t[names[i]]=g.dims[i]}t[as[0]]=p[0];t[as[1]]=p[1];values.push(ingest(t))}))}));if(this.value)out.rem=this.value;this.value=out.add=out.source=values}return out}});var Methods$1={linear:linear,log:log$2,exp:exp$1,pow:pow$1,quad:quad,poly:poly};var degreesOfFreedom=function degreesOfFreedom(method,order){return method==="poly"?order:method==="quad"?2:1};function Regression(params){Transform.call(this,null,params)}Regression.Definition={type:"Regression",metadata:{generates:true},params:[{name:"x",type:"field",required:true},{name:"y",type:"field",required:true},{name:"groupby",type:"field",array:true},{name:"method",type:"string",default:"linear",values:Object.keys(Methods$1)},{name:"order",type:"number",default:3},{name:"extent",type:"number",array:true,length:2},{name:"params",type:"boolean",default:false},{name:"as",type:"string",array:true}]};inherits(Regression,Transform,{transform:function transform(_,pulse){var out=pulse.fork(pulse.NO_SOURCE|pulse.NO_FIELDS);if(!this.value||pulse.changed()||_.modified()){var source=pulse.materialize(pulse.SOURCE).source,groups=partition$5(source,_.groupby),names=(_.groupby||[]).map(accessorName),method=_.method||"linear",order=_.order||3,dof=degreesOfFreedom(method,order),as=_.as||[accessorName(_.x),accessorName(_.y)],fit=Methods$1[method],values=[];var domain=_.extent;if(!_has(Methods$1,method)){error("Invalid regression method: "+method)}if(domain!=null){if(method==="log"&&domain[0]<=0){pulse.dataflow.warn("Ignoring extent with values <= 0 for log regression.");domain=null}}groups.forEach((function(g){var n=g.length;if(n<=dof){pulse.dataflow.warn("Skipping regression with more parameters than data points.");return}var model=fit(g,_.x,_.y,order);if(_.params){values.push(ingest({keys:g.dims,coef:model.coef,rSquared:model.rSquared}));return}var dom=domain||extent(g,_.x),add=function add(p){var t={};for(var i=0;i<names.length;++i){t[names[i]]=g.dims[i]}t[as[0]]=p[0];t[as[1]]=p[1];values.push(ingest(t))};if(method==="linear"){dom.forEach((function(x){return add([x,model.predict(x)])}))}else{sampleCurve(model.predict,dom,25,200).forEach(add)}}));if(this.value)out.rem=this.value;this.value=out.add=out.source=values}return out}});var reg=Object.freeze({__proto__:null,loess:Loess,regression:Regression});var EPSILON$2=Math.pow(2,-52);var EDGE_STACK=new Uint32Array(512);var Delaunator=function(){_createClass(Delaunator,null,[{key:"from",value:function from(points){var getX=arguments.length>1&&arguments[1]!==undefined?arguments[1]:defaultGetX;var getY=arguments.length>2&&arguments[2]!==undefined?arguments[2]:defaultGetY;var n=points.length;var coords=new Float64Array(n*2);for(var i=0;i<n;i++){var p=points[i];coords[2*i]=getX(p);coords[2*i+1]=getY(p)}return new Delaunator(coords)}}]);function Delaunator(coords){_classCallCheck(this,Delaunator);var n=coords.length>>1;if(n>0&&typeof coords[0]!=="number")throw new Error("Expected coords to contain numbers.");this.coords=coords;var maxTriangles=Math.max(2*n-5,0);this._triangles=new Uint32Array(maxTriangles*3);this._halfedges=new Int32Array(maxTriangles*3);this._hashSize=Math.ceil(Math.sqrt(n));this._hullPrev=new Uint32Array(n);this._hullNext=new Uint32Array(n);this._hullTri=new Uint32Array(n);this._hullHash=new Int32Array(this._hashSize).fill(-1);this._ids=new Uint32Array(n);this._dists=new Float64Array(n);this.update()}_createClass(Delaunator,[{key:"update",value:function update(){var coords=this.coords,hullPrev=this._hullPrev,hullNext=this._hullNext,hullTri=this._hullTri,hullHash=this._hullHash;var n=coords.length>>1;var minX=Infinity;var minY=Infinity;var maxX=-Infinity;var maxY=-Infinity;for(var i=0;i<n;i++){var x=coords[2*i];var y=coords[2*i+1];if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y;this._ids[i]=i}var cx=(minX+maxX)/2;var cy=(minY+maxY)/2;var minDist=Infinity;var i0,i1,i2;for(var _i=0;_i<n;_i++){var d=dist(cx,cy,coords[2*_i],coords[2*_i+1]);if(d<minDist){i0=_i;minDist=d}}var i0x=coords[2*i0];var i0y=coords[2*i0+1];minDist=Infinity;for(var _i2=0;_i2<n;_i2++){if(_i2===i0)continue;var _d=dist(i0x,i0y,coords[2*_i2],coords[2*_i2+1]);if(_d<minDist&&_d>0){i1=_i2;minDist=_d}}var i1x=coords[2*i1];var i1y=coords[2*i1+1];var minRadius=Infinity;for(var _i3=0;_i3<n;_i3++){if(_i3===i0||_i3===i1)continue;var r=circumradius(i0x,i0y,i1x,i1y,coords[2*_i3],coords[2*_i3+1]);if(r<minRadius){i2=_i3;minRadius=r}}var i2x=coords[2*i2];var i2y=coords[2*i2+1];if(minRadius===Infinity){for(var _i4=0;_i4<n;_i4++){this._dists[_i4]=coords[2*_i4]-coords[0]||coords[2*_i4+1]-coords[1]}quicksort(this._ids,this._dists,0,n-1);var hull=new Uint32Array(n);var j=0;for(var _i5=0,d0=-Infinity;_i5<n;_i5++){var id=this._ids[_i5];if(this._dists[id]>d0){hull[j++]=id;d0=this._dists[id]}}this.hull=hull.subarray(0,j);this.triangles=new Uint32Array(0);this.halfedges=new Uint32Array(0);return}if(orient(i0x,i0y,i1x,i1y,i2x,i2y)){var _i6=i1;var _x=i1x;var _y=i1y;i1=i2;i1x=i2x;i1y=i2y;i2=_i6;i2x=_x;i2y=_y}var center=circumcenter(i0x,i0y,i1x,i1y,i2x,i2y);this._cx=center.x;this._cy=center.y;for(var _i7=0;_i7<n;_i7++){this._dists[_i7]=dist(coords[2*_i7],coords[2*_i7+1],center.x,center.y)}quicksort(this._ids,this._dists,0,n-1);this._hullStart=i0;var hullSize=3;hullNext[i0]=hullPrev[i2]=i1;hullNext[i1]=hullPrev[i0]=i2;hullNext[i2]=hullPrev[i1]=i0;hullTri[i0]=0;hullTri[i1]=1;hullTri[i2]=2;hullHash.fill(-1);hullHash[this._hashKey(i0x,i0y)]=i0;hullHash[this._hashKey(i1x,i1y)]=i1;hullHash[this._hashKey(i2x,i2y)]=i2;this.trianglesLen=0;this._addTriangle(i0,i1,i2,-1,-1,-1);for(var k=0,xp,yp;k<this._ids.length;k++){var _i8=this._ids[k];var _x2=coords[2*_i8];var _y2=coords[2*_i8+1];if(k>0&&Math.abs(_x2-xp)<=EPSILON$2&&Math.abs(_y2-yp)<=EPSILON$2)continue;xp=_x2;yp=_y2;if(_i8===i0||_i8===i1||_i8===i2)continue;var start=0;for(var _j=0,key=this._hashKey(_x2,_y2);_j<this._hashSize;_j++){start=hullHash[(key+_j)%this._hashSize];if(start!==-1&&start!==hullNext[start])break}start=hullPrev[start];var e=start,q=void 0;while(q=hullNext[e],!orient(_x2,_y2,coords[2*e],coords[2*e+1],coords[2*q],coords[2*q+1])){e=q;if(e===start){e=-1;break}}if(e===-1)continue;var t=this._addTriangle(e,_i8,hullNext[e],-1,-1,hullTri[e]);hullTri[_i8]=this._legalize(t+2);hullTri[e]=t;hullSize++;var _n=hullNext[e];while(q=hullNext[_n],orient(_x2,_y2,coords[2*_n],coords[2*_n+1],coords[2*q],coords[2*q+1])){t=this._addTriangle(_n,_i8,q,hullTri[_i8],-1,hullTri[_n]);hullTri[_i8]=this._legalize(t+2);hullNext[_n]=_n;hullSize--;_n=q}if(e===start){while(q=hullPrev[e],orient(_x2,_y2,coords[2*q],coords[2*q+1],coords[2*e],coords[2*e+1])){t=this._addTriangle(q,_i8,e,-1,hullTri[e],hullTri[q]);this._legalize(t+2);hullTri[q]=t;hullNext[e]=e;hullSize--;e=q}}this._hullStart=hullPrev[_i8]=e;hullNext[e]=hullPrev[_n]=_i8;hullNext[_i8]=_n;hullHash[this._hashKey(_x2,_y2)]=_i8;hullHash[this._hashKey(coords[2*e],coords[2*e+1])]=e}this.hull=new Uint32Array(hullSize);for(var _i9=0,_e=this._hullStart;_i9<hullSize;_i9++){this.hull[_i9]=_e;_e=hullNext[_e]}this.triangles=this._triangles.subarray(0,this.trianglesLen);this.halfedges=this._halfedges.subarray(0,this.trianglesLen)}},{key:"_hashKey",value:function _hashKey(x,y){return Math.floor(pseudoAngle(x-this._cx,y-this._cy)*this._hashSize)%this._hashSize}},{key:"_legalize",value:function _legalize(a){var triangles=this._triangles,halfedges=this._halfedges,coords=this.coords;var i=0;var ar=0;while(true){var b=halfedges[a];var a0=a-a%3;ar=a0+(a+2)%3;if(b===-1){if(i===0)break;a=EDGE_STACK[--i];continue}var b0=b-b%3;var al=a0+(a+1)%3;var bl=b0+(b+2)%3;var p0=triangles[ar];var pr=triangles[a];var pl=triangles[al];var p1=triangles[bl];var illegal=inCircle(coords[2*p0],coords[2*p0+1],coords[2*pr],coords[2*pr+1],coords[2*pl],coords[2*pl+1],coords[2*p1],coords[2*p1+1]);if(illegal){triangles[a]=p1;triangles[b]=p0;var hbl=halfedges[bl];if(hbl===-1){var e=this._hullStart;do{if(this._hullTri[e]===bl){this._hullTri[e]=a;break}e=this._hullPrev[e]}while(e!==this._hullStart)}this._link(a,hbl);this._link(b,halfedges[ar]);this._link(ar,bl);var br=b0+(b+1)%3;if(i<EDGE_STACK.length){EDGE_STACK[i++]=br}}else{if(i===0)break;a=EDGE_STACK[--i]}}return ar}},{key:"_link",value:function _link(a,b){this._halfedges[a]=b;if(b!==-1)this._halfedges[b]=a}},{key:"_addTriangle",value:function _addTriangle(i0,i1,i2,a,b,c){var t=this.trianglesLen;this._triangles[t]=i0;this._triangles[t+1]=i1;this._triangles[t+2]=i2;this._link(t,a);this._link(t+1,b);this._link(t+2,c);this.trianglesLen+=3;return t}}]);return Delaunator}();function pseudoAngle(dx,dy){var p=dx/(Math.abs(dx)+Math.abs(dy));return(dy>0?3-p:1+p)/4}function dist(ax,ay,bx,by){var dx=ax-bx;var dy=ay-by;return dx*dx+dy*dy}function orientIfSure(px,py,rx,ry,qx,qy){var l=(ry-py)*(qx-px);var r=(rx-px)*(qy-py);return Math.abs(l-r)>=33306690738754716e-32*Math.abs(l+r)?l-r:0}function orient(rx,ry,qx,qy,px,py){var sign=orientIfSure(px,py,rx,ry,qx,qy)||orientIfSure(rx,ry,qx,qy,px,py)||orientIfSure(qx,qy,px,py,rx,ry);return sign<0}function inCircle(ax,ay,bx,by,cx,cy,px,py){var dx=ax-px;var dy=ay-py;var ex=bx-px;var ey=by-py;var fx=cx-px;var fy=cy-py;var ap=dx*dx+dy*dy;var bp=ex*ex+ey*ey;var cp=fx*fx+fy*fy;return dx*(ey*cp-bp*fy)-dy*(ex*cp-bp*fx)+ap*(ex*fy-ey*fx)<0}function circumradius(ax,ay,bx,by,cx,cy){var dx=bx-ax;var dy=by-ay;var ex=cx-ax;var ey=cy-ay;var bl=dx*dx+dy*dy;var cl=ex*ex+ey*ey;var d=.5/(dx*ey-dy*ex);var x=(ey*bl-dy*cl)*d;var y=(dx*cl-ex*bl)*d;return x*x+y*y}function circumcenter(ax,ay,bx,by,cx,cy){var dx=bx-ax;var dy=by-ay;var ex=cx-ax;var ey=cy-ay;var bl=dx*dx+dy*dy;var cl=ex*ex+ey*ey;var d=.5/(dx*ey-dy*ex);var x=ax+(ey*bl-dy*cl)*d;var y=ay+(dx*cl-ex*bl)*d;return{x:x,y:y}}function quicksort(ids,dists,left,right){if(right-left<=20){for(var i=left+1;i<=right;i++){var temp=ids[i];var tempDist=dists[temp];var j=i-1;while(j>=left&&dists[ids[j]]>tempDist){ids[j+1]=ids[j--]}ids[j+1]=temp}}else{var median=left+right>>1;var _i10=left+1;var _j2=right;swap$1(ids,median,_i10);if(dists[ids[left]]>dists[ids[right]])swap$1(ids,left,right);if(dists[ids[_i10]]>dists[ids[right]])swap$1(ids,_i10,right);if(dists[ids[left]]>dists[ids[_i10]])swap$1(ids,left,_i10);var _temp=ids[_i10];var _tempDist=dists[_temp];while(true){do{_i10++}while(dists[ids[_i10]]<_tempDist);do{_j2--}while(dists[ids[_j2]]>_tempDist);if(_j2<_i10)break;swap$1(ids,_i10,_j2)}ids[left+1]=ids[_j2];ids[_j2]=_temp;if(right-_i10+1>=_j2-left){quicksort(ids,dists,_i10,right);quicksort(ids,dists,left,_j2-1)}else{quicksort(ids,dists,left,_j2-1);quicksort(ids,dists,_i10,right)}}}function swap$1(arr,i,j){var tmp=arr[i];arr[i]=arr[j];arr[j]=tmp}function defaultGetX(p){return p[0]}function defaultGetY(p){return p[1]}var epsilon$5=1e-6;var Path$1=function(){function Path(){_classCallCheck(this,Path);this._x0=this._y0=this._x1=this._y1=null;this._=""}_createClass(Path,[{key:"moveTo",value:function moveTo(x,y){this._+="M".concat(this._x0=this._x1=+x,",").concat(this._y0=this._y1=+y)}},{key:"closePath",value:function closePath(){if(this._x1!==null){this._x1=this._x0,this._y1=this._y0;this._+="Z"}}},{key:"lineTo",value:function lineTo(x,y){this._+="L".concat(this._x1=+x,",").concat(this._y1=+y)}},{key:"arc",value:function arc(x,y,r){x=+x,y=+y,r=+r;var x0=x+r;var y0=y;if(r<0)throw new Error("negative radius");if(this._x1===null)this._+="M".concat(x0,",").concat(y0);else if(Math.abs(this._x1-x0)>epsilon$5||Math.abs(this._y1-y0)>epsilon$5)this._+="L"+x0+","+y0;if(!r)return;this._+="A".concat(r,",").concat(r,",0,1,1,").concat(x-r,",").concat(y,"A").concat(r,",").concat(r,",0,1,1,").concat(this._x1=x0,",").concat(this._y1=y0)}},{key:"rect",value:function rect(x,y,w,h){this._+="M".concat(this._x0=this._x1=+x,",").concat(this._y0=this._y1=+y,"h").concat(+w,"v").concat(+h,"h").concat(-w,"Z")}},{key:"value",value:function value(){return this._||null}}]);return Path}();var Polygon=function(){function Polygon(){_classCallCheck(this,Polygon);this._=[]}_createClass(Polygon,[{key:"moveTo",value:function moveTo(x,y){this._.push([x,y])}},{key:"closePath",value:function closePath(){this._.push(this._[0].slice())}},{key:"lineTo",value:function lineTo(x,y){this._.push([x,y])}},{key:"value",value:function value(){return this._.length?this._:null}}]);return Polygon}();var Voronoi=function(){function Voronoi(delaunay){var _ref=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[0,0,960,500],_ref2=_slicedToArray(_ref,4),xmin=_ref2[0],ymin=_ref2[1],xmax=_ref2[2],ymax=_ref2[3];_classCallCheck(this,Voronoi);if(!((xmax=+xmax)>=(xmin=+xmin))||!((ymax=+ymax)>=(ymin=+ymin)))throw new Error("invalid bounds");this.delaunay=delaunay;this._circumcenters=new Float64Array(delaunay.points.length*2);this.vectors=new Float64Array(delaunay.points.length*2);this.xmax=xmax,this.xmin=xmin;this.ymax=ymax,this.ymin=ymin;this._init()}_createClass(Voronoi,[{key:"update",value:function update(){this.delaunay.update();this._init();return this}},{key:"_init",value:function _init(){var _this$delaunay=this.delaunay,points=_this$delaunay.points,hull=_this$delaunay.hull,triangles=_this$delaunay.triangles,vectors=this.vectors;var circumcenters=this.circumcenters=this._circumcenters.subarray(0,triangles.length/3*2);for(var i=0,j=0,n=triangles.length,x,y;i<n;i+=3,j+=2){var t1=triangles[i]*2;var t2=triangles[i+1]*2;var t3=triangles[i+2]*2;var _x=points[t1];var _y=points[t1+1];var x2=points[t2];var y2=points[t2+1];var x3=points[t3];var y3=points[t3+1];var dx=x2-_x;var dy=y2-_y;var ex=x3-_x;var ey=y3-_y;var bl=dx*dx+dy*dy;var cl=ex*ex+ey*ey;var ab=(dx*ey-dy*ex)*2;if(!ab){x=(_x+x3)/2-1e8*ey;y=(_y+y3)/2+1e8*ex}else if(Math.abs(ab)<1e-8){x=(_x+x3)/2;y=(_y+y3)/2}else{var d=1/ab;x=_x+(ey*bl-dy*cl)*d;y=_y+(dx*cl-ex*bl)*d}circumcenters[j]=x;circumcenters[j+1]=y}var h=hull[hull.length-1];var p0,p1=h*4;var x0,x1=points[2*h];var y0,y1=points[2*h+1];vectors.fill(0);for(var _i=0;_i<hull.length;++_i){h=hull[_i];p0=p1,x0=x1,y0=y1;p1=h*4,x1=points[2*h],y1=points[2*h+1];vectors[p0+2]=vectors[p1]=y0-y1;vectors[p0+3]=vectors[p1+1]=x1-x0}}},{key:"render",value:function render(context){var buffer=context==null?context=new Path$1:undefined;var _this$delaunay2=this.delaunay,halfedges=_this$delaunay2.halfedges,inedges=_this$delaunay2.inedges,hull=_this$delaunay2.hull,circumcenters=this.circumcenters,vectors=this.vectors;if(hull.length<=1)return null;for(var i=0,n=halfedges.length;i<n;++i){var j=halfedges[i];if(j<i)continue;var ti=Math.floor(i/3)*2;var tj=Math.floor(j/3)*2;var xi=circumcenters[ti];var yi=circumcenters[ti+1];var xj=circumcenters[tj];var yj=circumcenters[tj+1];this._renderSegment(xi,yi,xj,yj,context)}var h0,h1=hull[hull.length-1];for(var _i2=0;_i2<hull.length;++_i2){h0=h1,h1=hull[_i2];var t=Math.floor(inedges[h1]/3)*2;var x=circumcenters[t];var y=circumcenters[t+1];var v=h0*4;var p=this._project(x,y,vectors[v+2],vectors[v+3]);if(p)this._renderSegment(x,y,p[0],p[1],context)}return buffer&&buffer.value()}},{key:"renderBounds",value:function renderBounds(context){var buffer=context==null?context=new Path$1:undefined;context.rect(this.xmin,this.ymin,this.xmax-this.xmin,this.ymax-this.ymin);return buffer&&buffer.value()}},{key:"renderCell",value:function renderCell(i,context){var buffer=context==null?context=new Path$1:undefined;var points=this._clip(i);if(points===null||!points.length)return;context.moveTo(points[0],points[1]);var n=points.length;while(points[0]===points[n-2]&&points[1]===points[n-1]&&n>1){n-=2}for(var _i3=2;_i3<n;_i3+=2){if(points[_i3]!==points[_i3-2]||points[_i3+1]!==points[_i3-1])context.lineTo(points[_i3],points[_i3+1])}context.closePath();return buffer&&buffer.value()}},{key:"cellPolygons",value:regeneratorRuntime.mark((function cellPolygons(){var points,i,n,cell;return regeneratorRuntime.wrap((function cellPolygons$(_context){while(1){switch(_context.prev=_context.next){case 0:points=this.delaunay.points;i=0,n=points.length/2;case 2:if(!(i<n)){_context.next=11;break}cell=this.cellPolygon(i);if(!cell){_context.next=8;break}cell.index=i;_context.next=8;return cell;case 8:++i;_context.next=2;break;case 11:case"end":return _context.stop()}}}),cellPolygons,this)}))},{key:"cellPolygon",value:function cellPolygon(i){var polygon=new Polygon;this.renderCell(i,polygon);return polygon.value()}},{key:"_renderSegment",value:function _renderSegment(x0,y0,x1,y1,context){var S;var c0=this._regioncode(x0,y0);var c1=this._regioncode(x1,y1);if(c0===0&&c1===0){context.moveTo(x0,y0);context.lineTo(x1,y1)}else if(S=this._clipSegment(x0,y0,x1,y1,c0,c1)){context.moveTo(S[0],S[1]);context.lineTo(S[2],S[3])}}},{key:"contains",value:function contains(i,x,y){if((x=+x,x!==x)||(y=+y,y!==y))return false;return this.delaunay._step(i,x,y)===i}},{key:"neighbors",value:regeneratorRuntime.mark((function neighbors(i){var ci,_iterator,_step,j,cj,ai,li,aj,lj;return regeneratorRuntime.wrap((function neighbors$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:ci=this._clip(i);if(!ci){_context2.next=33;break}_iterator=_createForOfIteratorHelper(this.delaunay.neighbors(i));_context2.prev=3;_iterator.s();case 5:if((_step=_iterator.n()).done){_context2.next=25;break}j=_step.value;cj=this._clip(j);if(!cj){_context2.next=23;break}ai=0,li=ci.length;case 10:if(!(ai<li)){_context2.next=23;break}aj=0,lj=cj.length;case 12:if(!(aj<lj)){_context2.next=20;break}if(!(ci[ai]==cj[aj]&&ci[ai+1]==cj[aj+1]&&ci[(ai+2)%li]==cj[(aj+lj-2)%lj]&&ci[(ai+3)%li]==cj[(aj+lj-1)%lj])){_context2.next=17;break}_context2.next=16;return j;case 16:return _context2.abrupt("break",23);case 17:aj+=2;_context2.next=12;break;case 20:ai+=2;_context2.next=10;break;case 23:_context2.next=5;break;case 25:_context2.next=30;break;case 27:_context2.prev=27;_context2.t0=_context2["catch"](3);_iterator.e(_context2.t0);case 30:_context2.prev=30;_iterator.f();return _context2.finish(30);case 33:case"end":return _context2.stop()}}}),neighbors,this,[[3,27,30,33]])}))},{key:"_cell",value:function _cell(i){var circumcenters=this.circumcenters,_this$delaunay3=this.delaunay,inedges=_this$delaunay3.inedges,halfedges=_this$delaunay3.halfedges,triangles=_this$delaunay3.triangles;var e0=inedges[i];if(e0===-1)return null;var points=[];var e=e0;do{var t=Math.floor(e/3);points.push(circumcenters[t*2],circumcenters[t*2+1]);e=e%3===2?e-2:e+1;if(triangles[e]!==i)break;e=halfedges[e]}while(e!==e0&&e!==-1);return points}},{key:"_clip",value:function _clip(i){if(i===0&&this.delaunay.hull.length===1){return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin]}var points=this._cell(i);if(points===null)return null;var V=this.vectors;var v=i*4;return V[v]||V[v+1]?this._clipInfinite(i,points,V[v],V[v+1],V[v+2],V[v+3]):this._clipFinite(i,points)}},{key:"_clipFinite",value:function _clipFinite(i,points){var n=points.length;var P=null;var x0,y0,x1=points[n-2],y1=points[n-1];var c0,c1=this._regioncode(x1,y1);var e0,e1;for(var j=0;j<n;j+=2){x0=x1,y0=y1,x1=points[j],y1=points[j+1];c0=c1,c1=this._regioncode(x1,y1);if(c0===0&&c1===0){e0=e1,e1=0;if(P)P.push(x1,y1);else P=[x1,y1]}else{var S=void 0,sx0=void 0,sy0=void 0,sx1=void 0,sy1=void 0;if(c0===0){if((S=this._clipSegment(x0,y0,x1,y1,c0,c1))===null)continue;var _S=S;var _S2=_slicedToArray(_S,4);sx0=_S2[0];sy0=_S2[1];sx1=_S2[2];sy1=_S2[3]}else{if((S=this._clipSegment(x1,y1,x0,y0,c1,c0))===null)continue;var _S3=S;var _S4=_slicedToArray(_S3,4);sx1=_S4[0];sy1=_S4[1];sx0=_S4[2];sy0=_S4[3];e0=e1,e1=this._edgecode(sx0,sy0);if(e0&&e1)this._edge(i,e0,e1,P,P.length);if(P)P.push(sx0,sy0);else P=[sx0,sy0]}e0=e1,e1=this._edgecode(sx1,sy1);if(e0&&e1)this._edge(i,e0,e1,P,P.length);if(P)P.push(sx1,sy1);else P=[sx1,sy1]}}if(P){e0=e1,e1=this._edgecode(P[0],P[1]);if(e0&&e1)this._edge(i,e0,e1,P,P.length)}else if(this.contains(i,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)){return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin]}return P}},{key:"_clipSegment",value:function _clipSegment(x0,y0,x1,y1,c0,c1){while(true){if(c0===0&&c1===0)return[x0,y0,x1,y1];if(c0&c1)return null;var x=void 0,y=void 0,c=c0||c1;if(c&8)x=x0+(x1-x0)*(this.ymax-y0)/(y1-y0),y=this.ymax;else if(c&4)x=x0+(x1-x0)*(this.ymin-y0)/(y1-y0),y=this.ymin;else if(c&2)y=y0+(y1-y0)*(this.xmax-x0)/(x1-x0),x=this.xmax;else y=y0+(y1-y0)*(this.xmin-x0)/(x1-x0),x=this.xmin;if(c0)x0=x,y0=y,c0=this._regioncode(x0,y0);else x1=x,y1=y,c1=this._regioncode(x1,y1)}}},{key:"_clipInfinite",value:function _clipInfinite(i,points,vx0,vy0,vxn,vyn){var P=Array.from(points),p;if(p=this._project(P[0],P[1],vx0,vy0))P.unshift(p[0],p[1]);if(p=this._project(P[P.length-2],P[P.length-1],vxn,vyn))P.push(p[0],p[1]);if(P=this._clipFinite(i,P)){for(var j=0,n=P.length,c0,c1=this._edgecode(P[n-2],P[n-1]);j<n;j+=2){c0=c1,c1=this._edgecode(P[j],P[j+1]);if(c0&&c1)j=this._edge(i,c0,c1,P,j),n=P.length}}else if(this.contains(i,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)){P=[this.xmin,this.ymin,this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax]}return P}},{key:"_edge",value:function _edge(i,e0,e1,P,j){while(e0!==e1){var x=void 0,y=void 0;switch(e0){case 5:e0=4;continue;case 4:e0=6,x=this.xmax,y=this.ymin;break;case 6:e0=2;continue;case 2:e0=10,x=this.xmax,y=this.ymax;break;case 10:e0=8;continue;case 8:e0=9,x=this.xmin,y=this.ymax;break;case 9:e0=1;continue;case 1:e0=5,x=this.xmin,y=this.ymin;break}if((P[j]!==x||P[j+1]!==y)&&this.contains(i,x,y)){P.splice(j,0,x,y),j+=2}}if(P.length>4){for(var _i4=0;_i4<P.length;_i4+=2){var _j=(_i4+2)%P.length,k=(_i4+4)%P.length;if(P[_i4]===P[_j]&&P[_j]===P[k]||P[_i4+1]===P[_j+1]&&P[_j+1]===P[k+1])P.splice(_j,2),_i4-=2}}return j}},{key:"_project",value:function _project(x0,y0,vx,vy){var t=Infinity,c,x,y;if(vy<0){if(y0<=this.ymin)return null;if((c=(this.ymin-y0)/vy)<t)y=this.ymin,x=x0+(t=c)*vx}else if(vy>0){if(y0>=this.ymax)return null;if((c=(this.ymax-y0)/vy)<t)y=this.ymax,x=x0+(t=c)*vx}if(vx>0){if(x0>=this.xmax)return null;if((c=(this.xmax-x0)/vx)<t)x=this.xmax,y=y0+(t=c)*vy}else if(vx<0){if(x0<=this.xmin)return null;if((c=(this.xmin-x0)/vx)<t)x=this.xmin,y=y0+(t=c)*vy}return[x,y]}},{key:"_edgecode",value:function _edgecode(x,y){return(x===this.xmin?1:x===this.xmax?2:0)|(y===this.ymin?4:y===this.ymax?8:0)}},{key:"_regioncode",value:function _regioncode(x,y){return(x<this.xmin?1:x>this.xmax?2:0)|(y<this.ymin?4:y>this.ymax?8:0)}}]);return Voronoi}();var _marked$4=regeneratorRuntime.mark(flatIterable);var tau$3=2*Math.PI,pow$4=Math.pow;function pointX(p){return p[0]}function pointY(p){return p[1]}function collinear$1(d){var triangles=d.triangles,coords=d.coords;for(var i=0;i<triangles.length;i+=3){var a=2*triangles[i],b=2*triangles[i+1],c=2*triangles[i+2],cross=(coords[c]-coords[a])*(coords[b+1]-coords[a+1])-(coords[b]-coords[a])*(coords[c+1]-coords[a+1]);if(cross>1e-10)return false}return true}function jitter(x,y,r){return[x+Math.sin(x+y)*r,y+Math.cos(x-y)*r]}var Delaunay=function(){_createClass(Delaunay,null,[{key:"from",value:function from(points){var fx=arguments.length>1&&arguments[1]!==undefined?arguments[1]:pointX;var fy=arguments.length>2&&arguments[2]!==undefined?arguments[2]:pointY;var that=arguments.length>3?arguments[3]:undefined;return new Delaunay("length"in points?flatArray(points,fx,fy,that):Float64Array.from(flatIterable(points,fx,fy,that)))}}]);function Delaunay(points){_classCallCheck(this,Delaunay);this._delaunator=new Delaunator(points);this.inedges=new Int32Array(points.length/2);this._hullIndex=new Int32Array(points.length/2);this.points=this._delaunator.coords;this._init()}_createClass(Delaunay,[{key:"update",value:function update(){this._delaunator.update();this._init();return this}},{key:"_init",value:function _init(){var d=this._delaunator,points=this.points;if(d.hull&&d.hull.length>2&&collinear$1(d)){this.collinear=Int32Array.from({length:points.length/2},(function(_,i){return i})).sort((function(i,j){return points[2*i]-points[2*j]||points[2*i+1]-points[2*j+1]}));var e=this.collinear[0],f=this.collinear[this.collinear.length-1],bounds=[points[2*e],points[2*e+1],points[2*f],points[2*f+1]],r=1e-8*Math.hypot(bounds[3]-bounds[1],bounds[2]-bounds[0]);for(var i=0,n=points.length/2;i<n;++i){var p=jitter(points[2*i],points[2*i+1],r);points[2*i]=p[0];points[2*i+1]=p[1]}this._delaunator=new Delaunator(points)}else{delete this.collinear}var halfedges=this.halfedges=this._delaunator.halfedges;var hull=this.hull=this._delaunator.hull;var triangles=this.triangles=this._delaunator.triangles;var inedges=this.inedges.fill(-1);var hullIndex=this._hullIndex.fill(-1);for(var _e=0,_n=halfedges.length;_e<_n;++_e){var _p=triangles[_e%3===2?_e-2:_e+1];if(halfedges[_e]===-1||inedges[_p]===-1)inedges[_p]=_e}for(var _i=0,_n2=hull.length;_i<_n2;++_i){hullIndex[hull[_i]]=_i}if(hull.length<=2&&hull.length>0){this.triangles=new Int32Array(3).fill(-1);this.halfedges=new Int32Array(3).fill(-1);this.triangles[0]=hull[0];this.triangles[1]=hull[1];this.triangles[2]=hull[1];inedges[hull[0]]=1;if(hull.length===2)inedges[hull[1]]=0}}},{key:"voronoi",value:function voronoi(bounds){return new Voronoi(this,bounds)}},{key:"neighbors",value:regeneratorRuntime.mark((function neighbors(i){var inedges,hull,_hullIndex,halfedges,triangles,collinear,l,e0,e,p0,p;return regeneratorRuntime.wrap((function neighbors$(_context){while(1){switch(_context.prev=_context.next){case 0:inedges=this.inedges,hull=this.hull,_hullIndex=this._hullIndex,halfedges=this.halfedges,triangles=this.triangles,collinear=this.collinear;if(!collinear){_context.next=10;break}l=collinear.indexOf(i);if(!(l>0)){_context.next=6;break}_context.next=6;return collinear[l-1];case 6:if(!(l<collinear.length-1)){_context.next=9;break}_context.next=9;return collinear[l+1];case 9:return _context.abrupt("return");case 10:e0=inedges[i];if(!(e0===-1)){_context.next=13;break}return _context.abrupt("return");case 13:e=e0,p0=-1;case 14:_context.next=16;return p0=triangles[e];case 16:e=e%3===2?e-2:e+1;if(!(triangles[e]!==i)){_context.next=19;break}return _context.abrupt("return");case 19:e=halfedges[e];if(!(e===-1)){_context.next=26;break}p=hull[(_hullIndex[i]+1)%hull.length];if(!(p!==p0)){_context.next=25;break}_context.next=25;return p;case 25:return _context.abrupt("return");case 26:if(e!==e0){_context.next=14;break}case 27:case"end":return _context.stop()}}}),neighbors,this)}))},{key:"find",value:function find(x,y){var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;if((x=+x,x!==x)||(y=+y,y!==y))return-1;var i0=i;var c;while((c=this._step(i,x,y))>=0&&c!==i&&c!==i0){i=c}return c}},{key:"_step",value:function _step(i,x,y){var inedges=this.inedges,hull=this.hull,_hullIndex=this._hullIndex,halfedges=this.halfedges,triangles=this.triangles,points=this.points;if(inedges[i]===-1||!points.length)return(i+1)%(points.length>>1);var c=i;var dc=pow$4(x-points[i*2],2)+pow$4(y-points[i*2+1],2);var e0=inedges[i];var e=e0;do{var t=triangles[e];var dt=pow$4(x-points[t*2],2)+pow$4(y-points[t*2+1],2);if(dt<dc)dc=dt,c=t;e=e%3===2?e-2:e+1;if(triangles[e]!==i)break;e=halfedges[e];if(e===-1){e=hull[(_hullIndex[i]+1)%hull.length];if(e!==t){if(pow$4(x-points[e*2],2)+pow$4(y-points[e*2+1],2)<dc)return e}break}}while(e!==e0);return c}},{key:"render",value:function render(context){var buffer=context==null?context=new Path$1:undefined;var points=this.points,halfedges=this.halfedges,triangles=this.triangles;for(var i=0,n=halfedges.length;i<n;++i){var j=halfedges[i];if(j<i)continue;var ti=triangles[i]*2;var tj=triangles[j]*2;context.moveTo(points[ti],points[ti+1]);context.lineTo(points[tj],points[tj+1])}this.renderHull(context);return buffer&&buffer.value()}},{key:"renderPoints",value:function renderPoints(context){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:2;var buffer=context==null?context=new Path$1:undefined;var points=this.points;for(var i=0,n=points.length;i<n;i+=2){var x=points[i],y=points[i+1];context.moveTo(x+r,y);context.arc(x,y,r,0,tau$3)}return buffer&&buffer.value()}},{key:"renderHull",value:function renderHull(context){var buffer=context==null?context=new Path$1:undefined;var hull=this.hull,points=this.points;var h=hull[0]*2,n=hull.length;context.moveTo(points[h],points[h+1]);for(var i=1;i<n;++i){var _h=2*hull[i];context.lineTo(points[_h],points[_h+1])}context.closePath();return buffer&&buffer.value()}},{key:"hullPolygon",value:function hullPolygon(){var polygon=new Polygon;this.renderHull(polygon);return polygon.value()}},{key:"renderTriangle",value:function renderTriangle(i,context){var buffer=context==null?context=new Path$1:undefined;var points=this.points,triangles=this.triangles;var t0=triangles[i*=3]*2;var t1=triangles[i+1]*2;var t2=triangles[i+2]*2;context.moveTo(points[t0],points[t0+1]);context.lineTo(points[t1],points[t1+1]);context.lineTo(points[t2],points[t2+1]);context.closePath();return buffer&&buffer.value()}},{key:"trianglePolygons",value:regeneratorRuntime.mark((function trianglePolygons(){var triangles,i,n;return regeneratorRuntime.wrap((function trianglePolygons$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:triangles=this.triangles;i=0,n=triangles.length/3;case 2:if(!(i<n)){_context2.next=8;break}_context2.next=5;return this.trianglePolygon(i);case 5:++i;_context2.next=2;break;case 8:case"end":return _context2.stop()}}}),trianglePolygons,this)}))},{key:"trianglePolygon",value:function trianglePolygon(i){var polygon=new Polygon;this.renderTriangle(i,polygon);return polygon.value()}}]);return Delaunay}();function flatArray(points,fx,fy,that){var n=points.length;var array=new Float64Array(n*2);for(var i=0;i<n;++i){var p=points[i];array[i*2]=fx.call(that,p,i,points);array[i*2+1]=fy.call(that,p,i,points)}return array}function flatIterable(points,fx,fy,that){var i,_iterator,_step2,p;return regeneratorRuntime.wrap((function flatIterable$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:i=0;_iterator=_createForOfIteratorHelper(points);_context3.prev=2;_iterator.s();case 4:if((_step2=_iterator.n()).done){_context3.next=13;break}p=_step2.value;_context3.next=8;return fx.call(that,p,i,points);case 8:_context3.next=10;return fy.call(that,p,i,points);case 10:++i;case 11:_context3.next=4;break;case 13:_context3.next=18;break;case 15:_context3.prev=15;_context3.t0=_context3["catch"](2);_iterator.e(_context3.t0);case 18:_context3.prev=18;_iterator.f();return _context3.finish(18);case 21:case"end":return _context3.stop()}}}),_marked$4,null,[[2,15,18,21]])}function Voronoi$1(params){Transform.call(this,null,params)}Voronoi$1.Definition={type:"Voronoi",metadata:{modifies:true},params:[{name:"x",type:"field",required:true},{name:"y",type:"field",required:true},{name:"size",type:"number",array:true,length:2},{name:"extent",type:"array",array:true,length:2,default:[[-1e5,-1e5],[1e5,1e5]],content:{type:"number",array:true,length:2}},{name:"as",type:"string",default:"path"}]};var defaultExtent=[-1e5,-1e5,1e5,1e5];inherits(Voronoi$1,Transform,{transform:function transform(_,pulse){var as=_.as||"path",data=pulse.source;if(!data||!data.length)return pulse;var s=_.size;s=s?[0,0,s[0],s[1]]:(s=_.extent)?[s[0][0],s[0][1],s[1][0],s[1][1]]:defaultExtent;var voronoi=this.value=Delaunay.from(data,_.x,_.y).voronoi(s);for(var i=0,n=data.length;i<n;++i){var polygon=voronoi.cellPolygon(i);data[i][as]=polygon?toPathString(polygon):null}return pulse.reflow(_.modified()).modifies(as)}});function toPathString(p){var x=p[0][0],y=p[0][1];var n=p.length-1;for(;p[n][0]===x&&p[n][1]===y;--n){}return"M"+p.slice(0,n+1).join("L")+"Z"}var voronoi=Object.freeze({__proto__:null,voronoi:Voronoi$1});var cloudRadians=Math.PI/180,cw=1<<11>>5,ch=1<<11;function cloud(){var size=[256,256],text,font,fontSize,fontStyle,fontWeight,rotate,padding,spiral=archimedeanSpiral,words=[],random=Math.random,cloud={};cloud.layout=function(){var contextAndRatio=getContext(domCanvas()),board=zeroArray((size[0]>>5)*size[1]),bounds=null,n=words.length,i=-1,tags=[],data=words.map((function(d){return{text:text(d),font:font(d),style:fontStyle(d),weight:fontWeight(d),rotate:rotate(d),size:~~(fontSize(d)+1e-14),padding:padding(d),xoff:0,yoff:0,x1:0,y1:0,x0:0,y0:0,hasText:false,sprite:null,datum:d}})).sort((function(a,b){return b.size-a.size}));while(++i<n){var d=data[i];d.x=size[0]*(random()+.5)>>1;d.y=size[1]*(random()+.5)>>1;cloudSprite(contextAndRatio,d,data,i);if(d.hasText&&place(board,d,bounds)){tags.push(d);if(bounds)cloudBounds(bounds,d);else bounds=[{x:d.x+d.x0,y:d.y+d.y0},{x:d.x+d.x1,y:d.y+d.y1}];d.x-=size[0]>>1;d.y-=size[1]>>1}}return tags};function getContext(canvas){canvas.width=canvas.height=1;var ratio=Math.sqrt(canvas.getContext("2d").getImageData(0,0,1,1).data.length>>2);canvas.width=(cw<<5)/ratio;canvas.height=ch/ratio;var context=canvas.getContext("2d");context.fillStyle=context.strokeStyle="red";context.textAlign="center";return{context:context,ratio:ratio}}function place(board,tag,bounds){var startX=tag.x,startY=tag.y,maxDelta=Math.sqrt(size[0]*size[0]+size[1]*size[1]),s=spiral(size),dt=random()<.5?1:-1,t=-dt,dxdy,dx,dy;while(dxdy=s(t+=dt)){dx=~~dxdy[0];dy=~~dxdy[1];if(Math.min(Math.abs(dx),Math.abs(dy))>=maxDelta)break;tag.x=startX+dx;tag.y=startY+dy;if(tag.x+tag.x0<0||tag.y+tag.y0<0||tag.x+tag.x1>size[0]||tag.y+tag.y1>size[1])continue;if(!bounds||!cloudCollide(tag,board,size[0])){if(!bounds||collideRects(tag,bounds)){var sprite=tag.sprite,w=tag.width>>5,sw=size[0]>>5,lx=tag.x-(w<<4),sx=lx&127,msx=32-sx,h=tag.y1-tag.y0,x=(tag.y+tag.y0)*sw+(lx>>5),last;for(var j=0;j<h;j++){last=0;for(var i=0;i<=w;i++){board[x+i]|=last<<msx|(i<w?(last=sprite[j*w+i])>>>sx:0)}x+=sw}tag.sprite=null;return true}}}return false}cloud.words=function(_){if(arguments.length){words=_;return cloud}else{return words}};cloud.size=function(_){if(arguments.length){size=[+_[0],+_[1]];return cloud}else{return size}};cloud.font=function(_){if(arguments.length){font=functor(_);return cloud}else{return font}};cloud.fontStyle=function(_){if(arguments.length){fontStyle=functor(_);return cloud}else{return fontStyle}};cloud.fontWeight=function(_){if(arguments.length){fontWeight=functor(_);return cloud}else{return fontWeight}};cloud.rotate=function(_){if(arguments.length){rotate=functor(_);return cloud}else{return rotate}};cloud.text=function(_){if(arguments.length){text=functor(_);return cloud}else{return text}};cloud.spiral=function(_){if(arguments.length){spiral=spirals[_]||_;return cloud}else{return spiral}};cloud.fontSize=function(_){if(arguments.length){fontSize=functor(_);return cloud}else{return fontSize}};cloud.padding=function(_){if(arguments.length){padding=functor(_);return cloud}else{return padding}};cloud.random=function(_){if(arguments.length){random=_;return cloud}else{return random}};return cloud}function cloudSprite(contextAndRatio,d,data,di){if(d.sprite)return;var c=contextAndRatio.context,ratio=contextAndRatio.ratio;c.clearRect(0,0,(cw<<5)/ratio,ch/ratio);var x=0,y=0,maxh=0,n=data.length,w,w32,h,i,j;--di;while(++di<n){d=data[di];c.save();c.font=d.style+" "+d.weight+" "+~~((d.size+1)/ratio)+"px "+d.font;w=c.measureText(d.text+"m").width*ratio;h=d.size<<1;if(d.rotate){var sr=Math.sin(d.rotate*cloudRadians),cr=Math.cos(d.rotate*cloudRadians),wcr=w*cr,wsr=w*sr,hcr=h*cr,hsr=h*sr;w=Math.max(Math.abs(wcr+hsr),Math.abs(wcr-hsr))+31>>5<<5;h=~~Math.max(Math.abs(wsr+hcr),Math.abs(wsr-hcr))}else{w=w+31>>5<<5}if(h>maxh)maxh=h;if(x+w>=cw<<5){x=0;y+=maxh;maxh=0}if(y+h>=ch)break;c.translate((x+(w>>1))/ratio,(y+(h>>1))/ratio);if(d.rotate)c.rotate(d.rotate*cloudRadians);c.fillText(d.text,0,0);if(d.padding){c.lineWidth=2*d.padding;c.strokeText(d.text,0,0)}c.restore();d.width=w;d.height=h;d.xoff=x;d.yoff=y;d.x1=w>>1;d.y1=h>>1;d.x0=-d.x1;d.y0=-d.y1;d.hasText=true;x+=w}var pixels=c.getImageData(0,0,(cw<<5)/ratio,ch/ratio).data,sprite=[];while(--di>=0){d=data[di];if(!d.hasText)continue;w=d.width;w32=w>>5;h=d.y1-d.y0;for(i=0;i<h*w32;i++){sprite[i]=0}x=d.xoff;if(x==null)return;y=d.yoff;var seen=0,seenRow=-1;for(j=0;j<h;j++){for(i=0;i<w;i++){var k=w32*j+(i>>5),m=pixels[(y+j)*(cw<<5)+(x+i)<<2]?1<<31-i%32:0;sprite[k]|=m;seen|=m}if(seen)seenRow=j;else{d.y0++;h--;j--;y++}}d.y1=d.y0+seenRow;d.sprite=sprite.slice(0,(d.y1-d.y0)*w32)}}function cloudCollide(tag,board,sw){sw>>=5;var sprite=tag.sprite,w=tag.width>>5,lx=tag.x-(w<<4),sx=lx&127,msx=32-sx,h=tag.y1-tag.y0,x=(tag.y+tag.y0)*sw+(lx>>5),last;for(var j=0;j<h;j++){last=0;for(var i=0;i<=w;i++){if((last<<msx|(i<w?(last=sprite[j*w+i])>>>sx:0))&board[x+i])return true}x+=sw}return false}function cloudBounds(bounds,d){var b0=bounds[0],b1=bounds[1];if(d.x+d.x0<b0.x)b0.x=d.x+d.x0;if(d.y+d.y0<b0.y)b0.y=d.y+d.y0;if(d.x+d.x1>b1.x)b1.x=d.x+d.x1;if(d.y+d.y1>b1.y)b1.y=d.y+d.y1}function collideRects(a,b){return a.x+a.x1>b[0].x&&a.x+a.x0<b[1].x&&a.y+a.y1>b[0].y&&a.y+a.y0<b[1].y}function archimedeanSpiral(size){var e=size[0]/size[1];return function(t){return[e*(t*=.1)*Math.cos(t),t*Math.sin(t)]}}function rectangularSpiral(size){var dy=4,dx=dy*size[0]/size[1],x=0,y=0;return function(t){var sign=t<0?-1:1;switch(Math.sqrt(1+4*sign*t)-sign&3){case 0:x+=dx;break;case 1:y+=dy;break;case 2:x-=dx;break;default:y-=dy;break}return[x,y]}}function zeroArray(n){var a=[],i=-1;while(++i<n){a[i]=0}return a}function functor(d){return typeof d==="function"?d:function(){return d}}var spirals={archimedean:archimedeanSpiral,rectangular:rectangularSpiral};var Output$5=["x","y","font","fontSize","fontStyle","fontWeight","angle"];var Params$1=["text","font","rotate","fontSize","fontStyle","fontWeight"];function Wordcloud(params){Transform.call(this,cloud(),params)}Wordcloud.Definition={type:"Wordcloud",metadata:{modifies:true},params:[{name:"size",type:"number",array:true,length:2},{name:"font",type:"string",expr:true,default:"sans-serif"},{name:"fontStyle",type:"string",expr:true,default:"normal"},{name:"fontWeight",type:"string",expr:true,default:"normal"},{name:"fontSize",type:"number",expr:true,default:14},{name:"fontSizeRange",type:"number",array:"nullable",default:[10,50]},{name:"rotate",type:"number",expr:true,default:0},{name:"text",type:"field"},{name:"spiral",type:"string",values:["archimedean","rectangular"]},{name:"padding",type:"number",expr:true},{name:"as",type:"string",array:true,length:7,default:Output$5}]};inherits(Wordcloud,Transform,{transform:function transform(_,pulse){if(_.size&&!(_.size[0]&&_.size[1])){error("Wordcloud size dimensions must be non-zero.")}function modp(param){var p=_[param];return isFunction(p)&&pulse.modified(p.fields)}var mod=_.modified();if(!(mod||pulse.changed(pulse.ADD_REM)||Params$1.some(modp)))return;var data=pulse.materialize(pulse.SOURCE).source,layout=this.value,as=_.as||Output$5;var fontSize=_.fontSize||14,range;isFunction(fontSize)?range=_.fontSizeRange:fontSize=constant(fontSize);if(range){var fsize=fontSize,sizeScale=scale("sqrt")().domain(extent(data,fsize)).range(range);fontSize=function fontSize(x){return sizeScale(fsize(x))}}data.forEach((function(t){t[as[0]]=NaN;t[as[1]]=NaN;t[as[3]]=0}));var words=layout.words(data).text(_.text).size(_.size||[500,500]).padding(_.padding||1).spiral(_.spiral||"archimedean").rotate(_.rotate||0).font(_.font||"sans-serif").fontStyle(_.fontStyle||"normal").fontWeight(_.fontWeight||"normal").fontSize(fontSize).random(exports.random).layout();var size=layout.size(),dx=size[0]>>1,dy=size[1]>>1,n=words.length;for(var i=0,w,t;i<n;++i){w=words[i];t=w.datum;t[as[0]]=w.x+dx;t[as[1]]=w.y+dy;t[as[2]]=w.font;t[as[3]]=w.size;t[as[4]]=w.style;t[as[5]]=w.weight;t[as[6]]=w.rotate}return pulse.reflow(mod).modifies(as)}});var wordcloud=Object.freeze({__proto__:null,wordcloud:Wordcloud});var array8=function array8(n){return new Uint8Array(n)};var array16=function array16(n){return new Uint16Array(n)};var array32=function array32(n){return new Uint32Array(n)};function Bitmaps(){var width=8,_data=[],_seen=array32(0),_curr=array$4(0,width),_prev=array$4(0,width);return{data:function data(){return _data},seen:function seen(){return _seen=lengthen(_seen,_data.length)},add:function add(array){for(var i=0,j=_data.length,n=array.length,t;i<n;++i){t=array[i];t._index=j++;_data.push(t)}},remove:function remove(num,map){var n=_data.length,copy=Array(n-num),reindex=_data;var t,i,j;for(i=0;!map[i]&&i<n;++i){copy[i]=_data[i];reindex[i]=i}for(j=i;i<n;++i){t=_data[i];if(!map[i]){reindex[i]=j;_curr[j]=_curr[i];_prev[j]=_prev[i];copy[j]=t;t._index=j++}else{reindex[i]=-1}_curr[i]=0}_data=copy;return reindex},size:function size(){return _data.length},curr:function curr(){return _curr},prev:function prev(){return _prev},reset:function reset(k){return _prev[k]=_curr[k]},all:function all(){return width<257?255:width<65537?65535:4294967295},set:function set(k,one){_curr[k]|=one},clear:function clear(k,one){_curr[k]&=~one},resize:function resize(n,m){var k=_curr.length;if(n>k||m>width){width=Math.max(m,width);_curr=array$4(n,width,_curr);_prev=array$4(n,width)}}}}function lengthen(array,length,copy){if(array.length>=length)return array;copy=copy||new array.constructor(length);copy.set(array);return copy}function array$4(n,m,array){var copy=(m<257?array8:m<65537?array16:array32)(n);if(array)copy.set(array);return copy}function Dimension(index,i,query){var bit=1<<i;return{one:bit,zero:~bit,range:query.slice(),bisect:index.bisect,index:index.index,size:index.size,onAdd:function onAdd(added,curr){var dim=this,range=dim.bisect(dim.range,added.value),idx=added.index,lo=range[0],hi=range[1],n1=idx.length;var i;for(i=0;i<lo;++i){curr[idx[i]]|=bit}for(i=hi;i<n1;++i){curr[idx[i]]|=bit}return dim}}}function SortedIndex(){var _index=array32(0),value=[],_size=0;function insert(key,data,base){if(!data.length)return[];var n0=_size,n1=data.length,addi=array32(n1);var addv=Array(n1),oldv,oldi,i;for(i=0;i<n1;++i){addv[i]=key(data[i]);addi[i]=i}addv=sort(addv,addi);if(n0){oldv=value;oldi=_index;value=Array(n0+n1);_index=array32(n0+n1);merge$2(base,oldv,oldi,n0,addv,addi,n1,value,_index)}else{if(base>0)for(i=0;i<n1;++i){addi[i]+=base}value=addv;_index=addi}_size=n0+n1;return{index:addi,value:addv}}function remove(num,map){var n=_size;var idx,i,j;for(i=0;!map[_index[i]]&&i<n;++i){}for(j=i;i<n;++i){if(!map[idx=_index[i]]){_index[j]=idx;value[j]=value[i];++j}}_size=n-num}function reindex(map){for(var i=0,n=_size;i<n;++i){_index[i]=map[_index[i]]}}function bisect(range,array){var n;if(array){n=array.length}else{array=value;n=_size}return[bisectLeft(array,range[0],0,n),bisectRight(array,range[1],0,n)]}return{insert:insert,remove:remove,bisect:bisect,reindex:reindex,index:function index(){return _index},size:function size(){return _size}}}function sort(values,index){values.sort.call(index,(function(a,b){var x=values[a],y=values[b];return x<y?-1:x>y?1:0}));return permute(values,index)}function merge$2(base,value0,index0,n0,value1,index1,n1,value,index){var i0=0,i1=0,i;for(i=0;i0<n0&&i1<n1;++i){if(value0[i0]<value1[i1]){value[i]=value0[i0];index[i]=index0[i0++]}else{value[i]=value1[i1];index[i]=index1[i1++]+base}}for(;i0<n0;++i0,++i){value[i]=value0[i0];index[i]=index0[i0]}for(;i1<n1;++i1,++i){value[i]=value1[i1];index[i]=index1[i1]+base}}function CrossFilter(params){Transform.call(this,Bitmaps(),params);this._indices=null;this._dims=null}CrossFilter.Definition={type:"CrossFilter",metadata:{},params:[{name:"fields",type:"field",array:true,required:true},{name:"query",type:"array",array:true,required:true,content:{type:"number",array:true,length:2}}]};inherits(CrossFilter,Transform,{transform:function transform(_,pulse){if(!this._dims){return this.init(_,pulse)}else{var init=_.modified("fields")||_.fields.some((function(f){return pulse.modified(f.fields)}));return init?this.reinit(_,pulse):this.eval(_,pulse)}},init:function init(_,pulse){var fields=_.fields,query=_.query,indices=this._indices={},dims=this._dims=[],m=query.length;var i=0,key,index;for(;i<m;++i){key=fields[i].fname;index=indices[key]||(indices[key]=SortedIndex());dims.push(Dimension(index,i,query[i]))}return this.eval(_,pulse)},reinit:function reinit(_,pulse){var output=pulse.materialize().fork(),fields=_.fields,query=_.query,indices=this._indices,dims=this._dims,bits=this.value,curr=bits.curr(),prev=bits.prev(),all=bits.all(),out=output.rem=output.add,mod=output.mod,m=query.length,adds={};var add,index,key,mods,remMap,modMap,i,n,f;prev.set(curr);if(pulse.rem.length){remMap=this.remove(_,pulse,output)}if(pulse.add.length){bits.add(pulse.add)}if(pulse.mod.length){modMap={};for(mods=pulse.mod,i=0,n=mods.length;i<n;++i){modMap[mods[i]._index]=1}}for(i=0;i<m;++i){f=fields[i];if(!dims[i]||_.modified("fields",i)||pulse.modified(f.fields)){key=f.fname;if(!(add=adds[key])){indices[key]=index=SortedIndex();adds[key]=add=index.insert(f,pulse.source,0)}dims[i]=Dimension(index,i,query[i]).onAdd(add,curr)}}for(i=0,n=bits.data().length;i<n;++i){if(remMap[i]){continue}else if(prev[i]!==curr[i]){out.push(i)}else if(modMap[i]&&curr[i]!==all){mod.push(i)}}bits.mask=(1<<m)-1;return output},eval:function _eval(_,pulse){var output=pulse.materialize().fork(),m=this._dims.length;var mask=0;if(pulse.rem.length){this.remove(_,pulse,output);mask|=(1<<m)-1}if(_.modified("query")&&!_.modified("fields")){mask|=this.update(_,pulse,output)}if(pulse.add.length){this.insert(_,pulse,output);mask|=(1<<m)-1}if(pulse.mod.length){this.modify(pulse,output);mask|=(1<<m)-1}this.value.mask=mask;return output},insert:function insert(_,pulse,output){var tuples=pulse.add,bits=this.value,dims=this._dims,indices=this._indices,fields=_.fields,adds={},out=output.add,n=bits.size()+tuples.length,m=dims.length;var k=bits.size(),j,key,add;bits.resize(n,m);bits.add(tuples);var curr=bits.curr(),prev=bits.prev(),all=bits.all();for(j=0;j<m;++j){key=fields[j].fname;add=adds[key]||(adds[key]=indices[key].insert(fields[j],tuples,k));dims[j].onAdd(add,curr)}for(;k<n;++k){prev[k]=all;if(curr[k]!==all)out.push(k)}},modify:function modify(pulse,output){var out=output.mod,bits=this.value,curr=bits.curr(),all=bits.all(),tuples=pulse.mod;var i,n,k;for(i=0,n=tuples.length;i<n;++i){k=tuples[i]._index;if(curr[k]!==all)out.push(k)}},remove:function remove(_,pulse,output){var indices=this._indices,bits=this.value,curr=bits.curr(),prev=bits.prev(),all=bits.all(),map={},out=output.rem,tuples=pulse.rem;var i,n,k,f;for(i=0,n=tuples.length;i<n;++i){k=tuples[i]._index;map[k]=1;prev[k]=f=curr[k];curr[k]=all;if(f!==all)out.push(k)}for(k in indices){indices[k].remove(n,map)}this.reindex(pulse,n,map);return map},reindex:function reindex(pulse,num,map){var indices=this._indices,bits=this.value;pulse.runAfter((function(){var indexMap=bits.remove(num,map);for(var key in indices){indices[key].reindex(indexMap)}}))},update:function update(_,pulse,output){var dims=this._dims,query=_.query,stamp=pulse.stamp,m=dims.length;var mask=0,i,q;output.filters=0;for(q=0;q<m;++q){if(_.modified("query",q)){i=q;++mask}}if(mask===1){mask=dims[i].one;this.incrementOne(dims[i],query[i],output.add,output.rem)}else{for(q=0,mask=0;q<m;++q){if(!_.modified("query",q))continue;mask|=dims[q].one;this.incrementAll(dims[q],query[q],stamp,output.add);output.rem=output.add}}return mask},incrementAll:function incrementAll(dim,query,stamp,out){var bits=this.value,seen=bits.seen(),curr=bits.curr(),prev=bits.prev(),index=dim.index(),old=dim.bisect(dim.range),range=dim.bisect(query),lo1=range[0],hi1=range[1],lo0=old[0],hi0=old[1],one=dim.one;var i,j,k;if(lo1<lo0){for(i=lo1,j=Math.min(lo0,hi1);i<j;++i){k=index[i];if(seen[k]!==stamp){prev[k]=curr[k];seen[k]=stamp;out.push(k)}curr[k]^=one}}else if(lo1>lo0){for(i=lo0,j=Math.min(lo1,hi0);i<j;++i){k=index[i];if(seen[k]!==stamp){prev[k]=curr[k];seen[k]=stamp;out.push(k)}curr[k]^=one}}if(hi1>hi0){for(i=Math.max(lo1,hi0),j=hi1;i<j;++i){k=index[i];if(seen[k]!==stamp){prev[k]=curr[k];seen[k]=stamp;out.push(k)}curr[k]^=one}}else if(hi1<hi0){for(i=Math.max(lo0,hi1),j=hi0;i<j;++i){k=index[i];if(seen[k]!==stamp){prev[k]=curr[k];seen[k]=stamp;out.push(k)}curr[k]^=one}}dim.range=query.slice()},incrementOne:function incrementOne(dim,query,add,rem){var bits=this.value,curr=bits.curr(),index=dim.index(),old=dim.bisect(dim.range),range=dim.bisect(query),lo1=range[0],hi1=range[1],lo0=old[0],hi0=old[1],one=dim.one;var i,j,k;if(lo1<lo0){for(i=lo1,j=Math.min(lo0,hi1);i<j;++i){k=index[i];curr[k]^=one;add.push(k)}}else if(lo1>lo0){for(i=lo0,j=Math.min(lo1,hi0);i<j;++i){k=index[i];curr[k]^=one;rem.push(k)}}if(hi1>hi0){for(i=Math.max(lo1,hi0),j=hi1;i<j;++i){k=index[i];curr[k]^=one;add.push(k)}}else if(hi1<hi0){for(i=Math.max(lo0,hi1),j=hi0;i<j;++i){k=index[i];curr[k]^=one;rem.push(k)}}dim.range=query.slice()}});function ResolveFilter(params){Transform.call(this,null,params)}ResolveFilter.Definition={type:"ResolveFilter",metadata:{},params:[{name:"ignore",type:"number",required:true,description:"A bit mask indicating which filters to ignore."},{name:"filter",type:"object",required:true,description:"Per-tuple filter bitmaps from a CrossFilter transform."}]};inherits(ResolveFilter,Transform,{transform:function transform(_,pulse){var ignore=~(_.ignore||0),bitmap=_.filter,mask=bitmap.mask;if((mask&ignore)===0)return pulse.StopPropagation;var output=pulse.fork(pulse.ALL),data=bitmap.data(),curr=bitmap.curr(),prev=bitmap.prev(),pass=function pass(k){return!(curr[k]&ignore)?data[k]:null};output.filter(output.MOD,pass);if(!(mask&mask-1)){output.filter(output.ADD,pass);output.filter(output.REM,(function(k){return(curr[k]&ignore)===mask?data[k]:null}))}else{output.filter(output.ADD,(function(k){var c=curr[k]&ignore,f=!c&&c^prev[k]&ignore;return f?data[k]:null}));output.filter(output.REM,(function(k){var c=curr[k]&ignore,f=c&&!(c^(c^prev[k]&ignore));return f?data[k]:null}))}return output.filter(output.SOURCE,(function(t){return pass(t._index)}))}});var xf=Object.freeze({__proto__:null,crossfilter:CrossFilter,resolvefilter:ResolveFilter});var version="5.17.1";var RawCode="RawCode";var Literal="Literal";var Property="Property";var Identifier$1="Identifier";var ArrayExpression="ArrayExpression";var BinaryExpression="BinaryExpression";var CallExpression="CallExpression";var ConditionalExpression="ConditionalExpression";var LogicalExpression="LogicalExpression";var MemberExpression="MemberExpression";var ObjectExpression="ObjectExpression";var UnaryExpression="UnaryExpression";function ASTNode(type){this.type=type}ASTNode.prototype.visit=function(visitor){var c,i,n;if(visitor(this))return 1;for(c=children$1(this),i=0,n=c.length;i<n;++i){if(c[i].visit(visitor))return 1}};function children$1(node){switch(node.type){case ArrayExpression:return node.elements;case BinaryExpression:case LogicalExpression:return[node.left,node.right];case CallExpression:return[node.callee].concat(node.arguments);case ConditionalExpression:return[node.test,node.consequent,node.alternate];case MemberExpression:return[node.object,node.property];case ObjectExpression:return node.properties;case Property:return[node.key,node.value];case UnaryExpression:return[node.argument];case Identifier$1:case Literal:case RawCode:default:return[]}}var TokenName,source$1,index$1,length,lookahead;var TokenBooleanLiteral=1,TokenEOF=2,TokenIdentifier=3,TokenKeyword=4,TokenNullLiteral=5,TokenNumericLiteral=6,TokenPunctuator=7,TokenStringLiteral=8,TokenRegularExpression=9;TokenName={};TokenName[TokenBooleanLiteral]="Boolean";TokenName[TokenEOF]="<end>";TokenName[TokenIdentifier]="Identifier";TokenName[TokenKeyword]="Keyword";TokenName[TokenNullLiteral]="Null";TokenName[TokenNumericLiteral]="Numeric";TokenName[TokenPunctuator]="Punctuator";TokenName[TokenStringLiteral]="String";TokenName[TokenRegularExpression]="RegularExpression";var SyntaxArrayExpression="ArrayExpression",SyntaxBinaryExpression="BinaryExpression",SyntaxCallExpression="CallExpression",SyntaxConditionalExpression="ConditionalExpression",SyntaxIdentifier="Identifier",SyntaxLiteral="Literal",SyntaxLogicalExpression="LogicalExpression",SyntaxMemberExpression="MemberExpression",SyntaxObjectExpression="ObjectExpression",SyntaxProperty="Property",SyntaxUnaryExpression="UnaryExpression";var MessageUnexpectedToken="Unexpected token %0",MessageUnexpectedNumber="Unexpected number",MessageUnexpectedString="Unexpected string",MessageUnexpectedIdentifier="Unexpected identifier",MessageUnexpectedReserved="Unexpected reserved word",MessageUnexpectedEOS="Unexpected end of input",MessageInvalidRegExp="Invalid regular expression",MessageUnterminatedRegExp="Invalid regular expression: missing /",MessageStrictOctalLiteral="Octal literals are not allowed in strict mode.",MessageStrictDuplicateProperty="Duplicate data property in object literal not allowed in strict mode";var ILLEGAL="ILLEGAL",DISABLED="Disabled.";var RegexNonAsciiIdentifierStart=new RegExp("[\\xAA\\xB5\\xBA\\xC0-\\xD6\\xD8-\\xF6\\xF8-\\u02C1\\u02C6-\\u02D1\\u02E0-\\u02E4\\u02EC\\u02EE\\u0370-\\u0374\\u0376\\u0377\\u037A-\\u037D\\u037F\\u0386\\u0388-\\u038A\\u038C\\u038E-\\u03A1\\u03A3-\\u03F5\\u03F7-\\u0481\\u048A-\\u052F\\u0531-\\u0556\\u0559\\u0561-\\u0587\\u05D0-\\u05EA\\u05F0-\\u05F2\\u0620-\\u064A\\u066E\\u066F\\u0671-\\u06D3\\u06D5\\u06E5\\u06E6\\u06EE\\u06EF\\u06FA-\\u06FC\\u06FF\\u0710\\u0712-\\u072F\\u074D-\\u07A5\\u07B1\\u07CA-\\u07EA\\u07F4\\u07F5\\u07FA\\u0800-\\u0815\\u081A\\u0824\\u0828\\u0840-\\u0858\\u08A0-\\u08B2\\u0904-\\u0939\\u093D\\u0950\\u0958-\\u0961\\u0971-\\u0980\\u0985-\\u098C\\u098F\\u0990\\u0993-\\u09A8\\u09AA-\\u09B0\\u09B2\\u09B6-\\u09B9\\u09BD\\u09CE\\u09DC\\u09DD\\u09DF-\\u09E1\\u09F0\\u09F1\\u0A05-\\u0A0A\\u0A0F\\u0A10\\u0A13-\\u0A28\\u0A2A-\\u0A30\\u0A32\\u0A33\\u0A35\\u0A36\\u0A38\\u0A39\\u0A59-\\u0A5C\\u0A5E\\u0A72-\\u0A74\\u0A85-\\u0A8D\\u0A8F-\\u0A91\\u0A93-\\u0AA8\\u0AAA-\\u0AB0\\u0AB2\\u0AB3\\u0AB5-\\u0AB9\\u0ABD\\u0AD0\\u0AE0\\u0AE1\\u0B05-\\u0B0C\\u0B0F\\u0B10\\u0B13-\\u0B28\\u0B2A-\\u0B30\\u0B32\\u0B33\\u0B35-\\u0B39\\u0B3D\\u0B5C\\u0B5D\\u0B5F-\\u0B61\\u0B71\\u0B83\\u0B85-\\u0B8A\\u0B8E-\\u0B90\\u0B92-\\u0B95\\u0B99\\u0B9A\\u0B9C\\u0B9E\\u0B9F\\u0BA3\\u0BA4\\u0BA8-\\u0BAA\\u0BAE-\\u0BB9\\u0BD0\\u0C05-\\u0C0C\\u0C0E-\\u0C10\\u0C12-\\u0C28\\u0C2A-\\u0C39\\u0C3D\\u0C58\\u0C59\\u0C60\\u0C61\\u0C85-\\u0C8C\\u0C8E-\\u0C90\\u0C92-\\u0CA8\\u0CAA-\\u0CB3\\u0CB5-\\u0CB9\\u0CBD\\u0CDE\\u0CE0\\u0CE1\\u0CF1\\u0CF2\\u0D05-\\u0D0C\\u0D0E-\\u0D10\\u0D12-\\u0D3A\\u0D3D\\u0D4E\\u0D60\\u0D61\\u0D7A-\\u0D7F\\u0D85-\\u0D96\\u0D9A-\\u0DB1\\u0DB3-\\u0DBB\\u0DBD\\u0DC0-\\u0DC6\\u0E01-\\u0E30\\u0E32\\u0E33\\u0E40-\\u0E46\\u0E81\\u0E82\\u0E84\\u0E87\\u0E88\\u0E8A\\u0E8D\\u0E94-\\u0E97\\u0E99-\\u0E9F\\u0EA1-\\u0EA3\\u0EA5\\u0EA7\\u0EAA\\u0EAB\\u0EAD-\\u0EB0\\u0EB2\\u0EB3\\u0EBD\\u0EC0-\\u0EC4\\u0EC6\\u0EDC-\\u0EDF\\u0F00\\u0F40-\\u0F47\\u0F49-\\u0F6C\\u0F88-\\u0F8C\\u1000-\\u102A\\u103F\\u1050-\\u1055\\u105A-\\u105D\\u1061\\u1065\\u1066\\u106E-\\u1070\\u1075-\\u1081\\u108E\\u10A0-\\u10C5\\u10C7\\u10CD\\u10D0-\\u10FA\\u10FC-\\u1248\\u124A-\\u124D\\u1250-\\u1256\\u1258\\u125A-\\u125D\\u1260-\\u1288\\u128A-\\u128D\\u1290-\\u12B0\\u12B2-\\u12B5\\u12B8-\\u12BE\\u12C0\\u12C2-\\u12C5\\u12C8-\\u12D6\\u12D8-\\u1310\\u1312-\\u1315\\u1318-\\u135A\\u1380-\\u138F\\u13A0-\\u13F4\\u1401-\\u166C\\u166F-\\u167F\\u1681-\\u169A\\u16A0-\\u16EA\\u16EE-\\u16F8\\u1700-\\u170C\\u170E-\\u1711\\u1720-\\u1731\\u1740-\\u1751\\u1760-\\u176C\\u176E-\\u1770\\u1780-\\u17B3\\u17D7\\u17DC\\u1820-\\u1877\\u1880-\\u18A8\\u18AA\\u18B0-\\u18F5\\u1900-\\u191E\\u1950-\\u196D\\u1970-\\u1974\\u1980-\\u19AB\\u19C1-\\u19C7\\u1A00-\\u1A16\\u1A20-\\u1A54\\u1AA7\\u1B05-\\u1B33\\u1B45-\\u1B4B\\u1B83-\\u1BA0\\u1BAE\\u1BAF\\u1BBA-\\u1BE5\\u1C00-\\u1C23\\u1C4D-\\u1C4F\\u1C5A-\\u1C7D\\u1CE9-\\u1CEC\\u1CEE-\\u1CF1\\u1CF5\\u1CF6\\u1D00-\\u1DBF\\u1E00-\\u1F15\\u1F18-\\u1F1D\\u1F20-\\u1F45\\u1F48-\\u1F4D\\u1F50-\\u1F57\\u1F59\\u1F5B\\u1F5D\\u1F5F-\\u1F7D\\u1F80-\\u1FB4\\u1FB6-\\u1FBC\\u1FBE\\u1FC2-\\u1FC4\\u1FC6-\\u1FCC\\u1FD0-\\u1FD3\\u1FD6-\\u1FDB\\u1FE0-\\u1FEC\\u1FF2-\\u1FF4\\u1FF6-\\u1FFC\\u2071\\u207F\\u2090-\\u209C\\u2102\\u2107\\u210A-\\u2113\\u2115\\u2119-\\u211D\\u2124\\u2126\\u2128\\u212A-\\u212D\\u212F-\\u2139\\u213C-\\u213F\\u2145-\\u2149\\u214E\\u2160-\\u2188\\u2C00-\\u2C2E\\u2C30-\\u2C5E\\u2C60-\\u2CE4\\u2CEB-\\u2CEE\\u2CF2\\u2CF3\\u2D00-\\u2D25\\u2D27\\u2D2D\\u2D30-\\u2D67\\u2D6F\\u2D80-\\u2D96\\u2DA0-\\u2DA6\\u2DA8-\\u2DAE\\u2DB0-\\u2DB6\\u2DB8-\\u2DBE\\u2DC0-\\u2DC6\\u2DC8-\\u2DCE\\u2DD0-\\u2DD6\\u2DD8-\\u2DDE\\u2E2F\\u3005-\\u3007\\u3021-\\u3029\\u3031-\\u3035\\u3038-\\u303C\\u3041-\\u3096\\u309D-\\u309F\\u30A1-\\u30FA\\u30FC-\\u30FF\\u3105-\\u312D\\u3131-\\u318E\\u31A0-\\u31BA\\u31F0-\\u31FF\\u3400-\\u4DB5\\u4E00-\\u9FCC\\uA000-\\uA48C\\uA4D0-\\uA4FD\\uA500-\\uA60C\\uA610-\\uA61F\\uA62A\\uA62B\\uA640-\\uA66E\\uA67F-\\uA69D\\uA6A0-\\uA6EF\\uA717-\\uA71F\\uA722-\\uA788\\uA78B-\\uA78E\\uA790-\\uA7AD\\uA7B0\\uA7B1\\uA7F7-\\uA801\\uA803-\\uA805\\uA807-\\uA80A\\uA80C-\\uA822\\uA840-\\uA873\\uA882-\\uA8B3\\uA8F2-\\uA8F7\\uA8FB\\uA90A-\\uA925\\uA930-\\uA946\\uA960-\\uA97C\\uA984-\\uA9B2\\uA9CF\\uA9E0-\\uA9E4\\uA9E6-\\uA9EF\\uA9FA-\\uA9FE\\uAA00-\\uAA28\\uAA40-\\uAA42\\uAA44-\\uAA4B\\uAA60-\\uAA76\\uAA7A\\uAA7E-\\uAAAF\\uAAB1\\uAAB5\\uAAB6\\uAAB9-\\uAABD\\uAAC0\\uAAC2\\uAADB-\\uAADD\\uAAE0-\\uAAEA\\uAAF2-\\uAAF4\\uAB01-\\uAB06\\uAB09-\\uAB0E\\uAB11-\\uAB16\\uAB20-\\uAB26\\uAB28-\\uAB2E\\uAB30-\\uAB5A\\uAB5C-\\uAB5F\\uAB64\\uAB65\\uABC0-\\uABE2\\uAC00-\\uD7A3\\uD7B0-\\uD7C6\\uD7CB-\\uD7FB\\uF900-\\uFA6D\\uFA70-\\uFAD9\\uFB00-\\uFB06\\uFB13-\\uFB17\\uFB1D\\uFB1F-\\uFB28\\uFB2A-\\uFB36\\uFB38-\\uFB3C\\uFB3E\\uFB40\\uFB41\\uFB43\\uFB44\\uFB46-\\uFBB1\\uFBD3-\\uFD3D\\uFD50-\\uFD8F\\uFD92-\\uFDC7\\uFDF0-\\uFDFB\\uFE70-\\uFE74\\uFE76-\\uFEFC\\uFF21-\\uFF3A\\uFF41-\\uFF5A\\uFF66-\\uFFBE\\uFFC2-\\uFFC7\\uFFCA-\\uFFCF\\uFFD2-\\uFFD7\\uFFDA-\\uFFDC]"),RegexNonAsciiIdentifierPart=new RegExp("[\\xAA\\xB5\\xBA\\xC0-\\xD6\\xD8-\\xF6\\xF8-\\u02C1\\u02C6-\\u02D1\\u02E0-\\u02E4\\u02EC\\u02EE\\u0300-\\u0374\\u0376\\u0377\\u037A-\\u037D\\u037F\\u0386\\u0388-\\u038A\\u038C\\u038E-\\u03A1\\u03A3-\\u03F5\\u03F7-\\u0481\\u0483-\\u0487\\u048A-\\u052F\\u0531-\\u0556\\u0559\\u0561-\\u0587\\u0591-\\u05BD\\u05BF\\u05C1\\u05C2\\u05C4\\u05C5\\u05C7\\u05D0-\\u05EA\\u05F0-\\u05F2\\u0610-\\u061A\\u0620-\\u0669\\u066E-\\u06D3\\u06D5-\\u06DC\\u06DF-\\u06E8\\u06EA-\\u06FC\\u06FF\\u0710-\\u074A\\u074D-\\u07B1\\u07C0-\\u07F5\\u07FA\\u0800-\\u082D\\u0840-\\u085B\\u08A0-\\u08B2\\u08E4-\\u0963\\u0966-\\u096F\\u0971-\\u0983\\u0985-\\u098C\\u098F\\u0990\\u0993-\\u09A8\\u09AA-\\u09B0\\u09B2\\u09B6-\\u09B9\\u09BC-\\u09C4\\u09C7\\u09C8\\u09CB-\\u09CE\\u09D7\\u09DC\\u09DD\\u09DF-\\u09E3\\u09E6-\\u09F1\\u0A01-\\u0A03\\u0A05-\\u0A0A\\u0A0F\\u0A10\\u0A13-\\u0A28\\u0A2A-\\u0A30\\u0A32\\u0A33\\u0A35\\u0A36\\u0A38\\u0A39\\u0A3C\\u0A3E-\\u0A42\\u0A47\\u0A48\\u0A4B-\\u0A4D\\u0A51\\u0A59-\\u0A5C\\u0A5E\\u0A66-\\u0A75\\u0A81-\\u0A83\\u0A85-\\u0A8D\\u0A8F-\\u0A91\\u0A93-\\u0AA8\\u0AAA-\\u0AB0\\u0AB2\\u0AB3\\u0AB5-\\u0AB9\\u0ABC-\\u0AC5\\u0AC7-\\u0AC9\\u0ACB-\\u0ACD\\u0AD0\\u0AE0-\\u0AE3\\u0AE6-\\u0AEF\\u0B01-\\u0B03\\u0B05-\\u0B0C\\u0B0F\\u0B10\\u0B13-\\u0B28\\u0B2A-\\u0B30\\u0B32\\u0B33\\u0B35-\\u0B39\\u0B3C-\\u0B44\\u0B47\\u0B48\\u0B4B-\\u0B4D\\u0B56\\u0B57\\u0B5C\\u0B5D\\u0B5F-\\u0B63\\u0B66-\\u0B6F\\u0B71\\u0B82\\u0B83\\u0B85-\\u0B8A\\u0B8E-\\u0B90\\u0B92-\\u0B95\\u0B99\\u0B9A\\u0B9C\\u0B9E\\u0B9F\\u0BA3\\u0BA4\\u0BA8-\\u0BAA\\u0BAE-\\u0BB9\\u0BBE-\\u0BC2\\u0BC6-\\u0BC8\\u0BCA-\\u0BCD\\u0BD0\\u0BD7\\u0BE6-\\u0BEF\\u0C00-\\u0C03\\u0C05-\\u0C0C\\u0C0E-\\u0C10\\u0C12-\\u0C28\\u0C2A-\\u0C39\\u0C3D-\\u0C44\\u0C46-\\u0C48\\u0C4A-\\u0C4D\\u0C55\\u0C56\\u0C58\\u0C59\\u0C60-\\u0C63\\u0C66-\\u0C6F\\u0C81-\\u0C83\\u0C85-\\u0C8C\\u0C8E-\\u0C90\\u0C92-\\u0CA8\\u0CAA-\\u0CB3\\u0CB5-\\u0CB9\\u0CBC-\\u0CC4\\u0CC6-\\u0CC8\\u0CCA-\\u0CCD\\u0CD5\\u0CD6\\u0CDE\\u0CE0-\\u0CE3\\u0CE6-\\u0CEF\\u0CF1\\u0CF2\\u0D01-\\u0D03\\u0D05-\\u0D0C\\u0D0E-\\u0D10\\u0D12-\\u0D3A\\u0D3D-\\u0D44\\u0D46-\\u0D48\\u0D4A-\\u0D4E\\u0D57\\u0D60-\\u0D63\\u0D66-\\u0D6F\\u0D7A-\\u0D7F\\u0D82\\u0D83\\u0D85-\\u0D96\\u0D9A-\\u0DB1\\u0DB3-\\u0DBB\\u0DBD\\u0DC0-\\u0DC6\\u0DCA\\u0DCF-\\u0DD4\\u0DD6\\u0DD8-\\u0DDF\\u0DE6-\\u0DEF\\u0DF2\\u0DF3\\u0E01-\\u0E3A\\u0E40-\\u0E4E\\u0E50-\\u0E59\\u0E81\\u0E82\\u0E84\\u0E87\\u0E88\\u0E8A\\u0E8D\\u0E94-\\u0E97\\u0E99-\\u0E9F\\u0EA1-\\u0EA3\\u0EA5\\u0EA7\\u0EAA\\u0EAB\\u0EAD-\\u0EB9\\u0EBB-\\u0EBD\\u0EC0-\\u0EC4\\u0EC6\\u0EC8-\\u0ECD\\u0ED0-\\u0ED9\\u0EDC-\\u0EDF\\u0F00\\u0F18\\u0F19\\u0F20-\\u0F29\\u0F35\\u0F37\\u0F39\\u0F3E-\\u0F47\\u0F49-\\u0F6C\\u0F71-\\u0F84\\u0F86-\\u0F97\\u0F99-\\u0FBC\\u0FC6\\u1000-\\u1049\\u1050-\\u109D\\u10A0-\\u10C5\\u10C7\\u10CD\\u10D0-\\u10FA\\u10FC-\\u1248\\u124A-\\u124D\\u1250-\\u1256\\u1258\\u125A-\\u125D\\u1260-\\u1288\\u128A-\\u128D\\u1290-\\u12B0\\u12B2-\\u12B5\\u12B8-\\u12BE\\u12C0\\u12C2-\\u12C5\\u12C8-\\u12D6\\u12D8-\\u1310\\u1312-\\u1315\\u1318-\\u135A\\u135D-\\u135F\\u1380-\\u138F\\u13A0-\\u13F4\\u1401-\\u166C\\u166F-\\u167F\\u1681-\\u169A\\u16A0-\\u16EA\\u16EE-\\u16F8\\u1700-\\u170C\\u170E-\\u1714\\u1720-\\u1734\\u1740-\\u1753\\u1760-\\u176C\\u176E-\\u1770\\u1772\\u1773\\u1780-\\u17D3\\u17D7\\u17DC\\u17DD\\u17E0-\\u17E9\\u180B-\\u180D\\u1810-\\u1819\\u1820-\\u1877\\u1880-\\u18AA\\u18B0-\\u18F5\\u1900-\\u191E\\u1920-\\u192B\\u1930-\\u193B\\u1946-\\u196D\\u1970-\\u1974\\u1980-\\u19AB\\u19B0-\\u19C9\\u19D0-\\u19D9\\u1A00-\\u1A1B\\u1A20-\\u1A5E\\u1A60-\\u1A7C\\u1A7F-\\u1A89\\u1A90-\\u1A99\\u1AA7\\u1AB0-\\u1ABD\\u1B00-\\u1B4B\\u1B50-\\u1B59\\u1B6B-\\u1B73\\u1B80-\\u1BF3\\u1C00-\\u1C37\\u1C40-\\u1C49\\u1C4D-\\u1C7D\\u1CD0-\\u1CD2\\u1CD4-\\u1CF6\\u1CF8\\u1CF9\\u1D00-\\u1DF5\\u1DFC-\\u1F15\\u1F18-\\u1F1D\\u1F20-\\u1F45\\u1F48-\\u1F4D\\u1F50-\\u1F57\\u1F59\\u1F5B\\u1F5D\\u1F5F-\\u1F7D\\u1F80-\\u1FB4\\u1FB6-\\u1FBC\\u1FBE\\u1FC2-\\u1FC4\\u1FC6-\\u1FCC\\u1FD0-\\u1FD3\\u1FD6-\\u1FDB\\u1FE0-\\u1FEC\\u1FF2-\\u1FF4\\u1FF6-\\u1FFC\\u200C\\u200D\\u203F\\u2040\\u2054\\u2071\\u207F\\u2090-\\u209C\\u20D0-\\u20DC\\u20E1\\u20E5-\\u20F0\\u2102\\u2107\\u210A-\\u2113\\u2115\\u2119-\\u211D\\u2124\\u2126\\u2128\\u212A-\\u212D\\u212F-\\u2139\\u213C-\\u213F\\u2145-\\u2149\\u214E\\u2160-\\u2188\\u2C00-\\u2C2E\\u2C30-\\u2C5E\\u2C60-\\u2CE4\\u2CEB-\\u2CF3\\u2D00-\\u2D25\\u2D27\\u2D2D\\u2D30-\\u2D67\\u2D6F\\u2D7F-\\u2D96\\u2DA0-\\u2DA6\\u2DA8-\\u2DAE\\u2DB0-\\u2DB6\\u2DB8-\\u2DBE\\u2DC0-\\u2DC6\\u2DC8-\\u2DCE\\u2DD0-\\u2DD6\\u2DD8-\\u2DDE\\u2DE0-\\u2DFF\\u2E2F\\u3005-\\u3007\\u3021-\\u302F\\u3031-\\u3035\\u3038-\\u303C\\u3041-\\u3096\\u3099\\u309A\\u309D-\\u309F\\u30A1-\\u30FA\\u30FC-\\u30FF\\u3105-\\u312D\\u3131-\\u318E\\u31A0-\\u31BA\\u31F0-\\u31FF\\u3400-\\u4DB5\\u4E00-\\u9FCC\\uA000-\\uA48C\\uA4D0-\\uA4FD\\uA500-\\uA60C\\uA610-\\uA62B\\uA640-\\uA66F\\uA674-\\uA67D\\uA67F-\\uA69D\\uA69F-\\uA6F1\\uA717-\\uA71F\\uA722-\\uA788\\uA78B-\\uA78E\\uA790-\\uA7AD\\uA7B0\\uA7B1\\uA7F7-\\uA827\\uA840-\\uA873\\uA880-\\uA8C4\\uA8D0-\\uA8D9\\uA8E0-\\uA8F7\\uA8FB\\uA900-\\uA92D\\uA930-\\uA953\\uA960-\\uA97C\\uA980-\\uA9C0\\uA9CF-\\uA9D9\\uA9E0-\\uA9FE\\uAA00-\\uAA36\\uAA40-\\uAA4D\\uAA50-\\uAA59\\uAA60-\\uAA76\\uAA7A-\\uAAC2\\uAADB-\\uAADD\\uAAE0-\\uAAEF\\uAAF2-\\uAAF6\\uAB01-\\uAB06\\uAB09-\\uAB0E\\uAB11-\\uAB16\\uAB20-\\uAB26\\uAB28-\\uAB2E\\uAB30-\\uAB5A\\uAB5C-\\uAB5F\\uAB64\\uAB65\\uABC0-\\uABEA\\uABEC\\uABED\\uABF0-\\uABF9\\uAC00-\\uD7A3\\uD7B0-\\uD7C6\\uD7CB-\\uD7FB\\uF900-\\uFA6D\\uFA70-\\uFAD9\\uFB00-\\uFB06\\uFB13-\\uFB17\\uFB1D-\\uFB28\\uFB2A-\\uFB36\\uFB38-\\uFB3C\\uFB3E\\uFB40\\uFB41\\uFB43\\uFB44\\uFB46-\\uFBB1\\uFBD3-\\uFD3D\\uFD50-\\uFD8F\\uFD92-\\uFDC7\\uFDF0-\\uFDFB\\uFE00-\\uFE0F\\uFE20-\\uFE2D\\uFE33\\uFE34\\uFE4D-\\uFE4F\\uFE70-\\uFE74\\uFE76-\\uFEFC\\uFF10-\\uFF19\\uFF21-\\uFF3A\\uFF3F\\uFF41-\\uFF5A\\uFF66-\\uFFBE\\uFFC2-\\uFFC7\\uFFCA-\\uFFCF\\uFFD2-\\uFFD7\\uFFDA-\\uFFDC]");function assert(condition,message){if(!condition){throw new Error("ASSERT: "+message)}}function isDecimalDigit(ch){return ch>=48&&ch<=57}function isHexDigit(ch){return"0123456789abcdefABCDEF".indexOf(ch)>=0}function isOctalDigit(ch){return"01234567".indexOf(ch)>=0}function isWhiteSpace(ch){return ch===32||ch===9||ch===11||ch===12||ch===160||ch>=5760&&[5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279].indexOf(ch)>=0}function isLineTerminator(ch){return ch===10||ch===13||ch===8232||ch===8233}function isIdentifierStart(ch){return ch===36||ch===95||ch>=65&&ch<=90||ch>=97&&ch<=122||ch===92||ch>=128&&RegexNonAsciiIdentifierStart.test(String.fromCharCode(ch))}function isIdentifierPart(ch){return ch===36||ch===95||ch>=65&&ch<=90||ch>=97&&ch<=122||ch>=48&&ch<=57||ch===92||ch>=128&&RegexNonAsciiIdentifierPart.test(String.fromCharCode(ch))}var keywords={if:1,in:1,do:1,var:1,for:1,new:1,try:1,let:1,this:1,else:1,case:1,void:1,with:1,enum:1,while:1,break:1,catch:1,throw:1,const:1,yield:1,class:1,super:1,return:1,typeof:1,delete:1,switch:1,export:1,import:1,public:1,static:1,default:1,finally:1,extends:1,package:1,private:1,function:1,continue:1,debugger:1,interface:1,protected:1,instanceof:1,implements:1};function skipComment(){while(index$1<length){var ch=source$1.charCodeAt(index$1);if(isWhiteSpace(ch)||isLineTerminator(ch)){++index$1}else{break}}}function scanHexEscape(prefix){var i,len,ch,code=0;len=prefix==="u"?4:2;for(i=0;i<len;++i){if(index$1<length&&isHexDigit(source$1[index$1])){ch=source$1[index$1++];code=code*16+"0123456789abcdef".indexOf(ch.toLowerCase())}else{throwError({},MessageUnexpectedToken,ILLEGAL)}}return String.fromCharCode(code)}function scanUnicodeCodePointEscape(){var ch,code,cu1,cu2;ch=source$1[index$1];code=0;if(ch==="}"){throwError({},MessageUnexpectedToken,ILLEGAL)}while(index$1<length){ch=source$1[index$1++];if(!isHexDigit(ch)){break}code=code*16+"0123456789abcdef".indexOf(ch.toLowerCase())}if(code>1114111||ch!=="}"){throwError({},MessageUnexpectedToken,ILLEGAL)}if(code<=65535){return String.fromCharCode(code)}cu1=(code-65536>>10)+55296;cu2=(code-65536&1023)+56320;return String.fromCharCode(cu1,cu2)}function getEscapedIdentifier(){var ch,id;ch=source$1.charCodeAt(index$1++);id=String.fromCharCode(ch);if(ch===92){if(source$1.charCodeAt(index$1)!==117){throwError({},MessageUnexpectedToken,ILLEGAL)}++index$1;ch=scanHexEscape("u");if(!ch||ch==="\\"||!isIdentifierStart(ch.charCodeAt(0))){throwError({},MessageUnexpectedToken,ILLEGAL)}id=ch}while(index$1<length){ch=source$1.charCodeAt(index$1);if(!isIdentifierPart(ch)){break}++index$1;id+=String.fromCharCode(ch);if(ch===92){id=id.substr(0,id.length-1);if(source$1.charCodeAt(index$1)!==117){throwError({},MessageUnexpectedToken,ILLEGAL)}++index$1;ch=scanHexEscape("u");if(!ch||ch==="\\"||!isIdentifierPart(ch.charCodeAt(0))){throwError({},MessageUnexpectedToken,ILLEGAL)}id+=ch}}return id}function getIdentifier(){var start,ch;start=index$1++;while(index$1<length){ch=source$1.charCodeAt(index$1);if(ch===92){index$1=start;return getEscapedIdentifier()}if(isIdentifierPart(ch)){++index$1}else{break}}return source$1.slice(start,index$1)}function scanIdentifier(){var start,id,type;start=index$1;id=source$1.charCodeAt(index$1)===92?getEscapedIdentifier():getIdentifier();if(id.length===1){type=TokenIdentifier}else if(keywords.hasOwnProperty(id)){type=TokenKeyword}else if(id==="null"){type=TokenNullLiteral}else if(id==="true"||id==="false"){type=TokenBooleanLiteral}else{type=TokenIdentifier}return{type:type,value:id,start:start,end:index$1}}function scanPunctuator(){var start=index$1,code=source$1.charCodeAt(index$1),code2,ch1=source$1[index$1],ch2,ch3,ch4;switch(code){case 46:case 40:case 41:case 59:case 44:case 123:case 125:case 91:case 93:case 58:case 63:case 126:++index$1;return{type:TokenPunctuator,value:String.fromCharCode(code),start:start,end:index$1};default:code2=source$1.charCodeAt(index$1+1);if(code2===61){switch(code){case 43:case 45:case 47:case 60:case 62:case 94:case 124:case 37:case 38:case 42:index$1+=2;return{type:TokenPunctuator,value:String.fromCharCode(code)+String.fromCharCode(code2),start:start,end:index$1};case 33:case 61:index$1+=2;if(source$1.charCodeAt(index$1)===61){++index$1}return{type:TokenPunctuator,value:source$1.slice(start,index$1),start:start,end:index$1}}}}ch4=source$1.substr(index$1,4);if(ch4===">>>="){index$1+=4;return{type:TokenPunctuator,value:ch4,start:start,end:index$1}}ch3=ch4.substr(0,3);if(ch3===">>>"||ch3==="<<="||ch3===">>="){index$1+=3;return{type:TokenPunctuator,value:ch3,start:start,end:index$1}}ch2=ch3.substr(0,2);if(ch1===ch2[1]&&"+-<>&|".indexOf(ch1)>=0||ch2==="=>"){index$1+=2;return{type:TokenPunctuator,value:ch2,start:start,end:index$1}}if(ch2==="//"){throwError({},MessageUnexpectedToken,ILLEGAL)}if("<>=!+-*%&|^/".indexOf(ch1)>=0){++index$1;return{type:TokenPunctuator,value:ch1,start:start,end:index$1}}throwError({},MessageUnexpectedToken,ILLEGAL)}function scanHexLiteral(start){var number="";while(index$1<length){if(!isHexDigit(source$1[index$1])){break}number+=source$1[index$1++]}if(number.length===0){throwError({},MessageUnexpectedToken,ILLEGAL)}if(isIdentifierStart(source$1.charCodeAt(index$1))){throwError({},MessageUnexpectedToken,ILLEGAL)}return{type:TokenNumericLiteral,value:parseInt("0x"+number,16),start:start,end:index$1}}function scanOctalLiteral(start){var number="0"+source$1[index$1++];while(index$1<length){if(!isOctalDigit(source$1[index$1])){break}number+=source$1[index$1++]}if(isIdentifierStart(source$1.charCodeAt(index$1))||isDecimalDigit(source$1.charCodeAt(index$1))){throwError({},MessageUnexpectedToken,ILLEGAL)}return{type:TokenNumericLiteral,value:parseInt(number,8),octal:true,start:start,end:index$1}}function scanNumericLiteral(){var number,start,ch;ch=source$1[index$1];assert(isDecimalDigit(ch.charCodeAt(0))||ch===".","Numeric literal must start with a decimal digit or a decimal point");start=index$1;number="";if(ch!=="."){number=source$1[index$1++];ch=source$1[index$1];if(number==="0"){if(ch==="x"||ch==="X"){++index$1;return scanHexLiteral(start)}if(isOctalDigit(ch)){return scanOctalLiteral(start)}if(ch&&isDecimalDigit(ch.charCodeAt(0))){throwError({},MessageUnexpectedToken,ILLEGAL)}}while(isDecimalDigit(source$1.charCodeAt(index$1))){number+=source$1[index$1++]}ch=source$1[index$1]}if(ch==="."){number+=source$1[index$1++];while(isDecimalDigit(source$1.charCodeAt(index$1))){number+=source$1[index$1++]}ch=source$1[index$1]}if(ch==="e"||ch==="E"){number+=source$1[index$1++];ch=source$1[index$1];if(ch==="+"||ch==="-"){number+=source$1[index$1++]}if(isDecimalDigit(source$1.charCodeAt(index$1))){while(isDecimalDigit(source$1.charCodeAt(index$1))){number+=source$1[index$1++]}}else{throwError({},MessageUnexpectedToken,ILLEGAL)}}if(isIdentifierStart(source$1.charCodeAt(index$1))){throwError({},MessageUnexpectedToken,ILLEGAL)}return{type:TokenNumericLiteral,value:parseFloat(number),start:start,end:index$1}}function scanStringLiteral(){var str="",quote,start,ch,code,octal=false;quote=source$1[index$1];assert(quote==="'"||quote==='"',"String literal must starts with a quote");start=index$1;++index$1;while(index$1<length){ch=source$1[index$1++];if(ch===quote){quote="";break}else if(ch==="\\"){ch=source$1[index$1++];if(!ch||!isLineTerminator(ch.charCodeAt(0))){switch(ch){case"u":case"x":if(source$1[index$1]==="{"){++index$1;str+=scanUnicodeCodePointEscape()}else{str+=scanHexEscape(ch)}break;case"n":str+="\n";break;case"r":str+="\r";break;case"t":str+="\t";break;case"b":str+="\b";break;case"f":str+="\f";break;case"v":str+="\v";break;default:if(isOctalDigit(ch)){code="01234567".indexOf(ch);if(code!==0){octal=true}if(index$1<length&&isOctalDigit(source$1[index$1])){octal=true;code=code*8+"01234567".indexOf(source$1[index$1++]);if("0123".indexOf(ch)>=0&&index$1<length&&isOctalDigit(source$1[index$1])){code=code*8+"01234567".indexOf(source$1[index$1++])}}str+=String.fromCharCode(code)}else{str+=ch}break}}else{if(ch==="\r"&&source$1[index$1]==="\n"){++index$1}}}else if(isLineTerminator(ch.charCodeAt(0))){break}else{str+=ch}}if(quote!==""){throwError({},MessageUnexpectedToken,ILLEGAL)}return{type:TokenStringLiteral,value:str,octal:octal,start:start,end:index$1}}function testRegExp(pattern,flags){var tmp=pattern;if(flags.indexOf("u")>=0){tmp=tmp.replace(/\\u\{([0-9a-fA-F]+)\}/g,(function($0,$1){if(parseInt($1,16)<=1114111){return"x"}throwError({},MessageInvalidRegExp)})).replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"x")}try{new RegExp(tmp)}catch(e){throwError({},MessageInvalidRegExp)}try{return new RegExp(pattern,flags)}catch(exception){return null}}function scanRegExpBody(){var ch,str,classMarker,terminated,body;ch=source$1[index$1];assert(ch==="/","Regular expression literal must start with a slash");str=source$1[index$1++];classMarker=false;terminated=false;while(index$1<length){ch=source$1[index$1++];str+=ch;if(ch==="\\"){ch=source$1[index$1++];if(isLineTerminator(ch.charCodeAt(0))){throwError({},MessageUnterminatedRegExp)}str+=ch}else if(isLineTerminator(ch.charCodeAt(0))){throwError({},MessageUnterminatedRegExp)}else if(classMarker){if(ch==="]"){classMarker=false}}else{if(ch==="/"){terminated=true;break}else if(ch==="["){classMarker=true}}}if(!terminated){throwError({},MessageUnterminatedRegExp)}body=str.substr(1,str.length-2);return{value:body,literal:str}}function scanRegExpFlags(){var ch,str,flags;str="";flags="";while(index$1<length){ch=source$1[index$1];if(!isIdentifierPart(ch.charCodeAt(0))){break}++index$1;if(ch==="\\"&&index$1<length){throwError({},MessageUnexpectedToken,ILLEGAL)}else{flags+=ch;str+=ch}}if(flags.search(/[^gimuy]/g)>=0){throwError({},MessageInvalidRegExp,flags)}return{value:flags,literal:str}}function scanRegExp(){var start,body,flags,value;lookahead=null;skipComment();start=index$1;body=scanRegExpBody();flags=scanRegExpFlags();value=testRegExp(body.value,flags.value);return{literal:body.literal+flags.literal,value:value,regex:{pattern:body.value,flags:flags.value},start:start,end:index$1}}function isIdentifierName(token){return token.type===TokenIdentifier||token.type===TokenKeyword||token.type===TokenBooleanLiteral||token.type===TokenNullLiteral}function advance(){skipComment();if(index$1>=length){return{type:TokenEOF,start:index$1,end:index$1}}var ch=source$1.charCodeAt(index$1);if(isIdentifierStart(ch)){return scanIdentifier()}if(ch===40||ch===41||ch===59){return scanPunctuator()}if(ch===39||ch===34){return scanStringLiteral()}if(ch===46){if(isDecimalDigit(source$1.charCodeAt(index$1+1))){return scanNumericLiteral()}return scanPunctuator()}if(isDecimalDigit(ch)){return scanNumericLiteral()}return scanPunctuator()}function lex(){var token=lookahead;index$1=token.end;lookahead=advance();index$1=token.end;return token}function peek$1(){var pos=index$1;lookahead=advance();index$1=pos}function finishArrayExpression(elements){var node=new ASTNode(SyntaxArrayExpression);node.elements=elements;return node}function finishBinaryExpression(operator,left,right){var node=new ASTNode(operator==="||"||operator==="&&"?SyntaxLogicalExpression:SyntaxBinaryExpression);node.operator=operator;node.left=left;node.right=right;return node}function finishCallExpression(callee,args){var node=new ASTNode(SyntaxCallExpression);node.callee=callee;node.arguments=args;return node}function finishConditionalExpression(test,consequent,alternate){var node=new ASTNode(SyntaxConditionalExpression);node.test=test;node.consequent=consequent;node.alternate=alternate;return node}function finishIdentifier(name){var node=new ASTNode(SyntaxIdentifier);node.name=name;return node}function finishLiteral(token){var node=new ASTNode(SyntaxLiteral);node.value=token.value;node.raw=source$1.slice(token.start,token.end);if(token.regex){if(node.raw==="//"){node.raw="/(?:)/"}node.regex=token.regex}return node}function finishMemberExpression(accessor,object,property){var node=new ASTNode(SyntaxMemberExpression);node.computed=accessor==="[";node.object=object;node.property=property;if(!node.computed)property.member=true;return node}function finishObjectExpression(properties){var node=new ASTNode(SyntaxObjectExpression);node.properties=properties;return node}function finishProperty(kind,key,value){var node=new ASTNode(SyntaxProperty);node.key=key;node.value=value;node.kind=kind;return node}function finishUnaryExpression(operator,argument){var node=new ASTNode(SyntaxUnaryExpression);node.operator=operator;node.argument=argument;node.prefix=true;return node}function throwError(token,messageFormat){var error,args=Array.prototype.slice.call(arguments,2),msg=messageFormat.replace(/%(\d)/g,(function(whole,index){assert(index<args.length,"Message reference must be in range");return args[index]}));error=new Error(msg);error.index=index$1;error.description=msg;throw error}function throwUnexpected(token){if(token.type===TokenEOF){throwError(token,MessageUnexpectedEOS)}if(token.type===TokenNumericLiteral){throwError(token,MessageUnexpectedNumber)}if(token.type===TokenStringLiteral){throwError(token,MessageUnexpectedString)}if(token.type===TokenIdentifier){throwError(token,MessageUnexpectedIdentifier)}if(token.type===TokenKeyword){throwError(token,MessageUnexpectedReserved)}throwError(token,MessageUnexpectedToken,token.value)}function expect(value){var token=lex();if(token.type!==TokenPunctuator||token.value!==value){throwUnexpected(token)}}function match(value){return lookahead.type===TokenPunctuator&&lookahead.value===value}function matchKeyword(keyword){return lookahead.type===TokenKeyword&&lookahead.value===keyword}function parseArrayInitialiser(){var elements=[];index$1=lookahead.start;expect("[");while(!match("]")){if(match(",")){lex();elements.push(null)}else{elements.push(parseConditionalExpression());if(!match("]")){expect(",")}}}lex();return finishArrayExpression(elements)}function parseObjectPropertyKey(){index$1=lookahead.start;var token=lex();if(token.type===TokenStringLiteral||token.type===TokenNumericLiteral){if(token.octal){throwError(token,MessageStrictOctalLiteral)}return finishLiteral(token)}return finishIdentifier(token.value)}function parseObjectProperty(){var token,key,id,value;index$1=lookahead.start;token=lookahead;if(token.type===TokenIdentifier){id=parseObjectPropertyKey();expect(":");value=parseConditionalExpression();return finishProperty("init",id,value)}if(token.type===TokenEOF||token.type===TokenPunctuator){throwUnexpected(token)}else{key=parseObjectPropertyKey();expect(":");value=parseConditionalExpression();return finishProperty("init",key,value)}}function parseObjectInitialiser(){var properties=[],property,name,key,map={},toString=String;index$1=lookahead.start;expect("{");while(!match("}")){property=parseObjectProperty();if(property.key.type===SyntaxIdentifier){name=property.key.name}else{name=toString(property.key.value)}key="$"+name;if(Object.prototype.hasOwnProperty.call(map,key)){throwError({},MessageStrictDuplicateProperty)}else{map[key]=true}properties.push(property);if(!match("}")){expect(",")}}expect("}");return finishObjectExpression(properties)}function parseGroupExpression(){expect("(");var expr=parseExpression();expect(")");return expr}var legalKeywords={if:1};function parsePrimaryExpression(){var type,token,expr;if(match("(")){return parseGroupExpression()}if(match("[")){return parseArrayInitialiser()}if(match("{")){return parseObjectInitialiser()}type=lookahead.type;index$1=lookahead.start;if(type===TokenIdentifier||legalKeywords[lookahead.value]){expr=finishIdentifier(lex().value)}else if(type===TokenStringLiteral||type===TokenNumericLiteral){if(lookahead.octal){throwError(lookahead,MessageStrictOctalLiteral)}expr=finishLiteral(lex())}else if(type===TokenKeyword){throw new Error(DISABLED)}else if(type===TokenBooleanLiteral){token=lex();token.value=token.value==="true";expr=finishLiteral(token)}else if(type===TokenNullLiteral){token=lex();token.value=null;expr=finishLiteral(token)}else if(match("/")||match("/=")){expr=finishLiteral(scanRegExp());peek$1()}else{throwUnexpected(lex())}return expr}function parseArguments(){var args=[];expect("(");if(!match(")")){while(index$1<length){args.push(parseConditionalExpression());if(match(")")){break}expect(",")}}expect(")");return args}function parseNonComputedProperty(){index$1=lookahead.start;var token=lex();if(!isIdentifierName(token)){throwUnexpected(token)}return finishIdentifier(token.value)}function parseNonComputedMember(){expect(".");return parseNonComputedProperty()}function parseComputedMember(){expect("[");var expr=parseExpression();expect("]");return expr}function parseLeftHandSideExpressionAllowCall(){var expr,args,property;expr=parsePrimaryExpression();for(;;){if(match(".")){property=parseNonComputedMember();expr=finishMemberExpression(".",expr,property)}else if(match("(")){args=parseArguments();expr=finishCallExpression(expr,args)}else if(match("[")){property=parseComputedMember();expr=finishMemberExpression("[",expr,property)}else{break}}return expr}function parsePostfixExpression(){var expr=parseLeftHandSideExpressionAllowCall();if(lookahead.type===TokenPunctuator){if(match("++")||match("--")){throw new Error(DISABLED)}}return expr}function parseUnaryExpression(){var token,expr;if(lookahead.type!==TokenPunctuator&&lookahead.type!==TokenKeyword){expr=parsePostfixExpression()}else if(match("++")||match("--")){throw new Error(DISABLED)}else if(match("+")||match("-")||match("~")||match("!")){token=lex();expr=parseUnaryExpression();expr=finishUnaryExpression(token.value,expr)}else if(matchKeyword("delete")||matchKeyword("void")||matchKeyword("typeof")){throw new Error(DISABLED)}else{expr=parsePostfixExpression()}return expr}function binaryPrecedence(token){var prec=0;if(token.type!==TokenPunctuator&&token.type!==TokenKeyword){return 0}switch(token.value){case"||":prec=1;break;case"&&":prec=2;break;case"|":prec=3;break;case"^":prec=4;break;case"&":prec=5;break;case"==":case"!=":case"===":case"!==":prec=6;break;case"<":case">":case"<=":case">=":case"instanceof":case"in":prec=7;break;case"<<":case">>":case">>>":prec=8;break;case"+":case"-":prec=9;break;case"*":case"/":case"%":prec=11;break}return prec}function parseBinaryExpression(){var marker,markers,expr,token,prec,stack,right,operator,left,i;marker=lookahead;left=parseUnaryExpression();token=lookahead;prec=binaryPrecedence(token);if(prec===0){return left}token.prec=prec;lex();markers=[marker,lookahead];right=parseUnaryExpression();stack=[left,token,right];while((prec=binaryPrecedence(lookahead))>0){while(stack.length>2&&prec<=stack[stack.length-2].prec){right=stack.pop();operator=stack.pop().value;left=stack.pop();markers.pop();expr=finishBinaryExpression(operator,left,right);stack.push(expr)}token=lex();token.prec=prec;stack.push(token);markers.push(lookahead);expr=parseUnaryExpression();stack.push(expr)}i=stack.length-1;expr=stack[i];markers.pop();while(i>1){markers.pop();expr=finishBinaryExpression(stack[i-1].value,stack[i-2],expr);i-=2}return expr}function parseConditionalExpression(){var expr,consequent,alternate;expr=parseBinaryExpression();if(match("?")){lex();consequent=parseConditionalExpression();expect(":");alternate=parseConditionalExpression();expr=finishConditionalExpression(expr,consequent,alternate)}return expr}function parseExpression(){var expr=parseConditionalExpression();if(match(",")){throw new Error(DISABLED)}return expr}function parser(code){source$1=code;index$1=0;length=source$1.length;lookahead=null;peek$1();var expr=parseExpression();if(lookahead.type!==TokenEOF){throw new Error("Unexpect token after expression.")}return expr}var Constants={NaN:"NaN",E:"Math.E",LN2:"Math.LN2",LN10:"Math.LN10",LOG2E:"Math.LOG2E",LOG10E:"Math.LOG10E",PI:"Math.PI",SQRT1_2:"Math.SQRT1_2",SQRT2:"Math.SQRT2",MIN_VALUE:"Number.MIN_VALUE",MAX_VALUE:"Number.MAX_VALUE"};function Functions(codegen){function fncall(name,args,cast,type){var obj=codegen(args[0]);if(cast){obj=cast+"("+obj+")";if(cast.lastIndexOf("new ",0)===0)obj="("+obj+")"}return obj+"."+name+(type<0?"":type===0?"()":"("+args.slice(1).map(codegen).join(",")+")")}function fn(name,cast,type){return function(args){return fncall(name,args,cast,type)}}var DATE="new Date",STRING="String",REGEXP="RegExp";return{isNaN:"Number.isNaN",isFinite:"Number.isFinite",abs:"Math.abs",acos:"Math.acos",asin:"Math.asin",atan:"Math.atan",atan2:"Math.atan2",ceil:"Math.ceil",cos:"Math.cos",exp:"Math.exp",floor:"Math.floor",log:"Math.log",max:"Math.max",min:"Math.min",pow:"Math.pow",random:"Math.random",round:"Math.round",sin:"Math.sin",sqrt:"Math.sqrt",tan:"Math.tan",clamp:function clamp(args){if(args.length<3)error("Missing arguments to clamp function.");if(args.length>3)error("Too many arguments to clamp function.");var a=args.map(codegen);return"Math.max("+a[1]+", Math.min("+a[2]+","+a[0]+"))"},now:"Date.now",utc:"Date.UTC",datetime:DATE,date:fn("getDate",DATE,0),day:fn("getDay",DATE,0),year:fn("getFullYear",DATE,0),month:fn("getMonth",DATE,0),hours:fn("getHours",DATE,0),minutes:fn("getMinutes",DATE,0),seconds:fn("getSeconds",DATE,0),milliseconds:fn("getMilliseconds",DATE,0),time:fn("getTime",DATE,0),timezoneoffset:fn("getTimezoneOffset",DATE,0),utcdate:fn("getUTCDate",DATE,0),utcday:fn("getUTCDay",DATE,0),utcyear:fn("getUTCFullYear",DATE,0),utcmonth:fn("getUTCMonth",DATE,0),utchours:fn("getUTCHours",DATE,0),utcminutes:fn("getUTCMinutes",DATE,0),utcseconds:fn("getUTCSeconds",DATE,0),utcmilliseconds:fn("getUTCMilliseconds",DATE,0),length:fn("length",null,-1),join:fn("join",null),indexof:fn("indexOf",null),lastindexof:fn("lastIndexOf",null),slice:fn("slice",null),reverse:function reverse(args){return"("+codegen(args[0])+").slice().reverse()"},parseFloat:"parseFloat",parseInt:"parseInt",upper:fn("toUpperCase",STRING,0),lower:fn("toLowerCase",STRING,0),substring:fn("substring",STRING),split:fn("split",STRING),replace:fn("replace",STRING),trim:fn("trim",STRING,0),regexp:REGEXP,test:fn("test",REGEXP),if:function _if(args){if(args.length<3)error("Missing arguments to if function.");if(args.length>3)error("Too many arguments to if function.");var a=args.map(codegen);return"("+a[0]+"?"+a[1]+":"+a[2]+")"}}}function stripQuotes(s){var n=s&&s.length-1;return n&&(s[0]==='"'&&s[n]==='"'||s[0]==="'"&&s[n]==="'")?s.slice(1,-1):s}function codegen(opt){opt=opt||{};var allowed=opt.allowed?toSet(opt.allowed):{},forbidden=opt.forbidden?toSet(opt.forbidden):{},constants=opt.constants||Constants,functions=(opt.functions||Functions)(visit),globalvar=opt.globalvar,fieldvar=opt.fieldvar,outputGlobal=isFunction(globalvar)?globalvar:function(id){return"".concat(globalvar,'["').concat(id,'"]')};var globals={},fields={},memberDepth=0;function visit(ast){if(isString(ast))return ast;var generator=Generators[ast.type];if(generator==null)error("Unsupported type: "+ast.type);return generator(ast)}var Generators={Literal:function Literal(n){return n.raw},Identifier:function Identifier(n){var id=n.name;if(memberDepth>0){return id}else if(_has(forbidden,id)){return error("Illegal identifier: "+id)}else if(_has(constants,id)){return constants[id]}else if(_has(allowed,id)){return id}else{globals[id]=1;return outputGlobal(id)}},MemberExpression:function MemberExpression(n){var d=!n.computed,o=visit(n.object);if(d)memberDepth+=1;var p=visit(n.property);if(o===fieldvar){fields[stripQuotes(p)]=1}if(d)memberDepth-=1;return o+(d?"."+p:"["+p+"]")},CallExpression:function CallExpression(n){if(n.callee.type!=="Identifier"){error("Illegal callee type: "+n.callee.type)}var callee=n.callee.name,args=n.arguments,fn=_has(functions,callee)&&functions[callee];if(!fn)error("Unrecognized function: "+callee);return isFunction(fn)?fn(args):fn+"("+args.map(visit).join(",")+")"},ArrayExpression:function ArrayExpression(n){return"["+n.elements.map(visit).join(",")+"]"},BinaryExpression:function BinaryExpression(n){return"("+visit(n.left)+" "+n.operator+" "+visit(n.right)+")"},UnaryExpression:function UnaryExpression(n){return"("+n.operator+visit(n.argument)+")"},ConditionalExpression:function ConditionalExpression(n){return"("+visit(n.test)+"?"+visit(n.consequent)+":"+visit(n.alternate)+")"},LogicalExpression:function LogicalExpression(n){return"("+visit(n.left)+n.operator+visit(n.right)+")"},ObjectExpression:function ObjectExpression(n){return"{"+n.properties.map(visit).join(",")+"}"},Property:function Property(n){memberDepth+=1;var k=visit(n.key);memberDepth-=1;return k+":"+visit(n.value)}};function codegen(ast){var result={code:visit(ast),globals:Object.keys(globals),fields:Object.keys(fields)};globals={};fields={};return result}codegen.functions=functions;codegen.constants=constants;return codegen}var Intersect="intersect";var Union="union";var VlMulti="vlMulti";var Or="or";var And="and";var TYPE_ENUM="E",TYPE_RANGE_INC="R",TYPE_RANGE_EXC="R-E",TYPE_RANGE_LE="R-LE",TYPE_RANGE_RE="R-RE",UNIT_INDEX="index:unit";function testPoint(datum,entry){var fields=entry.fields,values=entry.values,n=fields.length,i=0,dval,f;for(;i<n;++i){f=fields[i];f.getter=field.getter||field(f.field);dval=f.getter(datum);if(isDate(dval))dval=toNumber(dval);if(isDate(values[i]))values[i]=toNumber(values[i]);if(isDate(values[i][0]))values[i]=values[i].map(toNumber);if(f.type===TYPE_ENUM){if(isArray(values[i])?values[i].indexOf(dval)<0:dval!==values[i]){return false}}else{if(f.type===TYPE_RANGE_INC){if(!inrange(dval,values[i]))return false}else if(f.type===TYPE_RANGE_RE){if(!inrange(dval,values[i],true,false))return false}else if(f.type===TYPE_RANGE_EXC){if(!inrange(dval,values[i],false,false))return false}else if(f.type===TYPE_RANGE_LE){if(!inrange(dval,values[i],false,true))return false}}}return true}function selectionTest(name,datum,op){var data=this.context.data[name],entries=data?data.values.value:[],unitIdx=data?data[UNIT_INDEX]&&data[UNIT_INDEX].value:undefined,intersect=op===Intersect,n=entries.length,i=0,entry,miss,count,unit,b;for(;i<n;++i){entry=entries[i];if(unitIdx&&intersect){miss=miss||{};count=miss[unit=entry.unit]||0;if(count===-1)continue;b=testPoint(datum,entry);miss[unit]=b?-1:++count;if(b&&unitIdx.size===1)return true;if(!b&&count===unitIdx.get(unit).count)return false}else{b=testPoint(datum,entry);if(intersect^b)return b}}return n&&intersect}function selectionResolve(name,op,isMulti){var data=this.context.data[name],entries=data?data.values.value:[],resolved={},multiRes={},types={},entry,fields,values,unit,field,res,resUnit,type,union,n=entries.length,i=0,j,m;for(;i<n;++i){entry=entries[i];unit=entry.unit;fields=entry.fields;values=entry.values;for(j=0,m=fields.length;j<m;++j){field=fields[j];res=resolved[field.field]||(resolved[field.field]={});resUnit=res[unit]||(res[unit]=[]);types[field.field]=type=field.type.charAt(0);union=ops[type+"_union"];res[unit]=union(resUnit,array(values[j]))}if(isMulti){resUnit=multiRes[unit]||(multiRes[unit]=[]);resUnit.push(array(values).reduce((function(obj,curr,j){return obj[fields[j].field]=curr,obj}),{}))}}op=op||Union;Object.keys(resolved).forEach((function(field){resolved[field]=Object.keys(resolved[field]).map((function(unit){return resolved[field][unit]})).reduce((function(acc,curr){return acc===undefined?curr:ops[types[field]+"_"+op](acc,curr)}))}));entries=Object.keys(multiRes);if(isMulti&&entries.length){resolved[VlMulti]=op===Union?_defineProperty({},Or,entries.reduce((function(acc,k){return acc.push.apply(acc,_toConsumableArray(multiRes[k])),acc}),[])):_defineProperty({},And,entries.map((function(k){return _defineProperty({},Or,multiRes[k])})))}return resolved}var ops={E_union:function E_union(base,value){if(!base.length)return value;var i=0,n=value.length;for(;i<n;++i){if(base.indexOf(value[i])<0)base.push(value[i])}return base},E_intersect:function E_intersect(base,value){return!base.length?value:base.filter((function(v){return value.indexOf(v)>=0}))},R_union:function R_union(base,value){var lo=toNumber(value[0]),hi=toNumber(value[1]);if(lo>hi){lo=value[1];hi=value[0]}if(!base.length)return[lo,hi];if(base[0]>lo)base[0]=lo;if(base[1]<hi)base[1]=hi;return base},R_intersect:function R_intersect(base,value){var lo=toNumber(value[0]),hi=toNumber(value[1]);if(lo>hi){lo=value[1];hi=value[0]}if(!base.length)return[lo,hi];if(hi<base[0]||base[1]<lo){return[]}else{if(base[0]<lo)base[0]=lo;if(base[1]>hi)base[1]=hi}return base}};var DataPrefix=":",IndexPrefix="@";function selectionVisitor(name,args,scope,params){if(args[0].type!==Literal)error("First argument to selection functions must be a string literal.");var data=args[0].value,op=args.length>=2&&peek(args).value,field="unit",indexName=IndexPrefix+field,dataName=DataPrefix+data;if(op===Intersect&&!_has(params,indexName)){params[indexName]=scope.getData(data).indataRef(scope,field)}if(!_has(params,dataName)){params[dataName]=scope.getData(data).tuplesRef()}}function data(name){var data=this.context.data[name];return data?data.values.value:[]}function indata(name,field,value){var index=this.context.data[name]["index:"+field],entry=index?index.value.get(value):undefined;return entry?entry.count:entry}function setdata(name,tuples){var df=this.context.dataflow,data=this.context.data[name],input=data.input;df.pulse(input,df.changeset().remove(truthy).insert(tuples));return 1}function encode$1(item,name,retval){if(item){var df=this.context.dataflow,target=item.mark.source;df.pulse(target,df.changeset().encode(item,name))}return retval!==undefined?retval:item}var wrap=function wrap(method){return function(value,spec){var locale=this.context.dataflow.locale();return locale[method](spec)(value)}};var format$3=wrap("format");var timeFormat$1=wrap("timeFormat");var utcFormat$1=wrap("utcFormat");var timeParse$1=wrap("timeParse");var utcParse$1=wrap("utcParse");var dateObj=new Date(2e3,0,1);function time$1(month,day,specifier){if(!Number.isInteger(month)||!Number.isInteger(day))return"";dateObj.setYear(2e3);dateObj.setMonth(month);dateObj.setDate(day);return timeFormat$1.call(this,dateObj,specifier)}function monthFormat(month){return time$1.call(this,month,1,"%B")}function monthAbbrevFormat(month){return time$1.call(this,month,1,"%b")}function dayFormat(day){return time$1.call(this,0,2+day,"%A")}function dayAbbrevFormat(day){return time$1.call(this,0,2+day,"%a")}var DataPrefix$1=":";var IndexPrefix$1="@";var ScalePrefix="%";var SignalPrefix="$";function dataVisitor(name,args,scope,params){if(args[0].type!==Literal){error("First argument to data functions must be a string literal.")}var data=args[0].value,dataName=DataPrefix$1+data;if(!_has(dataName,params)){try{params[dataName]=scope.getData(data).tuplesRef()}catch(err){}}}function indataVisitor(name,args,scope,params){if(args[0].type!==Literal)error("First argument to indata must be a string literal.");if(args[1].type!==Literal)error("Second argument to indata must be a string literal.");var data=args[0].value,field=args[1].value,indexName=IndexPrefix$1+field;if(!_has(indexName,params)){params[indexName]=scope.getData(data).indataRef(scope,field)}}function scaleVisitor(name,args,scope,params){if(args[0].type===Literal){addScaleDependency(scope,params,args[0].value)}else{for(name in scope.scales){addScaleDependency(scope,params,name)}}}function addScaleDependency(scope,params,name){var scaleName=ScalePrefix+name;if(!_has(params,scaleName)){try{params[scaleName]=scope.scaleRef(name)}catch(err){}}}function getScale(name,ctx){var s;return isFunction(name)?name:isString(name)?(s=ctx.scales[name])&&s.value:undefined}function internalScaleFunctions(codegen,fnctx,visitors){fnctx.__bandwidth=function(s){return s&&s.bandwidth?s.bandwidth():0};visitors._bandwidth=scaleVisitor;visitors._range=scaleVisitor;visitors._scale=scaleVisitor;var ref=function ref(arg){return"_["+(arg.type===Literal?$(ScalePrefix+arg.value):$(ScalePrefix)+"+"+codegen(arg))+"]"};return{_bandwidth:function _bandwidth(args){return"this.__bandwidth(".concat(ref(args[0]),")")},_range:function _range(args){return"".concat(ref(args[0]),".range()")},_scale:function _scale(args){return"".concat(ref(args[0]),"(").concat(codegen(args[1]),")")}}}function geoMethod(methodName,globalMethod){return function(projection,geojson,group){if(projection){var p=getScale(projection,(group||this).context);return p&&p.path[methodName](geojson)}else{return globalMethod(geojson)}}}var geoArea=geoMethod("area",geoArea$1);var geoBounds=geoMethod("bounds",geoBounds$1);var geoCentroid=geoMethod("centroid",geoCentroid$1);function inScope(item){var group=this.context.group;var value=false;if(group)while(item){if(item===group){value=true;break}item=item.mark.group}return value}function log$5(df,method,args){try{df[method].apply(df,["EXPRESSION"].concat([].slice.call(args)))}catch(err){df.warn(err)}return args[args.length-1]}function warn(){return log$5(this.context.dataflow,"warn",arguments)}function info(){return log$5(this.context.dataflow,"info",arguments)}function debug(){return log$5(this.context.dataflow,"debug",arguments)}function channel_luminance_value(channelValue){var val=channelValue/255;if(val<=.03928){return val/12.92}return Math.pow((val+.055)/1.055,2.4)}function luminance(color){var c=rgb(color),r=channel_luminance_value(c.r),g=channel_luminance_value(c.g),b=channel_luminance_value(c.b);return.2126*r+.7152*g+.0722*b}function contrast(color1,color2){var lum1=luminance(color1),lum2=luminance(color2),lumL=Math.max(lum1,lum2),lumD=Math.min(lum1,lum2);return(lumL+.05)/(lumD+.05)}function merge$3(){var args=[].slice.call(arguments);args.unshift({});return extend.apply(void 0,_toConsumableArray(args))}function equal(a,b){return a===b||a!==a&&b!==b?true:isArray(a)?isArray(b)&&a.length===b.length?equalArray(a,b):false:isObject(a)&&isObject(b)?equalObject(a,b):false}function equalArray(a,b){for(var i=0,n=a.length;i<n;++i){if(!equal(a[i],b[i]))return false}return true}function equalObject(a,b){for(var key in a){if(!equal(a[key],b[key]))return false}return true}function removePredicate(props){return function(_){return equalObject(props,_)}}function modify(name,insert,remove,toggle,modify,values){var df=this.context.dataflow,data=this.context.data[name],input=data.input,stamp=df.stamp();var changes=data.changes,predicate,key;if(df._trigger===false||!(input.value.length||insert||toggle)){return 0}if(!changes||changes.stamp<stamp){data.changes=changes=df.changeset();changes.stamp=stamp;df.runAfter((function(){data.modified=true;df.pulse(input,changes).run()}),true,1)}if(remove){predicate=remove===true?truthy:isArray(remove)||isTuple(remove)?remove:removePredicate(remove);changes.remove(predicate)}if(insert){changes.insert(insert)}if(toggle){predicate=removePredicate(toggle);if(input.value.some(predicate)){changes.remove(predicate)}else{changes.insert(toggle)}}if(modify){for(key in values){changes.modify(modify,key,values[key])}}return 1}function pinchDistance(event){var t=event.touches,dx=t[0].clientX-t[1].clientX,dy=t[0].clientY-t[1].clientY;return Math.sqrt(dx*dx+dy*dy)}function pinchAngle(event){var t=event.touches;return Math.atan2(t[0].clientY-t[1].clientY,t[0].clientX-t[1].clientX)}function bandspace(count,paddingInner,paddingOuter){return bandSpace(count||0,paddingInner||0,paddingOuter||0)}function bandwidth(name,group){var s=getScale(name,(group||this).context);return s&&s.bandwidth?s.bandwidth():0}function copy$2(name,group){var s=getScale(name,(group||this).context);return s?s.copy():undefined}function domain(name,group){var s=getScale(name,(group||this).context);return s?s.domain():[]}function invert(name,range,group){var s=getScale(name,(group||this).context);return!s?undefined:isArray(range)?(s.invertRange||s.invert)(range):(s.invert||s.invertExtent)(range)}function range$2(name,group){var s=getScale(name,(group||this).context);return s&&s.range?s.range():[]}function scale$2(name,value,group){var s=getScale(name,(group||this).context);return s?s(value):undefined}function scaleGradient(scale$1,p0,p1,count,group){scale$1=getScale(scale$1,(group||this).context);var gradient=Gradient(p0,p1);var stops=scale$1.domain(),min=stops[0],max=peek(stops),fraction=identity;if(!(max-min)){scale$1=(scale$1.interpolator?scale("sequential")().interpolator(scale$1.interpolator()):scale("linear")().interpolate(scale$1.interpolate()).range(scale$1.range())).domain([min=0,max=1])}else{fraction=scaleFraction(scale$1,min,max)}if(scale$1.ticks){stops=scale$1.ticks(+count||15);if(min!==stops[0])stops.unshift(min);if(max!==peek(stops))stops.push(max)}stops.forEach((function(_){return gradient.stop(fraction(_),scale$1(_))}));return gradient}function geoShape(projection,geojson,group){var p=getScale(projection,(group||this).context);return function(context){return p?p.path.context(context)(geojson):""}}function pathShape(path){var p=null;return function(context){return context?pathRender(context,p=p||pathParse(path)):path}}var datum=function datum(d){return d.data};function treeNodes(name,context){var tree=data.call(context,name);return tree.root&&tree.root.lookup||{}}function treePath(name,source,target){var nodes=treeNodes(name,this),s=nodes[source],t=nodes[target];return s&&t?s.path(t).map(datum):undefined}function treeAncestors(name,node){var n=treeNodes(name,this)[node];return n?n.ancestors().map(datum):undefined}var _window=function _window(){return typeof window!=="undefined"&&window||null};function screen(){var w=_window();return w?w.screen:{}}function windowSize(){var w=_window();return w?[w.innerWidth,w.innerHeight]:[undefined,undefined]}function containerSize(){var view=this.context.dataflow,el=view.container&&view.container();return el?[el.clientWidth,el.clientHeight]:[undefined,undefined]}function intersect$3(b,opt,group){if(!b)return[];var _b=_slicedToArray(b,2),u=_b[0],v=_b[1],box=(new Bounds).set(u[0],u[1],v[0],v[1]),scene=group||this.context.dataflow.scenegraph().root;return intersect$1(scene,box,filter$1(opt))}function filter$1(opt){var p=null;if(opt){var types=array(opt.marktype),names=array(opt.markname);p=function p(_){return(!types.length||types.some((function(t){return _.marktype===t})))&&(!names.length||names.some((function(s){return _.name===s})))}}return p}var functionContext={random:function random(){return exports.random()},cumulativeNormal:cumulativeNormal,cumulativeLogNormal:cumulativeLogNormal,cumulativeUniform:cumulativeUniform,densityNormal:densityNormal,densityLogNormal:densityLogNormal,densityUniform:densityUniform,quantileNormal:quantileNormal,quantileLogNormal:quantileLogNormal,quantileUniform:quantileUniform,sampleNormal:sampleNormal,sampleLogNormal:sampleLogNormal,sampleUniform:sampleUniform,isArray:isArray,isBoolean:isBoolean,isDate:isDate,isDefined:function isDefined(_){return _!==undefined},isNumber:isNumber,isObject:isObject,isRegExp:isRegExp,isString:isString,isTuple:isTuple,isValid:function isValid(_){return _!=null&&_===_},toBoolean:toBoolean,toDate:toDate,toNumber:toNumber,toString:toString,flush:flush,lerp:lerp,merge:merge$3,pad:pad,peek:peek,span:span,inrange:inrange,truncate:truncate,rgb:rgb,lab:lab,hcl:hcl,hsl:hsl,luminance:luminance,contrast:contrast,sequence:range$1,format:format$3,utcFormat:utcFormat$1,utcParse:utcParse$1,utcOffset:utcOffset,utcSequence:utcSequence,timeFormat:timeFormat$1,timeParse:timeParse$1,timeOffset:timeOffset,timeSequence:timeSequence,timeUnitSpecifier:timeUnitSpecifier,monthFormat:monthFormat,monthAbbrevFormat:monthAbbrevFormat,dayFormat:dayFormat,dayAbbrevFormat:dayAbbrevFormat,quarter:quarter,utcquarter:utcquarter,week:week,utcweek:utcweek,dayofyear:dayofyear,utcdayofyear:utcdayofyear,warn:warn,info:info,debug:debug,extent:extent,inScope:inScope,intersect:intersect$3,clampRange:clampRange,pinchDistance:pinchDistance,pinchAngle:pinchAngle,screen:screen,containerSize:containerSize,windowSize:windowSize,bandspace:bandspace,setdata:setdata,pathShape:pathShape,panLinear:panLinear,panLog:panLog,panPow:panPow,panSymlog:panSymlog,zoomLinear:zoomLinear,zoomLog:zoomLog,zoomPow:zoomPow,zoomSymlog:zoomSymlog,encode:encode$1,modify:modify};var eventFunctions=["view","item","group","xy","x","y"],eventPrefix="event.vega.",thisPrefix="this.",astVisitors={};var codegenParams={forbidden:["_"],allowed:["datum","event","item"],fieldvar:"datum",globalvar:function globalvar(id){return"_[".concat($(SignalPrefix+id),"]")},functions:buildFunctions,constants:Constants,visitors:astVisitors};var codeGenerator=codegen(codegenParams);function buildFunctions(codegen){var fn=Functions(codegen);eventFunctions.forEach((function(name){return fn[name]=eventPrefix+name}));for(var name in functionContext){fn[name]=thisPrefix+name}extend(fn,internalScaleFunctions(codegen,functionContext,astVisitors));return fn}function expressionFunction(name,fn,visitor){if(arguments.length===1){return functionContext[name]}functionContext[name]=fn;if(visitor)astVisitors[name]=visitor;if(codeGenerator)codeGenerator.functions[name]=thisPrefix+name;return this}expressionFunction("bandwidth",bandwidth,scaleVisitor);expressionFunction("copy",copy$2,scaleVisitor);expressionFunction("domain",domain,scaleVisitor);expressionFunction("range",range$2,scaleVisitor);expressionFunction("invert",invert,scaleVisitor);expressionFunction("scale",scale$2,scaleVisitor);expressionFunction("gradient",scaleGradient,scaleVisitor);expressionFunction("geoArea",geoArea,scaleVisitor);expressionFunction("geoBounds",geoBounds,scaleVisitor);expressionFunction("geoCentroid",geoCentroid,scaleVisitor);expressionFunction("geoShape",geoShape,scaleVisitor);expressionFunction("indata",indata,indataVisitor);expressionFunction("data",data,dataVisitor);expressionFunction("treePath",treePath,dataVisitor);expressionFunction("treeAncestors",treeAncestors,dataVisitor);expressionFunction("vlSelectionTest",selectionTest,selectionVisitor);expressionFunction("vlSelectionResolve",selectionResolve,selectionVisitor);function parser$1(expr,scope){var params={};var ast;try{expr=isString(expr)?expr:$(expr)+"";ast=parser(expr)}catch(err){error("Expression parse error: "+expr)}ast.visit((function(node){if(node.type!==CallExpression)return;var name=node.callee.name,visit=codegenParams.visitors[name];if(visit)visit(name,node.arguments,scope,params)}));var gen=codeGenerator(ast);gen.globals.forEach((function(name){var signalName=SignalPrefix+name;if(!_has(params,signalName)&&scope.getSignal(name)){params[signalName]=scope.signalRef(name)}}));return{$expr:extend({code:gen.code},scope.options.ast?{ast:ast}:null),$fields:gen.fields,$params:params}}function parse$3(spec){var ctx=this,operators=spec.operators||[];if(spec.background){ctx.background=spec.background}if(spec.eventConfig){ctx.eventConfig=spec.eventConfig}if(spec.locale){ctx.locale=spec.locale}operators.forEach((function(entry){return ctx.parseOperator(entry)}));operators.forEach((function(entry){return ctx.parseOperatorParameters(entry)}));(spec.streams||[]).forEach((function(entry){return ctx.parseStream(entry)}));(spec.updates||[]).forEach((function(entry){return ctx.parseUpdate(entry)}));return ctx.resolve()}var Skip=toSet(["rule"]),Swap=toSet(["group","image","rect"]);function adjustSpatial(encode,marktype){var code="";if(Skip[marktype])return code;if(encode.x2){if(encode.x){if(Swap[marktype]){code+="if(o.x>o.x2)$=o.x,o.x=o.x2,o.x2=$;"}code+="o.width=o.x2-o.x;"}else{code+="o.x=o.x2-(o.width||0);"}}if(encode.xc){code+="o.x=o.xc-(o.width||0)/2;"}if(encode.y2){if(encode.y){if(Swap[marktype]){code+="if(o.y>o.y2)$=o.y,o.y=o.y2,o.y2=$;"}code+="o.height=o.y2-o.y;"}else{code+="o.y=o.y2-(o.height||0);"}}if(encode.yc){code+="o.y=o.yc-(o.height||0)/2;"}return code}function canonicalType(type){return(type+"").toLowerCase()}function isOperator(type){return canonicalType(type)==="operator"}function isCollect(type){return canonicalType(type)==="collect"}function expression(ctx,args,code){if(code[code.length-1]!==";"){code="return("+code+");"}var fn=Function.apply(void 0,_toConsumableArray(args.concat(code)));return ctx&&ctx.functions?fn.bind(ctx.functions):fn}function _compare(u,v,lt,gt){return"((u = ".concat(u,") < (v = ").concat(v,") || u == null) && v != null ? ").concat(lt,"\n  : (u > v || v == null) && u != null ? ").concat(gt,"\n  : ((v = v instanceof Date ? +v : v), (u = u instanceof Date ? +u : u)) !== u && v === v ? ").concat(lt,"\n  : v !== v && u === u ? ").concat(gt," : ")}var expressionCodegen={operator:function operator(ctx,expr){return expression(ctx,["_"],expr.code)},parameter:function parameter(ctx,expr){return expression(ctx,["datum","_"],expr.code)},event:function event(ctx,expr){return expression(ctx,["event"],expr.code)},handler:function handler(ctx,expr){var code="var datum=event.item&&event.item.datum;return ".concat(expr.code,";");return expression(ctx,["_","event"],code)},encode:function encode(ctx,_encode){var marktype=_encode.marktype,channels=_encode.channels;var code="var o=item,datum=o.datum,m=0,$;";for(var name in channels){var o="o["+$(name)+"]";code+="$=".concat(channels[name].code,";if(").concat(o,"!==$)").concat(o,"=$,m=1;")}code+=adjustSpatial(channels,marktype);code+="return m;";return expression(ctx,["item","_"],code)},codegen:{get:function get(path){var ref="[".concat(path.map($).join("]["),"]");var get=Function("_","return _".concat(ref,";"));get.path=ref;return get},comparator:function comparator(fields,orders){var t;var map=function map(f,i){var o=orders[i];var u,v;if(f.path){u="a".concat(f.path);v="b".concat(f.path)}else{(t=t||{})["f"+i]=f;u="this.f".concat(i,"(a)");v="this.f".concat(i,"(b)")}return _compare(u,v,-o,o)};var fn=Function("a","b","var u, v; return "+fields.map(map).join("")+"0;");return t?fn.bind(t):fn}}};function parseOperator(spec){var ctx=this;if(isOperator(spec.type)||!spec.type){ctx.operator(spec,spec.update?ctx.operatorExpression(spec.update):null)}else{ctx.transform(spec,spec.type)}}function parseOperatorParameters(spec){var ctx=this;if(spec.params){var op=ctx.get(spec.id);if(!op)error("Invalid operator id: "+spec.id);ctx.dataflow.connect(op,op.parameters(ctx.parseParameters(spec.params),spec.react,spec.initonly))}}function parseParameters(spec,params){params=params||{};var ctx=this;for(var _key in spec){var value=spec[_key];params[_key]=isArray(value)?value.map((function(v){return parseParameter(v,ctx,params)})):parseParameter(value,ctx,params)}return params}function parseParameter(spec,ctx,params){if(!spec||!isObject(spec))return spec;for(var i=0,n=PARSERS.length,p;i<n;++i){p=PARSERS[i];if(_has(spec,p.key)){return p.parse(spec,ctx,params)}}return spec}var PARSERS=[{key:"$ref",parse:getOperator},{key:"$key",parse:getKey},{key:"$expr",parse:getExpression},{key:"$field",parse:getField$1},{key:"$encode",parse:getEncode},{key:"$compare",parse:getCompare},{key:"$context",parse:getContext},{key:"$subflow",parse:getSubflow},{key:"$tupleid",parse:getTupleId}];function getOperator(_,ctx){return ctx.get(_.$ref)||error("Operator not defined: "+_.$ref)}function getExpression(_,ctx,params){if(_.$params){ctx.parseParameters(_.$params,params)}var k="e:"+_.$expr.code+"_"+_.$name;return ctx.fn[k]||(ctx.fn[k]=accessor(ctx.parameterExpression(_.$expr),_.$fields,_.$name))}function getKey(_,ctx){var k="k:"+_.$key+"_"+!!_.$flat;return ctx.fn[k]||(ctx.fn[k]=key(_.$key,_.$flat,ctx.expr.codegen))}function getField$1(_,ctx){if(!_.$field)return null;var k="f:"+_.$field+"_"+_.$name;return ctx.fn[k]||(ctx.fn[k]=field(_.$field,_.$name,ctx.expr.codegen))}function getCompare(_,ctx){var k="c:"+_.$compare+"_"+_.$order,c=array(_.$compare).map((function(_){return _&&_.$tupleid?tupleid:_}));return ctx.fn[k]||(ctx.fn[k]=compare(c,_.$order,ctx.expr.codegen))}function getEncode(_,ctx){var spec=_.$encode,encode={};for(var name in spec){var enc=spec[name];encode[name]=accessor(ctx.encodeExpression(enc.$expr),enc.$fields);encode[name].output=enc.$output}return encode}function getContext(_,ctx){return ctx}function getSubflow(_,ctx){var spec=_.$subflow;return function(dataflow,key,parent){var subctx=ctx.fork().parse(spec),op=subctx.get(spec.operators[0].id),p=subctx.signals.parent;if(p)p.set(parent);op.detachSubflow=function(){return ctx.detach(subctx)};return op}}function getTupleId(){return tupleid}function parseStream(spec){var ctx=this,filter=spec.filter!=null?ctx.eventExpression(spec.filter):undefined,stream=spec.stream!=null?ctx.get(spec.stream):undefined,args;if(spec.source){stream=ctx.events(spec.source,spec.type,filter)}else if(spec.merge){args=spec.merge.map((function(_){return ctx.get(_)}));stream=args[0].merge.apply(args[0],args.slice(1))}if(spec.between){args=spec.between.map((function(_){return ctx.get(_)}));stream=stream.between(args[0],args[1])}if(spec.filter){stream=stream.filter(filter)}if(spec.throttle!=null){stream=stream.throttle(+spec.throttle)}if(spec.debounce!=null){stream=stream.debounce(+spec.debounce)}if(stream==null){error("Invalid stream definition: "+JSON.stringify(spec))}if(spec.consume)stream.consume(true);ctx.stream(spec,stream)}function parseUpdate(spec){var ctx=this,srcid=isObject(srcid=spec.source)?srcid.$ref:srcid,source=ctx.get(srcid),target=null,update=spec.update,params=undefined;if(!source)error("Source not defined: "+spec.source);target=spec.target&&spec.target.$expr?ctx.eventExpression(spec.target.$expr):ctx.get(spec.target);if(update&&update.$expr){if(update.$params){params=ctx.parseParameters(update.$params)}update=ctx.handlerExpression(update.$expr)}ctx.update(spec,source,target,update,params)}var SKIP$3={skip:true};function getState(options){var ctx=this,state={};if(options.signals){var signals=state.signals={};Object.keys(ctx.signals).forEach((function(key){var op=ctx.signals[key];if(options.signals(key,op)){signals[key]=op.value}}))}if(options.data){var data=state.data={};Object.keys(ctx.data).forEach((function(key){var dataset=ctx.data[key];if(options.data(key,dataset)){data[key]=dataset.input.value}}))}if(ctx.subcontext&&options.recurse!==false){state.subcontext=ctx.subcontext.map((function(ctx){return ctx.getState(options)}))}return state}function setState(state){var ctx=this,df=ctx.dataflow,data=state.data,signals=state.signals;Object.keys(signals||{}).forEach((function(key){df.update(ctx.signals[key],signals[key],SKIP$3)}));Object.keys(data||{}).forEach((function(key){df.pulse(ctx.data[key].input,df.changeset().remove(truthy).insert(data[key]))}));(state.subcontext||[]).forEach((function(substate,i){var subctx=ctx.subcontext[i];if(subctx)subctx.setState(substate)}))}function context$2(df,transforms,functions,expr){return new Context(df,transforms,functions,expr)}function Context(df,transforms,functions,expr){this.dataflow=df;this.transforms=transforms;this.events=df.events.bind(df);this.expr=expr||expressionCodegen,this.signals={};this.scales={};this.nodes={};this.data={};this.fn={};if(functions){this.functions=Object.create(functions);this.functions.context=this}}function Subcontext(ctx){this.dataflow=ctx.dataflow;this.transforms=ctx.transforms;this.events=ctx.events;this.expr=ctx.expr;this.signals=Object.create(ctx.signals);this.scales=Object.create(ctx.scales);this.nodes=Object.create(ctx.nodes);this.data=Object.create(ctx.data);this.fn=Object.create(ctx.fn);if(ctx.functions){this.functions=Object.create(ctx.functions);this.functions.context=this}}Context.prototype=Subcontext.prototype={fork:function fork(){var ctx=new Subcontext(this);(this.subcontext||(this.subcontext=[])).push(ctx);return ctx},detach:function detach(ctx){this.subcontext=this.subcontext.filter((function(c){return c!==ctx}));var keys=Object.keys(ctx.nodes);for(var _i=0,_keys=keys;_i<_keys.length;_i++){var _key2=_keys[_i];ctx.nodes[_key2]._targets=null}for(var _i2=0,_keys2=keys;_i2<_keys2.length;_i2++){var _key3=_keys2[_i2];ctx.nodes[_key3].detach()}ctx.nodes=null},get:function get(id){return this.nodes[id]},set:function set(id,node){return this.nodes[id]=node},add:function add(spec,op){var ctx=this,df=ctx.dataflow,data=spec.value;ctx.set(spec.id,op);if(isCollect(spec.type)&&data){if(data.$ingest){df.ingest(op,data.$ingest,data.$format)}else if(data.$request){df.preload(op,data.$request,data.$format)}else{df.pulse(op,df.changeset().insert(data))}}if(spec.root){ctx.root=op}if(spec.parent){var p=ctx.get(spec.parent.$ref);if(p){df.connect(p,[op]);op.targets().add(p)}else{(ctx.unresolved=ctx.unresolved||[]).push((function(){p=ctx.get(spec.parent.$ref);df.connect(p,[op]);op.targets().add(p)}))}}if(spec.signal){ctx.signals[spec.signal]=op}if(spec.scale){ctx.scales[spec.scale]=op}if(spec.data){var _loop=function _loop(name){var data=ctx.data[name]||(ctx.data[name]={});spec.data[name].forEach((function(role){return data[role]=op}))};for(var name in spec.data){_loop(name)}}},resolve:function resolve(){(this.unresolved||[]).forEach((function(fn){return fn()}));delete this.unresolved;return this},operator:function operator(spec,update){this.add(spec,this.dataflow.add(spec.value,update))},transform:function transform(spec,type){this.add(spec,this.dataflow.add(this.transforms[canonicalType(type)]))},stream:function stream(spec,_stream){this.set(spec.id,_stream)},update:function update(spec,stream,target,_update,params){this.dataflow.on(stream,target,_update,params,spec.options)},operatorExpression:function operatorExpression(expr){return this.expr.operator(this,expr)},parameterExpression:function parameterExpression(expr){return this.expr.parameter(this,expr)},eventExpression:function eventExpression(expr){return this.expr.event(this,expr)},handlerExpression:function handlerExpression(expr){return this.expr.handler(this,expr)},encodeExpression:function encodeExpression(encode){return this.expr.encode(this,encode)},parse:parse$3,parseOperator:parseOperator,parseOperatorParameters:parseOperatorParameters,parseParameters:parseParameters,parseStream:parseStream,parseUpdate:parseUpdate,getState:getState,setState:setState};function initializeAria(view){var el=view.container();if(el){el.setAttribute("role","graphics-document");el.setAttribute("aria-roleDescription","visualization");ariaLabel(el,view.description())}}function ariaLabel(el,desc){if(el)desc==null?el.removeAttribute("aria-label"):el.setAttribute("aria-label",desc)}function background$1(view){view.add(null,(function(_){view._background=_.bg;view._resize=1;return _.bg}),{bg:view._signals.background})}var Default="default";function cursor(view){var cursor=view._signals.cursor||(view._signals.cursor=view.add({user:Default,item:null}));view.on(view.events("view","mousemove"),cursor,(function(_,event){var value=cursor.value,user=value?isString(value)?value:value.user:Default,item=event.item&&event.item.cursor||null;return value&&user===value.user&&item==value.item?value:{user:user,item:item}}));view.add(null,(function(_){var user=_.cursor,item=this.value;if(!isString(user)){item=user.item;user=user.user}setCursor(view,user&&user!==Default?user:item||user);return item}),{cursor:cursor})}function setCursor(view,cursor){var el=view.globalCursor()?typeof document!=="undefined"&&document.body:view.container();if(el){return cursor==null?el.style.removeProperty("cursor"):el.style.cursor=cursor}}function dataref(view,name){var data=view._runtime.data;if(!_has(data,name)){error("Unrecognized data set: "+name)}return data[name]}function data$1(name,values){return arguments.length<2?dataref(this,name).values.value:change.call(this,name,changeset().remove(truthy).insert(values))}function change(name,changes){if(!isChangeSet(changes)){error("Second argument to changes must be a changeset.")}var dataset=dataref(this,name);dataset.modified=true;return this.pulse(dataset.input,changes)}function insert(name,_){return change.call(this,name,changeset().insert(_))}function remove(name,_){return change.call(this,name,changeset().remove(_))}function width(view){var padding=view.padding();return Math.max(0,view._viewWidth+padding.left+padding.right)}function height(view){var padding=view.padding();return Math.max(0,view._viewHeight+padding.top+padding.bottom)}function offset$2(view){var padding=view.padding(),origin=view._origin;return[padding.left+origin[0],padding.top+origin[1]]}function resizeRenderer(view){var origin=offset$2(view),w=width(view),h=height(view);view._renderer.background(view.background());view._renderer.resize(w,h,origin);view._handler.origin(origin);view._resizeListeners.forEach((function(handler){try{handler(w,h)}catch(error){view.error(error)}}))}function eventExtend(view,event,item){var r=view._renderer,el=r&&r.canvas(),p,e,translate;if(el){translate=offset$2(view);e=event.changedTouches?event.changedTouches[0]:event;p=point$1(e,el);p[0]-=translate[0];p[1]-=translate[1]}event.dataflow=view;event.item=item;event.vega=extension(view,item,p);return event}function extension(view,item,point){var itemGroup=item?item.mark.marktype==="group"?item:item.mark.group:null;function group(name){var g=itemGroup,i;if(name)for(i=item;i;i=i.mark.group){if(i.mark.name===name){g=i;break}}return g&&g.mark&&g.mark.interactive?g:{}}function xy(item){if(!item)return point;if(isString(item))item=group(item);var p=point.slice();while(item){p[0]-=item.x||0;p[1]-=item.y||0;item=item.mark&&item.mark.group}return p}return{view:constant(view),item:constant(item||{}),group:group,xy:xy,x:function x(item){return xy(item)[0]},y:function y(item){return xy(item)[1]}}}var VIEW="view",TIMER="timer",WINDOW="window",NO_TRAP={trap:false};function initializeEventConfig(config){var events=extend({defaults:{}},config);var unpack=function unpack(obj,keys){keys.forEach((function(k){if(isArray(obj[k]))obj[k]=toSet(obj[k])}))};unpack(events.defaults,["prevent","allow"]);unpack(events,["view","window","selector"]);return events}function prevent(view,type){var def=view._eventConfig.defaults,prevent=def.prevent,allow=def.allow;return prevent===false||allow===true?false:prevent===true||allow===false?true:prevent?prevent[type]:allow?!allow[type]:view.preventDefault()}function permit(view,key,type){var rule=view._eventConfig&&view._eventConfig[key];if(rule===false||isObject(rule)&&!rule[type]){view.warn("Blocked ".concat(key," ").concat(type," event listener."));return false}return true}function events$1(source,type,filter){var view=this,s=new EventStream(filter),send=function send(e,item){view.runAsync(null,(function(){if(source===VIEW&&prevent(view,type)){e.preventDefault()}s.receive(eventExtend(view,e,item))}))},sources;if(source===TIMER){if(permit(view,"timer",type)){view.timer(send,type)}}else if(source===VIEW){if(permit(view,"view",type)){view.addEventListener(type,send,NO_TRAP)}}else{if(source===WINDOW){if(permit(view,"window",type)&&typeof window!=="undefined"){sources=[window]}}else if(typeof document!=="undefined"){if(permit(view,"selector",type)){sources=document.querySelectorAll(source)}}if(!sources){view.warn("Can not resolve event source: "+source)}else{for(var i=0,n=sources.length;i<n;++i){sources[i].addEventListener(type,send)}view._eventListeners.push({type:type,sources:sources,handler:send})}}return s}function itemFilter(event){return event.item}function markTarget(event){return event.item.mark.source}function invoke(name){return function(_,event){return event.vega.view().changeset().encode(event.item,name)}}function hover(hoverSet,leaveSet){hoverSet=[hoverSet||"hover"];leaveSet=[leaveSet||"update",hoverSet[0]];this.on(this.events("view","mouseover",itemFilter),markTarget,invoke(hoverSet));this.on(this.events("view","mouseout",itemFilter),markTarget,invoke(leaveSet));return this}function finalize(){var tooltip=this._tooltip,timers=this._timers,listeners=this._eventListeners,n,m,e;n=timers.length;while(--n>=0){timers[n].stop()}n=listeners.length;while(--n>=0){e=listeners[n];m=e.sources.length;while(--m>=0){e.sources[m].removeEventListener(e.type,e.handler)}}if(tooltip){tooltip.call(this,this._handler,null,null,null)}return this}function element$1(tag,attr,text){var el=document.createElement(tag);for(var key in attr){el.setAttribute(key,attr[key])}if(text!=null)el.textContent=text;return el}var BindClass="vega-bind",NameClass="vega-bind-name",RadioClass="vega-bind-radio";function bind$1(view,el,binding){if(!el)return;var param=binding.param;var bind=binding.state;if(!bind){bind=binding.state={elements:null,active:false,set:null,update:function update(value){if(value!==view.signal(param.signal)){view.runAsync(null,(function(){bind.source=true;view.signal(param.signal,value)}))}}};if(param.debounce){bind.update=debounce(param.debounce,bind.update)}}generate(bind,el,param,view.signal(param.signal));if(!bind.active){view.on(view._signals[param.signal],null,(function(){bind.source?bind.source=false:bind.set(view.signal(param.signal))}));bind.active=true}return bind}function generate(bind,el,param,value){var div=element$1("div",{class:BindClass});var wrapper=param.input==="radio"?div:div.appendChild(element$1("label"));wrapper.appendChild(element$1("span",{class:NameClass},param.name||param.signal));el.appendChild(div);var input=form;switch(param.input){case"checkbox":input=checkbox;break;case"select":input=select;break;case"radio":input=radio;break;case"range":input=range$3;break}input(bind,wrapper,param,value)}function form(bind,el,param,value){var node=element$1("input");for(var key in param){if(key!=="signal"&&key!=="element"){node.setAttribute(key==="input"?"type":key,param[key])}}node.setAttribute("name",param.signal);node.value=value;el.appendChild(node);node.addEventListener("input",(function(){return bind.update(node.value)}));bind.elements=[node];bind.set=function(value){return node.value=value}}function checkbox(bind,el,param,value){var attr={type:"checkbox",name:param.signal};if(value)attr.checked=true;var node=element$1("input",attr);el.appendChild(node);node.addEventListener("change",(function(){return bind.update(node.checked)}));bind.elements=[node];bind.set=function(value){return node.checked=!!value||null}}function select(bind,el,param,value){var node=element$1("select",{name:param.signal}),labels=param.labels||[];param.options.forEach((function(option,i){var attr={value:option};if(valuesEqual(option,value))attr.selected=true;node.appendChild(element$1("option",attr,(labels[i]||option)+""))}));el.appendChild(node);node.addEventListener("change",(function(){bind.update(param.options[node.selectedIndex])}));bind.elements=[node];bind.set=function(value){for(var i=0,n=param.options.length;i<n;++i){if(valuesEqual(param.options[i],value)){node.selectedIndex=i;return}}}}function radio(bind,el,param,value){var group=element$1("span",{class:RadioClass}),labels=param.labels||[];el.appendChild(group);bind.elements=param.options.map((function(option,i){var attr={type:"radio",name:param.signal,value:option};if(valuesEqual(option,value))attr.checked=true;var input=element$1("input",attr);input.addEventListener("change",(function(){return bind.update(option)}));var label=element$1("label",{},(labels[i]||option)+"");label.prepend(input);group.appendChild(label);return input}));bind.set=function(value){var nodes=bind.elements,n=nodes.length;for(var i=0;i<n;++i){if(valuesEqual(nodes[i].value,value))nodes[i].checked=true}}}function range$3(bind,el,param,value){value=value!==undefined?value:(+param.max+ +param.min)/2;var max=param.max!=null?param.max:Math.max(100,+value)||100,min=param.min||Math.min(0,max,+value)||0,step=param.step||tickStep(min,max,100);var node=element$1("input",{type:"range",name:param.signal,min:min,max:max,step:step});node.value=value;var span=element$1("span",{},+value);el.appendChild(node);el.appendChild(span);var update=function update(){span.textContent=node.value;bind.update(+node.value)};node.addEventListener("input",update);node.addEventListener("change",update);bind.elements=[node];bind.set=function(value){node.value=value;span.textContent=value}}function valuesEqual(a,b){return a===b||a+""===b+""}function initializeRenderer(view,r,el,constructor,scaleFactor,opt){r=r||new constructor(view.loader());return r.initialize(el,width(view),height(view),offset$2(view),scaleFactor,opt).background(view.background())}function trap(view,fn){return!fn?null:function(){try{fn.apply(this,arguments)}catch(error){view.error(error)}}}function initializeHandler(view,prevHandler,el,constructor){var handler=new constructor(view.loader(),trap(view,view.tooltip())).scene(view.scenegraph().root).initialize(el,offset$2(view),view);if(prevHandler){prevHandler.handlers().forEach((function(h){handler.on(h.type,h.handler)}))}return handler}function initialize$1(el,elBind){var view=this,type=view._renderType,config=view._eventConfig.bind,module=renderModule(type);el=view._el=el?lookup$3(view,el):null;initializeAria(view);if(!module)view.error("Unrecognized renderer type: "+type);var Handler=module.handler||CanvasHandler,Renderer=el?module.renderer:module.headless;view._renderer=!Renderer?null:initializeRenderer(view,view._renderer,el,Renderer);view._handler=initializeHandler(view,view._handler,el,Handler);view._redraw=true;if(el&&config!=="none"){elBind=elBind?view._elBind=lookup$3(view,elBind):el.appendChild(element$1("form",{class:"vega-bindings"}));view._bind.forEach((function(_){if(_.param.element&&config!=="container"){_.element=lookup$3(view,_.param.element)}}));view._bind.forEach((function(_){bind$1(view,_.element||elBind,_)}))}return view}function lookup$3(view,el){if(typeof el==="string"){if(typeof document!=="undefined"){el=document.querySelector(el);if(!el){view.error("Signal bind element not found: "+el);return null}}else{view.error("DOM document instance not found.");return null}}if(el){try{el.innerHTML=""}catch(e){el=null;view.error(e)}}return el}var number$5=function number(_){return+_||0};var paddingObject=function paddingObject(_){return{top:_,bottom:_,left:_,right:_}};function _padding(_){return isObject(_)?{top:number$5(_.top),bottom:number$5(_.bottom),left:number$5(_.left),right:number$5(_.right)}:paddingObject(number$5(_))}function renderHeadless(_x,_x2,_x3,_x4){return _renderHeadless.apply(this,arguments)}function _renderHeadless(){_renderHeadless=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(view,type,scaleFactor,opt){var module,ctr;return regeneratorRuntime.wrap((function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:module=renderModule(type),ctr=module&&module.headless;if(!ctr)error("Unrecognized renderer type: "+type);_context2.next=4;return view.runAsync();case 4:return _context2.abrupt("return",initializeRenderer(view,null,null,ctr,scaleFactor,opt).renderAsync(view._scenegraph.root));case 5:case"end":return _context2.stop()}}}),_callee2)})));return _renderHeadless.apply(this,arguments)}function renderToImageURL(_x5,_x6){return _renderToImageURL.apply(this,arguments)}function _renderToImageURL(){_renderToImageURL=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(type,scaleFactor){var r;return regeneratorRuntime.wrap((function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(type!==RenderType.Canvas&&type!==RenderType.SVG&&type!==RenderType.PNG){error("Unrecognized image type: "+type)}_context3.next=3;return renderHeadless(this,type,scaleFactor);case 3:r=_context3.sent;return _context3.abrupt("return",type===RenderType.SVG?toBlobURL(r.svg(),"image/svg+xml"):r.canvas().toDataURL("image/png"));case 5:case"end":return _context3.stop()}}}),_callee3,this)})));return _renderToImageURL.apply(this,arguments)}function toBlobURL(data,mime){var blob=new Blob([data],{type:mime});return window.URL.createObjectURL(blob)}function renderToCanvas(_x7,_x8){return _renderToCanvas.apply(this,arguments)}function _renderToCanvas(){_renderToCanvas=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(scaleFactor,opt){var r;return regeneratorRuntime.wrap((function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return renderHeadless(this,RenderType.Canvas,scaleFactor,opt);case 2:r=_context4.sent;return _context4.abrupt("return",r.canvas());case 4:case"end":return _context4.stop()}}}),_callee4,this)})));return _renderToCanvas.apply(this,arguments)}function renderToSVG(_x9){return _renderToSVG.apply(this,arguments)}function _renderToSVG(){_renderToSVG=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(scaleFactor){var r;return regeneratorRuntime.wrap((function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return renderHeadless(this,RenderType.SVG,scaleFactor);case 2:r=_context5.sent;return _context5.abrupt("return",r.svg());case 4:case"end":return _context5.stop()}}}),_callee5,this)})));return _renderToSVG.apply(this,arguments)}function runtime(view,spec,expr){return context$2(view,transforms,functionContext,expr).parse(spec)}function scale$3(name){var scales=this._runtime.scales;if(!_has(scales,name)){error("Unrecognized scale or projection: "+name)}return scales[name].value}var Width="width",Height="height",Padding$1="padding",Skip$1={skip:true};function viewWidth(view,width){var a=view.autosize(),p=view.padding();return width-(a&&a.contains===Padding$1?p.left+p.right:0)}function viewHeight(view,height){var a=view.autosize(),p=view.padding();return height-(a&&a.contains===Padding$1?p.top+p.bottom:0)}function initializeResize(view){var s=view._signals,w=s[Width],h=s[Height],p=s[Padding$1];function resetSize(){view._autosize=view._resize=1}view._resizeWidth=view.add(null,(function(_){view._width=_.size;view._viewWidth=viewWidth(view,_.size);resetSize()}),{size:w});view._resizeHeight=view.add(null,(function(_){view._height=_.size;view._viewHeight=viewHeight(view,_.size);resetSize()}),{size:h});var resizePadding=view.add(null,resetSize,{pad:p});view._resizeWidth.rank=w.rank+1;view._resizeHeight.rank=h.rank+1;resizePadding.rank=p.rank+1}function resizeView(viewWidth,viewHeight,width,height,origin,auto){this.runAfter((function(view){var rerun=0;view._autosize=0;if(view.width()!==width){rerun=1;view.signal(Width,width,Skip$1);view._resizeWidth.skip(true)}if(view.height()!==height){rerun=1;view.signal(Height,height,Skip$1);view._resizeHeight.skip(true)}if(view._viewWidth!==viewWidth){view._resize=1;view._viewWidth=viewWidth}if(view._viewHeight!==viewHeight){view._resize=1;view._viewHeight=viewHeight}if(view._origin[0]!==origin[0]||view._origin[1]!==origin[1]){view._resize=1;view._origin=origin}if(rerun)view.run("enter");if(auto)view.runAfter((function(v){return v.resize()}))}),false,1)}function getState$1(options){return this._runtime.getState(options||{data:dataTest,signals:signalTest,recurse:true})}function dataTest(name,data){return data.modified&&isArray(data.input.value)&&name.indexOf("_:vega:_")}function signalTest(name,op){return!(name==="parent"||op instanceof transforms.proxy)}function setState$1(state){this.runAsync(null,(function(v){v._trigger=false;v._runtime.setState(state)}),(function(v){v._trigger=true}));return this}function timer$1(callback,delay){function tick(elapsed){callback({timestamp:Date.now(),elapsed:elapsed})}this._timers.push(interval$1(tick,delay))}function defaultTooltip$1(handler,event,item,value){var el=handler.element();if(el)el.setAttribute("title",formatTooltip(value))}function formatTooltip(value){return value==null?"":isArray(value)?formatArray(value):isObject(value)&&!isDate(value)?formatObject(value):value+""}function formatObject(obj){return Object.keys(obj).map((function(key){var v=obj[key];return key+": "+(isArray(v)?formatArray(v):formatValue$1(v))})).join("\n")}function formatArray(value){return"["+value.map(formatValue$1).join(", ")+"]"}function formatValue$1(value){return isArray(value)?"[]":isObject(value)&&!isDate(value)?"{}":value}function View(spec,options){var view=this;options=options||{};Dataflow.call(view);if(options.loader)view.loader(options.loader);if(options.logger)view.logger(options.logger);if(options.logLevel!=null)view.logLevel(options.logLevel);if(options.locale||spec.locale){var loc=extend({},spec.locale,options.locale);view.locale(locale$2(loc.number,loc.time))}view._el=null;view._elBind=null;view._renderType=options.renderer||RenderType.Canvas;view._scenegraph=new Scenegraph;var root=view._scenegraph.root;view._renderer=null;view._tooltip=options.tooltip||defaultTooltip$1,view._redraw=true;view._handler=(new CanvasHandler).scene(root);view._globalCursor=false;view._preventDefault=false;view._timers=[];view._eventListeners=[];view._resizeListeners=[];view._eventConfig=initializeEventConfig(spec.eventConfig);view.globalCursor(view._eventConfig.globalCursor);var ctx=runtime(view,spec,options.expr);view._runtime=ctx;view._signals=ctx.signals;view._bind=(spec.bindings||[]).map((function(_){return{state:null,param:extend({},_)}}));if(ctx.root)ctx.root.set(root);root.source=ctx.data.root.input;view.pulse(ctx.data.root.input,view.changeset().insert(root.items));view._width=view.width();view._height=view.height();view._viewWidth=viewWidth(view,view._width);view._viewHeight=viewHeight(view,view._height);view._origin=[0,0];view._resize=0;view._autosize=1;initializeResize(view);background$1(view);cursor(view);view.description(spec.description);if(options.hover)view.hover();if(options.container)view.initialize(options.container,options.bind)}function lookupSignal(view,name){return _has(view._signals,name)?view._signals[name]:error("Unrecognized signal name: "+$(name))}function findOperatorHandler(op,handler){var h=(op._targets||[]).filter((function(op){return op._update&&op._update.handler===handler}));return h.length?h[0]:null}function addOperatorListener(view,name,op,handler){var h=findOperatorHandler(op,handler);if(!h){h=trap(view,(function(){return handler(name,op.value)}));h.handler=handler;view.on(op,null,h)}return view}function removeOperatorListener(view,op,handler){var h=findOperatorHandler(op,handler);if(h)op._targets.remove(h);return view}inherits(View,Dataflow,{evaluate:function evaluate(encode,prerun,postrun){var _this=this;return _asyncToGenerator(regeneratorRuntime.mark((function _callee(){return regeneratorRuntime.wrap((function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return Dataflow.prototype.evaluate.call(_this,encode,prerun);case 2:if(!(_this._redraw||_this._resize)){_context.next=14;break}_context.prev=3;if(!_this._renderer){_context.next=8;break}if(_this._resize){_this._resize=0;resizeRenderer(_this)}_context.next=8;return _this._renderer.renderAsync(_this._scenegraph.root);case 8:_this._redraw=false;_context.next=14;break;case 11:_context.prev=11;_context.t0=_context["catch"](3);_this.error(_context.t0);case 14:if(postrun)asyncCallback(_this,postrun);return _context.abrupt("return",_this);case 16:case"end":return _context.stop()}}}),_callee,null,[[3,11]])})))()},dirty:function dirty(item){this._redraw=true;this._renderer&&this._renderer.dirty(item)},description:function description(text){if(arguments.length){var desc=text!=null?text+"":null;if(desc!==this._desc)ariaLabel(this._el,this._desc=desc);return this}return this._desc},container:function container(){return this._el},scenegraph:function scenegraph(){return this._scenegraph},origin:function origin(){return this._origin.slice()},signal:function signal(name,value,options){var op=lookupSignal(this,name);return arguments.length===1?op.value:this.update(op,value,options)},width:function width(_){return arguments.length?this.signal("width",_):this.signal("width")},height:function height(_){return arguments.length?this.signal("height",_):this.signal("height")},padding:function padding(_){return arguments.length?this.signal("padding",_padding(_)):_padding(this.signal("padding"))},autosize:function autosize(_){return arguments.length?this.signal("autosize",_):this.signal("autosize")},background:function background(_){return arguments.length?this.signal("background",_):this.signal("background")},renderer:function renderer(type){if(!arguments.length)return this._renderType;if(!renderModule(type))error("Unrecognized renderer type: "+type);if(type!==this._renderType){this._renderType=type;this._resetRenderer()}return this},tooltip:function tooltip(handler){if(!arguments.length)return this._tooltip;if(handler!==this._tooltip){this._tooltip=handler;this._resetRenderer()}return this},loader:function loader(_loader){if(!arguments.length)return this._loader;if(_loader!==this._loader){Dataflow.prototype.loader.call(this,_loader);this._resetRenderer()}return this},resize:function resize(){this._autosize=1;return this.touch(lookupSignal(this,"autosize"))},_resetRenderer:function _resetRenderer(){if(this._renderer){this._renderer=null;this.initialize(this._el,this._elBind)}},_resizeView:resizeView,addEventListener:function addEventListener(type,handler,options){var callback=handler;if(!(options&&options.trap===false)){callback=trap(this,handler);callback.raw=handler}this._handler.on(type,callback);return this},removeEventListener:function removeEventListener(type,handler){var handlers=this._handler.handlers(type),i=handlers.length,h,t;while(--i>=0){t=handlers[i].type;h=handlers[i].handler;if(type===t&&(handler===h||handler===h.raw)){this._handler.off(t,h);break}}return this},addResizeListener:function addResizeListener(handler){var l=this._resizeListeners;if(l.indexOf(handler)<0){l.push(handler)}return this},removeResizeListener:function removeResizeListener(handler){var l=this._resizeListeners,i=l.indexOf(handler);if(i>=0){l.splice(i,1)}return this},addSignalListener:function addSignalListener(name,handler){return addOperatorListener(this,name,lookupSignal(this,name),handler)},removeSignalListener:function removeSignalListener(name,handler){return removeOperatorListener(this,lookupSignal(this,name),handler)},addDataListener:function addDataListener(name,handler){return addOperatorListener(this,name,dataref(this,name).values,handler)},removeDataListener:function removeDataListener(name,handler){return removeOperatorListener(this,dataref(this,name).values,handler)},globalCursor:function globalCursor(_){if(arguments.length){if(this._globalCursor!==!!_){var prev=setCursor(this,null);this._globalCursor=!!_;if(prev)setCursor(this,prev)}return this}else{return this._globalCursor}},preventDefault:function preventDefault(_){if(arguments.length){this._preventDefault=_;return this}else{return this._preventDefault}},timer:timer$1,events:events$1,finalize:finalize,hover:hover,data:data$1,change:change,insert:insert,remove:remove,scale:scale$3,initialize:initialize$1,toImageURL:renderToImageURL,toCanvas:renderToCanvas,toSVG:renderToSVG,getState:getState$1,setState:setState$1});var VIEW$1="view",LBRACK="[",RBRACK="]",LBRACE="{",RBRACE="}",COLON=":",COMMA=",",NAME="@",GT=">",ILLEGAL$1=/[[\]{}]/,DEFAULT_MARKS={"*":1,arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1};var DEFAULT_SOURCE,MARKS;function eventSelector(selector,source,marks){DEFAULT_SOURCE=source||VIEW$1;MARKS=marks||DEFAULT_MARKS;return parseMerge(selector.trim()).map(parseSelector)}function isMarkType(type){return MARKS[type]}function find$2(s,i,endChar,pushChar,popChar){var n=s.length;var count=0,c;for(;i<n;++i){c=s[i];if(!count&&c===endChar)return i;else if(popChar&&popChar.indexOf(c)>=0)--count;else if(pushChar&&pushChar.indexOf(c)>=0)++count}return i}function parseMerge(s){var output=[],n=s.length;var start=0,i=0;while(i<n){i=find$2(s,i,COMMA,LBRACK+LBRACE,RBRACK+RBRACE);output.push(s.substring(start,i).trim());start=++i}if(output.length===0){throw"Empty event selector: "+s}return output}function parseSelector(s){return s[0]==="["?parseBetween(s):parseStream$1(s)}function parseBetween(s){var n=s.length;var i=1,b;i=find$2(s,i,RBRACK,LBRACK,RBRACK);if(i===n){throw"Empty between selector: "+s}b=parseMerge(s.substring(1,i));if(b.length!==2){throw"Between selector must have two elements: "+s}s=s.slice(i+1).trim();if(s[0]!==GT){throw"Expected '>' after between selector: "+s}b=b.map(parseSelector);var stream=parseSelector(s.slice(1).trim());if(stream.between){return{between:b,stream:stream}}else{stream.between=b}return stream}function parseStream$1(s){var stream={source:DEFAULT_SOURCE},source=[];var throttle=[0,0],markname=0,start=0,n=s.length,i=0,j,filter;if(s[n-1]===RBRACE){i=s.lastIndexOf(LBRACE);if(i>=0){try{throttle=parseThrottle(s.substring(i+1,n-1))}catch(e){throw"Invalid throttle specification: "+s}s=s.slice(0,i).trim();n=s.length}else throw"Unmatched right brace: "+s;i=0}if(!n)throw s;if(s[0]===NAME)markname=++i;j=find$2(s,i,COLON);if(j<n){source.push(s.substring(start,j).trim());start=i=++j}i=find$2(s,i,LBRACK);if(i===n){source.push(s.substring(start,n).trim())}else{source.push(s.substring(start,i).trim());filter=[];start=++i;if(start===n)throw"Unmatched left bracket: "+s}while(i<n){i=find$2(s,i,RBRACK);if(i===n)throw"Unmatched left bracket: "+s;filter.push(s.substring(start,i).trim());if(i<n-1&&s[++i]!==LBRACK)throw"Expected left bracket: "+s;start=++i}if(!(n=source.length)||ILLEGAL$1.test(source[n-1])){throw"Invalid event selector: "+s}if(n>1){stream.type=source[1];if(markname){stream.markname=source[0].slice(1)}else if(isMarkType(source[0])){stream.marktype=source[0]}else{stream.source=source[0]}}else{stream.type=source[0]}if(stream.type.slice(-1)==="!"){stream.consume=true;stream.type=stream.type.slice(0,-1)}if(filter!=null)stream.filter=filter;if(throttle[0])stream.throttle=throttle[0];if(throttle[1])stream.debounce=throttle[1];return stream}function parseThrottle(s){var a=s.split(COMMA);if(!s.length||a.length>2)throw s;return a.map((function(_){var x=+_;if(x!==x)throw s;return x}))}function parseAutosize(spec){return isObject(spec)?spec:{type:spec||"pad"}}var number$6=function number(_){return+_||0};var paddingObject$1=function paddingObject(_){return{top:_,bottom:_,left:_,right:_}};function parsePadding(spec){return!isObject(spec)?paddingObject$1(number$6(spec)):spec.signal?spec:{top:number$6(spec.top),bottom:number$6(spec.bottom),left:number$6(spec.left),right:number$6(spec.right)}}var encoder=function encoder(_){return isObject(_)&&!isArray(_)?extend({},_):{value:_}};function addEncode(object,name,value,set){if(value!=null){var isEncoder=isObject(value)&&!isArray(value)||isArray(value)&&value.length&&isObject(value[0]);if(isEncoder){object.update[name]=value}else{object[set||"enter"][name]={value:value}}return 1}else{return 0}}function addEncoders(object,enter,update){for(var name in enter){addEncode(object,name,enter[name])}for(var _name in update){addEncode(object,_name,update[_name],"update")}}function extendEncode(encode,extra,skip){for(var name in extra){if(skip&&_has(skip,name))continue;encode[name]=extend(encode[name]||{},extra[name])}return encode}function has(key,encode){return encode&&(encode.enter&&encode.enter[key]||encode.update&&encode.update[key])}var MarkRole="mark";var FrameRole$1="frame";var ScopeRole$1="scope";var AxisRole$1="axis";var AxisDomainRole="axis-domain";var AxisGridRole="axis-grid";var AxisLabelRole="axis-label";var AxisTickRole="axis-tick";var AxisTitleRole="axis-title";var LegendRole$1="legend";var LegendBandRole="legend-band";var LegendEntryRole="legend-entry";var LegendGradientRole="legend-gradient";var LegendLabelRole="legend-label";var LegendSymbolRole="legend-symbol";var LegendTitleRole="legend-title";var TitleRole$1="title";var TitleTextRole="title-text";var TitleSubtitleRole="title-subtitle";function applyDefaults(encode,type,role,style,config){var defaults={},enter={};var update,key,skip,props;key="lineBreak";if(type==="text"&&config[key]!=null&&!has(key,encode)){applyDefault(defaults,key,config[key])}if(role=="legend"||String(role).startsWith("axis")){role=null}props=role===FrameRole$1?config.group:role===MarkRole?extend({},config.mark,config[type]):null;for(key in props){skip=has(key,encode)||(key==="fill"||key==="stroke")&&(has("fill",encode)||has("stroke",encode));if(!skip)applyDefault(defaults,key,props[key])}array(style).forEach((function(name){var props=config.style&&config.style[name];for(var _key in props){if(!has(_key,encode)){applyDefault(defaults,_key,props[_key])}}}));encode=extend({},encode);for(key in defaults){props=defaults[key];if(props.signal){(update=update||{})[key]=props}else{enter[key]=props}}encode.enter=extend(enter,encode.enter);if(update)encode.update=extend(update,encode.update);return encode}function applyDefault(defaults,key,value){defaults[key]=value&&value.signal?{signal:value.signal}:{value:value}}var scaleRef=function scaleRef(scale){return isString(scale)?$(scale):scale.signal?"(".concat(scale.signal,")"):field$1(scale)};function entry(enc){if(enc.gradient!=null){return gradient$1(enc)}var value=enc.signal?"(".concat(enc.signal,")"):enc.color?color$2(enc.color):enc.field!=null?field$1(enc.field):enc.value!==undefined?$(enc.value):undefined;if(enc.scale!=null){value=scale$4(enc,value)}if(value===undefined){value=null}if(enc.exponent!=null){value="pow(".concat(value,",").concat(property(enc.exponent),")")}if(enc.mult!=null){value+="*".concat(property(enc.mult))}if(enc.offset!=null){value+="+".concat(property(enc.offset))}if(enc.round){value="round(".concat(value,")")}return value}var _color=function _color(type,x,y,z){return"(".concat(type,"(").concat([x,y,z].map(entry).join(","),")+'')")};function color$2(enc){return enc.c?_color("hcl",enc.h,enc.c,enc.l):enc.h||enc.s?_color("hsl",enc.h,enc.s,enc.l):enc.l||enc.a?_color("lab",enc.l,enc.a,enc.b):enc.r||enc.g||enc.b?_color("rgb",enc.r,enc.g,enc.b):null}function gradient$1(enc){var args=[enc.start,enc.stop,enc.count].map((function(_){return _==null?null:$(_)}));while(args.length&&peek(args)==null){args.pop()}args.unshift(scaleRef(enc.gradient));return"gradient(".concat(args.join(","),")")}function property(property){return isObject(property)?"("+entry(property)+")":property}function field$1(ref){return resolveField(isObject(ref)?ref:{datum:ref})}function resolveField(ref){var object,level,field;if(ref.signal){object="datum";field=ref.signal}else if(ref.group||ref.parent){level=Math.max(1,ref.level||1);object="item";while(level-- >0){object+=".mark.group"}if(ref.parent){field=ref.parent;object+=".datum"}else{field=ref.group}}else if(ref.datum){object="datum";field=ref.datum}else{error("Invalid field reference: "+$(ref))}if(!ref.signal){field=isString(field)?splitAccessPath(field).map($).join("]["):resolveField(field)}return object+"["+field+"]"}function scale$4(enc,value){var scale=scaleRef(enc.scale);if(enc.range!=null){value="lerp(_range(".concat(scale,"), ").concat(+enc.range,")")}else{if(value!==undefined)value="_scale(".concat(scale,", ").concat(value,")");if(enc.band){value=(value?value+"+":"")+"_bandwidth(".concat(scale,")")+(+enc.band===1?"":"*"+property(enc.band));if(enc.extra){value="(datum.extra ? _scale(".concat(scale,", datum.extra.value) : ").concat(value,")")}}if(value==null)value="0"}return value}function rule$1(enc){var code="";enc.forEach((function(rule){var value=entry(rule);code+=rule.test?"(".concat(rule.test,")?").concat(value,":"):value}));if(peek(code)===":"){code+="null"}return code}function parseEncode(encode,type,role,style,scope,params){var enc={};params=params||{};params.encoders={$encode:enc};encode=applyDefaults(encode,type,role,style,scope.config);for(var key in encode){enc[key]=parseBlock(encode[key],type,params,scope)}return params}function parseBlock(block,marktype,params,scope){var channels={},fields={};for(var name in block){if(block[name]!=null){channels[name]=parse$4(expr(block[name]),scope,params,fields)}}return{$expr:{marktype:marktype,channels:channels},$fields:Object.keys(fields),$output:Object.keys(block)}}function expr(enc){return isArray(enc)?rule$1(enc):entry(enc)}function parse$4(code,scope,params,fields){var expr=parser$1(code,scope);expr.$fields.forEach((function(name){return fields[name]=1}));extend(params,expr.$params);return expr.$expr}var OUTER="outer",OUTER_INVALID=["value","update","init","react","bind"];function outerError(prefix,name){error(prefix+' for "outer" push: '+$(name))}function parseSignal(signal,scope){var name=signal.name;if(signal.push===OUTER){if(!scope.signals[name])outerError("No prior signal definition",name);OUTER_INVALID.forEach((function(prop){if(signal[prop]!==undefined)outerError("Invalid property ",prop)}))}else{var op=scope.addSignal(name,signal.value);if(signal.react===false)op.react=false;if(signal.bind)scope.addBinding(name,signal.bind)}}function Entry(type,value,params,parent){this.id=-1;this.type=type;this.value=value;this.params=params;if(parent)this.parent=parent}function entry$1(type,value,params,parent){return new Entry(type,value,params,parent)}function operator(value,params){return entry$1("operator",value,params)}function ref(op){var ref={$ref:op.id};if(op.id<0)(op.refs=op.refs||[]).push(ref);return ref}function _fieldRef(field,name){return name?{$field:field,$name:name}:{$field:field}}var keyFieldRef=_fieldRef("key");function _compareRef(fields,orders){return{$compare:fields,$order:orders}}function _keyRef(fields,flat){var ref={$key:fields};if(flat)ref.$flat=true;return ref}var Ascending="ascending";var Descending="descending";function sortKey(sort){return!isObject(sort)?"":(sort.order===Descending?"-":"+")+aggrField(sort.op,sort.field)}function aggrField(op,field){return(op&&op.signal?"$"+op.signal:op||"")+(op&&field?"_":"")+(field&&field.signal?"$"+field.signal:field||"")}var Scope="scope";var View$1="view";function isSignal(_){return _&&_.signal}function isExpr(_){return _&&_.expr}function hasSignal(_){if(isSignal(_))return true;if(isObject(_))for(var key in _){if(hasSignal(_[key]))return true}return false}function value$2(specValue,defaultValue){return specValue!=null?specValue:defaultValue}function deref(v){return v&&v.signal||v}var Timer$1="timer";function parseStream$2(stream,scope){var method=stream.merge?mergeStream:stream.stream?nestedStream:stream.type?eventStream:error("Invalid stream specification: "+$(stream));return method(stream,scope)}function eventSource(source){return source===Scope?View$1:source||View$1}function mergeStream(stream,scope){var list=stream.merge.map((function(s){return parseStream$2(s,scope)})),entry=streamParameters({merge:list},stream,scope);return scope.addStream(entry).id}function nestedStream(stream,scope){var id=parseStream$2(stream.stream,scope),entry=streamParameters({stream:id},stream,scope);return scope.addStream(entry).id}function eventStream(stream,scope){var id;if(stream.type===Timer$1){id=scope.event(Timer$1,stream.throttle);stream={between:stream.between,filter:stream.filter}}else{id=scope.event(eventSource(stream.source),stream.type)}var entry=streamParameters({stream:id},stream,scope);return Object.keys(entry).length===1?id:scope.addStream(entry).id}function streamParameters(entry,stream,scope){var param=stream.between;if(param){if(param.length!==2){error('Stream "between" parameter must have 2 entries: '+$(stream))}entry.between=[parseStream$2(param[0],scope),parseStream$2(param[1],scope)]}param=stream.filter?[].concat(stream.filter):[];if(stream.marktype||stream.markname||stream.markrole){param.push(filterMark(stream.marktype,stream.markname,stream.markrole))}if(stream.source===Scope){param.push("inScope(event.item)")}if(param.length){entry.filter=parser$1("("+param.join(")&&(")+")",scope).$expr}if((param=stream.throttle)!=null){entry.throttle=+param}if((param=stream.debounce)!=null){entry.debounce=+param}if(stream.consume){entry.consume=true}return entry}function filterMark(type,name,role){var item="event.item";return item+(type&&type!=="*"?"&&"+item+".mark.marktype==='"+type+"'":"")+(role?"&&"+item+".mark.role==='"+role+"'":"")+(name?"&&"+item+".mark.name==='"+name+"'":"")}var OP_VALUE_EXPR={code:"_.$value",ast:{type:"Identifier",value:"value"}};function parseUpdate$1(spec,scope,target){var encode=spec.encode,entry={target:target};var events=spec.events,update=spec.update,sources=[];if(!events){error("Signal update missing events specification.")}if(isString(events)){events=eventSelector(events,scope.isSubscope()?Scope:View$1)}events=array(events).filter((function(s){return s.signal||s.scale?(sources.push(s),0):1}));if(sources.length>1){sources=[mergeSources(sources)]}if(events.length){sources.push(events.length>1?{merge:events}:events[0])}if(encode!=null){if(update)error("Signal encode and update are mutually exclusive.");update="encode(item(),"+$(encode)+")"}entry.update=isString(update)?parser$1(update,scope):update.expr!=null?parser$1(update.expr,scope):update.value!=null?update.value:update.signal!=null?{$expr:OP_VALUE_EXPR,$params:{$value:scope.signalRef(update.signal)}}:error("Invalid signal update specification.");if(spec.force){entry.options={force:true}}sources.forEach((function(source){return scope.addUpdate(extend(streamSource(source,scope),entry))}))}function streamSource(stream,scope){return{source:stream.signal?scope.signalRef(stream.signal):stream.scale?scope.scaleRef(stream.scale):parseStream$2(stream,scope)}}function mergeSources(sources){return{signal:"["+sources.map((function(s){return s.scale?'scale("'+s.scale+'")':s.signal}))+"]"}}function parseSignalUpdates(signal,scope){var op=scope.getSignal(signal.name);var expr=signal.update;if(signal.init){if(expr){error("Signals can not include both init and update expressions.")}else{expr=signal.init;op.initonly=true}}if(expr){expr=parser$1(expr,scope);op.update=expr.$expr;op.params=expr.$params}if(signal.on){signal.on.forEach((function(_){return parseUpdate$1(_,scope,op.id)}))}}var transform$2=function transform(name){return function(params,value,parent){return entry$1(name,value,params||undefined,parent)}};var Aggregate$1=transform$2("aggregate");var AxisTicks$1=transform$2("axisticks");var Bound$1=transform$2("bound");var Collect$1=transform$2("collect");var Compare$1=transform$2("compare");var DataJoin$1=transform$2("datajoin");var Encode$1=transform$2("encode");var Expression$1=transform$2("expression");var Facet$1=transform$2("facet");var Field$1=transform$2("field");var Key$1=transform$2("key");var LegendEntries$1=transform$2("legendentries");var Load$1=transform$2("load");var Mark$1=transform$2("mark");var MultiExtent$1=transform$2("multiextent");var MultiValues$1=transform$2("multivalues");var Overlap$1=transform$2("overlap");var Params$2=transform$2("params");var PreFacet$1=transform$2("prefacet");var Projection$1=transform$2("projection");var Proxy$1=transform$2("proxy");var Relay$1=transform$2("relay");var Render$1=transform$2("render");var Scale$1=transform$2("scale");var Sieve$1=transform$2("sieve");var SortItems$1=transform$2("sortitems");var ViewLayout$1=transform$2("viewlayout");var Values$1=transform$2("values");var FIELD_REF_ID=0;var MULTIDOMAIN_SORT_OPS={min:"min",max:"max",count:"sum"};function initScale(spec,scope){var type=spec.type||"linear";if(!isValidScaleType(type)){error("Unrecognized scale type: "+$(type))}scope.addScale(spec.name,{type:type,domain:undefined})}function parseScale(spec,scope){var params=scope.getScale(spec.name).params;var key;params.domain=parseScaleDomain(spec.domain,spec,scope);if(spec.range!=null){params.range=parseScaleRange(spec,scope,params)}if(spec.interpolate!=null){parseScaleInterpolate(spec.interpolate,params)}if(spec.nice!=null){params.nice=parseScaleNice(spec.nice)}if(spec.bins!=null){params.bins=parseScaleBins(spec.bins,scope)}for(key in spec){if(_has(params,key)||key==="name")continue;params[key]=parseLiteral(spec[key],scope)}}function parseLiteral(v,scope){return!isObject(v)?v:v.signal?scope.signalRef(v.signal):error("Unsupported object: "+$(v))}function parseArray(v,scope){return v.signal?scope.signalRef(v.signal):v.map((function(v){return parseLiteral(v,scope)}))}function dataLookupError(name){error("Can not find data set: "+$(name))}function parseScaleDomain(domain,spec,scope){if(!domain){if(spec.domainMin!=null||spec.domainMax!=null){error("No scale domain defined for domainMin/domainMax to override.")}return}return domain.signal?scope.signalRef(domain.signal):(isArray(domain)?explicitDomain:domain.fields?multipleDomain:singularDomain)(domain,spec,scope)}function explicitDomain(domain,spec,scope){return domain.map((function(v){return parseLiteral(v,scope)}))}function singularDomain(domain,spec,scope){var data=scope.getData(domain.data);if(!data)dataLookupError(domain.data);return isDiscrete(spec.type)?data.valuesRef(scope,domain.field,parseSort(domain.sort,false)):isQuantile(spec.type)?data.domainRef(scope,domain.field):data.extentRef(scope,domain.field)}function multipleDomain(domain,spec,scope){var data=domain.data,fields=domain.fields.reduce((function(dom,d){d=isString(d)?{data:data,field:d}:isArray(d)||d.signal?fieldRef$1(d,scope):d;dom.push(d);return dom}),[]);return(isDiscrete(spec.type)?ordinalMultipleDomain:isQuantile(spec.type)?quantileMultipleDomain:numericMultipleDomain)(domain,scope,fields)}function fieldRef$1(data,scope){var name="_:vega:_"+FIELD_REF_ID++,coll=Collect$1({});if(isArray(data)){coll.value={$ingest:data}}else if(data.signal){var code="setdata("+$(name)+","+data.signal+")";coll.params.input=scope.signalRef(code)}scope.addDataPipeline(name,[coll,Sieve$1({})]);return{data:name,field:"data"}}function ordinalMultipleDomain(domain,scope,fields){var sort=parseSort(domain.sort,true);var a,v;var counts=fields.map((function(f){var data=scope.getData(f.data);if(!data)dataLookupError(f.data);return data.countsRef(scope,f.field,sort)}));var p={groupby:keyFieldRef,pulse:counts};if(sort){a=sort.op||"count";v=sort.field?aggrField(a,sort.field):"count";p.ops=[MULTIDOMAIN_SORT_OPS[a]];p.fields=[scope.fieldRef(v)];p.as=[v]}a=scope.add(Aggregate$1(p));var c=scope.add(Collect$1({pulse:ref(a)}));v=scope.add(Values$1({field:keyFieldRef,sort:scope.sortRef(sort),pulse:ref(c)}));return ref(v)}function parseSort(sort,multidomain){if(sort){if(!sort.field&&!sort.op){if(isObject(sort))sort.field="key";else sort={field:"key"}}else if(!sort.field&&sort.op!=="count"){error("No field provided for sort aggregate op: "+sort.op)}else if(multidomain&&sort.field){if(sort.op&&!MULTIDOMAIN_SORT_OPS[sort.op]){error("Multiple domain scales can not be sorted using "+sort.op)}}}return sort}function quantileMultipleDomain(domain,scope,fields){var values=fields.map((function(f){var data=scope.getData(f.data);if(!data)dataLookupError(f.data);return data.domainRef(scope,f.field)}));return ref(scope.add(MultiValues$1({values:values})))}function numericMultipleDomain(domain,scope,fields){var extents=fields.map((function(f){var data=scope.getData(f.data);if(!data)dataLookupError(f.data);return data.extentRef(scope,f.field)}));return ref(scope.add(MultiExtent$1({extents:extents})))}function parseScaleBins(v,scope){return v.signal||isArray(v)?parseArray(v,scope):scope.objectProperty(v)}function parseScaleNice(nice){return isObject(nice)?{interval:parseLiteral(nice.interval),step:parseLiteral(nice.step)}:parseLiteral(nice)}function parseScaleInterpolate(interpolate,params){params.interpolate=parseLiteral(interpolate.type||interpolate);if(interpolate.gamma!=null){params.interpolateGamma=parseLiteral(interpolate.gamma)}}function parseScaleRange(spec,scope,params){var config=scope.config.range;var range=spec.range;if(range.signal){return scope.signalRef(range.signal)}else if(isString(range)){if(config&&_has(config,range)){spec=extend({},spec,{range:config[range]});return parseScaleRange(spec,scope,params)}else if(range==="width"){range=[0,{signal:"width"}]}else if(range==="height"){range=isDiscrete(spec.type)?[0,{signal:"height"}]:[{signal:"height"},0]}else{error("Unrecognized scale range value: "+$(range))}}else if(range.scheme){params.scheme=isArray(range.scheme)?parseArray(range.scheme,scope):parseLiteral(range.scheme,scope);if(range.extent)params.schemeExtent=parseArray(range.extent,scope);if(range.count)params.schemeCount=parseLiteral(range.count,scope);return}else if(range.step){params.rangeStep=parseLiteral(range.step,scope);return}else if(isDiscrete(spec.type)&&!isArray(range)){return parseScaleDomain(range,spec,scope)}else if(!isArray(range)){error("Unsupported range type: "+$(range))}return range.map((function(v){return(isArray(v)?parseArray:parseLiteral)(v,scope)}))}function parseProjection(proj,scope){var config=scope.config.projection||{},params={};for(var name in proj){if(name==="name")continue;params[name]=parseParameter$1(proj[name],name,scope)}for(var _name2 in config){if(params[_name2]==null){params[_name2]=parseParameter$1(config[_name2],_name2,scope)}}scope.addProjection(proj.name,params)}function parseParameter$1(_,name,scope){return isArray(_)?_.map((function(_){return parseParameter$1(_,name,scope)})):!isObject(_)?_:_.signal?scope.signalRef(_.signal):name==="fit"?_:error("Unsupported parameter object: "+$(_))}var Top$1="top";var Left$1="left";var Right$1="right";var Bottom$1="bottom";var Center$1="center";var Vertical="vertical";var Start$1="start";var Middle$1="middle";var End$1="end";var Index="index";var Label$1="label";var Offset="offset";var Perc="perc";var Perc2="perc2";var Value="value";var GuideLabelStyle="guide-label";var GuideTitleStyle="guide-title";var GroupTitleStyle="group-title";var GroupSubtitleStyle="group-subtitle";var Symbols$1="symbol";var Gradient$1="gradient";var Discrete$1="discrete";var Size="size";var Shape="shape";var Fill="fill";var Stroke="stroke";var StrokeWidth="strokeWidth";var StrokeDash="strokeDash";var Opacity="opacity";var LegendScales=[Size,Shape,Fill,Stroke,StrokeWidth,StrokeDash,Opacity];var Skip$2={name:1,style:1,interactive:1};var zero$2={value:0};var one$2={value:1};var GroupMark="group";var RectMark="rect";var RuleMark="rule";var SymbolMark="symbol";var TextMark="text";function guideGroup(mark){mark.type=GroupMark;mark.interactive=mark.interactive||false;return mark}function lookup$4(spec,config){var _=function _(name,dflt){return value$2(spec[name],value$2(config[name],dflt))};_.isVertical=function(s){return Vertical===value$2(spec.direction,config.direction||(s?config.symbolDirection:config.gradientDirection))};_.gradientLength=function(){return value$2(spec.gradientLength,config.gradientLength||config.gradientWidth)};_.gradientThickness=function(){return value$2(spec.gradientThickness,config.gradientThickness||config.gradientHeight)};_.entryColumns=function(){return value$2(spec.columns,value$2(config.columns,+_.isVertical(true)))};return _}function getEncoding(name,encode){var v=encode&&(encode.update&&encode.update[name]||encode.enter&&encode.enter[name]);return v&&v.signal?v:v?v.value:null}function getStyle(name,scope,style){var s=scope.config.style[style];return s&&s[name]}function anchorExpr(s,e,m){return"item.anchor === '".concat(Start$1,"' ? ").concat(s," : item.anchor === '").concat(End$1,"' ? ").concat(e," : ").concat(m)}var alignExpr=anchorExpr($(Left$1),$(Right$1),$(Center$1));function tickBand(_){var v=_("tickBand");var offset=_("tickOffset"),band,extra;if(!v){band=_("bandPosition");extra=_("tickExtra")}else if(v.signal){band={signal:"(".concat(v.signal,") === 'extent' ? 1 : 0.5")};extra={signal:"(".concat(v.signal,") === 'extent'")};if(!isObject(offset)){offset={signal:"(".concat(v.signal,") === 'extent' ? 0 : ").concat(offset)}}}else if(v==="extent"){band=1;extra=true;offset=0}else{band=.5;extra=false}return{extra:extra,band:band,offset:offset}}function extendOffset(value,offset){return!offset?value:!value?offset:!isObject(value)?{value:value,offset:offset}:Object.assign({},value,{offset:extendOffset(value.offset,offset)})}function guideMark(mark,extras){if(extras){mark.name=extras.name;mark.style=extras.style||mark.style;mark.interactive=!!extras.interactive;mark.encode=extendEncode(mark.encode,extras,Skip$2)}else{mark.interactive=false}return mark}function legendGradient(spec,scale,config,userEncode){var _=lookup$4(spec,config),vertical=_.isVertical(),thickness=_.gradientThickness(),length=_.gradientLength();var enter,start,stop,width,height;if(vertical){start=[0,1];stop=[0,0];width=thickness;height=length}else{start=[0,0];stop=[1,0];width=length;height=thickness}var encode={enter:enter={opacity:zero$2,x:zero$2,y:zero$2,width:encoder(width),height:encoder(height)},update:extend({},enter,{opacity:one$2,fill:{gradient:scale,start:start,stop:stop}}),exit:{opacity:zero$2}};addEncoders(encode,{stroke:_("gradientStrokeColor"),strokeWidth:_("gradientStrokeWidth")},{opacity:_("gradientOpacity")});return guideMark({type:RectMark,role:LegendGradientRole,encode:encode},userEncode)}function legendGradientDiscrete(spec,scale,config,userEncode,dataRef){var _=lookup$4(spec,config),vertical=_.isVertical(),thickness=_.gradientThickness(),length=_.gradientLength();var u,v,uu,vv,adjust="";vertical?(u="y",uu="y2",v="x",vv="width",adjust="1-"):(u="x",uu="x2",v="y",vv="height");var enter={opacity:zero$2,fill:{scale:scale,field:Value}};enter[u]={signal:adjust+"datum."+Perc,mult:length};enter[v]=zero$2;enter[uu]={signal:adjust+"datum."+Perc2,mult:length};enter[vv]=encoder(thickness);var encode={enter:enter,update:extend({},enter,{opacity:one$2}),exit:{opacity:zero$2}};addEncoders(encode,{stroke:_("gradientStrokeColor"),strokeWidth:_("gradientStrokeWidth")},{opacity:_("gradientOpacity")});return guideMark({type:RectMark,role:LegendBandRole,key:Value,from:dataRef,encode:encode},userEncode)}var alignExpr$1="datum.".concat(Perc,'<=0?"').concat(Left$1,'":datum.').concat(Perc,'>=1?"').concat(Right$1,'":"').concat(Center$1,'"'),baselineExpr="datum.".concat(Perc,'<=0?"').concat(Bottom$1,'":datum.').concat(Perc,'>=1?"').concat(Top$1,'":"').concat(Middle$1,'"');function legendGradientLabels(spec,config,userEncode,dataRef){var _=lookup$4(spec,config),vertical=_.isVertical(),thickness=encoder(_.gradientThickness()),length=_.gradientLength();var overlap=_("labelOverlap"),enter,update,u,v,adjust="";var encode={enter:enter={opacity:zero$2},update:update={opacity:one$2,text:{field:Label$1}},exit:{opacity:zero$2}};addEncoders(encode,{fill:_("labelColor"),fillOpacity:_("labelOpacity"),font:_("labelFont"),fontSize:_("labelFontSize"),fontStyle:_("labelFontStyle"),fontWeight:_("labelFontWeight"),limit:value$2(spec.labelLimit,config.gradientLabelLimit)});if(vertical){enter.align={value:"left"};enter.baseline=update.baseline={signal:baselineExpr};u="y";v="x";adjust="1-"}else{enter.align=update.align={signal:alignExpr$1};enter.baseline={value:"top"};u="x";v="y"}enter[u]=update[u]={signal:adjust+"datum."+Perc,mult:length};enter[v]=update[v]=thickness;thickness.offset=value$2(spec.labelOffset,config.gradientLabelOffset)||0;overlap=overlap?{separation:_("labelSeparation"),method:overlap,order:"datum."+Index}:undefined;return guideMark({type:TextMark,role:LegendLabelRole,style:GuideLabelStyle,key:Value,from:dataRef,encode:encode,overlap:overlap},userEncode)}function legendSymbolGroups(spec,config,userEncode,dataRef,columns){var _=lookup$4(spec,config),entries=userEncode.entries,interactive=!!(entries&&entries.interactive),name=entries?entries.name:undefined,height=_("clipHeight"),symbolOffset=_("symbolOffset"),valueRef={data:"value"},xSignal="(".concat(columns,") ? datum.").concat(Offset," : datum.").concat(Size),yEncode=height?encoder(height):{field:Size},index="datum.".concat(Index),ncols="max(1, ".concat(columns,")");var encode,enter,update,nrows,sort;yEncode.mult=.5;encode={enter:enter={opacity:zero$2,x:{signal:xSignal,mult:.5,offset:symbolOffset},y:yEncode},update:update={opacity:one$2,x:enter.x,y:enter.y},exit:{opacity:zero$2}};var baseFill=null,baseStroke=null;if(!spec.fill){baseFill=config.symbolBaseFillColor;baseStroke=config.symbolBaseStrokeColor}addEncoders(encode,{fill:_("symbolFillColor",baseFill),shape:_("symbolType"),size:_("symbolSize"),stroke:_("symbolStrokeColor",baseStroke),strokeDash:_("symbolDash"),strokeDashOffset:_("symbolDashOffset"),strokeWidth:_("symbolStrokeWidth")},{opacity:_("symbolOpacity")});LegendScales.forEach((function(scale){if(spec[scale]){update[scale]=enter[scale]={scale:spec[scale],field:Value}}}));var symbols=guideMark({type:SymbolMark,role:LegendSymbolRole,key:Value,from:valueRef,clip:height?true:undefined,encode:encode},userEncode.symbols);var labelOffset=encoder(symbolOffset);labelOffset.offset=_("labelOffset");encode={enter:enter={opacity:zero$2,x:{signal:xSignal,offset:labelOffset},y:yEncode},update:update={opacity:one$2,text:{field:Label$1},x:enter.x,y:enter.y},exit:{opacity:zero$2}};addEncoders(encode,{align:_("labelAlign"),baseline:_("labelBaseline"),fill:_("labelColor"),fillOpacity:_("labelOpacity"),font:_("labelFont"),fontSize:_("labelFontSize"),fontStyle:_("labelFontStyle"),fontWeight:_("labelFontWeight"),limit:_("labelLimit")});var labels=guideMark({type:TextMark,role:LegendLabelRole,style:GuideLabelStyle,key:Value,from:valueRef,encode:encode},userEncode.labels);encode={enter:{noBound:{value:!height},width:zero$2,height:height?encoder(height):zero$2,opacity:zero$2},exit:{opacity:zero$2},update:update={opacity:one$2,row:{signal:null},column:{signal:null}}};if(_.isVertical(true)){nrows="ceil(item.mark.items.length / ".concat(ncols,")");update.row.signal="".concat(index,"%").concat(nrows);update.column.signal="floor(".concat(index," / ").concat(nrows,")");sort={field:["row",index]}}else{update.row.signal="floor(".concat(index," / ").concat(ncols,")");update.column.signal="".concat(index," % ").concat(ncols);sort={field:index}}update.column.signal="(".concat(columns,")?").concat(update.column.signal,":").concat(index);dataRef={facet:{data:dataRef,name:"value",groupby:Index}};return guideGroup({role:ScopeRole$1,from:dataRef,encode:extendEncode(encode,entries,Skip$2),marks:[symbols,labels],name:name,interactive:interactive,sort:sort})}function legendSymbolLayout(spec,config){var _=lookup$4(spec,config);return{align:_("gridAlign"),columns:_.entryColumns(),center:{row:true,column:false},padding:{row:_("rowPadding"),column:_("columnPadding")}}}var isL='item.orient === "left"',isR='item.orient === "right"',isLR="(".concat(isL," || ").concat(isR,")"),isVG="datum.vgrad && ".concat(isLR),baseline=anchorExpr('"top"','"bottom"','"middle"'),alignFlip=anchorExpr('"right"','"left"','"center"'),exprAlign="datum.vgrad && ".concat(isR," ? (").concat(alignFlip,") : (").concat(isLR," && !(datum.vgrad && ").concat(isL,')) ? "left" : ').concat(alignExpr),exprAnchor="item._anchor || (".concat(isLR,' ? "middle" : "start")'),exprAngle="".concat(isVG," ? (").concat(isL," ? -90 : 90) : 0"),exprBaseline="".concat(isLR," ? (datum.vgrad ? (").concat(isR,' ? "bottom" : "top") : ').concat(baseline,') : "top"');function legendTitle(spec,config,userEncode,dataRef){var _=lookup$4(spec,config);var encode={enter:{opacity:zero$2},update:{opacity:one$2,x:{field:{group:"padding"}},y:{field:{group:"padding"}}},exit:{opacity:zero$2}};addEncoders(encode,{orient:_("titleOrient"),_anchor:_("titleAnchor"),anchor:{signal:exprAnchor},angle:{signal:exprAngle},align:{signal:exprAlign},baseline:{signal:exprBaseline},text:spec.title,fill:_("titleColor"),fillOpacity:_("titleOpacity"),font:_("titleFont"),fontSize:_("titleFontSize"),fontStyle:_("titleFontStyle"),fontWeight:_("titleFontWeight"),limit:_("titleLimit"),lineHeight:_("titleLineHeight")},{align:_("titleAlign"),baseline:_("titleBaseline")});return guideMark({type:TextMark,role:LegendTitleRole,style:GuideTitleStyle,from:dataRef,encode:encode},userEncode)}function clip$3(clip,scope){var expr;if(isObject(clip)){if(clip.signal){expr=clip.signal}else if(clip.path){expr="pathShape("+param(clip.path)+")"}else if(clip.sphere){expr="geoShape("+param(clip.sphere)+', {type: "Sphere"})'}}return expr?scope.signalRef(expr):!!clip}function param(value){return isObject(value)&&value.signal?value.signal:$(value)}function getRole(spec){var role=spec.role||"";return!role.indexOf("axis")||!role.indexOf("legend")||!role.indexOf("title")?role:spec.type===GroupMark?ScopeRole$1:role||MarkRole}function definition$1(spec){return{marktype:spec.type,name:spec.name||undefined,role:spec.role||getRole(spec),zindex:+spec.zindex||undefined,aria:spec.aria,description:spec.description}}function interactive(spec,scope){return spec&&spec.signal?scope.signalRef(spec.signal):spec===false?false:true}function parseTransform(spec,scope){var def=definition(spec.type);if(!def)error("Unrecognized transform type: "+$(spec.type));var t=entry$1(def.type.toLowerCase(),null,parseParameters$1(def,spec,scope));if(spec.signal)scope.addSignal(spec.signal,scope.proxy(t));t.metadata=def.metadata||{};return t}function parseParameters$1(def,spec,scope){var params={},n=def.params.length;for(var i=0;i<n;++i){var pdef=def.params[i];params[pdef.name]=parseParameter$1$1(pdef,spec,scope)}return params}function parseParameter$1$1(def,spec,scope){var type=def.type,value=spec[def.name];if(type==="index"){return parseIndexParameter(def,spec,scope)}else if(value===undefined){if(def.required){error("Missing required "+$(spec.type)+" parameter: "+$(def.name))}return}else if(type==="param"){return parseSubParameters(def,spec,scope)}else if(type==="projection"){return scope.projectionRef(spec[def.name])}return def.array&&!isSignal(value)?value.map((function(v){return parameterValue(def,v,scope)})):parameterValue(def,value,scope)}function parameterValue(def,value,scope){var type=def.type;if(isSignal(value)){return isExpr$1(type)?error("Expression references can not be signals."):isField(type)?scope.fieldRef(value):isCompare(type)?scope.compareRef(value):scope.signalRef(value.signal)}else{var _expr=def.expr||isField(type);return _expr&&outerExpr(value)?scope.exprRef(value.expr,value.as):_expr&&outerField(value)?_fieldRef(value.field,value.as):isExpr$1(type)?parser$1(value,scope):isData(type)?ref(scope.getData(value).values):isField(type)?_fieldRef(value):isCompare(type)?scope.compareRef(value):value}}function parseIndexParameter(def,spec,scope){if(!isString(spec.from)){error('Lookup "from" parameter must be a string literal.')}return scope.getData(spec.from).lookupRef(scope,spec.key)}function parseSubParameters(def,spec,scope){var value=spec[def.name];if(def.array){if(!isArray(value)){error("Expected an array of sub-parameters. Instead: "+$(value))}return value.map((function(v){return parseSubParameter(def,v,scope)}))}else{return parseSubParameter(def,value,scope)}}function parseSubParameter(def,value,scope){var n=def.params.length;var pdef;for(var i=0;i<n;++i){pdef=def.params[i];for(var k in pdef.key){if(pdef.key[k]!==value[k]){pdef=null;break}}if(pdef)break}if(!pdef)error("Unsupported parameter: "+$(value));var params=extend(parseParameters$1(pdef,value,scope),pdef.key);return ref(scope.add(Params$2(params)))}var outerExpr=function outerExpr(_){return _&&_.expr};var outerField=function outerField(_){return _&&_.field};var isData=function isData(_){return _==="data"};var isExpr$1=function isExpr$1(_){return _==="expr"};var isField=function isField(_){return _==="field"};var isCompare=function isCompare(_){return _==="compare"};function parseData(from,group,scope){var facet,key,op,dataRef,parent;if(!from){dataRef=ref(scope.add(Collect$1(null,[{}])))}else if(facet=from.facet){if(!group)error("Only group marks can be faceted.");if(facet.field!=null){dataRef=parent=getDataRef(facet,scope)}else{if(!from.data){op=parseTransform(extend({type:"aggregate",groupby:array(facet.groupby)},facet.aggregate),scope);op.params.key=scope.keyRef(facet.groupby);op.params.pulse=getDataRef(facet,scope);dataRef=parent=ref(scope.add(op))}else{parent=ref(scope.getData(from.data).aggregate)}key=scope.keyRef(facet.groupby,true)}}if(!dataRef){dataRef=getDataRef(from,scope)}return{key:key,pulse:dataRef,parent:parent}}function getDataRef(from,scope){return from.$ref?from:from.data&&from.data.$ref?from.data:ref(scope.getData(from.data).output)}function DataScope(scope,input,output,values,aggr){this.scope=scope;this.input=input;this.output=output;this.values=values;this.aggregate=aggr;this.index={}}DataScope.fromEntries=function(scope,entries){var n=entries.length,values=entries[n-1],output=entries[n-2];var input=entries[0],aggr=null,i=1;if(input&&input.type==="load"){input=entries[1]}scope.add(entries[0]);for(;i<n;++i){entries[i].params.pulse=ref(entries[i-1]);scope.add(entries[i]);if(entries[i].type==="aggregate")aggr=entries[i]}return new DataScope(scope,input,output,values,aggr)};function fieldKey(field){return isString(field)?field:null}function addSortField(scope,p,sort){var as=aggrField(sort.op,sort.field);var s;if(p.ops){for(var i=0,n=p.as.length;i<n;++i){if(p.as[i]===as)return}}else{p.ops=["count"];p.fields=[null];p.as=["count"]}if(sort.op){p.ops.push((s=sort.op.signal)?scope.signalRef(s):sort.op);p.fields.push(scope.fieldRef(sort.field));p.as.push(as)}}function cache(scope,ds,name,optype,field,counts,index){var cache=ds[name]||(ds[name]={}),sort=sortKey(counts);var k=fieldKey(field),v,op;if(k!=null){scope=ds.scope;k=k+(sort?"|"+sort:"");v=cache[k]}if(!v){var params=counts?{field:keyFieldRef,pulse:ds.countsRef(scope,field,counts)}:{field:scope.fieldRef(field),pulse:ref(ds.output)};if(sort)params.sort=scope.sortRef(counts);op=scope.add(entry$1(optype,undefined,params));if(index)ds.index[field]=op;v=ref(op);if(k!=null)cache[k]=v}return v}DataScope.prototype={countsRef:function countsRef(scope,field,sort){var ds=this,cache=ds.counts||(ds.counts={}),k=fieldKey(field);var v,a,p;if(k!=null){scope=ds.scope;v=cache[k]}if(!v){p={groupby:scope.fieldRef(field,"key"),pulse:ref(ds.output)};if(sort&&sort.field)addSortField(scope,p,sort);a=scope.add(Aggregate$1(p));v=scope.add(Collect$1({pulse:ref(a)}));v={agg:a,ref:ref(v)};if(k!=null)cache[k]=v}else if(sort&&sort.field){addSortField(scope,v.agg.params,sort)}return v.ref},tuplesRef:function tuplesRef(){return ref(this.values)},extentRef:function extentRef(scope,field){return cache(scope,this,"extent","extent",field,false)},domainRef:function domainRef(scope,field){return cache(scope,this,"domain","values",field,false)},valuesRef:function valuesRef(scope,field,sort){return cache(scope,this,"vals","values",field,sort||true)},lookupRef:function lookupRef(scope,field){return cache(scope,this,"lookup","tupleindex",field,false)},indataRef:function indataRef(scope,field){return cache(scope,this,"indata","tupleindex",field,true,true)}};function parseFacet(spec,scope,group){var facet=spec.from.facet,name=facet.name,data=getDataRef(facet,scope);var op;if(!facet.name){error("Facet must have a name: "+$(facet))}if(!facet.data){error("Facet must reference a data set: "+$(facet))}if(facet.field){op=scope.add(PreFacet$1({field:scope.fieldRef(facet.field),pulse:data}))}else if(facet.groupby){op=scope.add(Facet$1({key:scope.keyRef(facet.groupby),group:ref(scope.proxy(group.parent)),pulse:data}))}else{error("Facet must specify groupby or field: "+$(facet))}var subscope=scope.fork(),source=subscope.add(Collect$1()),values=subscope.add(Sieve$1({pulse:ref(source)}));subscope.addData(name,new DataScope(subscope,source,source,values));subscope.addSignal("parent",null);op.params.subflow={$subflow:subscope.parse(spec).toRuntime()}}function parseSubflow(spec,scope,input){var op=scope.add(PreFacet$1({pulse:input.pulse})),subscope=scope.fork();subscope.add(Sieve$1());subscope.addSignal("parent",null);op.params.subflow={$subflow:subscope.parse(spec).toRuntime()}}function parseTrigger(spec,scope,name){var remove=spec.remove,insert=spec.insert,toggle=spec.toggle,modify=spec.modify,values=spec.values,op=scope.add(operator());var update="if("+spec.trigger+',modify("'+name+'",'+[insert,remove,toggle,modify,values].map((function(_){return _==null?"null":_})).join(",")+"),0)";var expr=parser$1(update,scope);op.update=expr.$expr;op.params=expr.$params}function parseMark(spec,scope){var role=getRole(spec),group=spec.type===GroupMark,facet=spec.from&&spec.from.facet,overlap=spec.overlap;var layout=spec.layout||role===ScopeRole$1||role===FrameRole$1,ops,op,store,enc,name,layoutRef,boundRef;var nested=role===MarkRole||layout||facet;var input=parseData(spec.from,group,scope);op=scope.add(DataJoin$1({key:input.key||(spec.key?_fieldRef(spec.key):undefined),pulse:input.pulse,clean:!group}));var joinRef=ref(op);op=store=scope.add(Collect$1({pulse:joinRef}));op=scope.add(Mark$1({markdef:definition$1(spec),interactive:interactive(spec.interactive,scope),clip:clip$3(spec.clip,scope),context:{$context:true},groups:scope.lookup(),parent:scope.signals.parent?scope.signalRef("parent"):null,index:scope.markpath(),pulse:ref(op)}));var markRef=ref(op);op=enc=scope.add(Encode$1(parseEncode(spec.encode,spec.type,role,spec.style,scope,{mod:false,pulse:markRef})));op.params.parent=scope.encode();if(spec.transform){spec.transform.forEach((function(_){var tx=parseTransform(_,scope),md=tx.metadata;if(md.generates||md.changes){error("Mark transforms should not generate new data.")}if(!md.nomod)enc.params.mod=true;tx.params.pulse=ref(op);scope.add(op=tx)}))}if(spec.sort){op=scope.add(SortItems$1({sort:scope.compareRef(spec.sort),pulse:ref(op)}))}var encodeRef=ref(op);if(facet||layout){layout=scope.add(ViewLayout$1({layout:scope.objectProperty(spec.layout),legends:scope.legends,mark:markRef,pulse:encodeRef}));layoutRef=ref(layout)}var bound=scope.add(Bound$1({mark:markRef,pulse:layoutRef||encodeRef}));boundRef=ref(bound);if(group){if(nested){ops=scope.operators;ops.pop();if(layout)ops.pop()}scope.pushState(encodeRef,layoutRef||boundRef,joinRef);facet?parseFacet(spec,scope,input):nested?parseSubflow(spec,scope,input):scope.parse(spec);scope.popState();if(nested){if(layout)ops.push(layout);ops.push(bound)}}if(overlap){boundRef=parseOverlap(overlap,boundRef,scope)}var render=scope.add(Render$1({pulse:boundRef})),sieve=scope.add(Sieve$1({pulse:ref(render)},undefined,scope.parent()));if(spec.name!=null){name=spec.name;scope.addData(name,new DataScope(scope,store,render,sieve));if(spec.on)spec.on.forEach((function(on){if(on.insert||on.remove||on.toggle){error("Marks only support modify triggers.")}parseTrigger(on,scope,name)}))}}function parseOverlap(overlap,source,scope){var method=overlap.method,bound=overlap.bound,sep=overlap.separation;var params={separation:isSignal(sep)?scope.signalRef(sep.signal):sep,method:isSignal(method)?scope.signalRef(method.signal):method,pulse:source};if(overlap.order){params.sort=scope.compareRef({field:overlap.order})}if(bound){var tol=bound.tolerance;params.boundTolerance=isSignal(tol)?scope.signalRef(tol.signal):+tol;params.boundScale=scope.scaleRef(bound.scale);params.boundOrient=bound.orient}return ref(scope.add(Overlap$1(params)))}function parseLegend(spec,scope){var config=scope.config.legend,encode=spec.encode||{},_=lookup$4(spec,config),legendEncode=encode.legend||{},name=legendEncode.name||undefined,interactive=legendEncode.interactive,style=legendEncode.style,scales={};var scale=0,entryLayout,params,children;LegendScales.forEach((function(s){return spec[s]?(scales[s]=spec[s],scale=scale||spec[s]):0}));if(!scale)error("Missing valid scale for legend.");var type=legendType(spec,scope.scaleType(scale));var datum={title:spec.title!=null,scales:scales,type:type,vgrad:type!=="symbol"&&_.isVertical()};var dataRef=ref(scope.add(Collect$1(null,[datum])));var entryEncode={enter:{x:{value:0},y:{value:0}}};var entryRef=ref(scope.add(LegendEntries$1(params={type:type,scale:scope.scaleRef(scale),count:scope.objectProperty(_("tickCount")),limit:scope.property(_("symbolLimit")),values:scope.objectProperty(spec.values),minstep:scope.property(spec.tickMinStep),formatType:scope.property(spec.formatType),formatSpecifier:scope.property(spec.format)})));if(type===Gradient$1){children=[legendGradient(spec,scale,config,encode.gradient),legendGradientLabels(spec,config,encode.labels,entryRef)];params.count=params.count||scope.signalRef("max(2,2*floor((".concat(deref(_.gradientLength()),")/100))"))}else if(type===Discrete$1){children=[legendGradientDiscrete(spec,scale,config,encode.gradient,entryRef),legendGradientLabels(spec,config,encode.labels,entryRef)]}else{entryLayout=legendSymbolLayout(spec,config);children=[legendSymbolGroups(spec,config,encode,entryRef,deref(entryLayout.columns))];params.size=sizeExpression(spec,scope,children[0].marks)}children=[guideGroup({role:LegendEntryRole,from:dataRef,encode:entryEncode,marks:children,layout:entryLayout,interactive:interactive})];if(datum.title){children.push(legendTitle(spec,config,encode.title,dataRef))}return parseMark(guideGroup({role:LegendRole$1,from:dataRef,encode:extendEncode(buildLegendEncode(_,spec,config),legendEncode,Skip$2),marks:children,aria:_("aria"),description:_("description"),zindex:_("zindex"),name:name,interactive:interactive,style:style}),scope)}function legendType(spec,scaleType){var type=spec.type||Symbols$1;if(!spec.type&&scaleCount(spec)===1&&(spec.fill||spec.stroke)){type=isContinuous(scaleType)?Gradient$1:isDiscretizing(scaleType)?Discrete$1:Symbols$1}return type!==Gradient$1?type:isDiscretizing(scaleType)?Discrete$1:Gradient$1}function scaleCount(spec){return LegendScales.reduce((function(count,type){return count+(spec[type]?1:0)}),0)}function buildLegendEncode(_,spec,config){var encode={enter:{},update:{}};addEncoders(encode,{orient:_("orient"),offset:_("offset"),padding:_("padding"),titlePadding:_("titlePadding"),cornerRadius:_("cornerRadius"),fill:_("fillColor"),stroke:_("strokeColor"),strokeWidth:config.strokeWidth,strokeDash:config.strokeDash,x:_("legendX"),y:_("legendY"),format:spec.format,formatType:spec.formatType});return encode}function sizeExpression(spec,scope,marks){var size=deref(getChannel("size",spec,marks)),strokeWidth=deref(getChannel("strokeWidth",spec,marks)),fontSize=deref(getFontSize(marks[1].encode,scope,GuideLabelStyle));return parser$1("max(ceil(sqrt(".concat(size,")+").concat(strokeWidth,"),").concat(fontSize,")"),scope)}function getChannel(name,spec,marks){return spec[name]?'scale("'.concat(spec[name],'",datum)'):getEncoding(name,marks[0].encode)}function getFontSize(encode,scope,style){return getEncoding("fontSize",encode)||getStyle("fontSize",scope,style)}var angleExpr='item.orient==="'.concat(Left$1,'"?-90:item.orient==="').concat(Right$1,'"?90:0');function parseTitle(spec,scope){spec=isString(spec)?{text:spec}:spec;var _=lookup$4(spec,scope.config.title),encode=spec.encode||{},userEncode=encode.group||{},name=userEncode.name||undefined,interactive=userEncode.interactive,style=userEncode.style,children=[];var datum={},dataRef=ref(scope.add(Collect$1(null,[datum])));children.push(buildTitle(spec,_,titleEncode(spec),dataRef));if(spec.subtitle){children.push(buildSubTitle(spec,_,encode.subtitle,dataRef))}return parseMark(guideGroup({role:TitleRole$1,from:dataRef,encode:groupEncode(_,userEncode),marks:children,aria:_("aria"),description:_("description"),zindex:_("zindex"),name:name,interactive:interactive,style:style}),scope)}function titleEncode(spec){var encode=spec.encode;return encode&&encode.title||extend({name:spec.name,interactive:spec.interactive,style:spec.style},encode)}function groupEncode(_,userEncode){var encode={enter:{},update:{}};addEncoders(encode,{orient:_("orient"),anchor:_("anchor"),align:{signal:alignExpr},angle:{signal:angleExpr},limit:_("limit"),frame:_("frame"),offset:_("offset")||0,padding:_("subtitlePadding")});return extendEncode(encode,userEncode,Skip$2)}function buildTitle(spec,_,userEncode,dataRef){var zero={value:0},text=spec.text,encode={enter:{opacity:zero},update:{opacity:{value:1}},exit:{opacity:zero}};addEncoders(encode,{text:text,align:{signal:"item.mark.group.align"},angle:{signal:"item.mark.group.angle"},limit:{signal:"item.mark.group.limit"},baseline:"top",dx:_("dx"),dy:_("dy"),fill:_("color"),font:_("font"),fontSize:_("fontSize"),fontStyle:_("fontStyle"),fontWeight:_("fontWeight"),lineHeight:_("lineHeight")},{align:_("align"),angle:_("angle"),baseline:_("baseline")});return guideMark({type:TextMark,role:TitleTextRole,style:GroupTitleStyle,from:dataRef,encode:encode},userEncode)}function buildSubTitle(spec,_,userEncode,dataRef){var zero={value:0},text=spec.subtitle,encode={enter:{opacity:zero},update:{opacity:{value:1}},exit:{opacity:zero}};addEncoders(encode,{text:text,align:{signal:"item.mark.group.align"},angle:{signal:"item.mark.group.angle"},limit:{signal:"item.mark.group.limit"},baseline:"top",dx:_("dx"),dy:_("dy"),fill:_("subtitleColor"),font:_("subtitleFont"),fontSize:_("subtitleFontSize"),fontStyle:_("subtitleFontStyle"),fontWeight:_("subtitleFontWeight"),lineHeight:_("subtitleLineHeight")},{align:_("align"),angle:_("angle"),baseline:_("baseline")});return guideMark({type:TextMark,role:TitleSubtitleRole,style:GroupSubtitleStyle,from:dataRef,encode:encode},userEncode)}function parseData$1(data,scope){var transforms=[];if(data.transform){data.transform.forEach((function(tx){transforms.push(parseTransform(tx,scope))}))}if(data.on){data.on.forEach((function(on){parseTrigger(on,scope,data.name)}))}scope.addDataPipeline(data.name,analyze(data,scope,transforms))}function analyze(data,scope,ops){var output=[];var source=null,modify=false,generate=false,upstream,i,n,t,m;if(data.values){if(hasSignal(data.values)||hasSignal(data.format)){output.push(load$1(scope,data));output.push(source=collect())}else{output.push(source=collect({$ingest:data.values,$format:data.format}))}}else if(data.url){if(hasSignal(data.url)||hasSignal(data.format)){output.push(load$1(scope,data));output.push(source=collect())}else{output.push(source=collect({$request:data.url,$format:data.format}))}}else if(data.source){source=upstream=array(data.source).map((function(d){return ref(scope.getData(d).output)}));output.push(null)}for(i=0,n=ops.length;i<n;++i){t=ops[i];m=t.metadata;if(!source&&!m.source){output.push(source=collect())}output.push(t);if(m.generates)generate=true;if(m.modifies&&!generate)modify=true;if(m.source)source=t;else if(m.changes)source=null}if(upstream){n=upstream.length-1;output[0]=Relay$1({derive:modify,pulse:n?upstream:upstream[0]});if(modify||n){output.splice(1,0,collect())}}if(!source)output.push(collect());output.push(Sieve$1({}));return output}function collect(values){var s=Collect$1({},values);s.metadata={source:true};return s}function load$1(scope,data){return Load$1({url:data.url?scope.property(data.url):undefined,async:data.async?scope.property(data.async):undefined,values:data.values?scope.property(data.values):undefined,format:scope.objectProperty(data.format)})}var isX=function isX(orient){return orient===Bottom$1||orient===Top$1};var getSign=function getSign(orient,a,b){return isSignal(orient)?ifLeftTopExpr(orient.signal,a,b):orient===Left$1||orient===Top$1?a:b};var ifX=function ifX(orient,a,b){return isSignal(orient)?ifXEnc(orient.signal,a,b):isX(orient)?a:b};var ifY=function ifY(orient,a,b){return isSignal(orient)?ifYEnc(orient.signal,a,b):isX(orient)?b:a};var ifTop=function ifTop(orient,a,b){return isSignal(orient)?ifTopExpr(orient.signal,a,b):orient===Top$1?{value:a}:{value:b}};var ifRight=function ifRight(orient,a,b){return isSignal(orient)?ifRightExpr(orient.signal,a,b):orient===Right$1?{value:a}:{value:b}};var ifXEnc=function ifXEnc($orient,a,b){return ifEnc("".concat($orient," === '").concat(Top$1,"' || ").concat($orient," === '").concat(Bottom$1,"'"),a,b)};var ifYEnc=function ifYEnc($orient,a,b){return ifEnc("".concat($orient," !== '").concat(Top$1,"' && ").concat($orient," !== '").concat(Bottom$1,"'"),a,b)};var ifLeftTopExpr=function ifLeftTopExpr($orient,a,b){return ifExpr("".concat($orient," === '").concat(Left$1,"' || ").concat($orient," === '").concat(Top$1,"'"),a,b)};var ifTopExpr=function ifTopExpr($orient,a,b){return ifExpr("".concat($orient," === '").concat(Top$1,"'"),a,b)};var ifRightExpr=function ifRightExpr($orient,a,b){return ifExpr("".concat($orient," === '").concat(Right$1,"'"),a,b)};var ifEnc=function ifEnc(test,a,b){a=a!=null?encoder(a):a;b=b!=null?encoder(b):b;if(isSimple(a)&&isSimple(b)){a=a?a.signal||$(a.value):null;b=b?b.signal||$(b.value):null;return{signal:"".concat(test," ? (").concat(a,") : (").concat(b,")")}}else{return[extend({test:test},a)].concat(b||[])}};var isSimple=function isSimple(enc){return enc==null||Object.keys(enc).length===1};var ifExpr=function ifExpr(test,a,b){return{signal:"".concat(test," ? (").concat(toExpr(a),") : (").concat(toExpr(b),")")}};var ifOrient=function ifOrient($orient,t,b,l,r){return{signal:(l!=null?"".concat($orient," === '").concat(Left$1,"' ? (").concat(toExpr(l),") : "):"")+(b!=null?"".concat($orient," === '").concat(Bottom$1,"' ? (").concat(toExpr(b),") : "):"")+(r!=null?"".concat($orient," === '").concat(Right$1,"' ? (").concat(toExpr(r),") : "):"")+(t!=null?"".concat($orient," === '").concat(Top$1,"' ? (").concat(toExpr(t),") : "):"")+"(null)"}};var toExpr=function toExpr(v){return isSignal(v)?v.signal:v==null?null:$(v)};var mult=function mult(sign,value){return value===0?0:isSignal(sign)?{signal:"(".concat(sign.signal,") * ").concat(value)}:{value:sign*value}};var patch=function patch(value,base){var s=value.signal;return s&&s.endsWith("(null)")?{signal:s.slice(0,-6)+base.signal}:value};function fallback(prop,config,axisConfig,style){var styleProp;if(config&&_has(config,prop)){return config[prop]}else if(_has(axisConfig,prop)){return axisConfig[prop]}else if(prop.startsWith("title")){switch(prop){case"titleColor":styleProp="fill";break;case"titleFont":case"titleFontSize":case"titleFontWeight":styleProp=prop[5].toLowerCase()+prop.slice(6)}return style[GuideTitleStyle][styleProp]}else if(prop.startsWith("label")){switch(prop){case"labelColor":styleProp="fill";break;case"labelFont":case"labelFontSize":styleProp=prop[5].toLowerCase()+prop.slice(6)}return style[GuideLabelStyle][styleProp]}return null}function keys$1(objects){var map={};var _iterator=_createForOfIteratorHelper(objects),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var obj=_step.value;if(!obj)continue;for(var key in obj){map[key]=1}}}catch(err){_iterator.e(err)}finally{_iterator.f()}return Object.keys(map)}function axisConfig(spec,scope){var config=scope.config,style=config.style,axis=config.axis,band=scope.scaleType(spec.scale)==="band"&&config.axisBand,orient=spec.orient,xy,or,key;if(isSignal(orient)){var xyKeys=keys$1([config.axisX,config.axisY]),orientKeys=keys$1([config.axisTop,config.axisBottom,config.axisLeft,config.axisRight]);xy={};var _iterator2=_createForOfIteratorHelper(xyKeys),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){key=_step2.value;xy[key]=ifX(orient,fallback(key,config.axisX,axis,style),fallback(key,config.axisY,axis,style))}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}or={};var _iterator3=_createForOfIteratorHelper(orientKeys),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){key=_step3.value;or[key]=ifOrient(orient.signal,fallback(key,config.axisTop,axis,style),fallback(key,config.axisBottom,axis,style),fallback(key,config.axisLeft,axis,style),fallback(key,config.axisRight,axis,style))}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}else{xy=orient===Top$1||orient===Bottom$1?config.axisX:config.axisY;or=config["axis"+orient[0].toUpperCase()+orient.slice(1)]}var result=xy||or||band?extend({},axis,xy,or,band):axis;return result}function axisDomain(spec,config,userEncode,dataRef){var _=lookup$4(spec,config),orient=spec.orient;var enter,update;var encode={enter:enter={opacity:zero$2},update:update={opacity:one$2},exit:{opacity:zero$2}};addEncoders(encode,{stroke:_("domainColor"),strokeCap:_("domainCap"),strokeDash:_("domainDash"),strokeDashOffset:_("domainDashOffset"),strokeWidth:_("domainWidth"),strokeOpacity:_("domainOpacity")});var pos0=position(spec,0);var pos1=position(spec,1);enter.x=update.x=ifX(orient,pos0,zero$2);enter.x2=update.x2=ifX(orient,pos1);enter.y=update.y=ifY(orient,pos0,zero$2);enter.y2=update.y2=ifY(orient,pos1);return guideMark({type:RuleMark,role:AxisDomainRole,from:dataRef,encode:encode},userEncode)}function position(spec,pos){return{scale:spec.scale,range:pos}}function axisGrid(spec,config,userEncode,dataRef,band){var _=lookup$4(spec,config),orient=spec.orient,vscale=spec.gridScale,sign=getSign(orient,1,-1),offset=offsetValue$1(spec.offset,sign);var enter,exit,update;var encode={enter:enter={opacity:zero$2},update:update={opacity:one$2},exit:exit={opacity:zero$2}};addEncoders(encode,{stroke:_("gridColor"),strokeCap:_("gridCap"),strokeDash:_("gridDash"),strokeDashOffset:_("gridDashOffset"),strokeOpacity:_("gridOpacity"),strokeWidth:_("gridWidth")});var tickPos={scale:spec.scale,field:Value,band:band.band,extra:band.extra,offset:band.offset,round:_("tickRound")};var sz=ifX(orient,{signal:"height"},{signal:"width"});var gridStart=vscale?{scale:vscale,range:0,mult:sign,offset:offset}:{value:0,offset:offset};var gridEnd=vscale?{scale:vscale,range:1,mult:sign,offset:offset}:extend(sz,{mult:sign,offset:offset});enter.x=update.x=ifX(orient,tickPos,gridStart);enter.y=update.y=ifY(orient,tickPos,gridStart);enter.x2=update.x2=ifY(orient,gridEnd);enter.y2=update.y2=ifX(orient,gridEnd);exit.x=ifX(orient,tickPos);exit.y=ifY(orient,tickPos);return guideMark({type:RuleMark,role:AxisGridRole,key:Value,from:dataRef,encode:encode},userEncode)}function offsetValue$1(offset,sign){if(sign===1);else if(!isObject(offset)){offset=isSignal(sign)?{signal:"(".concat(sign.signal,") * (").concat(offset||0,")")}:sign*(offset||0)}else{var _entry=offset=extend({},offset);while(_entry.mult!=null){if(!isObject(_entry.mult)){_entry.mult=isSignal(sign)?{signal:"(".concat(_entry.mult,") * (").concat(sign.signal,")")}:_entry.mult*sign;return offset}else{_entry=_entry.mult=extend({},_entry.mult)}}_entry.mult=sign}return offset}function axisTicks(spec,config,userEncode,dataRef,size,band){var _=lookup$4(spec,config),orient=spec.orient,sign=getSign(orient,-1,1);var enter,exit,update;var encode={enter:enter={opacity:zero$2},update:update={opacity:one$2},exit:exit={opacity:zero$2}};addEncoders(encode,{stroke:_("tickColor"),strokeCap:_("tickCap"),strokeDash:_("tickDash"),strokeDashOffset:_("tickDashOffset"),strokeOpacity:_("tickOpacity"),strokeWidth:_("tickWidth")});var tickSize=encoder(size);tickSize.mult=sign;var tickPos={scale:spec.scale,field:Value,band:band.band,extra:band.extra,offset:band.offset,round:_("tickRound")};update.y=enter.y=ifX(orient,zero$2,tickPos);update.y2=enter.y2=ifX(orient,tickSize);exit.x=ifX(orient,tickPos);update.x=enter.x=ifY(orient,zero$2,tickPos);update.x2=enter.x2=ifY(orient,tickSize);exit.y=ifY(orient,tickPos);return guideMark({type:RuleMark,role:AxisTickRole,key:Value,from:dataRef,encode:encode},userEncode)}function flushExpr(scale,threshold,a,b,c){return{signal:'flush(range("'+scale+'"), '+'scale("'+scale+'", datum.value), '+threshold+","+a+","+b+","+c+")"}}function axisLabels(spec,config,userEncode,dataRef,size,band){var _=lookup$4(spec,config),orient=spec.orient,scale=spec.scale,sign=getSign(orient,-1,1),flush=deref(_("labelFlush")),flushOffset=deref(_("labelFlushOffset")),labelAlign=_("labelAlign"),labelBaseline=_("labelBaseline");var flushOn=flush===0||!!flush,update;var tickSize=encoder(size);tickSize.mult=sign;tickSize.offset=encoder(_("labelPadding")||0);tickSize.offset.mult=sign;var tickPos={scale:scale,field:Value,band:.5,offset:extendOffset(band.offset,_("labelOffset"))};var align=ifX(orient,flushOn?flushExpr(scale,flush,'"left"','"right"','"center"'):{value:"center"},ifRight(orient,"left","right"));var baseline=ifX(orient,ifTop(orient,"bottom","top"),flushOn?flushExpr(scale,flush,'"top"','"bottom"','"middle"'):{value:"middle"});var offsetExpr=flushExpr(scale,flush,"-(".concat(flushOffset,")"),flushOffset,0);flushOn=flushOn&&flushOffset;var enter={opacity:zero$2,x:ifX(orient,tickPos,tickSize),y:ifY(orient,tickPos,tickSize)};var encode={enter:enter,update:update={opacity:one$2,text:{field:Label$1},x:enter.x,y:enter.y,align:align,baseline:baseline},exit:{opacity:zero$2,x:enter.x,y:enter.y}};addEncoders(encode,{dx:!labelAlign&&flushOn?ifX(orient,offsetExpr):null,dy:!labelBaseline&&flushOn?ifY(orient,offsetExpr):null});addEncoders(encode,{angle:_("labelAngle"),fill:_("labelColor"),fillOpacity:_("labelOpacity"),font:_("labelFont"),fontSize:_("labelFontSize"),fontWeight:_("labelFontWeight"),fontStyle:_("labelFontStyle"),limit:_("labelLimit"),lineHeight:_("labelLineHeight")},{align:labelAlign,baseline:labelBaseline});var bound=_("labelBound");var overlap=_("labelOverlap");overlap=overlap||bound?{separation:_("labelSeparation"),method:overlap,order:"datum.index",bound:bound?{scale:scale,orient:orient,tolerance:bound}:null}:undefined;if(update.align!==align){update.align=patch(update.align,align)}if(update.baseline!==baseline){update.baseline=patch(update.baseline,baseline)}return guideMark({type:TextMark,role:AxisLabelRole,style:GuideLabelStyle,key:Value,from:dataRef,encode:encode,overlap:overlap},userEncode)}function axisTitle(spec,config,userEncode,dataRef){var _=lookup$4(spec,config),orient=spec.orient,sign=getSign(orient,-1,1);var enter,update;var encode={enter:enter={opacity:zero$2,anchor:encoder(_("titleAnchor",null)),align:{signal:alignExpr}},update:update=extend({},enter,{opacity:one$2,text:encoder(spec.title)}),exit:{opacity:zero$2}};var titlePos={signal:'lerp(range("'.concat(spec.scale,'"), ').concat(anchorExpr(0,1,.5),")")};update.x=ifX(orient,titlePos);update.y=ifY(orient,titlePos);enter.angle=ifX(orient,zero$2,mult(sign,90));enter.baseline=ifX(orient,ifTop(orient,Bottom$1,Top$1),{value:Bottom$1});update.angle=enter.angle;update.baseline=enter.baseline;addEncoders(encode,{fill:_("titleColor"),fillOpacity:_("titleOpacity"),font:_("titleFont"),fontSize:_("titleFontSize"),fontStyle:_("titleFontStyle"),fontWeight:_("titleFontWeight"),limit:_("titleLimit"),lineHeight:_("titleLineHeight")},{align:_("titleAlign"),angle:_("titleAngle"),baseline:_("titleBaseline")});autoLayout(_,orient,encode,userEncode);encode.update.align=patch(encode.update.align,enter.align);encode.update.angle=patch(encode.update.angle,enter.angle);encode.update.baseline=patch(encode.update.baseline,enter.baseline);return guideMark({type:TextMark,role:AxisTitleRole,style:GuideTitleStyle,from:dataRef,encode:encode},userEncode)}function autoLayout(_,orient,encode,userEncode){var auto=function auto(value,dim){return value!=null?(encode.update[dim]=patch(encoder(value),encode.update[dim]),false):!has(dim,userEncode)?true:false};var autoY=auto(_("titleX"),"x"),autoX=auto(_("titleY"),"y");encode.enter.auto=autoX===autoY?encoder(autoX):ifX(orient,encoder(autoX),encoder(autoY))}function parseAxis(spec,scope){var config=axisConfig(spec,scope),encode=spec.encode||{},axisEncode=encode.axis||{},name=axisEncode.name||undefined,interactive=axisEncode.interactive,style=axisEncode.style,_=lookup$4(spec,config),band=tickBand(_);var datum={scale:spec.scale,ticks:!!_("ticks"),labels:!!_("labels"),grid:!!_("grid"),domain:!!_("domain"),title:spec.title!=null};var dataRef=ref(scope.add(Collect$1({},[datum])));var ticksRef=ref(scope.add(AxisTicks$1({scale:scope.scaleRef(spec.scale),extra:scope.property(band.extra),count:scope.objectProperty(spec.tickCount),values:scope.objectProperty(spec.values),minstep:scope.property(spec.tickMinStep),formatType:scope.property(spec.formatType),formatSpecifier:scope.property(spec.format)})));var children=[];var size;if(datum.grid){children.push(axisGrid(spec,config,encode.grid,ticksRef,band))}if(datum.ticks){size=_("tickSize");children.push(axisTicks(spec,config,encode.ticks,ticksRef,size,band))}if(datum.labels){size=datum.ticks?size:0;children.push(axisLabels(spec,config,encode.labels,ticksRef,size,band))}if(datum.domain){children.push(axisDomain(spec,config,encode.domain,dataRef))}if(datum.title){children.push(axisTitle(spec,config,encode.title,dataRef))}return parseMark(guideGroup({role:AxisRole$1,from:dataRef,encode:extendEncode(buildAxisEncode(_,spec),axisEncode,Skip$2),marks:children,aria:_("aria"),description:_("description"),zindex:_("zindex"),name:name,interactive:interactive,style:style}),scope)}function buildAxisEncode(_,spec){var encode={enter:{},update:{}};addEncoders(encode,{orient:_("orient"),offset:_("offset")||0,position:value$2(spec.position,0),titlePadding:_("titlePadding"),minExtent:_("minExtent"),maxExtent:_("maxExtent"),range:{signal:'abs(span(range("'.concat(spec.scale,'")))')},translate:_("translate"),format:spec.format,formatType:spec.formatType});return encode}function parseScope(spec,scope,preprocessed){var signals=array(spec.signals),scales=array(spec.scales);if(!preprocessed)signals.forEach((function(_){return parseSignal(_,scope)}));array(spec.projections).forEach((function(_){return parseProjection(_,scope)}));scales.forEach((function(_){return initScale(_,scope)}));array(spec.data).forEach((function(_){return parseData$1(_,scope)}));scales.forEach((function(_){return parseScale(_,scope)}));(preprocessed||signals).forEach((function(_){return parseSignalUpdates(_,scope)}));array(spec.axes).forEach((function(_){return parseAxis(_,scope)}));array(spec.marks).forEach((function(_){return parseMark(_,scope)}));array(spec.legends).forEach((function(_){return parseLegend(_,scope)}));if(spec.title)parseTitle(spec.title,scope);scope.parseLambdas();return scope}var rootEncode=function rootEncode(spec){return extendEncode({enter:{x:{value:0},y:{value:0}},update:{width:{signal:"width"},height:{signal:"height"}}},spec)};function parseView(spec,scope){var config=scope.config;var root=ref(scope.root=scope.add(operator()));var signals=collectSignals(spec,config);signals.forEach((function(_){return parseSignal(_,scope)}));scope.description=spec.description||config.description;scope.eventConfig=config.events;scope.legends=scope.objectProperty(config.legend&&config.legend.layout);scope.locale=config.locale;var input=scope.add(Collect$1());var encode=scope.add(Encode$1(parseEncode(rootEncode(spec.encode),GroupMark,FrameRole$1,spec.style,scope,{pulse:ref(input)})));var parent=scope.add(ViewLayout$1({layout:scope.objectProperty(spec.layout),legends:scope.legends,autosize:scope.signalRef("autosize"),mark:root,pulse:ref(encode)}));scope.operators.pop();scope.pushState(ref(encode),ref(parent),null);parseScope(spec,scope,signals);scope.operators.push(parent);var op=scope.add(Bound$1({mark:root,pulse:ref(parent)}));op=scope.add(Render$1({pulse:ref(op)}));op=scope.add(Sieve$1({pulse:ref(op)}));scope.addData("root",new DataScope(scope,input,input,op));return scope}function signalObject(name,value){return value&&value.signal?{name:name,update:value.signal}:{name:name,value:value}}function collectSignals(spec,config){var _=function _(name){return value$2(spec[name],config[name])},signals=[signalObject("background",_("background")),signalObject("autosize",parseAutosize(_("autosize"))),signalObject("padding",parsePadding(_("padding"))),signalObject("width",_("width")||0),signalObject("height",_("height")||0)],pre=signals.reduce((function(p,s){return p[s.name]=s,p}),{}),map={};array(spec.signals).forEach((function(s){if(_has(pre,s.name)){s=extend(pre[s.name],s)}else{signals.push(s)}map[s.name]=s}));array(config.signals).forEach((function(s){if(!_has(map,s.name)&&!_has(pre,s.name)){signals.push(s)}}));return signals}function Scope$1(config,options){this.config=config||{};this.options=options||{};this.bindings=[];this.field={};this.signals={};this.lambdas={};this.scales={};this.events={};this.data={};this.streams=[];this.updates=[];this.operators=[];this.eventConfig=null;this.locale=null;this._id=0;this._subid=0;this._nextsub=[0];this._parent=[];this._encode=[];this._lookup=[];this._markpath=[]}function Subscope(scope){this.config=scope.config;this.options=scope.options;this.legends=scope.legends;this.field=Object.create(scope.field);this.signals=Object.create(scope.signals);this.lambdas=Object.create(scope.lambdas);this.scales=Object.create(scope.scales);this.events=Object.create(scope.events);this.data=Object.create(scope.data);this.streams=[];this.updates=[];this.operators=[];this._id=0;this._subid=++scope._nextsub[0];this._nextsub=scope._nextsub;this._parent=scope._parent.slice();this._encode=scope._encode.slice();this._lookup=scope._lookup.slice();this._markpath=scope._markpath}Scope$1.prototype=Subscope.prototype={parse:function parse(spec){return parseScope(spec,this)},fork:function fork(){return new Subscope(this)},isSubscope:function isSubscope(){return this._subid>0},toRuntime:function toRuntime(){this.finish();return{description:this.description,operators:this.operators,streams:this.streams,updates:this.updates,bindings:this.bindings,eventConfig:this.eventConfig,locale:this.locale}},id:function id(){return(this._subid?this._subid+":":0)+this._id++},add:function add(op){this.operators.push(op);op.id=this.id();if(op.refs){op.refs.forEach((function(ref){ref.$ref=op.id}));op.refs=null}return op},proxy:function proxy(op){var vref=op instanceof Entry?ref(op):op;return this.add(Proxy$1({value:vref}))},addStream:function addStream(stream){this.streams.push(stream);stream.id=this.id();return stream},addUpdate:function addUpdate(update){this.updates.push(update);return update},finish:function finish(){var name,ds;if(this.root)this.root.root=true;for(name in this.signals){this.signals[name].signal=name}for(name in this.scales){this.scales[name].scale=name}function annotate(op,name,type){var data,list;if(op){data=op.data||(op.data={});list=data[name]||(data[name]=[]);list.push(type)}}for(name in this.data){ds=this.data[name];annotate(ds.input,name,"input");annotate(ds.output,name,"output");annotate(ds.values,name,"values");for(var _field in ds.index){annotate(ds.index[_field],name,"index:"+_field)}}return this},pushState:function pushState(encode,parent,lookup){this._encode.push(ref(this.add(Sieve$1({pulse:encode}))));this._parent.push(parent);this._lookup.push(lookup?ref(this.proxy(lookup)):null);this._markpath.push(-1)},popState:function popState(){this._encode.pop();this._parent.pop();this._lookup.pop();this._markpath.pop()},parent:function parent(){return peek(this._parent)},encode:function encode(){return peek(this._encode)},lookup:function lookup(){return peek(this._lookup)},markpath:function markpath(){var p=this._markpath;return++p[p.length-1]},fieldRef:function fieldRef(field,name){if(isString(field))return _fieldRef(field,name);if(!field.signal){error("Unsupported field reference: "+$(field))}var s=field.signal;var f=this.field[s];if(!f){var params={name:this.signalRef(s)};if(name)params.as=name;this.field[s]=f=ref(this.add(Field$1(params)))}return f},compareRef:function compareRef(cmp){var _this=this;var signal=false;var check=function check(_){return isSignal(_)?(signal=true,_this.signalRef(_.signal)):isExpr(_)?(signal=true,_this.exprRef(_.expr)):_};var fields=array(cmp.field).map(check),orders=array(cmp.order).map(check);return signal?ref(this.add(Compare$1({fields:fields,orders:orders}))):_compareRef(fields,orders)},keyRef:function keyRef(fields,flat){var signal=false;var check=function check(_){return isSignal(_)?(signal=true,ref(sig[_.signal])):_};var sig=this.signals;fields=array(fields).map(check);return signal?ref(this.add(Key$1({fields:fields,flat:flat}))):_keyRef(fields,flat)},sortRef:function sortRef(sort){if(!sort)return sort;var a=aggrField(sort.op,sort.field),o=sort.order||Ascending;return o.signal?ref(this.add(Compare$1({fields:a,orders:this.signalRef(o.signal)}))):_compareRef(a,o)},event:function event(source,type){var key=source+":"+type;if(!this.events[key]){var id=this.id();this.streams.push({id:id,source:source,type:type});this.events[key]=id}return this.events[key]},hasOwnSignal:function hasOwnSignal(name){return _has(this.signals,name)},addSignal:function addSignal(name,value){if(this.hasOwnSignal(name)){error("Duplicate signal name: "+$(name))}var op=value instanceof Entry?value:this.add(operator(value));return this.signals[name]=op},getSignal:function getSignal(name){if(!this.signals[name]){error("Unrecognized signal name: "+$(name))}return this.signals[name]},signalRef:function signalRef(s){if(this.signals[s]){return ref(this.signals[s])}else if(!_has(this.lambdas,s)){this.lambdas[s]=this.add(operator(null))}return ref(this.lambdas[s])},parseLambdas:function parseLambdas(){var code=Object.keys(this.lambdas);for(var i=0,n=code.length;i<n;++i){var s=code[i],e=parser$1(s,this),op=this.lambdas[s];op.params=e.$params;op.update=e.$expr}},property:function property(spec){return spec&&spec.signal?this.signalRef(spec.signal):spec},objectProperty:function objectProperty(spec){return!spec||!isObject(spec)?spec:this.signalRef(spec.signal||propertyLambda(spec))},exprRef:function exprRef(code,name){var params={expr:parser$1(code,this)};if(name)params.expr.$name=name;return ref(this.add(Expression$1(params)))},addBinding:function addBinding(name,bind){if(!this.bindings){error("Nested signals do not support binding: "+$(name))}this.bindings.push(extend({signal:name},bind))},addScaleProj:function addScaleProj(name,transform){if(_has(this.scales,name)){error("Duplicate scale or projection name: "+$(name))}this.scales[name]=this.add(transform)},addScale:function addScale(name,params){this.addScaleProj(name,Scale$1(params))},addProjection:function addProjection(name,params){this.addScaleProj(name,Projection$1(params))},getScale:function getScale(name){if(!this.scales[name]){error("Unrecognized scale name: "+$(name))}return this.scales[name]},scaleRef:function scaleRef(name){return ref(this.getScale(name))},scaleType:function scaleType(name){return this.getScale(name).params.type},projectionRef:function projectionRef(name){return this.scaleRef(name)},projectionType:function projectionType(name){return this.scaleType(name)},addData:function addData(name,dataScope){if(_has(this.data,name)){error("Duplicate data set name: "+$(name))}return this.data[name]=dataScope},getData:function getData(name){if(!this.data[name]){error("Undefined data set name: "+$(name))}return this.data[name]},addDataPipeline:function addDataPipeline(name,entries){if(_has(this.data,name)){error("Duplicate data set name: "+$(name))}return this.addData(name,DataScope.fromEntries(this,entries))}};function propertyLambda(spec){return(isArray(spec)?arrayLambda:objectLambda)(spec)}function arrayLambda(array){var n=array.length;var code="[";for(var i=0;i<n;++i){var _value=array[i];code+=(i>0?",":"")+(isObject(_value)?_value.signal||propertyLambda(_value):$(_value))}return code+"]"}function objectLambda(obj){var code="{",i=0,key,value;for(key in obj){value=obj[key];code+=(++i>1?",":"")+$(key)+":"+(isObject(value)?value.signal||propertyLambda(value):$(value))}return code+"}"}function defaults(){var defaultFont="sans-serif",defaultSymbolSize=30,defaultStrokeWidth=2,defaultColor="#4c78a8",black="#000",gray="#888",lightGray="#ddd";return{description:"Vega visualization",padding:0,autosize:"pad",background:null,events:{defaults:{allow:["wheel"]}},group:null,mark:null,arc:{fill:defaultColor},area:{fill:defaultColor},image:null,line:{stroke:defaultColor,strokeWidth:defaultStrokeWidth},path:{stroke:defaultColor},rect:{fill:defaultColor},rule:{stroke:black},shape:{stroke:defaultColor},symbol:{fill:defaultColor,size:64},text:{fill:black,font:defaultFont,fontSize:11},trail:{fill:defaultColor,size:defaultStrokeWidth},style:{"guide-label":{fill:black,font:defaultFont,fontSize:10},"guide-title":{fill:black,font:defaultFont,fontSize:11,fontWeight:"bold"},"group-title":{fill:black,font:defaultFont,fontSize:13,fontWeight:"bold"},"group-subtitle":{fill:black,font:defaultFont,fontSize:12},point:{size:defaultSymbolSize,strokeWidth:defaultStrokeWidth,shape:"circle"},circle:{size:defaultSymbolSize,strokeWidth:defaultStrokeWidth},square:{size:defaultSymbolSize,strokeWidth:defaultStrokeWidth,shape:"square"},cell:{fill:"transparent",stroke:lightGray}},title:{orient:"top",anchor:"middle",offset:4,subtitlePadding:3},axis:{minExtent:0,maxExtent:200,bandPosition:.5,domain:true,domainWidth:1,domainColor:gray,grid:false,gridWidth:1,gridColor:lightGray,labels:true,labelAngle:0,labelLimit:180,labelOffset:0,labelPadding:2,ticks:true,tickColor:gray,tickOffset:0,tickRound:true,tickSize:5,tickWidth:1,titlePadding:4},axisBand:{tickOffset:-.5},projection:{type:"mercator"},legend:{orient:"right",padding:0,gridAlign:"each",columnPadding:10,rowPadding:2,symbolDirection:"vertical",gradientDirection:"vertical",gradientLength:200,gradientThickness:16,gradientStrokeColor:lightGray,gradientStrokeWidth:0,gradientLabelOffset:2,labelAlign:"left",labelBaseline:"middle",labelLimit:160,labelOffset:4,labelOverlap:true,symbolLimit:30,symbolType:"circle",symbolSize:100,symbolOffset:0,symbolStrokeWidth:1.5,symbolBaseFillColor:"transparent",symbolBaseStrokeColor:gray,titleLimit:180,titleOrient:"top",titlePadding:5,layout:{offset:18,direction:"horizontal",left:{direction:"vertical"},right:{direction:"vertical"}}},range:{category:{scheme:"tableau10"},ordinal:{scheme:"blues"},heatmap:{scheme:"yellowgreenblue"},ramp:{scheme:"blues"},diverging:{scheme:"blueorange",extent:[1,0]},symbol:["circle","square","triangle-up","cross","diamond","triangle-right","triangle-down","triangle-left"]}}}function parse$1$1(spec,config,options){if(!isObject(spec)){error("Input Vega specification must be an object.")}config=mergeConfig(defaults(),config,spec.config);return parseView(spec,new Scope$1(config,options)).toRuntime()}extend(transforms,tx,vtx,encode,geo,force,label,tree$1,reg,voronoi,wordcloud,xf);exports.Bounds=Bounds;exports.CanvasHandler=CanvasHandler;exports.CanvasRenderer=CanvasRenderer;exports.DATE=DATE;exports.DAY=DAY;exports.DAYOFYEAR=DAYOFYEAR;exports.Dataflow=Dataflow;exports.Debug=Debug;exports.Error=Error$1;exports.EventStream=EventStream;exports.Gradient=Gradient;exports.GroupItem=GroupItem;exports.HOURS=HOURS;exports.Handler=Handler;exports.Info=Info;exports.Item=Item;exports.MILLISECONDS=MILLISECONDS;exports.MINUTES=MINUTES;exports.MONTH=MONTH;exports.Marks=Marks;exports.MultiPulse=MultiPulse;exports.None=None;exports.Operator=Operator;exports.Parameters=Parameters;exports.Pulse=Pulse;exports.QUARTER=QUARTER;exports.RenderType=RenderType;exports.Renderer=Renderer;exports.ResourceLoader=ResourceLoader;exports.SECONDS=SECONDS;exports.SVGHandler=SVGHandler;exports.SVGRenderer=SVGRenderer;exports.SVGStringRenderer=SVGStringRenderer;exports.Scenegraph=Scenegraph;exports.TIME_UNITS=TIME_UNITS;exports.Transform=Transform;exports.View=View;exports.WEEK=WEEK;exports.Warn=Warn;exports.YEAR=YEAR;exports.accessor=accessor;exports.accessorFields=accessorFields;exports.accessorName=accessorName;exports.array=array;exports.ascending=ascending;exports.bandwidthNRD=estimateBandwidth;exports.bin=bin$1;exports.bootstrapCI=bootstrapCI;exports.boundClip=boundClip;exports.boundContext=boundContext;exports.boundItem=boundItem;exports.boundMark=boundMark;exports.boundStroke=boundStroke;exports.changeset=changeset;exports.clampRange=clampRange;exports.compare=compare;exports.constant=constant;exports.cumulativeLogNormal=cumulativeLogNormal;exports.cumulativeNormal=cumulativeNormal;exports.cumulativeUniform=cumulativeUniform;exports.dayofyear=dayofyear;exports.debounce=debounce;exports.defaultLocale=defaultLocale$2;exports.definition=definition;exports.densityLogNormal=densityLogNormal;exports.densityNormal=densityNormal;exports.densityUniform=densityUniform;exports.domChild=domChild;exports.domClear=domClear;exports.domCreate=domCreate;exports.domFind=domFind;exports.dotbin=dotbin;exports.error=error;exports.expressionFunction=expressionFunction;exports.extend=extend;exports.extent=extent;exports.extentIndex=extentIndex;exports.falsy=falsy;exports.fastmap=fastmap;exports.field=field;exports.flush=flush;exports.font=font;exports.fontFamily=fontFamily;exports.fontSize=fontSize;exports.format=format;exports.formatLocale=numberFormatDefaultLocale;exports.formats=formats;exports.hasOwnProperty=_has;exports.id=id;exports.identity=identity;exports.inferType=inferType;exports.inferTypes=inferTypes;exports.ingest=ingest;exports.inherits=inherits;exports.inrange=inrange;exports.interpolate=interpolate;exports.interpolateColors=interpolateColors;exports.interpolateRange=interpolateRange;exports.intersect=intersect$1;exports.intersectBoxLine=intersectBoxLine;exports.intersectPath=intersectPath;exports.intersectPoint=intersectPoint;exports.intersectRule=intersectRule;exports.isArray=isArray;exports.isBoolean=isBoolean;exports.isDate=isDate;exports.isFunction=isFunction;exports.isIterable=isIterable;exports.isNumber=isNumber;exports.isObject=isObject;exports.isRegExp=isRegExp;exports.isString=isString;exports.isTuple=isTuple;exports.key=key;exports.lerp=lerp;exports.lineHeight=lineHeight;exports.loader=loader;exports.locale=locale$2;exports.logger=logger;exports.lruCache=lruCache;exports.markup=markup;exports.merge=merge;exports.mergeConfig=mergeConfig;exports.multiLineOffset=multiLineOffset;exports.one=one;exports.pad=pad;exports.panLinear=panLinear;exports.panLog=panLog;exports.panPow=panPow;exports.panSymlog=panSymlog;exports.parse=parse$1$1;exports.pathCurves=curves;exports.pathEqual=pathEqual;exports.pathParse=pathParse;exports.pathRectangle=vg_rect;exports.pathRender=pathRender;exports.pathSymbols=symbols$1;exports.pathTrail=vg_trail;exports.peek=peek;exports.point=point$1;exports.projection=projection$1;exports.quantileLogNormal=quantileLogNormal;exports.quantileNormal=quantileNormal;exports.quantileUniform=quantileUniform;exports.quantiles=quantiles;exports.quantizeInterpolator=quantizeInterpolator;exports.quarter=quarter;exports.quartiles=quartiles;exports.randomInteger=integer;exports.randomKDE=kde;exports.randomLCG=lcg;exports.randomLogNormal=lognormal;exports.randomMixture=mixture;exports.randomNormal=gaussian;exports.randomUniform=uniform;exports.read=read;exports.regressionExp=exp$1;exports.regressionLinear=linear;exports.regressionLoess=loess;exports.regressionLog=log$2;exports.regressionPoly=poly;exports.regressionPow=pow$1;exports.regressionQuad=quad;exports.renderModule=renderModule;exports.repeat=repeat;exports.resetDefaultLocale=resetDefaultLocale;exports.resetSVGClipId=resetSVGClipId;exports.resetSVGDefIds=resetSVGDefIds;exports.responseType=responseType;exports.runtimeContext=context$2;exports.sampleCurve=sampleCurve;exports.sampleLogNormal=sampleLogNormal;exports.sampleNormal=sampleNormal;exports.sampleUniform=sampleUniform;exports.scale=scale;exports.sceneEqual=sceneEqual;exports.sceneFromJSON=sceneFromJSON;exports.scenePickVisit=pickVisit;exports.sceneToJSON=sceneToJSON;exports.sceneVisit=visit;exports.sceneZOrder=zorder;exports.scheme=scheme;exports.serializeXML=serializeXML;exports.setRandom=setRandom;exports.span=span;exports.splitAccessPath=splitAccessPath;exports.stringValue=$;exports.textMetrics=textMetrics;exports.timeBin=bin;exports.timeFloor=timeFloor;exports.timeFormatLocale=timeFormatDefaultLocale;exports.timeInterval=timeInterval;exports.timeOffset=timeOffset;exports.timeSequence=timeSequence;exports.timeUnitSpecifier=timeUnitSpecifier;exports.timeUnits=timeUnits;exports.toBoolean=toBoolean;exports.toDate=toDate;exports.toNumber=toNumber;exports.toSet=toSet;exports.toString=toString;exports.transform=transform$1;exports.transforms=transforms;exports.truncate=truncate;exports.truthy=truthy;exports.tupleid=tupleid;exports.typeParsers=typeParsers;exports.utcFloor=utcFloor;exports.utcInterval=utcInterval;exports.utcOffset=utcOffset;exports.utcSequence=utcSequence;exports.utcdayofyear=utcdayofyear;exports.utcquarter=utcquarter;exports.utcweek=utcweek;exports.version=version;exports.visitArray=visitArray;exports.week=week;exports.writeConfig=writeConfig;exports.zero=zero;exports.zoomLinear=zoomLinear;exports.zoomLog=zoomLog;exports.zoomPow=zoomPow;exports.zoomSymlog=zoomSymlog;Object.defineProperty(exports,"__esModule",{value:true})}))}).call(this,__webpack_require__(55).Buffer)},60:function(module,exports){var g;g=function(){return this}();try{g=g||new Function("return this")()}catch(e){if(typeof window==="object")g=window}module.exports=g},61:function(module,exports,__webpack_require__){"use strict";exports.byteLength=byteLength;exports.toByteArray=toByteArray;exports.fromByteArray=fromByteArray;var lookup=[];var revLookup=[];var Arr=typeof Uint8Array!=="undefined"?Uint8Array:Array;var code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var i=0,len=code.length;i<len;++i){lookup[i]=code[i];revLookup[code.charCodeAt(i)]=i}revLookup["-".charCodeAt(0)]=62;revLookup["_".charCodeAt(0)]=63;function getLens(b64){var len=b64.length;if(len%4>0){throw new Error("Invalid string. Length must be a multiple of 4")}var validLen=b64.indexOf("=");if(validLen===-1)validLen=len;var placeHoldersLen=validLen===len?0:4-validLen%4;return[validLen,placeHoldersLen]}function byteLength(b64){var lens=getLens(b64);var validLen=lens[0];var placeHoldersLen=lens[1];return(validLen+placeHoldersLen)*3/4-placeHoldersLen}function _byteLength(b64,validLen,placeHoldersLen){return(validLen+placeHoldersLen)*3/4-placeHoldersLen}function toByteArray(b64){var tmp;var lens=getLens(b64);var validLen=lens[0];var placeHoldersLen=lens[1];var arr=new Arr(_byteLength(b64,validLen,placeHoldersLen));var curByte=0;var len=placeHoldersLen>0?validLen-4:validLen;var i;for(i=0;i<len;i+=4){tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)];arr[curByte++]=tmp>>16&255;arr[curByte++]=tmp>>8&255;arr[curByte++]=tmp&255}if(placeHoldersLen===2){tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4;arr[curByte++]=tmp&255}if(placeHoldersLen===1){tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2;arr[curByte++]=tmp>>8&255;arr[curByte++]=tmp&255}return arr}function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[num&63]}function encodeChunk(uint8,start,end){var tmp;var output=[];for(var i=start;i<end;i+=3){tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(uint8[i+2]&255);output.push(tripletToBase64(tmp))}return output.join("")}function fromByteArray(uint8){var tmp;var len=uint8.length;var extraBytes=len%3;var parts=[];var maxChunkLength=16383;for(var i=0,len2=len-extraBytes;i<len2;i+=maxChunkLength){parts.push(encodeChunk(uint8,i,i+maxChunkLength>len2?len2:i+maxChunkLength))}if(extraBytes===1){tmp=uint8[len-1];parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")}else if(extraBytes===2){tmp=(uint8[len-2]<<8)+uint8[len-1];parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"=")}return parts.join("")}},62:function(module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var nBits=-7;var i=isLE?nBytes-1:0;var d=isLE?-1:1;var s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8){}m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8){}if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)};exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0;var i=isLE?0:nBytes-1;var d=isLE?1:-1;var s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8){}e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8){}buffer[offset+i-d]|=s*128}},63:function(module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return toString.call(arr)=="[object Array]"}},65:function(module,exports,__webpack_require__){(function(global,factory){true?factory(exports,__webpack_require__(66)):undefined})(this,(function(exports,vegaUtil){"use strict";var name="vega-tooltip";var version="0.24.2";var description="A tooltip plugin for Vega-Lite and Vega visualizations.";var keywords=["vega-lite","vega","tooltip"];var repository={type:"git",url:"https://github.com/vega/vega-tooltip.git"};var author={name:"UW Interactive Data Lab",url:"https://idl.cs.washington.edu"};var collaborators=["Dominik Moritz","Sira Horradarn","Zening Qu","Kanit Wongsuphasawat","Yuri Astrakhan","Jeffrey Heer"];var license="BSD-3-Clause";var bugs={url:"https://github.com/vega/vega-tooltip/issues"};var homepage="https://github.com/vega/vega-tooltip#readme";var main="build/vega-tooltip.js";var module="build/vega-tooltip.module.js";var unpkg="build/vega-tooltip.min.js";var jsdelivr="build/vega-tooltip.min.js";var types="build/vega-tooltip.module.d.ts";var files=["src","build","types"];var scripts={prebuild:"yarn clean && yarn build:style",build:"rollup -c","build:style":"./build-style.sh",clean:"rimraf build && rimraf src/style.ts","copy:data":"rsync -r node_modules/vega-datasets/data/* examples/data","copy:build":"rsync -r build/* examples/build","deploy:gh":"yarn build && yarn copy:build && gh-pages -d examples && yarn clean",prepublishOnly:"yarn clean && yarn build",preversion:"yarn lint && yarn test",serve:"browser-sync start -s -f build examples --serveStatic examples",start:"yarn build && concurrently --kill-others -n Server,Rollup 'yarn serve' 'rollup -c -w'",pretest:"yarn build:style",test:"beemo jest","test:inspect":"node --inspect-brk ./node_modules/.bin/jest --runInBand",prepare:"beemo create-config",prettierbase:"beemo prettier '*.{css,scss,html}'",eslintbase:"beemo eslint .",format:"yarn eslintbase --fix && yarn prettierbase --write",lint:"yarn eslintbase && yarn prettierbase --check"};var devDependencies={"@rollup/plugin-json":"^4.1.0","@rollup/plugin-node-resolve":"^9.0.0","@wessberg/rollup-plugin-ts":"^1.3.4","browser-sync":"^2.26.12",concurrently:"^5.3.0","gh-pages":"^3.1.0","node-sass":"^4.14.1",path:"^0.12.7",rollup:"^2.28.1","rollup-plugin-bundle-size":"^1.0.3","rollup-plugin-terser":"^7.0.2",typescript:"~4.0.3","vega-datasets":"^2.1.0","vega-lite-dev-config":"^0.14.6","vega-typings":"^0.19.0"};var dependencies={"vega-util":"^1.15.2"};var beemo={module:"vega-lite-dev-config",drivers:["typescript","prettier","eslint","babel","jest"],eslint:{ignore:["types"]},typescript:{compilerOptions:{typeRoots:["node_modules/@types","types"]}}};var pkg={name:name,version:version,description:description,keywords:keywords,repository:repository,author:author,collaborators:collaborators,license:license,bugs:bugs,homepage:homepage,main:main,module:module,unpkg:unpkg,jsdelivr:jsdelivr,types:types,files:files,scripts:scripts,devDependencies:devDependencies,dependencies:dependencies,beemo:beemo};
/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */var __assign=function(){__assign=Object.assign||function __assign(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};return __assign.apply(this,arguments)};function __rest(s,e){var t={};for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0)t[p]=s[p];if(s!=null&&typeof Object.getOwnPropertySymbols==="function")for(var i=0,p=Object.getOwnPropertySymbols(s);i<p.length;i++){if(e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i]))t[p[i]]=s[p[i]]}return t}var defaultStyle="#vg-tooltip-element {\n  visibility: hidden;\n  padding: 8px;\n  position: fixed;\n  z-index: 1000;\n  font-family: sans-serif;\n  font-size: 11px;\n  border-radius: 3px;\n  box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);\n  /* The default theme is the light theme. */\n  background-color: rgba(255, 255, 255, 0.95);\n  border: 1px solid #d9d9d9;\n  color: black; }\n  #vg-tooltip-element.visible {\n    visibility: visible; }\n  #vg-tooltip-element h2 {\n    margin-top: 0;\n    margin-bottom: 10px;\n    font-size: 13px; }\n  #vg-tooltip-element img {\n    max-width: 200px;\n    max-height: 200px; }\n  #vg-tooltip-element table {\n    border-spacing: 0; }\n    #vg-tooltip-element table tr {\n      border: none; }\n      #vg-tooltip-element table tr td {\n        overflow: hidden;\n        text-overflow: ellipsis;\n        padding-top: 2px;\n        padding-bottom: 2px; }\n        #vg-tooltip-element table tr td.key {\n          color: #808080;\n          max-width: 150px;\n          text-align: right;\n          padding-right: 4px; }\n        #vg-tooltip-element table tr td.value {\n          display: block;\n          max-width: 300px;\n          max-height: 7em;\n          text-align: left; }\n  #vg-tooltip-element.dark-theme {\n    background-color: rgba(32, 32, 32, 0.9);\n    border: 1px solid #f5f5f5;\n    color: white; }\n    #vg-tooltip-element.dark-theme td.key {\n      color: #bfbfbf; }\n";var EL_ID="vg-tooltip-element";var DEFAULT_OPTIONS={offsetX:10,offsetY:10,id:EL_ID,styleId:"vega-tooltip-style",theme:"light",disableDefaultStyle:false,sanitize:escapeHTML,maxDepth:2};function escapeHTML(value){return String(value).replace(/&/g,"&amp;").replace(/</g,"&lt;")}function createDefaultStyle(id){if(!/^[A-Za-z]+[-:.\w]*$/.test(id)){throw new Error("Invalid HTML ID")}return defaultStyle.toString().replace(EL_ID,id)}function formatValue(value,valueToHtml,maxDepth){if(vegaUtil.isArray(value)){return"["+value.map((function(v){return valueToHtml(vegaUtil.isString(v)?v:stringify(v,maxDepth))})).join(", ")+"]"}if(vegaUtil.isObject(value)){var content="";var _a=value,title=_a.title,image=_a.image,rest=__rest(_a,["title","image"]);if(title){content+="<h2>"+valueToHtml(title)+"</h2>"}if(image){content+='<img src="'+valueToHtml(image)+'">'}var keys=Object.keys(rest);if(keys.length>0){content+="<table>";for(var _i=0,keys_1=keys;_i<keys_1.length;_i++){var key=keys_1[_i];var val=rest[key];if(val===undefined){continue}if(vegaUtil.isObject(val)){val=stringify(val,maxDepth)}content+='<tr><td class="key">'+valueToHtml(key)+':</td><td class="value">'+valueToHtml(val)+"</td></tr>"}content+="</table>"}return content||"{}"}return valueToHtml(value)}function replacer(maxDepth){var stack=[];return function(key,value){if(typeof value!=="object"||value===null){return value}var pos=stack.indexOf(this)+1;stack.length=pos;if(stack.length>maxDepth){return"[Object]"}if(stack.indexOf(value)>=0){return"[Circular]"}stack.push(value);return value}}function stringify(obj,maxDepth){return JSON.stringify(obj,replacer(maxDepth))}function calculatePosition(event,tooltipBox,offsetX,offsetY){var x=event.clientX+offsetX;if(x+tooltipBox.width>window.innerWidth){x=+event.clientX-offsetX-tooltipBox.width}var y=event.clientY+offsetY;if(y+tooltipBox.height>window.innerHeight){y=+event.clientY-offsetY-tooltipBox.height}return{x:x,y:y}}var Handler=function(){function Handler(options){this.options=__assign(__assign({},DEFAULT_OPTIONS),options);var elementId=this.options.id;this.call=this.tooltipHandler.bind(this);if(!this.options.disableDefaultStyle&&!document.getElementById(this.options.styleId)){var style=document.createElement("style");style.setAttribute("id",this.options.styleId);style.innerHTML=createDefaultStyle(elementId);var head=document.head;if(head.childNodes.length>0){head.insertBefore(style,head.childNodes[0])}else{head.appendChild(style)}}this.el=document.getElementById(elementId);if(!this.el){this.el=document.createElement("div");this.el.setAttribute("id",elementId);this.el.classList.add("vg-tooltip");document.body.appendChild(this.el)}}Handler.prototype.tooltipHandler=function(handler,event,item,value){if(value==null||value===""){this.el.classList.remove("visible",this.options.theme+"-theme");return}this.el.innerHTML=formatValue(value,this.options.sanitize,this.options.maxDepth);this.el.classList.add("visible",this.options.theme+"-theme");var _a=calculatePosition(event,this.el.getBoundingClientRect(),this.options.offsetX,this.options.offsetY),x=_a.x,y=_a.y;this.el.setAttribute("style","top: "+y+"px; left: "+x+"px")};return Handler}();var version$1=pkg.version;function index(view,opt){var handler=new Handler(opt);view.tooltip(handler.call).run();return handler}exports.DEFAULT_OPTIONS=DEFAULT_OPTIONS;exports.Handler=Handler;exports.calculatePosition=calculatePosition;exports.createDefaultStyle=createDefaultStyle;exports.default=index;exports.escapeHTML=escapeHTML;exports.formatValue=formatValue;exports.replacer=replacer;exports.stringify=stringify;exports.version=version$1;Object.defineProperty(exports,"__esModule",{value:true})}))},66:function(module,exports,__webpack_require__){(function(global,factory){true?factory(exports):undefined})(this,(function(exports){"use strict";function accessor(fn,fields,name){fn.fields=fields||[];fn.fname=name;return fn}function accessorName(fn){return fn==null?null:fn.fname}function accessorFields(fn){return fn==null?null:fn.fields}function getter(path){return path.length===1?get1(path[0]):getN(path)}const get1=field=>function(obj){return obj[field]};const getN=path=>{const len=path.length;return function(obj){for(let i=0;i<len;++i){obj=obj[path[i]]}return obj}};function error(message){throw Error(message)}function splitAccessPath(p){const path=[],n=p.length;let q=null,b=0,s="",i,j,c;p=p+"";function push(){path.push(s+p.substring(i,j));s="";i=j+1}for(i=j=0;j<n;++j){c=p[j];if(c==="\\"){s+=p.substring(i,j);s+=p.substring(++j,++j);i=j}else if(c===q){push();q=null;b=-1}else if(q){continue}else if(i===b&&c==='"'){i=j+1;q=c}else if(i===b&&c==="'"){i=j+1;q=c}else if(c==="."&&!b){if(j>i){push()}else{i=j+1}}else if(c==="["){if(j>i)push();b=i=j+1}else if(c==="]"){if(!b)error("Access path missing open bracket: "+p);if(b>0)push();b=0;i=j+1}}if(b)error("Access path missing closing bracket: "+p);if(q)error("Access path missing closing quote: "+p);if(j>i){j++;push()}return path}function field(field,name,opt){const path=splitAccessPath(field);field=path.length===1?path[0]:field;return accessor((opt&&opt.get||getter)(path),[field],name||field)}const id=field("id");const identity=accessor(_=>_,[],"identity");const zero=accessor(()=>0,[],"zero");const one=accessor(()=>1,[],"one");const truthy=accessor(()=>true,[],"true");const falsy=accessor(()=>false,[],"false");function log(method,level,input){const args=[level].concat([].slice.call(input));console[method].apply(console,args)}const None=0;const Error$1=1;const Warn=2;const Info=3;const Debug=4;function logger(_,method){let level=_||None;return{level(_){if(arguments.length){level=+_;return this}else{return level}},error(){if(level>=Error$1)log(method||"error","ERROR",arguments);return this},warn(){if(level>=Warn)log(method||"warn","WARN",arguments);return this},info(){if(level>=Info)log(method||"log","INFO",arguments);return this},debug(){if(level>=Debug)log(method||"log","DEBUG",arguments);return this}}}var isArray=Array.isArray;function isObject(_){return _===Object(_)}const isLegalKey=key=>key!=="__proto__";function mergeConfig(...configs){return configs.reduce((out,source)=>{for(const key in source){if(key==="signals"){out.signals=mergeNamed(out.signals,source.signals)}else{const r=key==="legend"?{layout:1}:key==="style"?true:null;writeConfig(out,key,source[key],r)}}return out},{})}function writeConfig(output,key,value,recurse){if(!isLegalKey(key))return;let k,o;if(isObject(value)&&!isArray(value)){o=isObject(output[key])?output[key]:output[key]={};for(k in value){if(recurse&&(recurse===true||recurse[k])){writeConfig(o,k,value[k])}else if(isLegalKey(k)){o[k]=value[k]}}}else{output[key]=value}}function mergeNamed(a,b){if(a==null)return b;const map={},out=[];function add(_){if(!map[_.name]){map[_.name]=1;out.push(_)}}b.forEach(add);a.forEach(add);return out}function peek(array){return array[array.length-1]}function toNumber(_){return _==null||_===""?null:+_}const exp=sign=>x=>sign*Math.exp(x);const log$1=sign=>x=>Math.log(sign*x);const symlog=c=>x=>Math.sign(x)*Math.log1p(Math.abs(x/c));const symexp=c=>x=>Math.sign(x)*Math.expm1(Math.abs(x))*c;const pow=exponent=>x=>x<0?-Math.pow(-x,exponent):Math.pow(x,exponent);function pan(domain,delta,lift,ground){const d0=lift(domain[0]),d1=lift(peek(domain)),dd=(d1-d0)*delta;return[ground(d0-dd),ground(d1-dd)]}function panLinear(domain,delta){return pan(domain,delta,toNumber,identity)}function panLog(domain,delta){var sign=Math.sign(domain[0]);return pan(domain,delta,log$1(sign),exp(sign))}function panPow(domain,delta,exponent){return pan(domain,delta,pow(exponent),pow(1/exponent))}function panSymlog(domain,delta,constant){return pan(domain,delta,symlog(constant),symexp(constant))}function zoom(domain,anchor,scale,lift,ground){const d0=lift(domain[0]),d1=lift(peek(domain)),da=anchor!=null?lift(anchor):(d0+d1)/2;return[ground(da+(d0-da)*scale),ground(da+(d1-da)*scale)]}function zoomLinear(domain,anchor,scale){return zoom(domain,anchor,scale,toNumber,identity)}function zoomLog(domain,anchor,scale){const sign=Math.sign(domain[0]);return zoom(domain,anchor,scale,log$1(sign),exp(sign))}function zoomPow(domain,anchor,scale,exponent){return zoom(domain,anchor,scale,pow(exponent),pow(1/exponent))}function zoomSymlog(domain,anchor,scale,constant){return zoom(domain,anchor,scale,symlog(constant),symexp(constant))}function quarter(date){return 1+~~(new Date(date).getMonth()/3)}function utcquarter(date){return 1+~~(new Date(date).getUTCMonth()/3)}function array(_){return _!=null?isArray(_)?_:[_]:[]}function clampRange(range,min,max){let lo=range[0],hi=range[1],span;if(hi<lo){span=hi;hi=lo;lo=span}span=hi-lo;return span>=max-min?[min,max]:[lo=Math.min(Math.max(lo,min),max-span),lo+span]}function isFunction(_){return typeof _==="function"}const DESCENDING="descending";function compare(fields,orders,opt){opt=opt||{};orders=array(orders)||[];const ord=[],get=[],fmap={},gen=opt.comparator||comparator;array(fields).forEach((f,i)=>{if(f==null)return;ord.push(orders[i]===DESCENDING?-1:1);get.push(f=isFunction(f)?f:field(f,null,opt));(accessorFields(f)||[]).forEach(_=>fmap[_]=1)});return get.length===0?null:accessor(gen(get,ord),Object.keys(fmap))}const ascending=(u,v)=>(u<v||u==null)&&v!=null?-1:(u>v||v==null)&&u!=null?1:(v=v instanceof Date?+v:v,u=u instanceof Date?+u:u)!==u&&v===v?-1:v!==v&&u===u?1:0;const comparator=(fields,orders)=>fields.length===1?compare1(fields[0],orders[0]):compareN(fields,orders,fields.length);const compare1=(field,order)=>function(a,b){return ascending(field(a),field(b))*order};const compareN=(fields,orders,n)=>{orders.push(0);return function(a,b){let f,c=0,i=-1;while(c===0&&++i<n){f=fields[i];c=ascending(f(a),f(b))}return c*orders[i]}};function constant(_){return isFunction(_)?_:()=>_}function debounce(delay,handler){let tid;return e=>{if(tid)clearTimeout(tid);tid=setTimeout(()=>(handler(e),tid=null),delay)}}function extend(_){for(let x,k,i=1,len=arguments.length;i<len;++i){x=arguments[i];for(k in x){_[k]=x[k]}}return _}function extent(array,f){let i=0,n,v,min,max;if(array&&(n=array.length)){if(f==null){for(v=array[i];i<n&&(v==null||v!==v);v=array[++i]);min=max=v;for(;i<n;++i){v=array[i];if(v!=null){if(v<min)min=v;if(v>max)max=v}}}else{for(v=f(array[i]);i<n&&(v==null||v!==v);v=f(array[++i]));min=max=v;for(;i<n;++i){v=f(array[i]);if(v!=null){if(v<min)min=v;if(v>max)max=v}}}}return[min,max]}function extentIndex(array,f){const n=array.length;let i=-1,a,b,c,u,v;if(f==null){while(++i<n){b=array[i];if(b!=null&&b>=b){a=c=b;break}}if(i===n)return[-1,-1];u=v=i;while(++i<n){b=array[i];if(b!=null){if(a>b){a=b;u=i}if(c<b){c=b;v=i}}}}else{while(++i<n){b=f(array[i],i,array);if(b!=null&&b>=b){a=c=b;break}}if(i===n)return[-1,-1];u=v=i;while(++i<n){b=f(array[i],i,array);if(b!=null){if(a>b){a=b;u=i}if(c<b){c=b;v=i}}}}return[u,v]}const hop=Object.prototype.hasOwnProperty;function has(object,property){return hop.call(object,property)}const NULL={};function fastmap(input){let obj={},test;function has$1(key){return has(obj,key)&&obj[key]!==NULL}const map={size:0,empty:0,object:obj,has:has$1,get(key){return has$1(key)?obj[key]:undefined},set(key,value){if(!has$1(key)){++map.size;if(obj[key]===NULL)--map.empty}obj[key]=value;return this},delete(key){if(has$1(key)){--map.size;++map.empty;obj[key]=NULL}return this},clear(){map.size=map.empty=0;map.object=obj={}},test(_){if(arguments.length){test=_;return map}else{return test}},clean(){const next={};let size=0;for(const key in obj){const value=obj[key];if(value!==NULL&&(!test||!test(value))){next[key]=value;++size}}map.size=size;map.empty=0;map.object=obj=next}};if(input)Object.keys(input).forEach(key=>{map.set(key,input[key])});return map}function flush(range,value,threshold,left,right,center){if(!threshold&&threshold!==0)return center;const t=+threshold;let a=range[0],b=peek(range),l;if(b<a){l=a;a=b;b=l}l=Math.abs(value-a);const r=Math.abs(b-value);return l<r&&l<=t?left:r<=t?right:center}function inherits(child,parent,members){const proto=child.prototype=Object.create(parent.prototype);proto.constructor=child;return extend(proto,members)}function inrange(value,range,left,right){let r0=range[0],r1=range[range.length-1],t;if(r0>r1){t=r0;r0=r1;r1=t}left=left===undefined||left;right=right===undefined||right;return(left?r0<=value:r0<value)&&(right?value<=r1:value<r1)}function isBoolean(_){return typeof _==="boolean"}function isDate(_){return Object.prototype.toString.call(_)==="[object Date]"}function isIterable(_){return _&&isFunction(_[Symbol.iterator])}function isNumber(_){return typeof _==="number"}function isRegExp(_){return Object.prototype.toString.call(_)==="[object RegExp]"}function isString(_){return typeof _==="string"}function key(fields,flat,opt){if(fields){fields=flat?array(fields).map(f=>f.replace(/\\(.)/g,"$1")):array(fields)}const len=fields&&fields.length,gen=opt&&opt.get||getter,map=f=>gen(flat?[f]:splitAccessPath(f));let fn;if(!len){fn=function(){return""}}else if(len===1){const get=map(fields[0]);fn=function(_){return""+get(_)}}else{const get=fields.map(map);fn=function(_){let s=""+get[0](_),i=0;while(++i<len)s+="|"+get[i](_);return s}}return accessor(fn,fields,"key")}function lerp(array,frac){const lo=array[0],hi=peek(array),f=+frac;return!f?lo:f===1?hi:lo+f*(hi-lo)}const DEFAULT_MAX_SIZE=1e4;function lruCache(maxsize){maxsize=+maxsize||DEFAULT_MAX_SIZE;let curr,prev,size;const clear=()=>{curr={};prev={};size=0};const update=(key,value)=>{if(++size>maxsize){prev=curr;curr={};size=1}return curr[key]=value};clear();return{clear:clear,has:key=>has(curr,key)||has(prev,key),get:key=>has(curr,key)?curr[key]:has(prev,key)?update(key,prev[key]):undefined,set:(key,value)=>has(curr,key)?curr[key]=value:update(key,value)}}function merge(compare,array0,array1,output){const n0=array0.length,n1=array1.length;if(!n1)return array0;if(!n0)return array1;const merged=output||new array0.constructor(n0+n1);let i0=0,i1=0,i=0;for(;i0<n0&&i1<n1;++i){merged[i]=compare(array0[i0],array1[i1])>0?array1[i1++]:array0[i0++]}for(;i0<n0;++i0,++i){merged[i]=array0[i0]}for(;i1<n1;++i1,++i){merged[i]=array1[i1]}return merged}function repeat(str,reps){let s="";while(--reps>=0)s+=str;return s}function pad(str,length,padchar,align){const c=padchar||" ",s=str+"",n=length-s.length;return n<=0?s:align==="left"?repeat(c,n)+s:align==="center"?repeat(c,~~(n/2))+s+repeat(c,Math.ceil(n/2)):s+repeat(c,n)}function span(array){return array&&peek(array)-array[0]||0}function $(x){return isArray(x)?"["+x.map($)+"]":isObject(x)||isString(x)?JSON.stringify(x).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):x}function toBoolean(_){return _==null||_===""?null:!_||_==="false"||_==="0"?false:!!_}const defaultParser=_=>isNumber(_)?_:isDate(_)?_:Date.parse(_);function toDate(_,parser){parser=parser||defaultParser;return _==null||_===""?null:parser(_)}function toString(_){return _==null||_===""?null:_+""}function toSet(_){const s={},n=_.length;for(let i=0;i<n;++i)s[_[i]]=true;return s}function truncate(str,length,align,ellipsis){const e=ellipsis!=null?ellipsis:"",s=str+"",n=s.length,l=Math.max(0,length-e.length);return n<=length?s:align==="left"?e+s.slice(n-l):align==="center"?s.slice(0,Math.ceil(l/2))+e+s.slice(n-~~(l/2)):s.slice(0,l)+e}function visitArray(array,filter,visitor){if(array){if(filter){const n=array.length;for(let i=0;i<n;++i){const t=filter(array[i]);if(t)visitor(t,i,array)}}else{array.forEach(visitor)}}}exports.Debug=Debug;exports.Error=Error$1;exports.Info=Info;exports.None=None;exports.Warn=Warn;exports.accessor=accessor;exports.accessorFields=accessorFields;exports.accessorName=accessorName;exports.array=array;exports.ascending=ascending;exports.clampRange=clampRange;exports.compare=compare;exports.constant=constant;exports.debounce=debounce;exports.error=error;exports.extend=extend;exports.extent=extent;exports.extentIndex=extentIndex;exports.falsy=falsy;exports.fastmap=fastmap;exports.field=field;exports.flush=flush;exports.hasOwnProperty=has;exports.id=id;exports.identity=identity;exports.inherits=inherits;exports.inrange=inrange;exports.isArray=isArray;exports.isBoolean=isBoolean;exports.isDate=isDate;exports.isFunction=isFunction;exports.isIterable=isIterable;exports.isNumber=isNumber;exports.isObject=isObject;exports.isRegExp=isRegExp;exports.isString=isString;exports.key=key;exports.lerp=lerp;exports.logger=logger;exports.lruCache=lruCache;exports.merge=merge;exports.mergeConfig=mergeConfig;exports.one=one;exports.pad=pad;exports.panLinear=panLinear;exports.panLog=panLog;exports.panPow=panPow;exports.panSymlog=panSymlog;exports.peek=peek;exports.quarter=quarter;exports.repeat=repeat;exports.span=span;exports.splitAccessPath=splitAccessPath;exports.stringValue=$;exports.toBoolean=toBoolean;exports.toDate=toDate;exports.toNumber=toNumber;exports.toSet=toSet;exports.toString=toString;exports.truncate=truncate;exports.truthy=truthy;exports.utcquarter=utcquarter;exports.visitArray=visitArray;exports.writeConfig=writeConfig;exports.zero=zero;exports.zoomLinear=zoomLinear;exports.zoomLog=zoomLog;exports.zoomPow=zoomPow;exports.zoomSymlog=zoomSymlog;Object.defineProperty(exports,"__esModule",{value:true})}))}}]);